<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Andrey Akinshin&#39;s blog">
    <meta name="author" content="Andrey Akinshin">
    <link href="/img/favicon.ico?v=2" rel="icon" type="image/x-icon"/>
    <meta name="keywords" content=''>

    <title>Andrey Akinshin&#39;s blog</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">

    <!-- Custom styles -->
    <link href="/css/about.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/blog.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/highlight.css" rel="stylesheet" type="text/css" media="all">

    <!-- Bootstrap scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>

    <!-- Other stuff -->
    <link href="/en/rss.xml" type="application/rss+xml" rel="alternate" title="Blog RSS Feed" />
    <link href="/en/atom.xml" type="application/atom+xml" rel="alternate" title="Blog ATOM Feed" />

    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41419012-5', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter28700916 = new Ya.Metrika({id:28700916,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true});
            } catch(e) { }
        });
        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";
        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
    </script>
    <!-- /Yandex.Metrika counter -->
    <!-- MathJax -->
    <script type="text/x-mathjax-config">
       MathJax.Hub.Config({
        extensions: ["jsMath2jax.js"]
      });
    </script>
    <script
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
    </script>
    <!-- Disqus -->
    <script id="dsq-count-scr" src="//aakinshinnet-en.disqus.com/count.js" async></script>
  </head>

  <body>
     <div class="blog-masthead">
      <div class="container">
        <nav class="nav blog-nav">
          <a class="nav-link" id="nav-link-blog" href="/en/blog/">Blog</a>
          <a class="nav-link" id="nav-link-blog" href="/en/blog/featured/">Featured</a>
          <a class="nav-link" id="nav-link-blog-content" href="/en/blog/content/">Content</a>
          <a class="nav-link" id="nav-link-about" href="/en/about/">About author</a>
          <a class="nav-link" href='/ru/blog/'>Russian version</a>
        </nav>
      </div>
    </div>

    <div class="container">
      <div class="blog-main">
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/rider-nuget-search/'>Why is NuGet search in Rider so fast?</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 08, 2017.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#Rider"><span class="tag tag-pill tag-info">Rider</span></a>
                <a href="/en/blog/tags/#NuGet"><span class="tag tag-pill tag-info">NuGet</span></a>
        </span><br /><br />
        <p>I'm a guy who develops the NuGet manager in <a href="https://www.jetbrains.com/rider/">Rider</a>.
It's not ready yet, there are some bugs here and there, but it already works pretty well.
The feature which I am most proud of is smart and fast search:</p>
<div class="mx-auto">
  <img class="mx-auto d-block" width="400" src="/img/posts/dotnet/rider-nuget-search/front.gif" />
</div>
<p>Today I want to share with you some technical details about how it was implemented.</p>
</p>
        <a href='/en/blog/dotnet/rider-nuget-search/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/rider-nuget-search/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/nuget2-and-directoryseparatorchar/'>NuGet2 and a DirectorySeparatorChar bug</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 06, 2017.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#Rider"><span class="tag tag-pill tag-info">Rider</span></a>
                <a href="/en/blog/tags/#Bugs"><span class="tag tag-pill tag-info">Bugs</span></a>
                <a href="/en/blog/tags/#Performance"><span class="tag tag-pill tag-info">Performance</span></a>
                <a href="/en/blog/tags/#NuGet"><span class="tag tag-pill tag-info">NuGet</span></a>
        </span><br /><br />
        <p>In <a href="https://www.jetbrains.com/rider/">Rider</a>, we care a lot about performance.
I like to improve the application responsiveness and do interesting optimizations all the time.
However, Rider is already well-optimized, and it's hard to make significant performance improvements.
So, usually, I do micro-optimizations which give a not very big impact on the whole application.
However, sometimes it's possible to improve the speed of a feature 100 times with a few lines of code.</p>
<p>Rider is based on <a href="https://www.jetbrains.com/resharper/">ReSharper</a>, so we have a lot of cool features out of the box.
One of such features is <a href="https://www.jetbrains.com/help/resharper/2016.3/Code_Analysis__Solution-Wide_Analysis.html">Solution-Wide Analysis</a>
which lets you constantly keep track of all issues in your solution.
Sometimes, solution-wide analysis takes a lot of time because there are many files which should be analyzed.
Of course, it should work super fast on small projects.</p>
<p>Ok, let's talk about a performance bug (<a href="https://youtrack.jetbrains.com/issue/RIDER-3742">#RIDER-3742</a>) that we recently had.</p>
<ul>
<li><em>Repro:</em> Open Rider, create a new &quot;ASP .NET MVC Application&quot;, enable solution wide-analysis.</li>
<li><em>Expected:</em> The analysis should take 1 second.</li>
<li><em>Actual:</em> The analysis takes 1 second on Windows and <strong>2 minutes</strong> on Linux and MacOS.</li>
</ul>
</p>
        <a href='/en/blog/dotnet/nuget2-and-directoryseparatorchar/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/nuget2-and-directoryseparatorchar/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/perfex-div/'>Performance exercise: Division</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> December 26, 2016.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#PerformanceExercise"><span class="tag tag-pill tag-info">PerformanceExercise</span></a>
                <a href="/en/blog/tags/#Benchmarking"><span class="tag tag-pill tag-info">Benchmarking</span></a>
                <a href="/en/blog/tags/#Math"><span class="tag tag-pill tag-info">Math</span></a>
        </span><br /><br />
        <p>In the previous post, we <a href="/en/blog/dotnet/perfex-min/">discussed</a> the performance space of the minimum function
which was implemented via a simple ternary operator and with the help of bit magic.
Now we continue to talk about performance and bit hacks.
In particular, we will divide a positive number by three:</p>
<pre><code class="language-cs">uint Div3Simple(uint n)   =&gt; n / 3;
uint Div3BitHacks(uint n) =&gt; (uint)((n * (ulong)0xAAAAAAAB) &gt;&gt; 33);
</code></pre>
<p>As usual, it's hard to say which method is faster in advanced because the performance depends on the environment.
Here are some interesting results:</p>
<table class="table table-sm">
  <tr> <th></th>              <th>Simple</th>              <th>BitHacks</th>             </tr>
  <tr> <th>LegacyJIT-x86</th> <td class="norm">≈8.3ns</td> <td class="fast">≈2.6ns</td>  </tr>
  <tr> <th>LegacyJIT-x64</th> <td class="fast">≈2.6ns</td> <td class="fast">≈1.7ns</td>  </tr>
  <tr> <th>RyuJIT-x64   </th> <td class="norm">≈6.9ns</td> <td class="fast">≈1.5ns</td>  </tr>
  <tr> <th>Mono4.6.2-x86</th> <td class="norm">≈8.5ns</td> <td class="slow">≈14.4ns</td> </tr>
  <tr> <th>Mono4.6.2-x64</th> <td class="norm">≈8.3ns</td> <td class="fast">≈2.8ns</td>  </tr>
</table>
</p>
        <a href='/en/blog/dotnet/perfex-div/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/perfex-div/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/perfex-min/'>Performance exercise: Minimum</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> December 20, 2016.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#PerformanceExercise"><span class="tag tag-pill tag-info">PerformanceExercise</span></a>
                <a href="/en/blog/tags/#Benchmarking"><span class="tag tag-pill tag-info">Benchmarking</span></a>
                <a href="/en/blog/tags/#Math"><span class="tag tag-pill tag-info">Math</span></a>
        </span><br /><br />
        <p>Performance is tricky. Especially, if you are working with very fast operations. In today benchmarking exercise, we will try to measure performance of two simple methods which calculate minimum of two numbers. Sounds easy? Ok, let's do it, here are our guinea pigs for today:</p>
<pre><code class="language-cs">int MinTernary(int x, int y)  =&gt; x &lt; y ? x : y;
int MinBitHacks(int x, int y) =&gt; x &amp; ((x - y) &gt;&gt; 31) | y &amp; (~(x - y) &gt;&gt; 31);
</code></pre>
<p>And here are some results:</p>
<table class="table table-sm">
  <style type="text/css" scoped>
    td.slow { color: #ff4444; } 
    td.fast { color: #00C851; }
  </style>
  
  <tr> <th></th> <th colspan="2">Random</th>        <th colspan="2">Const</th>          </tr>
  <tr> <th></th> <th>Ternary</th> <th>BitHacks</th> <th>Ternary</th> <th>BitHacks</th>  </tr>
  <tr> <th>LegacyJIT-x86</th>
       <td class="slow">≈643µs</td>
       <td class="fast">≈227µs</td>
       <td class="fast">≈160µs</td>
       <td class="slow">≈226µs</td>
  </tr>
  <tr> <th>LegacyJIT-x64</th>
       <td class="slow">≈450µs</td>
       <td class="fast">≈123µs</td>
       <td class="fast">≈68µs</td>
       <td class="slow">≈123µs</td>
  </tr>
  <tr> <th>RyuJIT-x64</th>
       <td class="slow">≈594µs</td>
       <td class="fast">≈241µs</td>
       <td class="fast">≈180µs</td>
       <td class="slow">≈241µs</td>
  </tr>
  <tr> <th>Mono-x64</th>
       <td class="fast">≈203µs</td>
       <td class="slow">≈283µs</td>
       <td class="fast">≈204µs</td>
       <td class="slow">≈282µs</td>
  </tr>
</table>
<p>What's going on here? Let's discuss it in detail.</p>
</p>
        <a href='/en/blog/dotnet/perfex-min/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/perfex-min/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/stopwatch/'>Stopwatch under the hood</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> September 09, 2016.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#Hardware"><span class="tag tag-pill tag-info">Hardware</span></a>
                <a href="/en/blog/tags/#Timers"><span class="tag tag-pill tag-info">Timers</span></a>
                <a href="/en/blog/tags/#Internals"><span class="tag tag-pill tag-info">Internals</span></a>
        </span><br /><br />
        <p>In <a href="/en/blog/dotnet/datetime/">the previous post</a>, we discussed <code>DateTime</code>.
This structure can be used in situations when you don't need a good level of precision.
If you want to do high precision time measurements, you need a better tool because <code>DateTime</code> has a small resolution and a big latency.
Also time is tricky, you can create wonderful bugs if you don't understand how it works (see <a href="http://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time">Falsehoods programmers believe about time</a> and <a href="http://infiniteundo.com/post/25509354022/more-falsehoods-programmers-believe-about-time">More falsehoods programmers believe about time</a>).</p>
<p>In this post, we will briefly talk about the <a href="https://msdn.microsoft.com/library/system.diagnostics.stopwatch.aspx">Stopwatch</a> class:</p>
<ul>
<li>Which kind of hardware timers could be a base for <code>Stopwatch</code></li>
<li>High precision timestamp API on Windows and Linux</li>
<li>Latency and Resolution of <code>Stopwatch</code> in different environments</li>
<li>Common pitfalls: which kind of problems could we get trying to measure small time intervals</li>
</ul>
<p>If you are not a .NET developer, you can also find a lot of useful information in this post: mainly we will discuss low-level details of high-resolution timestamping (probably your favorite language also uses the same API).
As usual, you can also find useful links for further reading.</p>
</p>
        <a href='/en/blog/dotnet/stopwatch/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/stopwatch/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/datetime/'>DateTime under the hood</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> August 19, 2016.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#Timers"><span class="tag tag-pill tag-info">Timers</span></a>
                <a href="/en/blog/tags/#Internals"><span class="tag tag-pill tag-info">Internals</span></a>
        </span><br /><br />
        <p><a href="https://msdn.microsoft.com/library/system.datetime.aspx">DateTime</a> is a widely used .NET type. A lot of developers use it all the time, but not all of them really know how it works. In this post, I discuss <a href="https://msdn.microsoft.com/library/system.datetime.utcnow.aspx">DateTime.UtcNow</a>: how it's implemented, what the latency and the resolution of <code>DateTime</code> on Windows and Linux, how the resolution can be changed, and how it can affect your application. This post is an overview, so you probably will not see super detailed explanations of some topics, but you will find a lot of useful links for further reading.</p>
</p>
        <a href='/en/blog/dotnet/datetime/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/datetime/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/legacyjitx86-and-first-method-call/'>LegacyJIT-x86 and first method call</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> April 04, 2016.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#C#"><span class="tag tag-pill tag-info">C#</span></a>
                <a href="/en/blog/tags/#JIT"><span class="tag tag-pill tag-info">JIT</span></a>
                <a href="/en/blog/tags/#Benchmarks"><span class="tag tag-pill tag-info">Benchmarks</span></a>
        </span><br /><br />
        <p>Today I tell you about one of my favorite benchmarks (this method doesn't return a useful value, we need it only as an example):</p>
<pre><code class="language-cs">[Benchmark]
public string Sum()
{
    double a = 1, b = 1;
    var sw = new Stopwatch();
    for (int i = 0; i &lt; 10001; i++)
        a = a + b;
    return string.Format(&quot;{0}{1}&quot;, a, sw.ElapsedMilliseconds);
}
</code></pre>
<p>An interesting fact: if you call <code>Stopwatch.GetTimestamp()</code> before the first call of the <code>Sum</code> method, you improve <code>Sum</code> performance several times (works only with LegacyJIT-x86).</p>
</p>
        <a href='/en/blog/dotnet/legacyjitx86-and-first-method-call/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/legacyjitx86-and-first-method-call/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/projecttypeguids/'>Visual Studio and ProjectTypeGuids.cs</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 27, 2016.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#C#"><span class="tag tag-pill tag-info">C#</span></a>
                <a href="/en/blog/tags/#VisualStudio"><span class="tag tag-pill tag-info">VisualStudio</span></a>
                <a href="/en/blog/tags/#Hate"><span class="tag tag-pill tag-info">Hate</span></a>
                <a href="/en/blog/tags/#Rider"><span class="tag tag-pill tag-info">Rider</span></a>
        </span><br /><br />
        <p>It's a story about how I tried to open a project in Visual Studio for a few hours. The other day, I was going to do some work. I pulled last commits from a repo, opened Visual Studio, and prepared to start coding. However, one of a project in my solution failed to open with a strange message:</p>
<pre><code>error  : The operation could not be completed.
</code></pre>
<p>In the Solution Explorer, I had <em>&quot;load failed&quot;</em> as a project status and the following message instead of the file tree: <em>&quot;The project requires user input. Reload the project for more information.&quot;</em> Hmm, ok, I reloaded the project and got a few more errors:</p>
<pre><code>error  : The operation could not be completed.
error  : The operation could not be completed.
</code></pre>
</p>
        <a href='/en/blog/dotnet/projecttypeguids/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/projecttypeguids/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/blittable/'>Blittable types</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> November 26, 2015.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#C#"><span class="tag tag-pill tag-info">C#</span></a>
                <a href="/en/blog/tags/#Internals"><span class="tag tag-pill tag-info">Internals</span></a>
        </span><br /><br />
        <p>Challenge of the day: what will the following code display?</p>
<pre><code class="language-cs">[StructLayout(LayoutKind.Explicit)]
public struct UInt128
{
    [FieldOffset(0)]
    public ulong Value1;
    [FieldOffset(8)]
    public ulong Value2;
}
[StructLayout(LayoutKind.Sequential)]
public struct MyStruct
{
    public UInt128 UInt128;
    public char Char;
}
class Program
{
    public static unsafe void Main()
    {
        var myStruct = new MyStruct();
        var baseAddress = (int)&amp;myStruct;
        var uInt128Adress = (int)&amp;myStruct.UInt128;
        Console.WriteLine(uInt128Adress - baseAddress);
        Console.WriteLine(Marshal.OffsetOf(typeof(MyStruct), &quot;UInt128&quot;));
    }
}
</code></pre>
<p>A hint: two zeros or two another same values are wrong answers in the general case. The following table shows the console output on different runtimes:</p>
<table>
<tr><th></th><th>MS.NET-x86</th><th>MS.NET-x64</th><th>Mono</th></tr>
<tr><td>uInt128Adress - baseAddress                  </td><td>4</td><td>8</td><td>0</td></tr>
<tr><td>Marshal.OffsetOf(typeof(MyStruct), "UInt128")</td><td>0</td><td>0</td><td>0</td></tr>
</table>
<p>If you want to know why it happens, you probably should learn some useful information about blittable types.</p>
        <a href='/en/blog/dotnet/blittable/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/blittable/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/en/blog/dotnet/ryujit-rc-and-constant-folding/'>RyuJIT RC and constant folding</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> May 12, 2015.
          <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
          <b>Tags:</b>
                <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
                <a href="/en/blog/tags/#C#"><span class="tag tag-pill tag-info">C#</span></a>
                <a href="/en/blog/tags/#JIT"><span class="tag tag-pill tag-info">JIT</span></a>
                <a href="/en/blog/tags/#RyuJIT"><span class="tag tag-pill tag-info">RyuJIT</span></a>
                <a href="/en/blog/tags/#ConstantFolding"><span class="tag tag-pill tag-info">ConstantFolding</span></a>
        </span><br /><br />
        <p><strong>Update:</strong> The below results are valid for the release version of RyuJIT.</p>
<p>The challenge of the day: which method is faster?</p>
<pre><code class="language-cs">public double Sqrt13()
{
    return Math.Sqrt(1) + Math.Sqrt(2) + Math.Sqrt(3) + Math.Sqrt(4) + Math.Sqrt(5) + 
           Math.Sqrt(6) + Math.Sqrt(7) + Math.Sqrt(8) + Math.Sqrt(9) + Math.Sqrt(10) + 
           Math.Sqrt(11) + Math.Sqrt(12) + Math.Sqrt(13);
}
public double Sqrt14()
{
    return Math.Sqrt(1) + Math.Sqrt(2) + Math.Sqrt(3) + Math.Sqrt(4) + Math.Sqrt(5) + 
           Math.Sqrt(6) + Math.Sqrt(7) + Math.Sqrt(8) + Math.Sqrt(9) + Math.Sqrt(10) + 
           Math.Sqrt(11) + Math.Sqrt(12) + Math.Sqrt(13) + Math.Sqrt(14);
}
</code></pre>
<p>I have measured the methods performance with help of <a href="https://github.com/AndreyAkinshin/BenchmarkDotNet">BenchmarkDotNet</a> for RyuJIT RC (a part of .NET Framework 4.6 RC) and received the following results:</p>
<pre><code>// BenchmarkDotNet=v0.7.4.0
// OS=Microsoft Windows NT 6.2.9200.0
// Processor=Intel(R) Core(TM) i7-4702MQ CPU ＠ 2.20GHz, ProcessorCount=8
// CLR=MS.NET 4.0.30319.0, Arch=64-bit  [RyuJIT]
Common:  Type=Math_DoubleSqrtAvx  Mode=Throughput  Platform=X64  Jit=RyuJit  .NET=Current  
<p>Method |  AvrTime |    StdDev |         op/s |
------- |--------- |---------- |------------- |
Sqrt13 | 55.40 ns |  0.571 ns |  18050993.06 |
Sqrt14 |  1.43 ns | 0.0224 ns | 697125029.18 |
</code></pre></p>
<p>How so? If I add one more <code>Math.Sqrt</code> to the expression, the method starts work 40 times faster! Let's examine the situation..</p>
        <a href='/en/blog/dotnet/ryujit-rc-and-constant-folding/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/en/blog/dotnet/ryujit-rc-and-constant-folding/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
</div>
<nav>
  <ul class="pagination">
          <li class="page-item disabled">
        <a class="page-link" href="#" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
          <span class="sr-only">Previous</span>
        </a>
      </li>
            <li class="page-item active">
          <a class="page-link" href="/en/blog/">1 <span class="sr-only">(current)</span></a>
        </li>
        <li class="page-item"><a class="page-link" href="/en/blog/page/2/">2</a></li>
        <li class="page-item"><a class="page-link" href="/en/blog/page/3/">3</a></li>
          <li class="page-item">
        <a class="page-link" href='/en/blog/page/2/' aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
          <span class="sr-only">Next</span>
        </a>
      </li>
      </ul>
</nav>
<hr />
<p style="font-size:150%"><a href="/ru/blog/">More posts in Russian</a></p>
<p>Subscribe: <a href="/en/rss.xml">RSS</a> <a href="/en/atom.xml">Atom</a></p>
    </div>

    <footer class="blog-footer">
      <div class="container">
        <p>&copy; 2014–2017 Andrey Akinshin</p>
      </div>
    </footer>

    <script>
    $(function() {
       // standard classes
       $("table").addClass("table");
       $("table").addClass("table-bordered");
       $("table").addClass("table-hover");
       $("table").addClass("table-condensed");
       $("blockquote").addClass("blockquote");

       // nav
       var url = $(location).attr('href');
       if (url.indexOf("/blog/content") != -1) {
           $("#nav-link-blog-content").addClass("active");
       } else if (url.indexOf("/blog") != -1) {
           $("#nav-link-blog").addClass("active");
       } else if (url.indexOf("/about") != -1) {
           $("#nav-link-about").addClass("active");
       }
    });
    </script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/anchor.min.js"></script>
    <script>
      anchors.options = {
        placement: 'left',
        icon: '§'
      };
      anchors.add('h1');
      anchors.add('h2');
      anchors.add('h3');
    </script>
  </body>
</html>
