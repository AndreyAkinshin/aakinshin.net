<!doctype html><html lang=ru><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Андрей Акиньшин"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content=".NET,C#,Generic,Static"><title>Статические поля в generic-классах | Андрей Акиньшин</title><meta name=description content="Сегодня мы кратко поговорим о статических полях в generic-классах. Тема простая, но у некоторых разработчиков она вызывает трудности. Итак, задачка: что вы..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.852cec611cdd74c8e940745d8a06d6c32796c1f728bee243cbd8b0a4a9377c67.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/ru/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/ru/about/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/ru/posts/>Посты</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/ru/about/>Об авторе</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Статические поля в generic-классах</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2015-01-21>21 января 2015</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/ru/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/ru/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/ru/tags/generic/>Generic</a>
<a class=label-link href=https://aakinshin.net/ru/tags/static/>Static</a></div></div><br><div class=main-content><p>Сегодня мы кратко поговорим о статических полях в generic-классах. Тема простая, но у некоторых разработчиков она вызывает трудности. Итак, задачка: что выведет следующий код?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>class</span> <span class=nc>Foo</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>static</span> <span class=kt>int</span> <span class=n>Bar</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Foo</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;.</span><span class=n>Bar</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>  <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>Foo</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;.</span><span class=n>Bar</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><em>Правильный ответ:</em> <code>0</code>. Всё дело в том, что <code>Foo&lt;int></code> и <code>Foo&lt;double></code> — это два разных класса, у каждого своё собственное статическое поле. И это весьма логично. Действительно, раз у нас есть поле, то оно должно принадлежать экземпляру какого-то класса, а экземпляр <code>Foo&lt;T></code> создать невозможно, необходимо явно указать <code>T</code>. Как можно догадаться, <code>typeof(Foo&lt;int>) != typeof(Foo&lt;double>)</code>, поэтому каждый класс получит собственное статическое поле. Если поменять значение этого поля в одном классе, то это никак не повлияет на значение соответствующего поля в другом классе. Вроде бы просто, но не всем очевидно: мне доводилось видеть, как данный нюанс вызывал проблемы в продакшн-проектах. Поэтому я и решил написать небольшую заметку по этому поводу.</p><p>Приведу также цитату из документации языка C#. <strong>CSharp Language Specification 5.0, 10.5.1:</strong></p><blockquote><p>When a field declaration includes a static modifier, the fields introduced by the declaration are static fields. When no static modifier is present, the fields introduced by the declaration are instance fields. Static fields and instance fields are two of the several kinds of variables (§5) supported by C#, and at times they are referred to as static variables and instance variables, respectively. A static field is not part of a specific instance; instead, it is shared amongst all instances of a closed type (§4.4.2). No matter how many instances of a closed class type are created, there is only ever one copy of a static field for the associated application domain.</p></blockquote><p>У MS в разделе <strong>Code Analysis for Managed Code Warnings</strong> есть такое предупреждение: <a href=https://msdn.microsoft.com/en-us/library/ms182139.aspx>CA1000</a>: Do not declare static members on generic types (DoNotDeclareStaticMembersOnGenericTypes). Ну и, само собой, в ReSharper также есть подобный warning под названием StaticMemberInGenericType (см. <a href=https://confluence.jetbrains.com/display/ReSharper/Static+field+in+generic+type>ReSharper wiki</a>).</p><p><strong>Мораль:</strong> старайтесь не делать изменяемые статические поля в generic-классах. А ещё лучше — просто старайтесь не делать изменяемые статические поля. Как правило, в нормальном проекте такую потребность всегда можно обойти с помощью красивого архитектурного решения. Даже если вы считаете, что изменяемое статическое поле вам просто необходимо, и при этом прекрасно понимаете нюансы, связанные с его использованием в generic-классах (используете эту фичу в своих целях), то помните, что кто-нибудь, кто будет работать с вашим кодом, может не понять авторскую задумку и чего-нибудь испортить или использовать не по плану. А архитектуру нужно стараться делать так, чтобы что-то испортить было чертовски сложно.</p><h3 id=задачи>Задачи</h3><p>Приведённая задачка доступна в <a href=http://problembook.net/>ProblemBookt.NET</a> <a href=http://problembook.net/content/ru/Oop/StaticFieldInGenericType-P.html>на русском</a> и <a href=http://problembook.net/content/en/Oop/StaticFieldInGenericType-P.html>на английском</a>.</p></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Поделиться:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fru%2fposts%2fstatic-field-in-generic-type%2f&title=%d0%a1%d1%82%d0%b0%d1%82%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b5%20%d0%bf%d0%be%d0%bb%d1%8f%20%d0%b2%20generic-%d0%ba%d0%bb%d0%b0%d1%81%d1%81%d0%b0%d1%85" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=%d0%a1%d1%82%d0%b0%d1%82%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b5%20%d0%bf%d0%be%d0%bb%d1%8f%20%d0%b2%20generic-%d0%ba%d0%bb%d0%b0%d1%81%d1%81%d0%b0%d1%85&url=https%3a%2f%2faakinshin.net%2fru%2fposts%2fstatic-field-in-generic-type%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fru%2fposts%2fstatic-field-in-generic-type%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fru%2fposts%2fstatic-field-in-generic-type%2f&title=%d0%a1%d1%82%d0%b0%d1%82%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b5%20%d0%bf%d0%be%d0%bb%d1%8f%20%d0%b2%20generic-%d0%ba%d0%bb%d0%b0%d1%81%d1%81%d0%b0%d1%85" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Андрей Акиньшин</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/ru/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>