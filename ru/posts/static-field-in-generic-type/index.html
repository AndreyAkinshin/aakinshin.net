<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="Статические поля в generic-классах">
    <meta name="author" content="Andrey Akinshin">
    <link href="/img/favicon.ico" rel="icon" type="image/x-icon"/>
    <meta name="keywords" content='.NET,C#,Generic,Static'>

    <title>Статические поля в generic-классах</title>

    <!-- Bootstrap CSS -->
    <link href="/css/lumen-bootstrap.min.css" rel="stylesheet" type="text/css" media="(prefers-color-scheme: no-preference)">
    <link href="/css/lumen-bootstrap.min.css" rel="stylesheet" type="text/css" media="(prefers-color-scheme: light)">
    <link href="/css/slate-bootstrap.min.css" rel="stylesheet" type="text/css" media="(prefers-color-scheme: dark)">

    <!-- Highlight.js -->
    <link href="/css/github-highlight.css" rel="stylesheet" type="text/css" media="(prefers-color-scheme: no-preference)">
    <link href="/css/github-highlight.css" rel="stylesheet" type="text/css" media="(prefers-color-scheme: light)">
    <link href="/css/darcula-highlight.css" rel="stylesheet" type="text/css" media="(prefers-color-scheme: dark)">

    <!-- FontAwesome -->
    <link href="/css/fontawesome-all.min.css" rel="stylesheet" type="text/css" media="all">

    <!-- Custom styles -->
    <link href="/css/about.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/blog.css" rel="stylesheet" type="text/css" media="all">

    <!-- Feeds -->
    <link href="/ru/rss.xml" type="application/rss+xml" rel="alternate" title="Blog RSS Feed" />
    <link href="/ru/atom.xml" type="application/atom+xml" rel="alternate" title="Blog ATOM Feed" />

    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41419012-5', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function (d, w, c) {
            (w[c] = w[c] || []).push(function() {
                try {
                    w.yaCounter28700916 = new Ya.Metrika({
                        id:28700916,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true,
                        webvisor:true,
                        trackHash:true
                    });
                } catch(e) { }
            });

            var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
            s.type = "text/javascript";
            s.async = true;
            s.src = "https://mc.yandex.ru/metrika/watch.js";

            if (w.opera == "[object Opera]") {
                d.addEventListener("DOMContentLoaded", f, false);
            } else { f(); }
        })(document, window, "yandex_metrika_callbacks");
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/28700916" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->

    <!-- jQuery -->
    <script src="/js/jquery-3.3.1.slim.min.js"></script>
  </head>

  <body>
    <div class="bg-primary">
      <div class="container bg-primary">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" id="nav-link-blog" href="/ru/posts/">Блог</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-link-blog-content" href="/ru/content/">Содержание</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-link-about" href="/ru/about/">Об авторе</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-link-about" href="/prodotnetbenchmarking/">Pro .NET Benchmarking</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Ru</a>
              <div class="dropdown-menu">
                  <a class="dropdown-item" href='/posts/static-field-in-generic-type/'>En</a>
              </div>
            </li>
          </ul>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item"><a class="nav-link" href="https://github.com/AndreyAkinshin"><i class="fab fa-github" title="GitHub" style="color:white"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://twitter.com/andrey_akinshin"><i class="fab fa-twitter" title="Twitter" style="color:white"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="/ru/rss.xml"><i class="fas fa-rss" title="RSS" style="color:white"></i></a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="container">
      <div class="blog-main">
<div class="blog-post">

<h2 class="blog-post-title" id="post-title">Статические поля в generic-классах</h2>
<span class="blog-post-meta">
  <b>Дата:</b> 21 января 2015.
  <b>Теги:</b>
        <a href="/ru/tags/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
        <a href="/ru/tags/csharp"><span class="badge badge-pill badge-info">C#</span></a>
        <a href="/ru/tags/generic"><span class="badge badge-pill badge-info">Generic</span></a>
        <a href="/ru/tags/static"><span class="badge badge-pill badge-info">Static</span></a>
</span><br /><br />

<p>Сегодня мы кратко поговорим о статических полях в generic-классах. Тема простая, но у некоторых разработчиков она вызывает трудности. Итак, задачка: что выведет следующий код?</p>
<pre><code class="language-cs">class Foo&lt;T&gt;
{
  public static int Bar;
}
void Main()
{
  Foo&lt;int&gt;.Bar++;
  Console.WriteLine(Foo&lt;double&gt;.Bar);
}
</code></pre>
<!--more-->
<p><em>Правильный ответ:</em> <code>0</code>. Всё дело в том, что <code>Foo&lt;int&gt;</code> и <code>Foo&lt;double&gt;</code> — это два разных класса, у каждого своё собственное статическое поле. И это весьма логично. Действительно, раз у нас есть поле, то оно должно принадлежать экземпляру какого-то класса, а экземпляр <code>Foo&lt;T&gt;</code> создать невозможно, необходимо явно указать <code>T</code>. Как можно догадаться, <code>typeof(Foo&lt;int&gt;) != typeof(Foo&lt;double&gt;)</code>, поэтому каждый класс получит собственное статическое поле. Если поменять значение этого поля в одном классе, то это никак не повлияет на значение соответствующего поля в другом классе. Вроде бы просто, но не всем очевидно: мне доводилось видеть, как данный нюанс вызывал проблемы в продакшн-проектах. Поэтому я и решил написать небольшую заметку по этому поводу.</p>
<p>Приведу также цитату из документации языка C#. <strong>CSharp Language Specification 5.0, 10.5.1:</strong></p>
<blockquote>
<p>When a field declaration includes a  static modifier, the fields introduced by the declaration are static fields. When no  static modifier is present, the fields introduced by the declaration are instance fields. Static fields and instance fields are two of the several kinds of variables (§5) supported by C#, and at times they are referred to as static variables and instance variables, respectively. A static field is not part of a specific instance; instead, it is shared amongst all instances of a closed type (§4.4.2). No matter how many instances of a closed class type are created, there is only ever one copy of a static field for the associated application domain.</p>
</blockquote>
<p>У MS в разделе <strong>Code Analysis for Managed Code Warnings</strong> есть такое предупреждение: <a href="https://msdn.microsoft.com/en-us/library/ms182139.aspx">CA1000</a>: Do not declare static members on generic types (DoNotDeclareStaticMembersOnGenericTypes). Ну и, само собой, в ReSharper также есть подобный warning под названием StaticMemberInGenericType (см. <a href="https://confluence.jetbrains.com/display/ReSharper/Static+field+in+generic+type">ReSharper wiki</a>).</p>
<p><strong>Мораль:</strong> старайтесь не делать изменяемые статические поля в generic-классах. А ещё лучше — просто старайтесь не делать изменяемые статические поля. Как правило, в нормальном проекте такую потребность всегда можно обойти с помощью красивого архитектурного решения. Даже если вы считаете, что изменяемое статическое поле вам просто необходимо, и при этом прекрасно понимаете нюансы, связанные с его использованием в generic-классах (используете эту фичу в своих целях), то помните, что кто-нибудь, кто будет работать с вашим кодом, может не понять авторскую задумку и чего-нибудь испортить или использовать не по плану. А архитектуру нужно стараться делать так, чтобы что-то испортить было чертовски сложно.</p>
<h3 id="section">Задачи</h3>
<p>Приведённая задачка доступна в <a href="http://problembook.net/">ProblemBookt.NET</a> <a href="http://problembook.net/content/ru/Oop/StaticFieldInGenericType-P.html">на русском</a> и <a href="http://problembook.net/content/en/Oop/StaticFieldInGenericType-P.html">на английском</a>.</p>

<!-- Share -->

Поделиться:
<a href="https://twitter.com/intent/tweet?text=Статические поля в generic-классах&url=http://aakinshin.net/ru/posts/static-field-in-generic-type/&via=andrey_akinshin&related=andrey_akinshin" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fab fa-twitter fa-2x" title="Twitter"></i></a>
<a href="https://www.reddit.com/submit?url=http://aakinshin.net/ru/posts/static-field-in-generic-type/" target="_blank" title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a>
<a href="https://news.ycombinator.com/submitlink?u=http://aakinshin.net/ru/posts/static-field-in-generic-type/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a>
<a href="https://facebook.com/sharer.php?u=http://aakinshin.net/ru/posts/static-field-in-generic-type/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fab fa-facebook fa-2x"></i></a>
<a href="https://plus.google.com/share?url=http://aakinshin.net/ru/posts/static-field-in-generic-type/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fab fab fa-google-plus-g fa-2x"></i></a>
<a href="http://vk.com/share.php?url=http://aakinshin.net/ru/posts/static-field-in-generic-type/" target="_blank" title="Share on VKontakte"><i class="fab fa-vk fa-2x"></i></a>
<a href="https://getpocket.com/save?url=http://aakinshin.net/ru/posts/static-field-in-generic-type/&title=Статические поля в generic-классах" target="_blank" title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a>
<hr />

<!-- GitHub -->
<div>
  Исходный код поста находится на GitHub:<br />
  <a href="https://github.com/AndreyAkinshin/aakinshin.net/blob/master/web/_posts/ru/2015/static-field-in-generic-type.md">https://github.com/AndreyAkinshin/aakinshin.net/blob/master/web/_posts/ru/2015/static-field-in-generic-type.md</a>
</div>

</div>
</div>
    </div>

    <footer class="blog-footer">
      <div class="container">
        <p>&copy; 2013–2019 Андрей Акиньшин</p>
      </div>
    </footer>

    <!-- jQuery first (header), then popper, then Bootstrap JS. -->
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <!-- Other scripts -->
    <script src="/js/highlight.pack.js"></script>
    <script src="/js/anchor.min.js"></script>
    <script src="/js/custom.js"></script>
  </body>
</html>
