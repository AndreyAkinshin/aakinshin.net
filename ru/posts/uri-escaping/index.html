<!doctype html><html lang=ru><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Андрей Акиньшин"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content=".NET,C#,Mono,URI,Escaping"><title>Об экранировании URI в .NET | Андрей Акиньшин</title><meta name=description content="Часть 1 Загадка на сегодня: что выведет код?
var uri = new Uri(&amp;#34;http://localhost/%2F1&amp;#34;); Console.WriteLine(uri.OriginalString); Console.WriteLine(u..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.4b9b1feb2fd5d603661a92526f99ae8821dceff78915a43e751f547a64ae7a5d.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/ru/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/ru/about/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/ru/posts/>Посты</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/ru/about/>Об авторе</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Об экранировании URI в .NET</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2014-11-13>13 ноября 2014</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/ru/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/ru/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/ru/tags/mono/>Mono</a>
<a class=label-link href=https://aakinshin.net/ru/tags/uri/>URI</a>
<a class=label-link href=https://aakinshin.net/ru/tags/escaping/>Escaping</a></div></div><br><div class=main-content><h2 id=часть-1>Часть 1</h2><p>Загадка на сегодня: что выведет код?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>uri</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Uri</span><span class=p>(</span><span class=s>&#34;http://localhost/%2F1&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=n>OriginalString</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=n>AbsoluteUri</span><span class=p>);</span>
</span></span></code></pre></div><p>Правильный ответ: зависит. Давайте немножко поразбираемся.</p><h3 id=так-что-же-он-выведет>Так что же он выведет?</h3><p>Результат работы зависит от версии .NET:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=c1>// .NET 4.0</span>
</span></span><span class=line><span class=cl><span class=n>http</span><span class=p>:</span><span class=c1>//localhost/%2F1</span>
</span></span><span class=line><span class=cl><span class=n>http</span><span class=p>:</span><span class=c1>//localhost//1</span>
</span></span><span class=line><span class=cl><span class=c1>// .NET 4.5</span>
</span></span><span class=line><span class=cl><span class=n>http</span><span class=p>:</span><span class=c1>//localhost/%2F1</span>
</span></span><span class=line><span class=cl><span class=n>http</span><span class=p>:</span><span class=c1>//localhost/%2F1</span>
</span></span></code></pre></div><h3 id=да-как-же-так-то>Да как же так-то?</h3><p>Увы, до версии .NET 4.0 имела место <a href=https://connect.microsoft.com/VisualStudio/feedback/details/511010/erroneous-uri-parsing-for-encoded-reserved-characters-according-to-rfc-3986>неприятная бага</a> с экранированием слеша (он же <code>%2F</code>). В 4.5 её решили пофиксить, чтобы поведение соответствовало <a href=http://tools.ietf.org/html/rfc3986>RFC 3986</a>. Сделали вроде бы правильно, но добавили дополнительной головной боли разработчикам, которые не знают про этот небольшой нюанс: теперь механизм экранирования зависит от версии Framework-а. Лучше всего использовать правильный механизм из .NET 4.5. Но что, если у нас нет .NET 4.5? Имеется путь починить поведение в .NET 4.0. Для этого необходимо добавить в *.config-файл вашего приложения магические строчки:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;uri&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;schemeSettings&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;add</span> <span class=na>name=</span><span class=s>&#34;http&#34;</span> 
</span></span><span class=line><span class=cl>           <span class=na>genericUriParserOptions=</span><span class=s>&#34;DontUnescapePathDotsAndSlashes&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/schemeSettings&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/uri&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></div><p>Работает приведённый фокус-покус начиная с .NET 4.0 beta 2. Т.е., скажем, в .NET 3.5 так сделать не получится. Так что придётся крутиться и вертеться. Например, на просторах интернета <a href=http://stackoverflow.com/a/784937/184842>можно найти</a> вот такой чудо-хак:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>void</span> <span class=n>ForceCanonicalPathAndQuery</span><span class=p>(</span><span class=n>Uri</span> <span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>string</span> <span class=n>paq</span> <span class=p>=</span> <span class=n>uri</span><span class=p>.</span><span class=n>PathAndQuery</span><span class=p>;</span> <span class=c1>// need to access PathAndQuery</span>
</span></span><span class=line><span class=cl>  <span class=n>FieldInfo</span> <span class=n>flagsFieldInfo</span> <span class=p>=</span> <span class=k>typeof</span><span class=p>(</span><span class=n>Uri</span><span class=p>).</span><span class=n>GetField</span><span class=p>(</span><span class=s>&#34;m_Flags&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>BindingFlags</span><span class=p>.</span><span class=n>Instance</span> <span class=p>|</span> <span class=n>BindingFlags</span><span class=p>.</span><span class=n>NonPublic</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>ulong</span> <span class=n>flags</span> <span class=p>=</span> <span class=p>(</span><span class=kt>ulong</span><span class=p>)</span> <span class=n>flagsFieldInfo</span><span class=p>.</span><span class=n>GetValue</span><span class=p>(</span><span class=n>uri</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>flags</span> <span class=p>&amp;=</span> <span class=p>~((</span><span class=kt>ulong</span><span class=p>)</span> <span class=m>0x30</span><span class=p>);</span> <span class=c1>// Flags.PathNotCanonical|Flags.QueryNotCanonical</span>
</span></span><span class=line><span class=cl>  <span class=n>flagsFieldInfo</span><span class=p>.</span><span class=n>SetValue</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=а-что-будет-в-mono>А что будет в Mono?</h3><p>В Mono <a href="https://bugzilla.xamarin.com/show_bug.cgi?id=16960">накосячили</a> точно также. Починка осуществилась совсем недавно с <a href=http://www.mono-project.com/docs/about-mono/releases/3.10.0/>выходом</a> Mono 3.10.0 в октябре 2014. Так что если вы сидите на последней версии, то у вас уже всё должно быть хорошо. Но как же нам теперь переключаться между старым и новым поведением? Для этих целей в классе <code>System.Uri</code> имеется свойство <code>IriParsing</code>. Заглянем в <a href=https://github.com/mono/mono/blob/mono-3.10.0/mcs/class/System/System/Uri.cs>код</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>private</span> <span class=k>static</span> <span class=kt>bool</span> <span class=n>s_IriParsing</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>internal</span> <span class=k>static</span> <span class=kt>bool</span> <span class=n>IriParsing</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>s_IriParsing</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>set</span> <span class=p>{</span> <span class=n>s_IriParsing</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Выставляется свойство следующим образом:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>static</span> <span class=n>Uri</span> <span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#if NET_4_5</span>
</span></span><span class=line><span class=cl>    <span class=n>IriParsing</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=n>endif</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>iriparsingVar</span> <span class=p>=</span> 
</span></span><span class=line><span class=cl>        <span class=n>Environment</span><span class=p>.</span><span class=n>GetEnvironmentVariable</span> <span class=p>(</span><span class=s>&#34;MONO_URI_IRIPARSING&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>iriparsingVar</span> <span class=p>==</span> <span class=s>&#34;true&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>IriParsing</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>iriparsingVar</span> <span class=p>==</span> <span class=s>&#34;false&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>IriParsing</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Т.е. выставить его проще всего через переменную окружения <code>MONO_URI_IRIPARSING</code>.</p><h3 id=заключение>Заключение</h3><p>Бага не особо приятная и может стоить вам многих часов душевного спокойствия, если вы на неё случайно наткнётесь. Поэтому я решил оформить такую вот небольшую заметку, чтобы побольше людей было в курсе. Помните о неоднозначности экранирования некоторых URI и пишите стабильный код.</p><h3 id=ссылки>Ссылки</h3><ul><li><a href=https://connect.microsoft.com/VisualStudio/feedback/details/511010/erroneous-uri-parsing-for-encoded-reserved-characters-according-to-rfc-3986>MS Connect 511010: Erroneous URI parsing for encoded, reserved characters, according to RFC 3986</a></li><li><a href="https://bugzilla.xamarin.com/show_bug.cgi?id=16960">Mono Bug 16960</a></li><li><a href=http://stackoverflow.com/q/20769150/184842>StackOverflow: Getting a Uri with escaped slashes on mono</a></li><li><a href=http://stackoverflow.com/q/781205/184842%22%3EStackOverflow>GETting a URL with an url-encoded slash</a></li><li><a href=http://www.mono-project.com/docs/about-mono/releases/3.10.0/>Mono 3.10.0 release notes</a></li><li><a href=http://mikehadlow.blogspot.co.uk/2011/08/how-to-stop-systemuri-un-escaping.html>Mike Hadlow: How to stop System.Uri un-escaping forward slash characters</a></li><li><a href=http://grootveld.com/archives/21/url-encoded-slashes-in-systemuri>Arnout&rsquo;s Eclectica: URL-encoded slashes in System.Uri</a></li></ul><h2 id=часть-2>Часть 2</h2><p>На StackOverflow мне попался интересный вопрос: <a href=http://stackoverflow.com/q/27062562/184842>«Unit test ReSharper and NUnit give different results»</a>. Суть заключалась в том, что ReSharper и NUnit дают разные результаты при экранировании URI. Я решил немножко углубиться в эту проблему. Разобраться с проблемой нам поможет следующая небольшая программка:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Print</span><span class=p>(</span><span class=s>&#34;http://localhost/a%2Fb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Print</span><span class=p>(</span><span class=s>&#34;http://localhost/a.?b&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Print</span><span class=p>(</span><span class=s>&#34;http://localhost/a?b=c%3Fd%3De&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Print</span><span class=p>(</span><span class=kt>string</span> <span class=n>uriString</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>uri</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Uri</span><span class=p>(</span><span class=n>uriString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Original: &#34;</span> <span class=p>+</span> <span class=n>uri</span><span class=p>.</span><span class=n>OriginalString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Absolute: &#34;</span> <span class=p>+</span> <span class=n>uri</span><span class=p>.</span><span class=n>AbsoluteUri</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;ToString: &#34;</span> <span class=p>+</span> <span class=n>uri</span><span class=p>.</span><span class=n>ToString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Я взял на рассмотрение три строки: с экранированным слешом, с точкой и с экранированными вопросом и знаком равенства. Программа запускалась под MS.NET 4.0, MS.NET 4.0 с опцией <code>genericUriParserOptions="DontUnescapePathDotsAndSlashes"</code>, MS.NET 4.5, Mono 3.2.8, Mono 3.10.0. Результаты:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=c1>// MS.NET 4.0:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a/b</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a/b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c?d=e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// MS.NET 4.0 (DontUnescapePathDotsAndSlashes):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a/b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c?d=e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// MS.NET 4.5:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Mono 3.2.8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a/b</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a/b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd=e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Mono 3.10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a%2Fb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a.?b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Original</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>Absolute</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span><span class=line><span class=cl><span class=n>ToString</span><span class=p>:</span> <span class=n>http</span><span class=p>:</span><span class=c1>//localhost/a?b=c%3Fd%3De</span>
</span></span></code></pre></div><p>Внимательное созерцание результатов может подтолкнуть к следующим выводам:</p><ul><li><code>uri.AbsoluteUri</code> совсем не обязательно совпадает с <code>uri.ToString()</code>. Например, <code>DontUnescapePathDotsAndSlashes</code> хак в MS.NET 4.0 при экранировании слеша влияет на <code>AbsoluteUri</code>, но не оказывает влияния на <code>ToString()</code>. Под Mono 3.2.8 можно увидеть проблемы с экранированным знаком равенства в <code>AbsoluteUri</code>.</li><li>В Mono и MS.NET были разные проблемы с обработкой URI. Например, под MS.NET 4.0 строка <code>a.?b</code> превратилась в <code>a?b</code>, а под Mono 3.2.8 мы увидели всё тот же <code>a.?b</code>.</li><li>В последних версиях (MS.NET 4.5 и Mono 3.10) всё хорошо: <code>AbsoluteUri</code> и <code>ToString()</code> на <em>приведённых примерах</em> совпадают с <code>OriginalString</code>.</li></ul><p>Что касается изначального StackOverflow-вопроса, то ReSharper проводит тестирование правильно: он запускает тесты под нужную версию .NET. А NUnit при консольном тестировании без указания специфических параметров по каким-то причинам может подхватить логику из старых библиотек.</p><h3 id=выводы>Выводы</h3><p>Если вы работаете с URI, в который могут попасть разные спецсимволы в экранированном или явном виде, то лучше бы вам не полагаться на стандартную реализацию по обработке исходной строчки: результат работы <code>AbsoluteUri</code> и <code>ToString()</code> могут вас неприятно удивить. Если вы уверены, что у вас повсеместно используется MS.NET 4.5+ или Mono 3.10+, то скорее всего у вас всё будет нормально, но при поддержке старых версий .NET лучше бы написать свою логику по работе с URI.</p></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Поделиться:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fru%2fposts%2furi-escaping%2f&title=%d0%9e%d0%b1%20%d1%8d%d0%ba%d1%80%d0%b0%d0%bd%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b8%20URI%20%d0%b2%20.NET" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=%d0%9e%d0%b1%20%d1%8d%d0%ba%d1%80%d0%b0%d0%bd%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b8%20URI%20%d0%b2%20.NET&url=https%3a%2f%2faakinshin.net%2fru%2fposts%2furi-escaping%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fru%2fposts%2furi-escaping%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fru%2fposts%2furi-escaping%2f&title=%d0%9e%d0%b1%20%d1%8d%d0%ba%d1%80%d0%b0%d0%bd%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b8%20URI%20%d0%b2%20.NET" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2022 <span class=whitespace-nowrap>Андрей Акиньшин</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/ru/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>anchors.options={placement:"left",icon:"§"},anchors.add("h1"),anchors.add("h2"),anchors.add("h3")</script></body></html>