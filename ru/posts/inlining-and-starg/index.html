<!doctype html><html lang=ru class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Андрей Акиньшин"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content=".NET,C#,Inlining"><title>История про инлайнинг под JIT-x86 и starg | Андрей Акиньшин</title><meta name=description content="Порой можно узнать много интересного во время чтения исходников .NET. Взглянем на конструктор типа Decimal из .NET Reference Source (mscorlib/system/decima..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=https://aakinshin.net/sass/bootstrap-light.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=https://aakinshin.net/sass/bootstrap-dark.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.d7f6578e23ad3f0c33c589f9bcb34f995b45121f1f3ce888869c86b26826c845.js></script>
<script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.9e68d431432744c07a43381a8a833ffe0921cc0e006d84ad97f0b0d43c5cd82d.mjs></script>
<link href=https://aakinshin.net/css/fontawesome-all.min.178e95bba6ea2e9a90838cd646658f4bf6667a6ceaa057cb587bf7e6eb8412d3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.2a76db7cc14055b3bafacc363f453917ab54a818a7db2a0a9b2409c0f6bf07c5.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.7e186db80d8c431d196b3e0718afb0636b82a269a8c92521c11a55267a24fc27.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/ru/posts/index.xml title="RSS Feed"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVB6MXSX32"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZVB6MXSX32")</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-41419012-5"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-41419012-5")</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[o]=e[o]||function(){(e[o].a=e[o].a||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym"),ym(28700916,"init",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0})</script><noscript><div><img src=https://mc.yandex.ru/watch/28700916 style=position:absolute;left:-9999px alt></div></noscript><script src=/js/jquery-3.3.1.slim.min.js></script></head><body><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/ru/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>Блог</a><ul class="dropdown-menu bg-primary"><li><a class=dropdown-item href=https://aakinshin.net/ru/posts/>Все Посты</a></li><li></li><a class=dropdown-item href=https://aakinshin.net/ru/tags/>Все Теги</a></li></ul></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/ru/about/>Об авторе</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>RU</a><ul class="dropdown-menu bg-primary"><li></li><a class=dropdown-item href=https://aakinshin.net/posts/inlining-and-starg/>EN</a></li></ul></li></ul><ul class="navbar-nav ms-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>История про инлайнинг под JIT-x86 и starg</h1><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2015-02-26>26 февраля 2015</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>
&nbsp;
<a href=https://aakinshin.net/ru/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/ru/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/ru/tags/inlining/ class="badge badge-info">Inlining</a></span><br><br><p>Порой можно узнать много интересного во время чтения исходников .NET. Взглянем на конструктор типа <code>Decimal</code> из .NET Reference Source (<a href=http://referencesource.microsoft.com/#mscorlib/system/decimal.cs,158>mscorlib/system/decimal.cs,158</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=c1>// Constructs a Decimal from an integer value.</span>
</span></span><span class=line><span class=cl><span class=p>//</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>Decimal</span><span class=p>(</span><span class=kt>int</span> <span class=k>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//  JIT today can&#39;t inline methods that contains &#34;starg&#34; opcode.</span>
</span></span><span class=line><span class=cl>    <span class=c1>//  For more details, see DevDiv Bugs 81184: x86 JIT CQ: Removing the inline striction of &#34;starg&#34;.</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>value_copy</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>value_copy</span> <span class=p>&gt;=</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span> <span class=p>=</span> <span class=n>SignMask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>value_copy</span> <span class=p>=</span> <span class=p>-</span><span class=n>value_copy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>lo</span> <span class=p>=</span> <span class=n>value_copy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mid</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>hi</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>В комментарии сказано, что если метод содержит IL-опкод <a href=https://msdn.microsoft.com/library/system.reflection.emit.opcodes.starg.aspx>starg</a>, то он не может быть заинлайнен под x86. Любопытно, не правда ли?</p><h3 id=исходники-jit>Исходники JIT</h3><p>Давайте разберёмся в ситуации. Заглянем в исходники JIT из CoreCLR. Фрагмент файла <a href=https://github.com/dotnet/coreclr/blob/65456c070ffbc97f14c1c32318dabc221646d8d6/src/jit/flowgraph.cpp#L4252>flowgraph.cpp</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=c1>// NetCF had some strict restrictions on inlining.  Specifically they</span>
</span></span><span class=line><span class=cl><span class=c1>// would only inline methods that fit a specific pattern of loading</span>
</span></span><span class=line><span class=cl><span class=c1>// arguments inorder, starting with zero, with no skipping, but not</span>
</span></span><span class=line><span class=cl><span class=c1>// needing to load all of them.  Then a &#39;body&#39; section that could do</span>
</span></span><span class=line><span class=cl><span class=c1>// anything besides control flow.  And a final ending ret opcode.</span>
</span></span><span class=line><span class=cl><span class=c1>// Lastly they did not allow starg or ldarga.</span>
</span></span><span class=line><span class=cl><span class=c1>// These simplifications allowed them to skip past the ldargs, when</span>
</span></span><span class=line><span class=cl><span class=c1>// inlining, and just use the caller&#39;s EE stack as the callee&#39;s EE</span>
</span></span><span class=line><span class=cl><span class=c1>// stack, after optionally popping a few &#39;arguments&#39; from the end.</span>
</span></span><span class=line><span class=cl><span class=p>//</span>
</span></span><span class=line><span class=cl><span class=c1>// stateNetCFQuirks is a simple state machine to track that state</span>
</span></span><span class=line><span class=cl><span class=c1>// and allow us to match those restrictions.</span>
</span></span><span class=line><span class=cl><span class=c1>// State -1 means we&#39;re not tracking (no quirks mode)</span>
</span></span><span class=line><span class=cl><span class=c1>// State 0 though 0x0000FFFF tracks what the *next* ldarg should be</span>
</span></span><span class=line><span class=cl><span class=c1>//    to match the pattern</span>
</span></span><span class=line><span class=cl><span class=c1>// State 0x00010000 and above means we are in the &#39;body&#39; section and</span>
</span></span><span class=line><span class=cl><span class=c1>//    thus no more ldarg&#39;s are allowed.</span>
</span></span></code></pre></div><p>Комментарий гласит, что если метод содержит IL-команду <code>starg</code> или <code>ldarga</code>, то инлайнинг не выполнится. Почитаем код и убедимся, что это действительно так. Вскоре после комментария происходит выбор опкода:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>switch</span> <span class=p>(</span><span class=n>opcode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>CEE_STARG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>CEE_STARG_S</span><span class=p>:</span>     <span class=k>goto</span> <span class=n>ARG_WRITE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>CEE_LDARGA</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>CEE_LDARGA_S</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>CEE_LDLOCA</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>CEE_LDLOCA_S</span><span class=p>:</span>    <span class=k>goto</span> <span class=n>ADDR_TAKEN</span><span class=p>;</span>
</span></span></code></pre></div><p>Случай с командой <code>starg</code> попроще, взглянем на него более внимательно:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=nl>ARG_WRITE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>compIsForInlining</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef DEBUG
</span></span></span><span class=line><span class=cl><span class=cp></span>                <span class=k>if</span> <span class=p>(</span><span class=n>verbose</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n\n</span><span class=s>Inline expansion aborted due to opcode at offset [%02u] which writes to an argument</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=n>codeAddr</span><span class=o>-</span><span class=n>codeBegp</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>                <span class=cm>/* The inliner keeps the args as trees and clones them.  Storing the arguments breaks that
</span></span></span><span class=line><span class=cl><span class=cm>                 * simplification.  To allow this, flag the argument as written to and spill it before
</span></span></span><span class=line><span class=cl><span class=cm>                 * inlining.  That way the STARG in the inlinee is trivial. */</span>
</span></span><span class=line><span class=cl>                <span class=n>inlineFailReason</span> <span class=o>=</span> <span class=s>&#34;Inlinee writes to an argument.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>goto</span> <span class=n>InlineNever</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>noway_assert</span><span class=p>(</span><span class=n>sz</span> <span class=o>==</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>BYTE</span><span class=p>)</span> <span class=o>||</span> <span class=n>sz</span> <span class=o>==</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>WORD</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>codeAddr</span> <span class=o>&gt;</span> <span class=n>codeEndp</span> <span class=o>-</span> <span class=n>sz</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>goto</span> <span class=n>TOO_FAR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>varNum</span> <span class=o>=</span> <span class=p>(</span><span class=n>sz</span> <span class=o>==</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>BYTE</span><span class=p>))</span> <span class=o>?</span> <span class=n>getU1LittleEndian</span><span class=p>(</span><span class=n>codeAddr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                              <span class=o>:</span> <span class=n>getU2LittleEndian</span><span class=p>(</span><span class=n>codeAddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>varNum</span> <span class=o>=</span> <span class=n>compMapILargNum</span><span class=p>(</span><span class=n>varNum</span><span class=p>);</span> <span class=c1>// account for possible hidden param
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                <span class=c1>// This check is only intended to prevent an AV.  Bad varNum values will later
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// be handled properly by the verifier.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=n>varNum</span> <span class=o>&lt;</span> <span class=n>lvaTableCnt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>lvaTable</span><span class=p>[</span><span class=n>varNum</span><span class=p>].</span><span class=n>lvArgWrite</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><p>Действительно, всё выглядит так, что для опкода <code>starg</code> в конечном итоге выполнится <code>goto InlineNever</code>. В <code>DEBUG</code>-режиме мы также получим сообщение, что процесс инлайнинга был прерван.</p><p>Эта «фича» используется в других местах JIT-а. Взглянем на фрагмент файла <a href=https://raw.githubusercontent.com/dotnet/coreclr/65456c070ffbc97f14c1c32318dabc221646d8d6/src/jit/importer.cpp>importer.cpp</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=cm>/******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> Is this the original &#34;this&#34; argument to the call being inlined?
</span></span></span><span class=line><span class=cl><span class=cm> 
</span></span></span><span class=line><span class=cl><span class=cm> Note that we do not inline methods with &#34;starg 0&#34;, and so we do not need to
</span></span></span><span class=line><span class=cl><span class=cm> worry about it.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span></code></pre></div><h3 id=смотрим-на-decimal>Смотрим на Decimal</h3><p>Вернёмся к нашему конструктору класса <code>Decimal</code>, убедимся, что копирование параметра <code>value</code> в локальную переменную действительно помогает. Вооружимся <a href=http://ilspy.net/>ILSpy</a> и взглянем на IL-код нашего конструктора:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>// Methods
</span></span><span class=line><span class=cl>.method public hidebysig specialname rtspecialname 
</span></span><span class=line><span class=cl>  instance void .ctor (
</span></span><span class=line><span class=cl>    int32 &#39;value&#39;
</span></span><span class=line><span class=cl>  ) cil managed 
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  .custom instance void __DynamicallyInvokableAttribute::.ctor() = (
</span></span><span class=line><span class=cl>    01 00 00 00
</span></span><span class=line><span class=cl>  )
</span></span><span class=line><span class=cl>  // Method begins at RVA 0x222e8
</span></span><span class=line><span class=cl>  // Code size 51 (0x33)
</span></span><span class=line><span class=cl>  .maxstack 2
</span></span><span class=line><span class=cl>  .locals init (
</span></span><span class=line><span class=cl>    [0] int32
</span></span><span class=line><span class=cl>  )
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  IL_0000: ldarg.1
</span></span><span class=line><span class=cl>  IL_0001: stloc.0
</span></span><span class=line><span class=cl>  IL_0002: ldloc.0
</span></span><span class=line><span class=cl>  IL_0003: ldc.i4.0
</span></span><span class=line><span class=cl>  IL_0004: blt.s IL_000f
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  IL_0006: ldarg.0
</span></span><span class=line><span class=cl>  IL_0007: ldc.i4.0
</span></span><span class=line><span class=cl>  IL_0008: stfld int32 System.Decimal::&#39;flags&#39;
</span></span><span class=line><span class=cl>  IL_000d: br.s IL_001d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  IL_000f: ldarg.0
</span></span><span class=line><span class=cl>  IL_0010: ldc.i4 -2147483648
</span></span><span class=line><span class=cl>  IL_0015: stfld int32 System.Decimal::&#39;flags&#39;
</span></span><span class=line><span class=cl>  IL_001a: ldloc.0
</span></span><span class=line><span class=cl>  IL_001b: neg
</span></span><span class=line><span class=cl>  IL_001c: stloc.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  IL_001d: ldarg.0
</span></span><span class=line><span class=cl>  IL_001e: ldloc.0
</span></span><span class=line><span class=cl>  IL_001f: stfld int32 System.Decimal::lo
</span></span><span class=line><span class=cl>  IL_0024: ldarg.0
</span></span><span class=line><span class=cl>  IL_0025: ldc.i4.0
</span></span><span class=line><span class=cl>  IL_0026: stfld int32 System.Decimal::mid
</span></span><span class=line><span class=cl>  IL_002b: ldarg.0
</span></span><span class=line><span class=cl>  IL_002c: ldc.i4.0
</span></span><span class=line><span class=cl>  IL_002d: stfld int32 System.Decimal::hi
</span></span><span class=line><span class=cl>  IL_0032: ret
</span></span><span class=line><span class=cl>} // end of method Decimal::.ctor
</span></span></code></pre></div><p>А что было бы, если бы мы не скопировали <code>value</code> в локальную переменную? Давайте проверим. Напишем простой код:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyDecimal</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>SignMask</span>  <span class=p>=</span> <span class=k>unchecked</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=m>0x80000000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>hi</span><span class=p>,</span> <span class=n>lo</span><span class=p>,</span> <span class=n>mid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=n>MyDecimal</span><span class=p>(</span><span class=kt>int</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&gt;=</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span> <span class=p>=</span> <span class=n>SignMask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>value</span> <span class=p>=</span> <span class=p>-</span><span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>lo</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mid</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>hi</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Скомпилируем его:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>&gt;csc Program.cs /optimize
</span></span><span class=line><span class=cl>Microsoft (R) Visual C# Compiler version 4.0.30319.33440
</span></span><span class=line><span class=cl>for Microsoft (R) .NET Framework 4.5
</span></span><span class=line><span class=cl>Copyright (C) Microsoft Corporation. All rights reserved.
</span></span></code></pre></div><p>И взглянем на IL:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>.class private auto ansi beforefieldinit MyDecimal
</span></span><span class=line><span class=cl>  extends [mscorlib]System.Object
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  // Fields
</span></span><span class=line><span class=cl>  .field private static literal int32 SignMask = int32(-2147483648)
</span></span><span class=line><span class=cl>  .field private int32 &#39;flags&#39;
</span></span><span class=line><span class=cl>  .field private int32 hi
</span></span><span class=line><span class=cl>  .field private int32 lo
</span></span><span class=line><span class=cl>  .field private int32 mid
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  // Methods
</span></span><span class=line><span class=cl>  .method public hidebysig specialname rtspecialname 
</span></span><span class=line><span class=cl>    instance void .ctor (
</span></span><span class=line><span class=cl>      int32 &#39;value&#39;
</span></span><span class=line><span class=cl>    ) cil managed 
</span></span><span class=line><span class=cl>  {
</span></span><span class=line><span class=cl>    // Method begins at RVA 0x2050
</span></span><span class=line><span class=cl>    // Code size 56 (0x38)
</span></span><span class=line><span class=cl>    .maxstack 8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    IL_0000: ldarg.0
</span></span><span class=line><span class=cl>    IL_0001: call instance void [mscorlib]System.Object::.ctor()
</span></span><span class=line><span class=cl>    IL_0006: ldarg.1
</span></span><span class=line><span class=cl>    IL_0007: ldc.i4.0
</span></span><span class=line><span class=cl>    IL_0008: blt.s IL_0013
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    IL_000a: ldarg.0
</span></span><span class=line><span class=cl>    IL_000b: ldc.i4.0
</span></span><span class=line><span class=cl>    IL_000c: stfld int32 MyDecimal::&#39;flags&#39;
</span></span><span class=line><span class=cl>    IL_0011: br.s IL_0022
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    IL_0013: ldarg.0
</span></span><span class=line><span class=cl>    IL_0014: ldc.i4 -2147483648
</span></span><span class=line><span class=cl>    IL_0019: stfld int32 MyDecimal::&#39;flags&#39;
</span></span><span class=line><span class=cl>    IL_001e: ldarg.1
</span></span><span class=line><span class=cl>    IL_001f: neg
</span></span><span class=line><span class=cl>    IL_0020: starg.s &#39;value&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    IL_0022: ldarg.0
</span></span><span class=line><span class=cl>    IL_0023: ldarg.1
</span></span><span class=line><span class=cl>    IL_0024: stfld int32 MyDecimal::lo
</span></span><span class=line><span class=cl>    IL_0029: ldarg.0
</span></span><span class=line><span class=cl>    IL_002a: ldc.i4.0
</span></span><span class=line><span class=cl>    IL_002b: stfld int32 MyDecimal::mid
</span></span><span class=line><span class=cl>    IL_0030: ldarg.0
</span></span><span class=line><span class=cl>    IL_0031: ldc.i4.0
</span></span><span class=line><span class=cl>    IL_0032: stfld int32 MyDecimal::hi
</span></span><span class=line><span class=cl>    IL_0037: ret
</span></span><span class=line><span class=cl>  } // end of method MyDecimal::.ctor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>} // end of class MyDecimal
</span></span></code></pre></div><p>Как мы видим, в строчке <code>IL_0020</code> действительно вызывается команда <code>starg.a</code>. Подобный приём используется также в конструкторе, который принимает аргумент типа <code>long</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=c1>// Constructs a Decimal from a long value.</span>
</span></span><span class=line><span class=cl><span class=p>//</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>Decimal</span><span class=p>(</span><span class=kt>long</span> <span class=k>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//  JIT today can&#39;t inline methods that contains &#34;starg&#34; opcode.</span>
</span></span><span class=line><span class=cl>    <span class=c1>//  For more details, see DevDiv Bugs 81184: x86 JIT CQ: Removing the inline striction of &#34;starg&#34;.</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>value_copy</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>value_copy</span> <span class=p>&gt;=</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span> <span class=p>=</span> <span class=n>SignMask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>value_copy</span> <span class=p>=</span> <span class=p>-</span><span class=n>value_copy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>lo</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>value_copy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mid</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>value_copy</span> <span class=p>&gt;&gt;</span> <span class=m>32</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>hi</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=проверяем-возможности-jit>Проверяем возможности JIT</h3><p>Для полноты исследования осталось убедиться, что JIT действительно себя ведёт именно так. Напишем простой код для проверки:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Runtime.CompilerServices</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=k>value</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>value</span> <span class=p>+=</span> <span class=n>SimpleMethod</span><span class=p>(</span><span class=m>0x11</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>value</span> <span class=p>+=</span> <span class=n>MethodWithStarg</span><span class=p>(</span><span class=m>0x12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>value</span> <span class=p>+=</span> <span class=n>MethodWithStargAggressive</span><span class=p>(</span><span class=m>0x13</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=k>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=kt>int</span> <span class=n>SimpleMethod</span><span class=p>(</span><span class=kt>int</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=kt>int</span> <span class=n>MethodWithStarg</span><span class=p>(</span><span class=kt>int</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>value</span> <span class=p>=</span> <span class=p>-</span><span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [MethodImpl(MethodImplOptions.AggressiveInlining)]</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=kt>int</span> <span class=n>MethodWithStargAggressive</span><span class=p>(</span><span class=kt>int</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>value</span> <span class=p>=</span> <span class=p>-</span><span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Метод <code>SimpleMethod</code> очень маленький и будет заинлайнен. Метод <code>MethodWithStarg</code> имеет следующее IL-представление:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=p>.</span><span class=n>method</span> <span class=k>private</span> <span class=n>hidebysig</span> <span class=k>static</span> 
</span></span><span class=line><span class=cl>  <span class=n>int32</span> <span class=n>MethodWithStarg</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>int32</span> <span class=err>&#39;</span><span class=k>value</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=n>cil</span> <span class=n>managed</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Method begins at RVA 0x2086</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Code size 10 (0xa)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>maxstack</span> <span class=m>8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>IL_0000</span><span class=p>:</span> <span class=n>ldarg</span><span class=p>.</span><span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=n>IL_0001</span><span class=p>:</span> <span class=n>ldc</span><span class=p>.</span><span class=n>i4</span><span class=p>.</span><span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=n>IL_0002</span><span class=p>:</span> <span class=n>bge</span><span class=p>.</span><span class=n>s</span> <span class=n>IL_0008</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>IL_0004</span><span class=p>:</span> <span class=n>ldarg</span><span class=p>.</span><span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=n>IL_0005</span><span class=p>:</span> <span class=n>neg</span>
</span></span><span class=line><span class=cl>  <span class=n>IL_0006</span><span class=p>:</span> <span class=n>starg</span><span class=p>.</span><span class=n>s</span> <span class=err>&#39;</span><span class=k>value</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>IL_0008</span><span class=p>:</span> <span class=n>ldarg</span><span class=p>.</span><span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=n>IL_0009</span><span class=p>:</span> <span class=n>ret</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=c1>// end of method Program::MethodWithStarg</span>
</span></span></code></pre></div><p>Данный код в строчке <code>IL_0006</code> содержит интересующую нас команду <code>starg.s</code>. Метод <code>MethodWithStargAggressive</code> имеет аналогичный код с той лишь разнице, что для него указан атрибут <code>[MethodImpl(MethodImplOptions.AggressiveInlining)]</code>. Взглянем на ассемблерный код под x86:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>008</span><span class=nf>A0050</span>  <span class=no>push</span>        <span class=no>ebp</span>  
</span></span><span class=line><span class=cl><span class=mi>008</span><span class=no>A0051</span>  <span class=no>mov</span>         <span class=no>ebp</span><span class=p>,</span><span class=no>esp</span>  
</span></span><span class=line><span class=cl><span class=mi>008</span><span class=no>A0053</span>  <span class=no>push</span>        <span class=no>esi</span>  
</span></span><span class=line><span class=cl><span class=mi>008</span><span class=no>A0054</span>  <span class=no>mov</span>         <span class=no>ecx</span><span class=p>,</span><span class=mi>12</span><span class=no>h</span>  
</span></span><span class=line><span class=cl><span class=mi>008</span><span class=no>A0059</span>  <span class=no>call</span>        <span class=no>dword</span> <span class=no>ptr</span> <span class=no>ds</span><span class=p>:[</span><span class=mi>7237</span><span class=no>BCh</span><span class=p>]</span>  <span class=err>//</span> <span class=no>MethodWithStarg</span>
</span></span><span class=line><span class=cl><span class=err>008</span><span class=nf>A005F</span>  <span class=no>add</span>         <span class=no>eax</span><span class=p>,</span><span class=mi>11</span><span class=no>h</span>  
</span></span><span class=line><span class=cl><span class=mi>008</span><span class=no>A0062</span>  <span class=no>mov</span>         <span class=no>esi</span><span class=p>,</span><span class=no>eax</span>  
</span></span><span class=line><span class=cl><span class=mi>008</span><span class=no>A0064</span>  <span class=no>mov</span>         <span class=no>ecx</span><span class=p>,</span><span class=mi>13</span><span class=no>h</span>  
</span></span><span class=line><span class=cl><span class=mi>008</span><span class=no>A0069</span>  <span class=no>call</span>        <span class=no>dword</span> <span class=no>ptr</span> <span class=no>ds</span><span class=p>:[</span><span class=mi>7237</span><span class=no>C8h</span><span class=p>]</span>  <span class=err>//</span> <span class=no>MethodWithStargAggressive</span>
</span></span><span class=line><span class=cl><span class=err>008</span><span class=nf>A006F</span>  <span class=no>add</span>         <span class=no>esi</span><span class=p>,</span><span class=no>eax</span>  
</span></span></code></pre></div><p>Эксперимент прошёл успешно. Метод <code>SimpleMethod</code> был заинлайнен, как и предполагалось. Метод <code>MethodWithStarg</code> не был заинлайнен, т. к. содержит IL-команду <code>starg.s</code>. Даже атрибут <code>[MethodImpl(MethodImplOptions.AggressiveInlining)]</code> не поспособствовал тому, чтобы инлайнинг был выполнен.</p><p>А теперь взглянем на ассемблерный код под x64:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00007</span><span class=nf>FFCC8720094</span>  <span class=no>mov</span>         <span class=no>ecx</span><span class=p>,</span><span class=mi>36</span><span class=no>h</span>
</span></span></code></pre></div><p>Как мы видим, JIT успешно выполнил инлайнинг всех методов и заранее предподсчитал результат.</p><h3 id=выводы>Выводы</h3><p>Для возможности инлайнинга методов необходимо выполнение ряда условий. JIT-x86 не может заинлайнить метод, в теле которого присутствуют IL-команды <code>starg</code> или <code>ldarga</code>, при этом даже <code>MethodImplOptions.AggressiveInlining</code> не в силах на это повлиять. Если вам критично, чтобы JIT мог выполнять инлайнинг, то порой придётся делать костыли, подобные тем, которые мы можем наблюдать в конструкторах класса <code>Decimal</code>.</p><h3 id=ссылки>Ссылки</h3><ul><li><a href=http://referencesource.microsoft.com/#mscorlib/system/decimal.cs,158>.NET Reference Source: Constructs a Decimal from an integer value</a></li><li><a href=https://github.com/dotnet/coreclr/blob/65456c070ffbc97f14c1c32318dabc221646d8d6/src/jit/flowgraph.cpp#L4252>CoreCLR, JIT sources: flowgraph.cpp (Feb 26, 2015)</a></li><li><a href=https://raw.githubusercontent.com/dotnet/coreclr/65456c070ffbc97f14c1c32318dabc221646d8d6/src/jit/importer.cpp>CoreCLR, JIT sources: importer.cpp (Feb 26, 2015)</a></li><li><a href=https://msdn.microsoft.com/library/system.reflection.emit.opcodes.starg.aspx>MSDN: starg</a></li><li><a href=https://msdn.microsoft.com/library/system.reflection.emit.opcodes.ldarga.aspx>MSDN: ldarga</a></li><li><a href=http://stackoverflow.com/questions/26369163/net-local-variable-optimization>Stackoverflow: .NET local variable optimization</a></li></ul><br><br><div class=row><div class="justify-content-center share-block"><div class=share-title>Поделиться:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fru%2fposts%2finlining-and-starg%2f&title=%d0%98%d1%81%d1%82%d0%be%d1%80%d0%b8%d1%8f%20%d0%bf%d1%80%d0%be%20%d0%b8%d0%bd%d0%bb%d0%b0%d0%b9%d0%bd%d0%b8%d0%bd%d0%b3%20%d0%bf%d0%be%d0%b4%20JIT-x86%20%d0%b8%20starg" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=%d0%98%d1%81%d1%82%d0%be%d1%80%d0%b8%d1%8f%20%d0%bf%d1%80%d0%be%20%d0%b8%d0%bd%d0%bb%d0%b0%d0%b9%d0%bd%d0%b8%d0%bd%d0%b3%20%d0%bf%d0%be%d0%b4%20JIT-x86%20%d0%b8%20starg&url=https%3a%2f%2faakinshin.net%2fru%2fposts%2finlining-and-starg%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fru%2fposts%2finlining-and-starg%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fru%2fposts%2finlining-and-starg%2f&title=%d0%98%d1%81%d1%82%d0%be%d1%80%d0%b8%d1%8f%20%d0%bf%d1%80%d0%be%20%d0%b8%d0%bd%d0%bb%d0%b0%d0%b9%d0%bd%d0%b8%d0%bd%d0%b3%20%d0%bf%d0%be%d0%b4%20JIT-x86%20%d0%b8%20starg" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class=blog-footer><div class=container><p>&copy; 2013&mdash;2022 Андрей Акиньшин
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub></i></a>
<a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter></i></a>
<a href=https://aakinshin.net/ru/posts/index.xml><i class="fas fa-rss" title=RSS></i></a>
|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.c26550621ac13c2221d7f6f5e6fe862345d3919723c50d730893e3e4856ecf35.js></script>
<script src=/js/bootstrap.bundle.min.js></script>
<script src=/js/anchor.min.js></script>
<script src=https://aakinshin.net/js/custom.min.f6e5d13fe39f305056cc743ee4cb8d117c1aba26176e58c82c79a480d02fe4b7.js></script></body></html>