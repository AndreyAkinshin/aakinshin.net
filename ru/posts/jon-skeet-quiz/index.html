<!doctype html><html lang=ru class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Андрей Акиньшин"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content=".NET,C#"><title>Jon Skeet's Quiz | Андрей Акиньшин</title><meta name=description content="Однажды Джона Скита попросили сформулировать три интересных вопроса на знание C#. Он спросил следующее (оригинал вопросника,	перевод статьи):
Q1. Вызов как..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=https://aakinshin.net/sass/bootstrap-light.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=https://aakinshin.net/sass/bootstrap-dark.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.d7f6578e23ad3f0c33c589f9bcb34f995b45121f1f3ce888869c86b26826c845.js></script>
<script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.9e68d431432744c07a43381a8a833ffe0921cc0e006d84ad97f0b0d43c5cd82d.mjs></script>
<link href=https://aakinshin.net/css/fontawesome-all.min.178e95bba6ea2e9a90838cd646658f4bf6667a6ceaa057cb587bf7e6eb8412d3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.60773ab7266ecc6e9625306f57c0a82a219b011dc3ea2d83763d1ecdf11c86d2.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.7e186db80d8c431d196b3e0718afb0636b82a269a8c92521c11a55267a24fc27.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/ru/posts/index.xml title="RSS Feed"><script src=/js/jquery-3.3.1.slim.min.js></script></head><body class="d-flex flex-column min-vh-100"><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/ru/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>Блог</a><ul class="dropdown-menu bg-primary"><li><a class=dropdown-item href=https://aakinshin.net/ru/posts/>Все Посты</a></li><li></li><a class=dropdown-item href=https://aakinshin.net/ru/tags/>Все Теги</a></li></ul></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/ru/about/>Об авторе</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>RU</a><ul class="dropdown-menu bg-primary"><li></li><a class=dropdown-item href=https://aakinshin.net/posts/jon-skeet-quiz/>EN</a></li></ul></li></ul><ul class="navbar-nav ms-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>Jon Skeet's Quiz</h1><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2013-11-03>3 ноября 2013</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>
&nbsp;
<a href=https://aakinshin.net/ru/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/ru/tags/cs/ class="badge badge-info">C#</a></span><br><br><p>Однажды Джона Скита попросили сформулировать три интересных вопроса на знание C#. Он спросил следующее (<a href=http://www.dotnetcurry.com/magazine/jon-skeet-quiz.aspx>оригинал вопросника</a>, <a href=http://timyrguev.blogspot.ru/2013/10/blog-post.html>перевод статьи</a>):</p><ul><li><strong>Q1.</strong> <em>Вызов какого конструктора можно использовать, чтобы следующий код вывел True (хотя бы в реализации Microsoft.NET)?</em></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>object</span> <span class=n>x</span> <span class=p>=</span> <span class=k>new</span> <span class=cm>/* fill in code here */</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>object</span> <span class=n>y</span> <span class=p>=</span> <span class=k>new</span> <span class=cm>/* fill in code here */</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>x</span> <span class=p>==</span> <span class=n>y</span><span class=p>);</span>
</span></span></code></pre></div><p><em>Учтите, что это просто вызов конструктора, вы не можете поменять тип переменных.</em></p><ul><li><strong>Q2.</strong> <em>Как сделать так, чтобы следующий код вызывал три различных перегрузки метода?</em></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>void</span> <span class=n>Foo</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>EvilMethod</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=n>EvilMethod</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=n>EvilMethod</span><span class=p>&lt;</span><span class=kt>int?</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li><strong>Q3.</strong> <em>Как заставить следующий код выбросить исключение во второй строчке с помощью локальной переменной (без хитрого изменения её значения)?</em></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>string</span> <span class=n>text</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>ToString</span><span class=p>();</span> <span class=c1>// No exception</span>
</span></span><span class=line><span class=cl><span class=n>Type</span> <span class=n>type</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>GetType</span><span class=p>();</span> <span class=c1>// Bang!</span>
</span></span></code></pre></div><p>Вопросы показались мне интересными, поэтому я решил обсудить их решения.</p><hr><ul><li><strong>A1-1.</strong></li></ul><p>Одним из самых простых способов является использование <a href="http://msdn.microsoft.com/en-us/library/1t3y8s4s(v=vs.90).aspx">Nullable</a>-типов:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>object</span> <span class=n>x</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int?</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kt>object</span> <span class=n>y</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int?</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>x</span> <span class=p>==</span> <span class=n>y</span><span class=p>);</span>
</span></span></code></pre></div><p>Несмотря на явный вызов конструктора, получившиеся значения равны <code>null</code>, а следовательно совпадают.</p><ul><li><strong>A1-2.</strong> Или можно вспомнить про <a href=http://blogs.msdn.com/b/ericlippert/archive/2009/09/28/string-interning-and-string-empty.aspx>интернирование строк</a> и объявить две пустые строчки:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>object</span> <span class=n>x</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>string</span><span class=p>(</span><span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=m>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=kt>object</span> <span class=n>y</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>string</span><span class=p>(</span><span class=k>new</span> <span class=kt>char</span><span class=p>[</span><span class=m>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>x</span> <span class=p>==</span> <span class=n>y</span><span class=p>);</span>
</span></span></code></pre></div><ul><li><strong>A2.</strong> Вторая задачка — самая сложная из трёх предложенных. Необходимо придумать такое решение, чтобы запускались именно три <em>разных</em> перегрузки нашего метода. В качестве варианта решения можно рассмотреть следующий код:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>ReferenceGeneric</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;</span> <span class=k>where</span> <span class=n>T</span> <span class=p>:</span> <span class=k>class</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>EvilClassBase</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>protected</span> <span class=k>void</span> <span class=n>EvilMethod</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;int?&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>EvilClass</span> <span class=p>:</span> <span class=n>EvilClassBase</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>EvilMethod</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=n>EvilMethod</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=n>EvilMethod</span><span class=p>&lt;</span><span class=kt>int?</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>void</span> <span class=n>EvilMethod</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;(</span><span class=n>ReferenceGeneric</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;</span> <span class=n>arg</span> <span class=p>=</span> <span class=k>null</span><span class=p>)</span> <span class=k>where</span> <span class=n>T</span> <span class=p>:</span> <span class=k>class</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;string&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>void</span> <span class=n>EvilMethod</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;(</span><span class=n>T</span><span class=p>?</span> <span class=n>arg</span> <span class=p>=</span> <span class=k>null</span><span class=p>)</span> <span class=k>where</span> <span class=n>T</span> <span class=p>:</span> <span class=k>struct</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;int&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Для начала разберёмся с типам <code>string</code> и <code>int</code>. Тут всё просто: <code>string</code> является ссылочным типом, а <code>int</code> — значимым. При написании кода нам помогут конструкции <code>where T : class</code>, <code>where T : struct</code> и параметры по умолчанию, которые явно задействуют тип <code>T</code> соответствующим образом: в первый метод пойдёт аргумент типа <code>ReferenceGeneric&lt;T></code> (он может принимать только ссылочные типы), а во второй — <code>T?</code> (он может принимать только значимые non-nullable типы). Теперь вызовы <code>EvilMethod&lt;string>()</code> и <code>EvilMethod&lt;int>()</code> «найдут» себе правильные перегрузки.</p><p>Едем дальше, вспомним про <code>int?</code>. Для него создадим перегрузку с сигнатурой без всяких дополнительных условий <code>EvilMethod&lt;T>()</code> (увы, C# не позволяет написать что-нибудь вроде <code>where T : Nullable&lt;int></code>). Но если мы объявим такой метод в том же классе, то он «заберёт» себе вызовы первых двух методов. Поэтому следует «отправить» его в базовый класс, там он нам мешать не будет.</p><p>Давайте взглянем на то, что получилось. Вызовы <code>EvilMethod&lt;string>()</code> и <code>EvilMethod&lt;int>()</code> «увидят» подходящие перегрузки в текущем классе и будут их использовать. Вызов <code>EvilMethod&lt;int>;()</code> подходящей перегрузки в текущем классе «не найдёт», поэтому «пойдёт» за ней в базовый класс. Сила <a href="http://msdn.microsoft.com/en-us/library/aa691336%28v=vs.71%29.aspx">C# Overload resolution rules</a> опять помогла нам!</p><ul><li><strong>A3.</strong> И снова Nullable-типы спешат на помощь!</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>x</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int?</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kt>string</span> <span class=n>text</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>ToString</span><span class=p>();</span> <span class=c1>// No exception</span>
</span></span><span class=line><span class=cl><span class=n>Type</span> <span class=n>type</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>GetType</span><span class=p>();</span> <span class=c1>// Bang!</span>
</span></span></code></pre></div><p><a href=http://msdn.microsoft.com/en-us/library/9hd15ket.aspx>Вспомним</a>, что метод <code>ToString()</code> перегружен в <code>Nullable&lt;T></code>, для null-значения он вернёт пустую строчку. Увы, для <code>GetType()</code> такой фокус не пройдёт, он не может быть перегружен и на null-значении выбросит исключение. Также вы <a href=http://stackoverflow.com/questions/12725631/nullable-type-gettype-throws-exception>можете почитать</a> оригинальный ответ Джона на свой вопрос.</p><p>Не забываем, что при очень большом желании через неуправляемый код мы всегда можем долезть до таблицы методов и ручками подменить ссылку на <code>GetType()</code>, но сегодня нас просили не хитрить =).</p><br><br><div class=row><div class="justify-content-center share-block"><div class=share-title>Поделиться:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fru%2fposts%2fjon-skeet-quiz%2f&title=Jon%20Skeet%27s%20Quiz" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=Jon%20Skeet%27s%20Quiz&url=https%3a%2f%2faakinshin.net%2fru%2fposts%2fjon-skeet-quiz%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fru%2fposts%2fjon-skeet-quiz%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fru%2fposts%2fjon-skeet-quiz%2f&title=Jon%20Skeet%27s%20Quiz" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class="blog-footer mt-auto"><div class=container><p>&copy; 2013&mdash;2022 Андрей Акиньшин
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub></i></a>
<a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter></i></a>
<a href=https://aakinshin.net/ru/posts/index.xml><i class="fas fa-rss" title=RSS></i></a>
|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.c26550621ac13c2221d7f6f5e6fe862345d3919723c50d730893e3e4856ecf35.js></script>
<script src=/js/bootstrap.bundle.min.js></script>
<script src=/js/anchor.min.js></script>
<script src=https://aakinshin.net/js/custom.min.f6e5d13fe39f305056cc743ee4cb8d117c1aba26176e58c82c79a480d02fe4b7.js></script></body></html>