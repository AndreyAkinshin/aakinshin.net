<!doctype html><html lang=ru><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.122.0"><meta name=author content="Андрей Акиньшин"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content=".NET,C#,Benchmarking,Static,IL,Arrays"><title>Об итерировании статичных массивов в .NET | Андрей Акиньшин</title>
<meta name=description content="Часть 1 Управляемый подход платформы .NET делает жизнь разработчиков достаточно простой, беря на себя многие рутинные операции. Большую часть времени программист может вообще не вспоминать о технической реализации платформы, сосредоточившись исключительно н..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.a032e875598f97999dcca4aec47ea745e5896949ccc57dfcd01331a89561c222.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/ru/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-2 xs:px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/ru/about/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/ru/posts/>Посты</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/ru/about/>Об авторе</a></div></div><button id=theme-toggle type=button title="Alt+Click to match OS color theme" class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Об итерировании статичных массивов в .NET</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg>
<time datetime=2013-08-29>29 августа 2013</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/ru/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/ru/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/ru/tags/benchmarking/>Benchmarking</a>
<a class=label-link href=https://aakinshin.net/ru/tags/static/>Static</a>
<a class=label-link href=https://aakinshin.net/ru/tags/il/>IL</a>
<a class=label-link href=https://aakinshin.net/ru/tags/arrays/>Arrays</a></div></div><br><div class=main-content><h2 id=часть-1>Часть 1</h2><p>Управляемый подход платформы .NET делает жизнь разработчиков достаточно простой, беря на себя многие рутинные операции. Большую часть времени программист может вообще не вспоминать о технической реализации платформы, сосредоточившись исключительно на логике своего приложения. Но иногда попадаются задачи, критичные по производительности. Существует множество различных подходов к оптимизации кода в таких ситуациях вплоть до переписывания наиболее важных частей кода через неуправляемый код. Однако, зачастую для увеличения скорости приложения достаточно понимать, сколько времени тратится на ту или иную операцию. Знание подобных вещей позволит оптимизировать некоторые методы с помощью достаточно простых модификаций исходного кода.</p><p>В этой статье мне хотелось бы поговорить о скорости доступа к массивам, ссылки на которые хранятся в статичных переменных. Дело в том, что в скорость итерирования по ним в зависимости от условий запуска может быть ниже, чем для массива, ссылка на который хранится в обычном поле экземпляра класса или локальной переменной. Рассмотрим пример.</p><p>В примере будем решать простую задачу: подсчёт суммы элементов массива. В первом случае мы будем использовать обычное боле класса, а во втором — статическое. Для замеров времени будем использовать <a href=https://github.com/AndreyAkinshin/BenchmarkDotNet>BenchmarkDotNet</a> (исходный код примера: <a href=https://github.com/AndreyAkinshin/BenchmarkDotNet/blob/master/Benchmarks/ArrayIterationProgram.cs>ArrayIterationProgram.cs</a>, тестировать следует в <strong>Release mode without debugging</strong>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>private</span> <span class=kd>const</span> <span class=kt>int</span> <span class=n>N</span> <span class=p>=</span> <span class=m>1000</span><span class=p>,</span> <span class=n>IterationCount</span> <span class=p>=</span> <span class=m>1000000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span><span class=p>[]</span> <span class=n>nonStaticField</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span><span class=p>[]</span> <span class=n>staticField</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>nonStaticField</span> <span class=p>=</span> <span class=n>staticField</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>competition</span> <span class=p>=</span> <span class=k>new</span> <span class=n>BenchmarkCompetition</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>competition</span><span class=p>.</span><span class=n>AddTask</span><span class=p>(</span><span class=s>&#34;Non-static&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=n>NonStaticRun</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>competition</span><span class=p>.</span><span class=n>AddTask</span><span class=p>(</span><span class=s>&#34;Static&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=n>StaticRun</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>competition</span><span class=p>.</span><span class=n>Run</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>NonStaticRun</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sum</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>iteration</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>iteration</span> <span class=p>&lt;</span> <span class=n>IterationCount</span><span class=p>;</span> <span class=n>iteration</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>N</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>sum</span> <span class=p>+=</span> <span class=n>nonStaticField</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>StaticRun</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sum</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>iteration</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>iteration</span> <span class=p>&lt;</span> <span class=n>IterationCount</span><span class=p>;</span> <span class=n>iteration</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>N</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>sum</span> <span class=p>+=</span> <span class=n>staticField</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>На своей машине я получил следующие результаты:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Non-static : 346ms
</span></span><span class=line><span class=cl>Static     : 535ms
</span></span></code></pre></div><p>Если мы взглянем на IL-код целевых методов, то увидим, что они различаются только в одном месте, при обращении к полю:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Non-static:
</span></span><span class=line><span class=cl>L_000b: ldarg.0 
</span></span><span class=line><span class=cl>L_000c: ldfld int32[] Benchmarks.StaticFieldBenchmark::nonStaticField
</span></span><span class=line><span class=cl>Static:
</span></span><span class=line><span class=cl>L_000b: ldsfld int32[] Benchmarks.StaticFieldBenchmark::staticField
</span></span></code></pre></div><p>Заметим, что физически оба поля ссылаются на одну и ту же область памяти. Мы можем ускорить работу со статическим полем, если перед многократным обращением к полю сохраним его в локальную переменную:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>StaticRun</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>localField</span> <span class=p>=</span> <span class=n>staticField</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sum</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>iteration</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>iteration</span> <span class=p>&lt;</span> <span class=n>IterationCount</span><span class=p>;</span> <span class=n>iteration</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>N</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>sum</span> <span class=p>+=</span> <span class=n>localField</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>В итоге <code>StaticRun</code> будет работать столько же, сколько и <code>NonStaticRun</code>.</p><p>Объяснение такого поведения можно прочитать во второй части статьи.</p><h2 id=часть-2>Часть 2</h2><p>В первой части я встретился с весьма интересной ситуацией. Были измерены скорости работы двух методов, в первом из которых считалась сумма элементов массива, ссылка на который хранилась в обычном поле объекта, а во втором — массива, ссылка на который хранилась в статичном поле. Результаты меня удивили: массивы были одинаковые, но второй метод работал ощутимо дольше. Сперва я подумал, что дело в организации скорости доступа к статичным полям, но более детальный анализ ситуации и разговоры с коллегами помогли мне понять, что истинная причина такого поведения намного интересней: для массивов, длина которых кратна 4, JIT использует различные оптимизации в случае обычных и статичных массивов. Давайте разберёмся с ситуацией более детально.</p><p>Напомню методы, поведение которых мы будем изучать:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>private</span> <span class=kd>const</span> <span class=kt>int</span> <span class=n>N</span> <span class=p>=</span> <span class=m>1000</span><span class=p>,</span> <span class=n>IterationCount</span> <span class=p>=</span> <span class=m>1000000</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span><span class=p>[]</span> <span class=n>nonStaticField</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span><span class=p>[]</span> <span class=n>staticField</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>nonStaticField</span> <span class=p>=</span> <span class=n>staticField</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>NonStaticRun</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>StaticRun</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>NonStaticRun</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sum</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>iteration</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>iteration</span> <span class=p>&lt;</span> <span class=n>IterationCount</span><span class=p>;</span> <span class=n>iteration</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>N</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>sum</span> <span class=p>+=</span> <span class=n>nonStaticField</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>int</span> <span class=n>StaticRun</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sum</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>iteration</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>iteration</span> <span class=p>&lt;</span> <span class=n>IterationCount</span><span class=p>;</span> <span class=n>iteration</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>N</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>sum</span> <span class=p>+=</span> <span class=n>staticField</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Для начала поменяем Platform target на x86 и запустим <a href=https://github.com/AndreyAkinshin/BenchmarkDotNet/blob/master/Benchmarks/ArrayIterationProgram.cs>бенчмарк</a>. Получим следующие результаты:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Non-static : 708ms
</span></span><span class=line><span class=cl>Static     : 709ms
</span></span></code></pre></div><p>Интересный вывод: на x86 результаты тестов одинаковы. Чтобы лучше разобраться в проблеме взглянем на нативный код, который получается после JIT-оптимизаций (изучается версия в Release mode without debugging). Конфигурация моей машины, на которой я проводил тестирование: Intel Core i7-3632QM CPU 2.20GHz.</p><p><strong>NonStaticRun-x86.asm</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00</span> <span class=nf>push</span> <span class=no>ebp</span> 
</span></span><span class=line><span class=cl><span class=mi>01</span> <span class=no>mov</span>  <span class=no>ebp</span><span class=p>,</span><span class=no>esp</span> 
</span></span><span class=line><span class=cl><span class=mi>03</span> <span class=no>push</span> <span class=no>edi</span> 
</span></span><span class=line><span class=cl><span class=mi>04</span> <span class=no>push</span> <span class=no>esi</span> 
</span></span><span class=line><span class=cl><span class=mi>05</span> <span class=no>push</span> <span class=no>ebx</span> 
</span></span><span class=line><span class=cl><span class=mi>06</span> <span class=no>xor</span>  <span class=no>edi</span><span class=p>,</span><span class=no>edi</span>                     <span class=c1>; sum = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>08</span> <span class=nf>xor</span>  <span class=no>ebx</span><span class=p>,</span><span class=no>ebx</span>                     <span class=c1>; iteration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nf>a</span> <span class=no>xor</span>  <span class=no>edx</span><span class=p>,</span><span class=no>edx</span>                     <span class=c1>; i = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nf>c</span> <span class=no>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ecx</span><span class=err>+</span><span class=mi>4</span><span class=p>]</span>       <span class=c1>; eax = &amp;nonStaticField
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nf>f</span> <span class=no>mov</span>  <span class=no>esi</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>4</span><span class=p>]</span>       <span class=c1>; esi = nonStaticField.Length
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>12</span> <span class=nf>cmp</span>  <span class=no>edx</span><span class=p>,</span><span class=no>esi</span>                     <span class=c1>; if i &gt;= nonStaticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>14</span> <span class=nf>jae</span>  <span class=mi>00000033</span>                    <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>16</span> <span class=nf>add</span>  <span class=no>edi</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=no>edx</span><span class=p>*</span><span class=mi>4</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span> <span class=c1>; sum += nonStaticField[i];
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>1</span><span class=nf>a</span> <span class=no>inc</span>  <span class=no>edx</span>                         <span class=c1>; i++
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>1</span><span class=nf>b</span> <span class=no>cmp</span>  <span class=no>edx</span><span class=p>,</span><span class=mi>3</span><span class=no>E8h</span>                    <span class=c1>; if i &lt; 1000 then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>21</span> <span class=nf>jl</span>   <span class=mi>00000012</span>                    <span class=c1>; loop by i
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>23</span> <span class=nf>inc</span>  <span class=no>ebx</span>                         <span class=c1>; iteration++
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>24</span> <span class=nf>cmp</span>  <span class=no>ebx</span><span class=p>,</span><span class=mi>0</span><span class=no>F4240h</span>                 <span class=c1>; if iteration &lt; 1000000 then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>2</span><span class=nf>a</span> <span class=no>jl</span>   <span class=mi>0000000</span><span class=no>A</span>                    <span class=c1>; loop by iteration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>2</span><span class=nf>c</span> <span class=no>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>edi</span>                     <span class=c1>; eax = sum (Result)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>2</span><span class=nf>e</span> <span class=no>pop</span>  <span class=no>ebx</span> 
</span></span><span class=line><span class=cl><span class=mi>2</span><span class=no>f</span> <span class=no>pop</span>  <span class=no>esi</span> 
</span></span><span class=line><span class=cl><span class=mi>30</span> <span class=no>pop</span>  <span class=no>edi</span> 
</span></span><span class=line><span class=cl><span class=mi>31</span> <span class=no>pop</span>  <span class=no>ebp</span> 
</span></span><span class=line><span class=cl><span class=mi>32</span> <span class=no>ret</span> 
</span></span><span class=line><span class=cl><span class=mi>33</span> <span class=no>call</span> <span class=mi>63495</span><span class=no>C4D</span>                    <span class=c1>; IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>38</span> <span class=nf>int</span>  <span class=mi>3</span> 
</span></span></code></pre></div><p><strong>StaticRun-x86.asm</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00</span> <span class=nf>push</span> <span class=no>ebp</span> 
</span></span><span class=line><span class=cl><span class=mi>01</span> <span class=no>mov</span>  <span class=no>ebp</span><span class=p>,</span><span class=no>esp</span> 
</span></span><span class=line><span class=cl><span class=mi>03</span> <span class=no>push</span> <span class=no>edi</span> 
</span></span><span class=line><span class=cl><span class=mi>04</span> <span class=no>push</span> <span class=no>esi</span> 
</span></span><span class=line><span class=cl><span class=mi>05</span> <span class=no>push</span> <span class=no>ebx</span> 
</span></span><span class=line><span class=cl><span class=mi>06</span> <span class=no>xor</span>  <span class=no>edi</span><span class=p>,</span><span class=no>edi</span>                      <span class=c1>; sum = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>08</span> <span class=nf>xor</span>  <span class=no>ebx</span><span class=p>,</span><span class=no>ebx</span>                      <span class=c1>; iteration = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nf>a</span> <span class=no>xor</span>  <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>                      <span class=c1>; i = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nf>c</span> <span class=no>mov</span>  <span class=no>edx</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=no>ds</span><span class=p>:[</span><span class=mi>03943380</span><span class=no>h</span><span class=p>]</span> <span class=c1>; edx = &amp;staticField
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>12</span> <span class=nf>mov</span>  <span class=no>esi</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>edx</span><span class=err>+</span><span class=mi>4</span><span class=p>]</span>        <span class=c1>; esi = staticField.Length 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>15</span> <span class=nf>cmp</span>  <span class=no>eax</span><span class=p>,</span><span class=no>esi</span>                      <span class=c1>; if i &gt;= staticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>17</span> <span class=nf>jae</span>  <span class=mi>00000035</span>                     <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>19</span> <span class=nf>add</span>  <span class=no>edi</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>edx</span><span class=err>+</span><span class=no>eax</span><span class=p>*</span><span class=mi>4</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span>  <span class=c1>; sum += staticField[i];
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>1</span><span class=nf>d</span> <span class=no>inc</span>  <span class=no>eax</span>                          <span class=c1>; i++
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>1</span><span class=nf>e</span> <span class=no>cmp</span>  <span class=no>eax</span><span class=p>,</span><span class=mi>3</span><span class=no>E8h</span>                     <span class=c1>; if i &lt; 1000 then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>23</span> <span class=nf>jl</span>   <span class=mi>00000015</span>                     <span class=c1>; loop by i
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>25</span> <span class=nf>inc</span>  <span class=no>ebx</span>                          <span class=c1>; iteration++
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>26</span> <span class=nf>cmp</span>  <span class=no>ebx</span><span class=p>,</span><span class=mi>0</span><span class=no>F4240h</span>                  <span class=c1>; if iteration &lt; 1000000 then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>2</span><span class=nf>c</span> <span class=no>jl</span>   <span class=mi>0000000</span><span class=no>A</span>                     <span class=c1>; loop by iteration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>2</span><span class=nf>e</span> <span class=no>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>edi</span>                      <span class=c1>; eax = sum (Result)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>30</span> <span class=nf>pop</span>  <span class=no>ebx</span> 
</span></span><span class=line><span class=cl><span class=mi>31</span> <span class=no>pop</span>  <span class=no>esi</span> 
</span></span><span class=line><span class=cl><span class=mi>32</span> <span class=no>pop</span>  <span class=no>edi</span> 
</span></span><span class=line><span class=cl><span class=mi>33</span> <span class=no>pop</span>  <span class=no>ebp</span> 
</span></span><span class=line><span class=cl><span class=mi>34</span> <span class=no>ret</span> 
</span></span><span class=line><span class=cl><span class=mi>35</span> <span class=no>call</span> <span class=mi>639</span><span class=no>E52D5</span>                     <span class=c1>; IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>3</span><span class=nf>a</span> <span class=no>int</span>  <span class=mi>3</span> 
</span></span></code></pre></div><p>Из этого кода становится понятно, что разнице во времени взяться неоткуда: методы отличаются только в одной строчке, в которой берётся адрес интересующего нас массива. В обоих случаях используется команда <code>move</code> , просто её аргументы разнятся, это не должно сказаться на производительности.</p><p>Теперь поменяем платформу на x64 и запустим бенчмарк:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Non-static : 347ms
</span></span><span class=line><span class=cl>Static     : 533ms
</span></span></code></pre></div><p>Любопытно: в обоих случаях быстродействие значительно возросло, но только в случае статичного поля оптимизация вышла «слабее». В чём же дело? Обратимся опять к машинному коду:</p><p><strong>NonStaticRun-x64.asm</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00</span> <span class=nf>sub</span>  <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span>
</span></span><span class=line><span class=cl><span class=err>04</span> <span class=nf>mov</span>  <span class=no>r8</span><span class=p>,</span><span class=no>rcx</span>
</span></span><span class=line><span class=cl><span class=err>07</span> <span class=nf>xor</span>  <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>09</span> <span class=nf>mov</span>  <span class=no>edx</span><span class=p>,</span><span class=no>ecx</span>                      <span class=c1>; sum = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nf>b</span> <span class=no>nop</span>  <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>10</span> <span class=nf>xor</span>  <span class=no>r10d</span><span class=p>,</span><span class=no>r10d</span>                    <span class=c1>; i = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>13</span> <span class=nf>mov</span>  <span class=no>r9</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r8</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span>          <span class=c1>; r9 = &amp;nonStaticField
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>17</span> <span class=nf>mov</span>  <span class=no>rax</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span>         <span class=c1>; rax = nonStaticField.Length
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>1</span><span class=nf>b</span> <span class=no>mov</span>  <span class=no>r11d</span><span class=p>,</span><span class=mi>3</span><span class=no>E4h</span>                    <span class=c1>; r11 = 996
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>21</span> <span class=nf>cmp</span>  <span class=no>r11</span><span class=p>,</span><span class=no>rax</span>                      <span class=c1>; if r11 &gt;= nonStaticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>24</span> <span class=nf>jae</span>  <span class=mi>000000000000008</span><span class=no>A</span>             <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>26</span> <span class=nf>mov</span>  <span class=no>r11d</span><span class=p>,</span><span class=mi>3</span><span class=no>E5h</span>                    <span class=c1>; r11 = 997
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>2</span><span class=nf>c</span> <span class=no>cmp</span>  <span class=no>r11</span><span class=p>,</span><span class=no>rax</span>                      <span class=c1>; if r11 &gt;= nonStaticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>2</span><span class=nf>f</span> <span class=no>jae</span>  <span class=mi>000000000000008</span><span class=no>A</span>             <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>31</span> <span class=nf>mov</span>  <span class=no>r11d</span><span class=p>,</span><span class=mi>3</span><span class=no>E6h</span>                    <span class=c1>; r11 = 998
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>37</span> <span class=nf>cmp</span>  <span class=no>r11</span><span class=p>,</span><span class=no>rax</span>                      <span class=c1>; if r11 &gt;= nonStaticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>3</span><span class=nf>a</span> <span class=no>jae</span>  <span class=mi>000000000000008</span><span class=no>A</span>             <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>3</span><span class=nf>c</span> <span class=no>mov</span>  <span class=no>r11d</span><span class=p>,</span><span class=mi>3</span><span class=no>E7h</span>                    <span class=c1>; r11 = 999
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>42</span> <span class=nf>cmp</span>  <span class=no>r11</span><span class=p>,</span><span class=no>rax</span>                      <span class=c1>; if r11 &gt;= nonStaticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>45</span> <span class=nf>jae</span>  <span class=mi>000000000000008</span><span class=no>A</span>             <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>47</span> <span class=nf>nop</span>  <span class=no>word</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=err>+</span><span class=mi>00000000</span><span class=no>h</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>50</span> <span class=nf>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=no>r10</span><span class=err>+</span><span class=mi>10</span><span class=no>h</span><span class=p>]</span>   <span class=c1>; eax = nonStaticField[i]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>55</span> <span class=nf>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>                      <span class=c1>; sum += eax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>57</span> <span class=nf>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=no>r10</span><span class=err>+</span><span class=mi>14</span><span class=no>h</span><span class=p>]</span>   <span class=c1>; eax = nonStaticField[i+1]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>5</span><span class=nf>c</span> <span class=no>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>                      <span class=c1>; sum += eax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>5</span><span class=nf>e</span> <span class=no>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=no>r10</span><span class=err>+</span><span class=mi>18</span><span class=no>h</span><span class=p>]</span>   <span class=c1>; eax = nonStaticField[i+2]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>63</span> <span class=nf>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>                      <span class=c1>; sum += eax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>65</span> <span class=nf>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=no>r10</span><span class=err>+</span><span class=mi>1</span><span class=no>Ch</span><span class=p>]</span>   <span class=c1>; eax = nonStaticField[i+3]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>6</span><span class=nf>a</span> <span class=no>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>                      <span class=c1>; sum += eax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>6</span><span class=nf>c</span> <span class=no>add</span>  <span class=no>r10</span><span class=p>,</span><span class=mi>10</span><span class=no>h</span>                      <span class=c1>; i += 4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>70</span> <span class=nf>cmp</span>  <span class=no>r10</span><span class=p>,</span><span class=mi>0</span><span class=no>FA0h</span>                    <span class=c1>; if i &lt; 1000 then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>77</span> <span class=nf>jl</span>   <span class=mi>0000000000000050</span>             <span class=c1>; loop by i
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>79</span> <span class=nf>inc</span>  <span class=no>ecx</span>                          <span class=c1>; iteration++
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>7</span><span class=nf>b</span> <span class=no>cmp</span>  <span class=no>ecx</span><span class=p>,</span><span class=mi>0</span><span class=no>F4240h</span>                  <span class=c1>; if iteration &lt; 1000000  then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>81</span> <span class=nf>jl</span>   <span class=mi>0000000000000010</span>             <span class=c1>; loop by iteration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>83</span> <span class=nf>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>edx</span>                      <span class=c1>; eax = sum (Result)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>85</span> <span class=nf>add</span>  <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span>
</span></span><span class=line><span class=cl><span class=err>89</span> <span class=nf>ret</span>   
</span></span><span class=line><span class=cl><span class=mi>8</span><span class=no>a</span> <span class=no>call</span> <span class=mi>000000005</span><span class=no>FA4AE14</span>             <span class=c1>; IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>8</span><span class=nf>f</span> <span class=no>nop</span> 
</span></span></code></pre></div><p>Этот пример намного интересней! Вспомним, что в x86 нам доступно только 8 регистров по 32 бита (EAX, ECX, EDX, EBX, ESP, EBP, ESI, EDI, R8D), а в x64 доступно 16 регистров по 64 бита (RAX, RCX, RDX, RBX, RSP, RBP, RSI, RDI, R8 — R15). Увеличение количества регистров позволило произвести JIT-оптимизацию «размотка цикла» (см.
<a href=http://en.wikipedia.org/wiki/Loop_unwinding>Loop unwinding</a>). При этом важную роль играет то обстоятельство, что количество итераций в каждом из циклов кратно четвёрке. Мы ещё вернёмся к этому моменту, а пока взглянем на static-версию.</p><p><strong>StaticRun-x64.asm</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00</span> <span class=nf>sub</span>  <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span> 
</span></span><span class=line><span class=cl><span class=mi>04</span> <span class=no>xor</span>  <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>                       <span class=c1>; iteration = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>06</span> <span class=nf>mov</span>  <span class=no>edx</span><span class=p>,</span><span class=no>ecx</span>                       <span class=c1>; sum = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>08</span> <span class=nf>nop</span>  <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=err>+</span><span class=mi>00000000</span><span class=no>h</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>10</span> <span class=no>xor</span>  <span class=no>r8d</span><span class=p>,</span><span class=no>r8d</span>                       <span class=c1>; i = 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>13</span> <span class=nf>mov</span>  <span class=no>r9</span><span class=p>,</span><span class=mi>12</span><span class=no>D756F0h</span>                  <span class=c1>; r9 = staticField
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>1</span><span class=nf>d</span> <span class=no>mov</span>  <span class=no>r9</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=p>]</span>             <span class=c1>; r9 = &amp;staticField
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>20</span> <span class=nf>mov</span>  <span class=no>r10</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span>          <span class=c1>; r10 = staticField.Length
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>24</span> <span class=nf>cmp</span>  <span class=no>r8</span><span class=p>,</span><span class=no>r10</span>                        <span class=c1>; if r8 &gt;= staticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>27</span> <span class=nf>jae</span>  <span class=mi>0000000000000080</span>              <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>29</span> <span class=nf>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=no>r8</span><span class=p>*</span><span class=mi>4</span><span class=err>+</span><span class=mi>10</span><span class=no>h</span><span class=p>]</span>   <span class=c1>; eax = staticField[i]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>2</span><span class=nf>e</span> <span class=no>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>                       <span class=c1>; sum += eax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>30</span> <span class=nf>lea</span>  <span class=no>rax</span><span class=p>,[</span><span class=no>r8</span><span class=err>+</span><span class=mi>1</span><span class=p>]</span>                    <span class=c1>; rax = i+1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>34</span> <span class=nf>cmp</span>  <span class=no>rax</span><span class=p>,</span><span class=no>r10</span>                       <span class=c1>; if rax &gt;= staticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>37</span> <span class=nf>jae</span>  <span class=mi>0000000000000080</span>              <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>39</span> <span class=nf>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=no>rax</span><span class=p>*</span><span class=mi>4</span><span class=err>+</span><span class=mi>10</span><span class=no>h</span><span class=p>]</span>  <span class=c1>; eax = staticField[i+1]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>3</span><span class=nf>e</span> <span class=no>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>                       <span class=c1>; sum += eax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>40</span> <span class=nf>lea</span>  <span class=no>rax</span><span class=p>,[</span><span class=no>r8</span><span class=err>+</span><span class=mi>2</span><span class=p>]</span>                    <span class=c1>; rax = i+2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>44</span> <span class=nf>cmp</span>  <span class=no>rax</span><span class=p>,</span><span class=no>r10</span>                       <span class=c1>; if rax &gt;= staticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>47</span> <span class=nf>jae</span>  <span class=mi>0000000000000080</span>              <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>49</span> <span class=nf>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=no>rax</span><span class=p>*</span><span class=mi>4</span><span class=err>+</span><span class=mi>10</span><span class=no>h</span><span class=p>]</span>  <span class=c1>; eax = staticField[i+2]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>4</span><span class=nf>e</span> <span class=no>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>                       <span class=c1>; sum += eax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>50</span> <span class=nf>lea</span>  <span class=no>rax</span><span class=p>,[</span><span class=no>r8</span><span class=err>+</span><span class=mi>3</span><span class=p>]</span>                    <span class=c1>; rax = i+3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>54</span> <span class=nf>cmp</span>  <span class=no>rax</span><span class=p>,</span><span class=no>r10</span>                       <span class=c1>; if rax &gt;= staticField.Length then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>57</span> <span class=nf>jae</span>  <span class=mi>0000000000000080</span>              <span class=c1>; throw IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>59</span> <span class=nf>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=no>rax</span><span class=p>*</span><span class=mi>4</span><span class=err>+</span><span class=mi>10</span><span class=no>h</span><span class=p>]</span>  <span class=c1>; eax = staticField[i+3]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>5</span><span class=nf>e</span> <span class=no>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>                       <span class=c1>; sum += eax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>60</span> <span class=nf>add</span>  <span class=no>r8</span><span class=p>,</span><span class=mi>4</span>                          <span class=c1>; i += 4
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>64</span> <span class=nf>cmp</span>  <span class=no>r8</span><span class=p>,</span><span class=mi>3</span><span class=no>E8h</span>                       <span class=c1>; if i &lt; 1000 then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>6</span><span class=nf>b</span> <span class=no>jl</span>   <span class=mi>0000000000000013</span>              <span class=c1>; loop by i
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>6</span><span class=nf>d</span> <span class=no>inc</span>  <span class=no>ecx</span>                           <span class=c1>; iteration++
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>6</span><span class=nf>f</span> <span class=no>cmp</span>  <span class=no>ecx</span><span class=p>,</span><span class=mi>0</span><span class=no>F4240h</span>                   <span class=c1>; if iteration &lt; 1000000 then
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>75</span> <span class=nf>jl</span>   <span class=mi>0000000000000010</span>              <span class=c1>; loop by iteration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>77</span> <span class=nf>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>edx</span>                       <span class=c1>; eax = sum (result)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>79</span> <span class=nf>add</span>  <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span> 
</span></span><span class=line><span class=cl><span class=mi>7</span><span class=no>d</span> <span class=no>ret</span>     
</span></span><span class=line><span class=cl><span class=mi>7</span><span class=no>e</span> <span class=no>xchg</span> <span class=no>ax</span><span class=p>,</span><span class=no>ax</span> 
</span></span><span class=line><span class=cl><span class=mi>80</span> <span class=no>call</span> <span class=mi>000000005</span><span class=no>FA49F64</span>              <span class=c1>; IndexOutOfRangeException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>85</span> <span class=nf>nop</span>   
</span></span></code></pre></div><p>Из примера видно, что для статичного массива оптимизация размотки цикла прошла несколько иначе. Причём, если в методе <code>StaticRun</code> сохранить ссылку на статический массив в локальную переменную и итерировать по ней, то машинный код будет аналогичен примеру NonStaticRun-x64.asm, а производительность обоих методов станет одинаковой. В текущей версии static-версия «проседает» по скорости из-за следующих обстоятельств:</p><ul><li>Вместо того, чтобы явно хранить смещения элементов, хранится индекс, который в момент вычисления адреса умножается на 4 для получения смещения.</li><li>Вычисление адресов элементов [i+1], [i+2], [i+3] происходит в регистрах вместо того, чтобы использовать константные смещения в 4h, 8h, bh, относительно элемента [i].</li></ul><p>Теперь попробуем изменить длину массива, чтобы она больше не делилась на 4: N = 1001. Результаты бенчмарка:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>Non-static</span> <span class=p>:</span> <span class=mi>550</span><span class=no>ms</span>
</span></span><span class=line><span class=cl><span class=nf>Static</span>     <span class=p>:</span> <span class=mi>719</span><span class=no>ms</span>
</span></span></code></pre></div><p>Static-версия по скорости «вернулась» к результату без оптимизации, который мы видели в x86-версии. В NonStatic-версии результат интереснее: текущая версия работает медленнее, чем для N=1000, но быстрее, чем для x86. Опять обратимся к машинному коду, чтобы разобраться:</p><p><strong>NonStaticRun-x64-1001.asm</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00</span> <span class=nf>sub</span>  <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span> 
</span></span><span class=line><span class=cl><span class=mi>04</span> <span class=no>mov</span>  <span class=no>r9</span><span class=p>,</span><span class=no>rcx</span> 
</span></span><span class=line><span class=cl><span class=mi>07</span> <span class=no>xor</span>  <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span> 
</span></span><span class=line><span class=cl><span class=mi>09</span> <span class=no>mov</span>  <span class=no>edx</span><span class=p>,</span><span class=no>ecx</span> 
</span></span><span class=line><span class=cl><span class=mi>0</span><span class=no>b</span> <span class=no>nop</span>  <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>10</span> <span class=no>xor</span>  <span class=no>r8d</span><span class=p>,</span><span class=no>r8d</span> 
</span></span><span class=line><span class=cl><span class=mi>13</span> <span class=no>mov</span>  <span class=no>r10</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>17</span> <span class=no>mov</span>  <span class=no>rax</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r10</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=no>b</span> <span class=no>mov</span>  <span class=no>r11d</span><span class=p>,</span><span class=mi>3</span><span class=no>E8h</span> 
</span></span><span class=line><span class=cl><span class=mi>21</span> <span class=no>cmp</span>  <span class=no>r11</span><span class=p>,</span><span class=no>rax</span> 
</span></span><span class=line><span class=cl><span class=mi>24</span> <span class=no>jae</span>  <span class=mi>0000000000000055</span> 
</span></span><span class=line><span class=cl><span class=mi>26</span> <span class=no>nop</span>  <span class=no>word</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=err>+</span><span class=mi>00000000</span><span class=no>h</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>30</span> <span class=no>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r10</span><span class=err>+</span><span class=no>r8</span><span class=err>+</span><span class=mi>10</span><span class=no>h</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>35</span> <span class=no>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span> 
</span></span><span class=line><span class=cl><span class=mi>37</span> <span class=no>add</span>  <span class=no>r8</span><span class=p>,</span><span class=mi>4</span> 
</span></span><span class=line><span class=cl><span class=mi>3</span><span class=no>b</span> <span class=no>cmp</span>  <span class=no>r8</span><span class=p>,</span><span class=mi>0</span><span class=no>FA4h</span> 
</span></span><span class=line><span class=cl><span class=mi>42</span> <span class=no>jl</span>   <span class=mi>0000000000000030</span> 
</span></span><span class=line><span class=cl><span class=mi>44</span> <span class=no>inc</span>  <span class=no>ecx</span> 
</span></span><span class=line><span class=cl><span class=mi>46</span> <span class=no>cmp</span>  <span class=no>ecx</span><span class=p>,</span><span class=mi>0</span><span class=no>F4240h</span> 
</span></span><span class=line><span class=cl><span class=mi>4</span><span class=no>c</span> <span class=no>jl</span>   <span class=mi>0000000000000010</span> 
</span></span><span class=line><span class=cl><span class=mi>4</span><span class=no>e</span> <span class=no>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>edx</span> 
</span></span><span class=line><span class=cl><span class=mi>50</span> <span class=no>add</span>  <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span> 
</span></span><span class=line><span class=cl><span class=mi>54</span> <span class=no>ret</span>    
</span></span><span class=line><span class=cl><span class=mi>55</span> <span class=no>call</span> <span class=mi>000000005</span><span class=no>FA5AE14</span> 
</span></span><span class=line><span class=cl><span class=mi>5</span><span class=no>a</span> <span class=no>nop</span>    
</span></span></code></pre></div><p><strong>StaticRun-x64-1001.asm</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00</span> <span class=nf>sub</span>  <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span> 
</span></span><span class=line><span class=cl><span class=mi>04</span> <span class=no>xor</span>  <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span> 
</span></span><span class=line><span class=cl><span class=mi>06</span> <span class=no>mov</span>  <span class=no>edx</span><span class=p>,</span><span class=no>ecx</span> 
</span></span><span class=line><span class=cl><span class=mi>08</span> <span class=no>nop</span>  <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=err>+</span><span class=mi>00000000</span><span class=no>h</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>10</span> <span class=no>xor</span>  <span class=no>r8d</span><span class=p>,</span><span class=no>r8d</span> 
</span></span><span class=line><span class=cl><span class=mi>13</span> <span class=no>mov</span>  <span class=no>r9</span><span class=p>,</span><span class=mi>12</span><span class=no>B556F0h</span> 
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=no>d</span> <span class=no>mov</span>  <span class=no>r9</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>20</span> <span class=no>mov</span>  <span class=no>rax</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=mi>8</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>24</span> <span class=no>cmp</span>  <span class=no>r8</span><span class=p>,</span><span class=no>rax</span> 
</span></span><span class=line><span class=cl><span class=mi>27</span> <span class=no>jae</span>  <span class=mi>0000000000000050</span> 
</span></span><span class=line><span class=cl><span class=mi>29</span> <span class=no>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r9</span><span class=err>+</span><span class=no>r8</span><span class=p>*</span><span class=mi>4</span><span class=err>+</span><span class=mi>10</span><span class=no>h</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>2</span><span class=no>e</span> <span class=no>add</span>  <span class=no>edx</span><span class=p>,</span><span class=no>eax</span> 
</span></span><span class=line><span class=cl><span class=mi>30</span> <span class=no>inc</span>  <span class=no>r8</span> 
</span></span><span class=line><span class=cl><span class=mi>33</span> <span class=no>cmp</span>  <span class=no>r8</span><span class=p>,</span><span class=mi>3</span><span class=no>E9h</span> 
</span></span><span class=line><span class=cl><span class=mi>3</span><span class=no>a</span> <span class=no>jl</span>   <span class=mi>0000000000000013</span> 
</span></span><span class=line><span class=cl><span class=mi>3</span><span class=no>c</span> <span class=no>inc</span>  <span class=no>ecx</span> 
</span></span><span class=line><span class=cl><span class=mi>3</span><span class=no>e</span> <span class=no>cmp</span>  <span class=no>ecx</span><span class=p>,</span><span class=mi>0</span><span class=no>F4240h</span> 
</span></span><span class=line><span class=cl><span class=mi>44</span> <span class=no>jl</span>   <span class=mi>0000000000000010</span> 
</span></span><span class=line><span class=cl><span class=mi>46</span> <span class=no>mov</span>  <span class=no>eax</span><span class=p>,</span><span class=no>edx</span> 
</span></span><span class=line><span class=cl><span class=mi>48</span> <span class=no>add</span>  <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span> 
</span></span><span class=line><span class=cl><span class=mi>4</span><span class=no>c</span> <span class=no>ret</span>   
</span></span><span class=line><span class=cl><span class=mi>4</span><span class=no>d</span> <span class=no>nop</span>  <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=mi>50</span> <span class=no>call</span> <span class=mi>000000005</span><span class=no>FA69FA4</span> 
</span></span><span class=line><span class=cl><span class=mi>55</span> <span class=no>nop</span>
</span></span></code></pre></div><p>Из примеров можно заметить, что в методах NonStaticRun-x86, StaticRun-x86, StaticRun-x64-1001 для вычисления очередного элемента массива используется формула:
<code>BaseAddress + i * 4 + 10h</code>, а в методе NonStaticRun: <code>BaseAddress + offset + 10h</code>, где <code>offset = i * 4</code> — уже готовое смещение. Этим и объясняется разница в скорости.</p><p>Данную тему можно изучать ещё очень долго: пробовать менять конфигурацию сборки, пробовать различные длины массивов и т.п. Но я ограничусь формулировкой основного вывода.</p><h3 id=выводы>Выводы</h3><p>Скорость итерирования может значительно зависеть от следующих обстоятельств:</p><ul><li>Тип ссылки на массив: статичное поле или обычное поле/локальная переменная</li><li>Используемая архитектура процессора</li><li>Делимость количества элементов на степени двойки</li><li>Версия CLR</li><li>Фаза луны</li></ul><p>Всем хороших бенчмарков =)</p></div><br><br></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}));function toggleTheme(e){e?(document.documentElement.classList.add("dark"),themeToggleLightIcon.classList.remove("hidden"),themeToggleDarkIcon.classList.add("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")}),imagesLight.forEach(e=>{e.classList.add("hidden")})):(document.documentElement.classList.remove("dark"),themeToggleDarkIcon.classList.remove("hidden"),themeToggleLightIcon.classList.add("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}),imagesDark.forEach(e=>{e.classList.add("hidden")}))}themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),event.altKey?(localStorage.removeItem("color-theme"),toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches)):localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{if(localStorage.getItem("color-theme")===null){const t=e.matches?"dark":"light";toggleTheme(t==="dark")}})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2024 <span class=whitespace-nowrap>Андрей Акиньшин</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/ru/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>