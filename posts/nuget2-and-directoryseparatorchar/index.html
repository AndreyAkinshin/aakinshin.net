<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.74.3"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content=".NET,Rider,Bugs,Performance,NuGet"><title>NuGet2 and a DirectorySeparatorChar bug</title><link href=/css/lumen-bootstrap.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/slate-bootstrap.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><link href=/css/syntax-light.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/syntax-dark.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.26d61b7027fe55e642f0001cef94cb75b567d721086492aab6b4e32d9ee7811d.js></script><script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.882998740b9c4c24677576b997bde5a487246e2e3bd72128a0e922eaa59db029.mjs></script><link href=https://aakinshin.net/css/fontawesome-all.min.e78467baec0179d7ccd2ef995e0c94f25b4a63a3191a93c3547e22bdf590ef5d.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.2a76db7cc14055b3bafacc363f453917ab54a818a7db2a0a9b2409c0f6bf07c5.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.fe41ce51781393cea2f6a8fd3567674242dd6203d0a0b62f852fb257e992a236.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVB6MXSX32"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-ZVB6MXSX32');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-41419012-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-41419012-5');</script><script type=text/javascript>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym");ym(28700916,"init",{clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src=https://mc.yandex.ru/watch/28700916 style=position:absolute;left:-9999px alt></div></noscript><script src=/js/jquery-3.3.1.slim.min.js></script></head><body><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/posts/>Posts</a></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/pages/prodotnetbenchmarking/>Pro .NET Benchmarking</a></li></ul><ul class="navbar-nav ml-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class=blog-post><h2 class=blog-post-title id=post-title>NuGet2 and a DirectorySeparatorChar bug</h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2017-02-06>February 6, 2017</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/rider/ class="badge badge-info">Rider</a>
<a href=https://aakinshin.net/tags/bugs/ class="badge badge-info">Bugs</a>
<a href=https://aakinshin.net/tags/performance/ class="badge badge-info">Performance</a>
<a href=https://aakinshin.net/tags/nuget/ class="badge badge-info">NuGet</a></span><br><br><p>In <a href=https://www.jetbrains.com/rider/>Rider</a>, we care a lot about performance.
I like to improve the application responsiveness and do interesting optimizations all the time.
Rider is already well-optimized, and it&rsquo;s often hard to make significant performance improvements, so usually I do micro-optimizations which do not have a very big impact on the whole application.
However, sometimes it&rsquo;s possible to improve the speed of a feature 100 times with just a few lines of code.</p><p>Rider is based on <a href=https://www.jetbrains.com/resharper/>ReSharper</a>, so we have a lot of cool features out of the box.
One of these features is <a href=https://www.jetbrains.com/help/resharper/2016.3/Code_Analysis__Solution-Wide_Analysis.html>Solution-Wide Analysis</a>
which lets you constantly keep track of issues in your solution.
Sometimes, solution-wide analysis takes a lot of time to run because there are many files which should be analyzed.
Of course, it works super fast on small and projects.</p><p>Let&rsquo;s talk about a performance bug (<a href=https://youtrack.jetbrains.com/issue/RIDER-3742>#RIDER-3742</a>) that we recently had.</p><ul><li><em>Repro:</em> Open Rider, create a new &ldquo;ASP .NET MVC Application&rdquo;, enable solution wide-analysis.</li><li><em>Expected:</em> The analysis should take 1 second.</li><li><em>Actual:</em> The analysis takes 1 second on Windows and <strong>2 minutes</strong> on Linux and MacOS.</li></ul><p>The solution-wide analysis builds a list of files which should be analyzed.
New asp.net applications depend on eleven NuGet packages include <code>bootstrap</code> and <code>jQuery</code>.
Thus, we have many css and JavaScript files in our project model.
Obviously, such files don&rsquo;t include any user code and should be ignored during the analysis.
On Windows, we have a nice optimization which checks the content of NuGet packages and creates an ignore list.
It turned out that for some reason the ignore list is empty on Linux and MacOS, so all the project model files are added into the analysis list.
As a result, the solution-wide analysis takes 2 minutes (instead of 1 second) to process all these files.</p><p>We use NuGet.Client 4.x for all new features in ReSharper and Rider.
However, we still have a huge amount of legacy code which uses NuGet.Core 2.x.
In particular, the solution-wide analysis still uses NuGet 2.13.
It&rsquo;s hard to rewrite our entire codebase to make use of the new NuGet API at once, so we still have to use the older one for some time.
Hopefully, it will be completely rewritten soon, but for now, we have issues with a higher priority.</p><p>So, the main question here is the following: why can&rsquo;t we read the content of the NuGet packages and get the complete content file list.
Let&rsquo;s look at the corresponding logic:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>contentFile</span> <span class=k>in</span> <span class=n>package</span><span class=p>.</span><span class=n>GetContentFiles</span><span class=p>())</span>
    <span class=n>newContent</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>GetEffectivePath</span><span class=p>(</span><span class=n>contentFile</span><span class=p>));</span>
</code></pre></div><p>Here is the NuGet <a href=https://github.com/NuGet/NuGet2/blob/2.13/src/Core/Extensions/PackageExtensions.cs#L64>source code</a> (v2.13):</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>Constants</span>
<span class=p>{</span>
    <span class=c1>/// &lt;summary&gt;
</span><span class=c1></span>    <span class=c1>/// Represents the content directory in the package.
</span><span class=c1></span>    <span class=c1>/// &lt;/summary&gt;
</span><span class=c1></span>    <span class=k>public</span> <span class=k>static</span> <span class=k>readonly</span> <span class=kt>string</span> <span class=n>ContentDirectory</span> <span class=p>=</span> <span class=s>&#34;content&#34;</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>PackageExtensions</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>static</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>IPackageFile</span><span class=p>&gt;</span> <span class=n>GetContentFiles</span><span class=p>(</span><span class=k>this</span> <span class=n>IPackage</span> <span class=n>package</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=n>package</span><span class=p>.</span><span class=n>GetFiles</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=n>ContentDirectory</span><span class=p>);</span>
    <span class=p>}</span>
    
    <span class=k>public</span> <span class=k>static</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>IPackageFile</span><span class=p>&gt;</span> <span class=n>GetFiles</span><span class=p>(</span><span class=k>this</span> <span class=n>IPackage</span> <span class=n>package</span><span class=p>,</span> <span class=kt>string</span> <span class=n>directory</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=kt>string</span> <span class=n>folderPrefix</span> <span class=p>=</span> <span class=n>directory</span> <span class=p>+</span> <span class=n>Path</span><span class=p>.</span><span class=n>DirectorySeparatorChar</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>package</span><span class=p>.</span><span class=n>GetFiles</span><span class=p>().</span><span class=n>Where</span><span class=p>(</span><span class=n>file</span> <span class=p>=&gt;</span> <span class=n>file</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=n>folderPrefix</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>));</span>
    <span class=p>}</span>  
<span class=p>}</span>
</code></pre></div><p>The next interesting thing here is what <code>file.Path</code> looks like.
Let&rsquo;s download the <code>bootstrap.4.0.0-alpha6</code> package and extract metadata (<code>.nuspec</code>).
Here is the <code>files</code> section:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=p>&lt;</span><span class=n>files</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.css&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.css.map&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.min.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.min.css&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.min.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.min.css.map&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.css&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.css.map&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.min.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.min.css&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.min.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.min.css.map&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.css&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.css.map&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.min.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.min.css&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.min.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.min.css.map&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Scripts\bootstrap.js&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Scripts\bootstrap.js&#34;</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Scripts\bootstrap.min.js&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Scripts\bootstrap.min.js&#34;</span> <span class=p>/&gt;</span>
<span class=p>&lt;/</span><span class=n>files</span><span class=p>&gt;</span>
</code></pre></div><p>You can see those file paths in the <code>nuspec</code> files use the Windows path separator <code>\</code>
(see <a href=https://en.wikipedia.org/wiki/Path_(computing)#Representations_of_paths_by_operating_system_and_shell>Representations of paths by operating system and shell</a>).
In the source code, we form a <code>folderPrefix</code> with the help of
<a href="https://msdn.microsoft.com/en-us/library/system.io.path.directoryseparatorchar(v=vs.110).aspx">Path.DirectorySeparatorChar</a>:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=kt>string</span> <span class=n>folderPrefix</span> <span class=p>=</span> <span class=n>directory</span> <span class=p>+</span> <span class=n>Path</span><span class=p>.</span><span class=n>DirectorySeparatorChar</span><span class=p>;</span>
</code></pre></div><p>The <code>Path.DirectorySeparatorChar</code> equals to <code>/</code> on Linux and MacOS and doesn&rsquo;t equal to the actual <code>nuspec</code> separator.
So, <code>PackageExtensions.GetContentFiles</code> returns an empty list.
Let&rsquo;s do an experiment and rewrite <code>GetContentFiles</code> in the following way:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>private</span> <span class=k>static</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>IPackageFile</span><span class=p>&gt;</span> <span class=n>GetContentFilesXPlat</span><span class=p>(</span><span class=n>IPackage</span> <span class=n>package</span><span class=p>)</span>
<span class=p>{</span>
  <span class=c1>// In a nuspec file we can use any path separator, it&#39;s impossible to say which one is used in advance.
</span><span class=c1></span>  <span class=kt>var</span> <span class=n>folderPrefix1</span> <span class=p>=</span> <span class=n>Constants</span><span class=p>.</span><span class=n>ContentDirectory</span> <span class=p>+</span> <span class=s>@&#34;/&#34;</span><span class=p>;</span>
  <span class=kt>var</span> <span class=n>folderPrefix2</span> <span class=p>=</span> <span class=n>Constants</span><span class=p>.</span><span class=n>ContentDirectory</span> <span class=p>+</span> <span class=s>@&#34;\&#34;</span><span class=p>;</span>
  <span class=k>return</span> <span class=n>package</span><span class=p>.</span><span class=n>GetFiles</span><span class=p>().</span><span class=n>Where</span><span class=p>(</span><span class=n>file</span> <span class=p>=&gt;</span>
    <span class=n>file</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=n>folderPrefix1</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>)</span> <span class=p>||</span>
    <span class=n>file</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=n>folderPrefix2</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div><p>Now we can use <code>GetContentFilesXPlat</code> in our code and get the actual list of content files.
I checked that this method now works fine, so I made a commit, pushed it, closed the issue, and started to solve our next performance puzzle.</p><p>The next day, I saw that the issue was reopened.
Our QA engineer told me that the bug is still here.</p><p>Hmm, ok, let&rsquo;s debug this logic again.
If you read the first code snippet carefully, you may notice that we are working with &ldquo;effective paths&rdquo;:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=n>newContent</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>GetEffectivePath</span><span class=p>(</span><span class=n>contentFile</span><span class=p>));</span>
</code></pre></div><p>Each <code>IPackageFile</code> package has <code>Path</code> and <code>EffectivePath</code>:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>interface</span> <span class=n>IPackageFile</span> <span class=p>:</span> <span class=n>IFrameworkTargetable</span>
<span class=p>{</span>
    <span class=kt>string</span> <span class=n>Path</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=kt>string</span> <span class=n>EffectivePath</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=n>FrameworkName</span> <span class=n>TargetFramework</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=n>Stream</span> <span class=n>GetStream</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div><p>I did a few more debugging sessions and discovered the following values for the <code>bootstrap-theme</code> package file:</p><table><thead><tr><th>OS</th><th>Path</th><th>EffectivePath</th></tr></thead><tbody><tr><td>Windows</td><td>content\Content\bootstrap-theme.css</td><td>Content\bootstrap-theme.css</td></tr><tr><td>Linux</td><td>content\Content\bootstrap-theme.css</td><td>content\Content\bootstrap-theme.css</td></tr></tbody></table><p>You can see that we have the wrong effective path on Linux (<code>content\Content\bootstrap-theme.css</code> instead of <code>Content\bootstrap-theme.css</code>).
So, how does NuGet calculate the effective paths? Let&rsquo;s look at the source code again.
<a href=https://github.com/NuGet/NuGet2/blob/2.13/src/Core/Utility/VersionUtility.cs#L773>NuGet-2.13, VersionUtility.cs</a>:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>static</span> <span class=n>FrameworkName</span> <span class=n>ParseFrameworkNameFromFilePath</span><span class=p>(</span><span class=kt>string</span> <span class=n>filePath</span><span class=p>,</span> <span class=k>out</span> <span class=kt>string</span> <span class=n>effectivePath</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>var</span> <span class=n>knownFolders</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>string</span><span class=p>[]</span>
    <span class=p>{</span>
        <span class=n>Constants</span><span class=p>.</span><span class=n>ContentDirectory</span><span class=p>,</span>
        <span class=n>Constants</span><span class=p>.</span><span class=n>LibDirectory</span><span class=p>,</span>
        <span class=n>Constants</span><span class=p>.</span><span class=n>ToolsDirectory</span><span class=p>,</span>
        <span class=n>Constants</span><span class=p>.</span><span class=n>BuildDirectory</span>
    <span class=p>};</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>knownFolders</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
    <span class=p>{</span>
        <span class=kt>string</span> <span class=n>folderPrefix</span> <span class=p>=</span> <span class=n>knownFolders</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>DirectorySeparatorChar</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>filePath</span><span class=p>.</span><span class=n>Length</span> <span class=p>&gt;</span> <span class=n>folderPrefix</span><span class=p>.</span><span class=n>Length</span> <span class=p>&amp;&amp;</span>
            <span class=n>filePath</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=n>folderPrefix</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>))</span>
        <span class=p>{</span>
            <span class=kt>string</span> <span class=n>frameworkPart</span> <span class=p>=</span> <span class=n>filePath</span><span class=p>.</span><span class=n>Substring</span><span class=p>(</span><span class=n>folderPrefix</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span>
            <span class=k>try</span>
            <span class=p>{</span>
                <span class=k>return</span> <span class=n>VersionUtility</span><span class=p>.</span><span class=n>ParseFrameworkFolderName</span><span class=p>(</span>
                    <span class=n>frameworkPart</span><span class=p>,</span>
                    <span class=n>strictParsing</span><span class=p>:</span> <span class=n>knownFolders</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>==</span> <span class=n>Constants</span><span class=p>.</span><span class=n>LibDirectory</span><span class=p>,</span>
                    <span class=n>effectivePath</span><span class=p>:</span> <span class=k>out</span> <span class=n>effectivePath</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>catch</span> <span class=p>(</span><span class=n>ArgumentException</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=c1>// if the parsing fails, we treat it as if this file
</span><span class=c1></span>                <span class=c1>// doesn&#39;t have target framework.
</span><span class=c1></span>                <span class=n>effectivePath</span> <span class=p>=</span> <span class=n>frameworkPart</span><span class=p>;</span>
                <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>effectivePath</span> <span class=p>=</span> <span class=n>filePath</span><span class=p>;</span>
    <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>And again, we have a <code>DirectorySeparatorChar</code> bug here:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=kt>string</span> <span class=n>folderPrefix</span> <span class=p>=</span> <span class=n>knownFolders</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>DirectorySeparatorChar</span><span class=p>;</span>
</code></pre></div><p>I rewrote this method too; now everything works fine.
I built Rider, checked, and double-checked that the solution-wide analysis takes only 1 second on Linux and MacOS.</p><p>Usually, we send pull requests to 3rd projects with our fixes.
However, it turned out that there are 53 usages of <code>DirectorySeparatorChar</code> in the NuGet2 source code.
So, I just created an issue: <a href=https://github.com/NuGet/Home/issues/4509>NuGet/Home#4509</a>.</p><p>Of course, it wasn&rsquo;t the first bug with <code>\</code> and <code>/</code>: we fight with them all the time.
I suspect that we will meet a lot of such bugs in the future.
For now, we have a significant performance improvement for the solution-wide analysis for new asp.net projects on Linux and MacOS
(this fix will be included in Rider EAP17).</p><br><br><div class=row><div class="mx-auto share-block"><div class=share-title>Share:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fnuget2-and-directoryseparatorchar%2f&title=NuGet2%20and%20a%20DirectorySeparatorChar%20bug" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=NuGet2%20and%20a%20DirectorySeparatorChar%20bug&url=https%3a%2f%2faakinshin.net%2fposts%2fnuget2-and-directoryseparatorchar%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fnuget2-and-directoryseparatorchar%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://facebook.com/sharer.php?u=https%3a%2f%2faakinshin.net%2fposts%2fnuget2-and-directoryseparatorchar%2f" rel=nofollow target=_blank title="Share on Facebook"><i class="fab fa-facebook fa-2x"></i></a></div><div class=share-button><a href="http://vk.com/share.php?url=https%3a%2f%2faakinshin.net%2fposts%2fnuget2-and-directoryseparatorchar%2f" target=_blank title="Share on VKontakte"><i class="fab fa-vk fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fnuget2-and-directoryseparatorchar%2f&title=NuGet2%20and%20a%20DirectorySeparatorChar%20bug" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class=blog-footer><div class=container><p>&copy; 2013–2020 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub style=color:#fff></i></a><a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter style=color:#fff></i></a><a href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS style=color:#fff></i></a>|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.082780cb948cc57eabbc0d80172a7a5347d5572b599938b4c9876dfd7978b424.js></script><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/anchor.min.js></script><script src=https://aakinshin.net/js/custom.min.11932490dde776463ed165b345838c701accc0cfdedf2e0868f13415f41f0872.js></script></body></html>