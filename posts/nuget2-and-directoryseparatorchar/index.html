<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.123.7"><meta name=author content='Andrey Akinshin'><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content='Programming,.NET,Rider,Bugs,Performance,NuGet'><title>NuGet2 and a DirectorySeparatorChar bug | Andrey Akinshin</title>
<meta name=description content="In Rider, we care a lot about performance. I like to improve the application responsiveness and do interesting optimizations all the time. Rider is already well-optimized, and it&amp;rsquo;s often hard to make significant performance improvements, so usually I ..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.f8640bf9a1f7ba7802d4c626b7c44d7f16a850d1b3573e70d5e67cc11f2bb278.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-2 xs:px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/library/>Library</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/about/>About</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/search/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#magnifying-glass"/></svg></a></div></div><button id=theme-toggle type=button title="Alt+Click to match OS color theme" class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>NuGet2 and a DirectorySeparatorChar bug</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg>
<time datetime=2017-02-06>February 6, 2017</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming
</a><a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET
</a><a class=label-link href=https://aakinshin.net/tags/rider/>Rider
</a><a class=label-link href=https://aakinshin.net/tags/bugs/>Bugs
</a><a class=label-link href=https://aakinshin.net/tags/performance/>Performance
</a><a class=label-link href=https://aakinshin.net/tags/nuget/>NuGet</a></div></div><br><div class=main-content><p>In <a href=https://www.jetbrains.com/rider/>Rider</a>, we care a lot about performance.
I like to improve the application responsiveness and do interesting optimizations all the time.
Rider is already well-optimized, and it&rsquo;s often hard to make significant performance improvements, so usually I do micro-optimizations which do not have a very big impact on the whole application.
However, sometimes it&rsquo;s possible to improve the speed of a feature 100 times with just a few lines of code.</p><p>Rider is based on <a href=https://www.jetbrains.com/resharper/>ReSharper</a>, so we have a lot of cool features out of the box.
One of these features is <a href=https://www.jetbrains.com/help/resharper/2016.3/Code_Analysis__Solution-Wide_Analysis.html>Solution-Wide Analysis</a>
which lets you constantly keep track of issues in your solution.
Sometimes, solution-wide analysis takes a lot of time to run because there are many files which should be analyzed.
Of course, it works super fast on small and projects.</p><p>Let&rsquo;s talk about a performance bug (<a href=https://youtrack.jetbrains.com/issue/RIDER-3742>#RIDER-3742</a>) that we recently had.</p><ul><li><em>Repro:</em> Open Rider, create a new &ldquo;ASP .NET MVC Application&rdquo;, enable solution wide-analysis.</li><li><em>Expected:</em> The analysis should take 1 second.</li><li><em>Actual:</em> The analysis takes 1 second on Windows and <strong>2 minutes</strong> on Linux and MacOS.</li></ul><p>The solution-wide analysis builds a list of files which should be analyzed.
New asp.net applications depend on eleven NuGet packages include <code>bootstrap</code> and <code>jQuery</code>.
Thus, we have many css and JavaScript files in our project model.
Obviously, such files don&rsquo;t include any user code and should be ignored during the analysis.
On Windows, we have a nice optimization which checks the content of NuGet packages and creates an ignore list.
It turned out that for some reason the ignore list is empty on Linux and MacOS, so all the project model files are added into the analysis list.
As a result, the solution-wide analysis takes 2 minutes (instead of 1 second) to process all these files.</p><p>We use NuGet.Client 4.x for all new features in ReSharper and Rider.
However, we still have a huge amount of legacy code which uses NuGet.Core 2.x.
In particular, the solution-wide analysis still uses NuGet 2.13.
It&rsquo;s hard to rewrite our entire codebase to make use of the new NuGet API at once, so we still have to use the older one for some time.
Hopefully, it will be completely rewritten soon, but for now, we have issues with a higher priority.</p><p>So, the main question here is the following: why can&rsquo;t we read the content of the NuGet packages and get the complete content file list.
Let&rsquo;s look at the corresponding logic:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>contentFile</span> <span class=k>in</span> <span class=n>package</span><span class=p>.</span><span class=n>GetContentFiles</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>newContent</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>GetEffectivePath</span><span class=p>(</span><span class=n>contentFile</span><span class=p>));</span>
</span></span></code></pre></div><p>Here is the NuGet <a href=https://github.com/NuGet/NuGet2/blob/2.13/src/Core/Extensions/PackageExtensions.cs#L64>source code</a> (v2.13):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=k>class</span> <span class=nc>Constants</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cs>/// &lt;summary&gt;</span>
</span></span><span class=line><span class=cl>    <span class=cs>/// Represents the content directory in the package.</span>
</span></span><span class=line><span class=cl>    <span class=cs>/// &lt;/summary&gt;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=k>readonly</span> <span class=kt>string</span> <span class=n>ContentDirectory</span> <span class=p>=</span> <span class=s>&#34;content&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=k>class</span> <span class=nc>PackageExtensions</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>IPackageFile</span><span class=p>&gt;</span> <span class=n>GetContentFiles</span><span class=p>(</span><span class=k>this</span> <span class=n>IPackage</span> <span class=n>package</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>package</span><span class=p>.</span><span class=n>GetFiles</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=n>ContentDirectory</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>IPackageFile</span><span class=p>&gt;</span> <span class=n>GetFiles</span><span class=p>(</span><span class=k>this</span> <span class=n>IPackage</span> <span class=n>package</span><span class=p>,</span> <span class=kt>string</span> <span class=n>directory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>string</span> <span class=n>folderPrefix</span> <span class=p>=</span> <span class=n>directory</span> <span class=p>+</span> <span class=n>Path</span><span class=p>.</span><span class=n>DirectorySeparatorChar</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>package</span><span class=p>.</span><span class=n>GetFiles</span><span class=p>().</span><span class=n>Where</span><span class=p>(</span><span class=n>file</span> <span class=p>=&gt;</span> <span class=n>file</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=n>folderPrefix</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The next interesting thing here is what <code>file.Path</code> looks like.
Let&rsquo;s download the <code>bootstrap.4.0.0-alpha6</code> package and extract metadata (<code>.nuspec</code>).
Here is the <code>files</code> section:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=p>&lt;</span><span class=n>files</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.css&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.css.map&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.min.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.min.css&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.min.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-grid.min.css.map&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.css&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.css.map&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.min.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.min.css&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.min.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap-reboot.min.css.map&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.css&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.css.map&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.min.css&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.min.css&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.min.css.map&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Content\bootstrap.min.css.map&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Scripts\bootstrap.js&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Scripts\bootstrap.js&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=n>file</span> <span class=n>src</span><span class=p>=</span><span class=s>&#34;content\Scripts\bootstrap.min.js&#34;</span> <span class=n>target</span><span class=p>=</span><span class=s>&#34;content\Scripts\bootstrap.min.js&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=n>files</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>You can see those file paths in the <code>nuspec</code> files use the Windows path separator <code>\</code>
(see <a href=https://en.wikipedia.org/wiki/Path_(computing)#Representations_of_paths_by_operating_system_and_shell>Representations of paths by operating system and shell</a>).
In the source code, we form a <code>folderPrefix</code> with the help of
<a href="https://msdn.microsoft.com/en-us/library/system.io.path.directoryseparatorchar(v=vs.110).aspx">Path.DirectorySeparatorChar</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>string</span> <span class=n>folderPrefix</span> <span class=p>=</span> <span class=n>directory</span> <span class=p>+</span> <span class=n>Path</span><span class=p>.</span><span class=n>DirectorySeparatorChar</span><span class=p>;</span>
</span></span></code></pre></div><p>The <code>Path.DirectorySeparatorChar</code> equals to <code>/</code> on Linux and MacOS and doesn&rsquo;t equal to the actual <code>nuspec</code> separator.
So, <code>PackageExtensions.GetContentFiles</code> returns an empty list.
Let&rsquo;s do an experiment and rewrite <code>GetContentFiles</code> in the following way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>IPackageFile</span><span class=p>&gt;</span> <span class=n>GetContentFilesXPlat</span><span class=p>(</span><span class=n>IPackage</span> <span class=n>package</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// In a nuspec file we can use any path separator, it&#39;s impossible to say which one is used in advance.</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>folderPrefix1</span> <span class=p>=</span> <span class=n>Constants</span><span class=p>.</span><span class=n>ContentDirectory</span> <span class=p>+</span> <span class=s>@&#34;/&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>folderPrefix2</span> <span class=p>=</span> <span class=n>Constants</span><span class=p>.</span><span class=n>ContentDirectory</span> <span class=p>+</span> <span class=s>@&#34;\&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>package</span><span class=p>.</span><span class=n>GetFiles</span><span class=p>().</span><span class=n>Where</span><span class=p>(</span><span class=n>file</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=n>file</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=n>folderPrefix1</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>)</span> <span class=p>||</span>
</span></span><span class=line><span class=cl>    <span class=n>file</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=n>folderPrefix2</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now we can use <code>GetContentFilesXPlat</code> in our code and get the actual list of content files.
I checked that this method now works fine, so I made a commit, pushed it, closed the issue, and started to solve our next performance puzzle.</p><p>The next day, I saw that the issue was reopened.
Our QA engineer told me that the bug is still here.</p><p>Hmm, ok, let&rsquo;s debug this logic again.
If you read the first code snippet carefully, you may notice that we are working with &ldquo;effective paths&rdquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>newContent</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>GetEffectivePath</span><span class=p>(</span><span class=n>contentFile</span><span class=p>));</span>
</span></span></code></pre></div><p>Each <code>IPackageFile</code> package has <code>Path</code> and <code>EffectivePath</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>public</span> <span class=k>interface</span> <span class=nc>IPackageFile</span> <span class=p>:</span> <span class=n>IFrameworkTargetable</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=n>Path</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=n>EffectivePath</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>FrameworkName</span> <span class=n>TargetFramework</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Stream</span> <span class=n>GetStream</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>I did a few more debugging sessions and discovered the following values for the <code>bootstrap-theme</code> package file:</p><table><thead><tr><th>OS</th><th>Path</th><th>EffectivePath</th></tr></thead><tbody><tr><td>Windows</td><td>content\Content\bootstrap-theme.css</td><td>Content\bootstrap-theme.css</td></tr><tr><td>Linux</td><td>content\Content\bootstrap-theme.css</td><td>content\Content\bootstrap-theme.css</td></tr></tbody></table><p>You can see that we have the wrong effective path on Linux (<code>content\Content\bootstrap-theme.css</code> instead of <code>Content\bootstrap-theme.css</code>).
So, how does NuGet calculate the effective paths? Let&rsquo;s look at the source code again.
<a href=https://github.com/NuGet/NuGet2/blob/2.13/src/Core/Utility/VersionUtility.cs#L773>NuGet-2.13, VersionUtility.cs</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=n>FrameworkName</span> <span class=n>ParseFrameworkNameFromFilePath</span><span class=p>(</span><span class=kt>string</span> <span class=n>filePath</span><span class=p>,</span> <span class=k>out</span> <span class=kt>string</span> <span class=n>effectivePath</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>knownFolders</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>string</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Constants</span><span class=p>.</span><span class=n>ContentDirectory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Constants</span><span class=p>.</span><span class=n>LibDirectory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Constants</span><span class=p>.</span><span class=n>ToolsDirectory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Constants</span><span class=p>.</span><span class=n>BuildDirectory</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>knownFolders</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>string</span> <span class=n>folderPrefix</span> <span class=p>=</span> <span class=n>knownFolders</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>DirectorySeparatorChar</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>filePath</span><span class=p>.</span><span class=n>Length</span> <span class=p>&gt;</span> <span class=n>folderPrefix</span><span class=p>.</span><span class=n>Length</span> <span class=p>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=n>filePath</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=n>folderPrefix</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>string</span> <span class=n>frameworkPart</span> <span class=p>=</span> <span class=n>filePath</span><span class=p>.</span><span class=n>Substring</span><span class=p>(</span><span class=n>folderPrefix</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>VersionUtility</span><span class=p>.</span><span class=n>ParseFrameworkFolderName</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>frameworkPart</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>strictParsing</span><span class=p>:</span> <span class=n>knownFolders</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>==</span> <span class=n>Constants</span><span class=p>.</span><span class=n>LibDirectory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>effectivePath</span><span class=p>:</span> <span class=k>out</span> <span class=n>effectivePath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>catch</span> <span class=p>(</span><span class=n>ArgumentException</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// if the parsing fails, we treat it as if this file</span>
</span></span><span class=line><span class=cl>                <span class=c1>// doesn&#39;t have target framework.</span>
</span></span><span class=line><span class=cl>                <span class=n>effectivePath</span> <span class=p>=</span> <span class=n>frameworkPart</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>effectivePath</span> <span class=p>=</span> <span class=n>filePath</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And again, we have a <code>DirectorySeparatorChar</code> bug here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>string</span> <span class=n>folderPrefix</span> <span class=p>=</span> <span class=n>knownFolders</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>Path</span><span class=p>.</span><span class=n>DirectorySeparatorChar</span><span class=p>;</span>
</span></span></code></pre></div><p>I rewrote this method too; now everything works fine.
I built Rider, checked, and double-checked that the solution-wide analysis takes only 1 second on Linux and MacOS.</p><p>Usually, we send pull requests to 3rd projects with our fixes.
However, it turned out that there are 53 usages of <code>DirectorySeparatorChar</code> in the NuGet2 source code.
So, I just created an issue: <a href=https://github.com/NuGet/Home/issues/4509>NuGet/Home#4509</a>.</p><p>Of course, it wasn&rsquo;t the first bug with <code>\</code> and <code>/</code>: we fight with them all the time.
I suspect that we will meet a lot of such bugs in the future.
For now, we have a significant performance improvement for the solution-wide analysis for new asp.net projects on Linux and MacOS
(this fix will be included in Rider EAP17).</p></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}));function toggleTheme(e){e?(document.documentElement.classList.add("dark"),themeToggleLightIcon.classList.remove("hidden"),themeToggleDarkIcon.classList.add("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")}),imagesLight.forEach(e=>{e.classList.add("hidden")})):(document.documentElement.classList.remove("dark"),themeToggleDarkIcon.classList.remove("hidden"),themeToggleLightIcon.classList.add("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}),imagesDark.forEach(e=>{e.classList.add("hidden")}))}themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),event.altKey?(localStorage.removeItem("color-theme"),toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches)):localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{if(localStorage.getItem("color-theme")===null){const t=e.matches?"dark":"light";toggleTheme(t==="dark")}})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2024 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+=" has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>