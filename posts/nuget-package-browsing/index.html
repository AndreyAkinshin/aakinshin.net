<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,NuGet,Rider"><title>A story about slow NuGet package browsing | Andrey Akinshin</title><meta name=description content="In Rider, we have integration tests which interact with api.nuget.org. Also, we have an internal service which monitors the performance of these tests. Two..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.13341ac97e21004cde7f286e6b392a1234aa8b2656426c008cfd9f98cd200dd1.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>A story about slow NuGet package browsing</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2018-05-08>May 8, 2018</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/nuget/>NuGet</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a></div></div><br><div class=main-content><p>In <a href=https://www.jetbrains.com/rider/>Rider</a>, we have integration tests which interact with <a href=https://api.nuget.org/>api.nuget.org</a>.
Also, we have an internal service which monitors the performance of these tests.
Two days ago, I noticed that some of these tests sometimes are running for too long.
For example, <code>nuget_NuGetTest_shouldUpgradeVersionForDotNetCore</code> usually takes around <code>10 sec</code>.
However, in some cases, it takes around <code>110 sec</code>, <code>210 sec</code>, or <code>310 sec</code>:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/perf-chart.png target=_blank alt=perf-chart><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/perf-chart.png></a></div></div><br><p>It looks very suspicious and increases the whole test suite duration.
Also, our dashboard with performance degradations contains only such tests
and some real degradations (which are introduced by the changes in our codebase) can go unnoticed.
So, my colleagues and I decided to investigate it.</p><p>First of all, we decided to look at the logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Information   GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0
</span></span><span class=line><span class=cl>Information An error was encountered when fetching
</span></span><span class=line><span class=cl>  &#39;GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0&#39;. The request will now be retried.
</span></span><span class=line><span class=cl>The HTTP request to &#39;GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0&#39;
</span></span><span class=line><span class=cl>  has timed out after 100000ms.
</span></span><span class=line><span class=cl>Information   GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0
</span></span><span class=line><span class=cl>Information   OK https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0 1090ms
</span></span></code></pre></div><p>In this test, we are trying to get TOP 10 NuGet packages from nuget.org.
The code calls <a href=https://github.com/NuGet/NuGet.Client>NuGet.Client API</a>
which <a href=https://github.com/NuGet/NuGet.Client/blob/release-4.5.0-rtm/src/NuGet.Core/NuGet.Protocol/Resources/RawSearchResourceV3.cs#L40>constructs</a>
the <code>https://api-v2v3search-0.nuget.org/query?q=&skip=0&take=10&prerelease=false&semVerLevel=2.0.0</code> url
and send a HTTP request.
The server doesn&rsquo;t respond in <code>100'000ms</code>, NuGet terminates this request by timeout
and <a href=https://github.com/NuGet/NuGet.Client/blob/release-4.5.0-rtm/src/NuGet.Core/NuGet.Protocol/HttpSource/HttpRetryHandler.cs#L38>retries</a> it.</p><p>We decided to write a simple small repro based on <code>HttpClient</code> which reproduces the issue:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>100</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>client</span> <span class=p>=</span> <span class=k>new</span> <span class=n>HttpClient</span> <span class=p>{</span> <span class=n>Timeout</span> <span class=p>=</span> <span class=n>TimeSpan</span><span class=p>.</span><span class=n>FromSeconds</span><span class=p>(</span><span class=m>10000</span><span class=p>)</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=s>&#34;Request #&#34;</span> <span class=p>+</span> <span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>).</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;000&#34;</span><span class=p>)</span> <span class=p>+</span> <span class=s>&#34;: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>sw</span> <span class=p>=</span> <span class=n>Stopwatch</span><span class=p>.</span><span class=n>StartNew</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>r</span> <span class=p>=</span> <span class=k>await</span> <span class=n>client</span><span class=p>.</span><span class=n>GetAsync</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;https://api-v2v3search-0.nuget.org:443/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=s>&#34;OK&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=s>&#34;FAIL                 .&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>sw</span><span class=p>.</span><span class=n>Stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>$&#34; Time: {sw.Elapsed.TotalSeconds:0.000} sec&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Surprisingly, with <code>Timeout = TimeSpan.FromSeconds(10000)</code> almost all of the request are successful.
On Windows, it produces the following distribution:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/stat.png target=_blank alt=stat><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/stat.png></a></div></div><br><p>It&rsquo;s very important to create a new instance of <code>HttpClient</code> for the each iteration: otherwise, the connection will be reused, and we will not get such a picture.</p><p>In the picture, we have a multimodal distribution with following levels:</p><ul><li><code>~1sec</code>:<ul><li><code>HttpClient</code> sends a request;</li><li>request is finished without any problems;</li><li>we get the list of packages</li></ul></li><li><code>~125sec</code>:<ul><li><code>HttpClient</code> sends a request;</li><li>the server terminates the request after 2 minutes;</li><li><code>HttpClient</code> retries the request;</li><li>we get the list of packages</li></ul></li><li><code>~250sec</code>:<ul><li><code>HttpClient</code> sends a request;</li><li>the server terminates the request after 2 minutes;</li><li><code>HttpClient</code> retries the request;</li><li>the server terminates the second request after 2 minutes;</li><li><code>HttpClient</code> retries the request again;</li><li>we get the list of packages</li></ul></li><li><code>~375sec</code>:<ul><li><code>HttpClient</code> sends a request;</li><li>the server terminates the request after 2 minutes;</li><li><code>HttpClient</code> retries the request;</li><li>the server terminates the second request after 2 minutes;</li><li><code>HttpClient</code> retries the request again;</li><li>the server terminates the third request after 2 minutes;</li><li>we <strong>don&rsquo;t</strong> get the list of packages (we get <code>System.Net.Http.WinHttpException: The connection with the server was terminated abnormally</code>)</li></ul></li></ul><p>A remark: on my machine, the first attempt uses <code>TLSv1.2</code>, the second attempt uses <code>TLSv1.1</code>, the third attempt uses <code>TLSv1</code>.
A screenshot from <a href=https://www.wireshark.org/>Wireshark</a> for the <code>~250sec</code> case:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/wireshark.png target=_blank alt=wireshark><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/wireshark.png></a></div></div><br><p>We tried it on our local machines and double checked it on an Azure VM:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/azure.png target=_blank alt=azure><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/azure.png></a></div></div><br><p>This problem affects (sometimes) different IDEs with NuGet Package Manager: it may take up to several minutes before it displays the search results.
That&rsquo;s how it looks in Visual Studio:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/vs-for-mac.gif target=_blank alt=vs><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/vs-for-mac.gif></a></div></div><br><p>That&rsquo;s how it looks in Visual Studio for Mac:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/vs-for-mac.gif target=_blank alt=vs-for-mac><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/vs-for-mac.gif></a></div></div><br><p>It&rsquo;s hard to reproduce this issue in <a href=https://www.jetbrains.com/rider/>Rider</a> because we are <a href=https://aakinshin.net/blog/post/rider-nuget-search/>using a persistent local cache of search results</a>:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/rider.gif target=_blank alt=rider><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/rider.gif></a></div></div><br><p>Currently, the problem is reproduced on <code>api-v2v3search-0.nuget.org</code> (<code>52.162.253.198</code>) and <code>api-v2v3search-1.nuget.org</code> (<code>13.84.46.37</code>).</p><p>Since it&rsquo;s a server-side problem and we can&rsquo;t fix it locally, we created an issue on GitHub: <a href=https://github.com/NuGet/Home/issues/6921>NuGet/Home#6921</a> (moved to <a href=https://github.com/NuGet/NuGetGallery/issues/5899>NuGet/NuGetGallery#5899</a>).</p><p><strong>Update.</strong>
A remark about the code snippet.
In the first version of the repro, I used a single <code>HttpClient</code> instance for all requests.
In this case, the first request fails in ~30% cases,
other requests are successful because the connection is already established.
From the practical point of view, it means that user can get hanged NuGet Package Manager in VS only once after startup.
However, in this case, it&rsquo;s hard to investigate the problem because it&rsquo;s very unstable.
Thus, the code snippet creates a new HttpClient instance each time on purpose.
So, it&rsquo;s very easy to reproduce the problem.</p><p><strong>Update 2018-05-11.</strong>
The issue is <a href=https://github.com/NuGet/NuGetGallery/issues/5899#issuecomment-388222254>fixed</a>.</p></div><h3>Data availability</h3>The source code of this post and all the relevant files is <a href=https://github.com/AndreyAkinshin/aakinshin.net/tree/master/content/en/posts/2018/nuget-package-browsing/index.md>available on GitHub</a>.<br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fnuget-package-browsing%2f&title=A%20story%20about%20slow%20NuGet%20package%20browsing" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=A%20story%20about%20slow%20NuGet%20package%20browsing&url=https%3a%2f%2faakinshin.net%2fposts%2fnuget-package-browsing%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fnuget-package-browsing%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fnuget-package-browsing%2f&title=A%20story%20about%20slow%20NuGet%20package%20browsing" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>