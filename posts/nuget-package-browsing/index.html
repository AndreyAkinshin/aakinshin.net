<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="A story about slow NuGet package browsing">
    <meta name="author" content="Andrey Akinshin">
    <link href="/img/favicon.ico" rel="icon" type="image/x-icon"/>
    <meta name="keywords" content='NuGet,Rider'>

    <title>A story about slow NuGet package browsing</title>

    <!-- Bootstrap CSS -->
    <link href="/css/lumen-bootstrap.min.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/minty-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/sketchy-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/slate-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/solar-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/superhero-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>

    <!-- Highlight.js -->
    <link href="/css/github-highlight.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/hopscotch-highlight.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/solarized-highlight.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/darcula-highlight.css" rel="stylesheet" type="text/css" media="all" disabled>

    <!-- FontAwesome -->
    <link href="/css/fontawesome-all.min.css" rel="stylesheet" type="text/css" media="all">
    
    <!-- Custom styles -->
    <link href="/css/about.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/blog.css" rel="stylesheet" type="text/css" media="all">

    <!-- Load theme -->
    <script src="/js/load-theme.js"></script>

    <!-- Feeds -->
    <link href="/en/rss.xml" type="application/rss+xml" rel="alternate" title="Blog RSS Feed" />
    <link href="/en/atom.xml" type="application/atom+xml" rel="alternate" title="Blog ATOM Feed" />

    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41419012-5', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function (d, w, c) {
            (w[c] = w[c] || []).push(function() {
                try {
                    w.yaCounter28700916 = new Ya.Metrika({
                        id:28700916,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true,
                        webvisor:true,
                        trackHash:true
                    });
                } catch(e) { }
            });

            var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
            s.type = "text/javascript";
            s.async = true;
            s.src = "https://mc.yandex.ru/metrika/watch.js";

            if (w.opera == "[object Opera]") {
                d.addEventListener("DOMContentLoaded", f, false);
            } else { f(); }
        })(document, window, "yandex_metrika_callbacks");
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/28700916" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->

    <!-- jQuery -->
    <script src="/js/jquery-3.2.1.slim.min.js"></script>
  </head>

  <body>
    <div class="bg-primary">
      <div class="container bg-primary">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" id="nav-link-blog" href="/posts/">Posts</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-link-blog-content" href="/content/">Content</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-link-about" href="/about/">About author</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href='/ru/posts/nuget-package-browsing/'>Russian version</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Theme</a>
              <div class="dropdown-menu">
                  <h6 class="dropdown-header" style="text-align: center">Light</h6>
                  <a class="dropdown-item" href="#" onclick="setTheme('lumen', 'github');">lumen</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('sketchy', 'github');">sketchy</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('minty', 'github');">minty</a>
                  <div class="dropdown-divider"></div>
                  <h6 class="dropdown-header" style="text-align: center">Dark</h6>
                  <a class="dropdown-item" href="#" onclick="setTheme('solar', 'solarized');">solar</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('slate', 'darcula');">slate</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('superhero', 'hopscotch');">superhero</a>
              </div>
            </li>
            <li class="nav-item"><a class="nav-link" href="https://github.com/AndreyAkinshin"><i class="fab fa-github" title="GitHub" style="color:white"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://twitter.com/andrey_akinshin"><i class="fab fa-twitter" title="Twitter" style="color:white"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="/rss.xml"><i class="fas fa-rss" title="RSS" style="color:white"></i></a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="container">
      <div class="blog-main">
<div class="blog-post">

<h2 class="blog-post-title" id="post-title">A story about slow NuGet package browsing</h2>
<span class="blog-post-meta">
  <b>Date:</b> May 08, 2018.
  <b>Tags:</b>
        <a href="/tags/nuget"><span class="badge badge-pill badge-info">NuGet</span></a>
        <a href="/tags/rider"><span class="badge badge-pill badge-info">Rider</span></a>
</span><br /><br />

<p>In <a href="https://www.jetbrains.com/rider/">Rider</a>, we have integration tests which interact with <a href="https://api.nuget.org/">api.nuget.org</a>.
Also, we have an internal service which monitors the performance of these tests.
Two days ago, I noticed that some of these tests sometimes are running for too long.
For example, <code>nuget_NuGetTest_shouldUpgradeVersionForDotNetCore</code> usually takes around <code>10 sec</code>.
However, in some cases, it takes around <code>110 sec</code>, <code>210 sec</code>, or <code>310 sec</code>:</p>
<div class="mx-auto"><a href="/img/posts/nuget-package-browsing/perf-chart.png" target="_blank"><img class="mx-auto d-block" width="600" src="/img/posts/nuget-package-browsing/perf-chart.png" /></a></div>
<p>It looks very suspicious and increases the whole test suite duration.
Also, our dashboard with performance degradations contains only such tests
and some real degradations (which are introduced by the changes in our codebase) can go unnoticed.
So, my colleagues and I decided to investigate it.</p>
<!--more-->
<p>First of all, we decided to look at the logs:</p>
<pre><code>Information   GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0
Information An error was encountered when fetching
  'GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0'. The request will now be retried.
The HTTP request to 'GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0'
  has timed out after 100000ms.
Information   GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0
Information   OK https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0 1090ms
</code></pre>
<p>In this test, we are trying to get TOP 10 NuGet packages from nuget.org.
The code calls <a href="https://github.com/NuGet/NuGet.Client">NuGet.Client API</a>
which <a href="https://github.com/NuGet/NuGet.Client/blob/release-4.5.0-rtm/src/NuGet.Core/NuGet.Protocol/Resources/RawSearchResourceV3.cs#L40">constructs</a>
the <code>https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0</code> url
and send a HTTP request.
The server doesn't respond in <code>100'000ms</code>, NuGet terminates this request by timeout
and <a href="https://github.com/NuGet/NuGet.Client/blob/release-4.5.0-rtm/src/NuGet.Core/NuGet.Protocol/HttpSource/HttpRetryHandler.cs#L38">retries</a> it.</p>
<p>We decided to write a simple small repro based on <code>HttpClient</code> which reproduces the issue:</p>
<pre><code class="language-cs">for (int i = 0; i &lt; 100; i++)
{
    using (var client = new HttpClient { Timeout = TimeSpan.FromSeconds(10000) })
    {
        Console.Write(&quot;Request #&quot; + (i + 1).ToString(&quot;000&quot;) + &quot;: &quot;);
        var sw = Stopwatch.StartNew();
        try
        {
            var r = await client.GetAsync(
                &quot;https://api-v2v3search-0.nuget.org:443/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0&quot;);
            Console.Write(&quot;OK&quot;);
        }
        catch (Exception e)
        {
            Console.Write(&quot;FAIL                 .&quot;);
            Console.WriteLine(e);
        }
        sw.Stop();
        Console.WriteLine($&quot; Time: {sw.Elapsed.TotalSeconds:0.000} sec&quot;);
    }
}
</code></pre>
<p>Surprisingly, with <code>Timeout = TimeSpan.FromSeconds(10000)</code> almost all of the request are successful.
On Windows, it produces the following distribution:</p>
<div class="mx-auto"><a href="/img/posts/nuget-package-browsing/stat.png" target="_blank"><img class="mx-auto d-block" width="600" src="/img/posts/nuget-package-browsing/stat.png" /></a></div>
<p>It's very important to create a new instance of <code>HttpClient</code> for the each iteration: otherwise, the connection will be reused, and we will not get such a picture.</p>
<p>In the picture, we have a multimodal distribution with following levels:</p>
<ul>
<li><code>~1sec</code>:
<ul>
<li><code>HttpClient</code> sends a request;</li>
<li>request is finished without any problems;</li>
<li>we get the list of packages</li>
</ul>
</li>
<li><code>~125sec</code>:
<ul>
<li><code>HttpClient</code> sends a request;</li>
<li>the server terminates the request after 2 minutes;</li>
<li><code>HttpClient</code> retries the request;</li>
<li>we get the list of packages</li>
</ul>
</li>
<li><code>~250sec</code>:
<ul>
<li><code>HttpClient</code> sends a request;</li>
<li>the server terminates the request after 2 minutes;</li>
<li><code>HttpClient</code> retries the request;</li>
<li>the server terminates the second request after 2 minutes;</li>
<li><code>HttpClient</code> retries the request again;</li>
<li>we get the list of packages</li>
</ul>
</li>
<li><code>~375sec</code>:
<ul>
<li><code>HttpClient</code> sends a request;</li>
<li>the server terminates the request after 2 minutes;</li>
<li><code>HttpClient</code> retries the request;</li>
<li>the server terminates the second request after 2 minutes;</li>
<li><code>HttpClient</code> retries the request again;</li>
<li>the server terminates the third request after 2 minutes;</li>
<li>we <strong>don't</strong> get the list of packages (we get <code>System.Net.Http.WinHttpException: The connection with the server was terminated abnormally</code>)</li>
</ul>
</li>
</ul>
<p>A remark: on my machine, the first attempt uses <code>TLSv1.2</code>, the second attempt uses <code>TLSv1.1</code>, the third attempt uses <code>TLSv1</code>.
A screenshot from <a href="https://www.wireshark.org/">Wireshark</a> for the <code>~250sec</code> case:</p>
<div class="mx-auto"><a href="/img/posts/nuget-package-browsing/wireshark.png" target="_blank"><img class="mx-auto d-block" width="600" src="/img/posts/nuget-package-browsing/wireshark.png" /></a></div>
<p>We tried it on our local machines and double checked it on an Azure VM:</p>
<div class="mx-auto"><a href="/img/posts/nuget-package-browsing/azure.png" target="_blank"><img class="mx-auto d-block" width="600" src="/img/posts/nuget-package-browsing/azure.png" /></a></div>
<p>This problem affects (sometimes) different IDEs with NuGet Package Manager: it may take up to several minutes before it displays the search results.
That's how it looks in Visual Studio:</p>
<div class="mx-auto"><a href="/img/posts/nuget-package-browsing/vs.gif" target="_blank"><img class="mx-auto d-block" width="600" src="/img/posts/nuget-package-browsing/vs.gif" /></a></div>
<p>That's how it looks in Visual Studio for Mac:</p>
<div class="mx-auto"><a href="/img/posts/nuget-package-browsing/vs-for-mac.gif" target="_blank"><img class="mx-auto d-block" width="600" src="/img/posts/nuget-package-browsing/vs-for-mac.gif" /></a></div>
<p>It's hard to reproduce this issue in <a href="https://www.jetbrains.com/rider/">Rider</a> because we are <a href="https://aakinshin.net/blog/post/rider-nuget-search/">using a persistent local cache of search results</a>:</p>
<div class="mx-auto"><a href="/img/posts/nuget-package-browsing/rider.gif" target="_blank"><img class="mx-auto d-block" width="600" src="/img/posts/nuget-package-browsing/rider.gif" /></a></div>
<p>Currently, the problem is reproduced on <code>api-v2v3search-0.nuget.org</code> (<code>52.162.253.198</code>) and <code>api-v2v3search-1.nuget.org</code> (<code>13.84.46.37</code>).</p>
<p>Since it's a server-side problem and we can't fix it locally, we created an issue on GitHub: <a href="https://github.com/NuGet/Home/issues/6921">NuGet/Home#6921</a> (moved to <a href="https://github.com/NuGet/NuGetGallery/issues/5899">NuGet/NuGetGallery#5899</a>).</p>
<p><strong>Update.</strong>
A remark about the code snippet.
In the first version of the repro, I used a single <code>HttpClient</code> instance for all requests.
In this case, the first request fails in ~30% cases,
other requests are successful because the connection is already established.
From the practical point of view, it means that user can get hanged NuGet Package Manager in VS only once after startup.
However, in this case, it's hard to investigate the problem because it's very unstable.
Thus, the code snippet creates a new HttpClient instance each time on purpose.
So, it's very easy to reproduce the problem.</p>
<p><strong>Update 2018-05-11.</strong>
The issue is <a href="https://github.com/NuGet/NuGetGallery/issues/5899#issuecomment-388222254">fixed</a>.</p>

<!-- Share -->

Share:
<a href="https://twitter.com/intent/tweet?text=A story about slow NuGet package browsing&url=http://aakinshin.net/posts/nuget-package-browsing/&via=andrey_akinshin&related=andrey_akinshin" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fab fa-twitter fa-2x" title="Twitter"></i></a>
<a href="https://www.reddit.com/submit?url=http://aakinshin.net/posts/nuget-package-browsing/" target="_blank" title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a>
<a href="https://news.ycombinator.com/submitlink?u=http://aakinshin.net/posts/nuget-package-browsing/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a>
<a href="https://facebook.com/sharer.php?u=http://aakinshin.net/posts/nuget-package-browsing/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fab fa-facebook fa-2x"></i></a>
<a href="https://plus.google.com/share?url=http://aakinshin.net/posts/nuget-package-browsing/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fab fab fa-google-plus-g fa-2x"></i></a>
<a href="http://vk.com/share.php?url=http://aakinshin.net/posts/nuget-package-browsing/" target="_blank" title="Share on VKontakte"><i class="fab fa-vk fa-2x"></i></a>
<a href="https://getpocket.com/save?url=http://aakinshin.net/posts/nuget-package-browsing/&title=A story about slow NuGet package browsing" target="_blank" title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a>
<hr />

<!-- GitHub -->
<div>
  You can find source code of this post on GitHub:<br />
  <a href="https://github.com/AndreyAkinshin/aakinshin.net/blob/master/web/_posts/en/2018/nuget-package-browsing.md">https://github.com/AndreyAkinshin/aakinshin.net/blob/master/web/_posts/en/2018/nuget-package-browsing.md</a>
</div>

</div>
</div>
    </div>

    <footer class="blog-footer bg-light">
      <div class="container">
        <p>&copy; 2013–2019 Andrey Akinshin</p>
      </div>
    </footer>

    <!-- jQuery first (header), then popper, then Bootstrap JS. -->
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <!-- Other scripts -->
    <script src="/js/highlight.pack.js"></script>
    <script src="/js/anchor.min.js"></script>
    <script src="/js/custom.js"></script>
  </body>
</html>
