<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,NuGet,Rider"><title>A story about slow NuGet package browsing | Andrey Akinshin</title><meta name=description content="In Rider, we have integration tests which interact with api.nuget.org. Also, we have an internal service which monitors the performance of these tests. Two..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=https://aakinshin.net/sass/bootstrap-light.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=https://aakinshin.net/sass/bootstrap-dark.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.d7f6578e23ad3f0c33c589f9bcb34f995b45121f1f3ce888869c86b26826c845.js></script>
<script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.9e68d431432744c07a43381a8a833ffe0921cc0e006d84ad97f0b0d43c5cd82d.mjs></script>
<link href=https://aakinshin.net/css/fontawesome-all.min.178e95bba6ea2e9a90838cd646658f4bf6667a6ceaa057cb587bf7e6eb8412d3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.60773ab7266ecc6e9625306f57c0a82a219b011dc3ea2d83763d1ecdf11c86d2.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.7e186db80d8c431d196b3e0718afb0636b82a269a8c92521c11a55267a24fc27.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script src=/js/jquery-3.3.1.slim.min.js></script></head><body class="d-flex flex-column min-vh-100"><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>Blog</a><ul class="dropdown-menu bg-primary"><li><a class=dropdown-item href=https://aakinshin.net/posts/>All Posts</a></li><li><a class=dropdown-item href=https://aakinshin.net/tags/statistics/>Posts about Statistics</a></li><li></li><a class=dropdown-item href=https://aakinshin.net/tags/>All Tags</a></li></ul></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li></ul><ul class="navbar-nav ms-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>A story about slow NuGet package browsing</h1><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2018-05-08>May 8, 2018</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>
&nbsp;
<a href=https://aakinshin.net/tags/programming/ class="badge badge-info">Programming</a>
<a href=https://aakinshin.net/tags/nuget/ class="badge badge-info">NuGet</a>
<a href=https://aakinshin.net/tags/rider/ class="badge badge-info">Rider</a></span><br><br><p>In <a href=https://www.jetbrains.com/rider/>Rider</a>, we have integration tests which interact with <a href=https://api.nuget.org/>api.nuget.org</a>.
Also, we have an internal service which monitors the performance of these tests.
Two days ago, I noticed that some of these tests sometimes are running for too long.
For example, <code>nuget_NuGetTest_shouldUpgradeVersionForDotNetCore</code> usually takes around <code>10 sec</code>.
However, in some cases, it takes around <code>110 sec</code>, <code>210 sec</code>, or <code>310 sec</code>:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/perf-chart.png target=_blank alt=perf-chart><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/perf-chart.png></a></div></div><br><p>It looks very suspicious and increases the whole test suite duration.
Also, our dashboard with performance degradations contains only such tests
and some real degradations (which are introduced by the changes in our codebase) can go unnoticed.
So, my colleagues and I decided to investigate it.</p><p>First of all, we decided to look at the logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Information   GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0
</span></span><span class=line><span class=cl>Information An error was encountered when fetching
</span></span><span class=line><span class=cl>  &#39;GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0&#39;. The request will now be retried.
</span></span><span class=line><span class=cl>The HTTP request to &#39;GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0&#39;
</span></span><span class=line><span class=cl>  has timed out after 100000ms.
</span></span><span class=line><span class=cl>Information   GET https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0
</span></span><span class=line><span class=cl>Information   OK https://api-v2v3search-0.nuget.org/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0 1090ms
</span></span></code></pre></div><p>In this test, we are trying to get TOP 10 NuGet packages from nuget.org.
The code calls <a href=https://github.com/NuGet/NuGet.Client>NuGet.Client API</a>
which <a href=https://github.com/NuGet/NuGet.Client/blob/release-4.5.0-rtm/src/NuGet.Core/NuGet.Protocol/Resources/RawSearchResourceV3.cs#L40>constructs</a>
the <code>https://api-v2v3search-0.nuget.org/query?q=&skip=0&take=10&prerelease=false&semVerLevel=2.0.0</code> url
and send a HTTP request.
The server doesn&rsquo;t respond in <code>100'000ms</code>, NuGet terminates this request by timeout
and <a href=https://github.com/NuGet/NuGet.Client/blob/release-4.5.0-rtm/src/NuGet.Core/NuGet.Protocol/HttpSource/HttpRetryHandler.cs#L38>retries</a> it.</p><p>We decided to write a simple small repro based on <code>HttpClient</code> which reproduces the issue:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>100</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>client</span> <span class=p>=</span> <span class=k>new</span> <span class=n>HttpClient</span> <span class=p>{</span> <span class=n>Timeout</span> <span class=p>=</span> <span class=n>TimeSpan</span><span class=p>.</span><span class=n>FromSeconds</span><span class=p>(</span><span class=m>10000</span><span class=p>)</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=s>&#34;Request #&#34;</span> <span class=p>+</span> <span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>).</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;000&#34;</span><span class=p>)</span> <span class=p>+</span> <span class=s>&#34;: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>sw</span> <span class=p>=</span> <span class=n>Stopwatch</span><span class=p>.</span><span class=n>StartNew</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>r</span> <span class=p>=</span> <span class=k>await</span> <span class=n>client</span><span class=p>.</span><span class=n>GetAsync</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;https://api-v2v3search-0.nuget.org:443/query?q=&amp;skip=0&amp;take=10&amp;prerelease=false&amp;semVerLevel=2.0.0&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=s>&#34;OK&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=s>&#34;FAIL                 .&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>sw</span><span class=p>.</span><span class=n>Stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>$&#34; Time: {sw.Elapsed.TotalSeconds:0.000} sec&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Surprisingly, with <code>Timeout = TimeSpan.FromSeconds(10000)</code> almost all of the request are successful.
On Windows, it produces the following distribution:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/stat.png target=_blank alt=stat><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/stat.png></a></div></div><br><p>It&rsquo;s very important to create a new instance of <code>HttpClient</code> for the each iteration: otherwise, the connection will be reused, and we will not get such a picture.</p><p>In the picture, we have a multimodal distribution with following levels:</p><ul><li><code>~1sec</code>:<ul><li><code>HttpClient</code> sends a request;</li><li>request is finished without any problems;</li><li>we get the list of packages</li></ul></li><li><code>~125sec</code>:<ul><li><code>HttpClient</code> sends a request;</li><li>the server terminates the request after 2 minutes;</li><li><code>HttpClient</code> retries the request;</li><li>we get the list of packages</li></ul></li><li><code>~250sec</code>:<ul><li><code>HttpClient</code> sends a request;</li><li>the server terminates the request after 2 minutes;</li><li><code>HttpClient</code> retries the request;</li><li>the server terminates the second request after 2 minutes;</li><li><code>HttpClient</code> retries the request again;</li><li>we get the list of packages</li></ul></li><li><code>~375sec</code>:<ul><li><code>HttpClient</code> sends a request;</li><li>the server terminates the request after 2 minutes;</li><li><code>HttpClient</code> retries the request;</li><li>the server terminates the second request after 2 minutes;</li><li><code>HttpClient</code> retries the request again;</li><li>the server terminates the third request after 2 minutes;</li><li>we <strong>don&rsquo;t</strong> get the list of packages (we get <code>System.Net.Http.WinHttpException: The connection with the server was terminated abnormally</code>)</li></ul></li></ul><p>A remark: on my machine, the first attempt uses <code>TLSv1.2</code>, the second attempt uses <code>TLSv1.1</code>, the third attempt uses <code>TLSv1</code>.
A screenshot from <a href=https://www.wireshark.org/>Wireshark</a> for the <code>~250sec</code> case:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/wireshark.png target=_blank alt=wireshark><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/wireshark.png></a></div></div><br><p>We tried it on our local machines and double checked it on an Azure VM:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/azure.png target=_blank alt=azure><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/azure.png></a></div></div><br><p>This problem affects (sometimes) different IDEs with NuGet Package Manager: it may take up to several minutes before it displays the search results.
That&rsquo;s how it looks in Visual Studio:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/vs-for-mac.gif target=_blank alt=vs><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/vs-for-mac.gif></a></div></div><br><p>That&rsquo;s how it looks in Visual Studio for Mac:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/vs-for-mac.gif target=_blank alt=vs-for-mac><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/vs-for-mac.gif></a></div></div><br><p>It&rsquo;s hard to reproduce this issue in <a href=https://www.jetbrains.com/rider/>Rider</a> because we are <a href=https://aakinshin.net/blog/post/rider-nuget-search/>using a persistent local cache of search results</a>:</p><div class=row><div class=mx-auto><a href=/posts/nuget-package-browsing/img/rider.gif target=_blank alt=rider><img class="mx-auto d-block img-fluid" width=800 src=/posts/nuget-package-browsing/img/rider.gif></a></div></div><br><p>Currently, the problem is reproduced on <code>api-v2v3search-0.nuget.org</code> (<code>52.162.253.198</code>) and <code>api-v2v3search-1.nuget.org</code> (<code>13.84.46.37</code>).</p><p>Since it&rsquo;s a server-side problem and we can&rsquo;t fix it locally, we created an issue on GitHub: <a href=https://github.com/NuGet/Home/issues/6921>NuGet/Home#6921</a> (moved to <a href=https://github.com/NuGet/NuGetGallery/issues/5899>NuGet/NuGetGallery#5899</a>).</p><p><strong>Update.</strong>
A remark about the code snippet.
In the first version of the repro, I used a single <code>HttpClient</code> instance for all requests.
In this case, the first request fails in ~30% cases,
other requests are successful because the connection is already established.
From the practical point of view, it means that user can get hanged NuGet Package Manager in VS only once after startup.
However, in this case, it&rsquo;s hard to investigate the problem because it&rsquo;s very unstable.
Thus, the code snippet creates a new HttpClient instance each time on purpose.
So, it&rsquo;s very easy to reproduce the problem.</p><p><strong>Update 2018-05-11.</strong>
The issue is <a href=https://github.com/NuGet/NuGetGallery/issues/5899#issuecomment-388222254>fixed</a>.</p><br><br><div class=row><div class="justify-content-center share-block"><div class=share-title>Share:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fnuget-package-browsing%2f&title=A%20story%20about%20slow%20NuGet%20package%20browsing" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=A%20story%20about%20slow%20NuGet%20package%20browsing&url=https%3a%2f%2faakinshin.net%2fposts%2fnuget-package-browsing%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fnuget-package-browsing%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fnuget-package-browsing%2f&title=A%20story%20about%20slow%20NuGet%20package%20browsing" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class="blog-footer mt-auto"><div class=container><p>&copy; 2013&mdash;2022 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub></i></a>
<a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter></i></a>
<a href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS></i></a>
|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.c26550621ac13c2221d7f6f5e6fe862345d3919723c50d730893e3e4856ecf35.js></script>
<script src=/js/bootstrap.bundle.min.js></script>
<script src=/js/anchor.min.js></script>
<script src=https://aakinshin.net/js/custom.min.f6e5d13fe39f305056cc743ee4cb8d117c1aba26176e58c82c79a480d02fe4b7.js></script></body></html>