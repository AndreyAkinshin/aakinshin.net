<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,Rider,Bugs,Xplat,Mono,CoreCLR"><title>A bug story about named mutex on Mono | Andrey Akinshin</title><meta name=description content="When you write some multithreading magic on .NET, you can use a cool synchronization primitive called Mutex:
var mutex = new Mutex(false, &amp;#34;Global\\MyNa..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script src=https://cdn.tailwindcss.com/3.2.4></script>
<script>tailwind.config={darkMode:"class"}</script><style type=text/tailwindcss>
    @layer base {
       
      body {
        @apply bg-white dark:bg-zinc-800;
        @apply text-black dark:text-gray-400;
      }
      nav {
        @apply bg-sky-800 dark:bg-zinc-900;
      }
      a {
        @apply text-sky-600 dark:text-white;
        @apply no-underline;
      }
      .main-content a:not(.label-link) {
        @apply hover:underline;
      }
      hr {
        @apply h-px my-3 border-0 bg-gray-300 dark:bg-gray-600;
      }
      h1, h2, h3, h4, h5, h6 {
        @apply leading-tight;
      }
      h1, h2, h3 {
        @apply text-4xl py-4;
      }
      h4 {
        @apply text-3xl py-3;
      }
      h5, h6 {
        @apply text-2xl py-2;
      }
      table {
        @apply border self-center mx-auto;
      }
      th, td {
        @apply border p-2
      }
      blockquote {
        @apply border-l-8 border-gray-300 bg-gray-100 dark:border-zinc-600 dark:bg-zinc-700;
        @apply ml-4 my-4 px-4 py-2;
      }

       
      .main ul {
        @apply list-disc ml-10 my-2;
      }
      .main ol {
        @apply list-decimal ml-10 my-2;
      }
      .main p {
        @apply mb-3;
      }

       
      .label {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-gray-400 dark:border-gray-500;
      }
      .label-link {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-sky-600 dark:border-slate-400;
        @apply hover:bg-sky-200 dark:hover:bg-gray-500;
      }
      .nav-item {
        @apply text-white hover:bg-sky-700 dark:hover:bg-gray-700;
      }

       
      .paginator {
        @apply flex flex-wrap justify-center mb-4;
      }
      .paginator .page-item {
        @apply inline-flex border rounded px-3 py-1;
      }
      .paginator .page-item:not(.active):not(.disabled) {
        @apply border-gray-400 dark:border-gray-400;
      }
      .paginator .page-item.active {
        @apply border-sky-600 dark:border-white;
      }
      .paginator .page-item.disabled {
        @apply bg-gray-50 dark:bg-gray-500 dark:border-gray-400;
      }
      .paginator .page-item.disabled a {
        @apply text-gray-400 dark:text-gray-400;
      }

       
      .block-example {
        @apply my-4 pl-3;
        @apply border-l-8 border-gray-300 dark:border-zinc-600;
      }

       
      #about img {
        @apply inline-flex h-4;
      }

       
      .fai {
        @apply inline-flex h-[1.2em] w-[1.2em] pr-[0.4em] fill-current;
      }
      .fai-link {
        @apply hover:text-sky-400 dark:hover:text-blue-400;
      }
      .label-link .fai {
        @apply pl-1 pb-1 h-[1.5em] w-[1.5em];
      }

       
      .chroma {
        @apply my-5 overflow-y-scroll;
        @apply p-1 border rounded;
      }
    }
  </style><style>.block-example-title::before{counter-increment:example;content:"Example " counter(example)}body{counter-reset:example}code.has-jax{-webkit-font-smoothing:antialiased;background:inherit!important;border:none!important;font-size:100%}.anchorjs-link{transition:all .25s linear}*:hover>.anchorjs-link{margin-left:-1.125em!important}.chroma{background-color:#fff}.chroma .x{}.chroma .err{color:#a61717;background-color:#e3d2d2}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#000;font-weight:700}.chroma .kc{color:#000;font-weight:700}.chroma .kd{color:#000;font-weight:700}.chroma .kn{color:#000;font-weight:700}.chroma .kp{color:#000;font-weight:700}.chroma .kr{color:#000;font-weight:700}.chroma .kt{color:#458;font-weight:700}.chroma .n{}.chroma .na{color:teal}.chroma .nb{color:#0086b3}.chroma .bp{color:#999}.chroma .nc{color:#458;font-weight:700}.chroma .no{color:teal}.chroma .nd{color:#3c5d5d;font-weight:700}.chroma .ni{color:purple}.chroma .ne{color:#900;font-weight:700}.chroma .nf{color:#900;font-weight:700}.chroma .fm{}.chroma .nl{color:#900;font-weight:700}.chroma .nn{color:#555}.chroma .nx{}.chroma .py{}.chroma .nt{color:navy}.chroma .nv{color:teal}.chroma .vc{color:teal}.chroma .vg{color:teal}.chroma .vi{color:teal}.chroma .vm{}.chroma .l{}.chroma .ld{}.chroma .s{color:#d14}.chroma .sa{color:#d14}.chroma .sb{color:#d14}.chroma .sc{color:#d14}.chroma .dl{color:#d14}.chroma .sd{color:#d14}.chroma .s2{color:#d14}.chroma .se{color:#d14}.chroma .sh{color:#d14}.chroma .si{color:#d14}.chroma .sx{color:#d14}.chroma .sr{color:#009926}.chroma .s1{color:#d14}.chroma .ss{color:#990073}.chroma .m{color:#099}.chroma .mb{color:#099}.chroma .mf{color:#099}.chroma .mh{color:#099}.chroma .mi{color:#099}.chroma .il{color:#099}.chroma .mo{color:#099}.chroma .o{color:#000;font-weight:700}.chroma .ow{color:#000;font-weight:700}.chroma .p{}.chroma .c{color:#998;font-style:italic}.chroma .ch{color:#998;font-style:italic}.chroma .cm{color:#998;font-style:italic}.chroma .c1{color:#998;font-style:italic}.chroma .cs{color:#999;font-weight:700;font-style:italic}.chroma .cp{color:#999;font-weight:700;font-style:italic}.chroma .cpf{color:#999;font-weight:700;font-style:italic}.chroma .g{}.chroma .gd{color:#000;background-color:#fdd}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#a00}.chroma .gh{color:#999}.chroma .gi{color:#000;background-color:#dfd}.chroma .go{color:#888}.chroma .gp{color:#555}.chroma .gs{font-weight:700}.chroma .gu{color:#aaa}.chroma .gt{color:#a00}.chroma .gl{text-decoration:underline}.chroma .w{color:#bbb}.dark.chroma{color:#f8f8f2;background-color:#272822}.dark .chroma{color:#f8f8f2;background-color:#272822}.dark .chroma .x{}.dark .chroma .err{color:#960050;background-color:#1e0010}.dark .chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.dark .chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.dark .chroma .hl{display:block;width:100%;background-color:#ffc}.dark .chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.dark .chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.dark .chroma .k{color:#66d9ef}.dark .chroma .kc{color:#66d9ef}.dark .chroma .kd{color:#66d9ef}.dark .chroma .kn{color:#f92672}.dark .chroma .kp{color:#66d9ef}.dark .chroma .kr{color:#66d9ef}.dark .chroma .kt{color:#66d9ef}.dark .chroma .n{}.dark .chroma .na{color:#a6e22e}.dark .chroma .nb{}.dark .chroma .bp{}.dark .chroma .nc{color:#a6e22e}.dark .chroma .no{color:#66d9ef}.dark .chroma .nd{color:#a6e22e}.dark .chroma .ni{}.dark .chroma .ne{color:#a6e22e}.dark .chroma .nf{color:#a6e22e}.dark .chroma .fm{}.dark .chroma .nl{}.dark .chroma .nn{}.dark .chroma .nx{color:#a6e22e}.dark .chroma .py{}.dark .chroma .nt{color:#f92672}.dark .chroma .nv{}.dark .chroma .vc{}.dark .chroma .vg{}.dark .chroma .vi{}.dark .chroma .vm{}.dark .chroma .l{color:#ae81ff}.dark .chroma .ld{color:#e6db74}.dark .chroma .s{color:#e6db74}.dark .chroma .sa{color:#e6db74}.dark .chroma .sb{color:#e6db74}.dark .chroma .sc{color:#e6db74}.dark .chroma .dl{color:#e6db74}.dark .chroma .sd{color:#e6db74}.dark .chroma .s2{color:#e6db74}.dark .chroma .se{color:#ae81ff}.dark .chroma .sh{color:#e6db74}.dark .chroma .si{color:#e6db74}.dark .chroma .sx{color:#e6db74}.dark .chroma .sr{color:#e6db74}.dark .chroma .s1{color:#e6db74}.dark .chroma .ss{color:#e6db74}.dark .chroma .m{color:#ae81ff}.dark .chroma .mb{color:#ae81ff}.dark .chroma .mf{color:#ae81ff}.dark .chroma .mh{color:#ae81ff}.dark .chroma .mi{color:#ae81ff}.dark .chroma .il{color:#ae81ff}.dark .chroma .mo{color:#ae81ff}.dark .chroma .o{color:#f92672}.dark .chroma .ow{color:#f92672}.dark .chroma .p{}.dark .chroma .c{color:#75715e}.dark .chroma .ch{color:#75715e}.dark .chroma .cm{color:#75715e}.dark .chroma .c1{color:#75715e}.dark .chroma .cs{color:#75715e}.dark .chroma .cp{color:#75715e}.dark .chroma .cpf{color:#75715e}.dark .chroma .g{}.dark .chroma .gd{color:#f92672}.dark .chroma .ge{font-style:italic}.dark .chroma .gr{}.dark .chroma .gh{}.dark .chroma .gi{color:#a6e22e}.dark .chroma .go{}.dark .chroma .gp{}.dark .chroma .gs{font-weight:700}.dark .chroma .gu{color:#75715e}.dark .chroma .gt{}.dark .chroma .gl{}.dark .chroma .w{}</style><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-6 h-6"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>A bug story about named mutex on Mono</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai"><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2017-02-13>February 13, 2017</time><svg class="fai ml-3"><use xlink:href="/img/fa/all.svg#tag"/></svg>
<a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a>
<a class=label-link href=https://aakinshin.net/tags/bugs/>Bugs</a>
<a class=label-link href=https://aakinshin.net/tags/xplat/>Xplat</a>
<a class=label-link href=https://aakinshin.net/tags/mono/>Mono</a>
<a class=label-link href=https://aakinshin.net/tags/coreclr/>CoreCLR</a></div><br><div class=main-content><p>When you write some multithreading magic on .NET,
you can use a cool synchronization primitive called <a href="https://msdn.microsoft.com/en-us/library/system.threading.mutex(v=vs.110).aspx">Mutex</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>mutex</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Mutex</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=s>&#34;Global\\MyNamedMutex&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>You also can make it <a href="https://msdn.microsoft.com/en-us/library/f55ddskf(v=vs.110).aspx">named</a> (and share the mutex between processes)
which works perfectly on Windows:</p><div class=mx-auto><img class="mx-auto d-block" width=600 src=/img/posts/dotnet/namedmutex-on-mono/front.png></div><p>However, today the .NET Framework is cross-platform, so this code should work on any operation system.
What will happen if you use named mutex on Linux or MacOS with the help of Mono or CoreCLR?
Is it possible to create some tricky bug based on this case?
Of course, it does.
Today I want to tell you a story about such bug in <a href=https://www.jetbrains.com/rider/>Rider</a> which was a headache for several weeks.</p><h3 id=preamble>Preamble</h3><p>The easiest way to avoid troubles with named mutex is the following: don&rsquo;t use them at all.
However, it&rsquo;s not always possible because you may use 3rd party libraries that use named mutex.
Recently, we had such situation in Rider.
We used <a href=https://www.nuget.org/packages/NuGet.Client/3.4.3>NuGet.Client-3.4.3</a> which contained the <code>Settings.LoadDefaultSettings</code> method.
This method reads the content of the <a href=https://docs.microsoft.com/en-us/nuget/consume-packages/configuring-nuget-behavior>NuGet.Config</a> files with useful information about package feeds and some other NuGet settings.
Of course, other threads or processes can also write to this file (or read from it) at the same time.
So, we have to protect the access to <code>NuGet.Config</code> with a synchronization primitive.
NuGet.Client-3.4.3 uses a named mutex for this purpose.
It worked fine in Rider when you used it as a client application.
We also have many integration tests for the NuGet logic and run them on <a href=https://www.jetbrains.com/teamcity/>TeamCity</a> after each commit.
Sometimes, one of these tests was failing on Linux with the following exception:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>at</span> <span class=p>&lt;</span><span class=n>unknown</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=m>0xffffffff</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=p>(</span><span class=n>wrapper</span> <span class=n>managed</span><span class=p>-</span><span class=n>to</span><span class=p>-</span><span class=n>native</span><span class=p>)</span> <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>WaitHandle</span><span class=p>.</span><span class=n>WaitOne_internal</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>WaitHandle</span><span class=p>,</span><span class=n>intptr</span><span class=p>,</span><span class=kt>int</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0xffffffff</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>WaitHandle</span><span class=p>.</span><span class=n>WaitOne</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>TimeSpan</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0x0009b</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>WaitHandle</span><span class=p>.</span><span class=n>WaitOne</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>TimeSpan</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0x0001d</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>ExecuteSynchronizedCore</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Action</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0x00143</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>ExecuteSynchronized</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Action</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0x00019</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>..</span><span class=n>ctor</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0x0032b</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>ReadSettings</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0x0008a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>LoadUserSpecificSettings</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Collections</span><span class=p>.</span><span class=n>Generic</span><span class=p>.</span><span class=n>List</span><span class=err>`</span><span class=m>1</span><span class=p>&lt;</span><span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>&gt;,</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>IMachineWideSettings</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0x00418</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>LoadDefaultSettings</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>IMachineWideSettings</span><span class=p>,</span><span class=kt>bool</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0x0031e</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>LoadDefaultSettings</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>IMachineWideSettings</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0x00026</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Native</span> <span class=n>stacktrace</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>0</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0x000000010e7c976a</span> <span class=n>mono_handle_native_sigsegv</span> <span class=p>+</span> <span class=m>282</span>
</span></span><span class=line><span class=cl><span class=m>1</span>   <span class=n>libsystem_platform</span><span class=p>.</span><span class=n>dylib</span>            <span class=m>0x00007fff8e929f1a</span> <span class=n>_sigtramp</span> <span class=p>+</span> <span class=m>26</span>
</span></span><span class=line><span class=cl><span class=m>2</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0x000000010eab167f</span> <span class=n>tmp_dir</span> <span class=p>+</span> <span class=m>5471</span>
</span></span><span class=line><span class=cl><span class=m>3</span>   <span class=n>libsystem_c</span><span class=p>.</span><span class=n>dylib</span>                   <span class=m>0x00007fff86e909b3</span> <span class=n>abort</span> <span class=p>+</span> <span class=m>129</span>
</span></span><span class=line><span class=cl><span class=m>4</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0x000000010e96f7f3</span> <span class=n>monoeg_log_default_handler</span> <span class=p>+</span> <span class=m>211</span>
</span></span><span class=line><span class=cl><span class=m>5</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0x000000010e96f702</span> <span class=n>monoeg_g_logv</span> <span class=p>+</span> <span class=m>114</span>
</span></span><span class=line><span class=cl><span class=m>6</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0x000000010e96fb04</span> <span class=n>monoeg_assertion_message</span> <span class=p>+</span> <span class=m>356</span>
</span></span><span class=line><span class=cl><span class=m>7</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0x000000010e951740</span> <span class=n>own_if_owned</span> <span class=p>+</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>8</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0x000000010e8b8430</span> <span class=n>ves_icall_System_Threading_WaitHandle_WaitOne_internal</span> <span class=p>+</span> <span class=m>96</span>
</span></span><span class=line><span class=cl><span class=m>9</span>   <span class=p>???</span>                                 <span class=m>0x0000000113feccb4</span> <span class=m>0x0</span> <span class=p>+</span> <span class=m>4630432948</span>
</span></span><span class=line><span class=cl><span class=m>10</span>  <span class=n>mscorlib</span><span class=p>.</span><span class=n>dll</span><span class=p>.</span><span class=n>dylib</span>                  <span class=m>0x0000000110ac347e</span> <span class=n>System_Threading_WaitHandle_WaitOne_System_TimeSpan</span> <span class=p>+</span> <span class=m>30</span>
</span></span><span class=line><span class=cl><span class=m>11</span>  <span class=p>???</span>                                 <span class=m>0x00000001264dffda</span> <span class=m>0x0</span> <span class=p>+</span> <span class=m>4937613274</span>
</span></span></code></pre></div><p>It was awful because we couldn&rsquo;t obtain a permanent green build status.
Here is the <a href=https://github.com/NuGet/NuGet.Client/blob/58bd2dffe9cee8bf62b601f1610df4e9bbb91106/src/NuGet.Core/NuGet.Configuration/Settings/Settings.cs#L1134>origin</a> of this exception:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=c1>// Global: ensure mutex is honored across TS sessions </span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>mutex</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Mutex</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=s>$&#34;Global\\{EncryptionUtility.GenerateUniqueToken(fileName)}&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>owner</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// operations on NuGet.config should be very short lived</span>
</span></span><span class=line><span class=cl>        <span class=n>owner</span> <span class=p>=</span> <span class=n>mutex</span><span class=p>.</span><span class=n>WaitOne</span><span class=p>(</span><span class=n>TimeSpan</span><span class=p>.</span><span class=n>FromMinutes</span><span class=p>(</span><span class=m>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=c1>// decision here is to proceed even if we were not able to get mutex ownership</span>
</span></span><span class=line><span class=cl>        <span class=c1>// and let the potential IO errors bubble up. Reasoning is that failure to get</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ownership probably means faulty hardware and in this case it&#39;s better to report</span>
</span></span><span class=line><span class=cl>        <span class=c1>// back than hang</span>
</span></span><span class=line><span class=cl>        <span class=n>ioOperation</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>It seems that the culprit is a named mutex.</p><h3 id=investigation>Investigation</h3><p>We have a bug in NuGet here, so I created an issue: <a href=https://github.com/NuGet/Home/issues/2860>NuGet/Home#2860</a>.
This bug is based on a Mono bug with named mutex.
It was almost impossible to reproduce bug locally, so we started to try to create a minimal repro.
After a few weeks (yep, it wasn&rsquo;t easy), we finally did it (here is the bug report: <a href="https://bugzilla.xamarin.com/show_bug.cgi?id=41914">bugzilla.xamarin#41914</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>internal</span> <span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>a</span> <span class=p>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>var</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>100</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>Thread</span><span class=p>(</span><span class=n>Crasher</span><span class=p>).</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>ReadLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>void</span> <span class=n>Crasher</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>rnd</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>rnd</span><span class=p>.</span><span class=n>Next</span><span class=p>(</span><span class=m>100</span><span class=p>,</span> <span class=m>10000</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>mutex</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Mutex</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=s>&#34;Global\\TEST&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>owner</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>owner</span> <span class=p>=</span> <span class=n>mutex</span><span class=p>.</span><span class=n>WaitOne</span><span class=p>(</span><span class=n>TimeSpan</span><span class=p>.</span><span class=n>FromMinutes</span><span class=p>(</span><span class=m>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>finally</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>owner</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>mutex</span><span class=p>.</span><span class=n>ReleaseMutex</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;PING&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>rnd</span><span class=p>.</span><span class=n>Next</span><span class=p>(</span><span class=m>100</span><span class=p>,</span> <span class=m>10000</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Mono 4.4 crashed with the following output:</p><pre tabindex=0><code>namedmutex_create: error creating mutex handle
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
_wapi_handle_unref_full: Attempting to unref unused handle 0x4e0
PING
PING
namedmutex_create: error creating mutex handle
PING
PING
PING
PING
PING
PING
_wapi_handle_ref: Attempting to ref unused handle 0x4e3
* Assertion at ../../mono/utils/mono-os-mutex.h:135, condition `res != EINVAL&#39; not met

Stacktrace:

  at &lt;unknown&gt; &lt;0xffffffff&gt;
  at (wrapper managed-to-native) System.Threading.WaitHandle.WaitOne_internal (System.Threading.WaitHandle,intptr,int,bool) &lt;0x00073&gt;
  at System.Threading.WaitHandle.WaitOne (System.TimeSpan,bool) &lt;0x0009b&gt;
  at System.Threading.WaitHandle.WaitOne (System.TimeSpan) &lt;0x0001d&gt;
  at Crasher.Program.Crasher () &lt;0x000f0&gt;
  at System.Threading.ThreadHelper.ThreadStart_Context (object) &lt;0x0009a&gt;
  at System.Threading.ExecutionContext.RunInternal (System.Threading.ExecutionContext,System.Threading.ContextCallback,object,bool) &lt;0x001c6&gt;
  at System.Threading.ExecutionContext.Run (System.Threading.ExecutionContext,System.Threading.ContextCallback,object,bool) &lt;0x00020&gt;
  at System.Threading.ExecutionContext.Run (System.Threading.ExecutionContext,System.Threading.ContextCallback,object) &lt;0x00059&gt;
  at System.Threading.ThreadHelper.ThreadStart () &lt;0x0002e&gt;
  at (wrapper runtime-invoke) object.runtime_invoke_void__this__ (object,intptr,intptr,intptr) &lt;0x000e0&gt;

Native stacktrace:

        0   mono                                0x0000000103f9b0ca mono_handle_native_sigsegv + 271
        1   libsystem_platform.dylib            0x00007fff854c252a _sigtramp + 26
        2   mono                                0x00000001042036a4 tmp_dir + 5316
        3   libsystem_c.dylib                   0x00007fff935536e7 abort + 129
        4   mono                                0x000000010410d1f0 monoeg_g_log + 0
        5   mono                                0x000000010410d175 monoeg_g_logv + 83
        6   mono                                0x000000010410d31a monoeg_assertion_message + 143
        7   mono                                0x00000001040e453d _wapi_handle_timedwait_signal_handle + 1153
        8   mono                                0x00000001040f4aec wapi_WaitForSingleObjectEx + 606
        9   mono                                0x000000010406c01c mono_wait_uninterrupted + 130
        10  mono                                0x000000010406c1ff ves_icall_System_Threading_WaitHandle_WaitOne_internal + 73
        11  ???                                 0x0000000108130b54 0x0 + 4430433108
        12  mscorlib.dll.dylib                  0x00000001062ed7ae System_Threading_WaitHandle_WaitOne_System_TimeSpan + 30
        13  mscorlib.dll.dylib                  0x0000000106140e5b System_Threading_ThreadHelper_ThreadStart_Context_object + 155
        14  mscorlib.dll.dylib                  0x000000010613f331 System_Threading_ExecutionContext_Run_System_Threading_ExecutionContext_System_Threading_ContextCallback_object_bool + 33
        15  mono                                0x0000000103f04876 mono_jit_runtime_invoke + 1578
        16  mono                                0x0000000104090c23 mono_runtime_invoke + 130
        17  mono                                0x0000000104070409 start_wrapper + 424
        18  mono                                0x0000000104106cb1 inner_start_thread + 305
        19  libsystem_pthread.dylib             0x00007fff989c399d _pthread_body + 131
        20  libsystem_pthread.dylib             0x00007fff989c391a _pthread_body + 0
        21  libsystem_pthread.dylib             0x00007fff989c1351 thread_start + 13
</code></pre><p>So, we have troubles with both NuGet and Mono. Let&rsquo;s talk about each bug story.</p><h3 id=nuget>NuGet</h3><p>After a few weeks, we received a useful <a href=https://github.com/NuGet/Home/issues/2860#issuecomment-228174849>comment</a> by <a href=https://github.com/migueldeicaza>@migueldeicaza</a>:</p><blockquote><p>Named mutexes in Mono are process-local, they are not global like they are on Windows, so on the Mono case, it should use the same setup.
In the past, many years ago, mono supported global mutexes across a processes in the user namespace, but that support was very brittle and we removed the code some 4-5 years ago.</p></blockquote><p>The first idea was to avoid named mutexes.
It was implemented in <a href=https://github.com/NuGet/NuGet.Client/pull/720>NuGet/NuGet.Client#720</a>:
NuGet uses a named mutex only on Windows;
otherwise, it uses a process-wide global mutex.
However, it wasn&rsquo;t a perfect solution because our global mutex isn&rsquo;t shared between processes.
So, this commit was reverted and replaced by another approach:
<a href=https://github.com/NuGet/NuGet.Client/pull/725>NuGet/NuGet.Client#725: use a common locking mechanism (filestream) for all platforms while writing to settings file</a>.
A <a href=https://github.com/NuGet/NuGet.Client/pull/725#issue-163279546>comment</a> by <a href=https://github.com/rohit21agrawal>@rohit21agrawal</a>:</p><blockquote><p>This makes use of a synchronized version of file locking by acquiring a filestream handle on a lock file.
This approach works across all platforms and can do inter-process synchronization too.</p></blockquote><p>You can find the current implementation in the <a href=https://github.com/NuGet/NuGet.Client/blob/release-4.0.0-rc4/src/NuGet.Core/NuGet.Common/ConcurrencyUtilities.cs>NuGet.Client-4.0.0-rc4/ConcurrencyUtilities.cs</a> file.
Thus, the issue was resolved.
Due to the fact that we always try to use the latest published version of <a href=https://github.com/NuGet/NuGet.Client>NuGet.Client</a>,
our integration tests were fixed after a dependencies update.
However, there is still a bug in Mono which should also be fixed.</p><h3 id=mono>Mono</h3><p>As I mentioned before, we create an <a href="https://bugzilla.xamarin.com/show_bug.cgi?id=41914">issue</a> in mono bug tracking system (2016-06-16).
Over time (2016-09-14), it was fixed
(<a href=https://github.com/mono/mono/pull/3560>mono/mono#3560: [w32handle] Fix race condition when creating named mutex/event/semaphore</a>);
the most interesting changes are in the <a href=https://github.com/mono/mono/pull/3560/files#diff-2fa9d2ef24b4fd347ae97a87829a5f59>w32handle.c</a>.
So, we don&rsquo;t have the described race condition anymore.
However, mutexes in Mono are still process-local, you can&rsquo;t use it across processes.
Also, the MOBILE profile does not support named mutexes at all: <a href=https://github.com/mono/mono/blob/mono-4.6.2.16/mcs/class/corlib/System.Threading/Mutex.cs#L164>mono-4.6.2.16/Mutex.cs#L164</a>,
it just throws a <a href="https://msdn.microsoft.com/en-us/library/system.notsupportedexception(v=vs.110).aspx">NotSupportedException</a>
(see also <a href="https://bugzilla.xamarin.com/show_bug.cgi?id=26067">bugzilla.xamarin#26067</a>).
Be careful!</p><h3 id=coreclr>CoreCLR</h3><p>Mono is not the only xplat .NET runtime; we also have <a href=https://github.com/dotnet/coreclr>CoreCLR</a>!
How are things going with named mutexes on Linux and MacOS here?</p><p>Early versions of CoreCLR just throw a <a href="https://msdn.microsoft.com/en-us/library/system.platformnotsupportedexception(v=vs.110).aspx">PlatformNotSupportedException</a>
when users try to create named primitives (see <a href=https://github.com/dotnet/coreclr/pull/1387>coreclr#1387</a>, <a href=https://github.com/dotnet/corefx/pull/2796>corefx#2796</a>).
It wasn&rsquo;t great because there is a lot of legacy code which already uses named mutexes.
So, after some discussions
(e.g., see <a href=https://github.com/dotnet/coreclr/issues/1237>coreclr#1237</a>, <a href=https://github.com/dotnet/coreclr/issues/3422>coreclr#3422</a>),
the cross-process named mutexes were implemented.
Here is an awesome PR by <a href=https://github.com/kouvel>@kouvel</a>: <a href=https://github.com/dotnet/coreclr/pull/5030>coreclr#5030</a>.
A fragment from the issue summary:</p><blockquote><ul><li>On systems that support pthread process-shared robust recursive mutexes, they will be used</li><li>On other systems, file locks are used. File locks unfortunately don&rsquo;t have a timeout in the blocking wait call, and I didn&rsquo;t find any other sync object with a timed wait with the necessary properties, so polling is done for timed waits.</li></ul></blockquote><h3 id=conclusion>Conclusion</h3><p>When you write cross-platform .NET applications, think twice before using any OS-specific API.
Always check how it&rsquo;s implemented on your favorite runtime (Mono or CoreCLR).
Even if you are sure that <em>your code</em> is completely cross-platform,
you still should be ready that there are some xplat bugs in libraries which you are using
(especially if these libraries were originally written for Windows + the full .NET Framework).
Don&rsquo;t forget about unit and integration tests for multithreading code which execute your methods under load.
And make sure that your CI build server runs these tests on all target operation systems.</p><h3 id=links>Links</h3><ul><li><a href=https://github.com/NuGet/Home/issues/2860>NuGet/Home#2860: Bug in ExecuteSynchronizedCore on Linux/MacOS + Mono</a></li><li><a href=https://github.com/NuGet/NuGet.Client/pull/720>NuGet/NuGet.Client#720: make mono use global mutex instead of named mutex, like in CoreCLR</a></li><li><a href=https://github.com/NuGet/NuGet.Client/pull/725>NuGet/NuGet.Client#725: use a common locking mechanism (filestream) for all platforms while writing to settings file</a></li><li><a href=https://github.com/NuGet/NuGet.Client/blob/release-4.0.0-rc4/src/NuGet.Core/NuGet.Common/ConcurrencyUtilities.cs>NuGet.Client-4.0.0-rc4/ConcurrencyUtilities.cs</a></li><li><a href="https://bugzilla.xamarin.com/show_bug.cgi?id=26067">bugzilla.xamarin#26067: Mutexes cannot be created with names without resulting in error</a></li><li><a href="https://bugzilla.xamarin.com/show_bug.cgi?id=41914">bugzilla.xamarin#41914: Race condition in named mutex</a></li><li><a href=https://github.com/mono/mono/pull/3560>mono/mono#3560: [w32handle] Fix race condition when creating named mutex/event/semaphore</a></li><li><a href=https://github.com/mono/mono/pull/3828>mono/mono#3828: Change clock source to CLOCK_MONOTONIC in &lsquo;pthread_cond_timedwait&rsquo;</a></li><li><a href=https://github.com/dotnet/coreclr/issues/1237>dotnet/coreclr#1237: Implement named synchronization primitives to be system wide</a></li><li><a href=https://github.com/dotnet/coreclr/pull/1387>dotnet/coreclr#1387: Throw PlatformNotSupported for named sync primitives on Unix</a></li><li><a href=https://github.com/dotnet/coreclr/issues/3422>dotnet/coreclr#3422: Named mutex not supported on Unix</a></li><li><a href=https://github.com/dotnet/coreclr/pull/5030>dotnet/coreclr#5030: Add named mutex for cross-process synchronization</a></li><li><a href=https://github.com/dotnet/corefx/pull/2796>dotnet/corefx#2796: Throw PlatformNotSupportedException for named Semaphore on Unix</a></li></ul></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f&title=A%20bug%20story%20about%20named%20mutex%20on%20Mono" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=A%20bug%20story%20about%20named%20mutex%20on%20Mono&url=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f&title=A%20bug%20story%20about%20named%20mutex%20on%20Mono" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2022 Andrey Akinshin</span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>anchors.options={placement:"left",icon:"§"},anchors.add("h1"),anchors.add("h2"),anchors.add("h3")</script></body></html>