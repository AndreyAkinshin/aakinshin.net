<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.74.3"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content=".NET,Rider,Bugs,Xplat,Mono,CoreCLR"><title>A bug story about named mutex on Mono</title><link href=/css/lumen-bootstrap.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/slate-bootstrap.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><link href=/css/syntax-light.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/syntax-dark.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.26d61b7027fe55e642f0001cef94cb75b567d721086492aab6b4e32d9ee7811d.js></script><script type=module src=https://googlechromelabs.github.io/dark-mode-toggle/src/dark-mode-toggle.mjs></script><link href=https://aakinshin.net/css/fontawesome-all.min.e78467baec0179d7ccd2ef995e0c94f25b4a63a3191a93c3547e22bdf590ef5d.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.2a76db7cc14055b3bafacc363f453917ab54a818a7db2a0a9b2409c0f6bf07c5.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.6f1f668376d360a0b0c065e3ce0796e07b8acdcdfa7479a2c7ded481cb569765.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVB6MXSX32"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-ZVB6MXSX32');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-41419012-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-41419012-5');</script><script type=text/javascript>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym");ym(28700916,"init",{clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src=https://mc.yandex.ru/watch/28700916 style=position:absolute;left:-9999px alt></div></noscript><script src=/js/jquery-3.3.1.slim.min.js></script></head><body><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-lg navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/posts/>Posts</a></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/pages/prodotnetbenchmarking/>Pro .NET Benchmarking</a></li><li class=nav-item></li><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub style=color:#fff></i></a></li><li class=nav-item><a class=nav-link href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter style=color:#fff></i></a></li><li class=nav-item><a class=nav-link href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS style=color:#fff></i></a></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class=blog-post><h2 class=blog-post-title id=post-title>A bug story about named mutex on Mono</h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2017-02-13>February 13, 2017</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i><a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/rider/ class="badge badge-info">Rider</a>
<a href=https://aakinshin.net/tags/bugs/ class="badge badge-info">Bugs</a>
<a href=https://aakinshin.net/tags/xplat/ class="badge badge-info">Xplat</a>
<a href=https://aakinshin.net/tags/mono/ class="badge badge-info">Mono</a>
<a href=https://aakinshin.net/tags/coreclr/ class="badge badge-info">CoreCLR</a></span><br><br><p>When you write some multithreading magic on .NET,
you can use a cool synchronization primitive called <a href="https://msdn.microsoft.com/en-us/library/system.threading.mutex(v=vs.110).aspx">Mutex</a>:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=kt>var</span> <span class=n>mutex</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Mutex</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=s>&#34;Global\\MyNamedMutex&#34;</span><span class=p>);</span>
</code></pre></div><p>You also can make it <a href="https://msdn.microsoft.com/en-us/library/f55ddskf(v=vs.110).aspx">named</a> (and share the mutex between processes)
which works perfectly on Windows:</p><div class=mx-auto><img class="mx-auto d-block" width=600 src=/img/posts/dotnet/namedmutex-on-mono/front.png></div><p>However, today the .NET Framework is cross-platform, so this code should work on any operation system.
What will happen if you use named mutex on Linux or MacOS with the help of Mono or CoreCLR?
Is it possible to create some tricky bug based on this case?
Of course, it does.
Today I want to tell you a story about such bug in <a href=https://www.jetbrains.com/rider/>Rider</a> which was a headache for several weeks.</p><h3 id=preamble>Preamble</h3><p>The easiest way to avoid troubles with named mutex is the following: don&rsquo;t use them at all.
However, it&rsquo;s not always possible because you may use 3rd party libraries that use named mutex.
Recently, we had such situation in Rider.
We used <a href=https://www.nuget.org/packages/NuGet.Client/3.4.3>NuGet.Client-3.4.3</a> which contained the <code>Settings.LoadDefaultSettings</code> method.
This method reads the content of the <a href=https://docs.microsoft.com/en-us/nuget/consume-packages/configuring-nuget-behavior>NuGet.Config</a> files with useful information about package feeds and some other NuGet settings.
Of course, other threads or processes can also write to this file (or read from it) at the same time.
So, we have to protect the access to <code>NuGet.Config</code> with a synchronization primitive.
NuGet.Client-3.4.3 uses a named mutex for this purpose.
It worked fine in Rider when you used it as a client application.
We also have many integration tests for the NuGet logic and run them on <a href=https://www.jetbrains.com/teamcity/>TeamCity</a> after each commit.
Sometimes, one of these tests was failing on Linux with the following exception:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=n>at</span> <span class=p>&lt;</span><span class=n>unknown</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>xffffffff</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=p>(</span><span class=n>wrapper</span> <span class=n>managed</span><span class=p>-</span><span class=n>to</span><span class=p>-</span><span class=n>native</span><span class=p>)</span> <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>WaitHandle</span><span class=p>.</span><span class=n>WaitOne_internal</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>WaitHandle</span><span class=p>,</span><span class=n>intptr</span><span class=p>,</span><span class=kt>int</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>xffffffff</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>WaitHandle</span><span class=p>.</span><span class=n>WaitOne</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>TimeSpan</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>x0009b</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>Threading</span><span class=p>.</span><span class=n>WaitHandle</span><span class=p>.</span><span class=n>WaitOne</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>TimeSpan</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>x0001d</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>ExecuteSynchronizedCore</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Action</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>x00143</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>ExecuteSynchronized</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Action</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>x00019</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>..</span><span class=n>ctor</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>x0032b</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>ReadSettings</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>x0008a</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>LoadUserSpecificSettings</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=n>Collections</span><span class=p>.</span><span class=n>Generic</span><span class=p>.</span><span class=n>List</span><span class=err>`</span><span class=m>1</span><span class=p>&lt;</span><span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>&gt;,</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>IMachineWideSettings</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>x00418</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>LoadDefaultSettings</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>IMachineWideSettings</span><span class=p>,</span><span class=kt>bool</span><span class=p>,</span><span class=kt>bool</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>x0031e</span><span class=p>&gt;</span>
<span class=n>at</span> <span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>Settings</span><span class=p>.</span><span class=n>LoadDefaultSettings</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=kt>string</span><span class=p>,</span><span class=n>NuGet</span><span class=p>.</span><span class=n>Configuration</span><span class=p>.</span><span class=n>IMachineWideSettings</span><span class=p>)</span> <span class=p>&lt;</span><span class=m>0</span><span class=n>x00026</span><span class=p>&gt;</span>

<span class=n>Native</span> <span class=n>stacktrace</span><span class=p>:</span>

<span class=m>0</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0</span><span class=n>x000000010e7c976a</span> <span class=n>mono_handle_native_sigsegv</span> <span class=p>+</span> <span class=m>282</span>
<span class=m>1</span>   <span class=n>libsystem_platform</span><span class=p>.</span><span class=n>dylib</span>            <span class=m>0</span><span class=n>x00007fff8e929f1a</span> <span class=n>_sigtramp</span> <span class=p>+</span> <span class=m>26</span>
<span class=m>2</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0</span><span class=n>x000000010eab167f</span> <span class=n>tmp_dir</span> <span class=p>+</span> <span class=m>5471</span>
<span class=m>3</span>   <span class=n>libsystem_c</span><span class=p>.</span><span class=n>dylib</span>                   <span class=m>0</span><span class=n>x00007fff86e909b3</span> <span class=n>abort</span> <span class=p>+</span> <span class=m>129</span>
<span class=m>4</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0</span><span class=n>x000000010e96f7f3</span> <span class=n>monoeg_log_default_handler</span> <span class=p>+</span> <span class=m>211</span>
<span class=m>5</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0</span><span class=n>x000000010e96f702</span> <span class=n>monoeg_g_logv</span> <span class=p>+</span> <span class=m>114</span>
<span class=m>6</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0</span><span class=n>x000000010e96fb04</span> <span class=n>monoeg_assertion_message</span> <span class=p>+</span> <span class=m>356</span>
<span class=m>7</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0</span><span class=n>x000000010e951740</span> <span class=n>own_if_owned</span> <span class=p>+</span> <span class=m>0</span>
<span class=m>8</span>   <span class=n>mono</span><span class=p>-</span><span class=n>sgen</span>                           <span class=m>0</span><span class=n>x000000010e8b8430</span> <span class=n>ves_icall_System_Threading_WaitHandle_WaitOne_internal</span> <span class=p>+</span> <span class=m>96</span>
<span class=m>9</span>   <span class=p>???</span>                                 <span class=m>0</span><span class=n>x0000000113feccb4</span> <span class=m>0</span><span class=n>x0</span> <span class=p>+</span> <span class=m>4630432948</span>
<span class=m>10</span>  <span class=n>mscorlib</span><span class=p>.</span><span class=n>dll</span><span class=p>.</span><span class=n>dylib</span>                  <span class=m>0</span><span class=n>x0000000110ac347e</span> <span class=n>System_Threading_WaitHandle_WaitOne_System_TimeSpan</span> <span class=p>+</span> <span class=m>30</span>
<span class=m>11</span>  <span class=p>???</span>                                 <span class=m>0</span><span class=n>x00000001264dffda</span> <span class=m>0</span><span class=n>x0</span> <span class=p>+</span> <span class=m>4937613274</span>
</code></pre></div><p>It was awful because we couldn&rsquo;t obtain a permanent green build status.
Here is the <a href=https://github.com/NuGet/NuGet.Client/blob/58bd2dffe9cee8bf62b601f1610df4e9bbb91106/src/NuGet.Core/NuGet.Configuration/Settings/Settings.cs#L1134>origin</a> of this exception:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=c1>// Global: ensure mutex is honored across TS sessions 
</span><span class=c1></span><span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>mutex</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Mutex</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=s>$&#34;Global\\{EncryptionUtility.GenerateUniqueToken(fileName)}&#34;</span><span class=p>))</span>
<span class=p>{</span>
    <span class=kt>var</span> <span class=n>owner</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
    <span class=k>try</span>
    <span class=p>{</span>
        <span class=c1>// operations on NuGet.config should be very short lived
</span><span class=c1></span>        <span class=n>owner</span> <span class=p>=</span> <span class=n>mutex</span><span class=p>.</span><span class=n>WaitOne</span><span class=p>(</span><span class=n>TimeSpan</span><span class=p>.</span><span class=n>FromMinutes</span><span class=p>(</span><span class=m>1</span><span class=p>));</span>
        <span class=c1>// decision here is to proceed even if we were not able to get mutex ownership
</span><span class=c1></span>        <span class=c1>// and let the potential IO errors bubble up. Reasoning is that failure to get
</span><span class=c1></span>        <span class=c1>// ownership probably means faulty hardware and in this case it&#39;s better to report
</span><span class=c1></span>        <span class=c1>// back than hang
</span><span class=c1></span>        <span class=n>ioOperation</span><span class=p>();</span>
    <span class=p>}</span>
</code></pre></div><p>It seems that the culprit is a named mutex.</p><h3 id=investigation>Investigation</h3><p>We have a bug in NuGet here, so I created an issue: <a href=https://github.com/NuGet/Home/issues/2860>NuGet/Home#2860</a>.
This bug is based on a Mono bug with named mutex.
It was almost impossible to reproduce bug locally, so we started to try to create a minimal repro.
After a few weeks (yep, it wasn&rsquo;t easy), we finally did it (here is the bug report: <a href="https://bugzilla.xamarin.com/show_bug.cgi?id=41914">bugzilla.xamarin#41914</a>):</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>internal</span> <span class=k>class</span> <span class=nc>Program</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=kt>var</span> <span class=n>a</span> <span class=p>=</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>var</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>100</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
        <span class=p>{</span>
            <span class=k>new</span> <span class=n>Thread</span><span class=p>(</span><span class=n>Crasher</span><span class=p>).</span><span class=n>Start</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>a</span><span class=p>);</span>
        <span class=n>Console</span><span class=p>.</span><span class=n>ReadLine</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>private</span> <span class=k>static</span> <span class=k>void</span> <span class=n>Crasher</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=kt>var</span> <span class=n>rnd</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>
        <span class=k>while</span> <span class=p>(</span><span class=k>true</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>rnd</span><span class=p>.</span><span class=n>Next</span><span class=p>(</span><span class=m>100</span><span class=p>,</span> <span class=m>10000</span><span class=p>));</span>
            <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>mutex</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Mutex</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=s>&#34;Global\\TEST&#34;</span><span class=p>))</span>
            <span class=p>{</span>
                <span class=kt>var</span> <span class=n>owner</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
                <span class=k>try</span>
                <span class=p>{</span>
                    <span class=n>owner</span> <span class=p>=</span> <span class=n>mutex</span><span class=p>.</span><span class=n>WaitOne</span><span class=p>(</span><span class=n>TimeSpan</span><span class=p>.</span><span class=n>FromMinutes</span><span class=p>(</span><span class=m>1</span><span class=p>));</span>
                <span class=p>}</span>
                <span class=k>finally</span>
                <span class=p>{</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>owner</span><span class=p>)</span>
                    <span class=p>{</span>
                        <span class=n>mutex</span><span class=p>.</span><span class=n>ReleaseMutex</span><span class=p>();</span>
                    <span class=p>}</span>
                <span class=p>}</span>
                <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;PING&#34;</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>rnd</span><span class=p>.</span><span class=n>Next</span><span class=p>(</span><span class=m>100</span><span class=p>,</span> <span class=m>10000</span><span class=p>));</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Mono 4.4 crashed with the following output:</p><pre><code>namedmutex_create: error creating mutex handle
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
PING
_wapi_handle_unref_full: Attempting to unref unused handle 0x4e0
PING
PING
namedmutex_create: error creating mutex handle
PING
PING
PING
PING
PING
PING
_wapi_handle_ref: Attempting to ref unused handle 0x4e3
* Assertion at ../../mono/utils/mono-os-mutex.h:135, condition `res != EINVAL' not met

Stacktrace:

  at &lt;unknown&gt; &lt;0xffffffff&gt;
  at (wrapper managed-to-native) System.Threading.WaitHandle.WaitOne_internal (System.Threading.WaitHandle,intptr,int,bool) &lt;0x00073&gt;
  at System.Threading.WaitHandle.WaitOne (System.TimeSpan,bool) &lt;0x0009b&gt;
  at System.Threading.WaitHandle.WaitOne (System.TimeSpan) &lt;0x0001d&gt;
  at Crasher.Program.Crasher () &lt;0x000f0&gt;
  at System.Threading.ThreadHelper.ThreadStart_Context (object) &lt;0x0009a&gt;
  at System.Threading.ExecutionContext.RunInternal (System.Threading.ExecutionContext,System.Threading.ContextCallback,object,bool) &lt;0x001c6&gt;
  at System.Threading.ExecutionContext.Run (System.Threading.ExecutionContext,System.Threading.ContextCallback,object,bool) &lt;0x00020&gt;
  at System.Threading.ExecutionContext.Run (System.Threading.ExecutionContext,System.Threading.ContextCallback,object) &lt;0x00059&gt;
  at System.Threading.ThreadHelper.ThreadStart () &lt;0x0002e&gt;
  at (wrapper runtime-invoke) object.runtime_invoke_void__this__ (object,intptr,intptr,intptr) &lt;0x000e0&gt;

Native stacktrace:

        0   mono                                0x0000000103f9b0ca mono_handle_native_sigsegv + 271
        1   libsystem_platform.dylib            0x00007fff854c252a _sigtramp + 26
        2   mono                                0x00000001042036a4 tmp_dir + 5316
        3   libsystem_c.dylib                   0x00007fff935536e7 abort + 129
        4   mono                                0x000000010410d1f0 monoeg_g_log + 0
        5   mono                                0x000000010410d175 monoeg_g_logv + 83
        6   mono                                0x000000010410d31a monoeg_assertion_message + 143
        7   mono                                0x00000001040e453d _wapi_handle_timedwait_signal_handle + 1153
        8   mono                                0x00000001040f4aec wapi_WaitForSingleObjectEx + 606
        9   mono                                0x000000010406c01c mono_wait_uninterrupted + 130
        10  mono                                0x000000010406c1ff ves_icall_System_Threading_WaitHandle_WaitOne_internal + 73
        11  ???                                 0x0000000108130b54 0x0 + 4430433108
        12  mscorlib.dll.dylib                  0x00000001062ed7ae System_Threading_WaitHandle_WaitOne_System_TimeSpan + 30
        13  mscorlib.dll.dylib                  0x0000000106140e5b System_Threading_ThreadHelper_ThreadStart_Context_object + 155
        14  mscorlib.dll.dylib                  0x000000010613f331 System_Threading_ExecutionContext_Run_System_Threading_ExecutionContext_System_Threading_ContextCallback_object_bool + 33
        15  mono                                0x0000000103f04876 mono_jit_runtime_invoke + 1578
        16  mono                                0x0000000104090c23 mono_runtime_invoke + 130
        17  mono                                0x0000000104070409 start_wrapper + 424
        18  mono                                0x0000000104106cb1 inner_start_thread + 305
        19  libsystem_pthread.dylib             0x00007fff989c399d _pthread_body + 131
        20  libsystem_pthread.dylib             0x00007fff989c391a _pthread_body + 0
        21  libsystem_pthread.dylib             0x00007fff989c1351 thread_start + 13
</code></pre><p>So, we have troubles with both NuGet and Mono. Let&rsquo;s talk about each bug story.</p><h3 id=nuget>NuGet</h3><p>After a few weeks, we received a useful <a href=https://github.com/NuGet/Home/issues/2860#issuecomment-228174849>comment</a> by <a href=https://github.com/migueldeicaza>@migueldeicaza</a>:</p><blockquote><p>Named mutexes in Mono are process-local, they are not global like they are on Windows, so on the Mono case, it should use the same setup.
In the past, many years ago, mono supported global mutexes across a processes in the user namespace, but that support was very brittle and we removed the code some 4-5 years ago.</p></blockquote><p>The first idea was to avoid named mutexes.
It was implemented in <a href=https://github.com/NuGet/NuGet.Client/pull/720>NuGet/NuGet.Client#720</a>:
NuGet uses a named mutex only on Windows;
otherwise, it uses a process-wide global mutex.
However, it wasn&rsquo;t a perfect solution because our global mutex isn&rsquo;t shared between processes.
So, this commit was reverted and replaced by another approach:
<a href=https://github.com/NuGet/NuGet.Client/pull/725>NuGet/NuGet.Client#725: use a common locking mechanism (filestream) for all platforms while writing to settings file</a>.
A <a href=https://github.com/NuGet/NuGet.Client/pull/725#issue-163279546>comment</a> by <a href=https://github.com/rohit21agrawal>@rohit21agrawal</a>:</p><blockquote><p>This makes use of a synchronized version of file locking by acquiring a filestream handle on a lock file.
This approach works across all platforms and can do inter-process synchronization too.</p></blockquote><p>You can find the current implementation in the <a href=https://github.com/NuGet/NuGet.Client/blob/release-4.0.0-rc4/src/NuGet.Core/NuGet.Common/ConcurrencyUtilities.cs>NuGet.Client-4.0.0-rc4/ConcurrencyUtilities.cs</a> file.
Thus, the issue was resolved.
Due to the fact that we always try to use the latest published version of <a href=https://github.com/NuGet/NuGet.Client>NuGet.Client</a>,
our integration tests were fixed after a dependencies update.
However, there is still a bug in Mono which should also be fixed.</p><h3 id=mono>Mono</h3><p>As I mentioned before, we create an <a href="https://bugzilla.xamarin.com/show_bug.cgi?id=41914">issue</a> in mono bug tracking system (2016-06-16).
Over time (2016-09-14), it was fixed
(<a href=https://github.com/mono/mono/pull/3560>mono/mono#3560: [w32handle] Fix race condition when creating named mutex/event/semaphore</a>);
the most interesting changes are in the <a href=https://github.com/mono/mono/pull/3560/files#diff-2fa9d2ef24b4fd347ae97a87829a5f59>w32handle.c</a>.
So, we don&rsquo;t have the described race condition anymore.
However, mutexes in Mono are still process-local, you can&rsquo;t use it across processes.
Also, the MOBILE profile does not support named mutexes at all: <a href=https://github.com/mono/mono/blob/mono-4.6.2.16/mcs/class/corlib/System.Threading/Mutex.cs#L164>mono-4.6.2.16/Mutex.cs#L164</a>,
it just throws a <a href="https://msdn.microsoft.com/en-us/library/system.notsupportedexception(v=vs.110).aspx">NotSupportedException</a>
(see also <a href="https://bugzilla.xamarin.com/show_bug.cgi?id=26067">bugzilla.xamarin#26067</a>).
Be careful!</p><h3 id=coreclr>CoreCLR</h3><p>Mono is not the only xplat .NET runtime; we also have <a href=https://github.com/dotnet/coreclr>CoreCLR</a>!
How are things going with named mutexes on Linux and MacOS here?</p><p>Early versions of CoreCLR just throw a <a href="https://msdn.microsoft.com/en-us/library/system.platformnotsupportedexception(v=vs.110).aspx">PlatformNotSupportedException</a>
when users try to create named primitives (see <a href=https://github.com/dotnet/coreclr/pull/1387>coreclr#1387</a>, <a href=https://github.com/dotnet/corefx/pull/2796>corefx#2796</a>).
It wasn&rsquo;t great because there is a lot of legacy code which already uses named mutexes.
So, after some discussions
(e.g., see <a href=https://github.com/dotnet/coreclr/issues/1237>coreclr#1237</a>, <a href=https://github.com/dotnet/coreclr/issues/3422>coreclr#3422</a>),
the cross-process named mutexes were implemented.
Here is an awesome PR by <a href=https://github.com/kouvel>@kouvel</a>: <a href=https://github.com/dotnet/coreclr/pull/5030>coreclr#5030</a>.
A fragment from the issue summary:</p><blockquote><ul><li>On systems that support pthread process-shared robust recursive mutexes, they will be used</li><li>On other systems, file locks are used. File locks unfortunately don&rsquo;t have a timeout in the blocking wait call, and I didn&rsquo;t find any other sync object with a timed wait with the necessary properties, so polling is done for timed waits.</li></ul></blockquote><h3 id=conclusion>Conclusion</h3><p>When you write cross-platform .NET applications, think twice before using any OS-specific API.
Always check how it&rsquo;s implemented on your favorite runtime (Mono or CoreCLR).
Even if you are sure that <em>your code</em> is completely cross-platform,
you still should be ready that there are some xplat bugs in libraries which you are using
(especially if these libraries were originally written for Windows + the full .NET Framework).
Don&rsquo;t forget about unit and integration tests for multithreading code which execute your methods under load.
And make sure that your CI build server runs these tests on all target operation systems.</p><h3 id=links>Links</h3><ul><li><a href=https://github.com/NuGet/Home/issues/2860>NuGet/Home#2860: Bug in ExecuteSynchronizedCore on Linux/MacOS + Mono</a></li><li><a href=https://github.com/NuGet/NuGet.Client/pull/720>NuGet/NuGet.Client#720: make mono use global mutex instead of named mutex, like in CoreCLR</a></li><li><a href=https://github.com/NuGet/NuGet.Client/pull/725>NuGet/NuGet.Client#725: use a common locking mechanism (filestream) for all platforms while writing to settings file</a></li><li><a href=https://github.com/NuGet/NuGet.Client/blob/release-4.0.0-rc4/src/NuGet.Core/NuGet.Common/ConcurrencyUtilities.cs>NuGet.Client-4.0.0-rc4/ConcurrencyUtilities.cs</a></li><li><a href="https://bugzilla.xamarin.com/show_bug.cgi?id=26067">bugzilla.xamarin#26067: Mutexes cannot be created with names without resulting in error</a></li><li><a href="https://bugzilla.xamarin.com/show_bug.cgi?id=41914">bugzilla.xamarin#41914: Race condition in named mutex</a></li><li><a href=https://github.com/mono/mono/pull/3560>mono/mono#3560: [w32handle] Fix race condition when creating named mutex/event/semaphore</a></li><li><a href=https://github.com/mono/mono/pull/3828>mono/mono#3828: Change clock source to CLOCK_MONOTONIC in &lsquo;pthread_cond_timedwait&rsquo;</a></li><li><a href=https://github.com/dotnet/coreclr/issues/1237>dotnet/coreclr#1237: Implement named synchronization primitives to be system wide</a></li><li><a href=https://github.com/dotnet/coreclr/pull/1387>dotnet/coreclr#1387: Throw PlatformNotSupported for named sync primitives on Unix</a></li><li><a href=https://github.com/dotnet/coreclr/issues/3422>dotnet/coreclr#3422: Named mutex not supported on Unix</a></li><li><a href=https://github.com/dotnet/coreclr/pull/5030>dotnet/coreclr#5030: Add named mutex for cross-process synchronization</a></li><li><a href=https://github.com/dotnet/corefx/pull/2796>dotnet/corefx#2796: Throw PlatformNotSupportedException for named Semaphore on Unix</a></li></ul><br><br><div class=row><div class="mx-auto share-block"><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f&title=A%20bug%20story%20about%20named%20mutex%20on%20Mono" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=A%20bug%20story%20about%20named%20mutex%20on%20Mono&url=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://facebook.com/sharer.php?u=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f" rel=nofollow target=_blank title="Share on Facebook"><i class="fab fa-facebook fa-2x"></i></a></div><div class=share-button><a href="http://vk.com/share.php?url=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f" target=_blank title="Share on VKontakte"><i class="fab fa-vk fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fnamedmutex-on-mono%2f&title=A%20bug%20story%20about%20named%20mutex%20on%20Mono" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class=blog-footer><div class=container><p>&copy; 2013â€“2020 Andrey Akinshin | <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.ea4f51ac7f59c8e13f4df787df946eb1a447174ce2f1fc5349483de93a607ecb.js></script><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/anchor.min.js></script><script src=https://aakinshin.net/js/custom.min.11932490dde776463ed165b345838c701accc0cfdedf2e0868f13415f41f0872.js></script></body></html>