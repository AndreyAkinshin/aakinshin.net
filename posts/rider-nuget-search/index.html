<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,Rider,NuGet"><title>Why is NuGet search in Rider so fast? | Andrey Akinshin</title><meta name=description content="I&amp;rsquo;m the guy who develops the NuGet manager in Rider. It&amp;rsquo;s not ready yet, there are some bugs here and there, but it already works pretty well. The feature which I am most proud of is smart and fast search:
Today I want to share with you some tec..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.3746982c0855975eba2f485ef34018c70576ba5fe5ea2f4333daa717341a2831.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><div class="flex items-center justify-end justify-self-start"><div class="flex nav-item h-12 items-center" title='Support this blog'><a class="px-3 text-white" href=https://github.com/sponsors/AndreyAkinshin><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#heart"/></svg></a></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Why is NuGet search in Rider so fast?</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2017-02-08>February 8, 2017</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a>
<a class=label-link href=https://aakinshin.net/tags/nuget/>NuGet</a></div></div><br><div class=main-content><p>I&rsquo;m the guy who develops the NuGet manager in <a href=https://www.jetbrains.com/rider/>Rider</a>.
It&rsquo;s not ready yet, there are some bugs here and there, but it already works pretty well.
The feature which I am most proud of is smart and fast search:</p><div class=mx-auto><img class="mx-auto d-block" width=400 src=/img/posts/dotnet/rider-nuget-search/front.gif></div><p>Today I want to share with you some technical details about how it was implemented.</p><h3 id=caching>Caching</h3><p>In Rider, we are using <a href=https://www.nuget.org/packages/NuGet.Client/>NuGet.Client</a>.
It is a package with a set of APIs which allows doing all the basic NuGet operations: install, uninstall, restore, and search.
So, we can write something like this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>packageSearchResource</span><span class=p>.</span><span class=n>SearchAsync</span><span class=p>(</span><span class=n>searchTerm</span><span class=p>,</span> <span class=n>searchFilters</span><span class=p>,</span> <span class=n>skip</span><span class=p>,</span> <span class=n>take</span><span class=p>,</span> <span class=n>logger</span><span class=p>,</span> <span class=n>cancellationToken</span><span class=p>);</span>
</span></span></code></pre></div><p>and get a list of packages.
And this method is a bottleneck: searching for ten packages can take about 1 second for a remote feed.
If you want to form a big list of search results, you have to wait tens of seconds.</p><p>But we don&rsquo;t want to wait so long!
We want to look at the package list right now without any delays!
Our solution is the following: we create a local packages cache.
Of course, we don&rsquo;t want to use a lot of storage space.
So, we keep only a few important fields per package (like <code>Id</code>, <code>DownloadCount</code>, <code>IconUrl</code>, and so on).
When you search a NuGet package in Rider, you always search in our cache!
That is why you have zero-latency typing in the NuGet manager.</p><p>The NuGet package cache is persisted between Rider sessions.
Free bonus: if you launch Rider the second time, you already have a warmed cache.
The search will work as soon as the NuGet component was initialized without additional network requests.</p><h3 id=fetching>Fetching</h3><p>Ok, we can take data for search results from cache.
However, we still have to fetch the metadata of packages from a remote feed.
Let&rsquo;s introduce <em>fetchers</em>.
Each fetcher can handle fetch requests of a special kind to a specific feed
There are several interesting decisions about fetchers.</p><p>Rider allows searching the same package in several feeds.
Each feed can have own request latency.
We want to show top packages into the cache as soon as possible, and we can&rsquo;t allow feeds with low latency affect other feeds.
So, we have a separated set of fetchers per feed.</p><p>Next, we create two fetchers per feed: one for the general search and one for fetching metadata of a specific package.
It allows updating
information about installed packages (some of them can have updates) and
information about a selected package (which should be shown on the right panel)
in the background: it doesn&rsquo;t affect the search process.</p><p>Each search fetcher should fetch information about a big amount of packages.
By default, we are fetching the top 300 packages for each search term.
However, we can&rsquo;t ask for 300 packages at once: such request has huge latency.
It will take a lot of time before we can update our cache.
We also can&rsquo;t ask several times for one package one after the other
because each request (even we ask for only one package) also has some minimum latency.
Thus, we found a trade-off: we ask 30 times for a ten package batch.
Maybe there are better values, but it&rsquo;s a point for future investigation.
Current values work pretty well for now.</p><p>Thus, we have a queue of requests.
Internally, it&rsquo;s an asynchronous mergeable queue with priorities.
Each request has
<code>searchTerm</code> (what are we looking for),
<code>skip</code> (how many packages we should skip),
<code>take</code> (how many packages we should take),
and a few additional flags.
When you open the NuGet windows for the first time and the search box text is empty, the queue looks like this:</p><pre tabindex=0><code>&#39;&#39; Skip=0, Take=10
&#39;&#39; Skip=10, Take=10
&#39;&#39; Skip=20, Take=10
&#39;&#39; Skip=30, Take=10
&#39;&#39; Skip=40, Take=10
// ...
&#39;&#39; Skip=280, Take=10
&#39;&#39; Skip=290, Take=10
</code></pre><p>When you start to type some text, we add additional 30 requests per typed symbol.
So, if you open the NuGet window, type <code>"ab"</code>, press backspace, then the queue will look like this:</p><pre tabindex=0><code>&#39;&#39; Skip=0, Take=10
&#39;&#39; Skip=10, Take=10
&#39;&#39; Skip=20, Take=10
&#39;&#39; Skip=30, Take=10
&#39;&#39; Skip=40, Take=10
// ...
&#39;&#39; Skip=280, Take=10
&#39;&#39; Skip=290, Take=10
&#39;a&#39; Skip=0, Take=10
&#39;a&#39; Skip=10, Take=10
&#39;a&#39; Skip=20, Take=10
&#39;a&#39; Skip=30, Take=10
&#39;a&#39; Skip=40, Take=10
// ...
&#39;a&#39; Skip=280, Take=10
&#39;a&#39; Skip=290, Take=10
&#39;ab&#39; Skip=0, Take=10
&#39;ab&#39; Skip=10, Take=10
&#39;ab&#39; Skip=20, Take=10
&#39;ab&#39; Skip=30, Take=10
&#39;ab&#39; Skip=40, Take=10
// ...
&#39;ab&#39; Skip=280, Take=10
&#39;ab&#39; Skip=290, Take=10
&#39;a&#39; Skip=0, Take=10
&#39;a&#39; Skip=10, Take=10
&#39;a&#39; Skip=20, Take=10
&#39;a&#39; Skip=30, Take=10
&#39;a&#39; Skip=40, Take=10
// ...
&#39;a&#39; Skip=280, Take=10
&#39;a&#39; Skip=290, Take=10
</code></pre><p>The source code looks very simple: we just add additional requests and don&rsquo;t think about anything.
Internally, the queue is very smart; it can optimize this list before it starts to process the next request:</p><ol><li>The obsolete requests (<code>request.SearchTerm</code> ≠ <code>searchBox.Text</code>) will be deleted.</li><li>The same requests will be merged.</li><li>The rest of the requests will be sorted.</li><li>The first request in the result list will be handled.</li></ol><p>This queue has many additional nice features.
For example, each queue has its own local history.
If we already handled 30 requests for empty string,
next, we type <code>"a"</code>,
press backspace,
new 30 requests for the empty string will not be handled:
the queue remembers that we already fetched all this information in the recent past.
Of course, each item in the local history has a timestamp,
so you shouldn&rsquo;t be worried about obsolete results for cases
when remote packages were updated.</p><h3 id=smart-search>Smart search</h3><p>Ok, we fetched all the packages and put them into the cache.
Now you should filter all the cached packages and sort them according to the <code>searchTerm</code>.</p><p>Here we use our awesome <a href=https://www.jetbrains.com/resharper/>R#</a> search engine.
For example, if I want to find <code>"BenchmarkDotNet"</code>, I can type:</p><ul><li><code>"BnechmarkDotNet"</code>: typos will be detected</li><li><code>"BeDoNe"</code>: <a href=https://www.jetbrains.com/help/resharper/2016.3/Navigation_and_Search__CamelHumps.html>CamelHumps</a> is supported</li><li><code>"ИутсрьфклВщеТуе"</code> or <code>"BקמביצשרלDםאNקא"</code>: no problem if you forget to switch keyboard layout from Russian or Hebrew to English</li></ul><div class=mx-auto><img class="mx-auto d-block" width=400 src=/img/posts/dotnet/rider-nuget-search/search.gif></div><p>However, it&rsquo;s not enough for the NuGet search.
For example, if I type <code>"Json"</code>,
I probably want to find <a href=https://www.nuget.org/packages/Newtonsoft.Json/>Newtonsoft.Json</a>
instead of <a href=https://www.nuget.org/packages/JSON/>JSON</a>.
So, we have a set of heuristics which try to improve sorting order and put the package which you really want to install in the first place.
For example, for the situation described above, we always move &ldquo;popular&rdquo; packages on the top.
But which package is &ldquo;popular&rdquo;?
It&rsquo;s a very hard question especially when you are working with a custom set of packages which are matched to your <code>searchTerm</code>.
An obvious idea: we can sort all the matched packages by <code>DownloadCount</code> and take first <code>N</code>.
But how we should choose <code>N</code>?
It can not be a constant because our algorithm should work for sets of packages of any size (from 2 to thousands).
Popular packages could have
millions of downloads (like Newtonsoft.Json),
thousands of downloads or
even hundreds of downloads
(depends on particular set of packages).<br>You can come up with many different approaches, but here is our way:</p><ul><li>Build a sorted list of <code>DownloadCount</code> values</li><li>Peek top 20</li><li>Take the natural logarithm of each number</li><li>Find the largest gap between two neighboring packages,</li><li>All the packages before the gap are popular; they should be moved to the top of the list.</li></ul><p>This algorithm can look strange and illogical, but it works very well.
There is no perfect solution for such problems.
So, we just try to create heuristics which work fast and somehow produce the result which you want in each specific situation.</p><h3 id=future-development>Future development</h3><p>For now, Rider is in the EAP stage, and there are many features that we want to implement before release.
Some examples:</p><ul><li>Search by <a href=https://www.jetbrains.com/help/resharper/2016.3/Finding_Exploring_and_Installing_NuGet_Packages.html>type and namespace</a>.
It&rsquo;s hard to integrate such feature in our search engine, but we already have some cool ideas.</li><li>Feed statistics: we want to get the detailed diagnostics information about each feed.
It will allow to predict latency of each request and improve fetcher algorithms.</li><li>Handle &ldquo;slow&rdquo; feeds: some private feeds can spend about <em>2 minutes(!)</em> per one request (I don&rsquo;t have any idea why).
And it&rsquo;s a big problem, so we should handle such feeds in a special way.</li></ul><h3 id=conclusion>Conclusion</h3><p>In this post, I covered only a few things which are implemented in our NuGet search engine.
There are many technical details under the hood of the small NuGet search box.
And we try to improve it all the time and create the best NuGet manager in the world. =)
If you have any complaints or feature requests, you are welcome on our <a href="https://youtrack.jetbrains.com/issues?q=project:Rider%20">issue tracker</a>.
Your feedback is very important for us.</p></div><br><br><div class="flex flex-wrap justify-center items-center">The source code of this post and all the relevant files are&nbsp;<a href=https://github.com/AndreyAkinshin/aakinshin.net/tree/master/content/en/posts/2017/rider-nuget-search.md>available on GitHub</a>.</div><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2frider-nuget-search%2f&title=Why%20is%20NuGet%20search%20in%20Rider%20so%20fast%3f" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=Why%20is%20NuGet%20search%20in%20Rider%20so%20fast%3f&url=https%3a%2f%2faakinshin.net%2fposts%2frider-nuget-search%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2frider-nuget-search%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2frider-nuget-search%2f&title=Why%20is%20NuGet%20search%20in%20Rider%20so%20fast%3f" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li><li><a href=https://github.com/sponsors/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>Support this blog</title><use xlink:href="/img/fa/all.svg#heart"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>