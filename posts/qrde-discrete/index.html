<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Mathematics,Statistics,Research,Quantile,QRDE,Density estimation,Discrete distribution,Ties,Jittering"><title>Improving quantile-respectful density estimation for discrete distributions using jittering | Andrey Akinshin</title><meta name=description content="A discussion about quantile-respectful density estimation problems for distributions with discrete features"><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script src=https://cdn.tailwindcss.com/3.2.4></script>
<script>tailwind.config={darkMode:"class"}</script><style type=text/tailwindcss>
    @layer base {
       
      body {
        @apply bg-white dark:bg-zinc-800;
        @apply text-black dark:text-gray-400;
      }
      nav {
        @apply bg-sky-800 dark:bg-zinc-900;
      }
      a {
        @apply text-sky-600 dark:text-white;
        @apply no-underline;
      }
      .main-content a:not(.label-link) {
        @apply hover:underline;
      }
      hr {
        @apply h-px my-3 border-0 bg-gray-300 dark:bg-gray-600;
      }
      h1, h2, h3, h4, h5, h6 {
        @apply leading-tight;
      }
      h1, h2, h3 {
        @apply text-4xl py-4;
      }
      h4 {
        @apply text-3xl py-3;
      }
      h5, h6 {
        @apply text-2xl py-2;
      }
      table {
        @apply border self-center mx-auto;
      }
      th, td {
        @apply border p-2
      }
      blockquote {
        @apply border-l-8 border-gray-300 bg-gray-100 dark:border-zinc-600 dark:bg-zinc-700;
        @apply ml-4 my-4 px-4 py-2;
      }

       
      .main ul {
        @apply list-disc ml-10 my-2;
      }
      .main ol {
        @apply list-decimal ml-10 my-2;
      }
      .main p {
        @apply mb-3;
      }

       
      .label {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-gray-400 dark:border-gray-500;
      }
      .label-link {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-sky-600 dark:border-slate-400;
        @apply hover:bg-sky-200 dark:hover:bg-gray-500;
      }
      .nav-item {
        @apply text-white hover:bg-sky-700 dark:hover:bg-gray-700;
      }

       
      .paginator {
        @apply flex flex-wrap justify-center mb-4;
      }
      .paginator .page-item {
        @apply inline-flex border rounded px-3 py-1;
      }
      .paginator .page-item:not(.active):not(.disabled) {
        @apply border-gray-400 dark:border-gray-400;
      }
      .paginator .page-item.active {
        @apply border-sky-600 dark:border-white;
      }
      .paginator .page-item.disabled {
        @apply bg-gray-50 dark:bg-gray-500 dark:border-gray-400;
      }
      .paginator .page-item.disabled a {
        @apply text-gray-400 dark:text-gray-400;
      }

       
      .block-example {
        @apply my-4 pl-3;
        @apply border-l-8 border-gray-300 dark:border-zinc-600;
      }

       
      #about img {
        @apply inline-flex h-4;
      }

       
      .fai {
        @apply inline-flex h-[1.2em] w-[1.2em] pr-[0.4em] fill-current;
      }
      .fai-link {
        @apply hover:text-sky-400 dark:hover:text-blue-400;
      }
      .label-link .fai {
        @apply pl-1 pb-1 h-[1.5em] w-[1.5em];
      }

       
      .chroma {
        @apply my-5 overflow-y-scroll;
        @apply p-1 border rounded;
      }
    }
  </style><style>.block-example-title::before{counter-increment:example;content:"Example " counter(example)}body{counter-reset:example}code.has-jax{-webkit-font-smoothing:antialiased;background:inherit!important;border:none!important;font-size:100%}.anchorjs-link{transition:all .25s linear}*:hover>.anchorjs-link{margin-left:-1.125em!important}.chroma{background-color:#fff}.chroma .x{}.chroma .err{color:#a61717;background-color:#e3d2d2}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#000;font-weight:700}.chroma .kc{color:#000;font-weight:700}.chroma .kd{color:#000;font-weight:700}.chroma .kn{color:#000;font-weight:700}.chroma .kp{color:#000;font-weight:700}.chroma .kr{color:#000;font-weight:700}.chroma .kt{color:#458;font-weight:700}.chroma .n{}.chroma .na{color:teal}.chroma .nb{color:#0086b3}.chroma .bp{color:#999}.chroma .nc{color:#458;font-weight:700}.chroma .no{color:teal}.chroma .nd{color:#3c5d5d;font-weight:700}.chroma .ni{color:purple}.chroma .ne{color:#900;font-weight:700}.chroma .nf{color:#900;font-weight:700}.chroma .fm{}.chroma .nl{color:#900;font-weight:700}.chroma .nn{color:#555}.chroma .nx{}.chroma .py{}.chroma .nt{color:navy}.chroma .nv{color:teal}.chroma .vc{color:teal}.chroma .vg{color:teal}.chroma .vi{color:teal}.chroma .vm{}.chroma .l{}.chroma .ld{}.chroma .s{color:#d14}.chroma .sa{color:#d14}.chroma .sb{color:#d14}.chroma .sc{color:#d14}.chroma .dl{color:#d14}.chroma .sd{color:#d14}.chroma .s2{color:#d14}.chroma .se{color:#d14}.chroma .sh{color:#d14}.chroma .si{color:#d14}.chroma .sx{color:#d14}.chroma .sr{color:#009926}.chroma .s1{color:#d14}.chroma .ss{color:#990073}.chroma .m{color:#099}.chroma .mb{color:#099}.chroma .mf{color:#099}.chroma .mh{color:#099}.chroma .mi{color:#099}.chroma .il{color:#099}.chroma .mo{color:#099}.chroma .o{color:#000;font-weight:700}.chroma .ow{color:#000;font-weight:700}.chroma .p{}.chroma .c{color:#998;font-style:italic}.chroma .ch{color:#998;font-style:italic}.chroma .cm{color:#998;font-style:italic}.chroma .c1{color:#998;font-style:italic}.chroma .cs{color:#999;font-weight:700;font-style:italic}.chroma .cp{color:#999;font-weight:700;font-style:italic}.chroma .cpf{color:#999;font-weight:700;font-style:italic}.chroma .g{}.chroma .gd{color:#000;background-color:#fdd}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#a00}.chroma .gh{color:#999}.chroma .gi{color:#000;background-color:#dfd}.chroma .go{color:#888}.chroma .gp{color:#555}.chroma .gs{font-weight:700}.chroma .gu{color:#aaa}.chroma .gt{color:#a00}.chroma .gl{text-decoration:underline}.chroma .w{color:#bbb}.dark.chroma{color:#f8f8f2;background-color:#272822}.dark .chroma{color:#f8f8f2;background-color:#272822}.dark .chroma .x{}.dark .chroma .err{color:#960050;background-color:#1e0010}.dark .chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.dark .chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.dark .chroma .hl{display:block;width:100%;background-color:#ffc}.dark .chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.dark .chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.dark .chroma .k{color:#66d9ef}.dark .chroma .kc{color:#66d9ef}.dark .chroma .kd{color:#66d9ef}.dark .chroma .kn{color:#f92672}.dark .chroma .kp{color:#66d9ef}.dark .chroma .kr{color:#66d9ef}.dark .chroma .kt{color:#66d9ef}.dark .chroma .n{}.dark .chroma .na{color:#a6e22e}.dark .chroma .nb{}.dark .chroma .bp{}.dark .chroma .nc{color:#a6e22e}.dark .chroma .no{color:#66d9ef}.dark .chroma .nd{color:#a6e22e}.dark .chroma .ni{}.dark .chroma .ne{color:#a6e22e}.dark .chroma .nf{color:#a6e22e}.dark .chroma .fm{}.dark .chroma .nl{}.dark .chroma .nn{}.dark .chroma .nx{color:#a6e22e}.dark .chroma .py{}.dark .chroma .nt{color:#f92672}.dark .chroma .nv{}.dark .chroma .vc{}.dark .chroma .vg{}.dark .chroma .vi{}.dark .chroma .vm{}.dark .chroma .l{color:#ae81ff}.dark .chroma .ld{color:#e6db74}.dark .chroma .s{color:#e6db74}.dark .chroma .sa{color:#e6db74}.dark .chroma .sb{color:#e6db74}.dark .chroma .sc{color:#e6db74}.dark .chroma .dl{color:#e6db74}.dark .chroma .sd{color:#e6db74}.dark .chroma .s2{color:#e6db74}.dark .chroma .se{color:#ae81ff}.dark .chroma .sh{color:#e6db74}.dark .chroma .si{color:#e6db74}.dark .chroma .sx{color:#e6db74}.dark .chroma .sr{color:#e6db74}.dark .chroma .s1{color:#e6db74}.dark .chroma .ss{color:#e6db74}.dark .chroma .m{color:#ae81ff}.dark .chroma .mb{color:#ae81ff}.dark .chroma .mf{color:#ae81ff}.dark .chroma .mh{color:#ae81ff}.dark .chroma .mi{color:#ae81ff}.dark .chroma .il{color:#ae81ff}.dark .chroma .mo{color:#ae81ff}.dark .chroma .o{color:#f92672}.dark .chroma .ow{color:#f92672}.dark .chroma .p{}.dark .chroma .c{color:#75715e}.dark .chroma .ch{color:#75715e}.dark .chroma .cm{color:#75715e}.dark .chroma .c1{color:#75715e}.dark .chroma .cs{color:#75715e}.dark .chroma .cp{color:#75715e}.dark .chroma .cpf{color:#75715e}.dark .chroma .g{}.dark .chroma .gd{color:#f92672}.dark .chroma .ge{font-style:italic}.dark .chroma .gr{}.dark .chroma .gh{}.dark .chroma .gi{color:#a6e22e}.dark .chroma .go{}.dark .chroma .gp{}.dark .chroma .gs{font-weight:700}.dark .chroma .gu{color:#75715e}.dark .chroma .gt{}.dark .chroma .gl{}.dark .chroma .w{}</style><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-6 h-6"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Improving quantile-respectful density estimation for discrete distributions using jittering</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai"><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2021-04-27>April 27, 2021</time><svg class="fai ml-3"><use xlink:href="/img/fa/all.svg#tag"/></svg>
<a class=label-link href=https://aakinshin.net/tags/mathematics/>Mathematics</a>
<a class=label-link href=https://aakinshin.net/tags/statistics/>Statistics</a>
<a class=label-link href=https://aakinshin.net/tags/research/>Research</a>
<a class=label-link href=https://aakinshin.net/tags/quantile/>Quantile</a>
<a class=label-link href=https://aakinshin.net/tags/qrde/>QRDE</a>
<a class=label-link href=https://aakinshin.net/tags/density-estimation/>Density estimation</a>
<a class=label-link href=https://aakinshin.net/tags/discrete-distribution/>Discrete distribution</a>
<a class=label-link href=https://aakinshin.net/tags/ties/>Ties</a>
<a class=label-link href=https://aakinshin.net/tags/jittering/>Jittering</a></div><br><div class=main-content><p>In my previous posts, I already discussed the <a href=https://aakinshin.net/posts/kde-discrete/>problem</a> that arise
when we try to build the kernel density estimation (KDE) for samples with ties.
We may get such samples in real life from discrete or mixed discrete/continuous distributions.
Even if the original distribution is continuous,
we may observe artificial sample discretization due to a limited resolution of the measuring tool.
Such discretization may lead to inaccurate density plots due to undersmoothing.
The problem can be resolved using a nice technique called <em>jittering</em>.
I also discussed <a href=https://aakinshin.net/posts/discrete-sample-jittering/>how to apply</a> jittering to get a smoother version of KDE.</p><p>However, I&rsquo;m not a huge fan of KDE because of two reasons.
The first one is the <a href=https://aakinshin.net/posts/kde-bw/>problem of choosing a proper bandwidth value</a>.
With poorly chosen bandwidth, we can easily get oversmoothing or undersmoothing even without the discretization problem.
The second one is an inconsistency between the KDE-based probability density function and evaluated sample quantiles.
It could lead to inconsistent visualizations (e.g., KDE-based violin plots with non-KDE-based quantile values)
or it could introduce problems for algorithms that require density function and quantile values at the same time.
The inconsistency could be resolved using <a href=https://aakinshin.net/posts/qrde-hd/>quantile-respectful density estimation</a> (QRDE).
This kind of estimation builds the density function which matches the evaluated sample quantiles.
To get a smooth QRDE, we also need a smooth quantile estimator like the Harrell-Davis quantile estimator.
The robustness and componential efficiency of this approach can be improved using
the <a href=https://aakinshin.net/posts/winsorized-hdqe/>winsorized</a> and <a href=https://aakinshin.net/posts/trimmed-hdqe/>trimmed</a>
modifications of the Harrell-Davis quantile estimator
(which also have a <a href=https://aakinshin.net/posts/wthdqe-efficiency/>decent statistical efficiency level</a>).</p><p>Unfortunately, the straightforward QRDE calculation is not always applicable for samples with ties
because it&rsquo;s impossible to build an &ldquo;honest&rdquo; density function for discrete distributions
without using the Dirac delta function.
This is a severe problem for QRDE-based algorithms like the
<a href=https://aakinshin.net/posts/lowland-multimodality-detection/>lowland multimodality detection algorithm</a>.
In this post, I will show how jittering could help to solve this problem and get a smooth QRDE on samples with ties.</p><h3 id=continuous-distribution>Continuous distribution</h3><p>First of all, let&rsquo;s briefly discuss the connection between
the quantile function,
the cumulative distribution function (CDF),
and the probability density function (PDF)
for continuous distributions.
As a continuous distribution example, we take the Gumbel distribution.</p><p>Here is the Gumbel distribution quantile function <span class="math inline">\(Q_{\textrm{Gum}}(p)\)</span>:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/gumbel-quantile-light.png target=_blank alt=gumbel-quantile><img src=/posts/qrde-discrete/img/gumbel-quantile-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/gumbel-quantile-dark.png target=_blank alt=gumbel-quantile><img src=/posts/qrde-discrete/img/gumbel-quantile-dark.png width=800></a></div><p>For the Gumbel distribution, all the quantile values are different.
For any <span class="math inline">\(p_1 < p_2\)</span>, we can say that <span class="math inline">\(Q_{\textrm{Gum}}(p_1) < Q_{\textrm{Gum}}(p_2)\)</span>.
It means that the quantile function <span class="math inline">\(Q_{\textrm{Gum}}(p)\)</span> is strictly increasing
(it doesn&rsquo;t have any horizontal segments).</p><p>The CDF is an inversion of the quantile function.
Here is the CDF of the Gumbel distribution <span class="math inline">\(F_{\textrm{Gum}} = Q^{-1}_{\textrm{Gum}}\)</span>:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/gumbel-cdf-light.png target=_blank alt=gumbel-cdf><img src=/posts/qrde-discrete/img/gumbel-cdf-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/gumbel-cdf-dark.png target=_blank alt=gumbel-cdf><img src=/posts/qrde-discrete/img/gumbel-cdf-dark.png width=800></a></div><p>Since the quantile function doesn&rsquo;t have horizontal segments,
the CDF doesn&rsquo;t have vertical segments.
Thus, the CDF is also a continuous and strictly increasing function.</p><p>The PDF is the CDF derivative.
Here is the PDF of the gumbel distribution <span class="math inline">\(f_{\textrm{Gum}} = F'_{\textrm{Gum}}\)</span>:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/gumbel-pdf-light.png target=_blank alt=gumbel-pdf><img src=/posts/qrde-discrete/img/gumbel-pdf-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/gumbel-pdf-dark.png target=_blank alt=gumbel-pdf><img src=/posts/qrde-discrete/img/gumbel-pdf-dark.png width=800></a></div><p>Since the CDF is continuous, the PDF is also a continuous function that has finite values at each point.</p><h3 id=discrete-distribution>Discrete distribution</h3><p>As a discrete distribution example, we take the Poisson distribution (<span class="math inline">\(\lambda = 1\)</span>).
Here is the corresponding quantile function <span class="math inline">\(Q_{\textrm{Pois}}\)</span>:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/poisson-quantile-light.png target=_blank alt=poisson-quantile><img src=/posts/qrde-discrete/img/poisson-quantile-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/poisson-quantile-dark.png target=_blank alt=poisson-quantile><img src=/posts/qrde-discrete/img/poisson-quantile-dark.png width=800></a></div><p>Since the Poisson distribution contains only integer numbers, the values of <span class="math inline">\(Q_{\textrm{Pois}}\)</span> are also integers.
The quantile function consists of horizontal segments.
Now let&rsquo;s look at the CDF which is an inversion of the quantile function <span class="math inline">\(F_{\textrm{Pois}} = Q^{-1}_{\textrm{Pois}}\)</span>:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/poisson-cdf-light.png target=_blank alt=poisson-cdf><img src=/posts/qrde-discrete/img/poisson-cdf-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/poisson-cdf-dark.png target=_blank alt=poisson-cdf><img src=/posts/qrde-discrete/img/poisson-cdf-dark.png width=800></a></div><p>Since quantile function has horizontal segments,
the CDF is discontinuous at the integers.
For discrete distributions, we typically use the probability mass function (PMF) instead of the PDF.
Unlike the PDF, the PMF has a discrete argument, so it could be shown in the histogram form.
Here is the PMF of the Poisson distribution:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/poisson-pmf-light.png target=_blank alt=poisson-pmf><img src=/posts/qrde-discrete/img/poisson-pmf-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/poisson-pmf-dark.png target=_blank alt=poisson-pmf><img src=/posts/qrde-discrete/img/poisson-pmf-dark.png width=800></a></div><p>If we really want to build the PDF, it&rsquo;s possible with the help of the Dirac delta function:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/poisson-pdf-light.png target=_blank alt=poisson-pdf><img src=/posts/qrde-discrete/img/poisson-pdf-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/poisson-pdf-dark.png target=_blank alt=poisson-pdf><img src=/posts/qrde-discrete/img/poisson-pdf-dark.png width=800></a></div><p>Such PDF is not continuous.</p><h3 id=qrde>QRDE</h3><p>The detailed description and motivation of quantile-respectful density estimation (QRDE)
can be found <a href=https://aakinshin.net/posts/qrde-hd/>here</a>.
Let&rsquo;s briefly recall the main idea of this approach.
We are going to build a density estimation for a sample from an unknown distribution.
This estimation should be consistent with the evaluated quantile values.
To get a smooth estimation, we need a smooth quantile estimator like the Harrell-Davis quantile estimator
(or its <a href=https://aakinshin.net/posts/winsorized-hdqe/>winsorized</a> or <a href=https://aakinshin.net/posts/trimmed-hdqe/>trimmed</a> modifications).
Let <span class="math inline">\(Q(p)\)</span> be the target quantile estimator.
Now we are going to estimate <span class="math inline">\(k\)</span>-quantiles at the following positions:</p><p><span class="math display">\[p_i = i / k, \quad i = 0, \ldots, k.
\]</span></p><p>For example, if <span class="math inline">\(k = 100\)</span> (we work with percentile), here are the <span class="math inline">\(p_i\)</span> values:</p><p><span class="math display">\[p = \{ 0.00, 0.01, 0.02, \ldots, 0.99, 1.00 \}.
\]</span></p><p>The QRDE could be presented as a histogram.
For each <span class="math inline">\(i = 0, \ldots, k - 1\)</span>, we could introduce a histogram bar.
The left (<span class="math inline">\(x_l\)</span>) and the right (<span class="math inline">\(x_r\)</span>) borders of the bar are defined as quantile values:</p><p><span class="math display">\[x_l = Q(p_i), \quad x_r = Q(p_{i+1}).
\]</span></p><p>By definition, the total area of the density plot should equal <span class="math inline">\(1.0\)</span>.
If we split it into <span class="math inline">\(k\)</span> equal bars, the area of each bar should equal <span class="math inline">\(1.0 / k\)</span>.
Since we know the width and the area of each bar, it&rsquo;s easy to calculate its height:</p><p><span class="math display">\[h = \frac{1/k}{x_r - x_l}
\]</span></p><p>That&rsquo;s all: now we know the borders and the height of each bar.
Here is an example of the QRDE for a sample from the normal distribution
(with a rug plot at the bottom):</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/norm-qrde-light.png target=_blank alt=norm-qrde><img src=/posts/qrde-discrete/img/norm-qrde-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/norm-qrde-dark.png target=_blank alt=norm-qrde><img src=/posts/qrde-discrete/img/norm-qrde-dark.png width=800></a></div><h3 id=degenerate-qrde-on-discrete-distribution>Degenerate QRDE on discrete distribution</h3><p>Let&rsquo;s look one more time at the definition of the bar height:</p><p><span class="math display">\[h = \frac{1/k}{x_r - x_l} = \frac{1/k}{Q(p_{i+1}) - Q(p_i)}.
\]</span></p><p>Thus, if <span class="math inline">\(Q(p_i) = Q(p_{i+1})\)</span>, the histogram bar should be transformed to the Dirac delta function.
In practice, if the given sample contains tied values,
we may get a situation when <span class="math inline">\(|Q(p_i) - Q(p_{i+1})|\)</span> is extremely small,
which leads to an extremely huge <span class="math inline">\(h\)</span> value.
As a result, we get degenerated QRDE.
Let&rsquo;s check how it looks in real life.</p><p>Here is a sample from the Poisson distribution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>x1</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span> <span class=p>}</span>
</span></span></code></pre></div><p><code>x1</code> gives us the following QRDE plot:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/poisson-qrde1-light.png target=_blank alt=poisson-qrde1><img src=/posts/qrde-discrete/img/poisson-qrde1-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/poisson-qrde1-dark.png target=_blank alt=poisson-qrde1><img src=/posts/qrde-discrete/img/poisson-qrde1-dark.png width=800></a></div><p>Because of the ties, we have a high peak around zero (<span class="math inline">\(h \approx 30\)</span>).
Now let&rsquo;s add another zero value to <code>x1</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>x2</span> <span class=o>=</span> <span class=p>{</span><span class=nx>x1</span><span class=p>,</span> <span class=mi>0</span><span class=p>}</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span> <span class=p>}</span>
</span></span></code></pre></div><p>The situation became worse (<span class="math inline">\(h \approx 130\)</span>):</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/poisson-qrde2-light.png target=_blank alt=poisson-qrde2><img src=/posts/qrde-discrete/img/poisson-qrde2-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/poisson-qrde2-dark.png target=_blank alt=poisson-qrde2><img src=/posts/qrde-discrete/img/poisson-qrde2-dark.png width=800></a></div><p>Let&rsquo;s continue this procedure and add one more zero value:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>x3</span> <span class=o>=</span> <span class=p>{</span><span class=nx>x1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>}</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>}</span>
</span></span></code></pre></div><p>Now <span class="math inline">\(h \approx 600\)</span>, the QRDE plot became useless:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/poisson-qrde3-light.png target=_blank alt=poisson-qrde3><img src=/posts/qrde-discrete/img/poisson-qrde3-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/poisson-qrde3-dark.png target=_blank alt=poisson-qrde3><img src=/posts/qrde-discrete/img/poisson-qrde3-dark.png width=800></a></div><h3 id=improving-qrde-using-jittering>Improving QRDE using jittering</h3><p>To fix the problem, we can use the jittering technique based on the Beta function as described in the
<a href=https://aakinshin.net/posts/discrete-sample-jittering/>previous post</a>.
The suggested technique has the following advantages:</p><ul><li>It doesn&rsquo;t involve randomization, so it produces the same result each time.</li><li>It preserves sample range: the minimum and the maximum value will not be corrupted.</li><li>It ensures high density near the original values</li></ul><p>If we apply jittering (based on the Beta function) to <code>x3</code>, we get the following sample:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>x4</span> <span class=o>=</span> <span class=nx>jittering</span><span class=p>(</span><span class=nx>x3</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mf>0.00000000</span><span class=p>,</span> <span class=mf>0.02957037</span><span class=p>,</span> <span class=mf>0.06495575</span><span class=p>,</span> <span class=mf>0.10929974</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>  <span class=mf>0.16944062</span><span class=p>,</span> <span class=mf>0.26618052</span><span class=p>,</span> <span class=mf>0.58622006</span><span class=p>,</span> <span class=mf>0.69481940</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=mf>0.77159043</span><span class=p>,</span> <span class=mf>0.83508358</span><span class=p>,</span> <span class=mf>0.89198685</span><span class=p>,</span> <span class=mf>0.94597932</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=mf>1.00000000</span><span class=p>,</span> <span class=mf>1.05771731</span><span class=p>,</span> <span class=mf>1.12709591</span><span class=p>,</span> <span class=mf>1.89371011</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=mf>2.00000000</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This gives a reasonable QRDE plot:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/qrde-discrete/img/poisson-qrde4-light.png target=_blank alt=poisson-qrde4><img src=/posts/qrde-discrete/img/poisson-qrde4-light.png width=800></a>
<a class="img-dark hidden" href=/posts/qrde-discrete/img/poisson-qrde4-dark.png target=_blank alt=poisson-qrde4><img src=/posts/qrde-discrete/img/poisson-qrde4-dark.png width=800></a></div></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fqrde-discrete%2f&title=Improving%20quantile-respectful%20density%20estimation%20for%20discrete%20distributions%20using%20jittering" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=Improving%20quantile-respectful%20density%20estimation%20for%20discrete%20distributions%20using%20jittering&url=https%3a%2f%2faakinshin.net%2fposts%2fqrde-discrete%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fqrde-discrete%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fqrde-discrete%2f&title=Improving%20quantile-respectful%20density%20estimation%20for%20discrete%20distributions%20using%20jittering" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2022 Andrey Akinshin</span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>anchors.options={placement:"left",icon:"§"},anchors.add("h1"),anchors.add("h2"),anchors.add("h3")</script><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>