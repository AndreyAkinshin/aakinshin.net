<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,C#,BenchmarkDotNet,Benchmarking,disassembly"><title>Cross-runtime .NET disassembly with BenchmarkDotNet | Andrey Akinshin</title><meta name=description content="BenchmarkDotNet is a cool tool for benchmarking. It has a lot of useful features that help you with performance investigations. However, you can use these ..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.13341ac97e21004cde7f286e6b392a1234aa8b2656426c008cfd9f98cd200dd1.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Cross-runtime .NET disassembly with BenchmarkDotNet</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2018-04-10>April 10, 2018</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarkdotnet/>BenchmarkDotNet</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarking/>Benchmarking</a>
<a class=label-link href=https://aakinshin.net/tags/disassembly/>disassembly</a></div></div><br><div class=main-content><p><a href=https://github.com/dotnet/BenchmarkDotNet>BenchmarkDotNet</a> is a cool tool for benchmarking.
It has a lot of useful features that help you with performance investigations.
However, you can use these features even if you are not actually going to benchmark something.
One of these features is <code>DisassemblyDiagnoser</code>.
It shows you a disassembly listing of your code for all required runtimes.
In this post, I will show you how to get disassembly listing for .NET Framework, .NET Core, and Mono with one click!
You can do it with a very small code snippet like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[DryCoreJob, DryMonoJob, DryClrJob(Platform.X86)]</span>
</span></span><span class=line><span class=cl><span class=na>[DisassemblyDiagnoser]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>IntroDisasm</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>double</span> <span class=n>Sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>res</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>64</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=p>+=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>That&rsquo;s all!
<code>[CoreJob]</code>, <code>[MonoJob]</code>, <code>[ClrJob]</code> mean that we are going to run it on .NET Core, Mono, and .NET Framework.
<code>[Dry]</code> means that we are going to run only single &ldquo;dry&rdquo; iteration for each runtime without actual measurements.
<code>[DisassemblyDiagnoser]</code> means that we want to get assembly listings in the <code>BenchmarkDotNet.Artifacts</code> folder.</p><p>Some important remarks:</p><ul><li>This benchmark requires .NET Framework, so it works only on Windows.</li><li>We use <code>Platform.X86</code> for <code>[ClrJob]</code> because we want to see a difference in assembly listing.
The modern versions of .NET Framework and .NET Core use the same JIT engine on <code>x64</code>.
So let&rsquo;s compare <code>LegacyJIT-x86</code> from .NET Framework and <code>RyuJIT-x64</code> from .NET Core.</li><li>To get assembly listings for Mono on Windows, you need <code>as</code> and <code>x86_64-w64-mingw32-objdump.exe</code> tools.
You can read more about it in the <a href=http://benchmarkdotnet.org/Configs/Diagnosers.htm#disassembly-diagnoser-for-mono-on-windows>documentation</a>.</li></ul><p>The source code (the benchmark + the csproj file) is available here: <a href=https://gist.github.com/AndreyAkinshin/62d2f4c3e67acde844f569fbf5846570>https://gist.github.com/AndreyAkinshin/62d2f4c3e67acde844f569fbf5846570</a>
You can try it on your machine with the help of the following script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl>git clone https://gist.github.com/62d2f4c3e67acde844f569fbf5846570.git DisasmDemo
</span></span><span class=line><span class=cl><span class=k>cd</span> DisasmDemo
</span></span><span class=line><span class=cl>dotnet run -f netcoreapp2.0 -c Release
</span></span><span class=line><span class=cl><span class=k>start</span> BenchmarkDotNet.Artifacts\results\IntroDisasm-disassembly-report.html
</span></span></code></pre></div><p>As a result, you will see an html page which contains disassembly listings for all runtimes:</p><div class=row><div class=mx-auto><a href=/posts/dotnet-crossruntime-disasm/img/disasm.png target=_blank alt=disasm><img class="mx-auto d-block img-fluid" width=800 src=/posts/dotnet-crossruntime-disasm/img/disasm.png></a></div></div><br><p>The raw code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=c>; .NET Framework 4.7 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.7.2633.0
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=err>07404098</span> <span class=nf>DisasmDemo.IntroDisasm.Sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=err>0740409</span><span class=nf>c</span> <span class=no>d9ee</span>            <span class=no>fldz</span>
</span></span><span class=line><span class=cl><span class=err>0740409</span><span class=nf>e</span> <span class=mi>33</span><span class=no>c0</span>            <span class=no>xor</span>     <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>074040</span><span class=nf>a0</span> <span class=mi>8945</span><span class=no>fc</span>          <span class=no>mov</span>     <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-4</span><span class=p>],</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>074040</span><span class=nf>a3</span> <span class=no>db45fc</span>          <span class=no>fild</span>    <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>074040</span><span class=nf>a6</span> <span class=no>dec1</span>            <span class=no>faddp</span>   <span class=no>st</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=no>st</span>
</span></span><span class=line><span class=cl><span class=err>074040</span><span class=nf>a8</span> <span class=mi>40</span>              <span class=no>inc</span>     <span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>074040</span><span class=nf>a9</span> <span class=mi>83</span><span class=no>f840</span>          <span class=no>cmp</span>     <span class=no>eax</span><span class=p>,</span><span class=mi>40</span><span class=no>h</span>
</span></span><span class=line><span class=cl><span class=err>074040</span><span class=nf>ac</span> <span class=mi>7</span><span class=no>cf2</span>            <span class=no>jl</span>      <span class=mi>074040</span><span class=no>a0</span>
</span></span><span class=line><span class=cl><span class=err>074040</span><span class=nf>ae</span> <span class=mi>8</span><span class=no>be5</span>            <span class=no>mov</span>     <span class=no>esp</span><span class=p>,</span><span class=no>ebp</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=c>; .NET Core 2.0.6 (CoreCLR 4.6.26212.01, CoreFX 4.6.26212.01), 64bit RyuJIT
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>b0</span> <span class=no>DisasmDemo.IntroDisasm.Sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>b3</span> <span class=no>c4e17957c0</span>      <span class=no>vxorpd</span>  <span class=no>xmm0</span><span class=p>,</span><span class=no>xmm0</span><span class=p>,</span><span class=no>xmm0</span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>b8</span> <span class=mi>33</span><span class=no>c0</span>            <span class=no>xor</span>     <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>ba</span> <span class=no>c4e17057c9</span>      <span class=no>vxorps</span>  <span class=no>xmm1</span><span class=p>,</span><span class=no>xmm1</span><span class=p>,</span><span class=no>xmm1</span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>bf</span> <span class=no>c4e1732ac8</span>      <span class=no>vcvtsi2sd</span> <span class=no>xmm1</span><span class=p>,</span><span class=no>xmm1</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>c4</span> <span class=no>c4e17b58c1</span>      <span class=no>vaddsd</span>  <span class=no>xmm0</span><span class=p>,</span><span class=no>xmm0</span><span class=p>,</span><span class=no>xmm1</span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>c9</span> <span class=no>ffc0</span>            <span class=no>inc</span>     <span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>cb</span> <span class=mi>83</span><span class=no>f840</span>          <span class=no>cmp</span>     <span class=no>eax</span><span class=p>,</span><span class=mi>40</span><span class=no>h</span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>ce</span> <span class=mi>7</span><span class=no>cea</span>            <span class=no>jl</span>      <span class=mi>00007</span><span class=no>fff</span> <span class=mi>196433</span><span class=no>ba</span>
</span></span><span class=line><span class=cl><span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>d0</span> <span class=no>c3</span>              <span class=no>ret</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=c>; Mono 5.4.0 (Visual Studio), 64bit
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl> <span class=nf>Sum</span>
</span></span><span class=line><span class=cl><span class=nf>sub</span>    <span class=no>$0x18</span><span class=p>,</span><span class=nv>%rsp</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span>    <span class=nv>%rsi</span><span class=p>,(</span><span class=nv>%rsp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>xorpd</span>  <span class=nv>%xmm0</span><span class=p>,</span><span class=nv>%xmm0</span>
</span></span><span class=line><span class=cl><span class=nf>movsd</span>  <span class=nv>%xmm0</span><span class=p>,</span><span class=mi>0x8</span><span class=p>(</span><span class=nv>%rsp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>xor</span>    <span class=nv>%esi</span><span class=p>,</span><span class=nv>%esi</span>
</span></span><span class=line><span class=cl><span class=nf>jmp</span>    <span class=mi>2</span><span class=no>e</span> 
</span></span><span class=line><span class=cl><span class=no>xchg</span>   <span class=nv>%ax</span><span class=p>,</span><span class=nv>%ax</span>
</span></span><span class=line><span class=cl><span class=nf>movsd</span>  <span class=mi>0x8</span><span class=p>(</span><span class=nv>%rsp</span><span class=p>),</span><span class=nv>%xmm0</span>
</span></span><span class=line><span class=cl><span class=nf>cvtsi2sd</span> <span class=nv>%esi</span><span class=p>,</span><span class=nv>%xmm1</span>
</span></span><span class=line><span class=cl><span class=nf>addsd</span>  <span class=nv>%xmm1</span><span class=p>,</span><span class=nv>%xmm0</span>
</span></span><span class=line><span class=cl><span class=nf>movsd</span>  <span class=nv>%xmm0</span><span class=p>,</span><span class=mi>0x8</span><span class=p>(</span><span class=nv>%rsp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>inc</span>    <span class=nv>%esi</span>
</span></span><span class=line><span class=cl><span class=nf>cmp</span>    <span class=no>$0x40</span><span class=p>,</span><span class=nv>%esi</span>
</span></span><span class=line><span class=cl><span class=nf>jl</span>     <span class=mi>18</span> 
</span></span><span class=line><span class=cl><span class=no>movsd</span>  <span class=mi>0x8</span><span class=p>(</span><span class=nv>%rsp</span><span class=p>),</span><span class=nv>%xmm0</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span>    <span class=p>(</span><span class=nv>%rsp</span><span class=p>),</span><span class=nv>%rsi</span>
</span></span><span class=line><span class=cl><span class=nf>add</span>    <span class=no>$0x18</span><span class=p>,</span><span class=nv>%rsp</span>
</span></span><span class=line><span class=cl><span class=nf>retq</span>
</span></span></code></pre></div><p>As you can see, BenchmarkDotNet uses different diasasm style for each runtime.
Well, <code>DisassemblyDiagnoser</code> is a recent feature, it works, but we did not have enough time to polish it.
However, BenchmarkDotNet is <a href=https://github.com/dotnet/BenchmarkDotNet/wiki/ChangeLog>rapidly evolving</a>,
each version contains many improvements and bug fixes.
If you want to help with the disasm support, <a href=https://github.com/dotnet/BenchmarkDotNet#contributions-are-welcome>contributions are welcome</a>!</p></div><br><br><div class="flex flex-wrap justify-center items-center">The source code of this post and all the relevant files are&nbsp;<a href=https://github.com/AndreyAkinshin/aakinshin.net/tree/master/content/en/posts/2018/dotnet-crossruntime-disasm/index.md>available on GitHub</a>.</div><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f&title=Cross-runtime%20.NET%20disassembly%20with%20BenchmarkDotNet" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=Cross-runtime%20.NET%20disassembly%20with%20BenchmarkDotNet&url=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f&title=Cross-runtime%20.NET%20disassembly%20with%20BenchmarkDotNet" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>