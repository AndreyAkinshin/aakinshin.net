<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.74.3"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content=".NET,C#,BenchmarkDotNet,Benchmarking,disassembly"><title>Cross-runtime .NET disassembly with BenchmarkDotNet | Andrey Akinshin</title><meta name=description content="BenchmarkDotNet is a cool tool for benchmarking. It has a lot of useful features that help you with performance investigations. However, you can use these ..."><link href=/css/lumen-bootstrap.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/slate-bootstrap.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><link href=/css/syntax-light.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/syntax-dark.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.26d61b7027fe55e642f0001cef94cb75b567d721086492aab6b4e32d9ee7811d.js></script><script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.882998740b9c4c24677576b997bde5a487246e2e3bd72128a0e922eaa59db029.mjs></script><link href=https://aakinshin.net/css/fontawesome-all.min.50da8736f05b35aac9691de67fe993cbe01b7d88fcf0cb682c3a8f39933fe4a3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.2a76db7cc14055b3bafacc363f453917ab54a818a7db2a0a9b2409c0f6bf07c5.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.ae812fc71daf5160d927febda5a991cee6c361345e3f685d3736931ed7537986.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVB6MXSX32"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-ZVB6MXSX32');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-41419012-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-41419012-5');</script><script type=text/javascript>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym");ym(28700916,"init",{clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src=https://mc.yandex.ru/watch/28700916 style=position:absolute;left:-9999px alt></div></noscript><script src=/js/jquery-3.3.1.slim.min.js></script></head><body><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class=nav-item><a class=nav-link id=nav-link-posts href=https://aakinshin.net/posts/>Posts</a></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li><li class=nav-item><a class=nav-link id=nav-link-pdnb href=https://aakinshin.net/prodotnetbenchmarking/>Pro .NET Benchmarking</a></li></ul><ul class="navbar-nav ml-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>Cross-runtime .NET disassembly with BenchmarkDotNet</h1><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2018-04-10>April 10, 2018</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/benchmarkdotnet/ class="badge badge-info">BenchmarkDotNet</a>
<a href=https://aakinshin.net/tags/benchmarking/ class="badge badge-info">Benchmarking</a>
<a href=https://aakinshin.net/tags/disassembly/ class="badge badge-info">disassembly</a></span><br><br><p><a href=https://github.com/dotnet/BenchmarkDotNet>BenchmarkDotNet</a> is a cool tool for benchmarking.
It has a lot of useful features that help you with performance investigations.
However, you can use these features even if you are not actually going to benchmark something.
One of these features is <code>DisassemblyDiagnoser</code>.
It shows you a disassembly listing of your code for all required runtimes.
In this post, I will show you how to get disassembly listing for .NET Framework, .NET Core, and Mono with one click!
You can do it with a very small code snippet like this:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=na>[DryCoreJob, DryMonoJob, DryClrJob(Platform.X86)]</span>
<span class=na>[DisassemblyDiagnoser]</span>
<span class=k>public</span> <span class=k>class</span> <span class=nc>IntroDisasm</span>
<span class=p>{</span>
<span class=na>    [Benchmark]</span>
    <span class=k>public</span> <span class=kt>double</span> <span class=n>Sum</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=kt>double</span> <span class=n>res</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>64</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
            <span class=n>res</span> <span class=p>+=</span> <span class=n>i</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>That&rsquo;s all!
<code>[CoreJob]</code>, <code>[MonoJob]</code>, <code>[ClrJob]</code> mean that we are going to run it on .NET Core, Mono, and .NET Framework.
<code>[Dry]</code> means that we are going to run only single &ldquo;dry&rdquo; iteration for each runtime without actual measurements.
<code>[DisassemblyDiagnoser]</code> means that we want to get assembly listings in the <code>BenchmarkDotNet.Artifacts</code> folder.</p><p>Some important remarks:</p><ul><li>This benchmark requires .NET Framework, so it works only on Windows.</li><li>We use <code>Platform.X86</code> for <code>[ClrJob]</code> because we want to see a difference in assembly listing.
The modern versions of .NET Framework and .NET Core use the same JIT engine on <code>x64</code>.
So let&rsquo;s compare <code>LegacyJIT-x86</code> from .NET Framework and <code>RyuJIT-x64</code> from .NET Core.</li><li>To get assembly listings for Mono on Windows, you need <code>as</code> and <code>x86_64-w64-mingw32-objdump.exe</code> tools.
You can read more about it in the <a href=http://benchmarkdotnet.org/Configs/Diagnosers.htm#disassembly-diagnoser-for-mono-on-windows>documentation</a>.</li></ul><p>The source code (the benchmark + the csproj file) is available here: <a href=https://gist.github.com/AndreyAkinshin/62d2f4c3e67acde844f569fbf5846570>https://gist.github.com/AndreyAkinshin/62d2f4c3e67acde844f569fbf5846570</a>
You can try it on your machine with the help of the following script:</p><div class=highlight><pre class=chroma><code class=language-bat data-lang=bat>git clone https://gist.github.com/62d2f4c3e67acde844f569fbf5846570.git DisasmDemo
<span class=k>cd</span> DisasmDemo
dotnet run -f netcoreapp2.0 -c Release
<span class=k>start</span> BenchmarkDotNet.Artifacts\results\IntroDisasm-disassembly-report.html
</code></pre></div><p>As a result, you will see an html page which contains disassembly listings for all runtimes:</p><div class=row><div class=mx-auto><a href=/posts/dotnet-crossruntime-disasm/img/disasm.png target=_blank alt=disasm><img class="mx-auto d-block img-fluid" width=800 src=/posts/dotnet-crossruntime-disasm/img/disasm.png></a></div></div><br><p>The raw code:</p><div class=highlight><pre class=chroma><code class=language-asm data-lang=asm><span class=c>; .NET Framework 4.7 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.7.2633.0
</span><span class=c></span>
<span class=err>07404098</span> <span class=nf>DisasmDemo.IntroDisasm.Sum</span><span class=p>()</span>
<span class=err>0740409</span><span class=nf>c</span> <span class=no>d9ee</span>            <span class=no>fldz</span>
<span class=err>0740409</span><span class=nf>e</span> <span class=mi>33</span><span class=no>c0</span>            <span class=no>xor</span>     <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>
<span class=err>074040</span><span class=nf>a0</span> <span class=mi>8945</span><span class=no>fc</span>          <span class=no>mov</span>     <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-4</span><span class=p>],</span><span class=no>eax</span>
<span class=err>074040</span><span class=nf>a3</span> <span class=no>db45fc</span>          <span class=no>fild</span>    <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-4</span><span class=p>]</span>
<span class=err>074040</span><span class=nf>a6</span> <span class=no>dec1</span>            <span class=no>faddp</span>   <span class=no>st</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=no>st</span>
<span class=err>074040</span><span class=nf>a8</span> <span class=mi>40</span>              <span class=no>inc</span>     <span class=no>eax</span>
<span class=err>074040</span><span class=nf>a9</span> <span class=mi>83</span><span class=no>f840</span>          <span class=no>cmp</span>     <span class=no>eax</span><span class=p>,</span><span class=mi>40</span><span class=no>h</span>
<span class=err>074040</span><span class=nf>ac</span> <span class=mi>7</span><span class=no>cf2</span>            <span class=no>jl</span>      <span class=mi>074040</span><span class=no>a0</span>
<span class=err>074040</span><span class=nf>ae</span> <span class=mi>8</span><span class=no>be5</span>            <span class=no>mov</span>     <span class=no>esp</span><span class=p>,</span><span class=no>ebp</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-asm data-lang=asm><span class=c>; .NET Core 2.0.6 (CoreCLR 4.6.26212.01, CoreFX 4.6.26212.01), 64bit RyuJIT
</span><span class=c></span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>b0</span> <span class=no>DisasmDemo.IntroDisasm.Sum</span><span class=p>()</span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>b3</span> <span class=no>c4e17957c0</span>      <span class=no>vxorpd</span>  <span class=no>xmm0</span><span class=p>,</span><span class=no>xmm0</span><span class=p>,</span><span class=no>xmm0</span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>b8</span> <span class=mi>33</span><span class=no>c0</span>            <span class=no>xor</span>     <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>ba</span> <span class=no>c4e17057c9</span>      <span class=no>vxorps</span>  <span class=no>xmm1</span><span class=p>,</span><span class=no>xmm1</span><span class=p>,</span><span class=no>xmm1</span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>bf</span> <span class=no>c4e1732ac8</span>      <span class=no>vcvtsi2sd</span> <span class=no>xmm1</span><span class=p>,</span><span class=no>xmm1</span><span class=p>,</span><span class=no>eax</span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>c4</span> <span class=no>c4e17b58c1</span>      <span class=no>vaddsd</span>  <span class=no>xmm0</span><span class=p>,</span><span class=no>xmm0</span><span class=p>,</span><span class=no>xmm1</span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>c9</span> <span class=no>ffc0</span>            <span class=no>inc</span>     <span class=no>eax</span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>cb</span> <span class=mi>83</span><span class=no>f840</span>          <span class=no>cmp</span>     <span class=no>eax</span><span class=p>,</span><span class=mi>40</span><span class=no>h</span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>ce</span> <span class=mi>7</span><span class=no>cea</span>            <span class=no>jl</span>      <span class=mi>00007</span><span class=no>fff</span> <span class=mi>196433</span><span class=no>ba</span>
<span class=err>00007</span><span class=nf>fff</span> <span class=mi>196433</span><span class=no>d0</span> <span class=no>c3</span>              <span class=no>ret</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-asm data-lang=asm><span class=c>; Mono 5.4.0 (Visual Studio), 64bit
</span><span class=c></span>
 <span class=nf>Sum</span>
<span class=nf>sub</span>    <span class=no>$0x18</span><span class=p>,</span><span class=nv>%rsp</span>
<span class=nf>mov</span>    <span class=nv>%rsi</span><span class=p>,(</span><span class=nv>%rsp</span><span class=p>)</span>
<span class=nf>xorpd</span>  <span class=nv>%xmm0</span><span class=p>,</span><span class=nv>%xmm0</span>
<span class=nf>movsd</span>  <span class=nv>%xmm0</span><span class=p>,</span><span class=mi>0x8</span><span class=p>(</span><span class=nv>%rsp</span><span class=p>)</span>
<span class=nf>xor</span>    <span class=nv>%esi</span><span class=p>,</span><span class=nv>%esi</span>
<span class=nf>jmp</span>    <span class=mi>2</span><span class=no>e</span> 
<span class=no>xchg</span>   <span class=nv>%ax</span><span class=p>,</span><span class=nv>%ax</span>
<span class=nf>movsd</span>  <span class=mi>0x8</span><span class=p>(</span><span class=nv>%rsp</span><span class=p>),</span><span class=nv>%xmm0</span>
<span class=nf>cvtsi2sd</span> <span class=nv>%esi</span><span class=p>,</span><span class=nv>%xmm1</span>
<span class=nf>addsd</span>  <span class=nv>%xmm1</span><span class=p>,</span><span class=nv>%xmm0</span>
<span class=nf>movsd</span>  <span class=nv>%xmm0</span><span class=p>,</span><span class=mi>0x8</span><span class=p>(</span><span class=nv>%rsp</span><span class=p>)</span>
<span class=nf>inc</span>    <span class=nv>%esi</span>
<span class=nf>cmp</span>    <span class=no>$0x40</span><span class=p>,</span><span class=nv>%esi</span>
<span class=nf>jl</span>     <span class=mi>18</span> 
<span class=no>movsd</span>  <span class=mi>0x8</span><span class=p>(</span><span class=nv>%rsp</span><span class=p>),</span><span class=nv>%xmm0</span>
<span class=nf>mov</span>    <span class=p>(</span><span class=nv>%rsp</span><span class=p>),</span><span class=nv>%rsi</span>
<span class=nf>add</span>    <span class=no>$0x18</span><span class=p>,</span><span class=nv>%rsp</span>
<span class=nf>retq</span>
</code></pre></div><p>As you can see, BenchmarkDotNet uses different diasasm style for each runtime.
Well, <code>DisassemblyDiagnoser</code> is a recent feature, it works, but we did not have enough time to polish it.
However, BenchmarkDotNet is <a href=https://github.com/dotnet/BenchmarkDotNet/wiki/ChangeLog>rapidly evolving</a>,
each version contains many improvements and bug fixes.
If you want to help with the disasm support, <a href=https://github.com/dotnet/BenchmarkDotNet#contributions-are-welcome>contributions are welcome</a>!</p><br><br><div class=row><div class="mx-auto share-block"><div class=share-title>Share:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f&title=Cross-runtime%20.NET%20disassembly%20with%20BenchmarkDotNet" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=Cross-runtime%20.NET%20disassembly%20with%20BenchmarkDotNet&url=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://facebook.com/sharer.php?u=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f" rel=nofollow target=_blank title="Share on Facebook"><i class="fab fa-facebook fa-2x"></i></a></div><div class=share-button><a href="http://vk.com/share.php?url=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f" target=_blank title="Share on VKontakte"><i class="fab fa-vk fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fdotnet-crossruntime-disasm%2f&title=Cross-runtime%20.NET%20disassembly%20with%20BenchmarkDotNet" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class=blog-footer><div class=container><p>&copy; 2013–2020 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub style=color:#fff></i></a><a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter style=color:#fff></i></a><a href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS style=color:#fff></i></a>|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.082780cb948cc57eabbc0d80172a7a5347d5572b599938b4c9876dfd7978b424.js></script><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/anchor.min.js></script><script src=https://aakinshin.net/js/custom.min.11932490dde776463ed165b345838c701accc0cfdedf2e0868f13415f41f0872.js></script></body></html>