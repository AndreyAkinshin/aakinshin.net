<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.123.8"><meta name=author content='Andrey Akinshin'><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content='Mathematics,Statistics,Research,Quantile,Moving quantile'><title>Better moving quantile estimations using the partitioning heaps | Andrey Akinshin</title>
<meta name=description content="Improvements of the Hardle-Steiger method that allows estimating moving quantiles using linear interpolation"><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.867ec06f826167a162aebd1233fd1f8bd62a1ad51f8768abaf9f1ae1d746b5cc.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body class="flex flex-col min-h-screen"><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-2 xs:px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/feed/>Feed</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/library/>Library</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/research-projects/>Research</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/about/>About</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/search/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#magnifying-glass"/></svg></a></div></div><button id=theme-toggle type=button title="Alt+Click to match OS color theme" class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6 flex-grow"><div class=main-post><h1 class=blog-post-title id=post-title>Better moving quantile estimations using the partitioning heaps</h1><div class="flex flex-wrap justify-start items-center"><div class="flex flex-wrap gap-y-1"><span class=label><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#calendar"/></svg>
<time datetime=2021-01-19>January 19, 2021</time>
</span><a class=label-link href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#math"/></svg>
Mathematics
</a><a class=label-link href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#statistics"/></svg>
Statistics
</a><a class=label-link href=https://aakinshin.net/tags/research/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#research"/></svg>
Research
</a><a class=label-link href=https://aakinshin.net/tags/quantile/>Quantile
</a><a class=label-link href=https://aakinshin.net/tags/moving-quantile/>Moving quantile</a></div></div><br><div class=main-content><p>In one of the previous posts, I <a href=https://aakinshin.net/posts/partitioning-heaps-quantile-estimator/>have discussed</a> the Hardle-Steiger method.
This algorithm allows estimating <a href=https://en.wikipedia.org/wiki/Moving_average#Moving_median>the moving median</a>
using $O(L)$ memory and $O(log(L))$ element processing complexity (where $L$ is the window size).
Also, I have shown how to adapt this approach to estimate <em>any</em> moving quantile.</p><p>In this post, I&rsquo;m going to present further improvements.
The Hardle-Steiger method always returns the <a href=https://en.wikipedia.org/wiki/Order_statistic>order statistics</a>
which is the $k\textrm{th}$ smallest element from the sample.
It means that the estimated quantile value always equals one of the last $L$ observed numbers.
However, many of the classic quantile estimators use two elements.
For example, if we want to estimate the median for $x = \{4, 5, 6, 7\}$,
some estimators return $5.5$ (which is the arithmetical mean of $5$ and $6$)
instead of $5$ or $6$ (which are order statistics).</p><p>Let&rsquo;s learn how to implement a moving version of such estimators using
the partitioning heaps from the Hardle-Steiger method.</p><h3 id=the-hyndman-fan-classification>The Hyndman-Fan classification</h3><p>There are many different quantile estimators.
In <a href=https://aakinshin.net/library/papers/hyndman1996/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#paper"/></svg>hyndman1996</a>, Rob Hyndman and Yanan Fan have described
nine estimators that are used in popular statistical packages.
They are based on a single order statistic or on linear interpolation
of two subsequent order statistics.
Below you can see equations for each type that
estimate $p^\textrm{th}$ quantile for a sorted sample $x$ of size $N$.</p><table><thead><tr><th>Type</th><th>h</th><th>Equation</th></tr></thead><tbody><tr><td>1</td><td>$Np+1/2$</td><td>$x_{\lceil h - 1/2 \rceil}$</td></tr><tr><td>2</td><td>$Np+1/2$</td><td>$(x_{\lceil h - 1/2 \rceil} + x_{\lceil h + 1/2 \rceil})/2$</td></tr><tr><td>3</td><td>$Np$</td><td>$x_{\lfloor h \rceil}$</td></tr><tr><td>4</td><td>$Np$</td><td>$x_{\lfloor h \rfloor}+(h-\lfloor h \rfloor)(x_{\lfloor h \rfloor+1})-x_{\lfloor h \rfloor}$</td></tr><tr><td>6</td><td>$(N+1)p$</td><td>$x_{\lfloor h \rfloor}+(h-\lfloor h \rfloor)(x_{\lfloor h \rfloor+1})-x_{\lfloor h \rfloor}$</td></tr><tr><td>5</td><td>$Np+1/2$</td><td>$x_{\lfloor h \rfloor}+(h-\lfloor h \rfloor)(x_{\lfloor h \rfloor+1})-x_{\lfloor h \rfloor}$</td></tr><tr><td>7</td><td>$(N-1)p+1$</td><td>$x_{\lfloor h \rfloor}+(h-\lfloor h \rfloor)(x_{\lfloor h \rfloor+1})-x_{\lfloor h \rfloor}$</td></tr><tr><td>8</td><td>$(N+1/3)p+1/3$</td><td>$x_{\lfloor h \rfloor}+(h-\lfloor h \rfloor)(x_{\lfloor h \rfloor+1})-x_{\lfloor h \rfloor}$</td></tr><tr><td>9</td><td>$(N+1/4)p+3/8$</td><td>$x_{\lfloor h \rfloor}+(h-\lfloor h \rfloor)(x_{\lfloor h \rfloor+1})-x_{\lfloor h \rfloor}$</td></tr></tbody></table><p>As you can see, only Type 1 and Type 3 estimators use a single order statistic.
The other types use an equation based on linear interpolation.</p><p>Type 7 is the most popular quantile estimator which is used by default in
R, Julia, NumPy, Excel (<code>PERCENTILE</code>, <code>PERCENTILE.INC</code>), Python (<code>inclusive</code> method).</p><h3 id=the-partitioning-heaps-data-structure>The partitioning heaps data structure</h3><p>In <a href=/posts/partitioning-heaps-quantile-estimator2/#Hardle1995>[Hardle1995]</a>, W. Hardle and W. Steiger have described a method
of estimating the moving median.
Their approach uses a data structure based on two <a href=https://en.wikipedia.org/wiki/Heap_(data_structure)>heaps</a>
which they call <em>partitioning heaps</em>:</p><div class=row><div class=mx-auto><a href=/posts/partitioning-heaps-quantile-estimator2/img/double-heap.svg target=_blank alt=double-heap><img class="mx-auto d-block img-fluid" width=400 src=/posts/partitioning-heaps-quantile-estimator2/img/double-heap.svg></a></div></div><br><p>In this figure, you see an example for $L=21$ ($L$ is the window size).
It contains:</p><ul><li>$H_1 .. H_{10}$: min heap</li><li>$H_{-1} .. H_{-10}$: max heap</li><li>$H_0$: a node that joins two heaps</li></ul><p>The $H$ array contain the last $L$ elements of the time series and satisfy the following conditions:</p><ul><li>$\max(H_{-2i},\; H_{-2i-1}) \leq H_{-i} \leq H_0$</li><li>$\min(H_{2i},\; H_{2i+1}) \geq H_{i} \geq H_0$</li></ul><p>Thus, $H_0$ is
less than all elements in the upper heap (positive indexes) and
greater than all elements in the lower heap (negative indexes).
Since we have an equal number of elements in both heaps,
$H_0$ represents the median value.</p><p>Once we get a new number in our stream,
we should replace the &ldquo;oldest&rdquo; number in this data structure with the new one.
Next, we should normalize the heaps to satisfy the above conditions.
This operation&rsquo;s algorithmic complexity is $O(log(L))$.</p><p>If we modify the number of elements in the min heap or the max heap,
we can get any quantile value instead of the median
(see <a href=https://aakinshin.net/posts/partitioning-heaps-quantile-estimator/>previous post</a> for details).</p><h3 id=applying-the-hyndman-fan-equations-for-the-partitioning-heaps>Applying the Hyndman-Fan equations for the partitioning heaps</h3><p>All of the equations described by Rob Hyndman and Yanan Fan use
no more than two subsequent order statistics.
Let&rsquo;s look closely at the figure with the partitioning heaps.
We may notice that we already have values of the required elements.
If $H_0$ is the $k^\textrm{th}$ smallest element,
$H_{-1}$ is the $(k-1)^\textrm{th}$ smallest element!
Indeed, $H_{-1} \leq H_0 \leq H_i$ for $i>0$
and $H_{-1} \geq H_i$ for $i < -1$.
By analogy, $H_1$ is the $(k+1)^\textrm{th}$ smallest element.</p><p>Since we already have both required element values,
we can apply the Hyndman-Fan equations without any changes in the data structure.
It&rsquo;s a super-simple improvement, but it allows achieving consistency between
the moving quantile estimator based on the partitioning heaps
and the classic quantile estimators from the Hyndman-Fan classification.</p><h3 id=reference-implementation>Reference implementation</h3><p>If you use C#, you can take an implementation from
the latest nightly version (0.3.0-nightly.86+) of <a href=https://github.com/AndreyAkinshin/perfolizer>Perfolizer</a>
(you need <code>PartitioningHeapsMovingQuantileEstimator</code>).</p><h3 id=conclusion>Conclusion</h3><p>In this post, we improved the Hardle-Steiger method (<a href=/posts/partitioning-heaps-quantile-estimator2/#Hardle1995>[Hardle1995]</a>).
Now it&rsquo;s able to estimate any moving quantiles
using any of the equations described in the Hyndman-Fan classification (<a href=https://aakinshin.net/library/papers/hyndman1996/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#paper"/></svg>hyndman1996</a>).
The suggested approach has the following characteristics ($L$ is the window size):</p><ul><li>Memory: $O(L)$</li><li>Element processing complexity: $O(log(L))$</li><li>Quantile estimating complexity: $O(1)$</li></ul><h3 id=references>References</h3><ul><li><b id=Hyndman1996>[Hyndman1996]</b><br>Hyndman, R. J. and Fan, Y. 1996. Sample quantiles in statistical packages, <em>American Statistician</em> 50, 361–365.<br><a href=https://doi.org/10.2307/2684934>https://doi.org/10.2307/2684934</a></li><li><b id=Hardle1995>[Hardle1995]</b><br>Hardle, W., and William Steiger. &ldquo;Algorithm AS 296: Optimal median smoothing.&rdquo; Journal of the Royal Statistical Society. Series C (Applied Statistics) 44, no. 2 (1995): 258-264.<br><a href=https://doi.org/10.2307/2986349>https://doi.org/10.2307/2986349</a></li></ul></div><hr><h3 id=references>References (2)</h3><ol><li><a href=https://aakinshin.net/library/papers/ title="Library / papers"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#paper"/></svg>
</a><a href=https://aakinshin.net/library/papers/hyndman1996/>Sample Quantiles in Statistical Packages
</a>(1996)
by
<a href=https://aakinshin.net/library/authors/rob-j-hyndman/>Rob J Hyndman</a>
et al.
<span class=label title=Backlinks:13><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>13</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/partitioning-heaps-quantile-estimator/>Fast implementation of the moving quantile based on the partitioning heaps
</a>(2020-12-29)
<span class=label title=Backlinks:2><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>2</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg>
</a><a href=https://aakinshin.net/tags/research/><svg class="rating-icon"><title>Research</title><use xlink:href="/img/fa/all.svg#research"/></svg></a></li></ol><h3 id=backlinks>Backlinks (1)</h3><ol><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/quantile-exponential-smoothing/>Quantile exponential smoothing
</a>(2021-05-04)
<span class=label title=References:7><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>7</span>
<span class=label title=Backlinks:3><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>3</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg>
</a><a href=https://aakinshin.net/tags/research/><svg class="rating-icon"><title>Research</title><use xlink:href="/img/fa/all.svg#research"/></svg></a></li></ol></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}));function toggleTheme(e){e?(document.documentElement.classList.add("dark"),themeToggleLightIcon.classList.remove("hidden"),themeToggleDarkIcon.classList.add("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")}),imagesLight.forEach(e=>{e.classList.add("hidden")})):(document.documentElement.classList.remove("dark"),themeToggleDarkIcon.classList.remove("hidden"),themeToggleLightIcon.classList.add("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}),imagesDark.forEach(e=>{e.classList.add("hidden")}))}themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),event.altKey?(localStorage.removeItem("color-theme"),toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches)):localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{if(localStorage.getItem("color-theme")===null){const t=e.matches?"dark":"light";toggleTheme(t==="dark")}})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2024 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+=" has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>