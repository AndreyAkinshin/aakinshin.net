<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,Lambda,Closures,C#,.NET"><title>Unobviousness in use of C# closures | Andrey Akinshin</title><meta name=description content="C# gives us an ability to use closures. This is a powerful tool that allows anonymous methods and lambda-functions to capture unbound variables in their le..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=https://aakinshin.net/sass/bootstrap-light.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=https://aakinshin.net/sass/bootstrap-dark.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.d7f6578e23ad3f0c33c589f9bcb34f995b45121f1f3ce888869c86b26826c845.js></script>
<script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.9e68d431432744c07a43381a8a833ffe0921cc0e006d84ad97f0b0d43c5cd82d.mjs></script>
<link href=https://aakinshin.net/css/fontawesome-all.min.178e95bba6ea2e9a90838cd646658f4bf6667a6ceaa057cb587bf7e6eb8412d3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.60773ab7266ecc6e9625306f57c0a82a219b011dc3ea2d83763d1ecdf11c86d2.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.7e186db80d8c431d196b3e0718afb0636b82a269a8c92521c11a55267a24fc27.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script src=/js/jquery-3.3.1.slim.min.js></script></head><body class="d-flex flex-column min-vh-100"><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>Blog</a><ul class="dropdown-menu bg-primary"><li><a class=dropdown-item href=https://aakinshin.net/posts/>All Posts</a></li><li><a class=dropdown-item href=https://aakinshin.net/tags/statistics/>Posts about Statistics</a></li><li></li><a class=dropdown-item href=https://aakinshin.net/tags/>All Tags</a></li></ul></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>EN</a><ul class="dropdown-menu bg-primary"><li></li><a class=dropdown-item href=https://aakinshin.net/ru/posts/closures/>RU</a></li></ul></li></ul><ul class="navbar-nav ms-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>Unobviousness in use of C# closures</h1><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2013-08-07>August 7, 2013</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>
&nbsp;
<a href=https://aakinshin.net/tags/programming/ class="badge badge-info">Programming</a>
<a href=https://aakinshin.net/tags/lambda/ class="badge badge-info">Lambda</a>
<a href=https://aakinshin.net/tags/closures/ class="badge badge-info">Closures</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a></span><br><br><p>C# gives us an ability to use closures. This is a powerful tool that allows anonymous methods and lambda-functions to capture unbound variables in their lexical scope. And many programmers in .NET world like using closures very much, but only few of them understand how they really work. Let’s start with a simple sample:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>e</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Foo</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span> <span class=p>+</span> <span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Nothing complicated happens here: we just captured a local variable <code>e</code> in its lambda that is passed to some <code>Foo</code> method. Let’s see how the compiler will expand such construction.*</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>DisplayClass</span> <span class=n>c</span> <span class=p>=</span> <span class=k>new</span> <span class=n>DisplayClass</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>c</span><span class=p>.</span><span class=n>e</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>  
</span></span><span class=line><span class=cl>  <span class=n>Foo</span><span class=p>(</span><span class=n>c</span><span class=p>.</span><span class=n>Action</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>sealed</span> <span class=k>class</span> <span class=nc>DisplayClass</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>Action</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span> <span class=p>+</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As you see from the sample, an additional class containing the captured variable and the target method is created for our closure. This knowledge will help us understand how closures behave in different situations.</p><h3 id=the-for-loop>The for loop</h3><p>Probably, this is the most classic sample cited by everyone:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>actions</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Action</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>3</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=n>actions</span><span class=p>.</span><span class=n>Add</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>action</span> <span class=k>in</span> <span class=n>actions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The sample contains a typical error. Newbie developers think that this code will output <code>"0 1 2"</code>, but in fact it will output <code>"3 3 3"</code>. Such strange behavior is easy to understand if you look on the expanded version of this method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>actions</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Action</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=n>DisplayClass</span> <span class=n>c</span> <span class=p>=</span> <span class=k>new</span> <span class=n>DisplayClass</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>c</span><span class=p>.</span><span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>c</span><span class=p>.</span><span class=n>i</span> <span class=p>&lt;</span> <span class=m>3</span><span class=p>;</span> <span class=n>c</span><span class=p>.</span><span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=n>list</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>c</span><span class=p>.</span><span class=n>Action</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=n>Action</span> <span class=n>action</span> <span class=k>in</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>sealed</span> <span class=k>class</span> <span class=nc>DisplayClass</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>Action</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In this case they say that the variable is cycled by reference, not by value. Many programmers criticize this peculiarity of closures. They think it’s unclear though it’s quite logical for those who get a clear idea what’s inside the closures.</p><h3 id=the-foreach-loop>The foreach loop</h3><p>Let’s review a more interesting sample:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>actions</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Action</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>i</span> <span class=k>in</span> <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>actions</span><span class=p>.</span><span class=n>Add</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>action</span> <span class=k>in</span> <span class=n>actions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>What will the code output? Sorry to say that there is no simple answer to this question. The matter is that earlier versions of C#, behavior of foreach was equal to behavior of for: variable of the cycle was created once and was captured in all lambdas. Starting from C# 5.0 this behavior has changed (<a href=http://blogs.msdn.com/b/ericlippert/archive/2009/11/12/closing-over-the-loop-variable-considered-harmful.aspx>here</a> Eric Lippert admits that Microsoft made the breaking change). Now this code outputs <code>"0 1 2"</code>. Note that this is a peculiarity of language, not of the platform. If you work in Visual Studio 2012 and change target framework to 3.5, nothing will change. And you will be able to see the old behavior in Visual Studio 2010. John Skit <a href=http://stackoverflow.com/questions/16264289/captured-closure-loop-variable-in-c-sharp-5-0>explains</a> why it was decided to make different behavior for <code>foreach</code> and <code>for</code>. Let’s have a look at a new variant of the expanded version of the code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>actions</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Action</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=k>in</span> <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DisplayClass</span> <span class=n>c</span> <span class=p>=</span> <span class=k>new</span> <span class=n>DisplayClass</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=err>с</span><span class=p>.</span><span class=n>i</span> <span class=p>=</span> <span class=n>i</span><span class=p>;</span>    
</span></span><span class=line><span class=cl>    <span class=n>list</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>c1</span><span class=p>.</span><span class=n>Action</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=n>Action</span> <span class=n>action</span> <span class=k>in</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>sealed</span> <span class=k>class</span> <span class=nc>DisplayClass</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>Action</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>You can easily see the difference: in C# 5.0, for every iteration of the foreach cycle, we get a new instance of the generated class providing closure logic.</p><h3 id=closure-of-multiple-variables>Closure of multiple variables</h3><p>Let’s review a case when we get multiple variables that are captured in different variables:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>x</span> <span class=p>=</span> <span class=m>1</span><span class=p>,</span> <span class=n>y</span> <span class=p>=</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Foo</span><span class=p>(</span><span class=n>u</span> <span class=p>=&gt;</span> <span class=n>u</span> <span class=p>+</span> <span class=n>x</span><span class=p>,</span> <span class=n>u</span> <span class=p>=&gt;</span> <span class=n>u</span> <span class=p>+</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>One can think that in this case two additional classes are generated and each of them will be responsible for a single variable. Actually, a single class will be generated:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>DisplayClass</span> <span class=err>с</span> <span class=p>=</span> <span class=k>new</span> <span class=n>DisplayClass</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=err>с</span><span class=p>.</span><span class=n>x</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=err>с</span><span class=p>.</span><span class=n>y</span> <span class=p>=</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Foo</span><span class=p>(</span><span class=err>с</span><span class=p>.</span><span class=n>ActionX</span><span class=p>,</span> <span class=n>c</span><span class=p>.</span><span class=n>ActionY</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>sealed</span> <span class=k>class</span> <span class=nc>DisplayClass</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>ActionX</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>u</span> <span class=p>+</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>ActionY</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>u</span> <span class=p>+</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Thus, lambdas are bound; garbage collector will access them when no reference to either of them will remain. Imagine the situation when the first lambda is used when initiating a long-living object, the second one is used when completing the work with it. And let there be many such objects. In this case initializing lambdas will stay in memory for quite a long time, though no one will ever invoke them.</p><h3 id=scope>Scope</h3><p>There is one more peculiarity of closures that you need to know. Let’s review a sample:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>(</span><span class=n>List</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>element</span> <span class=k>in</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>e</span> <span class=p>=</span> <span class=n>element</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Condition</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=n>Foo</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span> <span class=p>+</span> <span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And here is the question: where the closure object will be created? In spite the lambda is created inside <code>if</code>, the object will be created in the same scope the captured variable is located in.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>(</span><span class=n>List</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=kt>int</span> <span class=n>element</span> <span class=k>in</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DisplayClass</span> <span class=n>c</span> <span class=p>=</span> <span class=k>new</span> <span class=n>DisplayClass</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=p>.</span><span class=n>e</span> <span class=p>=</span> <span class=n>element</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Condition</span><span class=p>(</span><span class=n>c</span><span class=p>.</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=n>Foo</span><span class=p>(</span><span class=n>c</span><span class=p>.</span><span class=n>Action</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>sealed</span> <span class=k>class</span> <span class=nc>DisplayClass</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>Action</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span> <span class=p>+</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This peculiarity is important when the <code>list</code> is quite big and the <code>Condition(e)</code> is executed quite rarely. <code>DisplayClass</code> instances will be created uselessly. It will affect memory and performance. We can fix the situation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>(</span><span class=n>List</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>element</span> <span class=k>in</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Condition</span><span class=p>(</span><span class=n>element</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>var</span> <span class=n>e</span> <span class=p>=</span> <span class=n>element</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>Foo</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span> <span class=p>+</span> <span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This method will be deployed in a more optimal manner since <code>DisplayClass</code> constructor will be invoked when it is really necessary:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Run</span><span class=p>(</span><span class=n>List</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>foreach</span> <span class=p>(</span><span class=kt>int</span> <span class=n>element</span> <span class=k>in</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Condition</span><span class=p>(</span><span class=n>element</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>DisplayClass</span> <span class=n>c</span> <span class=p>=</span> <span class=k>new</span> <span class=n>DisplayClass</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>c</span><span class=p>.</span><span class=n>e</span> <span class=p>=</span> <span class=n>element</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>Foo</span><span class=p>(</span><span class=n>c</span><span class=p>.</span><span class=n>Action</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>sealed</span> <span class=k>class</span> <span class=nc>DisplayClass</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>int</span> <span class=n>Action</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span> <span class=p>+</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=problems>Problems</h3><p>You can find problems about the subject in <a href=http://problembook.net>ProblemBook.NET</a>:
<a href=http://problembook.net/content/en/Linq/ClosureAndForeach-P.html>ClosureAndForeach</a>,
<a href=http://problembook.net/content/en/Linq/ClosureAndFor-P.html>ClosureAndFor</a>,
<a href=http://problembook.net/content/en/Linq/ClosureAndVariable-P.html>ClosureAndVariable</a>.</p><hr><p>It’s very convenient to use the following utility: <a href=http://www.jetbrains.com/decompiler/>dotPeek</a> from <a href=http://www.jetbrains.com/>JetBrains</a> with enabled option <em>Show compiler-generated code</em>. Code included in the article is simplified in comparison with the disassembled version to make it easy to read.</p><br><br><div class=row><div class="justify-content-center share-block"><div class=share-title>Share:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fclosures%2f&title=Unobviousness%20in%20use%20of%20C%23%20closures" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=Unobviousness%20in%20use%20of%20C%23%20closures&url=https%3a%2f%2faakinshin.net%2fposts%2fclosures%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fclosures%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fclosures%2f&title=Unobviousness%20in%20use%20of%20C%23%20closures" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class="blog-footer mt-auto"><div class=container><p>&copy; 2013&mdash;2022 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub></i></a>
<a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter></i></a>
<a href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS></i></a>
|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.c26550621ac13c2221d7f6f5e6fe862345d3919723c50d730893e3e4856ecf35.js></script>
<script src=/js/bootstrap.bundle.min.js></script>
<script src=/js/anchor.min.js></script>
<script src=https://aakinshin.net/js/custom.min.f6e5d13fe39f305056cc743ee4cb8d117c1aba26176e58c82c79a480d02fe4b7.js></script></body></html>