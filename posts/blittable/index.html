<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,C#,Internals"><title>Blittable types | Andrey Akinshin</title><meta name=description content="Challenge of the day: what will the following code display?
[StructLayout(LayoutKind.Explicit)] public struct UInt128 { [FieldOffset(0)] public ulong Value..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script src=https://cdn.tailwindcss.com/3.2.4></script>
<script>tailwind.config={darkMode:"class"}</script><style type=text/tailwindcss>
    @layer base {
       
      body {
        @apply bg-white dark:bg-zinc-800;
        @apply text-black dark:text-gray-400;
      }
      nav {
        @apply bg-sky-800 dark:bg-zinc-900;
      }
      a {
        @apply text-sky-600 dark:text-white;
        @apply no-underline;
      }
      .main-content a:not(.label-link) {
        @apply hover:underline;
      }
      hr {
        @apply h-px my-3 border-0 bg-gray-300 dark:bg-gray-600;
      }
      h1, h2, h3, h4, h5, h6 {
        @apply leading-tight;
      }
      h1, h2, h3 {
        @apply text-4xl py-4;
      }
      h4 {
        @apply text-3xl py-3;
      }
      h5, h6 {
        @apply text-2xl py-2;
      }
      table {
        @apply border self-center mx-auto;
      }
      th, td {
        @apply border p-2
      }
      blockquote {
        @apply border-l-8 border-gray-300 bg-gray-100 dark:border-zinc-600 dark:bg-zinc-700;
        @apply ml-4 my-4 px-4 py-2;
      }

       
      .main ul {
        @apply list-disc ml-10 my-2;
      }
      .main ol {
        @apply list-decimal ml-10 my-2;
      }
      .main p {
        @apply mb-3;
      }

       
      .label {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-gray-400 dark:border-gray-500;
      }
      .label-link {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-sky-600 dark:border-slate-400;
        @apply hover:bg-sky-200 dark:hover:bg-gray-500;
      }
      .nav-item {
        @apply text-white hover:bg-sky-700 dark:hover:bg-gray-700;
      }

       
      .paginator {
        @apply flex flex-wrap justify-center mb-4;
      }
      .paginator .page-item {
        @apply inline-flex border rounded px-3 py-1;
      }
      .paginator .page-item:not(.active):not(.disabled) {
        @apply border-gray-400 dark:border-gray-400;
      }
      .paginator .page-item.active {
        @apply border-sky-600 dark:border-white;
      }
      .paginator .page-item.disabled {
        @apply bg-gray-50 dark:bg-gray-500 dark:border-gray-400;
      }
      .paginator .page-item.disabled a {
        @apply text-gray-400 dark:text-gray-400;
      }

       
      .block-example {
        @apply my-4 pl-3;
        @apply border-l-8 border-gray-300 dark:border-zinc-600;
      }

       
      #about img {
        @apply inline-flex h-4;
      }

       
      .fai {
        @apply inline-flex h-[1.2em] w-[1.2em] pr-[0.4em] fill-current;
      }
      .fai-link {
        @apply hover:text-sky-400 dark:hover:text-blue-400;
      }
      .label-link .fai {
        @apply pl-1 pb-1 h-[1.5em] w-[1.5em];
      }

       
      .chroma {
        @apply my-5 overflow-y-scroll;
        @apply p-1 border rounded;
      }
    }
  </style><style>.block-example-title::before{counter-increment:example;content:"Example " counter(example)}body{counter-reset:example}code.has-jax{-webkit-font-smoothing:antialiased;background:inherit!important;border:none!important;font-size:100%}.anchorjs-link{transition:all .25s linear}*:hover>.anchorjs-link{margin-left:-1.125em!important}.chroma{background-color:#fff}.chroma .x{}.chroma .err{color:#a61717;background-color:#e3d2d2}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#000;font-weight:700}.chroma .kc{color:#000;font-weight:700}.chroma .kd{color:#000;font-weight:700}.chroma .kn{color:#000;font-weight:700}.chroma .kp{color:#000;font-weight:700}.chroma .kr{color:#000;font-weight:700}.chroma .kt{color:#458;font-weight:700}.chroma .n{}.chroma .na{color:teal}.chroma .nb{color:#0086b3}.chroma .bp{color:#999}.chroma .nc{color:#458;font-weight:700}.chroma .no{color:teal}.chroma .nd{color:#3c5d5d;font-weight:700}.chroma .ni{color:purple}.chroma .ne{color:#900;font-weight:700}.chroma .nf{color:#900;font-weight:700}.chroma .fm{}.chroma .nl{color:#900;font-weight:700}.chroma .nn{color:#555}.chroma .nx{}.chroma .py{}.chroma .nt{color:navy}.chroma .nv{color:teal}.chroma .vc{color:teal}.chroma .vg{color:teal}.chroma .vi{color:teal}.chroma .vm{}.chroma .l{}.chroma .ld{}.chroma .s{color:#d14}.chroma .sa{color:#d14}.chroma .sb{color:#d14}.chroma .sc{color:#d14}.chroma .dl{color:#d14}.chroma .sd{color:#d14}.chroma .s2{color:#d14}.chroma .se{color:#d14}.chroma .sh{color:#d14}.chroma .si{color:#d14}.chroma .sx{color:#d14}.chroma .sr{color:#009926}.chroma .s1{color:#d14}.chroma .ss{color:#990073}.chroma .m{color:#099}.chroma .mb{color:#099}.chroma .mf{color:#099}.chroma .mh{color:#099}.chroma .mi{color:#099}.chroma .il{color:#099}.chroma .mo{color:#099}.chroma .o{color:#000;font-weight:700}.chroma .ow{color:#000;font-weight:700}.chroma .p{}.chroma .c{color:#998;font-style:italic}.chroma .ch{color:#998;font-style:italic}.chroma .cm{color:#998;font-style:italic}.chroma .c1{color:#998;font-style:italic}.chroma .cs{color:#999;font-weight:700;font-style:italic}.chroma .cp{color:#999;font-weight:700;font-style:italic}.chroma .cpf{color:#999;font-weight:700;font-style:italic}.chroma .g{}.chroma .gd{color:#000;background-color:#fdd}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#a00}.chroma .gh{color:#999}.chroma .gi{color:#000;background-color:#dfd}.chroma .go{color:#888}.chroma .gp{color:#555}.chroma .gs{font-weight:700}.chroma .gu{color:#aaa}.chroma .gt{color:#a00}.chroma .gl{text-decoration:underline}.chroma .w{color:#bbb}.dark.chroma{color:#f8f8f2;background-color:#272822}.dark .chroma{color:#f8f8f2;background-color:#272822}.dark .chroma .x{}.dark .chroma .err{color:#960050;background-color:#1e0010}.dark .chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.dark .chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.dark .chroma .hl{display:block;width:100%;background-color:#ffc}.dark .chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.dark .chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.dark .chroma .k{color:#66d9ef}.dark .chroma .kc{color:#66d9ef}.dark .chroma .kd{color:#66d9ef}.dark .chroma .kn{color:#f92672}.dark .chroma .kp{color:#66d9ef}.dark .chroma .kr{color:#66d9ef}.dark .chroma .kt{color:#66d9ef}.dark .chroma .n{}.dark .chroma .na{color:#a6e22e}.dark .chroma .nb{}.dark .chroma .bp{}.dark .chroma .nc{color:#a6e22e}.dark .chroma .no{color:#66d9ef}.dark .chroma .nd{color:#a6e22e}.dark .chroma .ni{}.dark .chroma .ne{color:#a6e22e}.dark .chroma .nf{color:#a6e22e}.dark .chroma .fm{}.dark .chroma .nl{}.dark .chroma .nn{}.dark .chroma .nx{color:#a6e22e}.dark .chroma .py{}.dark .chroma .nt{color:#f92672}.dark .chroma .nv{}.dark .chroma .vc{}.dark .chroma .vg{}.dark .chroma .vi{}.dark .chroma .vm{}.dark .chroma .l{color:#ae81ff}.dark .chroma .ld{color:#e6db74}.dark .chroma .s{color:#e6db74}.dark .chroma .sa{color:#e6db74}.dark .chroma .sb{color:#e6db74}.dark .chroma .sc{color:#e6db74}.dark .chroma .dl{color:#e6db74}.dark .chroma .sd{color:#e6db74}.dark .chroma .s2{color:#e6db74}.dark .chroma .se{color:#ae81ff}.dark .chroma .sh{color:#e6db74}.dark .chroma .si{color:#e6db74}.dark .chroma .sx{color:#e6db74}.dark .chroma .sr{color:#e6db74}.dark .chroma .s1{color:#e6db74}.dark .chroma .ss{color:#e6db74}.dark .chroma .m{color:#ae81ff}.dark .chroma .mb{color:#ae81ff}.dark .chroma .mf{color:#ae81ff}.dark .chroma .mh{color:#ae81ff}.dark .chroma .mi{color:#ae81ff}.dark .chroma .il{color:#ae81ff}.dark .chroma .mo{color:#ae81ff}.dark .chroma .o{color:#f92672}.dark .chroma .ow{color:#f92672}.dark .chroma .p{}.dark .chroma .c{color:#75715e}.dark .chroma .ch{color:#75715e}.dark .chroma .cm{color:#75715e}.dark .chroma .c1{color:#75715e}.dark .chroma .cs{color:#75715e}.dark .chroma .cp{color:#75715e}.dark .chroma .cpf{color:#75715e}.dark .chroma .g{}.dark .chroma .gd{color:#f92672}.dark .chroma .ge{font-style:italic}.dark .chroma .gr{}.dark .chroma .gh{}.dark .chroma .gi{color:#a6e22e}.dark .chroma .go{}.dark .chroma .gp{}.dark .chroma .gs{font-weight:700}.dark .chroma .gu{color:#75715e}.dark .chroma .gt{}.dark .chroma .gl{}.dark .chroma .w{}</style><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-6 h-6"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Blittable types</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai"><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2015-11-26>November 26, 2015</time><svg class="fai ml-3"><use xlink:href="/img/fa/all.svg#tag"/></svg>
<a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/internals/>Internals</a></div><br><div class=main-content><p>Challenge of the day: what will the following code display?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[StructLayout(LayoutKind.Explicit)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>UInt128</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>    [FieldOffset(0)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>ulong</span> <span class=n>Value1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [FieldOffset(8)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>ulong</span> <span class=n>Value2</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>[StructLayout(LayoutKind.Sequential)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>MyStruct</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>UInt128</span> <span class=n>UInt128</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>char</span> <span class=n>Char</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>unsafe</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>myStruct</span> <span class=p>=</span> <span class=k>new</span> <span class=n>MyStruct</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>baseAddress</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)&amp;</span><span class=n>myStruct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>uInt128Adress</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)&amp;</span><span class=n>myStruct</span><span class=p>.</span><span class=n>UInt128</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>uInt128Adress</span> <span class=p>-</span> <span class=n>baseAddress</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>Marshal</span><span class=p>.</span><span class=n>OffsetOf</span><span class=p>(</span><span class=k>typeof</span><span class=p>(</span><span class=n>MyStruct</span><span class=p>),</span> <span class=s>&#34;UInt128&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>A hint: two zeros or two another same values are wrong answers in the general case. The following table shows the console output on different runtimes:</p><table><tr><th></th><th>MS.NET-x86</th><th>MS.NET-x64</th><th>Mono</th></tr><tr><td>uInt128Adress - baseAddress</td><td>4</td><td>8</td><td>0</td></tr><tr><td>Marshal.OffsetOf(typeof(MyStruct), "UInt128")</td><td>0</td><td>0</td><td>0</td></tr></table><p>If you want to know why it happens, you probably should learn some useful information about blittable types.</p><h3 id=theory>Theory</h3><p>There is a definition of <a href=https://en.wikipedia.org/wiki/Blittable_types>blittable types</a> from Wikipedia:</p><blockquote><p>Blittable types are data types in software applications which have a unique characteristic. Data are often represented in memory differently in managed and unmanaged code in the Microsoft .NET framework. However, blittable types are defined as having an identical presentation in memory for both environments, and can be directly shared. Understanding the difference between blittable and non-blittable types can aid in using COM Interop or P/Invoke, two techniques for interoperability in .NET applications.</p></blockquote><p>If you want to marshall your structures, it is very important to know: is your type blittable or not. Indeed, marshalling will be easier, if your data in memory has a proper representation for marshalling. Furthermore, there are situations when you can use only blittable types. For example:</p><ul><li>Structures that are returned from platform invoke calls must be blittable types.</li><li>As an optimization, arrays of blittable types and classes that contain only blittable members are pinned instead of copied during marshaling.</li></ul><p>Let&rsquo;s discuss it in detail: which types are blittable and what does it depend?</p><p>First of all, we should know about the following attribute: <a href=https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.structlayoutattribute.aspx>System.Runtime.InteropServices.StructLayoutAttribute</a>, it lets you control the physical layout of the data fields of a class or structure in memory. You can use <a href=https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.layoutkind.aspx>3 following values</a> of <code>LayoutKind</code>:</p><ul><li><code>Auto</code>: The runtime automatically chooses an appropriate layout for the members of an object in unmanaged memory. Objects defined with this enumeration member cannot be exposed outside of managed code. Attempting to do so generates an exception.</li><li><code>Explicit</code>: The precise position of each member of an object in unmanaged memory is explicitly controlled, subject to the setting of the StructLayoutAttribute.Pack field. Each member must use the FieldOffsetAttribute to indicate the position of that field within the type.</li><li><code>Sequential</code>: The members of the object are laid out sequentially, in the order in which they appear when exported to unmanaged memory. The members are laid out according to the packing specified in StructLayoutAttribute.Pack, and can be noncontiguous.</li></ul><p>Two last values (<code>Explicit</code> and <code>Sequential</code>) are also called Formatted because they define the fields order for marshalling. C# uses <code>Sequential</code> as default.</p><h3 id=blittable-types>Blittable types</h3><p>It is very important to know, which types are blittable. We have the following groups of blittable types:</p><ul><li>Some primitive types: <a href=https://msdn.microsoft.com/en-us/library/system.byte.aspx>System.Byte</a>, <a href=https://msdn.microsoft.com/en-us/library/system.sbyte.aspx>System.SByte</a>, <a href=https://msdn.microsoft.com/en-us/library/system.int16.aspx>System.Int16</a>, <a href=https://msdn.microsoft.com/en-us/library/system.uint16.aspx>System.UInt16</a>, <a href=https://msdn.microsoft.com/en-us/library/system.int32.aspx>System.Int32</a>, <a href=https://msdn.microsoft.com/en-us/library/system.uint32.aspx>System.UInt32</a>, <a href=https://msdn.microsoft.com/en-us/library/system.int64.aspx>System.Int64</a>, <a href=https://msdn.microsoft.com/en-us/library/system.uint64.aspx>System.UInt64</a>, <a href=https://msdn.microsoft.com/en-us/library/system.intptr.aspx>System.IntPtr</a>, <a href=https://msdn.microsoft.com/en-us/library/system.uintptr.aspx>System.UIntPtr</a>, <a href=https://msdn.microsoft.com/en-us/library/system.single.aspx>System.Single</a>, <a href=https://msdn.microsoft.com/en-us/library/system.double.aspx>System.Double</a>.</li><li>One-dimensional arrays of blittable types, such as an array of integers. However, a type that contains a variable array of blittable types is not itself blittable.</li><li>Formatted value types that contain only blittable types (and classes if they are marshaled as formatted types).</li></ul><h3 id=non-blittable-types>Non-Blittable Types</h3><p>There are several non-blittable types which we should discussed in detail.</p><h4 id=decimal>Decimal</h4><p>Yep, <a href=https://msdn.microsoft.com/en-us/library/system.decimal.aspx>Decimal</a> is not a blittable type. If you want to use it as a blittable, you probably should write a wrapper (based on the <a href=http://stackoverflow.com/a/30217247/184842>method</a> by Hans Passant, see <a href=http://stackoverflow.com/questions/30213132/why-is-decimal-data-type-non-blittable>Why is “decimal” data type non-blittable?</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>BlittableDecimal</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=kt>long</span> <span class=n>longValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>decimal</span> <span class=n>Value</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=kt>decimal</span><span class=p>.</span><span class=n>FromOACurrency</span><span class=p>(</span><span class=n>longValue</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>set</span> <span class=p>{</span> <span class=n>longValue</span> <span class=p>=</span> <span class=kt>decimal</span><span class=p>.</span><span class=n>ToOACurrency</span><span class=p>(</span><span class=k>value</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>explicit</span> <span class=k>operator</span> <span class=n>BlittableDecimal</span><span class=p>(</span><span class=kt>decimal</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>BlittableDecimal</span> <span class=p>{</span> <span class=n>Value</span> <span class=p>=</span> <span class=k>value</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>implicit</span> <span class=k>operator</span> <span class=kt>decimal</span> <span class=p>(</span><span class=n>BlittableDecimal</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>value</span><span class=p>.</span><span class=n>Value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=datetime>DateTime</h4><p>An interesting fact: <a href=https://msdn.microsoft.com/en-us/library/system.datetime.aspx>DateTime</a> contains a single <code>UInt64</code> field, but the LayoutKind <a href=http://referencesource.microsoft.com/#mscorlib/system/datetime.cs,55>explicitly set</a> to <code>Auto</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[StructLayout(LayoutKind.Auto)]</span>
</span></span><span class=line><span class=cl><span class=na>[Serializable]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>DateTime</span> <span class=p>:</span> 
</span></span><span class=line><span class=cl>  <span class=n>IComparable</span><span class=p>,</span> <span class=n>IFormattable</span><span class=p>,</span> <span class=n>IConvertible</span><span class=p>,</span> <span class=n>ISerializable</span><span class=p>,</span> <span class=n>IComparable</span><span class=p>&lt;</span><span class=n>DateTime</span><span class=p>&gt;,</span><span class=n>IEquatable</span><span class=p>&lt;</span><span class=n>DateTime</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// ...</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>    <span class=c1>// The data is stored as an unsigned 64-bit integeter</span>
</span></span><span class=line><span class=cl>    <span class=c1>//   Bits 01-62: The value of 100-nanosecond ticks where 0 represents 1/1/0001 12:00am, up until the value</span>
</span></span><span class=line><span class=cl>    <span class=c1>//               12/31/9999 23:59:59.9999999</span>
</span></span><span class=line><span class=cl>    <span class=c1>//   Bits 63-64: A four-state value that describes the DateTimeKind value of the date time, with a 2nd</span>
</span></span><span class=line><span class=cl>    <span class=c1>//               value for the rare case where the date time is local, but is in an overlapped daylight</span>
</span></span><span class=line><span class=cl>    <span class=c1>//               savings time hour and it is in daylight savings time. This allows distinction of these</span>
</span></span><span class=line><span class=cl>    <span class=c1>//               otherwise ambiguous local times and prevents data loss when round tripping from Local to</span>
</span></span><span class=line><span class=cl>    <span class=c1>//               UTC time.</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=n>UInt64</span> <span class=n>dateData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// ...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It means that <code>DateTime</code> is a non-blittable type. Thus, if you have a value type with a <code>DateTime</code> field, your types will be also non-blittable. Such behaviour has historical causes and confuses some people, see: <a href=http://stackoverflow.com/questions/21881554/why-does-the-system-datetime-struct-have-layout-kind-auto>Why does the System.DateTime struct have layout kind Auto?</a>, <a href=http://stackoverflow.com/questions/4132533/why-does-layoutkind-sequential-work-differently-if-a-struct-contains-a-datetime>Why does LayoutKind.Sequential work differently if a struct contains a DateTime field?</a> (I recommend to read <a href=http://stackoverflow.com/a/21883421/184842>this answer</a> by Hans Passant).</p><p>Of course, you can write a blittable wrapper like follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>BlittableDateTime</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=kt>long</span> <span class=n>ticks</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>DateTime</span> <span class=n>Value</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=k>new</span> <span class=n>DateTime</span><span class=p>(</span><span class=n>ticks</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>set</span> <span class=p>{</span> <span class=n>ticks</span> <span class=p>=</span> <span class=k>value</span><span class=p>.</span><span class=n>Ticks</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>explicit</span> <span class=k>operator</span> <span class=n>BlittableDateTime</span><span class=p>(</span><span class=n>DateTime</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>BlittableDateTime</span> <span class=p>{</span> <span class=n>Value</span> <span class=p>=</span> <span class=k>value</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>implicit</span> <span class=k>operator</span> <span class=n>DateTime</span><span class=p>(</span><span class=n>BlittableDateTime</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>value</span><span class=p>.</span><span class=n>Value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=guid>Guid</h4><p>Of course, you know about the <a href=https://msdn.microsoft.com/en-us/library/system.guid.aspx>Guid</a> type. But do you know about its internal representation? Let&rsquo;s look to <a href=http://referencesource.microsoft.com/#mscorlib/system/guid.cs,30>the source code</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>private</span> <span class=kt>int</span>         <span class=n>_a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>short</span>       <span class=n>_b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>short</span>       <span class=n>_c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>byte</span>       <span class=n>_d</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>byte</span>       <span class=n>_e</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>byte</span>       <span class=n>_f</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>byte</span>       <span class=n>_g</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>byte</span>       <span class=n>_h</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>byte</span>       <span class=n>_i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>byte</span>       <span class=n>_j</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=kt>byte</span>       <span class=n>_k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Creates a new guid from an array of bytes.</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=n>Guid</span><span class=p>(</span><span class=kt>byte</span><span class=p>[]</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Some checks ...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_a</span> <span class=p>=</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>b</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>&lt;&lt;</span> <span class=m>24</span><span class=p>)</span> <span class=p>|</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>b</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>&lt;&lt;</span> <span class=m>16</span><span class=p>)</span> <span class=p>|</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>b</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>&lt;&lt;</span> <span class=m>8</span><span class=p>)</span> <span class=p>|</span> <span class=n>b</span><span class=p>[</span><span class=m>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>_b</span> <span class=p>=</span> <span class=p>(</span><span class=kt>short</span><span class=p>)(((</span><span class=kt>int</span><span class=p>)</span><span class=n>b</span><span class=p>[</span><span class=m>5</span><span class=p>]</span> <span class=p>&lt;&lt;</span> <span class=m>8</span><span class=p>)</span> <span class=p>|</span> <span class=n>b</span><span class=p>[</span><span class=m>4</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>_c</span> <span class=p>=</span> <span class=p>(</span><span class=kt>short</span><span class=p>)(((</span><span class=kt>int</span><span class=p>)</span><span class=n>b</span><span class=p>[</span><span class=m>7</span><span class=p>]</span> <span class=p>&lt;&lt;</span> <span class=m>8</span><span class=p>)</span> <span class=p>|</span> <span class=n>b</span><span class=p>[</span><span class=m>6</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>_d</span> <span class=p>=</span> <span class=n>b</span><span class=p>[</span><span class=m>8</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>_e</span> <span class=p>=</span> <span class=n>b</span><span class=p>[</span><span class=m>9</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>_f</span> <span class=p>=</span> <span class=n>b</span><span class=p>[</span><span class=m>10</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>_g</span> <span class=p>=</span> <span class=n>b</span><span class=p>[</span><span class=m>11</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>_h</span> <span class=p>=</span> <span class=n>b</span><span class=p>[</span><span class=m>12</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>_i</span> <span class=p>=</span> <span class=n>b</span><span class=p>[</span><span class=m>13</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>_j</span> <span class=p>=</span> <span class=n>b</span><span class=p>[</span><span class=m>14</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>_k</span> <span class=p>=</span> <span class=n>b</span><span class=p>[</span><span class=m>15</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It is interesting. If we open <a href=https://en.wikipedia.org/wiki/Globally_unique_identifier>wikipedia</a>, we can find the following table:</p><table><tr><th>Bits</th><th>Bytes</th><th>Name</th><th>Endianness (Microsoft GUID Structure)</th><th>Endianness (RFC 4122)</th></tr><tr><td>32</td><td>4</td><td>Data1</td><td>Native</td><td>Big</td></tr><tr><td>16</td><td>2</td><td>Data2</td><td>Native</td><td>Big</td></tr><tr><td>16</td><td>2</td><td>Data3</td><td>Native</td><td>Big</td></tr><tr><td>64</td><td>8</td><td>Data4</td><td>Big</td><td>Big</td></tr></table><p>GUID has the following Type library representation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>tagGUID</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>DWORD</span> <span class=n>Data1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>WORD</span>  <span class=n>Data2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>WORD</span>  <span class=n>Data3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>BYTE</span>  <span class=n>Data4</span><span class=p>[</span> <span class=mi>8</span> <span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>GUID</span><span class=p>;</span>
</span></span></code></pre></div><p>It is very important that internal representation of GUID is depend on platform. If you work with the little-endian architecture (you likely uses exactly little-endian, see <a href=https://en.wikipedia.org/wiki/Endianness>Endianness</a>), the GUID representation will differ from RFC 4122. It can create some troubles during interop with another application (for example, <a href=http://docs.oracle.com/javase/8/docs/api/java/util/UUID.html>Java UUID</a> uses RFC 4122).</p><h4 id=char>Char</h4><p><a href=https://msdn.microsoft.com/en-us/library/system.char.aspx>Char</a> is also non-blittable type, it can be converted to <code>Unicode</code> or <code>ANSI</code> character. The marshalling type depends on <a href=https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.charset.aspx>CharSet</a> of <code>StructLayout</code>, which can be equal to one of the following values: <code>Auto</code>, <code>Ansi</code>, <code>Unicode</code>. On the modern versions of Windows, <code>Auto</code> resolves to <code>Unicode</code>, but on Windows 98 and Windows Me <code>Auto</code> resolves to <code>Ansi</code>. The C# compiler uses <code>Ansi</code> as default that makes char a non-blittable type. However, we can write the following wrapper and solve the problem:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>BlittableChar</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>char</span> <span class=n>Value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>explicit</span> <span class=k>operator</span> <span class=n>BlittableChar</span><span class=p>(</span><span class=kt>char</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>BlittableChar</span> <span class=p>{</span> <span class=n>Value</span> <span class=p>=</span> <span class=k>value</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>implicit</span> <span class=k>operator</span> <span class=kt>char</span> <span class=p>(</span><span class=n>BlittableChar</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>value</span><span class=p>.</span><span class=n>Value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=boolean>Boolean</h4><p>MSDN <a href=https://msdn.microsoft.com/en-us/library/75dwhxf7.aspx>says</a> the following phrase about <a href=https://msdn.microsoft.com/en-us/library/system.boolean.aspx>Boolean</a>:</p><blockquote><p>Converts to a 1, 2, or 4-byte value with true as 1 or -1.</p></blockquote><p>Let&rsquo;s write one more wrapper and make blittable bool:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>BlittableBoolean</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=kt>byte</span> <span class=n>byteValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>bool</span> <span class=n>Value</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span> <span class=p>{</span> <span class=k>return</span> <span class=n>Convert</span><span class=p>.</span><span class=n>ToBoolean</span><span class=p>(</span><span class=n>byteValue</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>set</span> <span class=p>{</span> <span class=n>byteValue</span> <span class=p>=</span> <span class=n>Convert</span><span class=p>.</span><span class=n>ToByte</span><span class=p>(</span><span class=k>value</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>explicit</span> <span class=k>operator</span> <span class=n>BlittableBoolean</span><span class=p>(</span><span class=kt>bool</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>BlittableBoolean</span> <span class=p>{</span> <span class=n>Value</span> <span class=p>=</span> <span class=k>value</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>implicit</span> <span class=k>operator</span> <span class=kt>bool</span> <span class=p>(</span><span class=n>BlittableBoolean</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>value</span><span class=p>.</span><span class=n>Value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=blittable-or-non-blittable>Blittable or Non-Blittable?</h3><p>Sometimes it is useful to know, is your type blittable or not. How we can do it? Recall that we can&rsquo;t allocate pinned instances of non-blittable type. So, we can write the following helper class for our aim (based on the <a href=http://stackoverflow.com/a/31485271/184842>method by IllidanS4</a>, see <a href=http://stackoverflow.com/questions/10574645/the-fastest-way-to-check-if-a-type-is-blittable>The fastest way to check if a type is blittable?</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>BlittableHelper</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=kt>bool</span> <span class=n>IsBlittable</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>IsBlittableCache</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;.</span><span class=n>Value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=kt>bool</span> <span class=n>IsBlittable</span><span class=p>(</span><span class=k>this</span> <span class=n>Type</span> <span class=n>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>type</span><span class=p>.</span><span class=n>IsArray</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>elem</span> <span class=p>=</span> <span class=n>type</span><span class=p>.</span><span class=n>GetElementType</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>elem</span><span class=p>.</span><span class=n>IsValueType</span> <span class=p>&amp;&amp;</span> <span class=n>IsBlittable</span><span class=p>(</span><span class=n>elem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>object</span> <span class=n>instance</span> <span class=p>=</span> <span class=n>FormatterServices</span><span class=p>.</span><span class=n>GetUninitializedObject</span><span class=p>(</span><span class=n>type</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>GCHandle</span><span class=p>.</span><span class=n>Alloc</span><span class=p>(</span><span class=n>instance</span><span class=p>,</span> <span class=n>GCHandleType</span><span class=p>.</span><span class=n>Pinned</span><span class=p>).</span><span class=n>Free</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>catch</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>IsBlittableCache</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=k>static</span> <span class=k>readonly</span> <span class=kt>bool</span> <span class=n>Value</span> <span class=p>=</span> <span class=n>IsBlittable</span><span class=p>(</span><span class=k>typeof</span><span class=p>(</span><span class=n>T</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>However, there is one type that broke our approach: decimal. Surprisingly, but you can allocate a pinned decimal. And you can&rsquo;t allocate a pinned instance of value types that contains decimal field (because decimal is non-blittable). I don&rsquo;t know other such types. So, we probably can write a hack in the <code>IsBlittable</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=p>==</span> <span class=k>typeof</span><span class=p>(</span><span class=kt>decimal</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
</span></span></code></pre></div><p>If you know a general solution, I&rsquo;ll be glad to discuss it.</p><h3 id=coreclr-sources>CoreCLR sources</h3><p>Nowadays, we have open source CoreCLR. So, we can look inside the runtime and find something interesting. An interesting file is <a href=https://github.com/dotnet/coreclr/blob/master/src/vm/fieldmarshaler.cpp#L283-L318>fieldmarshaler.cpp</a>, it contains the following lines:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>if</span> <span class=p>(!(*</span><span class=n>pfDisqualifyFromManagedSequential</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// This type may qualify for ManagedSequential. Collect managed size and alignment info.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>CorTypeInfo</span><span class=p>::</span><span class=n>IsPrimitiveType</span><span class=p>(</span><span class=n>corElemType</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>pfwalk</span><span class=p>-&gt;</span><span class=n>m_managedSize</span> <span class=p>=</span> <span class=p>((</span><span class=n>UINT32</span><span class=p>)</span><span class=n>CorTypeInfo</span><span class=p>::</span><span class=n>Size</span><span class=p>(</span><span class=n>corElemType</span><span class=p>));</span> <span class=c1>// Safe cast - no primitive type is larger than 4gb!</span>
</span></span><span class=line><span class=cl>        <span class=n>pfwalk</span><span class=p>-&gt;</span><span class=n>m_managedAlignmentReq</span> <span class=p>=</span> <span class=n>pfwalk</span><span class=p>-&gt;</span><span class=n>m_managedSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>corElemType</span> <span class=p>==</span> <span class=n>ELEMENT_TYPE_PTR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>pfwalk</span><span class=p>-&gt;</span><span class=n>m_managedSize</span> <span class=p>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>LPVOID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pfwalk</span><span class=p>-&gt;</span><span class=n>m_managedAlignmentReq</span> <span class=p>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>LPVOID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>corElemType</span> <span class=p>==</span> <span class=n>ELEMENT_TYPE_VALUETYPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TypeHandle</span> <span class=n>pNestedType</span> <span class=p>=</span> <span class=n>fsig</span><span class=p>.</span><span class=n>GetLastTypeHandleThrowing</span><span class=p>(</span><span class=n>ClassLoader</span><span class=p>::</span><span class=n>LoadTypes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                                <span class=n>CLASS_LOAD_APPROXPARENTS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                                <span class=n>TRUE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>pNestedType</span><span class=p>.</span><span class=n>GetMethodTable</span><span class=p>()-&gt;</span><span class=n>IsManagedSequential</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>pfwalk</span><span class=p>-&gt;</span><span class=n>m_managedSize</span> <span class=p>=</span> <span class=p>(</span><span class=n>pNestedType</span><span class=p>.</span><span class=n>GetMethodTable</span><span class=p>()-&gt;</span><span class=n>GetNumInstanceFieldBytes</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>_ASSERTE</span><span class=p>(</span><span class=n>pNestedType</span><span class=p>.</span><span class=n>GetMethodTable</span><span class=p>()-&gt;</span><span class=n>HasLayout</span><span class=p>());</span> <span class=c1>// If it is ManagedSequential(), it also has Layout but doesn&#39;t hurt to check before we do a cast!</span>
</span></span><span class=line><span class=cl>            <span class=n>pfwalk</span><span class=p>-&gt;</span><span class=n>m_managedAlignmentReq</span> <span class=p>=</span> <span class=n>pNestedType</span><span class=p>.</span><span class=n>GetMethodTable</span><span class=p>()-&gt;</span><span class=n>GetLayoutInfo</span><span class=p>()-&gt;</span><span class=n>m_ManagedLargestAlignmentRequirementOfAllMembers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>*</span><span class=n>pfDisqualifyFromManagedSequential</span> <span class=p>=</span> <span class=n>TRUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// No other type permitted for ManagedSequential.</span>
</span></span><span class=line><span class=cl>        <span class=p>*</span><span class=n>pfDisqualifyFromManagedSequential</span> <span class=p>=</span> <span class=n>TRUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=explanation-of-the-example>Explanation of the example</h3><p>Let&rsquo;s back to the first example from this post. Now we can understand why MS.NET shows different results. <code>Marshal.OffsetOf(typeof(MyStruct), "UInt128")</code> display «honest» marshalling offset (<code>0</code>). However, CLR does not guarantee anything about memory representation of our value types because it is not a blittable type:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>BlittableHelper</span><span class=p>.</span><span class=n>IsBlittable</span><span class=p>&lt;</span><span class=n>MyStruct</span><span class=p>&gt;());</span> <span class=c1>// False</span>
</span></span></code></pre></div><p>But now we know how to change the situation and make the result more predictable. Let&rsquo;s replace <code>char</code> by our wrapper:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[StructLayout(LayoutKind.Sequential)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>MyStruct</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>UInt128</span> <span class=n>UInt128</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>BlittableChar</span> <span class=n>Char</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>uInt128Adress</span> <span class=p>-</span> <span class=n>baseAddress</span><span class=p>);</span> <span class=c1>// 0</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>Marshal</span><span class=p>.</span><span class=n>OffsetOf</span><span class=p>(</span><span class=k>typeof</span><span class=p>(</span><span class=n>MyStruct</span><span class=p>),</span> <span class=s>&#34;UInt128&#34;</span><span class=p>));</span> <span class=c1>// 0</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>BlittableHelper</span><span class=p>.</span><span class=n>IsBlittable</span><span class=p>&lt;</span><span class=n>MyStruct</span><span class=p>&gt;());</span> <span class=c1>// True</span>
</span></span></code></pre></div><p>I don&rsquo;t recommend try to predict memory representation of your non-blittable types, it depends on big amount of different conditions. For example, the following modification of the example shows that non-blittable types can be represented in memory without field reordering:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[StructLayout(LayoutKind.Sequential)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>UInt128</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>ulong</span> <span class=n>Value1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>ulong</span> <span class=n>Value2</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>[StructLayout(LayoutKind.Sequential)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>MyStruct</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>UInt128</span> <span class=n>UInt128</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>char</span> <span class=n>Char</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>uInt128Adress</span> <span class=p>-</span> <span class=n>baseAddress</span><span class=p>);</span> <span class=c1>// 0</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>Marshal</span><span class=p>.</span><span class=n>OffsetOf</span><span class=p>(</span><span class=k>typeof</span><span class=p>(</span><span class=n>MyStruct</span><span class=p>),</span> <span class=s>&#34;UInt128&#34;</span><span class=p>));</span> <span class=c1>// 0</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>BlittableHelper</span><span class=p>.</span><span class=n>IsBlittable</span><span class=p>&lt;</span><span class=n>MyStruct</span><span class=p>&gt;());</span> <span class=c1>// False</span>
</span></span></code></pre></div><h3 id=nuget--github>NuGet & GitHub</h3><p>I pushed my blittable wrappers to GitHub and publish a NuGet package:</p><ul><li><a href=https://github.com/AndreyAkinshin/BlittableStructs>https://github.com/AndreyAkinshin/BlittableStructs</a></li><li><a href=https://www.nuget.org/packages/BlittableStructs/>https://www.nuget.org/packages/BlittableStructs/</a></li></ul><p>I hope, it will be useful for someone. If you have any good ideas about blittable wrappers, PRs are welcome.</p><h3 id=links>Links</h3><ul><li><a href=https://msdn.microsoft.com/en-us/library/75dwhxf7.aspx>MSDN: Blittable and Non-Blittable Types</a></li><li><a href=https://msdn.microsoft.com/en-us/library/zah6xy75.aspx>MSDN: Default Marshaling Behavior</a></li><li><a href=https://msdn.microsoft.com/en-us/library/s9ts558h.aspx>MSDN: Default Marshaling for Strings</a></li><li><a href=https://msdn.microsoft.com/en-us/library/7b93s42f.aspx>MSDN: Specifying a Character Set</a></li><li><a href=https://msdn.microsoft.com/en-us/library/cwe8bzh0.aspx>MSDN: Unicode and MBCS</a></li><li><a href=https://msdn.microsoft.com/en-us/library/23acw07k.aspx>MSDN: Copying and Pinning</a></li><li><a href=https://msdn.microsoft.com/library/y8ewk18b.aspx>MSDN: Marshal.OffsetOf</a></li><li><a href=https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.structlayoutattribute.aspx>MSDN: System.Runtime.InteropServices.StructLayoutAttribute</a></li><li><a href=https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.layoutkind.aspx>MSDN: System.Runtime.InteropServices.LayoutKind</a></li><li><a href=https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.structlayoutattribute.charset.aspx>MSDN: System.Runtime.InteropServices.StructLayoutAttribute.CharSet</a></li><li><a href=https://en.wikipedia.org/wiki/Globally_unique_identifier>Wikipedia: Globally unique identifier</a></li><li><a href=https://en.wikipedia.org/wiki/Universally_unique_identifier>Wikipedia: Universally unique identifier</a></li><li><a href=https://en.wikipedia.org/wiki/Endianness>Wikipedia: Endianness</a></li><li><a href=http://stackoverflow.com/questions/10574645/the-fastest-way-to-check-if-a-type-is-blittable>Stackoverflow: The fastest way to check if a type is blittable?</a></li><li><a href=http://stackoverflow.com/questions/11416433/marshalling-non-blittable-structs-from-c-sharp-to-c>Stackoverflow: Marshalling non-Blittable Structs from C# to C++</a></li><li><a href=http://stackoverflow.com/questions/30213132/why-is-decimal-data-type-non-blittable>Stackoverflow: Why is “decimal” data type non-blittable?</a></li><li><a href=http://stackoverflow.com/questions/15544818/non-blitable-error-on-a-blitable-type>Stackoverflow: Non-blitable error on a blitable type</a></li><li><a href=http://stackoverflow.com/questions/17510042/using-reflection-to-determine-how-a-net-type-is-layed-out-in-memory>Stackoverflow: Using reflection to determine how a .Net type is layed out in memory</a></li><li><a href=http://stackoverflow.com/questions/5584160/are-net-enums-blittable-types-marshalling>Stackoverflow: Are .net Enums blittable types? (Marshalling)</a></li><li><a href=http://stackoverflow.com/questions/21881554/why-does-the-system-datetime-struct-have-layout-kind-auto>Stackoverflow: Why does the System.DateTime struct have layout kind Auto?</a></li><li><a href=http://stackoverflow.com/questions/4132533/why-does-layoutkind-sequential-work-differently-if-a-struct-contains-a-datetime>Stackoverflow: Why does LayoutKind.Sequential work differently if a struct contains a DateTime field?</a></li><li><a href=http://stackoverflow.com/questions/16333511/layoutkind-sequential-not-followed-when-substruct-has-layoutkind-explicit>Stackoverflow: LayoutKind.Sequential not followed when substruct has LayoutKind.Explicit</a></li><li><a href=http://stackoverflow.com/questions/246930/is-there-any-difference-between-a-guid-and-a-uuid>Stackoverflow: Is there any difference between a GUID and a UUID?</a></li><li><a href=https://github.com/dotnet/coreclr/blob/master/src/vm/fieldmarshaler.cpp>GitHub CoreCLR: coreclr/src/vm/fieldmarshaler.cpp</a></li><li><a href=http://referencesource.microsoft.com/#mscorlib/system/guid.cs>Microsoft Reference Source: GUID</a></li><li><a href=http://referencesource.microsoft.com/#mscorlib/system/datetime.cs>Microsoft Reference Source: DateTime</a></li><li><a href=https://tools.ietf.org/html/rfc4122>RFC 4122</a></li><li><a href=http://docs.oracle.com/javase/8/docs/api/java/util/UUID.html>Java UUID</a></li><li><a href=http://blog.stephencleary.com/2010/11/few-words-on-guids.html>Stephen Cleary: A Few Words on GUIDs</a></li></ul></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fblittable%2f&title=Blittable%20types" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=Blittable%20types&url=https%3a%2f%2faakinshin.net%2fposts%2fblittable%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fblittable%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fblittable%2f&title=Blittable%20types" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2022 Andrey Akinshin</span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>anchors.options={placement:"left",icon:"§"},anchors.add("h1"),anchors.add("h2"),anchors.add("h3")</script></body></html>