<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Mathematics,Statistics,Research,Quantile,Harrell-Davis quantile estimator,Exponential smoothing,Moving Quantile,MAD,IQR"><title>Dispersion exponential smoothing | Andrey Akinshin</title><meta name=description content="In this previous post, I showed how to apply exponential smoothing to quantiles using the weighted Harrell-Davis quantile estimator. This technique allows getting smooth and stable moving median estimations. In this post, I&amp;rsquo;m going to discuss how to u..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.fe1c45a5bb1462c47792274eba884723afa28a87c7a92405ed21b423927e7fbf.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button title="Alt+Click to match OS color theme" class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Dispersion exponential smoothing</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2021-05-11>May 11, 2021</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/mathematics/>Mathematics</a>
<a class=label-link href=https://aakinshin.net/tags/statistics/>Statistics</a>
<a class=label-link href=https://aakinshin.net/tags/research/>Research</a>
<a class=label-link href=https://aakinshin.net/tags/quantile/>Quantile</a>
<a class=label-link href=https://aakinshin.net/tags/harrell-davis-quantile-estimator/>Harrell-Davis quantile estimator</a>
<a class=label-link href=https://aakinshin.net/tags/exponential-smoothing/>Exponential smoothing</a>
<a class=label-link href=https://aakinshin.net/tags/moving-quantile/>Moving Quantile</a>
<a class=label-link href=https://aakinshin.net/tags/mad/>MAD</a>
<a class=label-link href=https://aakinshin.net/tags/iqr/>IQR</a></div></div><br><div class=main-content><p>In this <a href=https://aakinshin.net/posts/quantile-exponential-smoothing/>previous post</a>,
I showed how to apply exponential smoothing to quantiles
using the <a href=https://aakinshin.net/posts/weighted-quantiles/>weighted Harrell-Davis quantile estimator</a>.
This technique allows getting smooth and stable moving median estimations.
In this post, I&rsquo;m going to discuss how to use the same approach
to estimate moving dispersion.</p><h3 id=quantiles>Quantiles</h3><p>Let&rsquo;s briefly recall the idea of quantile exponential smoothing.
First of all, we should assign exponential weights <span class="math inline">\(w\)</span> to the given timer series <span class="math inline">\(\{ x_1, \ldots, x_n \}\)</span>
in the following way:</p><p><span class="math display">\[w_t = e^{-\lambda (n-t)}
\]</span></p><p>where <span class="math inline">\(\lambda\)</span> is the decay constant which can be expressed using the half-life value <span class="math inline">\(t_{1/2}\)</span>:</p><p><span class="math display">\[\lambda = \frac{\ln(2)}{t_{1/2}}.
\]</span></p><p>Next, we should define the weighted Harrell-Davis quantile estimation <span class="math inline">\(q^*_p\)</span> of the <span class="math inline">\(p^\textrm{th}\)</span> quantile:</p><p><span class="math display">\[q^*_p = \sum_{i=1}^{n} W^*_{i} \cdot x_i,\quad
W^*_{i} = I_{r^*_i}(a^*, b^*) - I_{l^*_i}(a^*, b^*),
\]</span></p><p><span class="math display">\[\left\{
\begin{array}{rcc}
l^*_i & = & \dfrac{s_{i-1}(w)}{s_n(w)},\\
r^*_i & = & \dfrac{s_i(w)}{s_n(w)},
\end{array}
\right.
\]</span></p><p><span class="math display">\[s_i(w) = \sum_{j=1}^i w_j,
\]</span></p><p><span class="math display">\[\left\{
\begin{array}{rccl}
a^* = & p     & \cdot & (n^* + 1),\\
b^* = & (1-p) & \cdot & (n^* + 1),
\end{array}
\right.
\]</span></p><p><span class="math display">\[n^* = \frac{\Big( \sum_{i=1}^n w_i \Big)^2}{\sum_{i=1}^n w_i^2 }
\]</span></p><p>where <span class="math inline">\(I_t(a, b)\)</span> is the
<a href=https://en.wikipedia.org/wiki/Beta_function#Incomplete_beta_function>regularized incomplete beta function</a>.</p><p>The same approach can be used with the weighted version of the classic Hyndman-Fan Type 7 quantile estimator
(details can be found <a href=https://aakinshin.net/posts/weighted-quantiles/>here</a>).</p><h3 id=dispersion>Dispersion</h3><p>Once we have a weighted quantile estimator, we can estimate moving measures of dispersion that are based
on the quantiles.
One of my favorite metrics is the <em>median absolute deviation</em> (MAD):</p><p><span class="math display">\[\textrm{MAD} = \textrm{median}(|x - \textrm{median}(x)|).
\]</span></p><p>If we want to use the MAD as the consistency estimator for the standard deviation under normality,
we should multiply the above expression by the consistency constant <span class="math inline">\(C_n\)</span>:</p><p><span class="math display">\[\textrm{MAD}_n = C_n \cdot \textrm{median}(|x - \textrm{median}(x)|).
\]</span></p><p>When the sample is big enough, we can use the asymptotic value as an approximation of <span class="math inline">\(C_n\)</span>:</p><p><span class="math display">\[C_\infty = \dfrac{1}{\Phi^{-1}(3/4)} \approx 1.4826022185056
\]</span></p><p>However, for small samples, this constant gives us a biased estimator.
In order to get the unbiased estimator, we should properly adjust the value of <span class="math inline">\(C_n\)</span>.
Note that this value depends on the used quantile estimator.
In my previous posts, I already shown how to get proper values for
the traditional quantile estimator (<a href=https://aakinshin.net/posts/unbiased-mad/>here</a>) and
the Harrell-Davis quantile estimator (<a href=https://aakinshin.net/posts/unbiased-mad-hd/>here</a>).</p><p>Another way to express the measure of dispersion is the <em>interquartile range</em> (IQR).
It&rsquo;s the difference between upper and lower quartiles:</p><p><span class="math display">\[\textrm{IQR} = Q_3 - Q_1.
\]</span></p><p>Since both the MAD and the IQR are based on quantile estimations,
we can use calculated them for a given weighted sample.</p><h3 id=an-example>An example</h3><p>When I test the moving average, I typically use noise sine wave as a primary data pattern.
With the moving dispersion, it makes sense to change the data dispersion according to the sine wave.
Let&rsquo;s look at the following figure:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/dispersion-exponential-smoothing/img/smoothing50-light.png target=_blank alt=smoothing50><img src=/posts/dispersion-exponential-smoothing/img/smoothing50-light.png width=800></a>
<a class="img-dark hidden" href=/posts/dispersion-exponential-smoothing/img/smoothing50-dark.png target=_blank alt=smoothing50><img src=/posts/dispersion-exponential-smoothing/img/smoothing50-dark.png width=800></a></div><p>In the upper image, we can observe the raw data point and
the estimated moving median using exponential smoothing with half-life = 50.
In the bottom picture, we can see the exponentially weighted MAD and IQR.
These charts do not only correspond to the actual dispersion,
but they also match the previously estimated moving median
because they are based on the same weight vector.</p></div><br><br></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}));function toggleTheme(e){e?(document.documentElement.classList.add("dark"),themeToggleLightIcon.classList.remove("hidden"),themeToggleDarkIcon.classList.add("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")}),imagesLight.forEach(e=>{e.classList.add("hidden")})):(document.documentElement.classList.remove("dark"),themeToggleDarkIcon.classList.remove("hidden"),themeToggleLightIcon.classList.add("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}),imagesDark.forEach(e=>{e.classList.add("hidden")}))}themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),event.altKey?(localStorage.removeItem("color-theme"),toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches)):localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{if(localStorage.getItem("color-theme")===null){const t=e.matches?"dark":"light";toggleTheme(t==="dark")}})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>