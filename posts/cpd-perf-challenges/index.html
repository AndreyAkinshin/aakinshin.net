<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Mathematics,Statistics,Change point detection"><title>Challenges of change point detection in CI performance data | Andrey Akinshin</title><meta name=description content="Change point detection is a popular task in various disciplines. There are many algorithms that solve this problem. For example, in Selective review of off..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.4ac0c7ef2f01d3ca1205e3c606bdce4b51eef77185a18ae7e20af21b90e1f88d.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Challenges of change point detection in CI performance data</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2022-07-19>July 19, 2022</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/mathematics/>Mathematics</a>
<a class=label-link href=https://aakinshin.net/tags/statistics/>Statistics</a>
<a class=label-link href=https://aakinshin.net/tags/cpd/>Change point detection</a></div></div><br><div class=main-content><p><a href=https://en.wikipedia.org/wiki/Change_detection>Change point detection</a> is a popular task in various disciplines.
There are many algorithms that solve this problem.
For example,
in <a href=https://arxiv.org/abs/1801.00718v3>Selective review of offline change point detection methods (2020)</a>,
the authors presented a classification of different approaches and discussed 35 algorithms.
However, not all the algorithms fit all the situations.</p><p>In this post, we consider the problem of change point detection in time series based on
software performance measurements obtained from a continuous integration (CI) server.
Examples of data sources are CI builds, unit tests, benchmarks, performance tests, and so on.
We would like to automatically find performance degradations in such time series.
Unfortunately, most of the available algorithms do not provide decent solutions for this problem.
In this post, I discuss some challenges that arise when we are looking for change points in CI performance data.</p><h3 id=basic-requirements>Basic requirements</h3><p>We start with a list of basic requirements we have for performance change point detection.</p><ul><li><strong>Unknown number of change points</strong><br>Many change point detectors require the exact number of expected change points in advance.
We do not know this number, so we need a detector that does not need this information.</li><li><strong>Computational efficiency</strong><br>When we work with a huge enterprise project, we may want to analyze millions of long-lasting time series on daily basis.
In this case, the detector&rsquo;s computational efficiency is quite important.
Even <span class="math inline">\(O(N^2)\)</span> could become a non-acceptable bottleneck.
Therefore, we would like to have something around <span class="math inline">\(O(N \log N)\)</span>.
However, the exact requirements depend on the amount of data we want to analyze.</li><li><strong>Nonparametric distributions</strong><br>Some change point detectors require normally-distributed data so that
they could track the changes in the mean or the standard deviation.
In the world of performance measurements, there are too many non-normal distributions
which we would like to support as well.</li><li><strong>Multimodal distribution support</strong><br>Some of the performance distributions are multimodal.
A change could be defined by a shift of a single mode.
We would like to support such scenarios.</li><li><strong>Heavy-tail distribution support</strong><br>Some of the performance distributions are heavy-tailed.
It means that we could expect some extreme outliers.
A performance change point detector should be robust so that its reliability is not affected by extreme values.</li><li><strong>Stability/consistency/persistency</strong><br>Let&rsquo;s say we analyzed a series of performance measurements, found some change points and sent corresponding alerts.
Next, we extended the data sample with new freshly gathered measurements and repeated the analysis.
What if the previous results don&rsquo;t match the current ones?
E.g., some change points may appear, disappear, or displace.
Should we send new alerts about freshly discovered two-week-old changes?
Such inconsistencies may bring a lot of problems and false-positive alerts.
A well-behaved performance change point detector shouldn&rsquo;t change the previously detected points,
the results of different runs should be consistent with each other.</li></ul><p>Next, we discuss some advanced challenges that should be properly solved.</p><h3 id=change-point-classification>Change point classification</h3><p>There are various types of changes.
When we start looking for change points, typically we expected to find
accelerations (performance becomes better) or
degradations (performance becomes worse).
Unfortunately, in real life, not all the changes could be unambiguously classified as accelerations or degradations.
Let&rsquo;s look at the following picture:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/cpd-perf-challenges/img/classification-light.png target=_blank alt=classification><img src=/posts/cpd-perf-challenges/img/classification-light.png width=800></a>
<a class="img-dark hidden" href=/posts/cpd-perf-challenges/img/classification-dark.png target=_blank alt=classification><img src=/posts/cpd-perf-challenges/img/classification-dark.png width=800></a></div><p>On the third plot, a unimodal distribution is split into two modes.
It means that one part of a distribution accelerated and the other one degraded.
It&rsquo;s a common effect in the performance world that could appear due to various reasons
like trade-off changes (e.g., changes in a caching strategy) or
multithreading nondeterminism (e.g., unintentional race conditions).</p><p>We should learn how to classify different types of changes properly
and we should specify formal alert criteria.
What kind of changes do we want to be aware of?</p><h3 id=ranking>Ranking</h3><p>Not all the change points are equally important.
If we automatically discover hundreds or thousands of changes,
we don&rsquo;t always have the physical ability to review all of them.
Therefore, we need some ranking strategy so that we could present only the most important and critical changes.
In addition to external business requirements,
we may consider introducing two following properties of each change point:</p><ul><li><em>Detection confidence:</em> how sure we are that we correctly find this particular change point?</li><li><em>Change magnitude:</em> what is the size of the change? (Could be expressed using absolute/relative units or effect size.)</li></ul><p>Let&rsquo;s consider a few examples.
Here is the first one:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/cpd-perf-challenges/img/ranking1-light.png target=_blank alt=ranking1><img src=/posts/cpd-perf-challenges/img/ranking1-light.png width=800></a>
<a class="img-dark hidden" href=/posts/cpd-perf-challenges/img/ranking1-dark.png target=_blank alt=ranking1><img src=/posts/cpd-perf-challenges/img/ranking1-dark.png width=800></a></div><p>Here we are quite confident that we correctly found a change point in the middle of the chart.
However, the change magnitude is not so high.
It could be a practically insignificant degradation that could be safely ignored.</p><p>Here is another example:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/cpd-perf-challenges/img/ranking2-light.png target=_blank alt=ranking2><img src=/posts/cpd-perf-challenges/img/ranking2-light.png width=800></a>
<a class="img-dark hidden" href=/posts/cpd-perf-challenges/img/ranking2-dark.png target=_blank alt=ranking2><img src=/posts/cpd-perf-challenges/img/ranking2-dark.png width=800></a></div><p>Here we have five outliers in the middle of the plot.
It could be an actual change in the values of higher distribution percentiles
that should be marked with two change points.
However, it could be just a random deviation that could be safely ignored.
While the change magnitude is high, we are not sure that this is an actual change that should be detected.</p><h3 id=metadata-support>Metadata support</h3><p>Sometimes, it&rsquo;s possible to get some valuable insights from the metadata of raw performance measurements.
Let&rsquo;s consider the following plot:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/cpd-perf-challenges/img/metadata-light.png target=_blank alt=metadata><img src=/posts/cpd-perf-challenges/img/metadata-light.png width=800></a>
<a class="img-dark hidden" href=/posts/cpd-perf-challenges/img/metadata-dark.png target=_blank alt=metadata><img src=/posts/cpd-perf-challenges/img/metadata-dark.png width=800></a></div><p>This plot combine the measurements from the main branch and all the other feature branches.
Typically, we have a small number of measurements in the main branch which is not always enough
to reliably detect change points.
We could extend the data set with measurements from the feature branches in order to obtain more reliable conclusions.
Unfortunately, this trick reduces the detection accuracy.
Indeed, once a change happened in the main branch, some feature branches based on the obsolete commits
may produce &ldquo;old-style&rdquo; measurements.
It leads to a situation where we can say that we have an obvious change here,
but we can&rsquo;t reliably detect its exact location.
Using additional metadata with branch names allows getting better results
in terms of detection confidence and location accuracy.</p><h3 id=matching-multiple-time-series>Matching multiple time series</h3><p>Now imagine that we try to find change points in multiple data series (e.g., in different unit tests):</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/cpd-perf-challenges/img/matching-light.png target=_blank alt=matching><img src=/posts/cpd-perf-challenges/img/matching-light.png width=800></a>
<a class="img-dark hidden" href=/posts/cpd-perf-challenges/img/matching-dark.png target=_blank alt=matching><img src=/posts/cpd-perf-challenges/img/matching-dark.png width=800></a></div><p>In some tests, we don&rsquo;t discover any changes.
In other tests, we discover changes, but we are not sure about their locations,
so it&rsquo;s hard to detect the exact commit that produced these changes.
A good alert message based on such data should include possible culprit commits and the list of the affected tests.
This task could be considered as multivariate change point detection with partially missing data
(some test runs may fail and we have to exclude the corresponding measurements from the analysis).</p><h3 id=distance-between-change-points>Distance between change points</h3><p>Let&rsquo;s consider another timeline plot:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/cpd-perf-challenges/img/distance1-light.png target=_blank alt=distance1><img src=/posts/cpd-perf-challenges/img/distance1-light.png width=800></a>
<a class="img-dark hidden" href=/posts/cpd-perf-challenges/img/distance1-dark.png target=_blank alt=distance1><img src=/posts/cpd-perf-challenges/img/distance1-dark.png width=800></a></div><p>Do we have a change point here?
We can&rsquo;t reliably claim this because the data set is quite small.
Such a picture could be obtained by chance.
When we analyze thousands of time series, there is a high probability of obtaining small &ldquo;pseudo-clusters&rdquo;
without any actual changes in the source code.</p><p>A typical solution for such kind of problem is to introduce a requirement for minimum cluster size
(or for the minimum distance between change points).
Usually, I require 20-30 measurements between change points to keep the false-positive rate low.</p><p>Now let&rsquo;s consider another timeline plot:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/cpd-perf-challenges/img/distance2-light.png target=_blank alt=distance2><img src=/posts/cpd-perf-challenges/img/distance2-light.png width=800></a>
<a class="img-dark hidden" href=/posts/cpd-perf-challenges/img/distance2-dark.png target=_blank alt=distance2><img src=/posts/cpd-perf-challenges/img/distance2-dark.png width=800></a></div><p>Obviously, we have a series of degradations here.
However, all the obtained clusters are too small (only five data points in each cluster).
With a requirement on the distance between change points,
we will not be able to mark all the suspicious places as change points.
Moreover, some of them may be pseudo-changes that were obtained by chance from the same sources.
It&rsquo;s also impossible to rank these suspicious change point candidates, all of them look almost the same.</p><p>Meanwhile, we have an obvious problem here.
This problem should be definitely reported.
But how should we choose the location of change points to report?
We could pick random ones according to the requirement on the distance between change points,
but how do we guarantee the persistence of the results?
If we pick different partitions each time, it would lead to a huge number of alters (a situation that we want to avoid).</p><h3 id=conclusion>Conclusion</h3><p>Change point detection is a difficult problem in any context.
Additional task specifications from the domain area may make this problem even more difficult.
Partial solutions may be useless if they produce too many false-positive alerts.
How to choose a proper algorithm that satisfies all the requirements at the same time?
It&rsquo;s an excellent question.
Unfortunately, I don&rsquo;t have a silver bullet that fits any context and works without problems.
However, I have some approaches that could be &ldquo;good enough&rdquo; under special circumstances.
In future posts, I will speculate about some of the possible solutions.</p></div><br><br><div class="flex flex-wrap justify-center items-center">The source code of this post and all the relevant files are&nbsp;<a href=https://github.com/AndreyAkinshin/aakinshin.net/tree/master/content/en/posts/2022/07/cpd-perf-challenges/index.md>available on GitHub</a>.</div><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fcpd-perf-challenges%2f&title=Challenges%20of%20change%20point%20detection%20in%20CI%20performance%20data" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=Challenges%20of%20change%20point%20detection%20in%20CI%20performance%20data&url=https%3a%2f%2faakinshin.net%2fposts%2fcpd-perf-challenges%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fcpd-perf-challenges%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fcpd-perf-challenges%2f&title=Challenges%20of%20change%20point%20detection%20in%20CI%20performance%20data" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>