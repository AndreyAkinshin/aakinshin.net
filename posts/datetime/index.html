<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,Timers,Internals"><title>DateTime under the hood | Andrey Akinshin</title><meta name=description content="Update: You can find an updated and significantly improved version of this post in my book &amp;ldquo;Pro .NET Benchmarking&amp;rdquo;.
DateTime is a widely used ...."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script src=https://cdn.tailwindcss.com/3.2.4></script>
<script>tailwind.config={darkMode:"class"}</script><style type=text/tailwindcss>
    @layer base {
       
       
      body {
        @apply bg-white dark:bg-zinc-800;
        @apply text-black dark:text-gray-400;
      }
      nav {
        @apply bg-sky-800 dark:bg-zinc-900;
      }
      a {
        @apply text-sky-600 dark:text-white;
        @apply no-underline;
      }
      .main-content a:not(.label-link) {
        @apply hover:underline;
      }
      hr {
        @apply h-px my-3 border-0 bg-gray-300 dark:bg-gray-600;
      }
      h1, h2, h3, h4, h5, h6 {
        @apply leading-tight;
      }
      h1, h2, h3 {
        @apply text-4xl py-4;
      }
      h4 {
        @apply text-3xl py-3;
      }
      h5, h6 {
        @apply text-2xl py-2;
      }
      table {
        @apply border self-center mx-auto;
      }
      th, td {
        @apply border p-2
      }
      blockquote {
        @apply border-l-8 border-gray-300 bg-gray-100 dark:border-zinc-600 dark:bg-zinc-700;
        @apply ml-4 my-4 pl-4 py-2;
      }

       
      .main ul {
        @apply list-disc ml-10 my-2;
      }
      .main ol {
        @apply list-decimal ml-10 my-2;
      }
      .main p {
        @apply mb-3;
      }

       
      .label {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-gray-400 dark:border-gray-500;
      }
      .label-link {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-sky-600 dark:border-slate-400;
        @apply hover:bg-sky-200 dark:hover:bg-gray-500;
      }
      .nav-item {
        @apply text-white hover:bg-sky-700 dark:hover:bg-gray-700;
      }

       
      .paginator {
        @apply flex flex-wrap justify-center mb-4;
      }
      .paginator .page-item {
        @apply inline-flex border rounded px-3 py-1;
      }
      .paginator .page-item:not(.active):not(.disabled) {
        @apply border-gray-400 dark:border-gray-400;
      }
      .paginator .page-item.active {
        @apply border-sky-600 dark:border-white;
      }
      .paginator .page-item.disabled {
        @apply bg-gray-50 dark:bg-gray-500 dark:border-gray-400;
      }
      .paginator .page-item.disabled a {
        @apply text-gray-400 dark:text-gray-400;
      }

       
      .anchorjs-link {
        transition: all .25s linear;
      }
      *:hover > .anchorjs-link {
        margin-left: -1.125em !important;
      }

       
      .block-example {
        margin-top: 10px;
        margin-bottom: 10px;
      
        margin-left: 10px;
        padding-left: 10px;
      
        border-left: 5px solid;
        border-color: grey;
      }
      .block-example-title::before {  
        counter-increment: example;
        content: "Example " counter(example);
      }
      body {
        counter-reset: example;
      }

       
      #about-profiles svg {
        margin-right: 0.7rem;
      }
      #about p, #about ul {
        margin-top: 0rem;
        margin-bottom: 0rem;
      }
      #about ol {
        @apply ml-10;
      }
      #about img {
        height: 18px;
        @apply inline-flex;
      }
      .about-compact p {
        text-indent: 20px !important;
        margin: 0 !important;
      }

       
      .d-none { display:none; }

       
      code.has-jax {
        -webkit-font-smoothing: antialiased;
        background: inherit !important;
        border: none !important;
        font-size: 100%;
      }

       
      .fai {
        @apply inline-flex;
        height: 1.2em;
        width: 1.2em;
        padding-right: 0.4em;
        fill: currentColor;
      }
      .fai-link {
        @apply hover:text-sky-400 dark:hover:text-blue-400;
      }
      .label-link .fai {
        @apply pl-1 pb-1;
        height: 1.5em;
        width: 1.5em;
      }

       
      .chroma {
        @apply my-5 overflow-y-scroll;
        border-radius: 3px;
        border: 1px solid #C3CCD0;
        padding: 0.5em;
      }
        .chroma { background-color: #ffffff }
        .chroma .x {  }
        .chroma .err { color: #a61717; background-color: #e3d2d2 }
        .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
        .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
        .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
        .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
        .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
        .chroma .k { color: #000000; font-weight: bold }
        .chroma .kc { color: #000000; font-weight: bold }
        .chroma .kd { color: #000000; font-weight: bold }
        .chroma .kn { color: #000000; font-weight: bold }
        .chroma .kp { color: #000000; font-weight: bold }
        .chroma .kr { color: #000000; font-weight: bold }
        .chroma .kt { color: #445588; font-weight: bold }
        .chroma .n {  }
        .chroma .na { color: #008080 }
        .chroma .nb { color: #0086b3 }
        .chroma .bp { color: #999999 }
        .chroma .nc { color: #445588; font-weight: bold }
        .chroma .no { color: #008080 }
        .chroma .nd { color: #3c5d5d; font-weight: bold }
        .chroma .ni { color: #800080 }
        .chroma .ne { color: #990000; font-weight: bold }
        .chroma .nf { color: #990000; font-weight: bold }
        .chroma .fm {  }
        .chroma .nl { color: #990000; font-weight: bold }
        .chroma .nn { color: #555555 }
        .chroma .nx {  }
        .chroma .py {  }
        .chroma .nt { color: #000080 }
        .chroma .nv { color: #008080 }
        .chroma .vc { color: #008080 }
        .chroma .vg { color: #008080 }
        .chroma .vi { color: #008080 }
        .chroma .vm {  }
        .chroma .l {  }
        .chroma .ld {  }
        .chroma .s { color: #dd1144 }
        .chroma .sa { color: #dd1144 }
        .chroma .sb { color: #dd1144 }
        .chroma .sc { color: #dd1144 }
        .chroma .dl { color: #dd1144 }
        .chroma .sd { color: #dd1144 }
        .chroma .s2 { color: #dd1144 }
        .chroma .se { color: #dd1144 }
        .chroma .sh { color: #dd1144 }
        .chroma .si { color: #dd1144 }
        .chroma .sx { color: #dd1144 }
        .chroma .sr { color: #009926 }
        .chroma .s1 { color: #dd1144 }
        .chroma .ss { color: #990073 }
        .chroma .m { color: #009999 }
        .chroma .mb { color: #009999 }
        .chroma .mf { color: #009999 }
        .chroma .mh { color: #009999 }
        .chroma .mi { color: #009999 }
        .chroma .il { color: #009999 }
        .chroma .mo { color: #009999 }
        .chroma .o { color: #000000; font-weight: bold }
        .chroma .ow { color: #000000; font-weight: bold }
        .chroma .p {  }
        .chroma .c { color: #999988; font-style: italic }
        .chroma .ch { color: #999988; font-style: italic }
        .chroma .cm { color: #999988; font-style: italic }
        .chroma .c1 { color: #999988; font-style: italic }
        .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
        .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
        .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
        .chroma .g {  }
        .chroma .gd { color: #000000; background-color: #ffdddd }
        .chroma .ge { color: #000000; font-style: italic }
        .chroma .gr { color: #aa0000 }
        .chroma .gh { color: #999999 }
        .chroma .gi { color: #000000; background-color: #ddffdd }
        .chroma .go { color: #888888 }
        .chroma .gp { color: #555555 }
        .chroma .gs { font-weight: bold }
        .chroma .gu { color: #aaaaaa }
        .chroma .gt { color: #aa0000 }
        .chroma .gl { text-decoration: underline }
        .chroma .w { color: #bbbbbb }
        .dark.chroma { color: #f8f8f2; background-color: #272822 }
        .dark .chroma { color: #f8f8f2; background-color: #272822 }
        .dark .chroma .x {  }
        .dark .chroma .err { color: #960050; background-color: #1e0010 }
        .dark .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
        .dark .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
        .dark .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
        .dark .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
        .dark .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
        .dark .chroma .k { color: #66d9ef }
        .dark .chroma .kc { color: #66d9ef }
        .dark .chroma .kd { color: #66d9ef }
        .dark .chroma .kn { color: #f92672 }
        .dark .chroma .kp { color: #66d9ef }
        .dark .chroma .kr { color: #66d9ef }
        .dark .chroma .kt { color: #66d9ef }
        .dark .chroma .n {  }
        .dark .chroma .na { color: #a6e22e }
        .dark .chroma .nb {  }
        .dark .chroma .bp {  }
        .dark .chroma .nc { color: #a6e22e }
        .dark .chroma .no { color: #66d9ef }
        .dark .chroma .nd { color: #a6e22e }
        .dark .chroma .ni {  }
        .dark .chroma .ne { color: #a6e22e }
        .dark .chroma .nf { color: #a6e22e }
        .dark .chroma .fm {  }
        .dark .chroma .nl {  }
        .dark .chroma .nn {  }
        .dark .chroma .nx { color: #a6e22e }
        .dark .chroma .py {  }
        .dark .chroma .nt { color: #f92672 }
        .dark .chroma .nv {  }
        .dark .chroma .vc {  }
        .dark .chroma .vg {  }
        .dark .chroma .vi {  }
        .dark .chroma .vm {  }
        .dark .chroma .l { color: #ae81ff }
        .dark .chroma .ld { color: #e6db74 }
        .dark .chroma .s { color: #e6db74 }
        .dark .chroma .sa { color: #e6db74 }
        .dark .chroma .sb { color: #e6db74 }
        .dark .chroma .sc { color: #e6db74 }
        .dark .chroma .dl { color: #e6db74 }
        .dark .chroma .sd { color: #e6db74 }
        .dark .chroma .s2 { color: #e6db74 }
        .dark .chroma .se { color: #ae81ff }
        .dark .chroma .sh { color: #e6db74 }
        .dark .chroma .si { color: #e6db74 }
        .dark .chroma .sx { color: #e6db74 }
        .dark .chroma .sr { color: #e6db74 }
        .dark .chroma .s1 { color: #e6db74 }
        .dark .chroma .ss { color: #e6db74 }
        .dark .chroma .m { color: #ae81ff }
        .dark .chroma .mb { color: #ae81ff }
        .dark .chroma .mf { color: #ae81ff }
        .dark .chroma .mh { color: #ae81ff }
        .dark .chroma .mi { color: #ae81ff }
        .dark .chroma .il { color: #ae81ff }
        .dark .chroma .mo { color: #ae81ff }
        .dark .chroma .o { color: #f92672 }
        .dark .chroma .ow { color: #f92672 }
        .dark .chroma .p {  }
        .dark .chroma .c { color: #75715e }
        .dark .chroma .ch { color: #75715e }
        .dark .chroma .cm { color: #75715e }
        .dark .chroma .c1 { color: #75715e }
        .dark .chroma .cs { color: #75715e }
        .dark .chroma .cp { color: #75715e }
        .dark .chroma .cpf { color: #75715e }
        .dark .chroma .g {  }
        .dark .chroma .gd { color: #f92672 }
        .dark .chroma .ge { font-style: italic }
        .dark .chroma .gr {  }
        .dark .chroma .gh {  }
        .dark .chroma .gi { color: #a6e22e }
        .dark .chroma .go {  }
        .dark .chroma .gp {  }
        .dark .chroma .gs { font-weight: bold }
        .dark .chroma .gu { color: #75715e }
        .dark .chroma .gt {  }
        .dark .chroma .gl {  }
        .dark .chroma .w {  }
    }
  </style><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-6 h-6"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>DateTime under the hood</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai"><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-08-19>August 19, 2016</time><svg class="fai ml-3"><use xlink:href="/img/fa/all.svg#tag"/></svg>
<a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/timers/>Timers</a>
<a class=label-link href=https://aakinshin.net/tags/internals/>Internals</a></div><br><div class=main-content><p><strong>Update:</strong>
You can find an updated and significantly improved version of this post in my book <a href=/prodotnetbenchmarking/>&ldquo;Pro .NET Benchmarking&rdquo;</a>.</p><p><a href=https://msdn.microsoft.com/library/system.datetime.aspx>DateTime</a> is a widely used .NET type. A lot of developers use it all the time, but not all of them really know how it works. In this post, I discuss <a href=https://msdn.microsoft.com/library/system.datetime.utcnow.aspx>DateTime.UtcNow</a>: how it&rsquo;s implemented, what the latency and the resolution of <code>DateTime</code> on Windows and Linux, how the resolution can be changed, and how it can affect your application. This post is an overview, so you probably will not see super detailed explanations of some topics, but you will find a lot of useful links for further reading.</p><hr><h3 id=source>Source</h3><p>In the .NET Framework, the <code>DateTime</code> struct is represented by a <code>long</code> value called <a href=https://msdn.microsoft.com/library/system.datetime.ticks.aspx>Ticks</a>. One tick equals to <code>100 ns</code>, ticks are counted starting from 12:00 AM January 1, year 1 A.D. (Gregorian Calendar).</p><p>In Windows, there is another structure for time called <a href=https://msdn.microsoft.com/library/windows/desktop/ms724284.aspx>FILETIME</a>. It also uses <code>100 ns</code>-ticks, but the starting point is January 1, 1601 (UTC). You can get current <code>FILETIME</code> via <a href=https://msdn.microsoft.com/en-us/library/windows/desktop/ms724397.aspx>GetSystemTimeAsFileTime</a>.</p><p>Now, let&rsquo;s look at the source code of <code>DateTime</code> in the coreclr repo: <a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/mscorlib/src/System/DateTime.cs>DateTime.cs</a> (<a href=http://referencesource.microsoft.com/#mscorlib/system/datetime.cs>the corresponded class</a> in the Full .NET Framework looks almost the same; Mono uses code from the full framework directly). The implementation is based on <code>GetSystemTimeAsFileTime</code> and use <a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/mscorlib/src/System/DateTime.cs#L93>FileTimeOffset</a> for conversion. A simplified version of <code>UtcNow</code> from <a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/mscorlib/src/System/DateTime.cs#L915>DateTime.cs</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=n>DateTime</span> <span class=n>UtcNow</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>long</span> <span class=n>ticks</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ticks</span> <span class=p>=</span> <span class=n>GetSystemTimeAsFileTime</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>DateTime</span><span class=p>(</span> <span class=p>((</span><span class=n>UInt64</span><span class=p>)(</span><span class=n>ticks</span> <span class=p>+</span> <span class=n>FileTimeOffset</span><span class=p>))</span> <span class=p>|</span> <span class=n>KindUtc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>[MethodImplAttribute(MethodImplOptions.InternalCall)]</span>
</span></span><span class=line><span class=cl><span class=k>internal</span> <span class=k>static</span> <span class=k>extern</span> <span class=kt>long</span> <span class=n>GetSystemTimeAsFileTime</span><span class=p>();</span>
</span></span></code></pre></div><p>You may have noticed <code>KindUtc</code> in the constructor argument. In fact, <code>DateTime</code> keeps actual <code>Ticks</code> only in bits 01-62 of the <a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/mscorlib/src/System/DateTime.cs#L137>dateData</a> field; bits 63-64 are used for <a href=https://msdn.microsoft.com/en-us/library/shx7s921.aspx>DateTimeKind</a> (<code>Local</code>, <code>Utc</code>, or <code>Unspecified</code>).</p><p><code>extern long GetSystemTimeAsFileTime()</code> is implemented as follows: on Windows, it uses the <a href=https://msdn.microsoft.com/library/windows/desktop/ms724397.aspx>GetSystemTimeAsFileTime</a> function from <a href=https://en.wikipedia.org/wiki/Windows.h>windows.h</a>, on Unix it uses <a href=http://man7.org/linux/man-pages/man2/gettimeofday.2.html>gettimeofday</a> and transforms the received value from the <a href=https://en.wikipedia.org/wiki/Unix_time>Unix epoch</a> (<em>January 1, 1970</em>) to the Win32 epoch (<em>January 1, 1601</em>).</p><p>Let&rsquo;s dive deeper into the source code for CoreCLR and Mono (you can skip the next two sections if you are not interested in the implementation details).</p><h4 id=coreclr-v100>CoreCLR v1.0.0</h4><p><a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/vm/ecalllist.h#L2219>src/vm/ecalllist.h</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>FCClassElement</span><span class=p>(</span><span class=s>&#34;DateTime&#34;</span><span class=p>,</span> <span class=s>&#34;System&#34;</span><span class=p>,</span> <span class=n>gDateTimeFuncs</span><span class=p>)</span>
</span></span></code></pre></div><p><a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/vm/ecalllist.h#L279>src/vm/ecalllist.h</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>FCFuncStart</span><span class=p>(</span><span class=n>gDateTimeFuncs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>FCFuncElement</span><span class=p>(</span><span class=s>&#34;GetSystemTimeAsFileTime&#34;</span><span class=p>,</span> <span class=n>SystemNative</span><span class=o>::</span><span class=n>__GetSystemTimeAsFileTime</span><span class=p>)</span>
</span></span></code></pre></div><p><a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/classlibnative/bcltype/system.cpp#L48>classlibnative/bcltype/system.cpp/system.cpp</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>FCIMPL0</span><span class=p>(</span><span class=n>INT64</span><span class=p>,</span> <span class=n>SystemNative</span><span class=o>::</span><span class=n>__GetSystemTimeAsFileTime</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FCALL_CONTRACT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>INT64</span> <span class=n>timestamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>::</span><span class=n>GetSystemTimeAsFileTime</span><span class=p>((</span><span class=n>FILETIME</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>timestamp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if BIGENDIAN
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>timestamp</span> <span class=o>=</span> <span class=p>(</span><span class=n>INT64</span><span class=p>)(((</span><span class=n>UINT64</span><span class=p>)</span><span class=n>timestamp</span> <span class=o>&gt;&gt;</span> <span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=n>UINT64</span><span class=p>)</span><span class=n>timestamp</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>timestamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>FCIMPLEND</span><span class=p>;</span>
</span></span></code></pre></div><p>You can find the definition of <code>FCIMPL0</code> in <a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/vm/fcall.h>src/vm/fcall.h</a>.</p><p><a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/pal/src/file/filetime.cpp#L502>pal/src/file/filetime.cpp</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>VOID</span>
</span></span><span class=line><span class=cl><span class=n>PALAPI</span>
</span></span><span class=line><span class=cl><span class=nf>GetSystemTimeAsFileTime</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>OUT</span> <span class=n>LPFILETIME</span> <span class=n>lpSystemTimeAsFileTime</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>timeval</span> <span class=n>Time</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PERF_ENTRY</span><span class=p>(</span><span class=n>GetSystemTimeAsFileTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ENTRY</span><span class=p>(</span><span class=s>&#34;GetSystemTimeAsFileTime(lpSystemTimeAsFileTime=%p)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>          <span class=n>lpSystemTimeAsFileTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>gettimeofday</span><span class=p>(</span> <span class=o>&amp;</span><span class=n>Time</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ASSERT</span><span class=p>(</span><span class=s>&#34;gettimeofday() failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* no way to indicate failure, so set time to zero */</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=n>lpSystemTimeAsFileTime</span> <span class=o>=</span> <span class=n>FILEUnixTimeToFileTime</span><span class=p>(</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* use (tv_usec * 1000) because 2nd arg is in nanoseconds */</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=n>lpSystemTimeAsFileTime</span> <span class=o>=</span> <span class=n>FILEUnixTimeToFileTime</span><span class=p>(</span> <span class=n>Time</span><span class=p>.</span><span class=n>tv_sec</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                          <span class=n>Time</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>*</span> <span class=mi>1000</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>LOGEXIT</span><span class=p>(</span><span class=s>&#34;GetSystemTimeAsFileTime returns.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>PERF_EXIT</span><span class=p>(</span><span class=n>GetSystemTimeAsFileTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*++
</span></span></span><span class=line><span class=cl><span class=cm>Convert a time_t value to a win32 FILETIME structure, as described in
</span></span></span><span class=line><span class=cl><span class=cm>MSDN documentation. time_t is the number of seconds elapsed since 
</span></span></span><span class=line><span class=cl><span class=cm>00:00 01 January 1970 UTC (Unix epoch), while FILETIME represents a 
</span></span></span><span class=line><span class=cl><span class=cm>64-bit number of 100-nanosecond intervals that have passed since 00:00 
</span></span></span><span class=line><span class=cl><span class=cm>01 January 1601 UTC (win32 epoch).
</span></span></span><span class=line><span class=cl><span class=cm>--*/</span>
</span></span><span class=line><span class=cl><span class=n>FILETIME</span> <span class=nf>FILEUnixTimeToFileTime</span><span class=p>(</span> <span class=n>time_t</span> <span class=n>sec</span><span class=p>,</span> <span class=kt>long</span> <span class=n>nsec</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>__int64</span> <span class=n>Result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>FILETIME</span> <span class=n>Ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Result</span> <span class=o>=</span> <span class=p>((</span><span class=kr>__int64</span><span class=p>)</span><span class=n>sec</span> <span class=o>+</span> <span class=n>SECS_BETWEEN_1601_AND_1970_EPOCHS</span><span class=p>)</span> <span class=o>*</span> <span class=n>SECS_TO_100NS</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>nsec</span> <span class=o>/</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Ret</span><span class=p>.</span><span class=n>dwLowDateTime</span> <span class=o>=</span> <span class=p>(</span><span class=n>DWORD</span><span class=p>)</span><span class=n>Result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Ret</span><span class=p>.</span><span class=n>dwHighDateTime</span> <span class=o>=</span> <span class=p>(</span><span class=n>DWORD</span><span class=p>)(</span><span class=n>Result</span> <span class=o>&gt;&gt;</span> <span class=mi>32</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>TRACE</span><span class=p>(</span><span class=s>&#34;Unix time = [%ld.%09ld] converts to Win32 FILETIME = [%#x:%#x]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>          <span class=n>sec</span><span class=p>,</span> <span class=n>nsec</span><span class=p>,</span> <span class=n>Ret</span><span class=p>.</span><span class=n>dwHighDateTime</span><span class=p>,</span> <span class=n>Ret</span><span class=p>.</span><span class=n>dwLowDateTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=mono-44211>Mono 4.4.2.11</h4><p><a href=https://github.com/mono/mono/blob/mono-4.4.2.11/mono/metadata/icall-def.h#L135>icall-def.h</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>ICALL_TYPE</span><span class=p>(</span><span class=n>DTIME</span><span class=p>,</span> <span class=s>&#34;System.DateTime&#34;</span><span class=p>,</span> <span class=n>DTIME_1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ICALL</span><span class=p>(</span><span class=n>DTIME_1</span><span class=p>,</span> <span class=s>&#34;GetSystemTimeAsFileTime&#34;</span><span class=p>,</span> <span class=n>mono_100ns_datetime</span><span class=p>)</span>
</span></span></code></pre></div><p><a href=https://github.com/mono/mono/blob/mono-4.4.2.11/mono/utils/mono-time.c>mono-time.c</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#ifdef HOST_WIN32
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;windows.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/* Returns the number of 100ns ticks since Jan 1, 1601, UTC timezone */</span>
</span></span><span class=line><span class=cl><span class=n>gint64</span>
</span></span><span class=line><span class=cl><span class=nf>mono_100ns_datetime</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ULARGE_INTEGER</span> <span class=n>ft</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>ft</span><span class=p>)</span> <span class=o>!=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>FILETIME</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>g_assert_not_reached</span> <span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>GetSystemTimeAsFileTime</span> <span class=p>((</span><span class=n>FILETIME</span><span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>ft</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ft</span><span class=p>.</span><span class=n>QuadPart</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * Magic number to convert unix epoch start to windows epoch start
</span></span></span><span class=line><span class=cl><span class=cm> * Jan 1, 1970 into a value which is relative to Jan 1, 1601.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=cp>#define EPOCH_ADJUST    ((guint64)11644473600LL)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* Returns the number of 100ns ticks since 1/1/1601, UTC timezone */</span>
</span></span><span class=line><span class=cl><span class=n>gint64</span>
</span></span><span class=line><span class=cl><span class=nf>mono_100ns_datetime</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>timeval</span> <span class=n>tv</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>gettimeofday</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>tv</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mono_100ns_datetime_from_timeval</span> <span class=p>(</span><span class=n>tv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gint64</span>
</span></span><span class=line><span class=cl><span class=nf>mono_100ns_datetime_from_timeval</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>timeval</span> <span class=n>tv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(((</span><span class=n>gint64</span><span class=p>)</span><span class=n>tv</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>+</span> <span class=n>EPOCH_ADJUST</span><span class=p>)</span> <span class=o>*</span> <span class=mi>1000000</span> <span class=o>+</span> <span class=n>tv</span><span class=p>.</span><span class=n>tv_usec</span><span class=p>)</span> <span class=o>*</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><hr><h3 id=resolution>Resolution</h3><h4 id=windows>Windows</h4><p>As I mentioned previously, the WinAPI function for getting current time is <code>GetSystemTimeAsFileTime</code>. If you want to get the <code>FILETIME</code> with with the highest possible level of precision, you should use <a href=https://msdn.microsoft.com/library/windows/desktop/hh706895.aspx>GetSystemTimePreciseAsFileTime</a>. There is also the <a href=https://msdn.microsoft.com/en-us/library/windows/desktop/ms724390.aspx>GetSystemTime</a> function which returns <a href=https://msdn.microsoft.com/en-us/library/windows/desktop/ms724950.aspx>SYSTEMTIME</a>: it works slowly but it returns current time in a well-suited format. You can convert <code>FILETIME</code> to <code>SYSTEMTIME</code> manually with help of the <a href=https://msdn.microsoft.com/en-us/library/windows/desktop/ms724280.aspx>FileTimeToSystemTime</a> function.</p><p>In this section, only <code>GetSystemTimeAsFileTime</code> will be discussed. The resolution of this function may take different values. You can easily get the configuration of your OS with the help of the <a href=https://technet.microsoft.com/en-us/sysinternals/bb897568.aspx>ClockRes</a> utility from the <a href=https://technet.microsoft.com/en-us/sysinternals/bb842062.aspx>Sysinternals Suite</a>. Here is a typical output on my laptop:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>&gt; Clockres.exe
</span></span><span class=line><span class=cl>Clockres v2.1 - Clock resolution display utility
</span></span><span class=line><span class=cl>Copyright (C) 2016 Mark Russinovich
</span></span><span class=line><span class=cl>Sysinternals
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Maximum timer interval: 15.625 ms
</span></span><span class=line><span class=cl>Minimum timer interval: 0.500 ms
</span></span><span class=line><span class=cl>Current timer interval: 1.000 ms
</span></span></code></pre></div><p>First of all, look at the maximum timer interval: it equals to <code>15.625 ms</code> (this corresponds to a frequency of 64 <a href=https://en.wikipedia.org/wiki/Hertz>Hz</a>). It&rsquo;s my default DateTime resolution when I don&rsquo;t have any non-system running applications. This value can be changed programmatically by <em>any application</em>. For example, my current timer interval is <code>1 ms</code> (frequency = <code>1000 Hz</code>). However, there is a limit: my minimum timer interval equals to <code>0.5 ms</code> (frequency = <code>2000 Hz</code>). The current timer interval may only take value from the specified range.</p><p>It&rsquo;s a typical configuration for the modern version of Windows. However, you can observe other resolution values on the older version of Windows. For example, <a href=https://msdn.microsoft.com/library/system.datetime.utcnow.aspx#Anchor_1>according</a> to MSDN, default resolution of <code>DateTime</code> on Windows 98 is about <code>55ms</code>. You can also find a lot of useful information about different configuration here: <a href=http://www.windowstimestamp.com/description>The Windows Timestamp Project</a>.</p><h4 id=windows-resolution-api>Windows Resolution API</h4><p>So, how it can be changed? There are some Windows API which can be used: <a href=https://msdn.microsoft.com/en-us/library/dd757624.aspx>timeBeginPeriod</a>/<a href=https://msdn.microsoft.com/en-us/library/dd757626.aspx>timeEndPeriod</a> from <code>winmm.dll</code> and <code>NtQueryTimerResolution</code>/<code>NtSetTimerResolution</code> from <code>ntdll.dll</code>. You can use it directly from C#, here is a helper class for you:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>ResolutionInfo</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>uint</span> <span class=n>Min</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>uint</span> <span class=n>Max</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>uint</span> <span class=n>Current</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>WinApi</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>  [DllImport(&#34;winmm.dll&#34;, EntryPoint = &#34;timeBeginPeriod&#34;, SetLastError = true)]</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>static</span> <span class=k>extern</span> <span class=kt>uint</span> <span class=n>TimeBeginPeriod</span><span class=p>(</span><span class=kt>uint</span> <span class=n>uMilliseconds</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>  [DllImport(&#34;winmm.dll&#34;, EntryPoint = &#34;timeEndPeriod&#34;, SetLastError = true)]</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>static</span> <span class=k>extern</span> <span class=kt>uint</span> <span class=n>TimeEndPeriod</span><span class=p>(</span><span class=kt>uint</span> <span class=n>uMilliseconds</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>  [DllImport(&#34;ntdll.dll&#34;, SetLastError = true)]</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>static</span> <span class=k>extern</span> <span class=kt>uint</span> <span class=n>NtQueryTimerResolution</span><span class=p>(</span><span class=k>out</span> <span class=kt>uint</span> <span class=n>min</span><span class=p>,</span> <span class=k>out</span> <span class=kt>uint</span> <span class=n>max</span><span class=p>,</span> <span class=k>out</span> <span class=kt>uint</span> <span class=n>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>  [DllImport(&#34;ntdll.dll&#34;, SetLastError = true)]</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>static</span> <span class=k>extern</span> <span class=kt>uint</span> <span class=n>NtSetTimerResolution</span><span class=p>(</span><span class=kt>uint</span> <span class=n>desiredResolution</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>setResolution</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>ref</span> <span class=kt>uint</span> <span class=n>currentResolution</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>static</span> <span class=n>ResolutionInfo</span> <span class=n>QueryTimerResolution</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>info</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ResolutionInfo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>NtQueryTimerResolution</span><span class=p>(</span><span class=k>out</span> <span class=n>info</span><span class=p>.</span><span class=n>Min</span><span class=p>,</span> <span class=k>out</span> <span class=n>info</span><span class=p>.</span><span class=n>Max</span><span class=p>,</span> <span class=k>out</span> <span class=n>info</span><span class=p>.</span><span class=n>Current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>static</span> <span class=kt>ulong</span> <span class=n>SetTimerResolution</span><span class=p>(</span><span class=kt>uint</span> <span class=n>ticks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint</span> <span class=n>currentRes</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>NtSetTimerResolution</span><span class=p>(</span><span class=n>ticks</span><span class=p>,</span> <span class=k>true</span><span class=p>,</span> <span class=k>ref</span> <span class=n>currentRes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>currentRes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now let&rsquo;s play a little bit with this class. First of all, we can write own <code>ClockRes</code> based on the described API:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>resolutioInfo</span> <span class=p>=</span> <span class=n>WinApi</span><span class=p>.</span><span class=n>QueryTimerResolution</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>$&#34;Min     = {resolutioInfo.Min}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>$&#34;Max     = {resolutioInfo.Max}&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>$&#34;Current = {resolutioInfo.Current}&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>Output (without any running apps):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Min     = 156250
</span></span><span class=line><span class=cl>Max     = 5000
</span></span><span class=line><span class=cl>Current = 156250
</span></span></code></pre></div><p>Now, let&rsquo;s manually check that <code>resolutioInfo.Current</code> is the actual resolution of <code>DateTime</code>. Here is a very simple code which shows observed <code>DateTime</code> behaviour:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>10</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>current</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>UtcNow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>last</span> <span class=p>=</span> <span class=n>current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=n>last</span> <span class=p>==</span> <span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>current</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>UtcNow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>diff</span> <span class=p>=</span> <span class=n>current</span> <span class=p>-</span> <span class=n>last</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>diff</span><span class=p>.</span><span class=n>Ticks</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Typical output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>155934
</span></span><span class=line><span class=cl>156101
</span></span><span class=line><span class=cl>156237
</span></span><span class=line><span class=cl>156256
</span></span><span class=line><span class=cl>156237
</span></span></code></pre></div><p>As you can see, the received numbers are not exactly equal to <code>156250</code>. So, the difference between two sequential different <code>DateTime</code> values is approximately equal to the current timer interval.</p><h4 id=powercfg>powercfg</h4><p>For example, your current timer interval is not the maximum timer interval. How do you know who&rsquo;s to blame? Which program increased the system timer frequency? You can check it with the help of <a href=https://en.wikipedia.org/wiki/Powercfg>powercfg</a>. For example, run the following command as administrator:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>powercfg -energy duration 10
</span></span></code></pre></div><p>This command will monitor you system for 10 seconds and generate an html report (<code>energy-report.html</code> in the current directory) with a lot of useful information include information about Platform Timer Resolution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Platform Timer Resolution:Platform Timer Resolution
</span></span><span class=line><span class=cl>The default platform timer resolution is 15.6ms (15625000ns) and should be used whenever the system is idle.
</span></span><span class=line><span class=cl>If the timer resolution is increased, processor power management technologies may not be effective.
</span></span><span class=line><span class=cl>The timer resolution may be increased due to multimedia playback or graphical animations.
</span></span><span class=line><span class=cl>  Current Timer Resolution (100ns units) 5003 
</span></span><span class=line><span class=cl>  Maximum Timer Period (100ns units) 156250 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Platform Timer Resolution:Outstanding Timer Request
</span></span><span class=line><span class=cl>A program or service has requested a timer resolution smaller than the platform maximum timer resolution.
</span></span><span class=line><span class=cl>  Requested Period 5000 
</span></span><span class=line><span class=cl>  Requesting Process ID 6676 
</span></span><span class=line><span class=cl>  Requesting Process Path \Device\HarddiskVolume4\Users\akinshin\ConsoleApplication1.exe 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Platform Timer Resolution:Outstanding Timer Request
</span></span><span class=line><span class=cl>A program or service has requested a timer resolution smaller than the platform maximum timer resolution.
</span></span><span class=line><span class=cl>  Requested Period 10000 
</span></span><span class=line><span class=cl>  Requesting Process ID 10860 
</span></span><span class=line><span class=cl>  Requesting Process Path \Device\HarddiskVolume4\Program Files (x86)\Mozilla Firefox\firefox.exe 
</span></span></code></pre></div><p>As you can see, default interval is 15.6ms, Firefox requires 1.0ms interval, and <code>ConsoleApplication1.exe</code> in my home directory (which just call <code>WinApi.SetTimerResolution(5000)</code>) requires 0.5ms interval. <code>ConsoleApplication1.exe</code> won, now I have the maximal possible platform timer frequency.</p><h4 id=threadsleep>Thread.Sleep</h4><p>Ok, it sounds interesting, but why we should care about the system timer resolution?
Here I want to ask you a question: what the following call does?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>1</span><span class=p>);</span>
</span></span></code></pre></div><p>Somebody can answer: it suspend the current thread for <code>1 ms</code>. Unfortunately, it&rsquo;s a wrong answer. The documentation <a href=https://msdn.microsoft.com/library/windows/desktop/ms686298.aspx>states</a> the following:</p><blockquote><p>The actual timeout might not be exactly the specified timeout, because the specified timeout will be adjusted to coincide with clock ticks.</p></blockquote><p>In fact, the elapsed time depends on system timer resolution. Let&rsquo;s write another naive benchmark (we don&rsquo;t need any accuracy here, we just want to show the <code>Sleep</code> behavior in a simple way; so, we don&rsquo;t need usual benchmarking routine here like a warmup, statistics, and so on):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>5</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>sw</span> <span class=p>=</span> <span class=n>Stopwatch</span><span class=p>.</span><span class=n>StartNew</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>sw</span><span class=p>.</span><span class=n>Stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>time</span> <span class=p>=</span> <span class=n>sw</span><span class=p>.</span><span class=n>ElapsedTicks</span> <span class=p>*</span> <span class=m>1000.0</span> <span class=p>/</span> <span class=n>Stopwatch</span><span class=p>.</span><span class=n>Frequency</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>time</span> <span class=p>+</span> <span class=s>&#34; ms&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Typical output (for current timer interval = <code>15.625ms</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>14.8772437280584 ms
</span></span><span class=line><span class=cl>15.5369201880125 ms
</span></span><span class=line><span class=cl>18.6300283418281 ms
</span></span><span class=line><span class=cl>15.5728431635545 ms
</span></span><span class=line><span class=cl>15.6129649284456 ms
</span></span></code></pre></div><p>As you can see, the elapsed intervals are much more than <code>1 ms</code>. Now, let&rsquo;s run Firefox (which sets the interval to <code>1ms</code>) and repeat our stupid benchmark:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>1.72057056881932 ms
</span></span><span class=line><span class=cl>1.48123957592228 ms
</span></span><span class=line><span class=cl>1.47983997947259 ms
</span></span><span class=line><span class=cl>1.47237546507424 ms
</span></span><span class=line><span class=cl>1.49756820116866 ms
</span></span></code></pre></div><p>Firefox affected the <code>Sleep</code> call and reduced elapsed interval by ~ten times. You can find a good explanation of the <code>Sleep</code> behavior in <a href=http://www.windowstimestamp.com/description>The Windows Timestamp Project</a>:</p><blockquote><p>Say the <em>ActualResolution</em> is set to 156250, the interrupt heartbeat of the system will run at 15.625 ms periods or 64 Hz, and a call to Sleep is made with the desired delay of 1 ms. Two scenarios are to be looked at:</p><ul><li>The call was made &lt; 1ms (ΔT) ahead of the next interrupt. The next interrupt will not confirm that the desired period of time has expired. Only the following interrupt will cause the call to return. The resulting sleep delay will be ΔT + 15.625ms.</li><li>The call was made ≥ 1ms (ΔT) ahead of the next interrupt. The next interrupt will force the call to return. The resulting sleep delay will be ΔT.</li></ul></blockquote><p>There are many others <code>Sleep</code> “features”, but they are beyond the scope of this post. You can read another interesting read about the subject here: <a href=https://randomascii.wordpress.com/2013/04/02/sleep-variation-investigated/>Random ASCII: Sleep Variation Investigated (2013)</a></p><p>Of course, there are another Windows API which depends on the system timer resolution (e.g. <a href=https://msdn.microsoft.com/en-us/library/windows/desktop/ms687012.aspx>Waitable Timer </a>). We will not discuss this class in detail, I just want to recommend you once again to read this great text: <a href=http://www.windowstimestamp.com/description>The Windows Timestamp Project</a></p><hr><h4 id=linux>Linux</h4><p>As I mentioned before, on Linux, <code>DateTime.UtcNow</code> uses the <a href=http://man7.org/linux/man-pages/man2/gettimeofday.2.html>gettimeofday</a> function. There are a lot of interesting posts on the internet about how it&rsquo;s work (see the <a href=#links>Links</a> section), so I will not repeat them, I will just put some short summary here.</p><p><code>gettimeofday</code> allows you to get time in microseconds. Thus, <code>1us</code> is the minimal possible resolution. The actual resolution depends on linux version and hardware, but nowadays <code>1us</code> is also your actual resolution (this is not guaranteed). Internally it&rsquo;s usually based on a high-precision hardware timer and use <a href=https://lwn.net/Articles/446528/>vsyscall/vDSO</a> to reduce latency (you can find some asm code <a href=http://stackoverflow.com/a/7269039/184842>here</a>).</p><hr><h3 id=benchmarks>Benchmarks</h3><p>Let&rsquo;s write simple benchmarks with the help of <a href=https://github.com/PerfDotNet/BenchmarkDotNet>BenchmarkDotNet</a> (<em>v0.9.9</em>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[ClrJob, CoreJob, MonoJob]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>DateTimeBenchmarks</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>  [Benchmark]</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>long</span> <span class=n>Latency</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>UtcNow</span><span class=p>.</span><span class=n>Ticks</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>  [Benchmark]</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=kt>long</span> <span class=n>Resolution</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>lastTicks</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>UtcNow</span><span class=p>.</span><span class=n>Ticks</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>DateTime</span><span class=p>.</span><span class=n>UtcNow</span><span class=p>.</span><span class=n>Ticks</span> <span class=p>==</span> <span class=n>lastTicks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>lastTicks</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=windows-1>Windows</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>BenchmarkDotNet</span><span class=o>=</span><span class=s>v0.9.9.0</span>
</span></span><span class=line><span class=cl><span class=na>OS</span><span class=o>=</span><span class=s>Microsoft Windows NT 6.2.9200.0 (Windows 10 anniversary update)</span>
</span></span><span class=line><span class=cl><span class=na>Processor</span><span class=o>=</span><span class=s>Intel(R) Core(TM) i7-4702MQ CPU 2.20GHz, ProcessorCount=8</span>
</span></span><span class=line><span class=cl><span class=na>Frequency</span><span class=o>=</span><span class=s>2143473 ticks, Resolution=466.5326 ns, Timer=TSC</span>
</span></span><span class=line><span class=cl><span class=na>CLR1</span><span class=o>=</span><span class=s>CORE, Arch=64-bit ? [RyuJIT]</span>
</span></span><span class=line><span class=cl><span class=na>CLR2</span><span class=o>=</span><span class=s>MS.NET 4.0.30319.42000</span>
</span></span><span class=line><span class=cl><span class=na>CLR3</span><span class=o>=</span><span class=s>Mono JIT compiler version 4.2.3</span>
</span></span><span class=line><span class=cl><span class=na>JitModules</span><span class=o>=</span><span class=s>clrjit-v4.6.1586.0</span>
</span></span><span class=line><span class=cl><span class=na>dotnet cli version: 1.0.0-preview2-003121</span>
</span></span></code></pre></div><p>Current Timer Interval = <code>15.625ms</code>:</p><table><thead><tr><th>Method</th><th>Runtime</th><th align=right>Median</th><th align=right>StdDev</th></tr></thead><tbody><tr><td>Latency</td><td>Clr</td><td align=right>7.0471 ns</td><td align=right>0.0342 ns</td></tr><tr><td>Resolution</td><td>Clr</td><td align=right>15,599,814.5300 ns</td><td align=right>2,754.4628 ns</td></tr><tr><td>Latency</td><td>Core</td><td align=right>7.0481 ns</td><td align=right>0.0367 ns</td></tr><tr><td>Resolution</td><td>Core</td><td align=right>15,597,438.1294 ns</td><td align=right>2,655.8045 ns</td></tr><tr><td>Latency</td><td>Mono</td><td align=right>30.4011 ns</td><td align=right>0.2043 ns</td></tr><tr><td>Resolution</td><td>Mono</td><td align=right>15,550,311.0491 ns</td><td align=right>6,562.2114 ns</td></tr></tbody></table><p>Current Timer Interval = <code>0.5ms</code> (running AIMP):</p><table><thead><tr><th>Method</th><th>Runtime</th><th align=right>Median</th><th align=right>StdDev</th></tr></thead><tbody><tr><td>Latency</td><td>Clr</td><td align=right>7.3655 ns</td><td align=right>0.1102 ns</td></tr><tr><td>Resolution</td><td>Clr</td><td align=right>499,666.4219 ns</td><td align=right>811.5021 ns</td></tr><tr><td>Latency</td><td>Core</td><td align=right>7.3545 ns</td><td align=right>0.0602 ns</td></tr><tr><td>Resolution</td><td>Core</td><td align=right>499,357.0707 ns</td><td align=right>1,021.2058 ns</td></tr><tr><td>Latency</td><td>Mono</td><td align=right>31.5868 ns</td><td align=right>0.2685 ns</td></tr><tr><td>Resolution</td><td>Mono</td><td align=right>499,696.0358 ns</td><td align=right>673.2927 ns</td></tr></tbody></table><h4 id=linux-1>Linux</h4><p>Xubuntu 16.04.01, the same hardware:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>BenchmarkDotNet</span><span class=o>=</span><span class=s>v0.9.9.0</span>
</span></span><span class=line><span class=cl><span class=na>OS</span><span class=o>=</span><span class=s>Unix 4.4.0.34</span>
</span></span><span class=line><span class=cl><span class=na>Processor</span><span class=o>=</span><span class=s>Intel(R) Core(TM) i7-4702MQ CPU 2.20GHz, ProcessorCount=8</span>
</span></span><span class=line><span class=cl><span class=na>CLR1</span><span class=o>=</span><span class=s>CORE, Arch=64-bit ? [RyuJIT]</span>
</span></span><span class=line><span class=cl><span class=na>CLR2</span><span class=o>=</span><span class=s>Mono 4.4.2 (Stable 4.4.2.11/f72fe45 Fri Jul 29 09:58:49 UTC 2016), Arch=64-bit RELEASE</span>
</span></span><span class=line><span class=cl><span class=na>dotnet cli version: 1.0.0-preview2-003121</span>
</span></span></code></pre></div><table><thead><tr><th>Method</th><th>Runtime</th><th align=right>Median</th><th align=right>StdDev</th></tr></thead><tbody><tr><td>Latency</td><td>Core</td><td align=right>27.2925 ns</td><td align=right>0.4665 ns</td></tr><tr><td>Resolution</td><td>Core</td><td align=right>1,000.7250 ns</td><td align=right>0.5176 ns</td></tr><tr><td>Latency</td><td>Mono</td><td align=right>26.6243 ns</td><td align=right>1.3973 ns</td></tr><tr><td>Resolution</td><td>Mono</td><td align=right>998.2508 ns</td><td align=right>1.4941 ns</td></tr></tbody></table><hr><h3 id=summary>Summary</h3><p>Now we know that the resolution and the latency of <code>DateTime</code> may be tricky. On Windows, the resolutions depend on Windows System Timer; it can be changed programmatically by any application. Usually, it&rsquo;s about <code>0.5 ms</code>..<code>15.625 ms</code>. On Linux, the resolution is typical <code>1 us</code>. However, the latency on Windows is usually several times smaller that the latency on Linux (but you should not care about it in most cases).</p><p>Typically, <code>DateTime</code> is a good choice when you want to know the current time (e.g. for logging) and you don&rsquo;t need high precision. However, beware of DateTime-specific phenomena (see <a href=http://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time>Falsehoods programmers believe about time</a> and <a href=http://infiniteundo.com/post/25509354022/more-falsehoods-programmers-believe-about-time>More falsehoods programmers believe about time</a>). If you need to measure some time interval (not just put an approximate timestamp into a log file), you probably need a better tool. In the next post, I will tell about <code>Stopwatch</code>: how it&rsquo;s implemented, what the latency and the resolution of <code>Stopwatch</code>, how it works on different operating systems and runtimes, and why we should use <code>Stopwatch</code> on .NET, rather than alternative measurements tools.</p><hr><h3 id=links>Links</h3><h4 id=msdn>MSDN</h4><ul><li><a href=https://msdn.microsoft.com/library/system.datetime.aspx>MSDN: DateTime</a></li><li><a href=https://msdn.microsoft.com/library/system.datetime.utcnow.aspx>MSDN: DateTime.UtcNow</a></li><li><a href=https://msdn.microsoft.com/library/system.datetime.ticks.aspx>MSDN: DateTime.Ticks</a></li><li><a href=https://msdn.microsoft.com/library/system.datetime.aspx#Resolution>MSDN: DateTime — Resolution</a></li><li><a href=https://msdn.microsoft.com/library/windows/desktop/hh706895.aspx>MSDN: GetSystemTimePreciseAsFileTime</a></li><li><a href=https://msdn.microsoft.com/en-us/library/dd757624.aspx>MSDN: timeBeginPeriod</a></li><li><a href=https://msdn.microsoft.com/en-us/library/dd757626.aspx>MSDN: timeEndPeriod</a></li><li><a href=https://msdn.microsoft.com/library/windows/desktop/dn553408.aspx>MSDN: Acquiring high-resolution time stamps</a></li></ul><h4 id=sources>Sources</h4><ul><li><a href=http://referencesource.microsoft.com/#mscorlib/system/datetime.cs>ReferenceSource: system/datetime.cs</a></li><li><a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/mscorlib/src/System/DateTime.cs>coreclr-v1.0.0: mscorlib/src/System/DateTime.cs</a></li><li><a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/pal/src/file/filetime.cpp>coreclr-v1.0.0: pal/src/file/filetime.cpp</a></li><li><a href=https://github.com/dotnet/coreclr/blob/v1.0.0/src/classlibnative/bcltype/system.cpp#L48>coreclr-v1.0.0: classlibnative/bcltype/system.cpp</a></li><li><a href=https://github.com/mono/mono/blob/mono-4.4.2.11/mono/utils/mono-time.c>mono-4.4.2.11: mono-time.c</a></li><li><a href=https://github.com/mono/mono/blob/mono-4.4.2.11/mono/metadata/icall-def.h>mono-4.4.2.11: icall-def.h</a></li></ul><h4 id=useful-software>Useful software</h4><ul><li><a href=https://technet.microsoft.com/en-us/sysinternals/bb897568.aspx>ClockRes</a></li><li><a href=https://technet.microsoft.com/en-us/sysinternals/bb842062.aspx>Sysinternals Suite</a></li></ul><h4 id=misc>Misc</h4><ul><li><a href=http://www.windowstimestamp.com/description>The Windows Timestamp Project</a></li><li><a href=https://en.wikipedia.org/wiki/System_time>Wiki: System time</a></li><li><a href=http://man7.org/linux/man-pages/man2/gettimeofday.2.html>man7.org: gettimeofday(2)</a></li><li><a href=https://lwn.net/Articles/446528/>lwn.net: On vsyscalls and the vDSO</a></li><li><a href=http://tldp.org/HOWTO/Clock.html>The Clock Mini-HOWTO (2000)</a></li></ul><h4 id=blog-posts>Blog posts</h4><ul><li><a href=http://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time>Infinite Undo!: Falsehoods programmers believe about time (2012)</a></li><li><a href=http://infiniteundo.com/post/25509354022/more-falsehoods-programmers-believe-about-time>Infinite Undo!: More falsehoods programmers believe about time (2012)</a></li><li><a href=https://randomascii.wordpress.com/2013/07/08/windows-timer-resolution-megawatts-wasted/>Random ASCII: Windows Timer Resolution: Megawatts Wasted (2013)</a></li><li><a href=https://randomascii.wordpress.com/2013/04/02/sleep-variation-investigated/>Random ASCII: Sleep Variation Investigated (2013)</a></li><li><a href=http://www.mathpirate.net/log/2010/03/20/temporal-mechanics-changing-the-speed-of-time-part-ii/>MathPirate: Temporal Mechanics: Changing the Speed of Time, Part II (2010)</a></li><li><a href=http://www.programgo.com/article/91674336979/>The accuracy of gettimeofday in ARM architecture</a></li></ul><h4 id=stackoverflow>StackOverflow</h4><ul><li><a href=http://stackoverflow.com/q/7685762/184842>StackOverflow: Windows 7 timing functions - How to use GetSystemTimeAdjustment correctly?</a></li><li><a href=http://stackoverflow.com/q/307582/184842>StackOverflow: How frequent is DateTime.Now updated?</a></li><li><a href=http://stackoverflow.com/q/37898579/184842>StackOverflow: How is the CLR faster than me when calling Windows API</a></li><li><a href=http://stackoverflow.com/q/13230719/184842>StackOverflow: How is the microsecond time of linux gettimeofday() obtained and what is its accuracy?</a></li><li><a href=http://stackoverflow.com/q/12392278/184842>StackOverflow: Measure time in Linux - time vs clock vs getrusage vs clock_gettime vs gettimeofday vs timespec_get?</a></li><li><a href=http://stackoverflow.com/q/7266813/184842>StackOverflow: Anyone can understand how gettimeofday works?</a></li><li><a href=http://stackoverflow.com/q/19938324/184842>StackOverflow: What are vdso and vsyscall?</a></li></ul></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fdatetime%2f&title=DateTime%20under%20the%20hood" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=DateTime%20under%20the%20hood&url=https%3a%2f%2faakinshin.net%2fposts%2fdatetime%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fdatetime%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fdatetime%2f&title=DateTime%20under%20the%20hood" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2022 Andrey Akinshin</span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>anchors.options={placement:"left",icon:"§"},anchors.add("h1"),anchors.add("h2"),anchors.add("h3")</script></body></html>