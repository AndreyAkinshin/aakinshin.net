<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,C#,Rider,Mono,.NET Core"><title>How ListSeparator Depends on Runtime and Operating System | Andrey Akinshin</title><meta name=description content="This blog post was originally posted on JetBrains .NET blog.
In the two previous blog posts from this series, we discussed how socket errors and socket ord..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.00b1604219597584f1a9abe4b2d4de199357afca35ce8637e05eff220ee75867.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>How ListSeparator Depends on Runtime and Operating System</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2020-05-20>May 20, 2020</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a>
<a class=label-link href=https://aakinshin.net/tags/mono/>Mono</a>
<a class=label-link href=https://aakinshin.net/tags/netcore/>.NET Core</a></div></div><br><div class=main-content><p><em>This blog post was <a href=https://blog.jetbrains.com/dotnet/2020/05/20/listseparator-depends-runtime-operating-system/>originally posted</a> on <a href=https://blog.jetbrains.com/dotnet/>JetBrains .NET blog</a>.</em></p><p>In the two previous blog posts from this series, we discussed how socket errors and socket orders depend on the runtime and operating systems. For some, it may be obvious that some things are indeed specific to the operating system or the runtime, but often these issues come as a surprise and are only discovered when running our code on different systems.
An interesting example that may bite us at runtime is using <code>ListSeparator</code> in our code. It should give us a common separator for list elements in a string. But is it really common?
Let&rsquo;s start our investigation by printing <code>ListSeparator</code> for the Russian language:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=k>new</span> <span class=n>CultureInfo</span><span class=p>(</span><span class=s>&#34;ru-ru&#34;</span><span class=p>).</span><span class=n>TextInfo</span><span class=p>.</span><span class=n>ListSeparator</span><span class=p>);</span>
</span></span></code></pre></div><p>On Windows, you will get the same result for .NET Framework, .NET Core, and Mono: the <code>ListSeparator</code> is <code>;</code> (a semicolon). You will also get a semicolon on Mono+Unix. However, on .NET Core+Unix, you will get a <a href=https://en.wikipedia.org/wiki/Non-breaking_space>non-breaking space</a>.</p><h3 id=the-mono-approach>The Mono approach</h3><p>On Windows, it&rsquo;s possible to fetch the <code>ListSeparator</code> value from the operating systemâ€™s regional settings. Unfortunately, there is no such option on Linux and macOS. So, how is this problem solved in Mono?
The missing information about cultures is collected in advance using the <a href=https://github.com/mono/mono/tree/mono-6.10.0.104/tools/locale-builder>locale-builder</a> tool. Some of this data is filled in using <a href=http://www.unicode.org/Public/cldr/>unicode CLDR</a>. The rest is hardcoded. Speaking of <code>TextInfo</code> (a class that contains the <code>ListSeparator </code>value), it&rsquo;s defined in <a href=https://github.com/mono/mono/blob/mono-6.10.0.104/tools/locale-builder/Patterns.cs#L1610>Patterns.c</a><a href=https://github.com/mono/mono/blob/mono-6.10.0.104/tools/locale-builder/Patterns.cs#L1610>s</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>entry_te</span> <span class=p>=</span> <span class=n>Text</span><span class=p>[</span><span class=n>lcid</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>te</span> <span class=p>=</span> <span class=n>ci</span><span class=p>.</span><span class=n>TextInfoEntry</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>te</span><span class=p>.</span><span class=n>ANSICodePage</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>te</span><span class=p>.</span><span class=n>EBCDICCodePage</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>te</span><span class=p>.</span><span class=n>IsRightToLeft</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>==</span> <span class=s>&#34;1&#34;</span> <span class=p>?</span> <span class=k>true</span> <span class=p>:</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>te</span><span class=p>.</span><span class=n>ListSeparator</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>te</span><span class=p>.</span><span class=n>MacCodePage</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>te</span><span class=p>.</span><span class=n>OEMCodePage</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>5</span><span class=p>];</span>
</span></span></code></pre></div><p>The <code>lcid</code> value (<a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lcid/70feba9f-294e-491e-b6eb-56532684c37f>Language Code Identifier</a>) for Russian is 1049 or 0x419. (The values for a number of other languages can be found <a href=https://www.science.co.il/language/Locale-codes.php>here</a>).
The predefined values can also be found in Patterns.cs. Here is the corresponding <a href=https://github.com/mono/mono/blob/mono-6.10.0.104/tools/locale-builder/Patterns.cs#L665>entry</a> for Russian:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=p>{</span> <span class=m>0x0419</span><span class=p>,</span> <span class=k>new</span> <span class=p>[]</span> <span class=p>{</span> <span class=s>&#34;1251&#34;</span><span class=p>,</span> <span class=s>&#34;20880&#34;</span><span class=p>,</span> <span class=s>&#34;0&#34;</span><span class=p>,</span> <span class=s>&#34;;&#34;</span><span class=p>,</span> <span class=s>&#34;10007&#34;</span><span class=p>,</span> <span class=s>&#34;866&#34;</span> <span class=p>}</span> <span class=p>},</span>
</span></span></code></pre></div><p>Thus, <code>entry_te[3]</code> equals <code>";"</code>. That&rsquo;s how Mono knows the <code>ListSeparator</code> value even if it&rsquo;s not defined in the current operating system.</p><h3 id=the-net-core-approach>The .NET Core approach</h3><p>Unfortunately, .NET Core doesn&rsquo;t have predefined values for <code>ListSeparator</code>. Thereâ€™s a fairly strange logic in the source code of .NET Core 3.1.3:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>case</span> <span class=n>LocaleString_ListSeparator</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=c1>// fall through</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=n>LocaleString_ThousandSeparator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=p>=</span> <span class=n>GetLocaleInfoDecimalFormatSymbol</span><span class=p>(</span><span class=n>locale</span><span class=p>,</span> <span class=n>UNUM_GROUPING_SEPARATOR_SYMBOL</span><span class=p>,</span> <span class=k>value</span><span class=p>,</span> <span class=n>valueLength</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></div><p>It looks like .NET Core always uses the <code>ThousandSeparator</code> value instead of <code>ListSeparator</code> on Linux and macOS. This doesn&rsquo;t feel right, so we filed an issue: <a href=https://github.com/dotnet/runtime/issues/536>dotnet/runtime#536</a>. Hopefully, this behavior will be improved in the future.</p><h3 id=practical-recommendations>Practical recommendations</h3><p>If you are using some <code>CultureInfo</code> properties that are not supported by one of your target operating systems, it&rsquo;s better to provide some fallback values. Here is an <a href=https://github.com/dotnet/BenchmarkDotNet/commit/0c48c2862f69a63407898680d18dd76b988c4197#diff-225f35e5288a4b6836d56a4fef7b6adc>example</a> of how this problem has been solved in BenchmarkDotNet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=kt>string</span> <span class=n>GetActualListSeparator</span><span class=p>([</span><span class=n>CanBeNull</span><span class=p>]</span> <span class=k>this</span> <span class=n>CultureInfo</span> <span class=n>cultureInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cultureInfo</span> <span class=p>=</span> <span class=n>cultureInfo</span> <span class=p>??</span> <span class=n>DefaultCultureInfo</span><span class=p>.</span><span class=n>Instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=n>listSeparator</span> <span class=p>=</span> <span class=n>cultureInfo</span><span class=p>.</span><span class=n>TextInfo</span><span class=p>.</span><span class=n>ListSeparator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// On .NET Core + Linux, TextInfo.ListSeparator returns NumberFormat.NumberGroupSeparator</span>
</span></span><span class=line><span class=cl>    <span class=c1>// To work around this behavior, we patch empty ListSeparator with &#34;;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// See also: https://github.com/dotnet/runtime/issues/536</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>listSeparator</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>listSeparator</span> <span class=p>=</span> <span class=s>&#34;;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>listSeparator</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Having fallback values in place prevents us from seeing unexpected issues when running our code, and helps us be sure we can safely run our code across multiple platforms without any surprises.</p><h3 id=references>References</h3><ul><li><a href=https://github.com/dotnet/runtime/issues/536>dotnet/runtime#536: Incorrect value of CultureInfo.TextInfo.ListSeparator on Unix</a></li><li><a href=https://github.com/dotnet/runtime/issues/43795>dotnet/runtime#43795: CultureInfo.TextInfo.ListSeparator broken in .Net 5</a></li></ul></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fhow-listseparator-depends-on-runtime-and-operating-system%2f&title=How%20ListSeparator%20Depends%20on%20Runtime%20and%20Operating%20System" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=How%20ListSeparator%20Depends%20on%20Runtime%20and%20Operating%20System&url=https%3a%2f%2faakinshin.net%2fposts%2fhow-listseparator-depends-on-runtime-and-operating-system%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fhow-listseparator-depends-on-runtime-and-operating-system%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fhow-listseparator-depends-on-runtime-and-operating-system%2f&title=How%20ListSeparator%20Depends%20on%20Runtime%20and%20Operating%20System" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">Â© 2013â€”2022 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>