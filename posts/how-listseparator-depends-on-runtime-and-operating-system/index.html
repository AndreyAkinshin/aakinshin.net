<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.74.3"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,C#,Rider,Mono,.NET Core"><title>How ListSeparator Depends on Runtime and Operating System | Andrey Akinshin</title><meta name=description content="This blog post was originally posted on JetBrains .NET blog.
In the two previous blog posts from this series, we discussed how socket errors and socket ord..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=/css/lumen-bootstrap.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/slate-bootstrap.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><link href=/css/syntax-light.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/syntax-dark.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.26d61b7027fe55e642f0001cef94cb75b567d721086492aab6b4e32d9ee7811d.js></script><script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.882998740b9c4c24677576b997bde5a487246e2e3bd72128a0e922eaa59db029.mjs></script><link href=https://aakinshin.net/css/fontawesome-all.min.50da8736f05b35aac9691de67fe993cbe01b7d88fcf0cb682c3a8f39933fe4a3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.2a76db7cc14055b3bafacc363f453917ab54a818a7db2a0a9b2409c0f6bf07c5.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.b7c11be17efd31d4852ff062694551596a7625c992103c0605c98f85d6569f11.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVB6MXSX32"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-ZVB6MXSX32');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-41419012-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-41419012-5');</script><script type=text/javascript>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym");ym(28700916,"init",{clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src=https://mc.yandex.ru/watch/28700916 style=position:absolute;left:-9999px alt></div></noscript><script src=/js/jquery-3.3.1.slim.min.js></script></head><body><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle=dropdown href=# role=button aria-haspopup=true aria-expanded=false>Posts</a><div class=dropdown-menu><a class=dropdown-item href=https://aakinshin.net/posts/>All Posts</a>
<a class=dropdown-item href=https://aakinshin.net/tags/statistics/>Posts about Statistics</a>
<a class=dropdown-item href=https://aakinshin.net/tags/>All Tags</a></div></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li></ul><ul class="navbar-nav ml-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>How ListSeparator Depends on Runtime and Operating System</h1><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2020-05-20>May 20, 2020</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/programming/ class="badge badge-info">Programming</a>
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/rider/ class="badge badge-info">Rider</a>
<a href=https://aakinshin.net/tags/mono/ class="badge badge-info">Mono</a>
<a href=https://aakinshin.net/tags/netcore/ class="badge badge-info">.NET Core</a></span><br><br><p><em>This blog post was <a href=https://blog.jetbrains.com/dotnet/2020/05/20/listseparator-depends-runtime-operating-system/>originally posted</a> on <a href=https://blog.jetbrains.com/dotnet/>JetBrains .NET blog</a>.</em></p><p>In the two previous blog posts from this series, we discussed how socket errors and socket orders depend on the runtime and operating systems. For some, it may be obvious that some things are indeed specific to the operating system or the runtime, but often these issues come as a surprise and are only discovered when running our code on different systems.
An interesting example that may bite us at runtime is using <code>ListSeparator</code> in our code. It should give us a common separator for list elements in a string. But is it really common?
Let&rsquo;s start our investigation by printing <code>ListSeparator</code> for the Russian language:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=k>new</span> <span class=n>CultureInfo</span><span class=p>(</span><span class=s>&#34;ru-ru&#34;</span><span class=p>).</span><span class=n>TextInfo</span><span class=p>.</span><span class=n>ListSeparator</span><span class=p>);</span>
</code></pre></div><p>On Windows, you will get the same result for .NET Framework, .NET Core, and Mono: the <code>ListSeparator</code> is <code>;</code> (a semicolon). You will also get a semicolon on Mono+Unix. However, on .NET Core+Unix, you will get a <a href=https://en.wikipedia.org/wiki/Non-breaking_space>non-breaking space</a>.</p><h3 id=the-mono-approach>The Mono approach</h3><p>On Windows, it&rsquo;s possible to fetch the <code>ListSeparator</code> value from the operating systemâ€™s regional settings. Unfortunately, there is no such option on Linux and macOS. So, how is this problem solved in Mono?
The missing information about cultures is collected in advance using the <a href=https://github.com/mono/mono/tree/mono-6.10.0.104/tools/locale-builder>locale-builder</a> tool. Some of this data is filled in using <a href=http://www.unicode.org/Public/cldr/>unicode CLDR</a>. The rest is hardcoded. Speaking of <code>TextInfo</code> (a class that contains the <code>ListSeparator </code>value), it&rsquo;s defined in <a href=https://github.com/mono/mono/blob/mono-6.10.0.104/tools/locale-builder/Patterns.cs#L1610>Patterns.c</a><a href=https://github.com/mono/mono/blob/mono-6.10.0.104/tools/locale-builder/Patterns.cs#L1610>s</a>:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=kt>var</span> <span class=n>entry_te</span> <span class=p>=</span> <span class=n>Text</span><span class=p>[</span><span class=n>lcid</span><span class=p>];</span>
<span class=kt>var</span> <span class=n>te</span> <span class=p>=</span> <span class=n>ci</span><span class=p>.</span><span class=n>TextInfoEntry</span><span class=p>;</span>
<span class=n>te</span><span class=p>.</span><span class=n>ANSICodePage</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>0</span><span class=p>];</span>
<span class=n>te</span><span class=p>.</span><span class=n>EBCDICCodePage</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>1</span><span class=p>];</span>
<span class=n>te</span><span class=p>.</span><span class=n>IsRightToLeft</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>==</span> <span class=s>&#34;1&#34;</span> <span class=p>?</span> <span class=k>true</span> <span class=p>:</span> <span class=k>false</span><span class=p>;</span>
<span class=n>te</span><span class=p>.</span><span class=n>ListSeparator</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>3</span><span class=p>];</span>
<span class=n>te</span><span class=p>.</span><span class=n>MacCodePage</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>4</span><span class=p>];</span>
<span class=n>te</span><span class=p>.</span><span class=n>OEMCodePage</span> <span class=p>=</span> <span class=n>entry_te</span><span class=p>[</span><span class=m>5</span><span class=p>];</span>
</code></pre></div><p>The <code>lcid</code> value (<a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lcid/70feba9f-294e-491e-b6eb-56532684c37f>Language Code Identifier</a>) for Russian is 1049 or 0x419. (The values for a number of other languages can be found <a href=https://www.science.co.il/language/Locale-codes.php>here</a>).
The predefined values can also be found in Patterns.cs. Here is the corresponding <a href=https://github.com/mono/mono/blob/mono-6.10.0.104/tools/locale-builder/Patterns.cs#L665>entry</a> for Russian:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=p>{</span> <span class=m>0</span><span class=n>x0419</span><span class=p>,</span> <span class=k>new</span> <span class=p>[]</span> <span class=p>{</span> <span class=s>&#34;1251&#34;</span><span class=p>,</span> <span class=s>&#34;20880&#34;</span><span class=p>,</span> <span class=s>&#34;0&#34;</span><span class=p>,</span> <span class=s>&#34;;&#34;</span><span class=p>,</span> <span class=s>&#34;10007&#34;</span><span class=p>,</span> <span class=s>&#34;866&#34;</span> <span class=p>}</span> <span class=p>},</span>
</code></pre></div><p>Thus, <code>entry_te[3]</code> equals <code>&rdquo;;&ldquo;</code>. That&rsquo;s how Mono knows the <code>ListSeparator</code> value even if it&rsquo;s not defined in the current operating system.</p><h3 id=the-net-core-approach>The .NET Core approach</h3><p>Unfortunately, .NET Core doesn&rsquo;t have predefined values for <code>ListSeparator</code>. Thereâ€™s a fairly strange logic in the source code of .NET Core 3.1.3:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>case</span> <span class=n>LocaleString_ListSeparator</span><span class=p>:</span>
<span class=c1>// fall through
</span><span class=c1></span><span class=k>case</span> <span class=n>LocaleString_ThousandSeparator</span><span class=p>:</span>
    <span class=n>status</span> <span class=p>=</span> <span class=n>GetLocaleInfoDecimalFormatSymbol</span><span class=p>(</span><span class=n>locale</span><span class=p>,</span> <span class=n>UNUM_GROUPING_SEPARATOR_SYMBOL</span><span class=p>,</span> <span class=k>value</span><span class=p>,</span> <span class=n>valueLength</span><span class=p>);</span>
    <span class=k>break</span><span class=p>;</span>
</code></pre></div><p>It looks like .NET Core always uses the <code>ThousandSeparator</code> value instead of <code>ListSeparator</code> on Linux and macOS. This doesn&rsquo;t feel right, so we filed an issue: <a href=https://github.com/dotnet/runtime/issues/536>dotnet/runtime#536</a>. Hopefully, this behavior will be improved in the future.</p><h3 id=practical-recommendations>Practical recommendations</h3><p>If you are using some <code>CultureInfo</code> properties that are not supported by one of your target operating systems, it&rsquo;s better to provide some fallback values. Here is an <a href=https://github.com/dotnet/BenchmarkDotNet/commit/0c48c2862f69a63407898680d18dd76b988c4197#diff-225f35e5288a4b6836d56a4fef7b6adc>example</a> of how this problem has been solved in BenchmarkDotNet:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>static</span> <span class=kt>string</span> <span class=n>GetActualListSeparator</span><span class=p>([</span><span class=n>CanBeNull</span><span class=p>]</span> <span class=k>this</span> <span class=n>CultureInfo</span> <span class=n>cultureInfo</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>cultureInfo</span> <span class=p>=</span> <span class=n>cultureInfo</span> <span class=p>??</span> <span class=n>DefaultCultureInfo</span><span class=p>.</span><span class=n>Instance</span><span class=p>;</span>
    <span class=kt>string</span> <span class=n>listSeparator</span> <span class=p>=</span> <span class=n>cultureInfo</span><span class=p>.</span><span class=n>TextInfo</span><span class=p>.</span><span class=n>ListSeparator</span><span class=p>;</span>

    <span class=c1>// On .NET Core + Linux, TextInfo.ListSeparator returns NumberFormat.NumberGroupSeparator
</span><span class=c1></span>    <span class=c1>// To work around this behavior, we patch empty ListSeparator with &#34;;&#34;
</span><span class=c1></span>    <span class=c1>// See also: https://github.com/dotnet/runtime/issues/536
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>listSeparator</span><span class=p>))</span>
        <span class=n>listSeparator</span> <span class=p>=</span> <span class=s>&#34;;&#34;</span><span class=p>;</span>

    <span class=k>return</span> <span class=n>listSeparator</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>Having fallback values in place prevents us from seeing unexpected issues when running our code, and helps us be sure we can safely run our code across multiple platforms without any surprises.</p><h3 id=references>References</h3><ul><li><a href=https://github.com/dotnet/runtime/issues/536>dotnet/runtime#536: Incorrect value of CultureInfo.TextInfo.ListSeparator on Unix</a></li><li><a href=https://github.com/dotnet/runtime/issues/43795>dotnet/runtime#43795: CultureInfo.TextInfo.ListSeparator broken in .Net 5</a></li></ul><br><br><div class=row><div class="mx-auto share-block"><div class=share-title>Share:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fhow-listseparator-depends-on-runtime-and-operating-system%2f&title=How%20ListSeparator%20Depends%20on%20Runtime%20and%20Operating%20System" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=How%20ListSeparator%20Depends%20on%20Runtime%20and%20Operating%20System&url=https%3a%2f%2faakinshin.net%2fposts%2fhow-listseparator-depends-on-runtime-and-operating-system%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fhow-listseparator-depends-on-runtime-and-operating-system%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fhow-listseparator-depends-on-runtime-and-operating-system%2f&title=How%20ListSeparator%20Depends%20on%20Runtime%20and%20Operating%20System" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class=blog-footer><div class=container><p>&copy; 2013&mdash;2022 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub></i></a><a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter></i></a><a href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS></i></a>|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.082780cb948cc57eabbc0d80172a7a5347d5572b599938b4c9876dfd7978b424.js></script><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/anchor.min.js></script><script src=https://aakinshin.net/js/custom.min.11932490dde776463ed165b345838c701accc0cfdedf2e0868f13415f41f0872.js></script></body></html>