<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="Unexpected area to collect garbage in .NET">
    <meta name="author" content="Andrey Akinshin">
    <link href="/img/favicon.ico" rel="icon" type="image/x-icon"/>
    <meta name="keywords" content='.NET,GC,OpenCV'>

    <title>Unexpected area to collect garbage in .NET</title>

    <!-- Bootstrap CSS -->
    <link href="/css/lumen-bootstrap.min.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/minty-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/sketchy-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/slate-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/solar-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/superhero-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>

    <!-- Highlight.js -->
    <link href="/css/github-highlight.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/hopscotch-highlight.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/solarized-highlight.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/darcula-highlight.css" rel="stylesheet" type="text/css" media="all" disabled>

    <!-- FontAwesome -->
    <link href="/css/fontawesome-all.min.css" rel="stylesheet" type="text/css" media="all">
    
    <!-- Custom styles -->
    <link href="/css/about.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/blog.css" rel="stylesheet" type="text/css" media="all">

    <!-- Load theme -->
    <script src="/js/load-theme.js"></script>

    <!-- Feeds -->
    <link href="/en/rss.xml" type="application/rss+xml" rel="alternate" title="Blog RSS Feed" />
    <link href="/en/atom.xml" type="application/atom+xml" rel="alternate" title="Blog ATOM Feed" />

    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41419012-5', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function (d, w, c) {
            (w[c] = w[c] || []).push(function() {
                try {
                    w.yaCounter28700916 = new Ya.Metrika({
                        id:28700916,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true,
                        webvisor:true,
                        trackHash:true
                    });
                } catch(e) { }
            });

            var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
            s.type = "text/javascript";
            s.async = true;
            s.src = "https://mc.yandex.ru/metrika/watch.js";

            if (w.opera == "[object Opera]") {
                d.addEventListener("DOMContentLoaded", f, false);
            } else { f(); }
        })(document, window, "yandex_metrika_callbacks");
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/28700916" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->

    <!-- jQuery -->
    <script src="/js/jquery-3.2.1.slim.min.js"></script>
  </head>

  <body>
    <div class="bg-primary">
      <div class="container bg-primary">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" id="nav-link-blog" href="/posts/">Posts</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-link-blog-content" href="/content/">Content</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-link-about" href="/about/">About author</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">En</a>
              <div class="dropdown-menu">
                  <a class="dropdown-item" href='/ru/posts/gc-native/'>Ru</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Theme</a>
              <div class="dropdown-menu">
                  <h6 class="dropdown-header" style="text-align: center">Light</h6>
                  <a class="dropdown-item" href="#" onclick="setTheme('lumen', 'github');">lumen</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('sketchy', 'github');">sketchy</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('minty', 'github');">minty</a>
                  <div class="dropdown-divider"></div>
                  <h6 class="dropdown-header" style="text-align: center">Dark</h6>
                  <a class="dropdown-item" href="#" onclick="setTheme('solar', 'solarized');">solar</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('slate', 'darcula');">slate</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('superhero', 'hopscotch');">superhero</a>
              </div>
            </li>
            <li class="nav-item"><a class="nav-link" href="https://github.com/AndreyAkinshin"><i class="fab fa-github" title="GitHub" style="color:white"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="https://twitter.com/andrey_akinshin"><i class="fab fa-twitter" title="Twitter" style="color:white"></i></a></li>
            <li class="nav-item"><a class="nav-link" href="/rss.xml"><i class="fas fa-rss" title="RSS" style="color:white"></i></a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="container">
      <div class="blog-main">
<div class="blog-post">

<h2 class="blog-post-title" id="post-title">Unexpected area to collect garbage in .NET</h2>
<span class="blog-post-meta">
  <b>Date:</b> August 08, 2013.
  <b>Tags:</b>
        <a href="/tags/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
        <a href="/tags/gc"><span class="badge badge-pill badge-info">GC</span></a>
        <a href="/tags/opencv"><span class="badge badge-pill badge-info">OpenCV</span></a>
</span><br /><br />

<p>The .NET framework provides an intelligent garbage collector that saves us a trouble of manual memory management. And in 95% of cases you can forget about memory and related issues. But the remaining 5% have some specific aspects connected to unmanaged resources, too big objects, etc. And it’s better to know how the garbage is collected. Otherwise, you can get surprises.</p>
<p>Do you think GC is able to collect an object till its last method is complete? It appears it is. But it is necessary to run an application in release mode without debugging. In this case JIT compiler will perform optimizations that will make this situation possible. Of course, JIT compiler does it when the remaining method body doesn’t contain references to the object or its fields. It should seem a very harmless optimization. But it can lead to the problems if you work with the unmanaged resources: object compilation can be executed before the operation over the unmanaged resource is finished. And most likely it will result in the application crash. <!--more--></p>
<p>Let’s reproduce the situation. For a beginning, we will need something unmanaged, for example <a href="https://code.google.com/p/opencvsharp/">OpenCvSharp</a> that is a wrapper for <a href="http://opencv.org/">OpenCV</a>, a computer vision and image processing library.</p>
<p>I am talking about this library since I got this irritating issue using it. Have a look the following class:</p>
<pre><code class="language-cs">public class ImageWithCircle
{
  private const int Size = 10000;
  private readonly IplImage image;

  public ImageWithCircle()
  {            
    image = Cv.CreateImage(new CvSize(Size, Size), BitDepth.U8, 3);
    DrawCircle();
  }

  ~ImageWithCircle()
  {
    Console.WriteLine(&quot;~ImageWithCircle&quot;);
    Cv.ReleaseImage(image);
  }

  public void Save()
  {
    Console.WriteLine(&quot;Save start&quot;);
    image.SaveImage(&quot;image.tif&quot;);
    Console.WriteLine(&quot;Save end&quot;);
  }

  public void DrawCircle()
  {
    image.FloodFill(new CvPoint(Size / 2, Size / 2), CvColor.White);
    image.Circle(new CvPoint(Size / 2, Size / 2), Size / 4, 
                 CvColor.Random(), 10);
  }
}
</code></pre>
<p>This is quite a simple class responsible for drawing a very big picture with a circle. There is a <code>Save()</code> method that saves a picture to a file. Logic of the work with a picture is stored in the <code>IplImage</code> class from OpenCvSharp. Run this code:</p>
<pre><code class="language-cs">static void Main()
{
  new ImageWithCircle().Save();
}
</code></pre>
<p>The console will show an expected variant: we started <code>Save()</code> method and ended it. Only after it garbage was collected and the corresponding finalizer is invoked.</p>
<pre><code>Save start
Save end
~ImageWithCircle
</code></pre>
<p>And now let’s call garbage collection while the picture is being saved. This is just a sample; that is why we won’t invent anything complicated and just enable <code>Timer</code> that will call <code>GC.Collect()</code> quite frequently. The picture is very big and we will call garbage collector at least once before it is saved to a file. So, the executable code now looks in the following way:</p>
<pre><code class="language-cs">private static void Main()
{
  var timer = new Timer(100);
  timer.Elapsed += RunGc;
  timer.Start();
  new ImageWithCircle().Save();
}

private static void RunGc(object sender, ElapsedEventArgs e)
{
  Console.WriteLine(&quot;Gc.Collect();&quot;);
  GC.Collect();
}
</code></pre>
<p>Probably, you expect to see something of this kind:</p>
<pre><code>Gc.Collect();
Gc.Collect();
Gc.Collect();
Save start
Gc.Collect();
Gc.Collect();
Gc.Collect();
Gc.Collect();
Gc.Collect();
Gc.Collect();
Save end
~ImageWithCircle
</code></pre>
<p>But if you run the application in release mode without debugging the app will crash:</p>
<pre><code>Gc.Collect();
Gc.Collect();
Gc.Collect();
Save start
Gc.Collect();
~ImageWithCircle

Unhandled Exception: System.AccessViolationException: Attempted to read or write
 protected memory. This is often an indication that other memory is corrupt.
   at OpenCvSharp.CvInvoke.cvSaveImage(String filename, IntPtr image, Int32[] pa
rams)
   at OpenCvSharp.Cv.SaveImage(String filename, CvArr image, ImageEncodingParam[
] prms)
   at ConsoleApplication.ImageWithCircle.Save() in d:\Tests\ConsoleApplica
tion\ConsoleApplication\ImageWithCircle.cs:line 28
   at ConsoleApplication.Program.Main() in d:\Tests\ConsoleApplication\Co
nsoleApplication\Program.cs:line 18
Gc.Collect();
Gc.Collect();
</code></pre>
<p>The problem is that JIT executed its insidious optimization: our object was subject to garbage collection before the picture is completely saved to a file. Unfortunately, OpenCvSharp couldn’t stand it and threw an exception.</p>
<p>The issue can be easily fixed: it’s just necessary to keep reference to the current picture till the method completes its work. For example, you can use some static object to which the picture will write reference to itself in the beginning of the <code>Save()</code> method. But I prefer to use the <a href="http://msdn.microsoft.com/en-us/library/system.gc.keepalive.aspx">GC.KeepAlive</a> method:</p>
<pre><code class="language-cs">public void Save()
{
  Console.WriteLine(&quot;Save start&quot;);
  image.SaveImage(&quot;image.tif&quot;);
  Console.WriteLine(&quot;Save end&quot;);
  GC.KeepAlive(this);
}
</code></pre>
<p>Actually, it’s not important in what way you will fix the issue; the main thing is to understand how garbage collector works to foresee such problems. They are hard to discover: the application in the sample crashes only with definite start configuration, in case if the garbage collector is able to run while some time-consuming unmanaged method is executed. And if you occasionally get such application crash you will spend much time trying to reproduce it. To avoid such issues it is necessary to carefully design interaction with any native objects trying to foresee probable troubles before the code is written.</p>
<h2 id="cross-posts">Cross-posts</h2>
<ul>
<li><a href="http://blogs.perpetuumsoft.com/dotnet/unexpected-area-to-collect-garbage-in-net/">blogs.perpetuumsoft.com</a></li>
</ul>

<!-- Share -->

Share:
<a href="https://twitter.com/intent/tweet?text=Unexpected area to collect garbage in .NET&url=http://aakinshin.net/posts/gc-native/&via=andrey_akinshin&related=andrey_akinshin" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fab fa-twitter fa-2x" title="Twitter"></i></a>
<a href="https://www.reddit.com/submit?url=http://aakinshin.net/posts/gc-native/" target="_blank" title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a>
<a href="https://news.ycombinator.com/submitlink?u=http://aakinshin.net/posts/gc-native/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a>
<a href="https://facebook.com/sharer.php?u=http://aakinshin.net/posts/gc-native/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fab fa-facebook fa-2x"></i></a>
<a href="https://plus.google.com/share?url=http://aakinshin.net/posts/gc-native/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fab fab fa-google-plus-g fa-2x"></i></a>
<a href="http://vk.com/share.php?url=http://aakinshin.net/posts/gc-native/" target="_blank" title="Share on VKontakte"><i class="fab fa-vk fa-2x"></i></a>
<a href="https://getpocket.com/save?url=http://aakinshin.net/posts/gc-native/&title=Unexpected area to collect garbage in .NET" target="_blank" title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a>
<hr />

<!-- GitHub -->
<div>
  You can find source code of this post on GitHub:<br />
  <a href="https://github.com/AndreyAkinshin/aakinshin.net/blob/master/web/_posts/en/2013/gc-native.md">https://github.com/AndreyAkinshin/aakinshin.net/blob/master/web/_posts/en/2013/gc-native.md</a>
</div>

</div>
</div>
    </div>

    <footer class="blog-footer bg-light">
      <div class="container">
        <p>&copy; 2013–2019 Andrey Akinshin</p>
      </div>
    </footer>

    <!-- jQuery first (header), then popper, then Bootstrap JS. -->
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <!-- Other scripts -->
    <script src="/js/highlight.pack.js"></script>
    <script src="/js/anchor.min.js"></script>
    <script src="/js/custom.js"></script>
  </body>
</html>
