<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,GC,OpenCV"><title>Unexpected area to collect garbage in .NET | Andrey Akinshin</title><meta name=description content="The .NET framework provides an intelligent garbage collector that saves us a trouble of manual memory management. And in 95% of cases you can forget about ..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script src=https://cdn.tailwindcss.com/3.2.4></script>
<script>tailwind.config={darkMode:"class"}</script><style type=text/tailwindcss>
    @layer base {
       
      body {
        @apply bg-white dark:bg-zinc-800;
        @apply text-black dark:text-gray-400;
      }
      nav {
        @apply bg-sky-800 dark:bg-zinc-900;
      }
      a {
        @apply text-sky-600 dark:text-white;
        @apply no-underline;
      }
      .main-content a:not(.label-link) {
        @apply hover:underline;
      }
      hr {
        @apply h-px my-3 border-0 bg-gray-300 dark:bg-gray-600;
      }
      h1, h2, h3, h4, h5, h6 {
        @apply leading-tight;
      }
      h1, h2, h3 {
        @apply text-4xl py-4;
      }
      h4 {
        @apply text-3xl py-3;
      }
      h5, h6 {
        @apply text-2xl py-2;
      }
      table {
        @apply border self-center mx-auto;
      }
      th, td {
        @apply border p-2
      }
      blockquote {
        @apply border-l-8 border-gray-300 bg-gray-100 dark:border-zinc-600 dark:bg-zinc-700;
        @apply ml-4 my-4 px-4 py-2;
      }
       
      .main ul {
        @apply list-disc ml-10 my-2;
      }
      .main ol {
        @apply list-decimal ml-10 my-2;
      }
      .main p {
        @apply mb-3;
      }
       
      .label {
        @apply mx-1 px-1 py-0.5 whitespace-nowrap;
        @apply rounded border border-gray-400 dark:border-gray-500;
      }
      .label-link {
        @apply mx-1 px-1 py-0.5 whitespace-nowrap;
        @apply rounded border border-sky-600 dark:border-slate-400;
        @apply hover:bg-sky-200 dark:hover:bg-gray-500;
      }
      .nav-item {
        @apply text-white hover:bg-sky-700 dark:hover:bg-gray-700;
      }
       
      .paginator {
        @apply flex flex-wrap justify-center mb-4;
      }
      .paginator .page-item {
        @apply inline-flex border rounded px-3 py-1;
      }
      .paginator .page-item:not(.active):not(.disabled) {
        @apply border-gray-400 dark:border-gray-400;
      }
      .paginator .page-item.active {
        @apply border-sky-600 dark:border-white;
      }
      .paginator .page-item.disabled {
        @apply bg-gray-50 dark:bg-gray-500 dark:border-gray-400;
      }
      .paginator .page-item.disabled a {
        @apply text-gray-400 dark:text-gray-400;
      }
       
      .block-example {
        @apply my-4 pl-3;
        @apply border-l-8 border-gray-300 dark:border-zinc-600;
      }
       
      #about img {
        @apply inline-flex h-4;
      }
       
      .fai {
        @apply inline-flex h-[1.2em] w-[1.2em] pr-[0.4em] fill-current;
      }
      .fai-link {
        @apply hover:text-sky-400 dark:hover:text-blue-400;
      }
      .label-link .fai {
        @apply pl-1 pb-1 h-[1.5em] w-[1.5em];
      }
       
      .chroma {
        @apply my-5 overflow-y-scroll;
        @apply p-1 border rounded;
      }
    }
  </style><style>.block-example-title::before{counter-increment:example;content:"Example " counter(example)}body{counter-reset:example}code.has-jax{-webkit-font-smoothing:antialiased;background:inherit!important;border:none!important;font-size:100%}*:hover>.anchorjs-link{margin-left:-1.125em!important}.chroma{background-color:#fff}.chroma .x{}.chroma .err{color:#a61717;background-color:#e3d2d2}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#000;font-weight:700}.chroma .kc{color:#000;font-weight:700}.chroma .kd{color:#000;font-weight:700}.chroma .kn{color:#000;font-weight:700}.chroma .kp{color:#000;font-weight:700}.chroma .kr{color:#000;font-weight:700}.chroma .kt{color:#458;font-weight:700}.chroma .n{}.chroma .na{color:teal}.chroma .nb{color:#0086b3}.chroma .bp{color:#999}.chroma .nc{color:#458;font-weight:700}.chroma .no{color:teal}.chroma .nd{color:#3c5d5d;font-weight:700}.chroma .ni{color:purple}.chroma .ne{color:#900;font-weight:700}.chroma .nf{color:#900;font-weight:700}.chroma .fm{}.chroma .nl{color:#900;font-weight:700}.chroma .nn{color:#555}.chroma .nx{}.chroma .py{}.chroma .nt{color:navy}.chroma .nv{color:teal}.chroma .vc{color:teal}.chroma .vg{color:teal}.chroma .vi{color:teal}.chroma .vm{}.chroma .l{}.chroma .ld{}.chroma .s{color:#d14}.chroma .sa{color:#d14}.chroma .sb{color:#d14}.chroma .sc{color:#d14}.chroma .dl{color:#d14}.chroma .sd{color:#d14}.chroma .s2{color:#d14}.chroma .se{color:#d14}.chroma .sh{color:#d14}.chroma .si{color:#d14}.chroma .sx{color:#d14}.chroma .sr{color:#009926}.chroma .s1{color:#d14}.chroma .ss{color:#990073}.chroma .m{color:#099}.chroma .mb{color:#099}.chroma .mf{color:#099}.chroma .mh{color:#099}.chroma .mi{color:#099}.chroma .il{color:#099}.chroma .mo{color:#099}.chroma .o{color:#000;font-weight:700}.chroma .ow{color:#000;font-weight:700}.chroma .p{}.chroma .c{color:#998;font-style:italic}.chroma .ch{color:#998;font-style:italic}.chroma .cm{color:#998;font-style:italic}.chroma .c1{color:#998;font-style:italic}.chroma .cs{color:#999;font-weight:700;font-style:italic}.chroma .cp{color:#999;font-weight:700;font-style:italic}.chroma .cpf{color:#999;font-weight:700;font-style:italic}.chroma .g{}.chroma .gd{color:#000;background-color:#fdd}.chroma .ge{color:#000;font-style:italic}.chroma .gr{color:#a00}.chroma .gh{color:#999}.chroma .gi{color:#000;background-color:#dfd}.chroma .go{color:#888}.chroma .gp{color:#555}.chroma .gs{font-weight:700}.chroma .gu{color:#aaa}.chroma .gt{color:#a00}.chroma .gl{text-decoration:underline}.chroma .w{color:#bbb}.dark.chroma{color:#f8f8f2;background-color:#272822}.dark .chroma{color:#f8f8f2;background-color:#272822}.dark .chroma .x{}.dark .chroma .err{color:#960050;background-color:#1e0010}.dark .chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.dark .chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.dark .chroma .hl{display:block;width:100%;background-color:#ffc}.dark .chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.dark .chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.dark .chroma .k{color:#66d9ef}.dark .chroma .kc{color:#66d9ef}.dark .chroma .kd{color:#66d9ef}.dark .chroma .kn{color:#f92672}.dark .chroma .kp{color:#66d9ef}.dark .chroma .kr{color:#66d9ef}.dark .chroma .kt{color:#66d9ef}.dark .chroma .n{}.dark .chroma .na{color:#a6e22e}.dark .chroma .nb{}.dark .chroma .bp{}.dark .chroma .nc{color:#a6e22e}.dark .chroma .no{color:#66d9ef}.dark .chroma .nd{color:#a6e22e}.dark .chroma .ni{}.dark .chroma .ne{color:#a6e22e}.dark .chroma .nf{color:#a6e22e}.dark .chroma .fm{}.dark .chroma .nl{}.dark .chroma .nn{}.dark .chroma .nx{color:#a6e22e}.dark .chroma .py{}.dark .chroma .nt{color:#f92672}.dark .chroma .nv{}.dark .chroma .vc{}.dark .chroma .vg{}.dark .chroma .vi{}.dark .chroma .vm{}.dark .chroma .l{color:#ae81ff}.dark .chroma .ld{color:#e6db74}.dark .chroma .s{color:#e6db74}.dark .chroma .sa{color:#e6db74}.dark .chroma .sb{color:#e6db74}.dark .chroma .sc{color:#e6db74}.dark .chroma .dl{color:#e6db74}.dark .chroma .sd{color:#e6db74}.dark .chroma .s2{color:#e6db74}.dark .chroma .se{color:#ae81ff}.dark .chroma .sh{color:#e6db74}.dark .chroma .si{color:#e6db74}.dark .chroma .sx{color:#e6db74}.dark .chroma .sr{color:#e6db74}.dark .chroma .s1{color:#e6db74}.dark .chroma .ss{color:#e6db74}.dark .chroma .m{color:#ae81ff}.dark .chroma .mb{color:#ae81ff}.dark .chroma .mf{color:#ae81ff}.dark .chroma .mh{color:#ae81ff}.dark .chroma .mi{color:#ae81ff}.dark .chroma .il{color:#ae81ff}.dark .chroma .mo{color:#ae81ff}.dark .chroma .o{color:#f92672}.dark .chroma .ow{color:#f92672}.dark .chroma .p{}.dark .chroma .c{color:#75715e}.dark .chroma .ch{color:#75715e}.dark .chroma .cm{color:#75715e}.dark .chroma .c1{color:#75715e}.dark .chroma .cs{color:#75715e}.dark .chroma .cp{color:#75715e}.dark .chroma .cpf{color:#75715e}.dark .chroma .g{}.dark .chroma .gd{color:#f92672}.dark .chroma .ge{font-style:italic}.dark .chroma .gr{}.dark .chroma .gh{}.dark .chroma .gi{color:#a6e22e}.dark .chroma .go{}.dark .chroma .gp{}.dark .chroma .gs{font-weight:700}.dark .chroma .gu{color:#75715e}.dark .chroma .gt{}.dark .chroma .gl{}.dark .chroma .w{}</style><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-6 h-6"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Unexpected area to collect garbage in .NET</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai"><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2013-08-08>August 8, 2013</time><svg class="fai ml-3"><use xlink:href="/img/fa/all.svg#tag"/></svg>
<a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/gc/>GC</a>
<a class=label-link href=https://aakinshin.net/tags/opencv/>OpenCV</a></div><br><div class=main-content><p>The .NET framework provides an intelligent garbage collector that saves us a trouble of manual memory management. And in 95% of cases you can forget about memory and related issues. But the remaining 5% have some specific aspects connected to unmanaged resources, too big objects, etc. And it’s better to know how the garbage is collected. Otherwise, you can get surprises.</p><p>Do you think GC is able to collect an object till its last method is complete? It appears it is. But it is necessary to run an application in release mode without debugging. In this case JIT compiler will perform optimizations that will make this situation possible. Of course, JIT compiler does it when the remaining method body doesn’t contain references to the object or its fields. It should seem a very harmless optimization. But it can lead to the problems if you work with the unmanaged resources: object compilation can be executed before the operation over the unmanaged resource is finished. And most likely it will result in the application crash.</p><p>Let’s reproduce the situation. For a beginning, we will need something unmanaged, for example <a href=https://code.google.com/p/opencvsharp/>OpenCvSharp</a> that is a wrapper for <a href=http://opencv.org/>OpenCV</a>, a computer vision and image processing library.</p><p>I am talking about this library since I got this irritating issue using it. Have a look the following class:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>ImageWithCircle</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>Size</span> <span class=p>=</span> <span class=m>10000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=k>readonly</span> <span class=n>IplImage</span> <span class=n>image</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=n>ImageWithCircle</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>            
</span></span><span class=line><span class=cl>    <span class=n>image</span> <span class=p>=</span> <span class=n>Cv</span><span class=p>.</span><span class=n>CreateImage</span><span class=p>(</span><span class=k>new</span> <span class=n>CvSize</span><span class=p>(</span><span class=n>Size</span><span class=p>,</span> <span class=n>Size</span><span class=p>),</span> <span class=n>BitDepth</span><span class=p>.</span><span class=n>U8</span><span class=p>,</span> <span class=m>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>DrawCircle</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>~</span><span class=n>ImageWithCircle</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;~ImageWithCircle&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Cv</span><span class=p>.</span><span class=n>ReleaseImage</span><span class=p>(</span><span class=n>image</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>Save</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Save start&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=p>.</span><span class=n>SaveImage</span><span class=p>(</span><span class=s>&#34;image.tif&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Save end&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>DrawCircle</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=p>.</span><span class=n>FloodFill</span><span class=p>(</span><span class=k>new</span> <span class=n>CvPoint</span><span class=p>(</span><span class=n>Size</span> <span class=p>/</span> <span class=m>2</span><span class=p>,</span> <span class=n>Size</span> <span class=p>/</span> <span class=m>2</span><span class=p>),</span> <span class=n>CvColor</span><span class=p>.</span><span class=n>White</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=p>.</span><span class=n>Circle</span><span class=p>(</span><span class=k>new</span> <span class=n>CvPoint</span><span class=p>(</span><span class=n>Size</span> <span class=p>/</span> <span class=m>2</span><span class=p>,</span> <span class=n>Size</span> <span class=p>/</span> <span class=m>2</span><span class=p>),</span> <span class=n>Size</span> <span class=p>/</span> <span class=m>4</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                 <span class=n>CvColor</span><span class=p>.</span><span class=n>Random</span><span class=p>(),</span> <span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is quite a simple class responsible for drawing a very big picture with a circle. There is a <code>Save()</code> method that saves a picture to a file. Logic of the work with a picture is stored in the <code>IplImage</code> class from OpenCvSharp. Run this code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>new</span> <span class=n>ImageWithCircle</span><span class=p>().</span><span class=n>Save</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The console will show an expected variant: we started <code>Save()</code> method and ended it. Only after it garbage was collected and the corresponding finalizer is invoked.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Save start
</span></span><span class=line><span class=cl>Save end
</span></span><span class=line><span class=cl>~ImageWithCircle
</span></span></code></pre></div><p>And now let’s call garbage collection while the picture is being saved. This is just a sample; that is why we won’t invent anything complicated and just enable <code>Timer</code> that will call <code>GC.Collect()</code> quite frequently. The picture is very big and we will call garbage collector at least once before it is saved to a file. So, the executable code now looks in the following way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>private</span> <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>timer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Timer</span><span class=p>(</span><span class=m>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>timer</span><span class=p>.</span><span class=n>Elapsed</span> <span class=p>+=</span> <span class=n>RunGc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>timer</span><span class=p>.</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>new</span> <span class=n>ImageWithCircle</span><span class=p>().</span><span class=n>Save</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>static</span> <span class=k>void</span> <span class=n>RunGc</span><span class=p>(</span><span class=kt>object</span> <span class=n>sender</span><span class=p>,</span> <span class=n>ElapsedEventArgs</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Gc.Collect();&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>GC</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Probably, you expect to see something of this kind:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Save</span> <span class=n>start</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Save</span> <span class=n>end</span>
</span></span><span class=line><span class=cl><span class=p>~</span><span class=n>ImageWithCircle</span>
</span></span></code></pre></div><p>But if you run the application in release mode without debugging the app will crash:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Save</span> <span class=n>start</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>~</span><span class=n>ImageWithCircle</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Unhandled</span> <span class=n>Exception</span><span class=p>:</span> <span class=n>System</span><span class=p>.</span><span class=n>AccessViolationException</span><span class=p>:</span> <span class=n>Attempted</span> <span class=n>to</span> <span class=n>read</span> <span class=n>or</span> <span class=n>write</span>
</span></span><span class=line><span class=cl> <span class=k>protected</span> <span class=n>memory</span><span class=p>.</span> <span class=n>This</span> <span class=k>is</span> <span class=n>often</span> <span class=n>an</span> <span class=n>indication</span> <span class=n>that</span> <span class=n>other</span> <span class=n>memory</span> <span class=k>is</span> <span class=n>corrupt</span><span class=p>.</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>OpenCvSharp</span><span class=p>.</span><span class=n>CvInvoke</span><span class=p>.</span><span class=n>cvSaveImage</span><span class=p>(</span><span class=n>String</span> <span class=n>filename</span><span class=p>,</span> <span class=n>IntPtr</span> <span class=n>image</span><span class=p>,</span> <span class=n>Int32</span><span class=p>[]</span> <span class=n>pa</span>
</span></span><span class=line><span class=cl><span class=n>rams</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>OpenCvSharp</span><span class=p>.</span><span class=n>Cv</span><span class=p>.</span><span class=n>SaveImage</span><span class=p>(</span><span class=n>String</span> <span class=n>filename</span><span class=p>,</span> <span class=n>CvArr</span> <span class=n>image</span><span class=p>,</span> <span class=n>ImageEncodingParam</span><span class=p>[</span>
</span></span><span class=line><span class=cl><span class=p>]</span> <span class=n>prms</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>ConsoleApplication</span><span class=p>.</span><span class=n>ImageWithCircle</span><span class=p>.</span><span class=n>Save</span><span class=p>()</span> <span class=k>in</span> <span class=n>d</span><span class=p>:</span><span class=err>\</span><span class=n>Tests</span><span class=err>\</span><span class=n>ConsoleApplica</span>
</span></span><span class=line><span class=cl><span class=n>tion</span><span class=err>\</span><span class=n>ConsoleApplication</span><span class=err>\</span><span class=n>ImageWithCircle</span><span class=p>.</span><span class=n>cs</span><span class=p>:</span><span class=n>line</span> <span class=m>28</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>ConsoleApplication</span><span class=p>.</span><span class=n>Program</span><span class=p>.</span><span class=n>Main</span><span class=p>()</span> <span class=k>in</span> <span class=n>d</span><span class=p>:</span><span class=err>\</span><span class=n>Tests</span><span class=err>\</span><span class=n>ConsoleApplication</span><span class=err>\</span><span class=n>Co</span>
</span></span><span class=line><span class=cl><span class=n>nsoleApplication</span><span class=err>\</span><span class=n>Program</span><span class=p>.</span><span class=n>cs</span><span class=p>:</span><span class=n>line</span> <span class=m>18</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>Gc</span><span class=p>.</span><span class=n>Collect</span><span class=p>();</span>
</span></span></code></pre></div><p>The problem is that JIT executed its insidious optimization: our object was subject to garbage collection before the picture is completely saved to a file. Unfortunately, OpenCvSharp couldn’t stand it and threw an exception.</p><p>The issue can be easily fixed: it’s just necessary to keep reference to the current picture till the method completes its work. For example, you can use some static object to which the picture will write reference to itself in the beginning of the <code>Save()</code> method. But I prefer to use the <a href=http://msdn.microsoft.com/en-us/library/system.gc.keepalive.aspx>GC.KeepAlive</a> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Save</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Save start&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>image</span><span class=p>.</span><span class=n>SaveImage</span><span class=p>(</span><span class=s>&#34;image.tif&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Save end&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>GC</span><span class=p>.</span><span class=n>KeepAlive</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Actually, it’s not important in what way you will fix the issue; the main thing is to understand how garbage collector works to foresee such problems. They are hard to discover: the application in the sample crashes only with definite start configuration, in case if the garbage collector is able to run while some time-consuming unmanaged method is executed. And if you occasionally get such application crash you will spend much time trying to reproduce it. To avoid such issues it is necessary to carefully design interaction with any native objects trying to foresee probable troubles before the code is written.</p><h2 id=cross-posts>Cross-posts</h2><ul><li><a href=http://blogs.perpetuumsoft.com/dotnet/unexpected-area-to-collect-garbage-in-net/>blogs.perpetuumsoft.com</a></li></ul></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fgc-native%2f&title=Unexpected%20area%20to%20collect%20garbage%20in%20.NET" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=Unexpected%20area%20to%20collect%20garbage%20in%20.NET&url=https%3a%2f%2faakinshin.net%2fposts%2fgc-native%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fgc-native%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fgc-native%2f&title=Unexpected%20area%20to%20collect%20garbage%20in%20.NET" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2022 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>anchors.options={placement:"left",icon:"§"},anchors.add("h1"),anchors.add("h2"),anchors.add("h3")</script></body></html>