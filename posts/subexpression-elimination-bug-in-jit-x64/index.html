<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,C#,JIT,Bugs"><title>A bug story about JIT-x64 | Andrey Akinshin</title><meta name=description content="Can you say, what will the following code display for step=1?
public void Foo(int step) { for (int i = 0; i &amp;lt; step; i++) { bar = i + 10; for (int j = 0;..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=https://aakinshin.net/sass/bootstrap-light.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=https://aakinshin.net/sass/bootstrap-dark.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.d7f6578e23ad3f0c33c589f9bcb34f995b45121f1f3ce888869c86b26826c845.js></script>
<script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.9e68d431432744c07a43381a8a833ffe0921cc0e006d84ad97f0b0d43c5cd82d.mjs></script>
<link href=https://aakinshin.net/css/fontawesome-all.min.178e95bba6ea2e9a90838cd646658f4bf6667a6ceaa057cb587bf7e6eb8412d3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.60773ab7266ecc6e9625306f57c0a82a219b011dc3ea2d83763d1ecdf11c86d2.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.7e186db80d8c431d196b3e0718afb0636b82a269a8c92521c11a55267a24fc27.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script src=/js/jquery-3.3.1.slim.min.js></script></head><body class="d-flex flex-column min-vh-100"><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>Blog</a><ul class="dropdown-menu bg-primary"><li><a class=dropdown-item href=https://aakinshin.net/posts/>All Posts</a></li><li><a class=dropdown-item href=https://aakinshin.net/tags/statistics/>Posts about Statistics</a></li><li></li><a class=dropdown-item href=https://aakinshin.net/tags/>All Tags</a></li></ul></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-expanded=false>EN</a><ul class="dropdown-menu bg-primary"><li></li><a class=dropdown-item href=https://aakinshin.net/ru/posts/subexpression-elimination-bug-in-jit-x64/>RU</a></li></ul></li></ul><ul class="navbar-nav ms-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>A bug story about JIT-x64</h1><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2015-02-27>February 27, 2015</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>
&nbsp;
<a href=https://aakinshin.net/tags/programming/ class="badge badge-info">Programming</a>
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/jit/ class="badge badge-info">JIT</a>
<a href=https://aakinshin.net/tags/bugs/ class="badge badge-info">Bugs</a></span><br><br><p>Can you say, what will the following code display for <code>step=1</code>?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>step</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>bar</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=m>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=m>2</span> <span class=p>*</span> <span class=n>step</span><span class=p>;</span> <span class=n>j</span> <span class=p>+=</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>j</span> <span class=p>+</span> <span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If you think about specific numbers, you are wrong. The right answer: it depends. The post title suggests to us, the program can has a strange behavior for x64.</p><h3 id=the-problem-statement>The problem statement</h3><p>The bug isn&rsquo;t a new one, it has been discussed a year ago on StackOverflow: <a href=http://stackoverflow.com/questions/20701701/jit-net-compiler-bug>“JIT .Net compiler bug?”</a>. However, the code from the question is too complicated for an analysis. I have tried to minimize it for the future examination. Let&rsquo;s consider the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Runtime.CompilerServices</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Program</span><span class=p>().</span><span class=n>Run</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>void</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Optimization:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Optimization</span><span class=p>(</span><span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;NoOptimization:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>NoOptimization</span><span class=p>(</span><span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>bar</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>void</span> <span class=n>Optimization</span><span class=p>(</span><span class=kt>int</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>step</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>bar</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=m>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=m>2</span> <span class=p>*</span> <span class=n>step</span><span class=p>;</span> <span class=n>j</span> <span class=p>+=</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>j</span> <span class=p>+</span> <span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [MethodImpl(MethodImplOptions.NoOptimization)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>void</span> <span class=n>NoOptimization</span><span class=p>(</span><span class=kt>int</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>step</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>bar</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=m>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=m>2</span> <span class=p>*</span> <span class=n>step</span><span class=p>;</span> <span class=n>j</span> <span class=p>+=</span> <span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>j</span> <span class=p>+</span> <span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If you compile the code in the Release-x64 mode and run it with JIT-x64, you see the following result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Optimization:
</span></span><span class=line><span class=cl>10
</span></span><span class=line><span class=cl>21
</span></span><span class=line><span class=cl>NoOptimization:
</span></span><span class=line><span class=cl>10
</span></span><span class=line><span class=cl>11
</span></span></code></pre></div><p>Unexpectedly, is not it? JIT-x64 has played a dirty trick on us and spent optimizing crooked. Some important facts:</p><ul><li><code>step</code> is a method argument.</li><li>Both of the loops start with zero and have the <code>step</code> increment..</li><li><code>j+10</code> prints on the Console, <code>i+10</code> stores in a local variable per each first loop iteration.</li></ul><p>These conditions (and several tricky additional conditions) allows JIT-x64 to perform an sub-expression elimination optimization. Unfortunately he does it wrong.</p><h3 id=jit-x86>JIT-x86</h3><p>At first, we will look to the assembler code for JIT-x86. We want to make sure that it is a code without any troubles.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=c>; Optimization, JIT-x86
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=nf>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>i</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; i &lt; step; i++)                
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>DA</span>  <span class=no>in</span>          <span class=no>al</span><span class=p>,</span><span class=no>dx</span>                           
</span></span><span class=line><span class=cl><span class=mi>008400</span><span class=no>DB</span>  <span class=no>push</span>        <span class=no>edi</span>                             
</span></span><span class=line><span class=cl><span class=mi>008400</span><span class=no>DC</span>  <span class=no>push</span>        <span class=no>esi</span>                             
</span></span><span class=line><span class=cl><span class=mi>008400</span><span class=no>DD</span>  <span class=no>push</span>        <span class=no>ebx</span>                             
</span></span><span class=line><span class=cl><span class=mi>008400</span><span class=no>DE</span>  <span class=no>sub</span>         <span class=no>esp</span><span class=p>,</span><span class=mi>8</span>                           
</span></span><span class=line><span class=cl><span class=mi>008400</span><span class=no>E1</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-14h</span><span class=p>],</span><span class=no>ecx</span>         
</span></span><span class=line><span class=cl><span class=mi>008400</span><span class=no>E4</span>  <span class=no>mov</span>         <span class=no>edi</span><span class=p>,</span><span class=no>edx</span>                         <span class=c>; edi=edx (edi=step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>E6</span>  <span class=no>xor</span>         <span class=no>edx</span><span class=p>,</span><span class=no>edx</span>                         <span class=c>; edx=0
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>E8</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-10h</span><span class=p>],</span><span class=no>edx</span>         <span class=c>; [ebp-10h]=edx (i=0)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>EB</span>  <span class=no>test</span>        <span class=no>edi</span><span class=p>,</span><span class=no>edi</span>                         
</span></span><span class=line><span class=cl><span class=mi>008400</span><span class=no>ED</span>  <span class=no>jle</span>         <span class=mi>00840125</span>                        
</span></span><span class=line><span class=cl>        <span class=err>{</span>                                             
</span></span><span class=line><span class=cl>            <span class=no>bar</span> <span class=err>=</span> <span class=no>i</span> <span class=err>+</span> <span class=mi>10</span><span class=c>;                             
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>EF</span>  <span class=no>mov</span>         <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-10h</span><span class=p>]</span>         <span class=c>; eax=[ebp-10h] (eax=i)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>F2</span>  <span class=no>add</span>         <span class=no>eax</span><span class=p>,</span><span class=mi>0</span><span class=no>Ah</span>                         <span class=c>; eax+=0Ah (eax=i+10)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>F5</span>  <span class=no>mov</span>         <span class=no>edx</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-14h</span><span class=p>]</span>         <span class=c>; edx=&amp;this
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>F8</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>edx</span><span class=err>+</span><span class=mi>4</span><span class=p>],</span><span class=no>eax</span>           <span class=c>; [edx+4]=eax (bar=i+10)
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>j</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; j &lt; 2 * step; j += step)  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>FB</span>  <span class=no>xor</span>         <span class=no>esi</span><span class=p>,</span><span class=no>esi</span>                         <span class=c>; esi=0 (j=0)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>FD</span>  <span class=no>mov</span>         <span class=no>ebx</span><span class=p>,</span><span class=no>edi</span>                         <span class=c>; ebx=edi (ebx=step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>008400</span><span class=no>FF</span>  <span class=no>add</span>         <span class=no>ebx</span><span class=p>,</span><span class=no>ebx</span>                         <span class=c>; ebx+=edx (ebx=2*step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00840101</span>  <span class=no>test</span>        <span class=no>ebx</span><span class=p>,</span><span class=no>ebx</span>                         
</span></span><span class=line><span class=cl><span class=mi>00840103</span>  <span class=no>jle</span>         <span class=mi>0084011</span><span class=no>D</span>                        
</span></span><span class=line><span class=cl>                <span class=no>Console.WriteLine</span><span class=p>(</span><span class=no>j</span> <span class=err>+</span> <span class=mi>10</span><span class=p>)</span><span class=c>;            
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00840105</span>  <span class=no>call</span>        <span class=mi>72</span><span class=no>EE0258</span>                        
</span></span><span class=line><span class=cl><span class=mi>0084010</span><span class=no>A</span>  <span class=no>mov</span>         <span class=no>ecx</span><span class=p>,</span><span class=no>eax</span>                         
</span></span><span class=line><span class=cl><span class=mi>0084010</span><span class=no>C</span>  <span class=no>lea</span>         <span class=no>edx</span><span class=p>,[</span><span class=no>esi</span><span class=err>+</span><span class=mi>0</span><span class=no>Ah</span><span class=p>]</span>                   <span class=c>; edx=[esi+0Ah] (edx=j+10)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0084010</span><span class=no>F</span>  <span class=no>mov</span>         <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ecx</span><span class=p>]</span>             
</span></span><span class=line><span class=cl><span class=mi>00840111</span>  <span class=no>mov</span>         <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>38</span><span class=no>h</span><span class=p>]</span>         
</span></span><span class=line><span class=cl><span class=mi>00840114</span>  <span class=no>call</span>        <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>eax</span><span class=err>+</span><span class=mi>14</span><span class=no>h</span><span class=p>]</span>             <span class=c>; Console.WriteLine(edx)
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>j</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; j &lt; 2 * step; j += step)  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00840117</span>  <span class=no>add</span>         <span class=no>esi</span><span class=p>,</span><span class=no>edi</span>                         <span class=c>; esi+=edi (j+=step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00840119</span>  <span class=no>cmp</span>         <span class=no>esi</span><span class=p>,</span><span class=no>ebx</span>                         <span class=c>; if esi&lt;ebx (j&lt;2*step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0084011</span><span class=no>B</span>  <span class=no>jl</span>          <span class=mi>00840105</span>                        <span class=c>; jump to loop start (j)
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>i</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; i &lt; step; i++)                
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0084011</span><span class=no>D</span>  <span class=no>inc</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-10h</span><span class=p>]</span>             <span class=c>; [ebp-10h]++ (i++)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00840120</span>  <span class=no>cmp</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>ebp-10h</span><span class=p>],</span><span class=no>edi</span>         <span class=c>; if [ebp-10h]&lt;edi (i&lt;step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00840123</span>  <span class=no>jl</span>          <span class=mi>008400</span><span class=no>EF</span>                        <span class=c>; jump to loop start (i)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00840125</span>  <span class=no>lea</span>         <span class=no>esp</span><span class=p>,[</span><span class=no>ebp-0Ch</span><span class=p>]</span>                   
</span></span><span class=line><span class=cl><span class=mi>00840128</span>  <span class=no>pop</span>         <span class=no>ebx</span>                             
</span></span><span class=line><span class=cl><span class=mi>00840129</span>  <span class=no>pop</span>         <span class=no>esi</span>                             
</span></span><span class=line><span class=cl><span class=mi>0084012</span><span class=no>A</span>  <span class=no>pop</span>         <span class=no>edi</span>                             
</span></span><span class=line><span class=cl><span class=mi>0084012</span><span class=no>B</span>  <span class=no>pop</span>         <span class=no>ebp</span>                             
</span></span><span class=line><span class=cl><span class=mi>0084012</span><span class=no>C</span>  <span class=no>ret</span>                                         
</span></span></code></pre></div><p>The result is right, we can see the expected result on the Console:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Optimization:
</span></span><span class=line><span class=cl>10
</span></span><span class=line><span class=cl>11
</span></span><span class=line><span class=cl>NoOptimization:
</span></span><span class=line><span class=cl>10
</span></span><span class=line><span class=cl>11
</span></span></code></pre></div><h3 id=jit-x64>JIT-x64</h3><p>Now, we will take the JIT-x64 assembler code and start with the <code>NoOptimization</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=c>; NoOptimization, JIT-x64
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=nf>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>i</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; i &lt; step; i++)                 
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202A5</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>8</span><span class=p>],</span><span class=no>ecx</span>    
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87202A9</span>  <span class=no>sub</span>         <span class=no>rsp</span><span class=p>,</span><span class=mi>38</span><span class=no>h</span>                  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87202AD</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>20</span><span class=no>h</span><span class=p>],</span><span class=mi>0</span>    <span class=c>; [rsp+20h]=0 (i=0)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202B5</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>24</span><span class=no>h</span><span class=p>],</span><span class=mi>0</span>    <span class=c>; [rsp+24h]=0 (j=0)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202BD</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>20</span><span class=no>h</span><span class=p>],</span><span class=mi>0</span>    <span class=c>; [rsp+20h]=0 (i=0)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202C5</span>  <span class=no>jmp</span>         <span class=mi>00007</span><span class=no>FFCC8720316</span>         
</span></span><span class=line><span class=cl>        <span class=err>{</span>                                              
</span></span><span class=line><span class=cl>            <span class=no>bar</span> <span class=err>=</span> <span class=no>i</span> <span class=err>+</span> <span class=mi>10</span><span class=c>;                              
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202C7</span>  <span class=no>mov</span>         <span class=no>ecx</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>20</span><span class=no>h</span><span class=p>]</span>  <span class=c>; ecx=[rsp+20h] (ecx=i)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202CB</span>  <span class=no>add</span>         <span class=no>ecx</span><span class=p>,</span><span class=mi>0</span><span class=no>Ah</span>                  <span class=c>; ecx+=10 (ecx=i+10)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202CE</span>  <span class=no>mov</span>         <span class=no>rax</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>40</span><span class=no>h</span><span class=p>]</span>  <span class=c>; rax=&amp;this
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202D3</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=mi>8</span><span class=p>],</span><span class=no>ecx</span>    <span class=c>; [rax+8]=ecx (bar=i+10)
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>j</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; j &lt; 2 * step; j += step)   
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202D6</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>24</span><span class=no>h</span><span class=p>],</span><span class=mi>0</span>    <span class=c>; [rsp+24h]=0 (j)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202DE</span>  <span class=no>jmp</span>         <span class=mi>00007</span><span class=no>FFCC87202FC</span>         
</span></span><span class=line><span class=cl>                <span class=no>Console.WriteLine</span><span class=p>(</span><span class=no>j</span> <span class=err>+</span> <span class=mi>10</span><span class=p>)</span><span class=c>;             
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202E0</span>  <span class=no>mov</span>         <span class=no>ecx</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>24</span><span class=no>h</span><span class=p>]</span>  <span class=c>; ecx=[rsp+24h] (ecx=j)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202E4</span>  <span class=no>add</span>         <span class=no>ecx</span><span class=p>,</span><span class=mi>0</span><span class=no>Ah</span>                  <span class=c>; ecx+=10
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202E7</span>  <span class=no>call</span>        <span class=mi>00007</span><span class=no>FFD273DCF10</span>         <span class=c>; Console.WriteLine(j+10)
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>j</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; j &lt; 2 * step; j += step)   
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202EC</span>  <span class=no>mov</span>         <span class=no>r11d</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>48</span><span class=no>h</span><span class=p>]</span> <span class=c>; r11d=[rsp+48h] (r11d=step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202F1</span>  <span class=no>mov</span>         <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>24</span><span class=no>h</span><span class=p>]</span>  <span class=c>; eax=[rsp+24h] (eax=j)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202F5</span>  <span class=no>add</span>         <span class=no>eax</span><span class=p>,</span><span class=no>r11d</span>                 <span class=c>; eax+=r11d (eax=j+step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202F8</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>24</span><span class=no>h</span><span class=p>],</span><span class=no>eax</span>  <span class=c>; [rsp+24h]=eax (j=j+step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87202FC</span>  <span class=no>mov</span>         <span class=no>eax</span><span class=p>,</span><span class=mi>2</span>                    <span class=c>; eax=2
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720301</span>  <span class=no>imul</span>        <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>48</span><span class=no>h</span><span class=p>]</span>  <span class=c>; eax*=[rsp+48h] (eax=2*step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720306</span>  <span class=no>cmp</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>24</span><span class=no>h</span><span class=p>],</span><span class=no>eax</span>  <span class=c>; if [resp+24h]&lt;eax (j&lt;2*step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC872030A</span>  <span class=no>jl</span>          <span class=mi>00007</span><span class=no>FFCC87202E0</span>         <span class=c>; jump to loop start (j)
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>i</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; i &lt; step; i++)                 
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC872030C</span>  <span class=no>mov</span>         <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>20</span><span class=no>h</span><span class=p>]</span>  <span class=c>; eax=[rsp+20h] (i)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720310</span>  <span class=no>inc</span>         <span class=no>eax</span>                      <span class=c>; eax++ (eax=i+1)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720312</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>20</span><span class=no>h</span><span class=p>],</span><span class=no>eax</span>  <span class=c>; [rsp+20h]=eax (i=i+1)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720316</span>  <span class=no>mov</span>         <span class=no>eax</span><span class=p>,</span><span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>48</span><span class=no>h</span><span class=p>]</span>  <span class=c>; eax=[rsp+48h] (eax=step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC872031A</span>  <span class=no>cmp</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>20</span><span class=no>h</span><span class=p>],</span><span class=no>eax</span>  <span class=c>; if [rsp+20h]&lt;eax (i&lt;step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC872031E</span>  <span class=no>jl</span>          <span class=mi>00007</span><span class=no>FFCC87202C7</span>         <span class=c>; jump to loop start (i)
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=err>}</span>                                              
</span></span><span class=line><span class=cl>    <span class=err>}</span>                                                  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720320</span>  <span class=no>jmp</span>         <span class=mi>00007</span><span class=no>FFCC8720322</span>         
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720322</span>  <span class=no>nop</span>                                  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720323</span>  <span class=no>add</span>         <span class=no>rsp</span><span class=p>,</span><span class=mi>38</span><span class=no>h</span>                  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720327</span>  <span class=no>ret</span>                                  
</span></span></code></pre></div><p>Ok, it is fine, go to the opimized method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=c>; Optimization, JIT-x64
</span></span></span><span class=line><span class=cl><span class=c></span>       <span class=nf>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>i</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; i &lt; step; i++)                 
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201C2</span>  <span class=no>push</span>        <span class=no>rsi</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201C3</span>  <span class=no>push</span>        <span class=no>rdi</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201C4</span>  <span class=no>push</span>        <span class=no>r12</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201C6</span>  <span class=no>push</span>        <span class=no>r13</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201C8</span>  <span class=no>push</span>        <span class=no>r14</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201CA</span>  <span class=no>push</span>        <span class=no>r15</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201CC</span>  <span class=no>sub</span>         <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span>                 
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201D0</span>  <span class=no>mov</span>         <span class=no>ebx</span><span class=p>,</span><span class=no>edx</span>                 <span class=c>; ebx=step
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201D2</span>  <span class=no>mov</span>         <span class=no>r12</span><span class=p>,</span><span class=no>rcx</span>                 <span class=c>; r12=&amp;this
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201D5</span>  <span class=no>lea</span>         <span class=no>r15d</span><span class=p>,[</span><span class=no>rbx</span><span class=err>+</span><span class=mi>0</span><span class=no>Ah</span><span class=p>]</span>          <span class=c>; r15d=rbx+10 (r15d=step+10)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201D9</span>  <span class=no>test</span>        <span class=no>ebx</span><span class=p>,</span><span class=no>ebx</span>                 
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201DB</span>  <span class=no>jle</span>         <span class=mi>00007</span><span class=no>FFCC8720260</span>        
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201E1</span>  <span class=no>xor</span>         <span class=no>esi</span><span class=p>,</span><span class=no>esi</span>                 <span class=c>; esi=0 (i=0)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201E3</span>  <span class=no>mov</span>         <span class=no>edi</span><span class=p>,</span><span class=mi>0</span><span class=no>Ah</span>                 <span class=c>; edi=10 ((i+10)=10)
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>j</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; j &lt; 2 * step; j += step)  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201E8</span>  <span class=no>mov</span>         <span class=no>ebp</span><span class=p>,</span><span class=mi>2</span>                   <span class=c>; ebp=2
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201ED</span>  <span class=no>imul</span>        <span class=no>ebp</span><span class=p>,</span><span class=no>ebx</span>                 <span class=c>; ebp*=ebx (ebp=2*step)
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=err>{</span>                                             
</span></span><span class=line><span class=cl>            <span class=no>bar</span> <span class=err>=</span> <span class=no>i</span> <span class=err>+</span> <span class=mi>10</span><span class=c>;                             
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201F0</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r12</span><span class=err>+</span><span class=mi>8</span><span class=p>],</span><span class=no>edi</span>   <span class=c>; bar=edi
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>j</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; j &lt; 2 * step; j += step)  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201F5</span>  <span class=no>test</span>        <span class=no>ebp</span><span class=p>,</span><span class=no>ebp</span>                 
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201F7</span>  <span class=no>jle</span>         <span class=mi>00007</span><span class=no>FFCC8720256</span>        
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC87201F9</span>  <span class=no>xor</span>         <span class=no>r13d</span><span class=p>,</span><span class=no>r13d</span>               <span class=c>; r13d=0 (j=0)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC87201FC</span>  <span class=no>mov</span>         <span class=no>r14d</span><span class=p>,</span><span class=mi>0</span><span class=no>Ah</span>                <span class=c>; r14d=10                     // !!!
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720202</span>  <span class=no>nop</span>         <span class=no>word</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=p>]</span>      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720210</span>  <span class=no>mov</span>         <span class=no>rax</span><span class=p>,</span><span class=mi>0</span><span class=no>FC2B841138h</span>        
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC872021A</span>  <span class=no>mov</span>         <span class=no>rax</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=p>]</span>     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC872021D</span>  <span class=no>test</span>        <span class=no>rax</span><span class=p>,</span><span class=no>rax</span>                 
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720220</span>  <span class=no>jne</span>         <span class=mi>00007</span><span class=no>FFCC8720230</span>        
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720222</span>  <span class=no>mov</span>         <span class=no>cl</span><span class=p>,</span><span class=mi>1</span>                    
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720224</span>  <span class=no>call</span>        <span class=mi>00007</span><span class=no>FFD26C0D960</span>        
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720229</span>  <span class=no>nop</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=p>]</span>         
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720230</span>  <span class=no>mov</span>         <span class=no>rcx</span><span class=p>,</span><span class=mi>0</span><span class=no>FC2B841138h</span>        
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC872023A</span>  <span class=no>mov</span>         <span class=no>rcx</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rcx</span><span class=p>]</span>     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC872023D</span>  <span class=no>mov</span>         <span class=no>rax</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rcx</span><span class=p>]</span>     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720240</span>  <span class=no>mov</span>         <span class=no>r8</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=mi>60</span><span class=no>h</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720244</span>  <span class=no>mov</span>         <span class=no>edx</span><span class=p>,</span><span class=no>r14d</span>                <span class=c>; edx=r14d                     // !!!
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720247</span>  <span class=no>call</span>        <span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>r8</span><span class=err>+</span><span class=mi>28</span><span class=no>h</span><span class=p>]</span>      <span class=c>; Console.WriteLine(edx)       // !!!
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC872024B</span>  <span class=no>add</span>         <span class=no>r13d</span><span class=p>,</span><span class=no>ebx</span>                <span class=c>; r13d+=ebx (j+=step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC872024E</span>  <span class=no>add</span>         <span class=no>r14d</span><span class=p>,</span><span class=no>r15d</span>               <span class=c>; r14d+=r15d (r14d+=(step+10)) // !!!
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720251</span>  <span class=no>cmp</span>         <span class=no>r13d</span><span class=p>,</span><span class=no>ebp</span>                <span class=c>; if r13d&lt;ebp (j&lt;2*step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720254</span>  <span class=no>jl</span>          <span class=mi>00007</span><span class=no>FFCC8720210</span>        <span class=c>; jump to loop start (j)
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>i</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; i &lt; step; i++)                
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720256</span>  <span class=no>inc</span>         <span class=no>esi</span>                     <span class=c>; esi++ (i++)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC8720258</span>  <span class=no>inc</span>         <span class=no>edi</span>                     <span class=c>; edi++ ((i+10)++)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC872025A</span>  <span class=no>cmp</span>         <span class=no>esi</span><span class=p>,</span><span class=no>ebx</span>                 <span class=c>; if esi&lt;ebx (i&lt;step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC872025C</span>  <span class=no>jl</span>          <span class=mi>00007</span><span class=no>FFCC87201F0</span>        <span class=c>; jump to loop start (i)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC872025E</span>  <span class=no>xchg</span>        <span class=no>ax</span><span class=p>,</span><span class=no>ax</span>                   
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720260</span>  <span class=no>add</span>         <span class=no>rsp</span><span class=p>,</span><span class=mi>28</span><span class=no>h</span>                 
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720264</span>  <span class=no>pop</span>         <span class=no>r15</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720266</span>  <span class=no>pop</span>         <span class=no>r14</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720268</span>  <span class=no>pop</span>         <span class=no>r13</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC872026A</span>  <span class=no>pop</span>         <span class=no>r12</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC872026C</span>  <span class=no>pop</span>         <span class=no>rdi</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC872026D</span>  <span class=no>pop</span>         <span class=no>rsi</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC872026E</span>  <span class=no>pop</span>         <span class=no>rbp</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC872026F</span>  <span class=no>pop</span>         <span class=no>rbx</span>                     
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC8720270</span>  <span class=no>ret</span>                                 
</span></span></code></pre></div><p>If you have some time to explore the above listing, you&rsquo;ll see that the problem is related with the <code>r14d</code> register which is used for output. At the beginning of the nested loop, it is initialized by <code>10</code>. Next, it increases by <code>step + 10</code> on each iteration (although the increment should be equal to <code>step</code>).</p><p>There is a <a href=https://connect.microsoft.com/VisualStudio/feedback/details/812093/>bug report</a> in MS Connect about the issue. Unfortunately, the bug status is sad:</p><blockquote><p>Status: Closed as Won&rsquo;t Fix Won&rsquo;t Fix. Due to several factors the product team decided to focus its efforts on other items.</p></blockquote><h3 id=ryujit>RyuJIT</h3><p>Let&rsquo;s download and install RyuJIT CTP5, set the <code>HKLM\SOFTWARE\Microsoft\.NETFramework\AltJit='*'</code> key in the regedit, and look to the x64 assembler code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=c>; Optimization, RyuJIT
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=nf>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>i</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; i &lt; step; i++)                 
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F0160</span>  <span class=no>push</span>        <span class=no>r14</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0162</span>  <span class=no>push</span>        <span class=no>rdi</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0163</span>  <span class=no>push</span>        <span class=no>rsi</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0164</span>  <span class=no>push</span>        <span class=no>rbp</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0165</span>  <span class=no>push</span>        <span class=no>rbx</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0166</span>  <span class=no>sub</span>         <span class=no>rsp</span><span class=p>,</span><span class=mi>20</span><span class=no>h</span>                  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F016A</span>  <span class=no>mov</span>         <span class=no>rdi</span><span class=p>,</span><span class=no>rcx</span>                  <span class=c>; rdi=&amp;this
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F016D</span>  <span class=no>mov</span>         <span class=no>esi</span><span class=p>,</span><span class=no>edx</span>                  <span class=c>; esi=edx (esi=step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F016F</span>  <span class=no>xor</span>         <span class=no>ebx</span><span class=p>,</span><span class=no>ebx</span>                  <span class=c>; ebx=0 (i=0)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F0171</span>  <span class=no>test</span>        <span class=no>esi</span><span class=p>,</span><span class=no>esi</span>                  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0173</span>  <span class=no>jle</span>         <span class=mi>00007</span><span class=no>FFCC86F01AA</span>         
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0175</span>  <span class=no>mov</span>         <span class=no>ebp</span><span class=p>,</span><span class=no>esi</span>                  <span class=c>; ebp=esi (ebp=step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F0177</span>  <span class=no>shl</span>         <span class=no>ebp</span><span class=p>,</span><span class=mi>1</span>                    <span class=c>; ebp*=2 (ebp=2*step)
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=err>{</span>                                              
</span></span><span class=line><span class=cl>            <span class=no>bar</span> <span class=err>=</span> <span class=no>i</span> <span class=err>+</span> <span class=mi>10</span><span class=c>;                              
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F0179</span>  <span class=no>lea</span>         <span class=no>eax</span><span class=p>,[</span><span class=no>rbx</span><span class=err>+</span><span class=mi>0</span><span class=no>Ah</span><span class=p>]</span>            <span class=c>; eax=[rbx+0Ah] (eax=i+10)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F017C</span>  <span class=no>mov</span>         <span class=no>dword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rdi</span><span class=err>+</span><span class=mi>8</span><span class=p>],</span><span class=no>eax</span>    <span class=c>; [rdi+8]=eax (bar=i+10)
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>j</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; j &lt; 2 * step; j += step)   
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F017F</span>  <span class=no>xor</span>         <span class=no>r14d</span><span class=p>,</span><span class=no>r14d</span>                <span class=c>; r14d=0 (j=0)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F0182</span>  <span class=no>test</span>        <span class=no>ebp</span><span class=p>,</span><span class=no>ebp</span>                  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0184</span>  <span class=no>jle</span>         <span class=mi>00007</span><span class=no>FFCC86F01A4</span>         
</span></span><span class=line><span class=cl>                <span class=no>Console.WriteLine</span><span class=p>(</span><span class=no>j</span> <span class=err>+</span> <span class=mi>10</span><span class=p>)</span><span class=c>;             
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F0186</span>  <span class=no>call</span>        <span class=mi>00007</span><span class=no>FFD26C0AFA0</span>         
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F018B</span>  <span class=no>mov</span>         <span class=no>rcx</span><span class=p>,</span><span class=no>rax</span>                  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F018E</span>  <span class=no>lea</span>         <span class=no>edx</span><span class=p>,[</span><span class=no>r14</span><span class=err>+</span><span class=mi>0</span><span class=no>Ah</span><span class=p>]</span>            <span class=c>; edx=r14+0Ah (edx=j+10)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F0192</span>  <span class=no>mov</span>         <span class=no>rax</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=p>]</span>      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0195</span>  <span class=no>mov</span>         <span class=no>rax</span><span class=p>,</span><span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=mi>60</span><span class=no>h</span><span class=p>]</span>  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F0199</span>  <span class=no>call</span>        <span class=no>qword</span> <span class=no>ptr</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=mi>28</span><span class=no>h</span><span class=p>]</span>      <span class=c>; Console.WriteLine(edx)
</span></span></span><span class=line><span class=cl><span class=c></span>            <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>j</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; j &lt; 2 * step; j += step)   
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F019C</span>  <span class=no>add</span>         <span class=no>r14d</span><span class=p>,</span><span class=no>esi</span>                 <span class=c>; r14d+=esi (j+=step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F019F</span>  <span class=no>cmp</span>         <span class=no>r14d</span><span class=p>,</span><span class=no>ebp</span>                 <span class=c>; if (r14d&lt;ebp) (j&lt;2*step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F01A2</span>  <span class=no>jl</span>          <span class=mi>00007</span><span class=no>FFCC86F0186</span>         <span class=c>; jump to loop start (j)
</span></span></span><span class=line><span class=cl><span class=c></span>        <span class=no>for</span> <span class=p>(</span><span class=no>int</span> <span class=no>i</span> <span class=err>=</span> <span class=mi>0</span><span class=c>; i &lt; step; i++)                 
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F01A4</span>  <span class=no>inc</span>         <span class=no>ebx</span>                      <span class=c>; ebx++ (i++)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F01A6</span>  <span class=no>cmp</span>         <span class=no>ebx</span><span class=p>,</span><span class=no>esi</span>                  <span class=c>; if ebx&lt;esi (i&lt;step)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F01A8</span>  <span class=no>jl</span>          <span class=mi>00007</span><span class=no>FFCC86F0179</span>         <span class=c>; jump to loop start (i)
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00007</span><span class=no>FFCC86F01AA</span>  <span class=no>add</span>         <span class=no>rsp</span><span class=p>,</span><span class=mi>20</span><span class=no>h</span>                  
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F01AE</span>  <span class=no>pop</span>         <span class=no>rbx</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F01AF</span>  <span class=no>pop</span>         <span class=no>rbp</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F01B0</span>  <span class=no>pop</span>         <span class=no>rsi</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F01B1</span>  <span class=no>pop</span>         <span class=no>rdi</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F01B2</span>  <span class=no>pop</span>         <span class=no>r14</span>                      
</span></span><span class=line><span class=cl><span class=mi>00007</span><span class=no>FFCC86F01B4</span>  <span class=no>ret</span>                                  
</span></span></code></pre></div><p>Everything is fine: clever optimization are absent, the code works correctly.</p><h3 id=summary>Summary</h3><p>The JIT-x86 and RyuJIT CTP5 don&rsquo;t have the described bug. However, it is exist in JIT-x64. Most likely, it will not going anywhere.</p><p>You should understand, there is no perfect software. .NET is not an exception. Bugs in the JIT are extremely rare, but it is useful to bear in mind that thay may exist.</p><h3 id=links>Links</h3><ul><li><a href=http://stackoverflow.com/questions/20701701/jit-net-compiler-bug>StackOverflow: JIT .Net compiler bug?</a></li><li><a href=https://connect.microsoft.com/VisualStudio/feedback/details/812093/x64-jitter-sub-expression-elimination-optimizer-bug>MS Connect: x64 jitter sub-expression elimination optimizer bug</a></li></ul><br><br><div class=row><div class="justify-content-center share-block"><div class=share-title>Share:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fsubexpression-elimination-bug-in-jit-x64%2f&title=A%20bug%20story%20about%20JIT-x64" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=A%20bug%20story%20about%20JIT-x64&url=https%3a%2f%2faakinshin.net%2fposts%2fsubexpression-elimination-bug-in-jit-x64%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fsubexpression-elimination-bug-in-jit-x64%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fsubexpression-elimination-bug-in-jit-x64%2f&title=A%20bug%20story%20about%20JIT-x64" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class="blog-footer mt-auto"><div class=container><p>&copy; 2013&mdash;2022 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub></i></a>
<a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter></i></a>
<a href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS></i></a>
|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.c26550621ac13c2221d7f6f5e6fe862345d3919723c50d730893e3e4856ecf35.js></script>
<script src=/js/bootstrap.bundle.min.js></script>
<script src=/js/anchor.min.js></script>
<script src=https://aakinshin.net/js/custom.min.f6e5d13fe39f305056cc743ee4cb8d117c1aba26176e58c82c79a480d02fe4b7.js></script></body></html>