<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Mathematics,Statistics,Research,Research: P² quantile estimator"><title>P² quantile estimator marker adjusting order | Andrey Akinshin</title><meta name=description content="I have already written a few blog posts about the P² quantile estimator (which is a sequential estimator that uses \(O(1)\) memory):
P² quantile estimator:..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=https://aakinshin.net/sass/bootstrap-light.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=https://aakinshin.net/sass/bootstrap-dark.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.d7f6578e23ad3f0c33c589f9bcb34f995b45121f1f3ce888869c86b26826c845.js></script>
<script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.9e68d431432744c07a43381a8a833ffe0921cc0e006d84ad97f0b0d43c5cd82d.mjs></script>
<link href=https://aakinshin.net/css/main.min.4521fdf961aba8dee11ce56edc3cfa07845a0629c82e528856f1558c230aea2f.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body class="d-flex flex-column min-vh-100"><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><svg class="fai"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></li><li class=nav-item><a class=nav-link id=nav-link-posts href=https://aakinshin.net/posts/>Posts</a></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li></ul><ul class="navbar-nav ms-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>P² quantile estimator marker adjusting order</h1><span class=blog-post-meta><svg class="fai"><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2022-01-11>January 11, 2022</time>
&nbsp;&nbsp;<svg class="fai"><use xlink:href="/img/fa/all.svg#tag"/></svg>
<a href=https://aakinshin.net/tags/mathematics/ class="badge badge-info">Mathematics</a>
<a href=https://aakinshin.net/tags/statistics/ class="badge badge-info">Statistics</a>
<a href=https://aakinshin.net/tags/research/ class="badge badge-info">Research</a>
<a href=https://aakinshin.net/tags/research-p2qe/ class="badge badge-info">Research: P² quantile estimator</a></span><br><br><p>I have already written a few blog posts about the P² quantile estimator
(which is a sequential estimator that uses <span class="math inline">\(O(1)\)</span> memory):</p><ul><li><a href=https://aakinshin.net/posts/p2-quantile-estimator/>P² quantile estimator: estimating the median without storing values</a></li><li><a href=https://aakinshin.net/posts/p2-quantile-estimator-rounding-issue/>P² quantile estimator rounding issue</a></li><li><a href=https://aakinshin.net/posts/p2-quantile-estimator-initialization/>P² quantile estimator initialization strategy</a></li></ul><p>In this post, we continue improving the P² implementation
so that it gives better estimations for streams with a small number of elements.</p><h3 id=the-problem>The problem</h3><p>In the <a href=https://aakinshin.net/posts/p2-quantile-estimator-initialization/>previous post</a>,
I have performed the following experiment:</p><blockquote><p>We enumerate different distributions (the standard uniform, the standard normal),
different sample sizes (6, 7, 8),
and different quantile probabilities (0.05, 0.1, 0.2, 0.8, 0.9, 0.95).
For each combination of the input parameters, we perform 10000 simulations of the sample experiment:
generate a random sample of the given size from the given distribution
and estimate the given quantile using the classic initialization strategy and
the new adaptive initialization strategy.
As a baseline, we use the traditional Hyndman-Fan Type 7 quantile estimator.
The initialization strategy that gives a better estimation (compared to the baseline)
is the &ldquo;winner&rdquo; of the corresponding experiment.
For each combination of the input parameters, we calculate the percentage of wins for each strategy.</p></blockquote><p>Here is the source code of this simulation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>random</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>(</span><span class=m>1729</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>distributions</span> <span class=p>=</span> <span class=k>new</span> <span class=n>IContinuousDistribution</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>UniformDistribution</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=n>NormalDistribution</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;                 Classic Adaptive&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>distribution</span> <span class=k>in</span> <span class=n>distributions</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=kt>int</span> <span class=n>n</span> <span class=k>in</span> <span class=k>new</span><span class=p>[]</span> <span class=p>{</span> <span class=m>6</span><span class=p>,</span> <span class=m>7</span><span class=p>,</span> <span class=m>8</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>probability</span> <span class=k>in</span> <span class=k>new</span> <span class=n>Probability</span><span class=p>[]</span> <span class=p>{</span> <span class=m>0.05</span><span class=p>,</span> <span class=m>0.1</span><span class=p>,</span> <span class=m>0.2</span><span class=p>,</span> <span class=m>0.8</span><span class=p>,</span> <span class=m>0.9</span><span class=p>,</span> <span class=m>0.95</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>randomGenerator</span> <span class=p>=</span> <span class=n>distribution</span><span class=p>.</span><span class=n>Random</span><span class=p>(</span><span class=n>random</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>int</span> <span class=n>totalIterations</span> <span class=p>=</span> <span class=m>10_000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>classicIsWinner</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>iteration</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>iteration</span> <span class=p>&lt;</span> <span class=n>totalIterations</span><span class=p>;</span> <span class=n>iteration</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>p2ClassicEstimator</span> <span class=p>=</span> <span class=k>new</span> <span class=n>P2QuantileEstimator</span><span class=p>(</span><span class=n>probability</span><span class=p>,</span> <span class=n>P2QuantileEstimator</span><span class=p>.</span><span class=n>InitializationStrategy</span><span class=p>.</span><span class=n>Classic</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>p2AdaptiveEstimator</span> <span class=p>=</span> <span class=k>new</span> <span class=n>P2QuantileEstimator</span><span class=p>(</span><span class=n>probability</span><span class=p>,</span> <span class=n>P2QuantileEstimator</span><span class=p>.</span><span class=n>InitializationStrategy</span><span class=p>.</span><span class=n>Adaptive</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>values</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>x</span> <span class=p>=</span> <span class=n>randomGenerator</span><span class=p>.</span><span class=n>Next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>values</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>p2ClassicEstimator</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>p2AdaptiveEstimator</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>simpleEstimation</span> <span class=p>=</span> <span class=n>SimpleQuantileEstimator</span><span class=p>.</span><span class=n>Instance</span><span class=p>.</span><span class=n>GetQuantile</span><span class=p>(</span><span class=n>values</span><span class=p>,</span> <span class=n>probability</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>p2ClassicEstimation</span> <span class=p>=</span> <span class=n>p2ClassicEstimator</span><span class=p>.</span><span class=n>GetQuantile</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>p2AdaptiveEstimation</span> <span class=p>=</span> <span class=n>p2AdaptiveEstimator</span><span class=p>.</span><span class=n>GetQuantile</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Math</span><span class=p>.</span><span class=n>Abs</span><span class=p>(</span><span class=n>p2ClassicEstimation</span> <span class=p>-</span> <span class=n>simpleEstimation</span><span class=p>)</span> <span class=p>&lt;</span> <span class=n>Math</span><span class=p>.</span><span class=n>Abs</span><span class=p>(</span><span class=n>p2AdaptiveEstimation</span> <span class=p>-</span> <span class=n>simpleEstimation</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>classicIsWinner</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>adaptiveIsWinner</span> <span class=p>=</span> <span class=n>totalIterations</span> <span class=p>-</span> <span class=n>classicIsWinner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=n>title</span> <span class=p>=</span>  <span class=n>distribution</span><span class=p>.</span><span class=n>GetType</span><span class=p>().</span><span class=n>Name</span><span class=p>.</span><span class=n>Replace</span><span class=p>(</span><span class=s>&#34;Distribution&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span><span class=n>PadRight</span><span class=p>(</span><span class=m>7</span><span class=p>)</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> 
</span></span><span class=line><span class=cl>                    <span class=s>&#34;P&#34;</span> <span class=p>+</span> <span class=p>(</span><span class=n>probability</span> <span class=p>*</span> <span class=m>100</span><span class=p>).</span><span class=n>ToString</span><span class=p>().</span><span class=n>PadRight</span><span class=p>(</span><span class=m>2</span><span class=p>)</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> 
</span></span><span class=line><span class=cl>                    <span class=s>&#34;N&#34;</span> <span class=p>+</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>$&#34;{title,-15}: {classicIsWinner / 100.0,6:N2}% {(adaptiveIsWinner / 100.0),6:N2}%&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>I got the following results for the Uniform and the Normal distributions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>                 Classic Adaptive
</span></span><span class=line><span class=cl>Uniform P5  N6 :   1.31%  98.69%
</span></span><span class=line><span class=cl>Uniform P10 N6 :   2.62%  97.38%
</span></span><span class=line><span class=cl>Uniform P20 N6 :  11.44%  88.56%
</span></span><span class=line><span class=cl>Uniform P80 N6 :   0.97%  99.03%
</span></span><span class=line><span class=cl>Uniform P90 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>Uniform P95 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Uniform P5  N7 :   4.00%  96.00%
</span></span><span class=line><span class=cl>Uniform P10 N7 :  14.68%  85.32%
</span></span><span class=line><span class=cl>Uniform P20 N7 :  24.52%  75.48%
</span></span><span class=line><span class=cl>Uniform P80 N7 :  10.41%  89.59%
</span></span><span class=line><span class=cl>Uniform P90 N7 :  10.31%  89.69%
</span></span><span class=line><span class=cl>Uniform P95 N7 :   1.14%  98.86%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Uniform P5  N8 :   7.50%  92.50%
</span></span><span class=line><span class=cl>Uniform P10 N8 :  22.87%  77.13%
</span></span><span class=line><span class=cl>Uniform P20 N8 :  35.12%  64.88%
</span></span><span class=line><span class=cl>Uniform P80 N8 :  24.98%  75.02%
</span></span><span class=line><span class=cl>Uniform P90 N8 :  17.81%  82.19%
</span></span><span class=line><span class=cl>Uniform P95 N8 :   3.94%  96.06%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Normal  P5  N6 :   1.73%  98.27%
</span></span><span class=line><span class=cl>Normal  P10 N6 :   3.80%  96.20%
</span></span><span class=line><span class=cl>Normal  P20 N6 :  13.93%  86.07%
</span></span><span class=line><span class=cl>Normal  P80 N6 :   1.55%  98.45%
</span></span><span class=line><span class=cl>Normal  P90 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>Normal  P95 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Normal  P5  N7 :   5.86%  94.14%
</span></span><span class=line><span class=cl>Normal  P10 N7 :  21.15%  78.85%
</span></span><span class=line><span class=cl>Normal  P20 N7 :  27.72%  72.28%
</span></span><span class=line><span class=cl>Normal  P80 N7 :  12.34%  87.66%
</span></span><span class=line><span class=cl>Normal  P90 N7 :  14.50%  85.50%
</span></span><span class=line><span class=cl>Normal  P95 N7 :   1.54%  98.46%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Normal  P5  N8 :   9.18%  90.82%
</span></span><span class=line><span class=cl>Normal  P10 N8 :  32.63%  67.37%
</span></span><span class=line><span class=cl>Normal  P20 N8 :  38.88%  61.12%
</span></span><span class=line><span class=cl>Normal  P80 N8 :  28.81%  71.19%
</span></span><span class=line><span class=cl>Normal  P90 N8 :  25.45%  74.55%
</span></span><span class=line><span class=cl>Normal  P95 N8 :   4.92%  95.08%
</span></span></code></pre></div><p>Since both the Normal and the Uniform distributions are symmetric,
we could expect symmetric results.
However, the result table is asymmetric:
the obtained numbers for P5/P10/P20 don&rsquo;t match the corresponding numbers for P80/P90/P95.</p><h3 id=the-solution>The solution</h3><p>The final stage of the P² quantile estimator suggest adjusting
non-extreme marker heights (<span class="math inline">\(q_i\)</span>) and positions (<span class="math inline">\(n_i\)</span>) for <span class="math inline">\(i \in \{ 1, 2, 3\} \)</span>
(see the <a href=https://aakinshin.net/posts/p2-quantile-estimator/#marker-invalidation>algorithm description</a>
and the original paper <a href=#Jain1985>[Jain1985]</a> for details):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;=</span> <span class=m>3</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=p>=</span> <span class=n>nꞌ</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>d</span> <span class=p>&gt;=</span>  <span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span>  <span class=m>1</span> <span class=p>||</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span> <span class=p>&lt;=</span> <span class=p>-</span><span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&lt;</span> <span class=p>-</span><span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span> <span class=p>=</span> <span class=n>sign</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>qꞌ</span> <span class=p>=</span> <span class=n>Parabolic</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(!(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>&lt;</span> <span class=n>qꞌ</span> <span class=p>&amp;&amp;</span> <span class=n>qꞌ</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=n>qꞌ</span> <span class=p>=</span> <span class=n>Linear</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>qꞌ</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+=</span> <span class=n>d</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The core equation of the algorithm is a piecewise-parabolic prediction (P²) formula
that adjusts marker heights for each observation:</p><p><span class="math display">\[q'_i = q_i + \dfrac{d}{n_{i+1}-n_{i-1}} \cdot
\Bigg(
(n_i-n_{i-1}+d)\dfrac{q_{i+1}-q_i}{n_{i+1}-n_i} +
(n_{i+1}-n_i-d)\dfrac{q_i-q_{i-1}}{n_i-n_{i-1}}
\Bigg).
\]</span></p><p>Once we calculated <span class="math inline">\(q'_i\)</span>, we should check that <span class="math inline">\(q_{i-1} < q'_i < q_{i+1}\)</span>.
If this condition is false, we should ignore the parabolic prediction and use the linear prediction instead:</p><p><span class="math display">\[q'_i = q_i + d \dfrac{q_{i+d}-q_i}{n_{i+d}-n_{i}}.
\]</span></p><p>The problem arises when the number of elements in a stream is small and we use
<a href=https://aakinshin.net/posts/p2-quantile-estimator-initialization/>an adjusted initialization strategy</a>.
Since we could have collisions across <span class="math inline">\(\{ n_i \}\)</span>,
the order of adjusting is important.
Currently, it&rsquo;s optimal only for higher quantiles (<span class="math inline">\(p > 0.5\)</span>), but not for lower quantiles (<span class="math inline">\(p < 0.5\)</span>).
Let&rsquo;s extract the adjusting logic from the above snippet to named method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;=</span> <span class=m>3</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=n>Adjust</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span></code></pre></div><p>Now it&rsquo;s easy to introduce an adaptive adjusting order depending on the value of <span class="math inline">\(p\)</span>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=p>&gt;=</span> <span class=m>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;=</span> <span class=m>3</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=n>Adjust</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>3</span><span class=p>;</span> <span class=n>i</span> <span class=p>&gt;=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>--)</span>
</span></span><span class=line><span class=cl>        <span class=n>Adjust</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>if we run the simulation from the beginning of the post, we get the following result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>                 Classic Adaptive
</span></span><span class=line><span class=cl>Uniform P5  N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>Uniform P10 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>Uniform P20 N6 :   0.84%  99.16%
</span></span><span class=line><span class=cl>Uniform P80 N6 :   0.97%  99.03%
</span></span><span class=line><span class=cl>Uniform P90 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>Uniform P95 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Uniform P5  N7 :   1.19%  98.81%
</span></span><span class=line><span class=cl>Uniform P10 N7 :   9.47%  90.53%
</span></span><span class=line><span class=cl>Uniform P20 N7 :  10.77%  89.23%
</span></span><span class=line><span class=cl>Uniform P80 N7 :  10.41%  89.59%
</span></span><span class=line><span class=cl>Uniform P90 N7 :  10.31%  89.69%
</span></span><span class=line><span class=cl>Uniform P95 N7 :   1.14%  98.86%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Uniform P5  N8 :   3.91%  96.09%
</span></span><span class=line><span class=cl>Uniform P10 N8 :  17.48%  82.52%
</span></span><span class=line><span class=cl>Uniform P20 N8 :  25.13%  74.87%
</span></span><span class=line><span class=cl>Uniform P80 N8 :  24.98%  75.02%
</span></span><span class=line><span class=cl>Uniform P90 N8 :  17.81%  82.19%
</span></span><span class=line><span class=cl>Uniform P95 N8 :   3.94%  96.06%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Normal  P5  N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>Normal  P10 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>Normal  P20 N6 :   1.63%  98.37%
</span></span><span class=line><span class=cl>Normal  P80 N6 :   1.55%  98.45%
</span></span><span class=line><span class=cl>Normal  P90 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>Normal  P95 N6 :   0.00% 100.00%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Normal  P5  N7 :   1.81%  98.19%
</span></span><span class=line><span class=cl>Normal  P10 N7 :  13.87%  86.13%
</span></span><span class=line><span class=cl>Normal  P20 N7 :  12.85%  87.15%
</span></span><span class=line><span class=cl>Normal  P80 N7 :  12.34%  87.66%
</span></span><span class=line><span class=cl>Normal  P90 N7 :  14.50%  85.50%
</span></span><span class=line><span class=cl>Normal  P95 N7 :   1.54%  98.46%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Normal  P5  N8 :   4.84%  95.16%
</span></span><span class=line><span class=cl>Normal  P10 N8 :  25.05%  74.95%
</span></span><span class=line><span class=cl>Normal  P20 N8 :  28.43%  71.57%
</span></span><span class=line><span class=cl>Normal  P80 N8 :  28.81%  71.19%
</span></span><span class=line><span class=cl>Normal  P90 N8 :  25.45%  74.55%
</span></span><span class=line><span class=cl>Normal  P95 N8 :   4.92%  95.08%
</span></span></code></pre></div><p>Now it looks quite symmetric.
The problem is solved!</p><h3 id=the-updated-reference-implementation>The updated reference implementation</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>P2QuantileEstimator</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=kt>double</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=n>InitializationStrategy</span> <span class=n>strategy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=kt>int</span><span class=p>[]</span> <span class=n>n</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int</span><span class=p>[</span><span class=m>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>ns</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=m>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>readonly</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>q</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=m>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>Count</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>enum</span> <span class=n>InitializationStrategy</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Classic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Adaptive</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>P2QuantileEstimator</span><span class=p>(</span><span class=kt>double</span> <span class=n>probability</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=n>InitializationStrategy</span> <span class=n>strategy</span> <span class=p>=</span> <span class=n>InitializationStrategy</span><span class=p>.</span><span class=n>Classic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=p>=</span> <span class=n>probability</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>strategy</span> <span class=p>=</span> <span class=n>strategy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>void</span> <span class=n>Add</span><span class=p>(</span><span class=kt>double</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>&lt;</span> <span class=m>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>[</span><span class=n>Count</span><span class=p>++]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>==</span> <span class=m>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Array</span><span class=p>.</span><span class=n>Sort</span><span class=p>(</span><span class=n>q</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>5</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>strategy</span> <span class=p>==</span> <span class=n>InitializationStrategy</span><span class=p>.</span><span class=n>Adaptive</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Array</span><span class=p>.</span><span class=n>Copy</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>ns</span><span class=p>,</span> <span class=m>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Round</span><span class=p>(</span><span class=m>2</span> <span class=p>*</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Round</span><span class=p>(</span><span class=m>4</span> <span class=p>*</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Round</span><span class=p>(</span><span class=m>2</span> <span class=p>+</span> <span class=m>2</span> <span class=p>*</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>q</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>n</span><span class=p>[</span><span class=m>1</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>                    <span class=n>q</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>n</span><span class=p>[</span><span class=m>2</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>                    <span class=n>q</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>n</span><span class=p>[</span><span class=m>3</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=m>2</span> <span class=p>*</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=m>4</span> <span class=p>*</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=m>2</span> <span class=p>+</span> <span class=m>2</span> <span class=p>*</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>4</span><span class=p>]</span> <span class=p>=</span> <span class=m>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>[</span><span class=m>4</span><span class=p>]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=n>k</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>5</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]++;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>Count</span> <span class=p>*</span> <span class=n>p</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=n>Count</span> <span class=p>*</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=n>Count</span> <span class=p>*</span> <span class=p>(</span><span class=m>1</span> <span class=p>+</span> <span class=n>p</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>4</span><span class=p>]</span> <span class=p>=</span> <span class=n>Count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=p>&gt;=</span> <span class=m>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;=</span> <span class=m>3</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                <span class=n>Adjust</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>3</span><span class=p>;</span> <span class=n>i</span> <span class=p>&gt;=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>--)</span>
</span></span><span class=line><span class=cl>                <span class=n>Adjust</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Count</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>void</span> <span class=n>Adjust</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>d</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>d</span> <span class=p>&gt;=</span> <span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=m>1</span> <span class=p>||</span> <span class=n>d</span> <span class=p>&lt;=</span> <span class=p>-</span><span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&lt;</span> <span class=p>-</span><span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>dInt</span> <span class=p>=</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sign</span><span class=p>(</span><span class=n>d</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>qs</span> <span class=p>=</span> <span class=n>Parabolic</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>dInt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>&lt;</span> <span class=n>qs</span> <span class=p>&amp;&amp;</span> <span class=n>qs</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>qs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>Linear</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>dInt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+=</span> <span class=n>dInt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=kt>double</span> <span class=n>Parabolic</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=kt>double</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>d</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span> <span class=p>*</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>d</span><span class=p>)</span> <span class=p>*</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>d</span><span class=p>)</span> <span class=p>*</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=kt>double</span> <span class=n>Linear</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=kt>int</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>d</span> <span class=p>*</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=n>d</span><span class=p>]</span> <span class=p>-</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=n>d</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>double</span> <span class=n>GetQuantile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidOperationException</span><span class=p>(</span><span class=s>&#34;Sequence contains no elements&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>&lt;=</span> <span class=m>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Array</span><span class=p>.</span><span class=n>Sort</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>Count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>index</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Round</span><span class=p>((</span><span class=n>Count</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span> <span class=p>*</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=n>index</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=m>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>void</span> <span class=n>Clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Count</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=references>References</h3><ul><li><b id=Jain1985>[Jain1985]</b><br>Jain, Raj, and Imrich Chlamtac.
&ldquo;The P² algorithm for dynamic calculation of quantiles and histograms without storing observations.&rdquo;
Communications of the ACM 28, no. 10 (1985): 1076-1085.<br><a href=https://doi.org/10.1145/4372.4378>https://doi.org/10.1145/4372.4378</a></li></ul><br><br><div class=row><div class="justify-content-center share-block"><div class=share-title>Share:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fp2-quantile-estimator-adjusting-order%2f&title=P%c2%b2%20quantile%20estimator%20marker%20adjusting%20order" target=_blank title="Share on Reddit"><svg class="fai"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=P%c2%b2%20quantile%20estimator%20marker%20adjusting%20order&url=https%3a%2f%2faakinshin.net%2fposts%2fp2-quantile-estimator-adjusting-order%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fp2-quantile-estimator-adjusting-order%2f" target=_blank title="Share on HackerNews"><svg class="fai"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fp2-quantile-estimator-adjusting-order%2f&title=P%c2%b2%20quantile%20estimator%20marker%20adjusting%20order" target=_blank title="Add to Pocket"><svg class="fai"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><hr></div></div></main></div><footer class="blog-footer mt-auto"><div class=container><p>&copy; 2013&mdash;2022 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><svg class="fai"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a><a href=https://twitter.com/andrey_akinshin><svg class="fai"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a><a href=https://aakinshin.net/posts/index.xml><svg class="fai"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a>|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://aakinshin.net/js/theme-after.min.29520a8e1176193da7ea4e6cb56cf9b3e634b867c9979234d8dafb5ab61dd494.js></script>
<script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>