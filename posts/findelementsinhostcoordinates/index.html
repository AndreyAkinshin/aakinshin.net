<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,C#,Silverlight,WinRT"><title>Strange behavior of FindElementsInHostCoordinates in WinRT | Andrey Akinshin</title><meta name=description content="Silverlight features a splendid method: VisualTreeHelper.FindElementsInHostCoordinates. It allows the HitTest, i.e. makes it possible for a point or rectan..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.852cec611cdd74c8e940745d8a06d6c32796c1f728bee243cbd8b0a4a9377c67.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Strange behavior of FindElementsInHostCoordinates in WinRT</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2014-04-29>April 29, 2014</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/silverlight/>Silverlight</a>
<a class=label-link href=https://aakinshin.net/tags/winrt/>WinRT</a></div></div><br><div class=main-content><p>Silverlight features a splendid method: <a href="http://msdn.microsoft.com/en-us/library/system.windows.media.visualtreehelper.findelementsinhostcoordinates(v=vs.95).aspx">VisualTreeHelper.FindElementsInHostCoordinates</a>. It allows the <code>HitTest</code>, i.e. makes it possible for a point or rectangle to search for all visual sub-tree objects that intersect this rectangle or point. Formally the same method <a href=http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.media.visualtreehelper.findelementsinhostcoordinates.aspx>VisualTreeHelper.FindElementsInHostCoordinates</a> is available in WinRT. And it seems the method looks in the same way, but there is a little nuance. It works differently in different versions of the platform. So, let’s see what’s going on.</p><p>Let’s create a simple Silverlight 5 application. The markup will look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;Grid</span> <span class=na>x:Name=</span><span class=s>&#34;LayoutRoot&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;Grid.RowDefinitions&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;RowDefinition</span> <span class=na>Height=</span><span class=s>&#34;*&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;RowDefinition</span> <span class=na>Height=</span><span class=s>&#34;100&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/Grid.RowDefinitions&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;Canvas</span> <span class=na>MouseLeftButtonDown=</span><span class=s>&#34;OnMainCanvasMouseLeftButtonDown&#34;</span> 
</span></span><span class=line><span class=cl>          <span class=na>x:Name=</span><span class=s>&#34;MainCanvas&#34;</span> <span class=na>Background=</span><span class=s>&#34;LightGreen&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Ellipse</span> <span class=na>Width=</span><span class=s>&#34;200&#34;</span> <span class=na>Height=</span><span class=s>&#34;200&#34;</span> <span class=na>Fill=</span><span class=s>&#34;LightCoral&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Path</span> <span class=na>Fill=</span><span class=s>&#34;LightBlue&#34;</span> <span class=na>Data=</span><span class=s>&#34;M 10,100 C 10,300 300,-200 300,100&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/Canvas&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;TextBlock</span> <span class=na>Grid.Row=</span><span class=s>&#34;1&#34;</span> <span class=na>x:Name=</span><span class=s>&#34;StatusBlock&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/Grid&gt;</span>
</span></span></code></pre></div><p>It’s very simple: we have a <code>Canvas</code>, an <code>Ellipse</code> and a <code>Path</code> are on the Canvas. A <code>TextBlock</code> for entering some useful info is located under this wonderful masterpiece. The app looks in the following way:</p><p class=center><img src=/img/posts/dotnet/findelementsinhostcoordinates/screen1.png></p><p>Now we will add a mouse click event handler: we will get the elements we clicked on. Here we will use two versions of <code>VisualTreeHelper.FindElementsInHostCoordinates</code> (for point and for rectangle):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=n>IEnumerable</span> <span class=n>FindElementsInHostCoordinates</span><span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=n>Point</span> <span class=n>intersectingPoint</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=n>UIElement</span> <span class=n>subtree</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=n>IEnumerable</span> <span class=n>FindElementsInHostCoordinates</span><span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=n>Rect</span> <span class=n>intersectingRect</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=n>UIElement</span> <span class=n>subtree</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>A list of elements we get will be displayed in <code>StatusBlock</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>private</span> <span class=k>void</span> <span class=n>OnMainCanvasMouseLeftButtonDown</span><span class=p>(</span><span class=kt>object</span> <span class=n>sender</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                                             <span class=n>MouseButtonEventArgs</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>p</span> <span class=p>=</span> <span class=n>e</span><span class=p>.</span><span class=n>GetPosition</span><span class=p>(</span><span class=n>MainCanvas</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>listPoint</span> <span class=p>=</span> <span class=n>VisualTreeHelper</span><span class=p>.</span><span class=n>FindElementsInHostCoordinates</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>Point</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=n>X</span><span class=p>,</span> <span class=n>p</span><span class=p>.</span><span class=n>Y</span><span class=p>),</span> <span class=n>MainCanvas</span><span class=p>).</span><span class=n>ToList</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>listRect</span> <span class=p>=</span> <span class=n>VisualTreeHelper</span><span class=p>.</span><span class=n>FindElementsInHostCoordinates</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=k>new</span> <span class=n>Rect</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=n>X</span><span class=p>,</span> <span class=n>p</span><span class=p>.</span><span class=n>Y</span><span class=p>,</span> <span class=m>1</span><span class=p>,</span> <span class=m>1</span><span class=p>),</span> <span class=n>MainCanvas</span><span class=p>).</span><span class=n>ToList</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>strPoint</span> <span class=p>=</span> <span class=kt>string</span><span class=p>.</span><span class=n>Join</span><span class=p>(</span><span class=s>&#34;, &#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                   <span class=n>listPoint</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>el</span> <span class=p>=&gt;</span> <span class=n>el</span><span class=p>.</span><span class=n>GetType</span><span class=p>().</span><span class=n>Name</span><span class=p>.</span><span class=n>ToString</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>  <span class=kt>var</span> <span class=n>strRect</span> <span class=p>=</span> <span class=kt>string</span><span class=p>.</span><span class=n>Join</span><span class=p>(</span><span class=s>&#34;, &#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                   <span class=n>listRect</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>el</span> <span class=p>=&gt;</span> <span class=n>el</span><span class=p>.</span><span class=n>GetType</span><span class=p>().</span><span class=n>Name</span><span class=p>.</span><span class=n>ToString</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>  <span class=n>StatusBlock</span><span class=p>.</span><span class=n>Text</span> <span class=p>=</span> <span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;[{0}] vs [{1}]&#34;</span><span class=p>,</span> <span class=n>strPoint</span><span class=p>,</span> <span class=n>strRect</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Our perfect app is ready! Something tells me that considering the rectangle size (1×1) results of two method overloads won’t differ. Let’s check it by clicking on different areas. The picture below shows the result of this test:</p><p class=center><img src=/img/posts/dotnet/findelementsinhostcoordinates/screen2.png></p><p>Everything seems to be ok: all methods work as expected. Now let’s proceed to WinRT. Create a new Windows Store application and add the same markup to it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;Grid</span> <span class=na>Background=</span><span class=s>&#34;{StaticResource ApplicationPageBackgroundThemeBrush}&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;Grid.RowDefinitions&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;RowDefinition</span> <span class=na>Height=</span><span class=s>&#34;*&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;RowDefinition</span> <span class=na>Height=</span><span class=s>&#34;100&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/Grid.RowDefinitions&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;Canvas</span> <span class=na>Tapped=</span><span class=s>&#34;OnMainCanvasTapped&#34;</span> 
</span></span><span class=line><span class=cl>          <span class=na>x:Name=</span><span class=s>&#34;MainCanvas&#34;</span> <span class=na>Background=</span><span class=s>&#34;LightGreen&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Ellipse</span> <span class=na>Width=</span><span class=s>&#34;200&#34;</span> <span class=na>Height=</span><span class=s>&#34;200&#34;</span> <span class=na>Fill=</span><span class=s>&#34;LightCoral&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Path</span> <span class=na>Fill=</span><span class=s>&#34;LightBlue&#34;</span> <span class=na>Data=</span><span class=s>&#34;M 10,100 C 10,300 300,-200 300,100&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/Canvas&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;TextBlock</span> <span class=na>Grid.Row=</span><span class=s>&#34;1&#34;</span> <span class=na>x:Name=</span><span class=s>&#34;StatusBlock&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/Grid&gt;</span>
</span></span></code></pre></div><p>Code of the <code>OnMainCanvasTapped</code> handler matched <code>OnMainCanvasMouseLeftButtonDown</code> code. Let’s run the application and click on it. Results look as follows:</p><p class=center><img src=/img/posts/dotnet/findelementsinhostcoordinates/screen3.png></p><p>What a turn out! A short test of the app results in the following conclusion: point <code>HitTest</code> works in the same way as in the Silverlight application while rectangle HitTest for the Path-figures works not for the figure itself, but for its BoundingBox. WinRT applications are created based on the Touch First principle, that’s why Rect-version of the code if more interesting. In most cases this issue won’t be critical, but if an application is oriented to interaction with various arcuate elements, it’s better to pay special attention to the behavior of <code>FindElementsInHostCoordinates</code>.</p><h2 id=cross-posts>Cross-posts</h2><ul><li><a href=http://blogs.perpetuumsoft.com/silverlight/strange-behavior-of-findelementsinhostcoordinates-in-winrt/>blogs.perpetuumsoft.com</a></li></ul></div><br><br><div class="flex flex-wrap justify-center items-center">The source code of this post and all the relevant files are&nbsp;<a href=https://github.com/AndreyAkinshin/aakinshin.net/tree/master/content/en/posts/2014/findelementsinhostcoordinates.md>available on GitHub</a>.</div><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2ffindelementsinhostcoordinates%2f&title=Strange%20behavior%20of%20FindElementsInHostCoordinates%20in%20WinRT" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=Strange%20behavior%20of%20FindElementsInHostCoordinates%20in%20WinRT&url=https%3a%2f%2faakinshin.net%2fposts%2ffindelementsinhostcoordinates%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2ffindelementsinhostcoordinates%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2ffindelementsinhostcoordinates%2f&title=Strange%20behavior%20of%20FindElementsInHostCoordinates%20in%20WinRT" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>