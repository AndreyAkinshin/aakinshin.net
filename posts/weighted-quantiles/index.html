<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.123.7"><meta name=author content='Andrey Akinshin'><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content='Mathematics,Statistics,Research,Research: Weighted quantile estimators,Quantiles,Harrell-Davis quantile estimator'><title>Weighted quantile estimators | Andrey Akinshin</title>
<meta name=description content="Update 2021-07-06: the approach was updated using the Kish&amp;rsquo;s effective sample size.
In this post, I will show how to calculate weighted quantile estimates and how to use them in practice.
Let&amp;rsquo;s start with a problem from real life. Imagine that y..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.d6826f88345af20c0769a313557ec1355465a3091b1f9869b936f2504c4dfe26.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body class="flex flex-col min-h-screen"><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-2 xs:px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/library/>Library</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/about/>About</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/search/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#magnifying-glass"/></svg></a></div></div><button id=theme-toggle type=button title="Alt+Click to match OS color theme" class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6 flex-grow"><div class=main-post><h1 class=blog-post-title id=post-title>Weighted quantile estimators</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg>
<time datetime=2020-09-29>September 29, 2020</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#math"/></svg>
Mathematics
</a><a class=label-link href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#statistics"/></svg>
Statistics
</a><a class=label-link href=https://aakinshin.net/tags/research/>Research
</a><a class=label-link href=https://aakinshin.net/tags/research-wqe/>Research: Weighted quantile estimators
</a><a class=label-link href=https://aakinshin.net/tags/quantiles/>Quantiles
</a><a class=label-link href=https://aakinshin.net/tags/harrell-davis-quantile-estimator/>Harrell-Davis quantile estimator</a></div></div><br><div class="main-content mb-3 px-2 py-1 rounded border text-alert-text-l border-alert-frame-l dark:text-alert-text-d dark:border-alert-frame-d">Update: this blog post is a part of research that aimed to build weighed versions of various quantile estimators. A <a href=/posts/preprint-wqe/>preprint with final results</a> is available on arXiv: <a href=https://arxiv.org/abs/2304.07265>arXiv:2304.07265 [stat.ME]</a>. Some information in this blog post can be obsolete: please, use the preprint as the primary reference.</div><div class=main-content><p><strong>Update 2021-07-06:
the approach was updated using the <a href=https://aakinshin.net/posts/kish-ess-weighted-quantiles/>Kish&rsquo;s effective sample size</a>.</strong></p><p>In this post, I will show how to calculate weighted quantile estimates and how to use them in practice.</p><p>Let&rsquo;s start with a problem from real life.
Imagine that you measure the total duration of a unit test executed daily on a CI server.
Every day you get a single number that corresponds to the test duration from the latest revision for this day:</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/moving1-light.svg target=_blank class=imgldlink alt=moving1><picture><source theme=dark srcset=/posts/weighted-quantiles/img/moving1-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/moving1-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=600 src=/posts/weighted-quantiles/img/moving1-light.svg></picture></a></div></div><br><p>You collect a history of such measurements for 100 days.
Now you want to describe the &ldquo;actual&rdquo; distribution of the performance measurements.</p><p>However, for the latest &ldquo;actual&rdquo; revision, you have only a single measurement, which is not enough to build a distribution.
Also, you can&rsquo;t build a distribution based on the last N measurements because they can contain change points that will spoil your results.
So, what you really want to do is to use all the measurements, but older values should have a lower impact on the final distribution form.</p><p>Such a problem can be solved using the weighted quantiles!
This powerful approach can be applied to any time series regardless of the domain area.
In this post, we learn how to calculate and apply weighted quantiles.</p><h3 id=literature-overview>Literature overview</h3><p>When I started looking for a weighted quantile implementation,
I was sure that it should be easy to google some well explained sources.
Unfortunately, I didn&rsquo;t manage to find any workable approach.
Here are some of my findings (you can scroll to the next section if you are not interested in non-working approaches):</p><ul><li><a href=https://en.wikipedia.org/wiki/Percentile#Weighted_percentile>The weighted percentile method</a> on Wikipedia<br>A very strange formulation with missing details.
It doesn&rsquo;t seem to be true because it&rsquo;s based on two subsequent elements from the given sample.
Here is a simple counterexample for any formula which is based on two subsequent elements.
Imagine a sample $ \{ x_1, x_2, x_3, x_4 \}$ where $ x_1 \leq x_2 \leq x_3 \leq x_4 $ with weights $ \{ 1, 0, 1, 0 \} $.
I expect that the median value will be $ (x_1 + x_3) / 2$, but we can&rsquo;t get such a result using two subsequent elements.
If we have low weights around the element that corresponds to the target quantile, the formula should involve several elements from the original sample.</li><li><a href=https://stats.stackexchange.com/a/13223/261747>Answer for &ldquo;Defining quantiles over a weighted sample&rdquo;</a> on StackExchange.<br>The same problem here: a formula with two subsequent elements.</li><li><a href=https://blogs.sas.com/content/iml/2016/08/29/weighted-percentiles.html>Weighted percentiles</a> on SAS blogs.<br>It explains only the general concept of weighted quantiles, but it doesn&rsquo;t provide any details.
Although the main idea looks correct (it uses ECDF), it&rsquo;s hard to check and reuse it.</li></ul><p>Also, I found some implementations of weighted quantiles:</p><ul><li><a href=http://finzi.psych.upenn.edu/R/library/Hmisc/html/wtd.stats.html>Hmisc::wtd.quantile</a> (R)<br>Has a <a href=https://github.com/harrelfe/Hmisc/issues/97>critical bug</a>, doesn&rsquo;t work.
Designed only for the Harrell-Davis quantile estimator.</li><li><a href=https://www.rdocumentation.org/packages/reldist/versions/1.6-6/topics/wtd.quantile>reldist::wtd.quantile</a> (R)<br>Just <a href=https://github.com/cran/reldist/blob/5e5c9357b7ca27585a11bbcfb2e4a2ab6e37dd7b/R/wtd.quantile.R#L16>calls</a> <code>wtd.quantile</code> from <code>Hmisc</code></li><li><a href=https://github.com/FilippoBovo/robustats>FilippoBovo/robustats</a> (Python)<br>Produces very strange results.
<a href=https://github.com/FilippoBovo/robustats/blob/8d029001acaa7702fe5ecb33479664bb7cb0a3f7/robustats/robustats.py#L32>For example</a>, the weighted median value for $\{ 1.0, 2.0 \}$ with weights $\{ 1.0, 1.0 \}$ is $1.0$.</li></ul><p>The weighted quantiles look like a very natural concept to me.
So, I believe it should be explained somewhere, but I just didn&rsquo;t manage to find it.
If you know such a reference, I will appreciate if you share it with me.</p><p>Meanwhile, I decided to derive all the formulas myself because it sounds like a fun exercise.
In this post, I will show how to transform a non-weighted quantile estimator to a weighted one
and present exact formulas for the Harrell-Davis and Type 7 weighted quantile estimators.</p><h3 id=notation>Notation</h3><p>We will use the following notation:</p><ul><li>$x$: original sample. Assuming that it&rsquo;s always contain sorted real numbers.</li><li>$n$: the number of elements in the sample.</li><li>$x_i$: $i^\textrm{th}$ element of the sample.</li><li>$w$: a vector of weights. It has the same length as $x$. Assuming $w_i \geq 0$, $\sum_{i=1}^n w > 0$.</li><li>$s_i(w)$: partial sum of weights, $s_i(w) = \sum_{j=1}^{i} w_j$. Assuming $s_0(w) = 0$.</li><li>$q_p$: estimation of the $p^\textrm{th}$ quantile based on $x$.</li></ul><h3 id=weighted-quantiles>Weighted quantiles</h3><p>Let&rsquo;s say we have a sample $x = \{ x_1, x_2, \ldots, x_n \}$ and we want to calculate the $p^\textrm{th}$ quantile $q_p$.</p><div class=block-example><b><span class=block-example-title></span></b><br><em>Input:</em> $x = \{ 1, 2, 3, 4, 5 \}$ and $p = 0.5$.<br><em>Result:</em> $q_p = 3$.<br>Since $p = 0.5$, we are looking for the median, it&rsquo;s the middle element of a sorted sample which equals $3$ in our case.</div><p>Let&rsquo;s also consider a vector of weights $w = \{ w_1, w_2, \ldots, w_n \}$.
We assume that the weight of $x_i$ is $w_i$.
We want to calculate the $p^\textrm{th}$ quantile $q_p$ with respect to these weights.
To give you an idea of this concept, let&rsquo;s look at another example.</p><div class=block-example><b><span class=block-example-title></span></b><br><em>Input:</em> $x = \{ 1, 2, 3, 4, 5 \}$, $w = \{ 1, 0, 0, 1, 1 \}$, $p = 0.5$.<br><em>Result:</em> $q_p = 4$.<br>Here $w_2 = w_3 = 0$, which means that we can omit the second and the third element of the sample.
Since $w_1 = w_4 = w_5 = 1$, we can imagine that our sample was transformed to $\{ 1, 4, 5 \}$.
After that, it&rsquo;s easy to see that $q_p = 4$ because it&rsquo;s the middle element of the transformed sample.</div><p>It was an easy example because $w$ contained only zeros and ones.
What about more complicated cases when $w$ contains fractional numbers?
The exact formula for weighted quantiles depends on the used quantile estimator for the non-weighted case.
In this post, we consider two estimator kinds:</p><ul><li><strong>The Type 7 quantile estimator</strong><br>It&rsquo;s the most popular quantile estimator which is used by default in
R, Julia, NumPy, Excel (<code>PERCENTILE</code>, <code>PERCENTILE.INC</code>), Python (<code>inclusive</code> method).
We call it &ldquo;Type 7&rdquo; according to notation from <a href=https://aakinshin.net/library/papers/hyndman1996/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#paper"/></svg>hyndman1996</a>,
where Rob J. Hyndman and Yanan Fan described nine quantile algorithms which are used in statistical computer packages.</li><li><strong>The Harrell-Davis quantile estimator</strong><br>It&rsquo;s my favorite option in real life because
it&rsquo;s more efficient than classic quantile estimators based on linear interpolation,
and it provides more reliable estimations on small samples.
This quantile estimator is described in <a href=https://aakinshin.net/library/papers/harrell1982/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#paper"/></svg>harrell1982</a>.</li></ul><h3 id=weighted-harrell-davis-quantile-estimator>Weighted Harrell-Davis quantile estimator</h3><p>I start with the Harrell-Davis quantile estimator because it provides a more intuitive generalization for the weighted case.</p><p>Here is the formula for the Harrell-Davis quantile estimator:</p>$$
q_p = \sum_{i=1}^{n} W_{n,i} \cdot x_i,
$$
$$
W_{n,i} = I_{i/n} (p(n+1)), (1-p)(n+1)) - I_{(i-1)/n} (p(n+1), (1-p)(n+1))
$$<p>where $I_t(a, b)$ denotes the <a href=https://en.wikipedia.org/wiki/Beta_function#Incomplete_beta_function>regularized incomplete beta function</a>.
It&rsquo;s not a simple formula, so let&rsquo;s visualize it for better understanding.
$I_u (a, b)$ depends on three variables: $x$, $a$, and $b$.
The values of $a$ and $b$ and fixed for the given $p$:</p>$$
\left\{
\begin{array}{rccl}
a = & p     & \cdot & (n + 1),\\
b = & (1-p) & \cdot & (n + 1).
\end{array}
\right.
$$<p>Thus, we can rewrite the formula for $W_{n,i}$ as follows:</p>$$
W_{n,i} = I_{i/n}(a, b) - I_{(i-1)/n}(a, b).
$$<div class=block-example><b><span class=block-example-title></span></b><br><em>Input:</em> $n=9$, $p=0.25$ (we are looking for the first <a href=https://en.wikipedia.org/wiki/Quartile>quartile</a>).<br><em>Result:</em> $a = p(n+1) = 0.25 \cdot 10 = 2.5, \quad b = (1-p)(n+1) = 0.75 \cdot 10 = 7.5$.</div><p>Using the predefined $a$ and $b$, we can define the following function:</p>$$
g(t) = t^{a-1} (1-t)^{b-1}.
$$<div class=block-example><b><span class=block-example-title></span></b><br><p>For $a = 2.5$ and $b = 7.5$, $g(t)$ looks as follows:</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/hd1-light.svg target=_blank class=imgldlink alt=hd1><picture><source theme=dark srcset=/posts/weighted-quantiles/img/hd1-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/hd1-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/hd1-light.svg></picture></a></div></div><br></div><p>The value of the <a href=https://en.wikipedia.org/wiki/Beta_function>beta function</a> is the area under this curve:</p>$$
B(a,b) = \int_0^1 t^{a-1}(1-t)^{b-1}\,dt.
$$<p>The value of the <a href=https://en.wikipedia.org/wiki/Beta_function#Incomplete_beta_function>incomplete beta function</a> for $x$ is the area under this curve between $0$ and $x$:</p>$$
B(u; a,b) = \int_0^u t^{a-1}(1-t)^{b-1}\,dt.
$$<p>The value of the <em>regularized incomplete beta function</em> for $x$ is the normalized version of the incomplete beta function, so its value always belongs to $[0; 1]$.
To get the regularized version, we should divide the incomplete beta function by $B(a,b)$ (it&rsquo;s a constant for given $a$ and $b$).</p>$$
I_u(a,b) = \frac{B(u;\,a,b)}{B(a,b)}.
$$<div class=block-example><b><span class=block-example-title></span></b><br><p>$I_{0.25}(a, b)$ corresponds to the area of the highlighted area on the following plot:</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/hd2-light.svg target=_blank class=imgldlink alt=hd2><picture><source theme=dark srcset=/posts/weighted-quantiles/img/hd2-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/hd2-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/hd2-light.svg></picture></a></div></div><br></div><p>Here are a few additional facts which are good to understand:</p><ul><li>$I_{0.0}(a, b) = 0.0$, it&rsquo;s the minimum value of this function.</li><li>$I_{1.0}(a, b) = 1.0$, it&rsquo;s the maximum value of this function and the area under the curve on the above plot.</li><li>$I_u(a,b)$ is also the <a href=https://en.wikipedia.org/wiki/Cumulative_distribution_function>cumulative distribution function</a> (CDF) for the <a href=https://en.wikipedia.org/wiki/Beta_distribution>Beta distribution</a>.</li><li>Regularized version of $g(t)$ is the <a href=https://en.wikipedia.org/wiki/Probability_density_function>probability density function</a> (PDF) of the Beta distribution:
$f(t) = g(t) / B(a, b) = t^{a-1} (1-t)^{b-1} / B(a, b)$.
On the above and below plots, we are working with PDF.</li></ul><p>Now we can visualize $W_{n,i} = I_{i/n}(a, b) - I_{(i-1)/n}(a, b)$.
Each $W_{n,i}$ corresponds to a fragment of our plot.</p><div class=block-example><b><span class=block-example-title></span></b><br><p><em>Input:</em> $n=9$, $p=0.25$, $a=2.5$, $b=7.5$.<br>In this case, we get 9 fragments of $I_u(a,b)$ (last two segments are almost invisible):</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/hd3-light.svg target=_blank class=imgldlink alt=hd3><picture><source theme=dark srcset=/posts/weighted-quantiles/img/hd3-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/hd3-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/hd3-light.svg></picture></a></div></div><br><p>$W_{n,i}$ equals the area of the $i^\textrm{th}$ fragment.</p></div><p>We work with the <em>regularized</em> version of the incomplete beta function, so the sum of these fragments equals $1$:</p>$$
\sum_{i=1}^n W_{n, i} = 1.
$$<p>Since $q_p = \sum_{i=1}^{n} W_{n,i} \cdot x_i$, the $W_{n, i}$ coefficients define the &ldquo;contribution&rdquo; of $x_i$ to the quantile value.</p><p>Now it&rsquo;s time to convert our non-weighted quantile estimator to a weighted one.
First of all, we should introduce the concept of &ldquo;weighted sample size.&rdquo;
We are going to use the <a href=https://aakinshin.net/posts/kish-ess-weighted-quantiles/>Kish&rsquo;s effective sample size</a>:</p>$$
n^* = \frac{\Big( \sum_{i=1}^n w_i \Big)^2}{\sum_{i=1}^n w_i^2 }.
$$<p>Thus, the weighted sample size of $w = \{1, 1, 1, 0, 0 \}$ and $w = \{ 1, 1, 1 \}$ is $3$ for both cases.
This value has an influence on the values of $a$ and $b$.
Here are the updated equations for the weighted case:</p>$$
\left\{
\begin{array}{rccl}
a^* = & p     & \cdot & (n^* + 1),\\
b^* = & (1-p) & \cdot & (n^* + 1).
\end{array}
\right.
$$<p>Next, I suggest changing how we choose the width of the $I_u(a,b)$ fragments.
Currently, the endpoints of the $i^\textrm{th}$ fragment are</p>$$
\left\{
\begin{array}{rcc}
l_i & = & \dfrac{i - 1}{n},\\
r_i & = & \dfrac{i}{n}.
\end{array}
\right.
$$<p>All the fragments have the same width which equals $1/n$.
Let&rsquo;s introduce new endpoints in such a way that the width of the fragment will be equal to $w_i/s_n(w)$:</p>$$
\left\{
\begin{array}{rcc}
l^*_i & = & \dfrac{s_{i-1}(w)}{s_n(w)},\\
r^*_i & = & \dfrac{s_i(w)}{s_n(w)}.
\end{array}
\right.
$$<p>It&rsquo;s a generalization of the non-weighted case because $l_i = l^*_i, r_i = r^*_i$ when all weights are equal (e.g., $\forall i: w_i = 1$).
Now we can introduce a &ldquo;weighted version&rdquo; of $W_{n, i}$:</p>$$
W^*_{n, i} = I_{r^*_i}(a^*, b^*) - I_{l^*_i}(a^*, b^*).
$$<p>Here is the final formula for the weighted Harrell-Davis quantile estimator:</p>$$
q^*_p = \sum_{i=1}^{n} W^*_{n,i} \cdot x_i.
$$<div class=block-example><b><span class=block-example-title></span></b><br><p><em>Input:</em> $x = \{ 1, 2, 3, 4, 5 \}$, $w = \{ 1, 0, 0, 1, 1 \}$, $p = 0.5$.</p><p>Without weights, we had the following five equal-width fragments:</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/hd4-light.svg target=_blank class=imgldlink alt=hd4><picture><source theme=dark srcset=/posts/weighted-quantiles/img/hd4-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/hd4-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/hd4-light.svg></picture></a></div></div><br><p>With weights, the second and the third fragments will be eliminated.
It means that now we have three equal fragments (for $x_1$, $x_4$, $x_5$):</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/hd5-light.svg target=_blank class=imgldlink alt=hd5><picture><source theme=dark srcset=/posts/weighted-quantiles/img/hd5-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/hd5-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/hd5-light.svg></picture></a></div></div><br></div><div class=block-example><b><span class=block-example-title></span></b><br><p><em>Input:</em> $x = \{ 1, 2, 3, 4, 5 \}$, $w = \{ 0.4, 0.4, 0.05, 0.05, 0.1 \}$, $p = 0.5$.<br>The new value of $w$ defines another Kish’s effective sample size
($n^*\approx 2.985$; $a^*=b^*\approx 1.993$)
and introduces another fragmentation:</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/hd6-light.svg target=_blank class=imgldlink alt=hd6><picture><source theme=dark srcset=/posts/weighted-quantiles/img/hd6-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/hd6-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/hd6-light.svg></picture></a></div></div><br><p>As we can see, $x_1$ and $x_2$ have a major impact on the median value because they have high weights: $w_1 = w_2 = 0.4$.
Meanwhile, $x_3$, $x_4$, and $x_5$ have a minor impact because they have low weights: $w_3 = 0.05$, $w_4 = 0.05$, $w_5 = 0.1$.
The weighted median value $q^*_{0.5}$ is $\approx 1.8416$.</p></div><h3 id=the-generalization>The generalization</h3><p>We can generalize this approach for any non-weighted quantile estimator.
Let&rsquo;s say we can express the non-weighted equations via a CDF function $F$ in the following way:</p>$$
\begin{gather*}
q_p = \sum_{i=1}^{n} W_{n,i} \cdot x_i,\\
W_{n, i} = F(r_i) - F(l_i),\\
l_i = (i - 1) / n, \quad r_i = i / n.
\end{gather*}
$$<p>In this case, we can generalize it to the weighted case using an altered version of above equations:</p>$$
\begin{gather*}
q^*_p = \sum_{i=1}^{n} W^*_{n,i} \cdot x_i,\\
W^*_{n, i} = F(r^*_i) - F(l^*_i),\\
l^*_i = s_{i-1}(w) / s_n(w), \quad r^*_i = s_i(w) / s_n(w).
\end{gather*}
$$<p>It can be easily transformed back to the non-weighted case if we put $w_i = 1$ for any $i$.</p><p>In the case of the Harrell-Davis quantile estimator, we should put $F(u) = I_u(a^*, b^*)$.</p><h3 id=weighted-type-7-quantile-estimator>Weighted Type 7 quantile estimator</h3><p>First of all, let&rsquo;s recall the <a href=https://en.wikipedia.org/wiki/Quantile#Estimating_quantiles_from_a_sample>formula</a> for the Type 7 quantile estimator in the non-weighted case.
In order to do that, we should calculate the real valued index $h = p (n - 1) + 1$.
After that, the quantile value can be calculated using the following formula:</p>$$
q_p = x_{\lfloor h \rfloor} + (h - \lfloor h \rfloor) (x_{\lfloor h \rfloor + 1} - x_{\lfloor h \rfloor}).
$$<p>To get the non-weighted case formula in the generic form, we should express it via a CDF function (let&rsquo;s call it $F_7$).
It has the following form:</p>$$
F_7(u) = \left\{
\begin{array}{lcrcllr}
0 & \textrm{for} &         &      & u & <    & (h-1)/n, \\
un-h+1 & \textrm{for} & (h-1)/n & \leq & u  & \leq & h/n, \\
1 & \textrm{for} & h/n     & <    & u. &      &
\end{array}
\right.
$$<p>The corresponding PDF (let&rsquo;s call it $f_7$) looks simpler:</p>$$
f_7(u) = F'_7(u) = \left\{
\begin{array}{lcrcllr}
0 & \textrm{for} &         &      & u & <    & (h-1)/n, \\
n      & \textrm{for} & (h-1)/n & \leq & u  & \leq & h/n, \\
0 & \textrm{for} & h/n     & <    & u. &      &
\end{array}
\right.
$$<div class=block-example><b><span class=block-example-title></span></b><br><p><em>Input:</em> $n = 5$, $p = 0.25$.<br>We have $h = 2$ which gives us the following plots:</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/type7-1-light.svg target=_blank class=imgldlink alt=type7-1><picture><source theme=dark srcset=/posts/weighted-quantiles/img/type7-1-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/type7-1-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/type7-1-light.svg></picture></a></div></div><br></div><p>Let&rsquo;s verify that it works the correct way for the non-weighted case using $W_{n,i} = F_7(i / n) - F_7((i - 1) / n)$:</p><ul><li>Assuming $h$ is an integer number.<br>For $i < h$, we have $W_{n,i} = 0 - 0 = 0$.<br>For $i = h$, we have $W_{n,i} = 1 - 0 = 1$.<br>For $i > h$, we have $W_{n,i} = 1 - 1 = 0$.<br>Thus, $q_p = \sum_{i=1}^{n} W_{n,i} \cdot x_i = x_h = x_{\lfloor h \rfloor} + (h - \lfloor h \rfloor) (x_{\lfloor h \rfloor + 1} - x_{\lfloor h \rfloor})$.</li></ul><div class=block-example><b><span class=block-example-title></span></b><br><p><em>Input:</em> $n = 5$, $p = 0.25$.<br>We have $h = 2$, which is an integer number.
Here are the corresponding PDF and CDF plots:</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/type7-2-light.svg target=_blank class=imgldlink alt=type7-2><picture><source theme=dark srcset=/posts/weighted-quantiles/img/type7-2-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/type7-2-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/type7-2-light.svg></picture></a></div></div><br><p>It&rsquo;s easy to see that we have only one non-negative $W_{n,i}$: $W_{5,2} = 1$.
It means that $q_{0.25} = x_2$, which satisfies our expectations (the first quartile of a sample with five elements is the second element).</p></div><ul><li>Assuming $h$ is a non-integer number.<br>For $i < \lfloor h \rfloor$, we have $W_{n,i} = 0 - 0 = 0$.<br>For $i = \lfloor h \rfloor$, we have $W_{n,i} = (\lfloor h \rfloor/n \cdot n - h + 1) - 0 = \lfloor h \rfloor - h + 1$.<br>For $i = \lfloor h \rfloor + 1$, we have $W_{n,i} = 1 - (\lfloor h \rfloor/n \cdot n - h + 1) = h - \lfloor h \rfloor $.<br>For $i > \lfloor h \rfloor + 1$, we have $W_{n,i} = 1 - 1 = 0$.<br>Thus, $q_p = \sum_{i=1}^{n} W_{n,i} \cdot x_i = (\lfloor h \rfloor - h + 1) x_{\lfloor h \rfloor} + (h - \lfloor h \rfloor) x_{\lfloor h \rfloor + 1} = x_{\lfloor h \rfloor} + (h - \lfloor h \rfloor) (x_{\lfloor h \rfloor + 1} - x_{\lfloor h \rfloor})$.</li></ul><div class=block-example><b><span class=block-example-title></span></b><br><p><em>Input:</em> $n = 5$, $p = 0.35$.<br>We have $h = 2.4$ which is a non-integer number.
Thus, the $0.35^\textrm{th}$ quantile estimation is a linear combination of $x_2$ and $x_3$:</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/type7-3-light.svg target=_blank class=imgldlink alt=type7-3><picture><source theme=dark srcset=/posts/weighted-quantiles/img/type7-3-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/type7-3-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/type7-3-light.svg></picture></a></div></div><br></div><p>As we can see, the suggested $F_7$ perfectly matches the non-weighted case.
Using equations from the previous section, we can get the weighted case.</p><div class=block-example><b><span class=block-example-title></span></b><br><em>Input:</em> $n = 5$, $x = \{ 1, 2, 3, 4, 5\}$, $w = \{ 1, 0, 1, 1, 1 \}$, $p = 0.25$.<br>Here we have:<br>$h = p(n - 1) + 1 = 2,$<br>$(h - 1) / n = 0.2, \quad h / n = 0.4,$<br>$F_7(u) = \left\{
\begin{array}{lcrcllr}
0 & \textrm{for} &     &      & u  & < & 0.2, \\
5u-1 & \textrm{for} & 0.2 & \leq & u  & \leq & 0.4, \\
1    & \textrm{for} & 0.4 & <    & u, & &
\end{array}
\right.$<br>$s_0(w) = 0, \; s_1(w) = 1, \; s_2(w) = 1, \; s_3(w) = 2, \; s_4(w) = 3, \; s_5(w) = 4,$<br>$\begin{array}{ll}
l^*_1 = s_0(w) / s_5(w) = 0.00, & r^*_1 = s_1(w) / s_5(w) = 0.25,\\
l^*_2 = s_1(w) / s_5(w) = 0.25, & r^*_2 = s_2(w) / s_5(w) = 0.25,\\
l^*_3 = s_2(w) / s_5(w) = 0.25, & r^*_3 = s_3(w) / s_5(w) = 0.50,\\
l^*_4 = s_3(w) / s_5(w) = 0.50, & r^*_4 = s_4(w) / s_5(w) = 0.75,\\
l^*_5 = s_4(w) / s_5(w) = 0.75, & r^*_5 = s_5(w) / s_5(w) = 1.00,\\
\end{array}$<br>$W^*_{5,1} = F_7(r_1) - F_7(l_1) = F_7(0.25) - F_7(0.00) = 0.25 - 0.25 = 0.25,$<br>$W^*_{5,2} = F_7(r_2) - F_7(l_2) = F_7(0.25) - F_7(0.25) = 0.25 - 0.25 = 0.00,$<br>$W^*_{5,3} = F_7(r_3) - F_7(l_3) = F_7(0.50) - F_7(0.25) = 1.00 - 0.25 = 0.75,$<br>$W^*_{5,4} = F_7(r_4) - F_7(l_4) = F_7(0.75) - F_7(0.50) = 1.00 - 1.00 = 0.00,$<br>$W^*_{5,5} = F_7(r_5) - F_7(l_5) = F_7(1.00) - F_7(0.75) = 1.00 - 1.00 = 0.00,$<br>$q^*_{0.25} = W^*_{5,1}x_1 + W^*_{5,2}x_2 + W^*_{5,3}x_3 + W^*_{5,4}x_4 + W^*_{5,5}x_5 = 0.25x_1 + 0.75x_3 = 0.25 + 2.25 = 2.5.$</div><h3 id=weighted-type-4-9-quantile-estimators>Weighted Type 4-9 quantile estimators</h3><p>Although the Type 7 is one of the most popular quantile estimators nowadays,
the above approach can be applied to any of Type 4-9 estimators.
All of them are based on the same interpolation formula:</p>$$
q_p = x_{\lfloor h \rfloor} + (h - \lfloor h \rfloor) (x_{\lfloor h \rfloor + 1} - x_{\lfloor h \rfloor}).
$$<p>The only difference between them is how we choose the $h$ value:</p><table><thead><tr><th align=left>Type</th><th align=left>h</th></tr></thead><tbody><tr><td align=left>4</td><td align=left>$np$</td></tr><tr><td align=left>5</td><td align=left>$np+1/2$</td></tr><tr><td align=left>6</td><td align=left>$(n+1)p$</td></tr><tr><td align=left>7</td><td align=left>$(n-1)p+1$</td></tr><tr><td align=left>8</td><td align=left>$(n+1/3)p+1/3$</td></tr><tr><td align=left>9</td><td align=left>$(n+1/4)/p+3/8$</td></tr></tbody></table><p>An important note: if the obtained $h$ value is less than $1$ or larger than $n$,
it should be clamped to the $[1;n]$ interval.
Once we get the $h$ value, we can use the same PDF/CDF functions that we used for the Type 7 quantile estimator:</p>$$
F_k(u) = \left\{
\begin{array}{lcrcllr}
0 & \textrm{for} &         &      & u & <    & (h-1)/n, \\
un-h+1 & \textrm{for} & (h-1)/n & \leq & u  & \leq & h/n, \\
1 & \textrm{for} & h/n     & <    & u. &      &
\end{array}
\right.
$$
$$
f_k(u) = F'_k(u) = \left\{
\begin{array}{lcrcllr}
0 & \textrm{for} &         &      & u & <    & (h-1)/n, \\
n      & \textrm{for} & (h-1)/n & \leq & u  & \leq & h/n, \\
0 & \textrm{for} & h/n     & <    & u. &      &
\end{array}
\right.
$$<h3 id=weighted-quantiles-in-action-exponential-smoothing>Weighted quantiles in action (exponential smoothing)</h3><p>Let&rsquo;s go back to the original problem with performance measurements and quantile evaluations.
We already know how to calculate the weighted quantiles.
All we need now is the weight values.
For problems like this, it&rsquo;s pretty convenient to use the <a href=https://en.wikipedia.org/wiki/Exponential_decay>exponential decay</a> law:</p>$$
\omega(t) = 2^{-t/t_{1/2}}
$$<p>where $t_{1/2}$ is the <a href=https://en.wikipedia.org/wiki/Half-life>half-life</a>.
This value describes the period of time required for the current weight to reduce to half of its original value.
Thus, we have</p>$$
\omega(0) = 1, \quad \omega(t_{1/2}) = 0.5, \quad \omega(2t_{1/2}) = 0.25, \quad \omega(3t_{1/2}) = 0.125, \ldots
$$<p>For our problem, we should use the exponential decay in a reverse way:</p>$$
w_i = \omega(n - i).
$$<p>Thus, the last measurement has weight $w_n = 1$,
the measurement from $t_{1/2}$ days ago has weight $w_{n-t_{1/2}} = 0.5$,
the measurement from $2t_{1/2}$ days ago has weight $w_{n-2t_{1/2}} = 0.25$,
and so on.</p><p>Originally, we had the following pictures with daily measurements:</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/moving1-light.svg target=_blank class=imgldlink alt=moving1><picture><source theme=dark srcset=/posts/weighted-quantiles/img/moving1-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/moving1-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/moving1-light.svg></picture></a></div></div><br><p>Let&rsquo;s say we want to get a daily estimation for the actual median value.
To do that, we have to apply the following procedure after each day:</p><ul><li>Assign weights $w_i$ to existing measurements $x_i$ according to the exponential decay law.</li><li>Sort the pairs $(x_i, w_i)$ by the measurement values $x_i$ because our equations require a sorted sample.</li><li>Apply the Harrell-Davis quantile estimator (because it&rsquo;s an efficient estimator) to get the median estimation ($q_{0.5}$).</li></ul><p>Here is an illustration of how it works in practice (for this example, $t_{1/2} = 5$).</p><div class=row><div class=mx-auto><a href=/posts/weighted-quantiles/img/moving2-light.svg target=_blank class=imgldlink alt=moving2><picture><source theme=dark srcset=/posts/weighted-quantiles/img/moving2-dark.svg media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/weighted-quantiles/img/moving2-light.svg media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=400 src=/posts/weighted-quantiles/img/moving2-light.svg></picture></a></div></div><br><p>Of course, we can apply this procedure not only to the median, but to any other quantile and get a daily estimation of the &ldquo;actual&rdquo; distribution.
It may be &ldquo;spoiled&rdquo; after change point, but it will be &ldquo;recovered&rdquo; after several days.
This technique is known as the <a href=https://aakinshin.net/posts/quantile-exponential-smoothing/>quantile exponential smoothing</a>.
The same idea can be also applied to different measures of dispersion,
so we can use the <a href=https://aakinshin.net/posts/dispersion-exponential-smoothing/>dispersion exponential smoothing</a>.</p><p>This approach can be improved with the help of change point detection (e.g., using <a href=https://aakinshin.net/posts/edpelt/>EdPelt</a> or <a href=https://github.com/AndreyAkinshin/perfolizer#changepoint-detection>RqqPelt</a>): we can just drop the values before the last change point.
However, the weighted approach improves our estimations in this case as well because some change points may not be correctly detected, or measurements may change slowly without explicit change points.</p><h3 id=reference-implementation>Reference implementation</h3><p>If you use R, here are functions that you can use in your scripts:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-r data-lang=r><span class=line><span class=cl><span class=c1># Weighted generic quantile estimator</span>
</span></span><span class=line><span class=cl><span class=n>wquantile.generic</span> <span class=o>&lt;-</span> <span class=kr>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>probs</span><span class=p>,</span> <span class=n>cdf.gen</span><span class=p>,</span> <span class=n>weights</span> <span class=o>=</span> <span class=kc>NA</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>n</span> <span class=o>&lt;-</span> <span class=nf>length</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>if</span> <span class=p>(</span><span class=nf>any</span><span class=p>(</span><span class=nf>is.na</span><span class=p>(</span><span class=n>weights</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>weights</span> <span class=o>&lt;-</span> <span class=nf>rep</span><span class=p>(</span><span class=m>1</span> <span class=o>/</span> <span class=n>n</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>nw</span> <span class=o>&lt;-</span> <span class=nf>sum</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span><span class=n>^2</span> <span class=o>/</span> <span class=nf>sum</span><span class=p>(</span><span class=n>weights^2</span><span class=p>)</span> <span class=c1># Kish&#39;s effective sample size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>indexes</span> <span class=o>&lt;-</span> <span class=nf>order</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>x</span> <span class=o>&lt;-</span> <span class=n>x[indexes]</span>
</span></span><span class=line><span class=cl>  <span class=n>weights</span> <span class=o>&lt;-</span> <span class=n>weights[indexes]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>weights</span> <span class=o>&lt;-</span> <span class=n>weights</span> <span class=o>/</span> <span class=nf>sum</span><span class=p>(</span><span class=n>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>cdf.probs</span> <span class=o>&lt;-</span> <span class=nf>cumsum</span><span class=p>(</span><span class=nf>c</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>weights</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nf>sapply</span><span class=p>(</span><span class=n>probs</span><span class=p>,</span> <span class=kr>function</span><span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cdf</span> <span class=o>&lt;-</span> <span class=nf>cdf.gen</span><span class=p>(</span><span class=n>nw</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span> <span class=o>&lt;-</span> <span class=nf>cdf</span><span class=p>(</span><span class=n>cdf.probs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>w</span> <span class=o>&lt;-</span> <span class=nf>tail</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=m>-1</span><span class=p>)</span> <span class=o>-</span> <span class=nf>head</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=m>-1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>sum</span><span class=p>(</span><span class=n>w</span> <span class=o>*</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Weighted Harrell-Davis quantile estimator</span>
</span></span><span class=line><span class=cl><span class=n>whdquantile</span> <span class=o>&lt;-</span> <span class=kr>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>probs</span><span class=p>,</span> <span class=n>weights</span> <span class=o>=</span> <span class=kc>NA</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>cdf.gen</span> <span class=o>&lt;-</span> <span class=kr>function</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span> <span class=kr>return</span><span class=p>(</span><span class=kr>function</span><span class=p>(</span><span class=n>cdf.probs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>pbeta</span><span class=p>(</span><span class=n>cdf.probs</span><span class=p>,</span> <span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=m>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>p</span><span class=p>,</span> <span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=m>1</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=m>1</span> <span class=o>-</span> <span class=n>p</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=nf>wquantile.generic</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>probs</span><span class=p>,</span> <span class=n>cdf.gen</span><span class=p>,</span> <span class=n>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Weighted Type 7 quantile estimator</span>
</span></span><span class=line><span class=cl><span class=n>wquantile</span> <span class=o>&lt;-</span> <span class=kr>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>probs</span><span class=p>,</span> <span class=n>weights</span> <span class=o>=</span> <span class=kc>NA</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>cdf.gen</span> <span class=o>&lt;-</span> <span class=kr>function</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span> <span class=kr>return</span><span class=p>(</span><span class=kr>function</span><span class=p>(</span><span class=n>cdf.probs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span> <span class=o>&lt;-</span> <span class=n>p</span> <span class=o>*</span> <span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=m>1</span><span class=p>)</span> <span class=o>+</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=n>u</span> <span class=o>&lt;-</span> <span class=nf>pmax</span><span class=p>((</span><span class=n>h</span> <span class=o>-</span> <span class=m>1</span><span class=p>)</span> <span class=o>/</span> <span class=n>n</span><span class=p>,</span> <span class=nf>pmin</span><span class=p>(</span><span class=n>h</span> <span class=o>/</span> <span class=n>n</span><span class=p>,</span> <span class=n>cdf.probs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>u</span> <span class=o>*</span> <span class=n>n</span> <span class=o>-</span> <span class=n>h</span> <span class=o>+</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=nf>wquantile.generic</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>probs</span><span class=p>,</span> <span class=n>cdf.gen</span><span class=p>,</span> <span class=n>weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If you use C#, you can take an implementation from
the latest nightly version (0.3.0-nightly.96+) of <a href=https://github.com/AndreyAkinshin/perfolizer>Perfolizer</a>
(you need <code>HarrellDavisQuantileEstimator</code> and <code>SimpleQuantileEstimator</code>).</p><h3 id=conclusion>Conclusion</h3><p>In this post, we derived equations for weighted quantile, including a generic CDF-based approach and specific formulas for the Harrell-Davis and Type 7 quantile estimators.
This technique has various applications, and we showed how to apply it to estimate quantiles for a time series using exponential decay.</p><p>The suggested equations present my own view on the concept of weighted quantiles since it&rsquo;s not a popular topic, and I didn&rsquo;t manage to find any good explanations.
If you know any papers/posts/implementations with the same or other approaches, I will appreciate if you share it with me.</p><h3 id=references>References</h3><ul><li><b id=Harrell1982>[Harrell1982]</b><br>Harrell, F.E. and Davis, C.E., 1982. A new distribution-free quantile estimator.
<em>Biometrika</em>, 69(3), pp.635-640.<br><a href=https://pdfs.semanticscholar.org/1a48/9bb74293753023c5bb6bff8e41e8fe68060f.pdf>https://pdfs.semanticscholar.org/1a48/9bb74293753023c5bb6bff8e41e8fe68060f.pdf</a></li><li><b id=Hyndman1996>[Hyndman1996]</b><br>Hyndman, R. J. and Fan, Y. 1996. Sample quantiles in statistical packages, <em>American Statistician</em> 50, 361–365.<br><a href=https://doi.org/10.2307/2684934>https://doi.org/10.2307/2684934</a></li></ul></div><hr><h3 id=references>References (6)</h3><ol><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/dispersion-exponential-smoothing/>Dispersion exponential smoothing
</a>(2021-05-11)
<span class=label title=References:4><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>4</span>
<span class=label title=Backlinks:3><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>3</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/edpelt/>Implementation of an efficient algorithm for changepoint detection: ED-PELT
</a>(2019-10-07)
<span class=label title=References:1><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>1</span>
<span class=label title=Backlinks:2><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>2</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/library/papers/ title="Library / papers"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#paper"/></svg>
</a><a href=https://aakinshin.net/library/papers/harrell1982/>A New distribution-free Quantile Estimator
</a>(1982)
by
<a href=https://aakinshin.net/library/authors/frank-e-harrell/>Frank E Harrell</a>
et al.
<span class=label title=Backlinks:23><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>23</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg>
</a><a href=https://aakinshin.net/tags/decent/><svg class="rating-icon"><title>Decent</title><use xlink:href="/img/fa/all.svg#decent"/></svg></a></li><li><a href=https://aakinshin.net/library/papers/ title="Library / papers"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#paper"/></svg>
</a><a href=https://aakinshin.net/library/papers/hyndman1996/>Sample Quantiles in Statistical Packages
</a>(1996)
by
<a href=https://aakinshin.net/library/authors/rob-j-hyndman/>Rob J Hyndman</a>
et al.
<span class=label title=Backlinks:12><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>12</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/kish-ess-weighted-quantiles/>Using Kish's effective sample size with weighted quantiles
</a>(2021-07-06)
<span class=label title=References:6><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>6</span>
<span class=label title=Backlinks:5><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>5</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/quantile-exponential-smoothing/>Quantile exponential smoothing
</a>(2021-05-04)
<span class=label title=References:7><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>7</span>
<span class=label title=Backlinks:3><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>3</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li></ol><h3 id=backlinks>Backlinks (8)</h3><ol><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/dispersion-exponential-smoothing/>Dispersion exponential smoothing
</a>(2021-05-11)
<span class=label title=References:4><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>4</span>
<span class=label title=Backlinks:3><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>3</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/kish-ess-weighted-quantiles/>Using Kish's effective sample size with weighted quantiles
</a>(2021-07-06)
<span class=label title=References:6><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>6</span>
<span class=label title=Backlinks:5><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>5</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/kosqe2/>Quantile estimators based on k order statistics, Part 2: Extending Hyndman-Fan equations
</a>(2021-08-10)
<span class=label title=References:5><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>5</span>
<span class=label title=Backlinks:4><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>4</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/quantile-exponential-smoothing/>Quantile exponential smoothing
</a>(2021-05-04)
<span class=label title=References:7><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>7</span>
<span class=label title=Backlinks:3><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>3</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/statistics-for-performance/>Statistical approaches for performance analysis
</a>(2020-12-15)
<span class=label title=References:16><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>16</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/weighted-quantiles-ci/>Quantile confidence intervals for weighted samples
</a>(2020-12-08)
<span class=label title=References:3><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>3</span>
<span class=label title=Backlinks:5><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>5</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/whl/>Weighted modification of the Hodges-Lehmann location estimator
</a>(2023-03-28)
<span class=label title=References:1><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>1</span>
<span class=label title=Backlinks:3><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>3</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/wthdqe/>Weighted trimmed Harrell-Davis quantile estimator
</a>(2022-04-19)
<span class=label title=References:5><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>5</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li></ol></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}));function toggleTheme(e){e?(document.documentElement.classList.add("dark"),themeToggleLightIcon.classList.remove("hidden"),themeToggleDarkIcon.classList.add("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")}),imagesLight.forEach(e=>{e.classList.add("hidden")})):(document.documentElement.classList.remove("dark"),themeToggleDarkIcon.classList.remove("hidden"),themeToggleLightIcon.classList.add("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}),imagesDark.forEach(e=>{e.classList.add("hidden")}))}themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),event.altKey?(localStorage.removeItem("color-theme"),toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches)):localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{if(localStorage.getItem("color-theme")===null){const t=e.matches?"dark":"light";toggleTheme(t==="dark")}})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2024 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+=" has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>