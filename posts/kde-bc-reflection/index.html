<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Mathematics,Statistics,Research"><title>Kernel density estimation boundary correction: reflection (ggplot2 v3.4.0) | Andrey Akinshin</title><meta name=description content="Kernel density estimation (KDE) is a popular way to approximate a distribution based on the given data. However, it has several flaws. One of the most significant flaws is that it extends the support of the distribution. It is pretty unfortunate: even if we..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.7748cd40c7f2f841cbbd37537f783d52d954e3efdc8673a15babd858bf8c359f.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button title="Alt+Click to match OS color theme" class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Kernel density estimation boundary correction: reflection (ggplot2 v3.4.0)</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2022-12-06>December 6, 2022</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/mathematics/>Mathematics</a>
<a class=label-link href=https://aakinshin.net/tags/statistics/>Statistics</a>
<a class=label-link href=https://aakinshin.net/tags/research/>Research</a></div></div><br><div class=main-content><p>Kernel density estimation (KDE) is a popular way to approximate a distribution based on the given data.
However, it has several flaws.
One of the most significant flaws is that it extends the support of the distribution.
It is pretty unfortunate: even if we know the actual range of supported values,
KDE provides non-zero density values for the regions where no values exist.
It is obviously an inaccurate estimation.
The procedure of adjusting the KDE values according to the given boundaries is known as <em>boundary correction</em>.
As usual, there are plenty of available boundary correction strategies.</p><p>One such strategy was implemented in the
<a href=https://www.tidyverse.org/blog/2022/11/ggplot2-3-4-0/#bounded-density-estimation>v3.4.0 update</a> of
<a href=https://ggplot2.tidyverse.org/>ggplot2</a> (a popular R package for plotting)
thanks to <a href=https://github.com/tidyverse/ggplot2/pull/4013/>pull request #4013</a>.
At the present moment, it supports a single boundary correction strategy called <em>reflection</em>.
In this post, we discuss this approach and see how it works in practice.</p><h3 id=introduction>Introduction</h3><p>First of all, we recall the problem.
Let us consider a random sample from the standard exponential distribution of size 100.
Here is the unbounded KDE for this sample (normal kernel, Sheather & Jones bandwidth)
alongside the true distribution density:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/kde-bc-reflection/img/exp1-light.svg target=_blank alt=exp1><img src=/posts/kde-bc-reflection/img/exp1-light.svg width=800></a>
<a class="img-dark hidden" href=/posts/kde-bc-reflection/img/exp1-dark.svg target=_blank alt=exp1><img src=/posts/kde-bc-reflection/img/exp1-dark.svg width=800></a></div><p>As we can see, a significant part of the KDE is placed in the negative region,
which does not make much sense since the exponential distribution supports only non-negative numbers.
If we specify bounds <span class="math inline">\([0; \infty]\)</span>, we can get the bounded KDE which covers only positive numbers:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/kde-bc-reflection/img/exp2-light.svg target=_blank alt=exp2><img src=/posts/kde-bc-reflection/img/exp2-light.svg width=800></a>
<a class="img-dark hidden" href=/posts/kde-bc-reflection/img/exp2-dark.svg target=_blank alt=exp2><img src=/posts/kde-bc-reflection/img/exp2-dark.svg width=800></a></div><p>As we can see, the negative tail is gone, and the density for small <span class="math inline">\(x\)</span> values is slightly increased.
Let us discuss how it works.</p><h3 id=boundary-correction-reflection>Boundary correction: reflection</h3><p>We consider the reflection boundary correction strategy
that was <a href=https://github.com/tidyverse/ggplot2/pull/4013/>implemented</a> in ggplot 3.4.0
and proposed in <a href=#Jones1993>[Jones1993]</a>.</p><p>As an example, we consider a sample from the standard uniform distribution <span class="math inline">\(\mathcal{U}(0, 1)\)</span> of size 1000.
Despite a huge number of elements, the unbounded KDE (normal kernel, Sheather & Jones bandwidth)
exceeds the natural range <span class="math inline">\([0;1]\)</span> of this distribution:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/kde-bc-reflection/img/unif1-light.svg target=_blank alt=unif1><img src=/posts/kde-bc-reflection/img/unif1-light.svg width=800></a>
<a class="img-dark hidden" href=/posts/kde-bc-reflection/img/unif1-dark.svg target=_blank alt=unif1><img src=/posts/kde-bc-reflection/img/unif1-dark.svg width=800></a></div><p>The reflection boundary correction procedure contains two simple steps.
In the first step, we should reflect the KDE tails against the boundaries:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/kde-bc-reflection/img/unif2-light.svg target=_blank alt=unif2><img src=/posts/kde-bc-reflection/img/unif2-light.svg width=800></a>
<a class="img-dark hidden" href=/posts/kde-bc-reflection/img/unif2-dark.svg target=_blank alt=unif2><img src=/posts/kde-bc-reflection/img/unif2-dark.svg width=800></a></div><p>In the second step, we should sum the reflected tails with the rest of the KDE so that the total density area is <span class="math inline">\(1\)</span>:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/kde-bc-reflection/img/unif3-light.svg target=_blank alt=unif3><img src=/posts/kde-bc-reflection/img/unif3-light.svg width=800></a>
<a class="img-dark hidden" href=/posts/kde-bc-reflection/img/unif3-dark.svg target=_blank alt=unif3><img src=/posts/kde-bc-reflection/img/unif3-dark.svg width=800></a></div><p>That is all!
We have just built a beautiful bounded KDE concerning the support of the uniform distribution!</p><h3 id=references>References</h3><ul><li><b id=Jones1993>[Jones1993]</b><br>Jones, M. C. (1993). Simple boundary correction for kernel density estimation.
Statistics and Computing, 3(3), 135-146. doi:<a href=https://dx.doi.org/10.1007/bf00147776>10.1007/bf00147776</a></li></ul></div><br><br></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}));function toggleTheme(e){e?(document.documentElement.classList.add("dark"),themeToggleLightIcon.classList.remove("hidden"),themeToggleDarkIcon.classList.add("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")}),imagesLight.forEach(e=>{e.classList.add("hidden")})):(document.documentElement.classList.remove("dark"),themeToggleDarkIcon.classList.remove("hidden"),themeToggleLightIcon.classList.add("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}),imagesDark.forEach(e=>{e.classList.add("hidden")}))}themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),event.altKey?(localStorage.removeItem("color-theme"),toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches)):localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{if(localStorage.getItem("color-theme")===null){const t=e.matches?"dark":"light";toggleTheme(t==="dark")}})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2024 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>