<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Mathematics,Statistics,Research,Mann-Whitney U-test,python"><title>When Python's Mann-Whitney U test returns extremely distorted p-values | Andrey Akinshin</title><meta name=description content="Discussing corner cases in which mannwhitneyu returns distorted p-values"><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.7748cd40c7f2f841cbbd37537f783d52d954e3efdc8673a15babd858bf8c359f.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button title="Alt+Click to match OS color theme" class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>When Python's Mann-Whitney U test returns extremely distorted p-values</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2023-05-02>May 2, 2023</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/mathematics/>Mathematics</a>
<a class=label-link href=https://aakinshin.net/tags/statistics/>Statistics</a>
<a class=label-link href=https://aakinshin.net/tags/research/>Research</a>
<a class=label-link href=https://aakinshin.net/tags/mann-whitney/>Mann-Whitney U-test</a>
<a class=label-link href=https://aakinshin.net/tags/python/>python</a></div></div><br><div class=main-content><p>In the <a href=https://aakinshin.net/posts/r-mann-whitney-incorrect-p-value/>previous post</a>,
I have discussed a huge difference between p-values evaluated via the R implementation of
the <a href=https://en.wikipedia.org/wiki/Mann%E2%80%93Whitney_U_test>Mann-Whitney U test</a>
between the exact and asymptotic implementations.
This issue is not unique only to R, it is relevant for other statistical packages in other languages as well.
In this post, we review this problem in the Python package <a href=https://scipy.org/>SciPy</a>.</p><p>In SciPy<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, the Mann-Whitney U test is available via the function
<a href=https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.mannwhitneyu.html>mannwhitneyu</a>.
Similarly to R, it has two methods to estimate the value: the exact one and the normally approximated one.
The difference between these methods can be shown using the following <a href=https://trinket.io/python3/204b37a1b1>snippet</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy.stats</span> <span class=kn>import</span> <span class=n>mannwhitneyu</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>101</span><span class=p>,</span> <span class=mi>106</span><span class=p>)</span> <span class=c1># n = 5</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>51</span><span class=p>)</span>    <span class=c1># m = 50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s2>&#34;greater&#34;</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s2>&#34;exact&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s2>&#34;greater&#34;</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s2>&#34;asymptotic&#34;</span><span class=p>))</span>
</span></span></code></pre></div><p>This code gives the following output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>MannwhitneyuResult</span><span class=p>(</span><span class=n>statistic</span><span class=o>=</span><span class=mf>250.0</span><span class=p>,</span> <span class=n>pvalue</span><span class=o>=</span><span class=mf>2.874586670369134e-07</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>MannwhitneyuResult</span><span class=p>(</span><span class=n>statistic</span><span class=o>=</span><span class=mf>250.0</span><span class=p>,</span> <span class=n>pvalue</span><span class=o>=</span><span class=mf>0.00013370277743792665</span><span class=p>)</span>
</span></span></code></pre></div><p>The results match the situation <a href=https://aakinshin.net/posts/r-mann-whitney-incorrect-p-value/>we observed</a> in R:
the approximated value is 465 times larger than the exact value.</p><p>However, the default strategy for choosing between <code>exact</code> and <code>asymptotic</code> is different between R and SciPy.
In R, <code>wilcox.text</code> <a href=https://github.com/wch/r-source/blob/tags/R-4-3-0/src/library/stats/R/wilcox.test.R#L279>uses</a>
the exact strategy when <code>n &lt; 50 AND m &lt; 50</code> (and there are no tied values).
In SciPy, <code>mannwhitneyu</code> <a href=https://github.com/scipy/scipy/blob/v1.10.1/scipy/stats/_mannwhitneyu.py#L236>uses</a>
the exact strategy when <code>n &lt;= 8 OR m &lt;= 8</code> (and there are no tied values).
Therefore, SciPy switches to the <code>asymptotic</code> methods when both samples contain at least 9 elements.
Here is a <a href=https://trinket.io/python3/acd4dac09d>snippet</a> that illustrates this transition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy.stats</span> <span class=kn>import</span> <span class=n>mannwhitneyu</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>101</span><span class=p>,</span> <span class=mi>109</span><span class=p>)</span> <span class=c1># n = 8</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>9</span><span class=p>)</span>     <span class=c1># m = 8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;n = m = 8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;auto:       &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s2>&#34;greater&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;exact:      &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s2>&#34;greater&#34;</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s2>&#34;exact&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;asymptotic: &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s2>&#34;greater&#34;</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s2>&#34;asymptotic&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>101</span><span class=p>,</span> <span class=mi>110</span><span class=p>)</span> <span class=c1># n = 9</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>    <span class=c1># m = 9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;n = m = 9&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;auto:       &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s2>&#34;greater&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;exact:      &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s2>&#34;greater&#34;</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s2>&#34;exact&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;asymptotic: &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>mannwhitneyu</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>alternative</span><span class=o>=</span><span class=s2>&#34;greater&#34;</span><span class=p>,</span> <span class=n>method</span><span class=o>=</span><span class=s2>&#34;asymptotic&#34;</span><span class=p>)))</span>
</span></span></code></pre></div><p>Here is the corresponding output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=n>m</span> <span class=o>=</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>auto</span><span class=p>:</span>       <span class=n>MannwhitneyuResult</span><span class=p>(</span><span class=n>statistic</span><span class=o>=</span><span class=mf>64.0</span><span class=p>,</span> <span class=n>pvalue</span><span class=o>=</span><span class=mf>7.77000777000777e-05</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exact</span><span class=p>:</span>      <span class=n>MannwhitneyuResult</span><span class=p>(</span><span class=n>statistic</span><span class=o>=</span><span class=mf>64.0</span><span class=p>,</span> <span class=n>pvalue</span><span class=o>=</span><span class=mf>7.77000777000777e-05</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>asymptotic</span><span class=p>:</span> <span class=n>MannwhitneyuResult</span><span class=p>(</span><span class=n>statistic</span><span class=o>=</span><span class=mf>64.0</span><span class=p>,</span> <span class=n>pvalue</span><span class=o>=</span><span class=mf>0.00046955284955859495</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=n>m</span> <span class=o>=</span> <span class=mi>9</span>
</span></span><span class=line><span class=cl><span class=n>auto</span><span class=p>:</span>       <span class=n>MannwhitneyuResult</span><span class=p>(</span><span class=n>statistic</span><span class=o>=</span><span class=mf>81.0</span><span class=p>,</span> <span class=n>pvalue</span><span class=o>=</span><span class=mf>0.00020614740103084563</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exact</span><span class=p>:</span>      <span class=n>MannwhitneyuResult</span><span class=p>(</span><span class=n>statistic</span><span class=o>=</span><span class=mf>81.0</span><span class=p>,</span> <span class=n>pvalue</span><span class=o>=</span><span class=mf>2.0567667626491154e-05</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>asymptotic</span><span class=p>:</span> <span class=n>MannwhitneyuResult</span><span class=p>(</span><span class=n>statistic</span><span class=o>=</span><span class=mf>81.0</span><span class=p>,</span> <span class=n>pvalue</span><span class=o>=</span><span class=mf>0.00020614740103084563</span><span class=p>)</span>
</span></span></code></pre></div><p>Thus, we should be careful when using <code>mannwhitneyu</code> from SciPy:
the <code>asymptotic</code> method is enabled by default even for relatively small samples
which can lead to significant errors in p-value evaluation for extreme values of the U statistic.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>We consider SciPy 1.10.1&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><br><br></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}));function toggleTheme(e){e?(document.documentElement.classList.add("dark"),themeToggleLightIcon.classList.remove("hidden"),themeToggleDarkIcon.classList.add("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")}),imagesLight.forEach(e=>{e.classList.add("hidden")})):(document.documentElement.classList.remove("dark"),themeToggleDarkIcon.classList.remove("hidden"),themeToggleLightIcon.classList.add("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}),imagesDark.forEach(e=>{e.classList.add("hidden")}))}themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),event.altKey?(localStorage.removeItem("color-theme"),toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches)):localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{if(localStorage.getItem("color-theme")===null){const t=e.matches?"dark":"light";toggleTheme(t==="dark")}})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2024 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>