<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Programming,.NET,C#,BenchmarkDotNet,Benchmarking"><title>BenchmarkDotNet v0.10.7 | Andrey Akinshin</title><meta name=description content="BenchmarkDotNet v0.10.7 has been released. In this post, I will briefly cover the following features:
LINQPad support Filters and categories Updated Setup/Cleanup attributes Better Value Types support Building Sources on Linux"><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.3694189c64d6e73f07022b9b02e5f1a3ce7adaa4b67d9bd3ed23e8f8115e6411.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>BenchmarkDotNet v0.10.7</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2017-06-05>June 5, 2017</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarkdotnet/>BenchmarkDotNet</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarking/>Benchmarking</a></div></div><br><div class=main-content><p>BenchmarkDotNet v0.10.7 has been released.
In this post, I will briefly cover the following features:</p><ul><li>LINQPad support</li><li>Filters and categories</li><li>Updated Setup/Cleanup attributes</li><li>Better Value Types support</li><li>Building Sources on Linux</li></ul><hr><h3 id=linqpad-support>LINQPad support</h3><p>We already supported LinqPad some time ago, but the support was broken in recent version of BenchmarkDotNet.
It turned out that there was a conflict between the Roslyn assemblies in LINQPad and those referenced by BenchmarkDotNet.
With the help of <a href=https://github.com/albahari>@albahari</a> (the author of LinqPad), the issue <a href=https://github.com/dotnet/BenchmarkDotNet/issues/445#issuecomment-300683997>was fixed</a>.
The fix was on the LINQPad side, so you need LINQPad 5.22.05+ to get it worked (currently it&rsquo;s a beta version, it can be downloaded from <a href=https://www.linqpad.net/Download.aspx>the official site</a>).</p><div class=row><div class=mx-auto><a href=/posts/bdn-v0_10_7/img/linqpad.png target=_blank alt=linqpad><img class="mx-auto d-block img-fluid" width=800 src=/posts/bdn-v0_10_7/img/linqpad.png></a></div></div><br><p>See also:
<a href=https://github.com/dotnet/BenchmarkDotNet/issues/66>BenchmarkDotNet#66</a>,
<a href=https://github.com/dotnet/BenchmarkDotNet/issues/445>BenchmarkDotNet#445</a>.</p><hr><h3 id=filters-and-categories>Filters and categories</h3><p><a href=https://github.com/dotnet/BenchmarkDotNet/issues/248>This issue</a> by <a href=https://github.com/jskeet>@jskeet</a> was pretty old,
but I finally found some time to implement it.
BenchmarkDotNet becomes very popular, some of our users have a lot of benchmarks, and they don&rsquo;t want to run all the benchmarks each time.
In this case, they can <em>filter</em> some of them with the help of <em>filters</em>.</p><p>Usage examples:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[Config(typeof(Config))]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>IntroFilters</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>class</span> <span class=nc>Config</span> <span class=p>:</span> <span class=n>ManualConfig</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// We will benchmark ONLY method with names with names (which contains &#34;A&#34; OR &#34;1&#34;) AND (have length &lt; 3)</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=n>Config</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Add</span><span class=p>(</span><span class=k>new</span> <span class=n>DisjunctionFilter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>NameFilter</span><span class=p>(</span><span class=n>name</span> <span class=p>=&gt;</span> <span class=n>name</span><span class=p>.</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;A&#34;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>NameFilter</span><span class=p>(</span><span class=n>name</span> <span class=p>=&gt;</span> <span class=n>name</span><span class=p>.</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>));</span> <span class=c1>// benchmark with names which contains &#34;A&#34; OR &#34;1&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>Add</span><span class=p>(</span><span class=k>new</span> <span class=n>NameFilter</span><span class=p>(</span><span class=n>name</span> <span class=p>=&gt;</span> <span class=n>name</span><span class=p>.</span><span class=n>Length</span> <span class=p>&lt;</span> <span class=m>3</span><span class=p>));</span> <span class=c1>// benchmark with names with length &lt; 3</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>A1</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span> <span class=c1>// Will be benchmarked</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>A2</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span> <span class=c1>// Will be benchmarked</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>A3</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span> <span class=c1>// Will be benchmarked</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>B1</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span> <span class=c1>// Will be benchmarked</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>B2</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>B3</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>C1</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span> <span class=c1>// Will be benchmarked</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>C2</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>C3</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span> <span class=k>public</span> <span class=k>void</span> <span class=n>Aaa</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>An example of <code>BenchmarkCategory</code> usage:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[DryJob]</span>
</span></span><span class=line><span class=cl><span class=na>[CategoriesColumn]</span>
</span></span><span class=line><span class=cl><span class=na>[BenchmarkCategory(&#34;Awesome&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>[AnyCategoriesFilter(&#34;A&#34;, &#34;1&#34;)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>IntroCategories</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span>
</span></span><span class=line><span class=cl><span class=na>    [BenchmarkCategory(&#34;A&#34;, &#34;1&#34;)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>void</span> <span class=n>A1</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span> <span class=c1>// Will be benchmarked</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span>
</span></span><span class=line><span class=cl><span class=na>    [BenchmarkCategory(&#34;A&#34;, &#34;2&#34;)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>void</span> <span class=n>A2</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span> <span class=c1>// Will be benchmarked</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span>
</span></span><span class=line><span class=cl><span class=na>    [BenchmarkCategory(&#34;B&#34;, &#34;1&#34;)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>void</span> <span class=n>B1</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span> <span class=c1>// Will be benchmarked</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span>
</span></span><span class=line><span class=cl><span class=na>    [BenchmarkCategory(&#34;B&#34;, &#34;2&#34;)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>void</span> <span class=n>B2</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=m>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The filtering can be performed via command line.
Examples:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>--category=A
</span></span><span class=line><span class=cl>--allCategories=A,B
</span></span><span class=line><span class=cl>--anyCategories=A,B
</span></span></code></pre></div><p>If you are using <code>BenchmarkSwitcher</code> and want to run all the benchmarks with a category from all types and join them into one summary table, use the <code>--join</code> option (or <code>BenchmarkSwitcher.RunAllJoined</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>* --join --category=MyAwesomeCategory
</span></span></code></pre></div><p>The last feature was inspired by a <a href=https://github.com/NickCraver>@NickCraver</a> <a href=https://github.com/dotnet/BenchmarkDotNet/issues/248#issuecomment-300652000>comment</a>,
it should be useful in <a href=https://github.com/StackExchange/Dapper>Dapper</a>.</p><p>See also:
<a href=https://github.com/dotnet/BenchmarkDotNet/issues/248>BenchmarkDotNet#248</a>.</p><hr><h3 id=updated-setupcleanup-attributes>Updated Setup/Cleanup attributes</h3><p>Sometimes we want to write some logic which should be executed <em>before</em> or <em>after</em> a benchmark, but we don&rsquo;t want to measure it.
For this purpose, BenchmarkDotNet provides a set of attributes: <code>[GlobalSetup]</code>, <code>[GlobalCleanup]</code>, <code>[IterationSetup]</code>, <code>[IterationCleanup]</code>.</p><h4 id=globalsetup>GlobalSetup</h4><p>A method which is marked by the <code>[GlobalSetup]</code> attribute will be executed only once per a benchmarked method
after initialization of benchmark parameters and before all the benchmark method invocations.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>GlobalSetupExample</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>    [Params(10, 100, 1000)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>N</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=kt>int</span><span class=p>[]</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [GlobalSetup]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>void</span> <span class=n>GlobalSetup</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int</span><span class=p>[</span><span class=n>N</span><span class=p>];</span> <span class=c1>// executed once per each N value</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>    [Benchmark]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>Logic</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>res</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>N</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=p>+=</span> <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=globalcleanup>GlobalCleanup</h4><p>A method which is marked by the <code>[GlobalCleanup]</code> attribute will be executed only once per a benchmarked method
after all the benchmark method invocations.
If you are using some unmanaged resources (e.g., which were created in the <code>GlobalSetup</code> method), they can be disposed in the <code>GlobalCleanup</code> method.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>void</span> <span class=n>GlobalCleanup</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Disposing logic</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=iterationsetup>IterationSetup</h4><p>A method which is marked by the <code>[IterationSetup]</code> attribute will be executed only once <em>before each an iteration</em>.
It&rsquo;s not recommended to use this attribute in microbenchmarks because it can spoil the results.
However, if you are writing a macrobenchmark (e.g. a benchmark which takes at least 100ms) and
you want to prepare some data before each iteration, <code>[IterationSetup]</code> can be useful.
BenchmarkDotNet doesn&rsquo;t support setup/cleanup method for a single method invocation (<em>an operation</em>), but you can perform only one operation per iteration.
It&rsquo;s recommended to use <code>RunStrategy.Monitoring</code> for such cases.
Be careful: if you allocate any objects in the <code>[IterationSetup]</code> method, the MemoryDiagnoser results can also be spoiled.</p><h4 id=iterationcleanup>IterationCleanup</h4><p>A method which is marked by the <code>[IterationCleanup]</code> attribute will be executed only once <em>after each an iteration</em>.
This attribute has the same set of constraint with <code>[IterationSetup]</code>: it&rsquo;s not recommended to use <code>[IterationCleanup]</code> in microbenchmarks or benchmark which also</p><h4 id=an-example>An example</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[SimpleJob(RunStrategy.Monitoring, launchCount: 1, warmupCount: 2, targetCount: 3)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>SetupAndCleanupExample</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=kt>int</span> <span class=n>setupCounter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>private</span> <span class=kt>int</span> <span class=n>cleanupCounter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>  [IterationSetup]</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>IterationSetup</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;// &#34;</span> <span class=p>+</span> <span class=s>&#34;IterationSetup&#34;</span> <span class=p>+</span> <span class=s>&#34; (&#34;</span> <span class=p>+</span> <span class=p>++</span><span class=n>setupCounter</span> <span class=p>+</span> <span class=s>&#34;)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>  [IterationCleanup]</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>IterationCleanup</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;// &#34;</span> <span class=p>+</span> <span class=s>&#34;IterationCleanup&#34;</span> <span class=p>+</span> <span class=s>&#34; (&#34;</span> <span class=p>+</span> <span class=p>++</span><span class=n>cleanupCounter</span> <span class=p>+</span> <span class=s>&#34;)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>  [GlobalSetup]</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>GlobalSetup</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;// &#34;</span> <span class=p>+</span> <span class=s>&#34;GlobalSetup&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>  [GlobalCleanup]</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>GlobalCleanup</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;// &#34;</span> <span class=p>+</span> <span class=s>&#34;GlobalCleanup&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=na>
</span></span></span><span class=line><span class=cl><span class=na>  [Benchmark]</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=k>void</span> <span class=n>Benchmark</span><span class=p>()</span> <span class=p>=&gt;</span> <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;// &#34;</span> <span class=p>+</span> <span class=s>&#34;Benchmark&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The order of method calls:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>// GlobalSetup
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// IterationSetup (1)    // IterationSetup Jitting
</span></span><span class=line><span class=cl>// IterationCleanup (1)  // IterationCleanup Jitting
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// IterationSetup (2)    // MainWarmup1
</span></span><span class=line><span class=cl>// Benchmark             // MainWarmup1
</span></span><span class=line><span class=cl>// IterationCleanup (2)  // MainWarmup1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// IterationSetup (3)    // MainWarmup2
</span></span><span class=line><span class=cl>// Benchmark             // MainWarmup2
</span></span><span class=line><span class=cl>// IterationCleanup (3)  // MainWarmup2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// IterationSetup (4)    // MainTarget1
</span></span><span class=line><span class=cl>// Benchmark             // MainTarget1
</span></span><span class=line><span class=cl>// IterationCleanup (4)  // MainTarget1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// IterationSetup (5)    // MainTarget2
</span></span><span class=line><span class=cl>// Benchmark             // MainTarget2
</span></span><span class=line><span class=cl>// IterationCleanup (5)  // MainTarget2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// IterationSetup (6)    // MainTarget3
</span></span><span class=line><span class=cl>// Benchmark             // MainTarget3
</span></span><span class=line><span class=cl>// IterationCleanup (6)  // MainTarget3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// GlobalCleanup
</span></span></code></pre></div><h4 id=some-additional-comments>Some additional comments</h4><p>In <code>v0.10.6</code>, we had only the <code>[Setup]</code> and <code>[Cleanup]</code> attributes which were renamed to <code>[GlobalSetup]</code> and <code>[GlobalCleanup]</code>.
In <code>v0.10.7</code>, we still have <code>[Setup]</code> and <code>[Cleanup]</code> (so, your benchmarks will not be broken after the update) with a simple trick which is very popular for backward compatibility:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[Obsolete(&#34;Use GlobalSetupAttribute&#34;)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>SetupAttribute</span> <span class=p>:</span> <span class=n>GlobalSetupAttribute</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>[Obsolete(&#34;Use GlobalCleanupAttribute&#34;)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>class</span> <span class=nc>CleanupAttribute</span> <span class=p>:</span> <span class=n>GlobalCleanupAttribute</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It&rsquo;s recommended to fix your benchmarks because we are going to drop in in a few months.
Here is discussion about renaming: <a href=https://github.com/dotnet/BenchmarkDotNet/issues/456>BenchmarkDotNet#456</a>.</p><p>Historically, BenchmarkDotNet was focused only on microbenchmarking.
We didn&rsquo;t implement <code>[IterationSetup]</code>/<code>[IterationCleanup]</code> before because these attributes can&rsquo;t be applied for benchmarking of methods which take nanoseconds (if you want good precision):
Since a lot of our users use it for macrobenchmarking now (and they don&rsquo;t need super-precision in this case),
it makes sense to support it now and provide a way to use all the BenchmarkDotNet features for such cases.</p><p>See also:
<a href=https://github.com/dotnet/BenchmarkDotNet/issues/270>BenchmarkDotNet#270</a>,
<a href=https://github.com/dotnet/BenchmarkDotNet/issues/274>BenchmarkDotNet#274</a>,
<a href=https://github.com/dotnet/BenchmarkDotNet/issues/325>BenchmarkDotNet#325</a>,
<a href=https://github.com/dotnet/BenchmarkDotNet/issues/456>BenchmarkDotNet#456</a>.</p><hr><h3 id=better-value-types-support>Better Value Types support</h3><p>Microbenchmarking is tricky.
And it&rsquo;s super-tricky if you are working on the nanosecond-level with value types.
It turned out that we had some troubles with benchmarks that were returning value types prior to v0.10.7,
but <a href=https://github.com/adamsitnik>@adamsitnik</a> solved it, and now we have better support for such cases.
Probably, it&rsquo;s not the last such problem, so we are going to continue to improve precision with each release!</p><p>See also:
<a href=https://github.com/dotnet/BenchmarkDotNet/commit/afa803d0e38c0e11864b2e4394d4a85d3801d944>BenchmarkDotNet/afa803d0</a></p><hr><h3 id=building-sources-on-linux>Building Sources on Linux</h3><p>BenchmarkDotNet is a cross-platform NuGet package so that you can use all the basic features on Windows, Linux, and MacOS.
We develop BenchmarkDotNet on Windows, but it&rsquo;s already possible to develop it on Linux and MacOS (with some limitations).
If you have latest <a href=https://www.microsoft.com/net/download/core>.NET Core SDK</a> and <a href=https://www.mono-project.com/download/stable/>Mono</a>,
you should be able to build the solution (with unloaded F#/VB projects), run samples (for both <code>net46</code>/<code>netcoreapp1.1</code>), run unit tests (for <code>netcoreapp1.1</code> only).</p><div class=row><div class=mx-auto><a href=/posts/bdn-v0_10_7/img/linux-xunit.png target=_blank alt=linux-xunit><img class="mx-auto d-block img-fluid" width=800 src=/posts/bdn-v0_10_7/img/linux-xunit.png></a></div></div><br><p>Unfortunately, I don&rsquo;t know how to run unit tests on <code>net46</code> and how to pack NuGet packages on Linux:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>akinshin@xu:~/RiderProjects/BenchmarkDotNet/tests$ dotnet test BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj --configuration Release --framework net46
</span></span><span class=line><span class=cl>Build started, please wait...
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Microsoft.Common.CurrentVersion.targets(1111,5): error MSB3644: The reference assemblies for framework &#34;.NETFramework,Version=v4.6&#34; were not found. To resolve this, install the SDK or Targeting Pack for this framework version or retarget your application to a version of the framework for which you have the SDK or Targeting Pack installed. Note that assemblies will be resolved from the Global Assembly Cache (GAC) and will be used in place of reference assemblies. Therefore your assembly may not be correctly targeted for the framework you intend. [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018: The &#34;GenerateRuntimeConfigurationFiles&#34; task failed unexpectedly. [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018: System.IO.DirectoryNotFoundException: Could not find a part of the path &#39;/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/bin/Release/net46/BenchmarkDotNet.Tests.runtimeconfig.json&#39;. [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at Interop.ThrowExceptionForIoErrno(ErrorInfo errorInfo, String path, Boolean isDirectory, Func`2 errorRewriter) [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at Interop.CheckIo[TSafeHandle](TSafeHandle handle, String path, Boolean isDirectory, Func`2 errorRewriter) [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at Microsoft.Win32.SafeHandles.SafeFileHandle.Open(String path, OpenFlags flags, Int32 mode) [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at System.IO.UnixFileStream..ctor(String path, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize, FileOptions options, FileStream parent) [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at System.IO.UnixFileSystem.Open(String fullPath, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize, FileOptions options, FileStream parent) [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at System.IO.FileStream.Init(String path, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize, FileOptions options) [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at Microsoft.NET.Build.Tasks.GenerateRuntimeConfigurationFiles.WriteToJsonFile(String fileName, Object value) [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at Microsoft.NET.Build.Tasks.GenerateRuntimeConfigurationFiles.WriteRuntimeConfig(ProjectContext projectContext) [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at Microsoft.NET.Build.Tasks.GenerateRuntimeConfigurationFiles.ExecuteCore() [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at Microsoft.NET.Build.Tasks.TaskBase.Execute() [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at Microsoft.Build.BackEnd.TaskExecutionHost.Microsoft.Build.BackEnd.ITaskExecutionHost.Execute() [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span><span class=line><span class=cl>/usr/share/dotnet/sdk/1.0.4/Sdks/Microsoft.NET.Sdk/build/Microsoft.NET.Sdk.targets(129,5): error MSB4018:    at Microsoft.Build.BackEnd.TaskBuilder.&lt;ExecuteInstantiatedTask&gt;d__25.MoveNext() [/home/akinshin/RiderProjects/BenchmarkDotNet/tests/BenchmarkDotNet.Tests/BenchmarkDotNet.Tests.csproj]
</span></span></code></pre></div><p><a href=https://developercommunity.visualstudio.com/content/problem/61641/targeting-multiple-frameworks-causes-build-to-fail.html>It seems</a> that it&rsquo;s impossible now (.NET Core SDK 1.0.4) by design.
I hope that it will be possible in the future and BenchmarkDotNet will become xplat not only for our users, but also for core BenchmarkDotNet developers.</p><hr><h3 id=conclusion>Conclusion</h3><p><code>v0.10.7</code> is a small (but important) step forward to <code>v1.0</code>.
We didn&rsquo;t release it yet because we are still not sure about how perfect API should look like and what kind of features should be included in a decent benchmarking library.
Any feedback is very valuable, don&rsquo;t hesitate to <a href=https://github.com/dotnet/BenchmarkDotNet/issues/new>create issues</a> on GitHub if you don&rsquo;t like the current API or you need some additional features.</p><ul><li>BenchmarkDotNet on GitHub: <a href=https://github.com/dotnet/BenchmarkDotNet>https://github.com/dotnet/BenchmarkDotNet</a></li><li>Official documentation: <a href=http://benchmarkdotnet.org/>http://benchmarkdotnet.org/</a></li><li>ChangeLog: <a href=https://github.com/dotnet/BenchmarkDotNet/wiki/ChangeLog>https://github.com/dotnet/BenchmarkDotNet/wiki/ChangeLog</a></li></ul></div><br><br></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>