<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.123.7"><meta name=author content='Andrey Akinshin'><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content='Mathematics,Statistics,Research,Research: P² quantile estimator'><title>Merging extended P² quantile estimators, Part 1 | Andrey Akinshin</title>
<meta name=description content="P² quantile estimator is a streaming quantile estimator with $\mathcal{O}(1)$ memory footprint and an extremely fast update procedure. Several days ago, I learned that it was adopted for the new Paint.NET GPU-based Median Sketch effect (the description is h..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.f8640bf9a1f7ba7802d4c626b7c44d7f16a850d1b3573e70d5e67cc11f2bb278.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-2 xs:px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/library/>Library</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/about/>About</a></div><div class="flex nav-item h-12 items-center"><a class=text-white href=https://aakinshin.net/search/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#magnifying-glass"/></svg></a></div></div><button id=theme-toggle type=button title="Alt+Click to match OS color theme" class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Merging extended P² quantile estimators, Part 1</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg>
<time datetime=2024-01-02>January 2, 2024</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#math"/></svg>
Mathematics
</a><a class=label-link href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#statistics"/></svg>
Statistics
</a><a class=label-link href=https://aakinshin.net/tags/research/>Research
</a><a class=label-link href=https://aakinshin.net/tags/research-p2qe/>Research: P² quantile estimator</a></div></div><br><div class=main-content><p><a href=https://aakinshin.net/tags/research-p2qe/>P² quantile estimator</a> is a streaming quantile estimator
with $\mathcal{O}(1)$ memory footprint and an extremely fast update procedure.
Several days ago, I learned that it was <a href=https://twitter.com/rickbrewPDN/status/1740233421673349544>adopted</a> for
the new Paint.NET GPU-based Median Sketch effect
(the description is <a href=https://forums.getpaint.net/topic/124261-median-sketch-gpu/>here</a>).
While P² meets the basic problem requirement (streaming median approximation without storing all the values),
the algorithm performance is still not acceptable without additional adjustments.
A significant performance improvement <a href=https://twitter.com/rickbrewPDN/status/1740422610545234153>can be obtained</a>
if we split the input stream, process each part separately with a separate P², and merge the results.
Unfortunately, the merging procedure is a tricky thing to implement.
I enjoy such challenges, so I decided to attempt to build such a merging approach.
In this post, I describe my first attempt.</p><h3 id=the-problem>The problem</h3><p>Let us start with a simplified problem statement in which we have two streams of numbers of equal size:
$\mathbf{x} = (x_1, x_2, \ldots, x_n)$ and $\mathbf{y} = (y_1, y_2, \ldots, y_n)$.
We can perform a single pass over each stream, but we cannot store the values.
We can store some intermediate calculation results, but the storage size should still be $\mathcal{O}(1)$.
We want to know the median of the combined stream $\mathbf{z} = (x_1, y_1, x_2, y_2, \ldots, x_n, y_n)$.
The exact median value is not required, a reasonable approximation is enough.
However, the expected approximation error should be reasonable and not depend on the input stream values.</p><h3 id=speculations>Speculations</h3><p>Let us think about what we can do here.</p><p>One may be tempted to calculate the median of each stream separately and then aggregate the results somehow.
While this approach may produce an acceptable answer in some cases, it doesn&rsquo;t work in general.
Let us show a generic counterexample parametrized by the variable $R$:</p>$$
\mathbf{x} = \bigl(
\underbrace{0, 0, \ldots, 0, 0}_{100\%}
\bigr),
$$
$$
\mathbf{y} = \bigl(
\underbrace{0, 0, \ldots, 0, 0}_{40\%},
\underbrace{R, R, R, \ldots, R, R, R}_{60\%}
\bigr),
$$
$$
\mathbf{z} = \bigl(
\underbrace{0, 0, 0, 0, \ldots, 0, 0, 0}_{70\%},
\underbrace{R, R, \ldots, R}_{30\%}
\bigr),
$$<p>It is easy to see that</p>$$
\operatorname{Median}(x) = 0,\quad
\operatorname{Median}(y) = R,\quad
\operatorname{Median}(z) = 0.
$$<p>The straightforward aggregation of $\operatorname{Median}(x)$ and $\operatorname{Median}(y)$ is $R/2$,
which may be arbitrarily larger than $\operatorname{Median}(z) = 0$ depending on $R$.
Therefore, this approach is not workable.</p><p>Another idea is to use a streaming quantile estimator that supports merging out of the box.
A good example is <a href=https://github.com/tdunning/t-digest>t-digest</a>.
However, while it is natively designed for such kinds of problems, its implementation is not so trivial:
it may be challenging to come up with a proper GPU-friendly implementation.
Also, the performance overhead of t-digest is noticeably higher than the P² overhead.
It may be worth trying this idea (we can&rsquo;t say anything for sure without actual measurements),
but this is an effortful venture that we postpone for the future.
Now, we try to find a simpler solution.</p><p>The final idea is to support the merging operations for the P² quantile estimators.
In general, it feels tangible.
However, the classic P² maintains only five markers
(minimum, $(p/2)^\textrm{th}$ quantile, $p^\textrm{th}$ quantile,
$((1+p)/2)^\textrm{th}$ quantile, maximum; where $p$ is the target quantile order).
It doesn&rsquo;t feel like enough data for accurate merging implementation.
Fortunately, we have <a href=https://aakinshin.net/posts/ex-p2-quantile-estimator/>the extended P² quantile estimator</a> (ExP²),
which maintains more markers.
What if we evaluate ExP² on each stream and use all their marker values to build an aggregated median approximation?
This looks implementable.
Let&rsquo;s try it!</p><h3 id=setting-up-exp>Setting up ExP²</h3><p>For simplicity, we will not build the generic implementation but rather focus on the median case $p=0.5$
(if the idea works, we can generalize it later).
Let us define an ExP² that evaluates $m=2k+1$ uniformly distributed quantiles:</p>$$
\mathbf{p} = \left(
\frac{1}{m + 1}, \frac{2}{m + 1}, \ldots, \frac{k+1}{m+1}, \ldots, \frac{m-1}{m+1}, \frac{m}{m+1}
\right).
$$<p>It is easy to see that the middle quantile is the median:</p>$$
p_{k+1} = \frac{k+1}{m+1} = \frac{k+1}{2k+2} = 0.5.
$$<p>The corresponding ExP² will be based on $2m+3$ markers.
Let us evaluate the memory overhead.
We need two <code>double</code> arrays for the marker desired positions and their values and
one <code>int</code> array for the actual marker positions.
The target quantile orders are fixed, so we don&rsquo;t need to store them.
The marker count can be a predefined constant.
Therefore, we get</p>$$
(2m+3) \cdot \bigl( 2 \cdot \operatorname{sizeof}(\texttt{double}) + \operatorname{sizeof}(\texttt{int}) \bigr) =
(2m+3) \cdot 20~\textrm{bytes}.
$$<p>Plus array overheads (depends on the language/runtime and the current processor architecture),
plus one variable for the current observation count.
TODO: example</p><h3 id=merging-exp>Merging ExP²</h3><p>The idea we are going to try today is extremely simple.
We take two ExP² results and treat their markers as the true sub-stream quantile values.
Next, we join these two lists of markers,
using linear interpolation to determine the quantile orders for the given quantiles
(it could be upgraded to parabolic interpolation later).
Finally, we use linear interpolation one more time to get the median based on determined values.
See <code>CustomP2MedianEstimator.GetMedian</code> for details.</p><p>Since it&rsquo;s an experiment, I have written a quick-and-dirty proof-of-concept implementation in C# (do not use it as-is!).</p><h3 id=demo-time>Demo Time</h3><p>Here is my hacky proof-of-concept implementation (adjustments are needed)
and the corresponding results:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kd>internal</span> <span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>int</span> <span class=n>n</span> <span class=p>=</span> <span class=m>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>const</span> <span class=kt>int</span> <span class=n>m</span> <span class=p>=</span> <span class=m>7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Special cases</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>Check</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>n</span><span class=p>).</span><span class=n>Select</span><span class=p>(</span><span class=n>i</span> <span class=p>=&gt;</span> <span class=m>0.0</span><span class=p>).</span><span class=n>ToArray</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>n</span><span class=p>).</span><span class=n>Select</span><span class=p>(</span><span class=n>i</span> <span class=p>=&gt;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>0.4</span> <span class=p>*</span> <span class=n>n</span> <span class=p>?</span> <span class=m>0.0</span> <span class=p>:</span> <span class=m>1.0</span><span class=p>).</span><span class=n>ToArray</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>Check</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>n</span><span class=p>).</span><span class=n>Select</span><span class=p>(</span><span class=n>i</span> <span class=p>=&gt;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>0.4</span> <span class=p>*</span> <span class=n>n</span> <span class=p>?</span> <span class=m>0.0</span> <span class=p>:</span> <span class=m>1.0</span><span class=p>).</span><span class=n>ToArray</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>n</span><span class=p>).</span><span class=n>Select</span><span class=p>(</span><span class=n>i</span> <span class=p>=&gt;</span> <span class=m>0.0</span><span class=p>).</span><span class=n>ToArray</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>MultiCheck</span><span class=p>(</span><span class=s>&#34;Uniform&#34;</span><span class=p>,</span> <span class=n>GenerateUniform</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MultiCheck</span><span class=p>(</span><span class=s>&#34;Bimodal&#34;</span><span class=p>,</span> <span class=n>GenerateBimodal</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>MultiCheck</span><span class=p>(</span><span class=kt>string</span> <span class=n>title</span><span class=p>,</span> <span class=n>Func</span><span class=p>&lt;</span><span class=n>Random</span><span class=p>,</span> <span class=kt>int</span><span class=p>,</span> <span class=kt>double</span><span class=p>[]&gt;</span> <span class=n>generate</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>$&#34;*** {title} ***&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>random</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>(</span><span class=m>1729</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>results</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>CheckResult</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>100</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>x</span> <span class=p>=</span> <span class=n>generate</span><span class=p>(</span><span class=n>random</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>y</span> <span class=p>=</span> <span class=n>generate</span><span class=p>(</span><span class=n>random</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>Check</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>m</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=p>.</span><span class=n>Sort</span><span class=p>((</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=n>a</span><span class=p>.</span><span class=n>ApproxGain</span><span class=p>.</span><span class=n>CompareTo</span><span class=p>(</span><span class=n>b</span><span class=p>.</span><span class=n>ApproxGain</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>result</span> <span class=k>in</span> <span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>CheckResult</span> <span class=n>Check</span><span class=p>(</span><span class=kt>double</span><span class=p>[]</span> <span class=n>x</span><span class=p>,</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>y</span><span class=p>,</span> <span class=kt>int</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>xEstimator</span> <span class=p>=</span> <span class=k>new</span> <span class=n>CustomP2MedianEstimator</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>yEstimator</span> <span class=p>=</span> <span class=k>new</span> <span class=n>CustomP2MedianEstimator</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>x</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>xEstimator</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=n>y</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>j</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>yEstimator</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>y</span><span class=p>[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>medianApprox</span> <span class=p>=</span> <span class=n>CustomP2MedianEstimator</span><span class=p>.</span><span class=n>GetMedian</span><span class=p>(</span><span class=n>xEstimator</span><span class=p>,</span> <span class=n>yEstimator</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>medianTrue</span> <span class=p>=</span> <span class=n>GetMedian</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>Concat</span><span class=p>(</span><span class=n>y</span><span class=p>).</span><span class=n>ToArray</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>medianX</span> <span class=p>=</span> <span class=n>P2QuantileEstimator</span><span class=p>.</span><span class=n>GetMedian</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>medianY</span> <span class=p>=</span> <span class=n>P2QuantileEstimator</span><span class=p>.</span><span class=n>GetMedian</span><span class=p>(</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>CheckResult</span><span class=p>(</span><span class=n>medianApprox</span><span class=p>,</span> <span class=n>medianTrue</span><span class=p>,</span> <span class=n>medianX</span><span class=p>,</span> <span class=n>medianY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>GenerateUniform</span><span class=p>(</span><span class=n>Random</span> <span class=n>random</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>_</span> <span class=p>=&gt;</span> <span class=n>random</span><span class=p>.</span><span class=n>NextDouble</span><span class=p>()).</span><span class=n>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>GenerateBimodal</span><span class=p>(</span><span class=n>Random</span> <span class=n>random</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>_</span> <span class=p>=&gt;</span> <span class=n>random</span><span class=p>.</span><span class=n>Next</span><span class=p>(</span><span class=m>2</span><span class=p>)</span> <span class=p>==</span> <span class=m>0</span> <span class=p>?</span> <span class=n>random</span><span class=p>.</span><span class=n>NextDouble</span><span class=p>()</span> <span class=p>:</span> <span class=n>random</span><span class=p>.</span><span class=n>NextDouble</span><span class=p>()</span> <span class=p>+</span> <span class=m>10</span><span class=p>).</span><span class=n>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>double</span> <span class=n>GetMedian</span><span class=p>(</span><span class=n>IReadOnlyList</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>sortedX</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>Order</span><span class=p>().</span><span class=n>ToList</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sortedX</span><span class=p>.</span><span class=n>Count</span> <span class=p>%</span> <span class=m>2</span> <span class=p>==</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>            <span class=p>?</span> <span class=p>(</span><span class=n>sortedX</span><span class=p>[</span><span class=n>sortedX</span><span class=p>.</span><span class=n>Count</span> <span class=p>/</span> <span class=m>2</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>sortedX</span><span class=p>[</span><span class=n>sortedX</span><span class=p>.</span><span class=n>Count</span> <span class=p>/</span> <span class=m>2</span><span class=p>])</span> <span class=p>/</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>            <span class=p>:</span> <span class=n>sortedX</span><span class=p>[</span><span class=n>sortedX</span><span class=p>.</span><span class=n>Count</span> <span class=p>/</span> <span class=m>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>class</span> <span class=nc>CheckResult</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>double</span> <span class=n>MedianApprox</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>double</span> <span class=n>MedianTrue</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>double</span> <span class=n>MedianX</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>double</span> <span class=n>MedianY</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>double</span> <span class=n>ApproxError</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>double</span> <span class=n>MeanXYError</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>double</span> <span class=n>ApproxGain</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=n>CheckResult</span><span class=p>(</span><span class=kt>double</span> <span class=n>medianApprox</span><span class=p>,</span> <span class=kt>double</span> <span class=n>medianTrue</span><span class=p>,</span> <span class=kt>double</span> <span class=n>medianX</span><span class=p>,</span> <span class=kt>double</span> <span class=n>medianY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>MedianApprox</span> <span class=p>=</span> <span class=n>medianApprox</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>MedianTrue</span> <span class=p>=</span> <span class=n>medianTrue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>MedianX</span> <span class=p>=</span> <span class=n>medianX</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>MedianY</span> <span class=p>=</span> <span class=n>medianY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ApproxError</span> <span class=p>=</span> <span class=n>Math</span><span class=p>.</span><span class=n>Abs</span><span class=p>(</span><span class=n>medianTrue</span> <span class=p>-</span> <span class=n>medianApprox</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>MeanXYError</span> <span class=p>=</span> <span class=n>Math</span><span class=p>.</span><span class=n>Abs</span><span class=p>(</span><span class=n>medianTrue</span> <span class=p>-</span> <span class=p>(</span><span class=n>medianX</span> <span class=p>+</span> <span class=n>medianY</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ApproxGain</span> <span class=p>=</span> <span class=n>MeanXYError</span> <span class=p>-</span> <span class=n>ApproxError</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kd>override</span> <span class=kt>string</span> <span class=n>ToString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>string</span> <span class=n>Format</span><span class=p>(</span><span class=kt>double</span> <span class=k>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=k>value</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;0.00&#34;</span><span class=p>).</span><span class=n>PadLeft</span><span class=p>(</span><span class=m>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=s>$&#34;True: {Format(MedianTrue)} | &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>                <span class=s>$&#34;Approx: {Format(MedianApprox)} | &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>                <span class=s>$&#34;X: {Format(MedianX)} | &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>                <span class=s>$&#34;Y: {Format(MedianY)} | &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>                <span class=s>$&#34;ApproxErr: {Format(ApproxError)} | &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>                <span class=s>$&#34;MeanXYErr: {Format(MeanXYError)} | &#34;</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>                <span class=s>$&#34;ApproxGain: {Format(ApproxGain)}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Hacky, not-complete, not-so-tested, proof-of-concept implementation</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>CustomP2MedianEstimator</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>probabilities</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=kt>int</span> <span class=n>m</span><span class=p>,</span> <span class=n>markerCount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=kt>int</span><span class=p>[]</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>ns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>q</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=n>Count</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=kd>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CustomP2MedianEstimator</span><span class=p>(</span><span class=kt>int</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>m</span> <span class=p>%</span> <span class=m>2</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>NotImplementedException</span><span class=p>(</span><span class=s>&#34;m must be odd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>probabilities</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=n>m</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>probabilities</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>)</span> <span class=p>/</span> <span class=p>(</span><span class=kt>double</span><span class=p>)(</span><span class=n>m</span> <span class=p>+</span> <span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>m</span> <span class=p>=</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>markerCount</span> <span class=p>=</span> <span class=m>2</span> <span class=p>*</span> <span class=n>m</span> <span class=p>+</span> <span class=m>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int</span><span class=p>[</span><span class=n>markerCount</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=n>markerCount</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=n>markerCount</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>void</span> <span class=n>UpdateNs</span><span class=p>(</span><span class=kt>int</span> <span class=n>maxIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Principal markers</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>ns</span><span class=p>[</span><span class=n>i</span> <span class=p>*</span> <span class=m>2</span> <span class=p>+</span> <span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=n>maxIndex</span> <span class=p>*</span> <span class=n>probabilities</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=n>markerCount</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>maxIndex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Middle markers</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>maxIndex</span> <span class=p>*</span> <span class=n>probabilities</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>ns</span><span class=p>[</span><span class=m>2</span> <span class=p>*</span> <span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>maxIndex</span> <span class=p>*</span> <span class=p>(</span><span class=n>probabilities</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>probabilities</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=n>markerCount</span> <span class=p>-</span> <span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=n>maxIndex</span> <span class=p>*</span> <span class=p>(</span><span class=m>1</span> <span class=p>+</span> <span class=n>probabilities</span><span class=p>[</span><span class=n>m</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>void</span> <span class=n>Add</span><span class=p>(</span><span class=kt>double</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>&lt;</span> <span class=n>markerCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>[</span><span class=n>Count</span><span class=p>++]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>==</span> <span class=n>markerCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Array</span><span class=p>.</span><span class=n>Sort</span><span class=p>(</span><span class=n>q</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>UpdateNs</span><span class=p>(</span><span class=n>markerCount</span> <span class=p>-</span> <span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>markerCount</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Round</span><span class=p>(</span><span class=n>ns</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>Array</span><span class=p>.</span><span class=n>Copy</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>ns</span><span class=p>,</span> <span class=n>markerCount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>markerCount</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                    <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>                <span class=n>UpdateNs</span><span class=p>(</span><span class=n>markerCount</span> <span class=p>-</span> <span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>k</span> <span class=p>=</span> <span class=p>-</span><span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>markerCount</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>k</span> <span class=p>=</span> <span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>k</span> <span class=p>==</span> <span class=p>-</span><span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>markerCount</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>k</span> <span class=p>=</span> <span class=n>markerCount</span> <span class=p>-</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=n>k</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>markerCount</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]++;</span>
</span></span><span class=line><span class=cl>        <span class=n>UpdateNs</span><span class=p>(</span><span class=n>Count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>leftI</span> <span class=p>=</span> <span class=m>1</span><span class=p>,</span> <span class=n>rightI</span> <span class=p>=</span> <span class=n>markerCount</span> <span class=p>-</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>leftI</span> <span class=p>&lt;=</span> <span class=n>rightI</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>Math</span><span class=p>.</span><span class=n>Abs</span><span class=p>(</span><span class=n>ns</span><span class=p>[</span><span class=n>leftI</span><span class=p>]</span> <span class=p>/</span> <span class=n>Count</span> <span class=p>-</span> <span class=m>0.5</span><span class=p>)</span> <span class=p>&lt;=</span> <span class=n>Math</span><span class=p>.</span><span class=n>Abs</span><span class=p>(</span><span class=n>ns</span><span class=p>[</span><span class=n>rightI</span><span class=p>]</span> <span class=p>/</span> <span class=n>Count</span> <span class=p>-</span> <span class=m>0.5</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>i</span> <span class=p>=</span> <span class=n>leftI</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>i</span> <span class=p>=</span> <span class=n>rightI</span><span class=p>--;</span>
</span></span><span class=line><span class=cl>            <span class=n>Adjust</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Count</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>void</span> <span class=n>Adjust</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>d</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>d</span> <span class=p>&gt;=</span> <span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=m>1</span> <span class=p>||</span> <span class=n>d</span> <span class=p>&lt;=</span> <span class=p>-</span><span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&lt;</span> <span class=p>-</span><span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>dInt</span> <span class=p>=</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sign</span><span class=p>(</span><span class=n>d</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>qs</span> <span class=p>=</span> <span class=n>Parabolic</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>dInt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>&lt;</span> <span class=n>qs</span> <span class=p>&amp;&amp;</span> <span class=n>qs</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>qs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>Linear</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>dInt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+=</span> <span class=n>dInt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>double</span> <span class=n>Parabolic</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=kt>double</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>d</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span> <span class=p>*</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>d</span><span class=p>)</span> <span class=p>*</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>d</span><span class=p>)</span> <span class=p>*</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>double</span> <span class=n>Linear</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=kt>int</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>d</span> <span class=p>*</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=n>d</span><span class=p>]</span> <span class=p>-</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=n>d</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>void</span> <span class=n>Clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Count</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>double</span> <span class=n>GetMedian</span><span class=p>(</span><span class=n>CustomP2MedianEstimator</span> <span class=n>x</span><span class=p>,</span> <span class=n>CustomP2MedianEstimator</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>Count</span> <span class=p>!=</span> <span class=n>y</span><span class=p>.</span><span class=n>Count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>NotImplementedException</span><span class=p>(</span><span class=s>&#34;Different counts are not supported yet&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>markerCount</span> <span class=p>!=</span> <span class=n>y</span><span class=p>.</span><span class=n>markerCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>NotImplementedException</span><span class=p>(</span><span class=s>&#34;Different marker counts are not supported yet&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>Count</span> <span class=p>&lt;=</span> <span class=n>x</span><span class=p>.</span><span class=n>markerCount</span> <span class=p>||</span> <span class=n>y</span><span class=p>.</span><span class=n>Count</span> <span class=p>&lt;=</span> <span class=n>y</span><span class=p>.</span><span class=n>markerCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>size</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>Count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>values</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;(</span><span class=m>2</span> <span class=p>*</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>values</span><span class=p>.</span><span class=n>AddRange</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>q</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>values</span><span class=p>.</span><span class=n>AddRange</span><span class=p>(</span><span class=n>y</span><span class=p>.</span><span class=n>q</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>values</span><span class=p>.</span><span class=n>Sort</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Return median</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=n>values</span><span class=p>[</span><span class=n>size</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>values</span><span class=p>[</span><span class=n>size</span><span class=p>])</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>markerCount</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>markerCount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Original .n contains indexes in the range [0; Count - 1]</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Let&#39;s transform them to quantile orders in the range [0; 1].</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>px</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>n</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=k>value</span> <span class=p>=&gt;</span> <span class=k>value</span> <span class=p>/</span> <span class=p>(</span><span class=kt>double</span><span class=p>)(</span><span class=n>x</span><span class=p>.</span><span class=n>Count</span> <span class=p>-</span> <span class=m>1</span><span class=p>)).</span><span class=n>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>py</span> <span class=p>=</span> <span class=n>y</span><span class=p>.</span><span class=n>n</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=k>value</span> <span class=p>=&gt;</span> <span class=k>value</span> <span class=p>/</span> <span class=p>(</span><span class=kt>double</span><span class=p>)(</span><span class=n>y</span><span class=p>.</span><span class=n>Count</span> <span class=p>-</span> <span class=m>1</span><span class=p>)).</span><span class=n>ToArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>qx</span> <span class=p>=</span> <span class=n>x</span><span class=p>.</span><span class=n>q</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>qy</span> <span class=p>=</span> <span class=n>y</span><span class=p>.</span><span class=n>q</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>double</span><span class=p>[]</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=m>2</span> <span class=p>*</span> <span class=n>markerCount</span><span class=p>],</span> <span class=n>q</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=m>2</span> <span class=p>*</span> <span class=n>markerCount</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>,</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>,</span> <span class=n>k</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>k</span> <span class=p>&lt;</span> <span class=m>2</span> <span class=p>*</span> <span class=n>markerCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>==</span> <span class=n>markerCount</span> <span class=p>||</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>markerCount</span> <span class=p>&amp;&amp;</span> <span class=n>qx</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&lt;</span> <span class=n>qy</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Take X</span>
</span></span><span class=line><span class=cl>                <span class=kt>double</span> <span class=n>pxi</span> <span class=p>=</span> <span class=n>px</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=kt>double</span> <span class=n>pyj</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>pyj</span> <span class=p>=</span> <span class=m>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=p>==</span> <span class=n>markerCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>pyj</span> <span class=p>=</span> <span class=m>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=n>pyj</span> <span class=p>=</span> <span class=n>Interpolation</span><span class=p>(</span><span class=n>py</span><span class=p>[</span><span class=n>j</span> <span class=p>-</span> <span class=m>1</span><span class=p>],</span> <span class=n>py</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> <span class=n>qy</span><span class=p>[</span><span class=n>j</span> <span class=p>-</span> <span class=m>1</span><span class=p>],</span> <span class=n>qx</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>qy</span><span class=p>[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=n>pxi</span> <span class=p>+</span> <span class=n>pyj</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>k</span><span class=p>++]</span> <span class=p>=</span> <span class=n>qx</span><span class=p>[</span><span class=n>i</span><span class=p>++];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Take Y</span>
</span></span><span class=line><span class=cl>                <span class=kt>double</span> <span class=n>pyj</span> <span class=p>=</span> <span class=n>py</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=kt>double</span> <span class=n>pxi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>pxi</span> <span class=p>=</span> <span class=m>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=p>==</span> <span class=n>markerCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>pxi</span> <span class=p>=</span> <span class=m>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=n>pxi</span> <span class=p>=</span> <span class=n>Interpolation</span><span class=p>(</span><span class=n>px</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>],</span> <span class=n>px</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>qx</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>],</span> <span class=n>qy</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> <span class=n>qx</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=n>pxi</span> <span class=p>+</span> <span class=n>pyj</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>k</span><span class=p>++]</span> <span class=p>=</span> <span class=n>qy</span><span class=p>[</span><span class=n>j</span><span class=p>++];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>k</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>k</span> <span class=p>&lt;</span> <span class=m>2</span> <span class=p>*</span> <span class=n>markerCount</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>k</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>k</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>&gt;=</span> <span class=m>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>Interpolation</span><span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> <span class=n>q</span><span class=p>[</span><span class=n>k</span> <span class=p>+</span> <span class=m>1</span><span class=p>],</span> <span class=n>p</span><span class=p>[</span><span class=n>k</span><span class=p>],</span> <span class=m>0.5</span><span class=p>,</span> <span class=n>p</span><span class=p>[</span><span class=n>k</span> <span class=p>+</span> <span class=m>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidOperationException</span><span class=p>(</span><span class=s>&#34;Median not found&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>double</span> <span class=n>Interpolation</span><span class=p>(</span><span class=kt>double</span> <span class=n>start</span><span class=p>,</span> <span class=kt>double</span> <span class=n>end</span><span class=p>,</span> <span class=kt>double</span> <span class=n>prev</span><span class=p>,</span> <span class=kt>double</span> <span class=n>current</span><span class=p>,</span> <span class=kt>double</span> <span class=n>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Math</span><span class=p>.</span><span class=n>Abs</span><span class=p>(</span><span class=n>next</span> <span class=p>-</span> <span class=n>prev</span><span class=p>)</span> <span class=p>&lt;</span> <span class=m>1e-9</span>
</span></span><span class=line><span class=cl>            <span class=p>?</span> <span class=n>end</span>
</span></span><span class=line><span class=cl>            <span class=p>:</span> <span class=n>start</span> <span class=p>+</span> <span class=p>(</span><span class=n>end</span> <span class=p>-</span> <span class=n>start</span><span class=p>)</span> <span class=p>*</span> <span class=p>(</span><span class=n>current</span> <span class=p>-</span> <span class=n>prev</span><span class=p>)</span> <span class=p>/</span> <span class=p>(</span><span class=n>next</span> <span class=p>-</span> <span class=n>prev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Copy-pasted from https://aakinshin.net/posts/p2-quantile-estimator-adjusting-order/</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>P2QuantileEstimator</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=kt>double</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=n>InitializationStrategy</span> <span class=n>strategy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=kt>int</span><span class=p>[]</span> <span class=n>n</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>int</span><span class=p>[</span><span class=m>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>ns</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=m>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>readonly</span> <span class=kt>double</span><span class=p>[]</span> <span class=n>q</span> <span class=p>=</span> <span class=k>new</span> <span class=kt>double</span><span class=p>[</span><span class=m>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>int</span> <span class=n>Count</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=kd>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>enum</span> <span class=n>InitializationStrategy</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Classic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Adaptive</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>P2QuantileEstimator</span><span class=p>(</span><span class=kt>double</span> <span class=n>probability</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                               <span class=n>InitializationStrategy</span> <span class=n>strategy</span> <span class=p>=</span> <span class=n>InitializationStrategy</span><span class=p>.</span><span class=n>Classic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=p>=</span> <span class=n>probability</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>strategy</span> <span class=p>=</span> <span class=n>strategy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>void</span> <span class=n>Add</span><span class=p>(</span><span class=kt>double</span> <span class=k>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>&lt;</span> <span class=m>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>[</span><span class=n>Count</span><span class=p>++]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>==</span> <span class=m>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Array</span><span class=p>.</span><span class=n>Sort</span><span class=p>(</span><span class=n>q</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>5</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>strategy</span> <span class=p>==</span> <span class=n>InitializationStrategy</span><span class=p>.</span><span class=n>Adaptive</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Array</span><span class=p>.</span><span class=n>Copy</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>ns</span><span class=p>,</span> <span class=m>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Round</span><span class=p>(</span><span class=m>2</span> <span class=p>*</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Round</span><span class=p>(</span><span class=m>4</span> <span class=p>*</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Round</span><span class=p>(</span><span class=m>2</span> <span class=p>+</span> <span class=m>2</span> <span class=p>*</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>q</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>n</span><span class=p>[</span><span class=m>1</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>                    <span class=n>q</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>n</span><span class=p>[</span><span class=m>2</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>                    <span class=n>q</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>n</span><span class=p>[</span><span class=m>3</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=m>2</span> <span class=p>*</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=m>4</span> <span class=p>*</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=m>2</span> <span class=p>+</span> <span class=m>2</span> <span class=p>*</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>ns</span><span class=p>[</span><span class=m>4</span><span class=p>]</span> <span class=p>=</span> <span class=m>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>[</span><span class=m>0</span><span class=p>]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=m>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>[</span><span class=m>4</span><span class=p>]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span> <span class=p>=</span> <span class=m>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=n>k</span> <span class=p>+</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>5</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>            <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]++;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>Count</span> <span class=p>*</span> <span class=n>p</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=n>Count</span> <span class=p>*</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=n>Count</span> <span class=p>*</span> <span class=p>(</span><span class=m>1</span> <span class=p>+</span> <span class=n>p</span><span class=p>)</span> <span class=p>/</span> <span class=m>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ns</span><span class=p>[</span><span class=m>4</span><span class=p>]</span> <span class=p>=</span> <span class=n>Count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=p>&gt;=</span> <span class=m>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;=</span> <span class=m>3</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>                <span class=n>Adjust</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>3</span><span class=p>;</span> <span class=n>i</span> <span class=p>&gt;=</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>--)</span>
</span></span><span class=line><span class=cl>                <span class=n>Adjust</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Count</span><span class=p>++;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=k>void</span> <span class=n>Adjust</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>d</span> <span class=p>=</span> <span class=n>ns</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>d</span> <span class=p>&gt;=</span> <span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=m>1</span> <span class=p>||</span> <span class=n>d</span> <span class=p>&lt;=</span> <span class=p>-</span><span class=m>1</span> <span class=p>&amp;&amp;</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&lt;</span> <span class=p>-</span><span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>dInt</span> <span class=p>=</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sign</span><span class=p>(</span><span class=n>d</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>qs</span> <span class=p>=</span> <span class=n>Parabolic</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>dInt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>&lt;</span> <span class=n>qs</span> <span class=p>&amp;&amp;</span> <span class=n>qs</span> <span class=p>&lt;</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>qs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>Linear</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>dInt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+=</span> <span class=n>dInt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>double</span> <span class=n>Parabolic</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=kt>double</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>d</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span> <span class=p>*</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>]</span> <span class=p>+</span> <span class=n>d</span><span class=p>)</span> <span class=p>*</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>+</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>d</span><span class=p>)</span> <span class=p>*</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>-</span> <span class=m>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>double</span> <span class=n>Linear</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=kt>int</span> <span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>+</span> <span class=n>d</span> <span class=p>*</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=n>d</span><span class=p>]</span> <span class=p>-</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>/</span> <span class=p>(</span><span class=n>n</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=n>d</span><span class=p>]</span> <span class=p>-</span> <span class=n>n</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>double</span> <span class=n>GetQuantile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>==</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidOperationException</span><span class=p>(</span><span class=s>&#34;Sequence contains no elements&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Count</span> <span class=p>&lt;=</span> <span class=m>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Array</span><span class=p>.</span><span class=n>Sort</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=n>Count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>index</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Round</span><span class=p>((</span><span class=n>Count</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span> <span class=p>*</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=n>index</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>q</span><span class=p>[</span><span class=m>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>void</span> <span class=n>Clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Count</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>double</span> <span class=n>GetMedian</span><span class=p>(</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>double</span><span class=p>&gt;</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>estimator</span> <span class=p>=</span> <span class=k>new</span> <span class=n>P2QuantileEstimator</span><span class=p>(</span><span class=m>0.5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=k>value</span> <span class=k>in</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>estimator</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=k>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>estimator</span><span class=p>.</span><span class=n>GetQuantile</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>True:  0.00 | Approx:  0.00 | X:  0.00 | Y:  0.54 | ApproxErr:  0.00 | MeanXYErr:  0.27 | ApproxGain:  0.27
</span></span><span class=line><span class=cl>True:  0.00 | Approx:  0.00 | X:  0.54 | Y:  0.00 | ApproxErr:  0.00 | MeanXYErr:  0.27 | ApproxGain:  0.27
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*** Uniform ***
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.50 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.50 | X:  0.51 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.51 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.48 | Approx:  0.49 | X:  0.50 | Y:  0.47 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.51 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.51 | X:  0.50 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.50 | X:  0.47 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.47 | Approx:  0.46 | X:  0.47 | Y:  0.46 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.50 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.50 | X:  0.52 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.50 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.49 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.48 | Approx:  0.49 | X:  0.47 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.52 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.51 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.51 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.47 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.52 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.50 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.48 | Approx:  0.49 | X:  0.49 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.49 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.48 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.51 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.49 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.52 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.50 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.49 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.47 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.50 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.49 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.53 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.52 | Approx:  0.52 | X:  0.52 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.49 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.53 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.47 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.52 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.52 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.53 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.47 | Approx:  0.47 | X:  0.47 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.48 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.48 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.52 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.48 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.47 | Approx:  0.48 | X:  0.47 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.50 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.49 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.50 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.48 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.47 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain: -0.00
</span></span><span class=line><span class=cl>True:  0.53 | Approx:  0.52 | X:  0.51 | Y:  0.54 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.50 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.51 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.52 | Approx:  0.52 | X:  0.52 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.50 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.52 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.52 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.52 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.48 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.50 | X:  0.50 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.48 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.48 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.48 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.49 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.50 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.52 | Approx:  0.52 | X:  0.51 | Y:  0.53 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.48 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.54 | Approx:  0.54 | X:  0.53 | Y:  0.55 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.47 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.49 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.50 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.48 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.50 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.51 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.52 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.50 | X:  0.51 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.51 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.53 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.51 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.51 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.48 | Approx:  0.48 | X:  0.48 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.48 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.01 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.52 | Approx:  0.52 | X:  0.51 | Y:  0.52 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.51 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.54 | Y:  0.49 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.51 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.49 | Approx:  0.49 | X:  0.47 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.50 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.52 | Approx:  0.52 | X:  0.50 | Y:  0.54 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.51 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.01 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.52 | Approx:  0.52 | X:  0.52 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.52 | Approx:  0.52 | X:  0.51 | Y:  0.53 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.51 | X:  0.51 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.00 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.48 | Approx:  0.48 | X:  0.46 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.01 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.52 | Approx:  0.51 | X:  0.47 | Y:  0.55 | ApproxErr:  0.00 | MeanXYErr:  0.01 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.49 | X:  0.47 | Y:  0.53 | ApproxErr:  0.00 | MeanXYErr:  0.01 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.48 | Approx:  0.49 | X:  0.50 | Y:  0.46 | ApproxErr:  0.00 | MeanXYErr:  0.01 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.51 | X:  0.52 | Y:  0.50 | ApproxErr:  0.01 | MeanXYErr:  0.01 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.50 | X:  0.52 | Y:  0.48 | ApproxErr:  0.00 | MeanXYErr:  0.01 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.51 | Approx:  0.51 | X:  0.51 | Y:  0.51 | ApproxErr:  0.00 | MeanXYErr:  0.01 | ApproxGain:  0.00
</span></span><span class=line><span class=cl>True:  0.50 | Approx:  0.50 | X:  0.52 | Y:  0.50 | ApproxErr:  0.00 | MeanXYErr:  0.01 | ApproxGain:  0.01
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*** Bimodal ***
</span></span><span class=line><span class=cl>True:  1.00 | Approx:  5.40 | X:  3.49 | Y:  0.89 | ApproxErr:  4.40 | MeanXYErr:  1.19 | ApproxGain: -3.21
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  6.73 | X:  4.56 | Y:  3.64 | ApproxErr:  5.74 | MeanXYErr:  3.11 | ApproxGain: -2.63
</span></span><span class=line><span class=cl>True:  0.97 | Approx:  4.86 | X:  3.63 | Y:  0.98 | ApproxErr:  3.90 | MeanXYErr:  1.34 | ApproxGain: -2.55
</span></span><span class=line><span class=cl>True: 10.00 | Approx:  4.37 | X:  8.14 | Y:  5.21 | ApproxErr:  5.63 | MeanXYErr:  3.33 | ApproxGain: -2.30
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  7.41 | X:  9.88 | Y:  9.06 | ApproxErr:  2.60 | MeanXYErr:  0.54 | ApproxGain: -2.06
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  6.98 | X: 10.06 | Y:  7.72 | ApproxErr:  3.04 | MeanXYErr:  1.13 | ApproxGain: -1.91
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  5.35 | X:  5.94 | Y:  1.30 | ApproxErr:  4.36 | MeanXYErr:  2.63 | ApproxGain: -1.74
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  3.51 | X:  2.39 | Y:  1.21 | ApproxErr:  2.53 | MeanXYErr:  0.82 | ApproxGain: -1.71
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  7.11 | X:  7.63 | Y:  9.94 | ApproxErr:  2.90 | MeanXYErr:  1.22 | ApproxGain: -1.67
</span></span><span class=line><span class=cl>True:  1.00 | Approx:  4.37 | X:  3.73 | Y:  1.67 | ApproxErr:  3.37 | MeanXYErr:  1.71 | ApproxGain: -1.67
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  5.80 | X:  5.14 | Y:  9.71 | ApproxErr:  4.21 | MeanXYErr:  2.58 | ApproxGain: -1.63
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  7.86 | X:  9.52 | Y:  9.34 | ApproxErr:  2.16 | MeanXYErr:  0.58 | ApproxGain: -1.57
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  4.95 | X:  4.98 | Y:  7.96 | ApproxErr:  5.05 | MeanXYErr:  3.54 | ApproxGain: -1.52
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  6.16 | X:  5.28 | Y:  4.35 | ApproxErr:  5.17 | MeanXYErr:  3.82 | ApproxGain: -1.35
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  6.31 | X:  5.36 | Y:  9.92 | ApproxErr:  3.72 | MeanXYErr:  2.38 | ApproxGain: -1.34
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  4.13 | X:  3.81 | Y:  1.84 | ApproxErr:  3.15 | MeanXYErr:  1.85 | ApproxGain: -1.30
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  5.84 | X:  8.49 | Y:  5.54 | ApproxErr:  4.18 | MeanXYErr:  3.00 | ApproxGain: -1.18
</span></span><span class=line><span class=cl>True: 10.03 | Approx:  8.23 | X:  8.71 | Y: 10.02 | ApproxErr:  1.80 | MeanXYErr:  0.67 | ApproxGain: -1.13
</span></span><span class=line><span class=cl>True: 10.00 | Approx:  5.56 | X:  3.41 | Y:  9.94 | ApproxErr:  4.44 | MeanXYErr:  3.33 | ApproxGain: -1.12
</span></span><span class=line><span class=cl>True:  1.00 | Approx:  4.57 | X:  4.20 | Y:  2.71 | ApproxErr:  3.57 | MeanXYErr:  2.45 | ApproxGain: -1.11
</span></span><span class=line><span class=cl>True: 10.03 | Approx:  8.73 | X: 10.01 | Y:  9.66 | ApproxErr:  1.30 | MeanXYErr:  0.19 | ApproxGain: -1.11
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  5.98 | X:  4.40 | Y:  9.72 | ApproxErr:  4.02 | MeanXYErr:  2.94 | ApproxGain: -1.08
</span></span><span class=line><span class=cl>True: 10.00 | Approx:  5.08 | X:  6.53 | Y:  5.68 | ApproxErr:  4.92 | MeanXYErr:  3.89 | ApproxGain: -1.03
</span></span><span class=line><span class=cl>True:  1.00 | Approx:  7.05 | X:  3.59 | Y:  8.48 | ApproxErr:  6.05 | MeanXYErr:  5.03 | ApproxGain: -1.02
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  6.28 | X:  4.47 | Y:  9.81 | ApproxErr:  3.73 | MeanXYErr:  2.87 | ApproxGain: -0.86
</span></span><span class=line><span class=cl>True: 10.03 | Approx:  7.13 | X:  9.88 | Y:  5.98 | ApproxErr:  2.91 | MeanXYErr:  2.11 | ApproxGain: -0.80
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  2.48 | X:  1.05 | Y:  2.33 | ApproxErr:  1.50 | MeanXYErr:  0.71 | ApproxGain: -0.79
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  3.19 | X:  3.28 | Y:  1.70 | ApproxErr:  2.21 | MeanXYErr:  1.50 | ApproxGain: -0.71
</span></span><span class=line><span class=cl>True: 10.00 | Approx:  5.00 | X:  4.37 | Y:  6.88 | ApproxErr:  5.00 | MeanXYErr:  4.38 | ApproxGain: -0.62
</span></span><span class=line><span class=cl>True: 10.00 | Approx:  6.69 | X:  9.38 | Y:  5.23 | ApproxErr:  3.31 | MeanXYErr:  2.70 | ApproxGain: -0.61
</span></span><span class=line><span class=cl>True:  1.00 | Approx:  6.01 | X:  9.24 | Y:  1.66 | ApproxErr:  5.01 | MeanXYErr:  4.45 | ApproxGain: -0.56
</span></span><span class=line><span class=cl>True:  5.50 | Approx:  6.29 | X:  1.83 | Y:  9.66 | ApproxErr:  0.79 | MeanXYErr:  0.24 | ApproxGain: -0.55
</span></span><span class=line><span class=cl>True:  0.95 | Approx:  4.66 | X:  6.68 | Y:  1.56 | ApproxErr:  3.71 | MeanXYErr:  3.17 | ApproxGain: -0.54
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  8.74 | X:  8.57 | Y:  9.58 | ApproxErr:  1.28 | MeanXYErr:  0.95 | ApproxGain: -0.34
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  5.16 | X:  1.08 | Y:  8.57 | ApproxErr:  4.17 | MeanXYErr:  3.84 | ApproxGain: -0.33
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  6.95 | X:  4.84 | Y:  9.70 | ApproxErr:  3.07 | MeanXYErr:  2.75 | ApproxGain: -0.32
</span></span><span class=line><span class=cl>True:  0.96 | Approx:  5.20 | X:  5.84 | Y:  3.94 | ApproxErr:  4.24 | MeanXYErr:  3.93 | ApproxGain: -0.31
</span></span><span class=line><span class=cl>True: 10.05 | Approx:  9.76 | X:  9.97 | Y: 10.10 | ApproxErr:  0.29 | MeanXYErr:  0.01 | ApproxGain: -0.28
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  5.98 | X:  5.63 | Y:  5.92 | ApproxErr:  4.99 | MeanXYErr:  4.79 | ApproxGain: -0.20
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  5.55 | X:  1.61 | Y:  9.72 | ApproxErr:  4.45 | MeanXYErr:  4.34 | ApproxGain: -0.11
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  5.46 | X:  1.71 | Y:  9.01 | ApproxErr:  4.47 | MeanXYErr:  4.37 | ApproxGain: -0.10
</span></span><span class=line><span class=cl>True: 10.06 | Approx:  9.79 | X:  9.92 | Y:  9.84 | ApproxErr:  0.27 | MeanXYErr:  0.18 | ApproxGain: -0.09
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  5.47 | X:  9.06 | Y:  1.79 | ApproxErr:  4.48 | MeanXYErr:  4.43 | ApproxGain: -0.05
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  5.55 | X:  1.52 | Y:  9.60 | ApproxErr:  4.56 | MeanXYErr:  4.57 | ApproxGain:  0.01
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  5.22 | X:  0.95 | Y:  9.54 | ApproxErr:  4.24 | MeanXYErr:  4.27 | ApproxGain:  0.03
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  4.98 | X:  0.92 | Y:  9.29 | ApproxErr:  4.00 | MeanXYErr:  4.12 | ApproxGain:  0.12
</span></span><span class=line><span class=cl>True:  1.00 | Approx:  4.16 | X:  6.94 | Y:  1.65 | ApproxErr:  3.16 | MeanXYErr:  3.29 | ApproxGain:  0.13
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  5.76 | X:  9.69 | Y:  1.52 | ApproxErr:  4.26 | MeanXYErr:  4.41 | ApproxGain:  0.15
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  5.31 | X:  9.78 | Y:  1.20 | ApproxErr:  4.32 | MeanXYErr:  4.50 | ApproxGain:  0.18
</span></span><span class=line><span class=cl>True: 10.00 | Approx:  4.99 | X:  3.82 | Y:  5.75 | ApproxErr:  5.01 | MeanXYErr:  5.22 | ApproxGain:  0.20
</span></span><span class=line><span class=cl>True:  5.50 | Approx:  3.56 | X:  7.67 | Y:  7.82 | ApproxErr:  1.94 | MeanXYErr:  2.24 | ApproxGain:  0.31
</span></span><span class=line><span class=cl>True:  0.96 | Approx:  4.01 | X:  1.00 | Y:  7.66 | ApproxErr:  3.05 | MeanXYErr:  3.37 | ApproxGain:  0.32
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  6.52 | X:  6.01 | Y:  6.37 | ApproxErr:  3.49 | MeanXYErr:  3.83 | ApproxGain:  0.34
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  4.96 | X:  0.90 | Y:  9.70 | ApproxErr:  3.98 | MeanXYErr:  4.32 | ApproxGain:  0.34
</span></span><span class=line><span class=cl>True:  0.97 | Approx:  5.03 | X:  1.16 | Y:  9.58 | ApproxErr:  4.06 | MeanXYErr:  4.40 | ApproxGain:  0.34
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  5.01 | X:  2.39 | Y:  8.39 | ApproxErr:  4.03 | MeanXYErr:  4.41 | ApproxGain:  0.38
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  5.97 | X:  5.55 | Y:  5.57 | ApproxErr:  4.05 | MeanXYErr:  4.46 | ApproxGain:  0.41
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  8.09 | X:  6.08 | Y:  9.17 | ApproxErr:  1.93 | MeanXYErr:  2.39 | ApproxGain:  0.47
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  6.49 | X:  9.91 | Y:  2.12 | ApproxErr:  3.53 | MeanXYErr:  4.01 | ApproxGain:  0.48
</span></span><span class=line><span class=cl>True:  1.00 | Approx:  6.94 | X:  9.97 | Y:  4.87 | ApproxErr:  5.94 | MeanXYErr:  6.42 | ApproxGain:  0.48
</span></span><span class=line><span class=cl>True: 10.00 | Approx:  6.10 | X:  1.51 | Y:  9.71 | ApproxErr:  3.90 | MeanXYErr:  4.39 | ApproxGain:  0.49
</span></span><span class=line><span class=cl>True:  0.97 | Approx:  3.85 | X:  1.09 | Y:  7.87 | ApproxErr:  2.88 | MeanXYErr:  3.51 | ApproxGain:  0.63
</span></span><span class=line><span class=cl>True:  0.99 | Approx:  3.47 | X:  1.52 | Y:  6.95 | ApproxErr:  2.48 | MeanXYErr:  3.25 | ApproxGain:  0.76
</span></span><span class=line><span class=cl>True: 10.04 | Approx:  8.54 | X:  9.47 | Y:  6.07 | ApproxErr:  1.50 | MeanXYErr:  2.27 | ApproxGain:  0.77
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  6.44 | X:  9.25 | Y:  1.93 | ApproxErr:  3.58 | MeanXYErr:  4.43 | ApproxGain:  0.85
</span></span><span class=line><span class=cl>True:  0.97 | Approx:  4.77 | X:  2.89 | Y:  8.34 | ApproxErr:  3.80 | MeanXYErr:  4.65 | ApproxGain:  0.85
</span></span><span class=line><span class=cl>True:  0.97 | Approx:  3.67 | X:  6.64 | Y:  2.52 | ApproxErr:  2.70 | MeanXYErr:  3.61 | ApproxGain:  0.91
</span></span><span class=line><span class=cl>True:  0.94 | Approx:  4.01 | X:  1.00 | Y:  8.87 | ApproxErr:  3.06 | MeanXYErr:  3.99 | ApproxGain:  0.93
</span></span><span class=line><span class=cl>True: 10.06 | Approx:  7.27 | X: 10.20 | Y:  2.38 | ApproxErr:  2.79 | MeanXYErr:  3.77 | ApproxGain:  0.98
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  5.07 | X:  2.81 | Y:  5.36 | ApproxErr:  4.94 | MeanXYErr:  5.93 | ApproxGain:  0.99
</span></span><span class=line><span class=cl>True: 10.00 | Approx:  7.51 | X:  3.41 | Y:  9.51 | ApproxErr:  2.50 | MeanXYErr:  3.54 | ApproxGain:  1.04
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  5.20 | X:  6.16 | Y:  1.99 | ApproxErr:  4.82 | MeanXYErr:  5.95 | ApproxGain:  1.13
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  4.41 | X:  7.19 | Y:  3.91 | ApproxErr:  3.43 | MeanXYErr:  4.57 | ApproxGain:  1.14
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  3.10 | X:  1.61 | Y:  6.99 | ApproxErr:  2.12 | MeanXYErr:  3.32 | ApproxGain:  1.20
</span></span><span class=line><span class=cl>True: 10.03 | Approx:  7.39 | X:  9.11 | Y:  3.23 | ApproxErr:  2.65 | MeanXYErr:  3.86 | ApproxGain:  1.21
</span></span><span class=line><span class=cl>True: 10.00 | Approx:  5.27 | X:  3.17 | Y:  4.69 | ApproxErr:  4.74 | MeanXYErr:  6.07 | ApproxGain:  1.33
</span></span><span class=line><span class=cl>True:  0.96 | Approx:  3.27 | X:  1.06 | Y:  8.17 | ApproxErr:  2.31 | MeanXYErr:  3.66 | ApproxGain:  1.35
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  6.95 | X:  7.81 | Y:  3.25 | ApproxErr:  3.07 | MeanXYErr:  4.49 | ApproxGain:  1.42
</span></span><span class=line><span class=cl>True: 10.03 | Approx:  8.05 | X:  9.80 | Y:  3.11 | ApproxErr:  1.99 | MeanXYErr:  3.58 | ApproxGain:  1.59
</span></span><span class=line><span class=cl>True: 10.05 | Approx:  8.11 | X: 10.06 | Y:  2.51 | ApproxErr:  1.94 | MeanXYErr:  3.77 | ApproxGain:  1.82
</span></span><span class=line><span class=cl>True:  1.00 | Approx:  5.58 | X:  5.34 | Y:  9.55 | ApproxErr:  4.58 | MeanXYErr:  6.45 | ApproxGain:  1.87
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  5.10 | X:  8.00 | Y:  5.96 | ApproxErr:  4.11 | MeanXYErr:  5.99 | ApproxGain:  1.88
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  6.98 | X:  9.28 | Y:  8.55 | ApproxErr:  5.99 | MeanXYErr:  7.93 | ApproxGain:  1.94
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  4.47 | X:  7.62 | Y:  5.45 | ApproxErr:  3.49 | MeanXYErr:  5.56 | ApproxGain:  2.07
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  5.42 | X:  5.92 | Y:  9.26 | ApproxErr:  4.44 | MeanXYErr:  6.60 | ApproxGain:  2.17
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  5.46 | X:  4.11 | Y:  2.44 | ApproxErr:  4.54 | MeanXYErr:  6.73 | ApproxGain:  2.19
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  5.21 | X:  1.91 | Y:  3.69 | ApproxErr:  4.79 | MeanXYErr:  7.20 | ApproxGain:  2.41
</span></span><span class=line><span class=cl>True: 10.03 | Approx:  6.25 | X:  4.32 | Y:  3.35 | ApproxErr:  3.77 | MeanXYErr:  6.19 | ApproxGain:  2.42
</span></span><span class=line><span class=cl>True:  0.97 | Approx:  4.36 | X:  7.37 | Y:  6.24 | ApproxErr:  3.38 | MeanXYErr:  5.83 | ApproxGain:  2.45
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  7.25 | X:  3.24 | Y:  6.21 | ApproxErr:  2.78 | MeanXYErr:  5.30 | ApproxGain:  2.52
</span></span><span class=line><span class=cl>True:  0.98 | Approx:  5.02 | X:  8.02 | Y:  7.82 | ApproxErr:  4.04 | MeanXYErr:  6.94 | ApproxGain:  2.90
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  5.86 | X:  2.13 | Y:  3.68 | ApproxErr:  4.15 | MeanXYErr:  7.10 | ApproxGain:  2.95
</span></span><span class=line><span class=cl>True:  0.97 | Approx:  3.37 | X:  7.12 | Y:  6.04 | ApproxErr:  2.40 | MeanXYErr:  5.60 | ApproxGain:  3.21
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  6.29 | X:  3.84 | Y:  1.81 | ApproxErr:  3.73 | MeanXYErr:  7.19 | ApproxGain:  3.46
</span></span><span class=line><span class=cl>True: 10.04 | Approx:  6.61 | X:  2.58 | Y:  3.38 | ApproxErr:  3.43 | MeanXYErr:  7.06 | ApproxGain:  3.62
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  8.25 | X:  5.16 | Y:  3.82 | ApproxErr:  1.77 | MeanXYErr:  5.53 | ApproxGain:  3.76
</span></span><span class=line><span class=cl>True: 10.01 | Approx:  8.43 | X:  4.16 | Y:  5.15 | ApproxErr:  1.57 | MeanXYErr:  5.36 | ApproxGain:  3.78
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  8.49 | X:  3.45 | Y:  5.03 | ApproxErr:  1.52 | MeanXYErr:  5.77 | ApproxGain:  4.25
</span></span><span class=line><span class=cl>True: 10.02 | Approx:  7.92 | X:  3.14 | Y:  3.89 | ApproxErr:  2.10 | MeanXYErr:  6.51 | ApproxGain:  4.40
</span></span><span class=line><span class=cl>True: 10.05 | Approx:  8.50 | X:  3.84 | Y:  3.80 | ApproxErr:  1.55 | MeanXYErr:  6.23 | ApproxGain:  4.67
</span></span></code></pre></div><h3 id=conclusion>Conclusion</h3><p>In general, the suggested merging procedure works well, the experiment is successful.
It perfectly handles the corner case we discussed in the beginning.
However, I wouldn&rsquo;t say that is noticeably superior to the average of separate sub-stream medians.
Fortunately, we have room for improvement.
Here is my plan for further idea development:</p><ul><li>Check the correctness of the current implementation and fix bugs.
It is worth debugging cases when the suggested approach works much worse than the average of the medians.</li><li>Use parabolic interpolation instead of the linear one.</li><li>Add more different distributions to the dataset to make proper exploration research.</li><li>Investigate how we should choose the appropriate number of markers based on the expected stream length.</li><li>Generalize the algorithms and support all the corner cases
(e.g., streams of unequal lengths, evaluation of arbitrary quantiles, merging multiple estimators, etc.).</li></ul><h3 id=references>References</h3><ul><li><b id=Jain1985>[Jain1985]</b><br>Jain, Raj, and Imrich Chlamtac.
&ldquo;The P² algorithm for dynamic calculation of quantiles and histograms without storing observations.&rdquo;
Communications of the ACM 28, no. 10 (1985): 1076-1085.<br><a href=https://doi.org/10.1145/4372.4378>https://doi.org/10.1145/4372.4378</a></li><li><b id=Raatikainen1987>[Raatikainen1987]</b><br>Raatikainen, Kimmo EE. &ldquo;Simultaneous estimation of several percentiles.&rdquo;
Simulation 49, no. 4 (1987): 159-163.<br><a href=https://doi.org/10.1177/003754978704900405>https://doi.org/10.1177/003754978704900405</a></li></ul></div><hr><h3 id=references>References (2)</h3><ol><li><a href=https://aakinshin.net/posts/ title="Library / posts"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#note"/></svg>
</a><a href=https://aakinshin.net/posts/ex-p2-quantile-estimator/>Extended P² quantile estimator
</a>(2022-01-18)
<span class=label title=References:6><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#reference"/></svg>6</span>
<span class=label title=Backlinks:2><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#backlink"/></svg>2</span>
<a href=https://aakinshin.net/tags/mathematics/><svg class="rating-icon"><title>Mathematics</title><use xlink:href="/img/fa/all.svg#math"/></svg>
</a><a href=https://aakinshin.net/tags/statistics/><svg class="rating-icon"><title>Statistics</title><use xlink:href="/img/fa/all.svg#statistics"/></svg></a></li><li><a href=https://aakinshin.net/tags/ title="Library / tags"><svg class="rating-icon"><use xlink:href="/img/fa/all.svg#tag"/></svg>
</a><a href=https://aakinshin.net/tags/research-p2qe/>Research</a></li></ol></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}));function toggleTheme(e){e?(document.documentElement.classList.add("dark"),themeToggleLightIcon.classList.remove("hidden"),themeToggleDarkIcon.classList.add("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")}),imagesLight.forEach(e=>{e.classList.add("hidden")})):(document.documentElement.classList.remove("dark"),themeToggleDarkIcon.classList.remove("hidden"),themeToggleLightIcon.classList.add("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")}),imagesDark.forEach(e=>{e.classList.add("hidden")}))}themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),event.altKey?(localStorage.removeItem("color-theme"),toggleTheme(window.matchMedia("(prefers-color-scheme: dark)").matches)):localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{if(localStorage.getItem("color-theme")===null){const t=e.matches?"dark":"light";toggleTheme(t==="dark")}})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2024 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+=" has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>