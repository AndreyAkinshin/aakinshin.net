<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.74.3"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Statistics,Quantile,Trimming,Harrell-Davis quantile estimator"><title>Trimmed modification of the Harrell-Davis quantile estimator | Andrey Akinshin</title><meta name=description content="A modified version of the Harrell-Davis quantile estimator with better robustness"><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=/css/lumen-bootstrap.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/slate-bootstrap.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><link href=/css/syntax-light.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/syntax-dark.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.26d61b7027fe55e642f0001cef94cb75b567d721086492aab6b4e32d9ee7811d.js></script><script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.882998740b9c4c24677576b997bde5a487246e2e3bd72128a0e922eaa59db029.mjs></script><link href=https://aakinshin.net/css/fontawesome-all.min.50da8736f05b35aac9691de67fe993cbe01b7d88fcf0cb682c3a8f39933fe4a3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.2a76db7cc14055b3bafacc363f453917ab54a818a7db2a0a9b2409c0f6bf07c5.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.ae812fc71daf5160d927febda5a991cee6c361345e3f685d3736931ed7537986.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVB6MXSX32"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-ZVB6MXSX32');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-41419012-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-41419012-5');</script><script type=text/javascript>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym");ym(28700916,"init",{clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src=https://mc.yandex.ru/watch/28700916 style=position:absolute;left:-9999px alt></div></noscript><script src=/js/jquery-3.3.1.slim.min.js></script></head><body><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class=nav-item><a class=nav-link id=nav-link-posts href=https://aakinshin.net/posts/>Posts</a></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li><li class=nav-item><a class=nav-link id=nav-link-pdnb href=https://aakinshin.net/prodotnetbenchmarking/>Pro .NET Benchmarking</a></li></ul><ul class="navbar-nav ml-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>Trimmed modification of the Harrell-Davis quantile estimator</h1><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2021-03-30>March 30, 2021</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/statistics/ class="badge badge-info">Statistics</a>
<a href=https://aakinshin.net/tags/quantile/ class="badge badge-info">Quantile</a>
<a href=https://aakinshin.net/tags/trimming/ class="badge badge-info">Trimming</a>
<a href=https://aakinshin.net/tags/harrell-davis-quantile-estimator/ class="badge badge-info">Harrell-Davis quantile estimator</a></span><br><br><p>In one of <a href=https://aakinshin.net/posts/winsorized-hdqe/>the previous posts</a>, I discussed winsorized Harrell-Davis quantile estimator.
This estimator is more robust than the classic Harrell-Davis quantile estimator.
In this post, I want to suggest another modification that may be better for some corner cases:
the <em>trimmed</em> Harrell-Davis quantile estimator.</p><h3 id=winsorizing>Winsorizing</h3><p>I already discussed
winsorization of the Harrell-Davis quantile estimator in detail in my <a href=https://aakinshin.net/posts/winsorized-hdqe/>previous post</a>.
Let&rsquo;s briefly recall the main idea.
For sample <span class="math inline">\(x = \{ x_1, x_2, \ldots, x_n \}\)</span>,
the Harrell-Davis quantile estimator (<a href=#Harrell1982>[Harrell1982]</a>)
estimates the <span class="math inline">\(p^\textrm{th}\)</span> quantile using the following equation:</p><p><span class="math display">\[Q_{HD}(p) = \sum_{i=1}^{n} W_{i} \cdot x_{(i)}, \quad
W_{i} = I_{i/n}(a, b) - I_{(i-1)/n}(a, b), \quad
a = p(n+1),\; b = (1-p)(n+1)
\]</span></p><p>where
<span class="math inline">\(I_t(a, b)\)</span> denotes the regularized incomplete beta function,
<span class="math inline">\(x_{(i)}\)</span> is the <span class="math inline">\(i^\textrm{th}\)</span> order statistic.</p><p>This approach is quite effective (you can find relevant simulations <a href=https://aakinshin.net/posts/hdqe-efficiency/>here</a>).
Unfortunately, it&rsquo;s not robust because it&rsquo;s a sum of <em>all</em> order statistics with positive weights.
The breakdown point of such a metric is zero:
a single outlier may corrupt the estimation of any quantile.</p><p>Now let&rsquo;s look at an example.
Here is the probability density function plot of the beta distribution for <span class="math inline">\(n = 20, p = 0.2\)</span>:</p><div class=row><div class=mx-auto><a href=/posts/trimmed-hdqe/img/beta-light.png target=_blank class=imgldlink alt=beta><picture>
<source theme=dark srcset=/posts/trimmed-hdqe/img/beta-dark.png media="(prefers-color-scheme: dark)"><source theme=light srcset=/posts/trimmed-hdqe/img/beta-light.png media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><img class="mx-auto d-block img-fluid" width=800 src=/posts/trimmed-hdqe/img/beta-light.png></picture></a></div></div><br><p>Blue vertical lines split the plot into 20 fragments.
The value of <span class="math inline">\(W_i\)</span> is the area of <span class="math inline">\(i^\textrm{th}\)</span> fragment.
As you can see, half of the fragments have tiny areas which are close to zero.
Meanwhile, these fragments are also the reason of the zero breakdown point.
Thus, we have the following situation:</p><ul><li>If there are no extreme values,
tiny fragments don&rsquo;t produce a noticeable contribution to the estimation value.</li><li>If there are extreme values,
tiny fragments may corrupt the estimation value because their areas are actually positive.</li></ul><p>Therefore, such tiny fragments don&rsquo;t improve efficiency and reduce robustness.
Moreover, they noticeably slow down numerical calculation because
it takes some time to evaluate all values of the regularized incomplete beta function.
So, what&rsquo;s the point of including such fragments in the calculations?
Let&rsquo;s get rid of them!
We can consider two strategies of eliminating tiny fragments.</p><p>The first strategy is winsorization which I suggested in <a href=https://aakinshin.net/posts/winsorized-hdqe/>the previous posts</a>.
The idea is pretty simple.
Let&rsquo;s find the k% highest density interval (e.g., we can consider k=95 or k=99).
Next, we find all the fragments that overlap with this interval.
Let&rsquo;s say such fragments have indexes from <span class="math inline">\(l\)</span> to <span class="math inline">\(r\)</span>.
The winsorization assumes that we
replace all values between <span class="math inline">\(1\)</span> and <span class="math inline">\(l-1\)</span> by <span class="math inline">\(x_{(l)}\)</span> and
replace all values between <span class="math inline">\(r+1\)</span> and <span class="math inline">\(n\)</span> by <span class="math inline">\(x_{(r)}\)</span>.
Here is the final equation for the winsorized Harrell-Davis (WHD) quantile estimator:</p><p><span class="math display">\[Q_{WHD}(p) =
\sum_{i=1}^{l-1} W_i \cdot x_{(l)} +
\sum_{i=l}^{r} W_i \cdot x_{(i)} +
\sum_{i=r+1}^{n} W_i \cdot x_{(r)}.
\]</span></p><p>Thus, if we have outliers outside the <span class="math inline">\([l..r]\)</span> interval, they won&rsquo;t corrupt the quantile estimation.
The same trick could be applied to the
<a href=https://aakinshin.net/posts/weighted-quantiles-ci//#the-maritz-jarrett-method>Maritz-Jarrett method</a> (<a href=#Maritz1979>[Maritz1979]</a>)
to estimate corresponding winsorized quantile confidence interval.</p><h3 id=trimming>Trimming</h3><p>Trimming is very similar to winsorizing with two differences:</p><ul><li>Instead of replacing <span class="math inline">\(x_{(i)}\)</span> outside the <span class="math inline">\([l..r]\)</span> interval, we should eliminate them.</li><li>Since the sum of all weights should be equal to one, we should normalize <span class="math inline">\(W_i\)</span> values.</li></ul><p>Here is the final equation for the trimmed Harrell-Davis (THD) quantile estimator:</p><p><span class="math display">\[Q_{THD}(p) =
\dfrac{1}{\sum_{i=l}^{r} W_i}
\sum_{i=l}^{r} W_i \cdot x_{(i)}.
\]</span></p><p>In most cases, winsorized and trimmed modifications provide similar results.
We can observe a noticeable difference between them when <span class="math inline">\(x_{(l)}\)</span> or <span class="math inline">\(x_{(r)}\)</span> is an outlier.
In this case, the trimmed modification seems to be more efficient because it assigns lower weight to the extreme value.
I&rsquo;m going to share some numerical experiments related to
the efficiency of both modifications in our of my future blog posts.</p><h3 id=reference-implementation>Reference implementation</h3><p>The C# reference implementation can be found in
the latest nightly version (0.3.0-nightly.92+) of <a href=https://github.com/AndreyAkinshin/perfolizer>Perfolizer</a>
(you need <code>TrimmedHarrellDavisQuantileEstimator</code>).</p><h3 id=references>References</h3><ul><li><b id=Harrell1982>[Harrell1982]</b><br>Harrell, F.E. and Davis, C.E., 1982. A new distribution-free quantile estimator.
<em>Biometrika</em>, 69(3), pp.635-640.<br><a href=https://doi.org/10.2307/2335999>https://doi.org/10.2307/2335999</a></li><li><b id=Maritz1979>[Maritz1979]</b><br>Maritz, J. S., and R. G. Jarrett. 1978.
“A Note on Estimating the Variance of the Sample Median.”
Journal of the American Statistical Association 73 (361): 194–196.<br><a href=https://doi.org/10.1080/01621459.1978.10480027>https://doi.org/10.1080/01621459.1978.10480027</a></li></ul><br><br><div class=row><div class="mx-auto share-block"><div class=share-title>Share:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2ftrimmed-hdqe%2f&title=Trimmed%20modification%20of%20the%20Harrell-Davis%20quantile%20estimator" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=Trimmed%20modification%20of%20the%20Harrell-Davis%20quantile%20estimator&url=https%3a%2f%2faakinshin.net%2fposts%2ftrimmed-hdqe%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2ftrimmed-hdqe%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://facebook.com/sharer.php?u=https%3a%2f%2faakinshin.net%2fposts%2ftrimmed-hdqe%2f" rel=nofollow target=_blank title="Share on Facebook"><i class="fab fa-facebook fa-2x"></i></a></div><div class=share-button><a href="http://vk.com/share.php?url=https%3a%2f%2faakinshin.net%2fposts%2ftrimmed-hdqe%2f" target=_blank title="Share on VKontakte"><i class="fab fa-vk fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2ftrimmed-hdqe%2f&title=Trimmed%20modification%20of%20the%20Harrell-Davis%20quantile%20estimator" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class=blog-footer><div class=container><p>&copy; 2013–2021 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub></i></a><a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter></i></a><a href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS></i></a>|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.082780cb948cc57eabbc0d80172a7a5347d5572b599938b4c9876dfd7978b424.js></script><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/anchor.min.js></script><script src=https://aakinshin.net/js/custom.min.11932490dde776463ed165b345838c701accc0cfdedf2e0868f13415f41f0872.js></script><script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:true,processEnvironments:true,},options:{skipHtmlTags:['script','noscript','style','textarea','pre'],ignoreHtmlClass:'tex2jax_ignore',processHtmlClass:'tex2jax_process'}};</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></body></html>