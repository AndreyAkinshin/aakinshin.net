<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content=".NET,C#,Rider,Mono,.NET Core"><title>How Sorting Order Depends on Runtime and Operating System | Andrey Akinshin</title><meta name=description content="This blog post was originally posted on JetBrains .NET blog.
In Rider, we have unit tests that enumerate files in your project and dump a sorted list of th..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.00b1604219597584f1a9abe4b2d4de199357afca35ce8637e05eff220ee75867.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>How Sorting Order Depends on Runtime and Operating System</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2020-05-13>May 13, 2020</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a>
<a class=label-link href=https://aakinshin.net/tags/mono/>Mono</a>
<a class=label-link href=https://aakinshin.net/tags/netcore/>.NET Core</a></div></div><br><div class=main-content><p><em>This blog post was <a href=https://blog.jetbrains.com/dotnet/2020/05/13/sorting-order-depends-runtime-operating-system/>originally posted</a> on <a href=https://blog.jetbrains.com/dotnet/>JetBrains .NET blog</a>.</em></p><p>In <a href=https://www.jetbrains.com/rider/>Rider</a>, we have unit tests that enumerate files in your project and dump a sorted list of these files. In one of our test projects, we had the following files: <code>jquery-1.4.1.js</code>, <code>jquery-1.4.1.min.js</code>, <code>jquery-1.4.1-vsdoc.js</code>. On Windows, .NET Framework, .NET Core, and Mono produce the same sorted list:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jquery-1.4.1.js
</span></span><span class=line><span class=cl>jquery-1.4.1.min.js
</span></span><span class=line><span class=cl>jquery-1.4.1-vsdoc.js
</span></span></code></pre></div><p>On Unix, Mono also produces the same list, so we had a consistent list of files across all environments. However, once we migrated to .NET Core, we discovered that the sorting order had changed to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>jquery-1.4.1-vsdoc.js
</span></span><span class=line><span class=cl>jquery-1.4.1.js
</span></span><span class=line><span class=cl>jquery-1.4.1.min.js
</span></span></code></pre></div><p>After a quick investigation, we realized that the problem was related to the <code>.</code> and <code>-</code> symbols. The example above can be simplified to the following minimal repro:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>list</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=p>{</span> <span class=s>&#34;a.b&#34;</span><span class=p>,</span> <span class=s>&#34;a-b&#34;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Join</span><span class=p>(</span><span class=s>&#34; &#34;</span><span class=p>,</span> <span class=n>list</span><span class=p>.</span><span class=n>OrderBy</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>)));</span>
</span></span></code></pre></div><p>.NET Framework, Mono, and .NET Core+Windows print <code>a.b a-b</code> to the output. However, .NET Core on Unix thinks that <code>a-b</code> is smaller than <code>a.b</code>, and prints <code>a-b a.b</code>. Thus, the sorting order depends on the runtime and operating system that you use.
In our codebase, we fixed this problem with the help of <code>StringComparer.Ordinal</code>. Instead of <code>list.OrderBy(x => x)</code>, in the example above we would write <code>list.OrderBy(x => x, StringComparer.Ordinal)</code>. This guarantees a consistent string order that doesn&rsquo;t depend on the environment.
We also started to wonder about the other kinds of string sorting &ldquo;phenomena&rdquo; we might find by switching between runtimes and operating systems. Let&rsquo;s find out!</p><h2><strong>Collecting more data</strong></h2>We took a simple set of characters <code>.-'!a</code> and built all possible two-character combinations from them:<div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>chars</span> <span class=p>=</span> <span class=s>&#34;.-&#39;!a&#34;</span><span class=p>.</span><span class=n>ToCharArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>strings</span> <span class=p>=</span> <span class=k>new</span> <span class=n>List</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>chars</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=n>chars</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>j</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=n>strings</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>chars</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>ToString</span><span class=p>()</span> <span class=p>+</span> <span class=n>chars</span><span class=p>[</span><span class=n>j</span><span class=p>]);</span>
</span></span></code></pre></div><p>Next, we compared these combinations to each other on different combinations of runtimes (.NET Framework, .NET Core, Mono) and operating systems (Windows, Linux, macOS):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>writer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StreamWriter</span><span class=p>(</span><span class=n>filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>a</span> <span class=k>in</span> <span class=n>strings</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>b</span> <span class=k>in</span> <span class=n>strings</span><span class=p>)</span>
</span></span><span class=line><span class=cl>             <span class=n>writer</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=n>CompareTo</span><span class=p>(</span><span class=n>b</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We discovered three different cases in which the <code>CompareTo</code> results are not consistent. To illustrate them, we took 4 string pairs from each group and built the following diagram for you:</p><div class=row><div class=mx-auto><a href=/posts/how-sorting-order-depends-on-runtime-and-operating-system/img/dotnet-SortingTable-blog.png target=_blank alt=dotnet-SortingTable-blog><img class="mx-auto d-block img-fluid" width=800 src=/posts/how-sorting-order-depends-on-runtime-and-operating-system/img/dotnet-SortingTable-blog.png></a></div></div><br><p>In the <a href=https://blog.jetbrains.com/dotnet/2020/04/27/socket-error-codes-depend-runtime-operating-system/>previous post</a> where we discussed socket implementations in different environments, we showed the source code for all relevant cases. This time, we suggest you do this exercise yourself. Try digging into the source code of all runtimes to find explanations for the above picture. For a bonus challenge, do your own experiments with <code>CultureInfo.CurrentCulture</code> and learn more about how the sorting order depends on the system locale. It would be great if you could share your findings with the community! To give you further inspiration for this kind of research, we want to show you a few more interesting facts.</p><h2><strong>More tricky cases</strong></h2>Sorting order can be pretty tricky, even if you are only working within one environment. A great example of unexpected behavior can be found in this StackOverflow <a href=https://stackoverflow.com/q/2244480/184842>question</a>, where developers discuss the following code snippet:<div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=s>&#34;+&#34;</span><span class=p>.</span><span class=n>CompareTo</span><span class=p>(</span><span class=s>&#34;-&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Returns</span><span class=p>:</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s>&#34;+1&#34;</span><span class=p>.</span><span class=n>CompareTo</span><span class=p>(</span><span class=s>&#34;-1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Returns</span><span class=p>:</span> <span class=p>-</span><span class=m>1</span>
</span></span></code></pre></div><p>As you can see, <code>"+"</code> is greater than <code>"-"</code> while <code>"+1"</code> is lesser than <code>"-1"</code>. The <a href=https://stackoverflow.com/a/2244615/184842>best answer</a> quotes the following paragraph from Microsoft Docs:</p><blockquote>The comparison uses the current culture to obtain culture-specific information such as casing rules and the alphabetic order of individual characters.
For example, a culture could specify that certain combinations of characters be treated as a single character, or uppercase and lowercase characters be compared in a particular way, or that the sorting order of a character depends on the characters that precede or follow it.</blockquote>If we continue to read the documentation, we will see that there are overloads of <code>string.Compare</code> that take <code>System.Globalization.CompareOptions </code>as one of the arguments. Here is the most common overload:<div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=kt>int</span> <span class=n>Compare</span><span class=p>(</span><span class=kt>string</span> <span class=n>strA</span><span class=p>,</span> <span class=kt>string</span> <span class=n>strB</span><span class=p>,</span> <span class=n>CultureInfo</span> <span class=n>culture</span><span class=p>,</span> <span class=n>CompareOptions</span> <span class=n>options</span><span class=p>);</span>
</span></span></code></pre></div><p>The <a href=https://docs.microsoft.com/en-us/dotnet/api/system.globalization.compareoptions>CompareOptions</a> flag enum defines the string comparison rules. Here are the most interesting values:</p><ul><li><strong>IgnoreKanaType:</strong> Indicates that the string comparison must ignore the Kana type. Kana type refers to Japanese hiragana and katakana characters, which represent phonetic sounds in the Japanese language. Hiragana is used for native Japanese expressions and words, while katakana is used for words borrowed from other languages, such as "computer" or "Internet". A phonetic sound can be expressed in both hiragana and katakana. If this value is selected, the hiragana character for one sound is considered equal to the katakana character for the same sound.</li><li><strong>IgnoreNonSpace:</strong> Indicates that the string comparison must ignore non-spacing combining characters, such as diacritics. The Unicode Standard defines combining characters as characters that are combined with base characters to produce a new character. Non-spacing combining characters do not occupy a spacing position by themselves when rendered.</li><li><strong>IgnoreSymbols:</strong> Indicates that the string comparison must ignore symbols, such as white-space characters, punctuation, currency symbols, the percent sign, mathematical symbols, the ampersand, and so on.</li><li><strong>IgnoreWidth</strong>: Indicates that the string comparison must ignore character width. For example, Japanese katakana characters can be written as full-width or half-width. If this value is selected, the katakana characters written as full-width are considered equal to the same characters written as half-width.</li><li><strong>Ordinal:</strong> Indicates that the string comparison must use the successive Unicode UTF-16 encoded values of the string (code unit by code unit comparison), leading to a fast comparison, but one that is culture-insensitive. A string starting with a code unit XXXX16 comes before a string starting with YYYY16, if XXXX16 is less than YYYY16. This value cannot be combined with other CompareOptions values and must be used alone.</li><li><strong>StringSort:</strong> Indicates that the string comparison must use the string sort algorithm. In a string sort, the hyphen and the apostrophe, as well as other non-alphanumeric symbols, come before alphanumeric characters.</li></ul>Try to play with these values, and find examples of string lists that can be sorted differently depending on the above flags. This kind of experiment is a great way to learn more about runtime and to become more aware of pitfalls related to string sorting.
This is not the end of our adventure, however. There is one more global option that can completely change the behavior of string comparison!<h2><strong>Globalization invariant mode</strong></h2>In .NET Core 2.0+, there is a feature called <em>Globalization invariant mode</em>, which uses the <code>Ordinal</code> sorting rule for all string comparisons by default. It can be enabled if you set the <code>DOTNET_SYSTEM_GLOBALIZATION_INVARIANT</code> environment variable to <code>true</code> or <code>1</code>. Let's enable this mode and run examples from the previous section:<div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Compare</span><span class=p>(</span><span class=s>&#34;-&#34;</span><span class=p>,</span> <span class=s>&#34;+&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Compare</span><span class=p>(</span><span class=s>&#34;-x&#34;</span><span class=p>,</span> <span class=s>&#34;+x&#34;</span><span class=p>));</span>
</span></span></code></pre></div><p>Now it prints a new result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>2
</span></span><span class=line><span class=cl>2
</span></span></code></pre></div><p>Some developers may think that it&rsquo;s a good idea to always enable this by default to avoid problems with inconsistent sorting. Note that in this mode, you will get poor globalization support: a lot of features will be affected, including all <code>CultureInfo</code>-specific logic, string operations, internationalized domain names (IDN) support, and even time zone display names on Linux. If you want to enable it, carefully read the <a href=https://github.com/dotnet/runtime/blob/master/docs/design/features/globalization-invariant-mode.md>documentation</a> first.
It&rsquo;s worth mentioning that if you don&rsquo;t control the environment of your application, there is a chance that users will enable it manually. This could significantly affect any .NET Core application!</p><h2><strong>Conclusion</strong></h2>Here are a few practical recommendations that can help you avoid tricky and painful bugs in the future:<ul><li>If you want to achieve consistent string comparison across different runtimes and operating systems, always use <code>StringComparer.Ordinal</code>.</li><li>If you don't use <code>StringComparer.Ordinal</code>, always keep in mind that the sorting order may depend on runtime, operating system, current culture, and environment variables.</li><li>Try to do your own experiments and learn more about sorting rules in .NET. This time we decided to leave out the detailed explanations and instead encourage you to explore them for yourself. After all, this is the best way to learn something new and improve your programming skills!</li></ul></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fhow-sorting-order-depends-on-runtime-and-operating-system%2f&title=How%20Sorting%20Order%20Depends%20on%20Runtime%20and%20Operating%20System" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=How%20Sorting%20Order%20Depends%20on%20Runtime%20and%20Operating%20System&url=https%3a%2f%2faakinshin.net%2fposts%2fhow-sorting-order-depends-on-runtime-and-operating-system%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fhow-sorting-order-depends-on-runtime-and-operating-system%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fhow-sorting-order-depends-on-runtime-and-operating-system%2f&title=How%20Sorting%20Order%20Depends%20on%20Runtime%20and%20Operating%20System" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2022 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer></body></html>