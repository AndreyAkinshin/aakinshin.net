<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.74.3"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Statistics"><title>Middle non-zero quantile absolute deviation, Part 2 | Andrey Akinshin</title><meta name=description content="In one of the previous posts, I described the idea of the middle non-zero quantile absolute deviation. It&amp;rsquo;s defined as follows:
\[\operatorname{MNZQA..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=/css/lumen-bootstrap.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/slate-bootstrap.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><link href=/css/syntax-light.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/syntax-dark.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.26d61b7027fe55e642f0001cef94cb75b567d721086492aab6b4e32d9ee7811d.js></script><script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.882998740b9c4c24677576b997bde5a487246e2e3bd72128a0e922eaa59db029.mjs></script><link href=https://aakinshin.net/css/fontawesome-all.min.50da8736f05b35aac9691de67fe993cbe01b7d88fcf0cb682c3a8f39933fe4a3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.2a76db7cc14055b3bafacc363f453917ab54a818a7db2a0a9b2409c0f6bf07c5.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.b7c11be17efd31d4852ff062694551596a7625c992103c0605c98f85d6569f11.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVB6MXSX32"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-ZVB6MXSX32');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-41419012-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-41419012-5');</script><script type=text/javascript>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym");ym(28700916,"init",{clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src=https://mc.yandex.ru/watch/28700916 style=position:absolute;left:-9999px alt></div></noscript><script src=/js/jquery-3.3.1.slim.min.js></script></head><body><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class=nav-item><a class=nav-link id=nav-link-posts href=https://aakinshin.net/posts/>Posts</a></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li><li class=nav-item><a class=nav-link id=nav-link-pdnb href=https://aakinshin.net/prodotnetbenchmarking/>Pro .NET Benchmarking</a></li></ul><ul class="navbar-nav ml-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class="blog-post table-sm"><h1 class=blog-post-title id=post-title>Middle non-zero quantile absolute deviation, Part 2</h1><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2022-06-28>June 28, 2022</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/statistics/ class="badge badge-info">Statistics</a></span><br><br><p>In one of the previous posts, I <a href=https://aakinshin.net/posts/mnzqad/>described</a> the idea of the
middle non-zero quantile absolute deviation.
It&rsquo;s defined as follows:</p><p><span class="math display">\[\operatorname{MNZQAD}(x, p) = \operatorname{QAD}(x, p, q_m),
\]</span></p><p><span class="math display">\[q_m = \frac{q_0 + 1}{2}, \quad
q_0 = \frac{\max(k - 1, 0)}{n - 1}, \quad
k = \sum_{i=1}^n \mathbf{1}_{Q(x, p)}(x_i),
\]</span></p><p>where <span class="math inline">\(\mathbf{1}\)</span> is the indicator function</p><p><span class="math display">\[\mathbf{1}_U(u) = \begin{cases}
1 & \textrm{if}\quad  u = U,\\
0 & \textrm{if}\quad u \neq U,
\end{cases}
\]</span></p><p>and <span class="math inline">\(\operatorname{QAD}\)</span> is the <a href=https://aakinshin.net/posts/qad/>quantile absolute deviation</a></p><p><span class="math display">\[\operatorname{QAD}(x, p, q) = Q(|x - Q(x, p)|, q).
\]</span></p><p>The <span class="math inline">\(\operatorname{MNZQAD}\)</span> approach tries to work around a problem with tied values.
While it works well in the generic case, there are some corner cases
where the suggested metric behaves poorly.
In this post, we discuss this problem and how to solve it.</p><h3 id=the-problem>The problem</h3><p>Let&rsquo;s take 20 samples of size 1000 from the
<a href=https://en.wikipedia.org/wiki/Rectified_Gaussian_distribution>rectified Gaussian distribution</a>
and calculate <span class="math inline">\(\operatorname{MNZQAD}\)</span> around the median for each of them.
It could be done using the following R snippet:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>qad</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=m>0.5</span><span class=p>,</span> <span class=n>q</span> <span class=o>=</span> <span class=m>0.5</span><span class=p>)</span> <span class=nf>as.numeric</span><span class=p>(</span><span class=nf>quantile</span><span class=p>(</span><span class=nf>abs</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=nf>quantile</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span><span class=p>)),</span> <span class=n>q</span><span class=p>))</span>
<span class=n>mnzqad</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=m>0.5</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>n</span> <span class=o>&lt;-</span> <span class=nf>length</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
  <span class=n>anchor</span> <span class=o>&lt;-</span> <span class=nf>quantile</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
  <span class=n>k</span> <span class=o>&lt;-</span> <span class=nf>sum</span><span class=p>(</span><span class=nf>abs</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>anchor</span><span class=p>)</span> <span class=o>&lt;</span> <span class=m>1e-9</span><span class=p>)</span>
  <span class=n>q0</span> <span class=o>&lt;-</span> <span class=nf>max</span><span class=p>(</span><span class=n>k</span> <span class=o>-</span> <span class=m>1</span><span class=p>,</span> <span class=m>0</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=m>1</span><span class=p>)</span>
  <span class=n>qm</span> <span class=o>&lt;-</span> <span class=p>(</span><span class=n>q0</span> <span class=o>+</span> <span class=m>1</span><span class=p>)</span> <span class=o>/</span> <span class=m>2</span>
  <span class=nf>qad</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=m>0.5</span><span class=p>,</span> <span class=n>qm</span><span class=p>)</span>
<span class=p>}</span>
<span class=n>rrnorm</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>sd</span> <span class=o>=</span> <span class=m>1</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>x</span> <span class=o>&lt;-</span> <span class=nf>rnorm</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>sd</span> <span class=o>=</span> <span class=n>sd</span><span class=p>)</span>
  <span class=n>x[x</span> <span class=o>&lt;</span> <span class=m>0</span><span class=n>]</span> <span class=o>&lt;-</span> <span class=m>0</span>
  <span class=n>x</span>
<span class=p>}</span>
<span class=nf>set.seed</span><span class=p>(</span><span class=m>1729</span><span class=p>)</span>
<span class=nf>replicate</span><span class=p>(</span><span class=m>20</span><span class=p>,</span> <span class=nf>mnzqad</span><span class=p>(</span><span class=nf>rrnorm</span><span class=p>(</span><span class=m>1000</span><span class=p>)))</span>
</code></pre></div><p>And here is the result:</p><div class=highlight><pre class=chroma><code class=language-txt data-lang=txt>0.6708304 0.0626490 0.6283213 0.6484299 0.0139355
0.6640861 0.0068413 0.0229421 0.5961456 0.6814358
0.6744908 0.6451489 0.6804007 0.0602365 0.7027132
0.6503397 0.0025354 0.0349211 0.0158567 0.0105813
</code></pre></div><p>As we can see, the results are not stable.
Sometimes we have small values (like 0.007), and sometimes we have large values (like 0.703).
The underlying problem is quite simple.
If the number of zero values in the sample is larger than 500,
the median is exactly zero,
and the number of median-tied values <span class="math inline">\(k\)</span> is around 500.
It leads to evaluating the <span class="math inline">\(0.75^\textrm{th}\)</span> quantile (<span class="math inline">\(q_m \approx 0.75\)</span>).
If the number of zero values in the sample is smaller than 500,
the median is non-zero,
and the number of median-tied values <span class="math inline">\(k\)</span> is zero.
It leads to evaluating the <span class="math inline">\(0.50^\textrm{th}\)</span> quantile (<span class="math inline">\(q_m \approx 0.50\)</span>).</p><h3 id=the-solution>The solution</h3><p>One of the ideas I have is about counting the total number of tied values in the sample
instead of only median-tied values.
It makes <span class="math inline">\(k\)</span> much more stable in corner cases like the one above.
Here is the updated R snippet:</p><div class=highlight><pre class=chroma><code class=language-r data-lang=r><span class=n>mnzqad2</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=m>0.5</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>n</span> <span class=o>&lt;-</span> <span class=nf>length</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
  <span class=n>anchor</span> <span class=o>&lt;-</span> <span class=nf>quantile</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
  <span class=n>k</span> <span class=o>&lt;-</span> <span class=n>n</span> <span class=o>-</span> <span class=nf>sum</span><span class=p>(</span><span class=nf>table</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>==</span> <span class=m>1</span><span class=p>)</span>
  <span class=n>q0</span> <span class=o>&lt;-</span> <span class=nf>max</span><span class=p>(</span><span class=n>k</span> <span class=o>-</span> <span class=m>1</span><span class=p>,</span> <span class=m>0</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=m>1</span><span class=p>)</span>
  <span class=n>qm</span> <span class=o>&lt;-</span> <span class=p>(</span><span class=n>q0</span> <span class=o>+</span> <span class=m>1</span><span class=p>)</span> <span class=o>/</span> <span class=m>2</span>
  <span class=nf>qad</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=m>0.5</span><span class=p>,</span> <span class=n>qm</span><span class=p>)</span>
<span class=p>}</span>
<span class=nf>set.seed</span><span class=p>(</span><span class=m>1729</span><span class=p>)</span>
<span class=nf>replicate</span><span class=p>(</span><span class=m>20</span><span class=p>,</span> <span class=nf>mnzqad2</span><span class=p>(</span><span class=nf>rrnorm</span><span class=p>(</span><span class=m>1000</span><span class=p>)))</span>
</code></pre></div><p>And here is the updated result:</p><div class=highlight><pre class=chroma><code class=language-txt data-lang=txt>0.6708304 0.6329019 0.6283213 0.6484299 0.7578973
0.6640861 0.6207138 0.6284881 0.5961456 0.6814358
0.6744908 0.6451489 0.6804007 0.6067494 0.7027132
0.6503397 0.6441379 0.6970224 0.6400928 0.6438555
</code></pre></div><p>As we can see, the new version of <span class="math inline">\(\operatorname{MNZQAD}\)</span> is much more stable
than the originally proposed version.</p><br><br><div class=row><div class="mx-auto share-block"><div class=share-title>Share:</div><div class=share-button><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fmnzqad2%2f&title=Middle%20non-zero%20quantile%20absolute%20deviation%2c%20Part%202" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a></div><div class=share-button><a href="https://twitter.com/intent/tweet?text=Middle%20non-zero%20quantile%20absolute%20deviation%2c%20Part%202&url=https%3a%2f%2faakinshin.net%2fposts%2fmnzqad2%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><i class="fab fa-twitter fa-2x"></i></a></div><div class=share-button><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fmnzqad2%2f" target=_blank title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a></div><div class=share-button><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fmnzqad2%2f&title=Middle%20non-zero%20quantile%20absolute%20deviation%2c%20Part%202" target=_blank title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a></div></div></div></div><hr></div></div></main></div><footer class=blog-footer><div class=container><p>&copy; 2013&mdash;2022 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub></i></a><a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter></i></a><a href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS></i></a>|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.082780cb948cc57eabbc0d80172a7a5347d5572b599938b4c9876dfd7978b424.js></script><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/anchor.min.js></script><script src=https://aakinshin.net/js/custom.min.11932490dde776463ed165b345838c701accc0cfdedf2e0868f13415f41f0872.js></script><script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:true,processEnvironments:true,},options:{skipHtmlTags:['script','noscript','style','textarea','pre'],ignoreHtmlClass:'tex2jax_ignore',processHtmlClass:'tex2jax_process'}};</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></body></html>