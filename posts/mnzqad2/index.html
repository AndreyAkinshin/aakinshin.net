<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Mathematics,Statistics,Research,Research: Quantile absolute deviation"><title>Middle non-zero quantile absolute deviation, Part 2 | Andrey Akinshin</title><meta name=description content="In one of the previous posts, I described the idea of the middle non-zero quantile absolute deviation. It&amp;rsquo;s defined as follows:
\[\operatorname{MNZQA..."><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.c7d578d6f644d60facb46dc3020d6ba03c3271003667b8b375b069810f11fc69.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Middle non-zero quantile absolute deviation, Part 2</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2022-06-28>June 28, 2022</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/mathematics/>Mathematics</a>
<a class=label-link href=https://aakinshin.net/tags/statistics/>Statistics</a>
<a class=label-link href=https://aakinshin.net/tags/research/>Research</a>
<a class=label-link href=https://aakinshin.net/tags/research-qad/>Research: Quantile absolute deviation</a></div></div><br><div class="main-content mb-3 px-2 py-1 rounded border text-alert-text-l border-alert-frame-l dark:text-alert-text-d dark:border-alert-frame-d">Update: this blog post is a part of research that aimed to build a new measure of statistical dispersion called quantile absolute deviation. A <a href=/posts/preprint-qad/>preprint with final results</a> is available on arXiv: <a href=https://arxiv.org/abs/2208.13459>arXiv:2208.13459 [stat.ME]</a>. Some information in this blog post can be obsolete: please, use the preprint as the primary reference.</div><div class=main-content><p>In one of the previous posts, I <a href=https://aakinshin.net/posts/mnzqad/>described</a> the idea of the
middle non-zero quantile absolute deviation.
It&rsquo;s defined as follows:</p><p><span class="math display">\[\operatorname{MNZQAD}(x, p) = \operatorname{QAD}(x, p, q_m),
\]</span></p><p><span class="math display">\[q_m = \frac{q_0 + 1}{2}, \quad
q_0 = \frac{\max(k - 1, 0)}{n - 1}, \quad
k = \sum_{i=1}^n \mathbf{1}_{Q(x, p)}(x_i),
\]</span></p><p>where <span class="math inline">\(\mathbf{1}\)</span> is the indicator function</p><p><span class="math display">\[\mathbf{1}_U(u) = \begin{cases}
1 & \textrm{if}\quad  u = U,\\
0 & \textrm{if}\quad u \neq U,
\end{cases}
\]</span></p><p>and <span class="math inline">\(\operatorname{QAD}\)</span> is the <a href=https://aakinshin.net/posts/qad/>quantile absolute deviation</a></p><p><span class="math display">\[\operatorname{QAD}(x, p, q) = Q(|x - Q(x, p)|, q).
\]</span></p><p>The <span class="math inline">\(\operatorname{MNZQAD}\)</span> approach tries to work around a problem with tied values.
While it works well in the generic case, there are some corner cases
where the suggested metric behaves poorly.
In this post, we discuss this problem and how to solve it.</p><h3 id=the-problem>The problem</h3><p>Let&rsquo;s take 20 samples of size 1000 from the
<a href=https://en.wikipedia.org/wiki/Rectified_Gaussian_distribution>rectified Gaussian distribution</a>
and calculate <span class="math inline">\(\operatorname{MNZQAD}\)</span> around the median for each of them.
It could be done using the following R snippet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-r data-lang=r><span class=line><span class=cl><span class=n>qad</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=m>0.5</span><span class=p>,</span> <span class=n>q</span> <span class=o>=</span> <span class=m>0.5</span><span class=p>)</span> <span class=nf>as.numeric</span><span class=p>(</span><span class=nf>quantile</span><span class=p>(</span><span class=nf>abs</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=nf>quantile</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span><span class=p>)),</span> <span class=n>q</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>mnzqad</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=m>0.5</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>n</span> <span class=o>&lt;-</span> <span class=nf>length</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>anchor</span> <span class=o>&lt;-</span> <span class=nf>quantile</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>k</span> <span class=o>&lt;-</span> <span class=nf>sum</span><span class=p>(</span><span class=nf>abs</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>anchor</span><span class=p>)</span> <span class=o>&lt;</span> <span class=m>1e-9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>q0</span> <span class=o>&lt;-</span> <span class=nf>max</span><span class=p>(</span><span class=n>k</span> <span class=o>-</span> <span class=m>1</span><span class=p>,</span> <span class=m>0</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>qm</span> <span class=o>&lt;-</span> <span class=p>(</span><span class=n>q0</span> <span class=o>+</span> <span class=m>1</span><span class=p>)</span> <span class=o>/</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>  <span class=nf>qad</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=m>0.5</span><span class=p>,</span> <span class=n>qm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>rrnorm</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>sd</span> <span class=o>=</span> <span class=m>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>x</span> <span class=o>&lt;-</span> <span class=nf>rnorm</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>sd</span> <span class=o>=</span> <span class=n>sd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>x[x</span> <span class=o>&lt;</span> <span class=m>0</span><span class=n>]</span> <span class=o>&lt;-</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=n>x</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>set.seed</span><span class=p>(</span><span class=m>1729</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>replicate</span><span class=p>(</span><span class=m>20</span><span class=p>,</span> <span class=nf>mnzqad</span><span class=p>(</span><span class=nf>rrnorm</span><span class=p>(</span><span class=m>1000</span><span class=p>)))</span>
</span></span></code></pre></div><p>And here is the result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>0.6708304 0.0626490 0.6283213 0.6484299 0.0139355
</span></span><span class=line><span class=cl>0.6640861 0.0068413 0.0229421 0.5961456 0.6814358
</span></span><span class=line><span class=cl>0.6744908 0.6451489 0.6804007 0.0602365 0.7027132
</span></span><span class=line><span class=cl>0.6503397 0.0025354 0.0349211 0.0158567 0.0105813
</span></span></code></pre></div><p>As we can see, the results are not stable.
Sometimes we have small values (like 0.007), and sometimes we have large values (like 0.703).
The underlying problem is quite simple.
If the number of zero values in the sample is larger than 500,
the median is exactly zero,
and the number of median-tied values <span class="math inline">\(k\)</span> is around 500.
It leads to evaluating the <span class="math inline">\(0.75^\textrm{th}\)</span> quantile (<span class="math inline">\(q_m \approx 0.75\)</span>).
If the number of zero values in the sample is smaller than 500,
the median is non-zero,
and the number of median-tied values <span class="math inline">\(k\)</span> is zero.
It leads to evaluating the <span class="math inline">\(0.50^\textrm{th}\)</span> quantile (<span class="math inline">\(q_m \approx 0.50\)</span>).</p><h3 id=the-solution>The solution</h3><p>One of the ideas I have is about counting the total number of tied values in the sample
instead of only median-tied values.
It makes <span class="math inline">\(k\)</span> much more stable in corner cases like the one above.
Here is the updated R snippet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-r data-lang=r><span class=line><span class=cl><span class=n>mnzqad2</span> <span class=o>&lt;-</span> <span class=nf>function</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=m>0.5</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>n</span> <span class=o>&lt;-</span> <span class=nf>length</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>anchor</span> <span class=o>&lt;-</span> <span class=nf>quantile</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>k</span> <span class=o>&lt;-</span> <span class=n>n</span> <span class=o>-</span> <span class=nf>sum</span><span class=p>(</span><span class=nf>table</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>==</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>q0</span> <span class=o>&lt;-</span> <span class=nf>max</span><span class=p>(</span><span class=n>k</span> <span class=o>-</span> <span class=m>1</span><span class=p>,</span> <span class=m>0</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>qm</span> <span class=o>&lt;-</span> <span class=p>(</span><span class=n>q0</span> <span class=o>+</span> <span class=m>1</span><span class=p>)</span> <span class=o>/</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>  <span class=nf>qad</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=m>0.5</span><span class=p>,</span> <span class=n>qm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>set.seed</span><span class=p>(</span><span class=m>1729</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>replicate</span><span class=p>(</span><span class=m>20</span><span class=p>,</span> <span class=nf>mnzqad2</span><span class=p>(</span><span class=nf>rrnorm</span><span class=p>(</span><span class=m>1000</span><span class=p>)))</span>
</span></span></code></pre></div><p>And here is the updated result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>0.6708304 0.6329019 0.6283213 0.6484299 0.7578973
</span></span><span class=line><span class=cl>0.6640861 0.6207138 0.6284881 0.5961456 0.6814358
</span></span><span class=line><span class=cl>0.6744908 0.6451489 0.6804007 0.6067494 0.7027132
</span></span><span class=line><span class=cl>0.6503397 0.6441379 0.6970224 0.6400928 0.6438555
</span></span></code></pre></div><p>As we can see, the new version of <span class="math inline">\(\operatorname{MNZQAD}\)</span> is much more stable
than the originally proposed version.</p></div><br><br><div class="flex flex-wrap justify-center items-center">The source code of this post and all the relevant files are&nbsp;<a href=https://github.com/AndreyAkinshin/aakinshin.net/tree/master/content/en/posts/2022/06/mnzqad2/index.md>available on GitHub</a>.</div><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fmnzqad2%2f&title=Middle%20non-zero%20quantile%20absolute%20deviation%2c%20Part%202" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=Middle%20non-zero%20quantile%20absolute%20deviation%2c%20Part%202&url=https%3a%2f%2faakinshin.net%2fposts%2fmnzqad2%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fmnzqad2%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fmnzqad2%2f&title=Middle%20non-zero%20quantile%20absolute%20deviation%2c%20Part%202" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>