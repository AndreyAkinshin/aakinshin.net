<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content="Mathematics,Statistics,Research,Quantile,Winsorizing,Harrell-Davis quantile estimator,Research: Building trimmed Harrell-Davis quantile estimator"><title>Winsorized modification of the Harrell-Davis quantile estimator | Andrey Akinshin</title><meta name=description content="A modified version of the Harrell-Davis quantile estimator with better robustness"><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script src=https://cdn.tailwindcss.com/3.2.4></script>
<script>tailwind.config={darkMode:"class"}</script><style type=text/tailwindcss>
    @layer base {
       
       
      body {
        @apply bg-white dark:bg-zinc-800;
        @apply text-black dark:text-gray-400;
      }
      nav {
        @apply bg-sky-800 dark:bg-zinc-900;
      }
      a {
        @apply text-sky-600 dark:text-white;
        @apply no-underline;
      }
      .main-content a:not(.label-link) {
        @apply hover:underline;
      }
      hr {
        @apply h-px my-3 border-0 bg-gray-300 dark:bg-gray-600;
      }
      h1, h2, h3, h4, h5, h6 {
        @apply leading-tight;
      }
      h1, h2, h3 {
        @apply text-4xl py-4;
      }
      h4 {
        @apply text-3xl py-3;
      }
      h5, h6 {
        @apply text-2xl py-2;
      }
      table {
        @apply border self-center mx-auto;
      }
      th, td {
        @apply border p-2
      }
      blockquote {
        @apply border-l-8 border-gray-300 bg-gray-100 dark:border-zinc-600 dark:bg-zinc-700;
        @apply ml-4 my-4 pl-4 py-2;
      }

       
      .main ul {
        @apply list-disc ml-10 my-2;
      }
      .main ol {
        @apply list-decimal ml-10 my-2;
      }
      .main p {
        @apply mb-3;
      }

       
      .label {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-gray-400 dark:border-gray-500;
      }
      .label-link {
        @apply mx-1 px-1 py-0.5;
        @apply rounded border border-sky-600 dark:border-slate-400;
        @apply hover:bg-sky-200 dark:hover:bg-gray-500;
      }
      .nav-item {
        @apply text-white hover:bg-sky-700 dark:hover:bg-gray-700;
      }

       
      .paginator {
        @apply flex flex-wrap justify-center mb-4;
      }
      .paginator .page-item {
        @apply inline-flex border rounded px-3 py-1;
      }
      .paginator .page-item:not(.active):not(.disabled) {
        @apply border-gray-400 dark:border-gray-400;
      }
      .paginator .page-item.active {
        @apply border-sky-600 dark:border-white;
      }
      .paginator .page-item.disabled {
        @apply bg-gray-50 dark:bg-gray-500 dark:border-gray-400;
      }
      .paginator .page-item.disabled a {
        @apply text-gray-400 dark:text-gray-400;
      }

       
      .anchorjs-link {
        transition: all .25s linear;
      }
      *:hover > .anchorjs-link {
        margin-left: -1.125em !important;
      }

       
      .block-example {
        margin-top: 10px;
        margin-bottom: 10px;
      
        margin-left: 10px;
        padding-left: 10px;
      
        border-left: 5px solid;
        border-color: grey;
      }
      .block-example-title::before {  
        counter-increment: example;
        content: "Example " counter(example);
      }
      body {
        counter-reset: example;
      }

       
      #about-profiles svg {
        margin-right: 0.7rem;
      }
      #about p, #about ul {
        margin-top: 0rem;
        margin-bottom: 0rem;
      }
      #about ol {
        @apply ml-10;
      }
      #about img {
        height: 18px;
        @apply inline-flex;
      }
      .about-compact p {
        text-indent: 20px !important;
        margin: 0 !important;
      }

       
      .d-none { display:none; }

       
      code.has-jax {
        -webkit-font-smoothing: antialiased;
        background: inherit !important;
        border: none !important;
        font-size: 100%;
      }

       
      .fai {
        @apply inline-flex;
        height: 1.2em;
        width: 1.2em;
        padding-right: 0.4em;
        fill: currentColor;
      }
      .fai-link {
        @apply hover:text-sky-400 dark:hover:text-blue-400;
      }
      .label-link .fai {
        @apply pl-1 pb-1;
        height: 1.5em;
        width: 1.5em;
      }

       
      .chroma {
        @apply my-5 overflow-y-scroll;
        border-radius: 3px;
        border: 1px solid #C3CCD0;
        padding: 0.5em;
      }
        .chroma { background-color: #ffffff }
        .chroma .x {  }
        .chroma .err { color: #a61717; background-color: #e3d2d2 }
        .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
        .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
        .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
        .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
        .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
        .chroma .k { color: #000000; font-weight: bold }
        .chroma .kc { color: #000000; font-weight: bold }
        .chroma .kd { color: #000000; font-weight: bold }
        .chroma .kn { color: #000000; font-weight: bold }
        .chroma .kp { color: #000000; font-weight: bold }
        .chroma .kr { color: #000000; font-weight: bold }
        .chroma .kt { color: #445588; font-weight: bold }
        .chroma .n {  }
        .chroma .na { color: #008080 }
        .chroma .nb { color: #0086b3 }
        .chroma .bp { color: #999999 }
        .chroma .nc { color: #445588; font-weight: bold }
        .chroma .no { color: #008080 }
        .chroma .nd { color: #3c5d5d; font-weight: bold }
        .chroma .ni { color: #800080 }
        .chroma .ne { color: #990000; font-weight: bold }
        .chroma .nf { color: #990000; font-weight: bold }
        .chroma .fm {  }
        .chroma .nl { color: #990000; font-weight: bold }
        .chroma .nn { color: #555555 }
        .chroma .nx {  }
        .chroma .py {  }
        .chroma .nt { color: #000080 }
        .chroma .nv { color: #008080 }
        .chroma .vc { color: #008080 }
        .chroma .vg { color: #008080 }
        .chroma .vi { color: #008080 }
        .chroma .vm {  }
        .chroma .l {  }
        .chroma .ld {  }
        .chroma .s { color: #dd1144 }
        .chroma .sa { color: #dd1144 }
        .chroma .sb { color: #dd1144 }
        .chroma .sc { color: #dd1144 }
        .chroma .dl { color: #dd1144 }
        .chroma .sd { color: #dd1144 }
        .chroma .s2 { color: #dd1144 }
        .chroma .se { color: #dd1144 }
        .chroma .sh { color: #dd1144 }
        .chroma .si { color: #dd1144 }
        .chroma .sx { color: #dd1144 }
        .chroma .sr { color: #009926 }
        .chroma .s1 { color: #dd1144 }
        .chroma .ss { color: #990073 }
        .chroma .m { color: #009999 }
        .chroma .mb { color: #009999 }
        .chroma .mf { color: #009999 }
        .chroma .mh { color: #009999 }
        .chroma .mi { color: #009999 }
        .chroma .il { color: #009999 }
        .chroma .mo { color: #009999 }
        .chroma .o { color: #000000; font-weight: bold }
        .chroma .ow { color: #000000; font-weight: bold }
        .chroma .p {  }
        .chroma .c { color: #999988; font-style: italic }
        .chroma .ch { color: #999988; font-style: italic }
        .chroma .cm { color: #999988; font-style: italic }
        .chroma .c1 { color: #999988; font-style: italic }
        .chroma .cs { color: #999999; font-weight: bold; font-style: italic }
        .chroma .cp { color: #999999; font-weight: bold; font-style: italic }
        .chroma .cpf { color: #999999; font-weight: bold; font-style: italic }
        .chroma .g {  }
        .chroma .gd { color: #000000; background-color: #ffdddd }
        .chroma .ge { color: #000000; font-style: italic }
        .chroma .gr { color: #aa0000 }
        .chroma .gh { color: #999999 }
        .chroma .gi { color: #000000; background-color: #ddffdd }
        .chroma .go { color: #888888 }
        .chroma .gp { color: #555555 }
        .chroma .gs { font-weight: bold }
        .chroma .gu { color: #aaaaaa }
        .chroma .gt { color: #aa0000 }
        .chroma .gl { text-decoration: underline }
        .chroma .w { color: #bbbbbb }
        .dark.chroma { color: #f8f8f2; background-color: #272822 }
        .dark .chroma { color: #f8f8f2; background-color: #272822 }
        .dark .chroma .x {  }
        .dark .chroma .err { color: #960050; background-color: #1e0010 }
        .dark .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
        .dark .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
        .dark .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
        .dark .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
        .dark .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
        .dark .chroma .k { color: #66d9ef }
        .dark .chroma .kc { color: #66d9ef }
        .dark .chroma .kd { color: #66d9ef }
        .dark .chroma .kn { color: #f92672 }
        .dark .chroma .kp { color: #66d9ef }
        .dark .chroma .kr { color: #66d9ef }
        .dark .chroma .kt { color: #66d9ef }
        .dark .chroma .n {  }
        .dark .chroma .na { color: #a6e22e }
        .dark .chroma .nb {  }
        .dark .chroma .bp {  }
        .dark .chroma .nc { color: #a6e22e }
        .dark .chroma .no { color: #66d9ef }
        .dark .chroma .nd { color: #a6e22e }
        .dark .chroma .ni {  }
        .dark .chroma .ne { color: #a6e22e }
        .dark .chroma .nf { color: #a6e22e }
        .dark .chroma .fm {  }
        .dark .chroma .nl {  }
        .dark .chroma .nn {  }
        .dark .chroma .nx { color: #a6e22e }
        .dark .chroma .py {  }
        .dark .chroma .nt { color: #f92672 }
        .dark .chroma .nv {  }
        .dark .chroma .vc {  }
        .dark .chroma .vg {  }
        .dark .chroma .vi {  }
        .dark .chroma .vm {  }
        .dark .chroma .l { color: #ae81ff }
        .dark .chroma .ld { color: #e6db74 }
        .dark .chroma .s { color: #e6db74 }
        .dark .chroma .sa { color: #e6db74 }
        .dark .chroma .sb { color: #e6db74 }
        .dark .chroma .sc { color: #e6db74 }
        .dark .chroma .dl { color: #e6db74 }
        .dark .chroma .sd { color: #e6db74 }
        .dark .chroma .s2 { color: #e6db74 }
        .dark .chroma .se { color: #ae81ff }
        .dark .chroma .sh { color: #e6db74 }
        .dark .chroma .si { color: #e6db74 }
        .dark .chroma .sx { color: #e6db74 }
        .dark .chroma .sr { color: #e6db74 }
        .dark .chroma .s1 { color: #e6db74 }
        .dark .chroma .ss { color: #e6db74 }
        .dark .chroma .m { color: #ae81ff }
        .dark .chroma .mb { color: #ae81ff }
        .dark .chroma .mf { color: #ae81ff }
        .dark .chroma .mh { color: #ae81ff }
        .dark .chroma .mi { color: #ae81ff }
        .dark .chroma .il { color: #ae81ff }
        .dark .chroma .mo { color: #ae81ff }
        .dark .chroma .o { color: #f92672 }
        .dark .chroma .ow { color: #f92672 }
        .dark .chroma .p {  }
        .dark .chroma .c { color: #75715e }
        .dark .chroma .ch { color: #75715e }
        .dark .chroma .cm { color: #75715e }
        .dark .chroma .c1 { color: #75715e }
        .dark .chroma .cs { color: #75715e }
        .dark .chroma .cp { color: #75715e }
        .dark .chroma .cpf { color: #75715e }
        .dark .chroma .g {  }
        .dark .chroma .gd { color: #f92672 }
        .dark .chroma .ge { font-style: italic }
        .dark .chroma .gr {  }
        .dark .chroma .gh {  }
        .dark .chroma .gi { color: #a6e22e }
        .dark .chroma .go {  }
        .dark .chroma .gp {  }
        .dark .chroma .gs { font-weight: bold }
        .dark .chroma .gu { color: #75715e }
        .dark .chroma .gt {  }
        .dark .chroma .gl {  }
        .dark .chroma .w {  }
    }
  </style><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-6 h-6"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-post><h1 class=blog-post-title id=post-title>Winsorized modification of the Harrell-Davis quantile estimator</h1><div class="flex flex-wrap justify-start items-center"><svg class="fai"><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2021-03-02>March 2, 2021</time><svg class="fai ml-3"><use xlink:href="/img/fa/all.svg#tag"/></svg>
<a class=label-link href=https://aakinshin.net/tags/mathematics/>Mathematics</a>
<a class=label-link href=https://aakinshin.net/tags/statistics/>Statistics</a>
<a class=label-link href=https://aakinshin.net/tags/research/>Research</a>
<a class=label-link href=https://aakinshin.net/tags/quantile/>Quantile</a>
<a class=label-link href=https://aakinshin.net/tags/winsorizing/>Winsorizing</a>
<a class=label-link href=https://aakinshin.net/tags/harrell-davis-quantile-estimator/>Harrell-Davis quantile estimator</a>
<a class=label-link href=https://aakinshin.net/tags/research-thdqe/>Research: Building trimmed Harrell-Davis quantile estimator</a></div><br><strong>Update: this blog post is a part of research that aimed to build a statistically efficient and robust quantile estimator. A <a href=/posts/pub-thdqe/>paper with final results</a> is available in <em>Communications in Statistics - Simulation and Computation</em> (DOI: <a href=https://www.tandfonline.com/doi/abs/10.1080/03610918.2022.2050396>10.1080/03610918.2022.2050396</a>). A preprint is available on arXiv: <a href=https://arxiv.org/abs/2111.11776>arXiv:2111.11776 [stat.ME]</a>. Some information in this blog post can be obsolete: please, use the official paper as the primary reference.</strong><br><br><div class=main-content><p>The Harrell-Davis quantile estimator is one of my favorite quantile estimators
because of its <a href=https://en.wikipedia.org/wiki/Efficiency_(statistics)>efficiency</a>.
It has a small mean square error which allows getting accurate estimations.
However, it has a severe drawback: it&rsquo;s not robust.
Indeed, since the estimator includes all sample elements with positive weights,
its <a href=https://en.wikipedia.org/wiki/Robust_statistics#Breakdown_point>breakdown point</a> is zero.</p><p>In this post, I want to suggest modifications of the Harrell-Davis quantile estimator
which increases its <em>robustness</em> keeping almost the same level of <em>efficiency</em>.</p><h3 id=robustness>Robustness</h3><p>One of the essential properties of
a statistical <a href=https://en.wikipedia.org/wiki/Estimator>estimator</a> is <em>robustness</em>.
It describes the resistance abilities of the estimator against outliers.
Robustness can be expressed using the <em>breakdown point</em>.
The breakdown point is the proportion of invalid measurements that the estimator can handle.
In other words, it&rsquo;s the maximum number of sample elements
that we could replace by arbitrarily large values
without making the estimator value also arbitrarily large.
Let&rsquo;s look at a few examples.</p><p>Consider sample <span class="math inline">\(x = \{ 1, 2, 3, 4, 5, 6, 7 \}\)</span>.
The mean value of <span class="math inline">\(x\)</span> is <span class="math inline">\(4\)</span>.
Imagine that we replace one of the sample elements with <span class="math inline">\(\infty\)</span>.
Now the sample look like this: <span class="math inline">\(x = \{ 1, 2, 3, 4, 5, 6, \infty \}\)</span>.
The updated mean value is also <span class="math inline">\(\infty\)</span>.
It&rsquo;s enough to corrupt a single element in the sample to make the mean also corrupted.
The breakdown point of the mean is zero.
Thus, the mean is not a robust metric.</p><p>The sample median of <span class="math inline">\(x = \{ 1, 2, 3, 4, 5, 6, 7 \}\)</span> is also <span class="math inline">\(4\)</span>.
However, if we replace a single sample element with <span class="math inline">\(\infty\)</span> it doesn&rsquo;t make the sample median value also <span class="math inline">\(\infty\)</span>.
In fact, we can safely replace three elements of this sample and get <span class="math inline">\(x = \{ 1, 2, 3, 4, \infty, \infty, \infty \}\)</span>.
The sample median is still meaningful.
It could be changed to another element from the original sample, but it will not become arbitrarily large.
Thereby, we can corrupt three elements from the given seven-element sample without corrupting the sample median value.
The breakdown point is <span class="math inline">\(3/7\approx 43\%\)</span>.
Asymptotically, the breakdown point of the sample median is <span class="math inline">\(0.5\)</span> which is
the maximum possible breakdown point value.
Thus, the median is a robust metric.</p><h3 id=efficiency>Efficiency</h3><p>Another important estimator property is <em>efficiency</em>.
It describes the estimator accuracy.</p><p>Consider the straightforward way to calculate the sample median for a sample of size <span class="math inline">\(n\)</span>:</p><ul><li>If <span class="math inline">\(n\)</span> is odd, the median is the middle element of the sorted sample</li><li>If <span class="math inline">\(n\)</span> is even, the median is the arithmetic average of the two middle elements of the sorted sample</li></ul><p>This rule gives us the median value of the sample, but it doesn&rsquo;t provide an accurate estimation of the population median.
Meanwhile, there are other quantile estimators that have better accuracy.
One of my favorite options is the Harrell-Davis quantile estimator (see <a href=#Harrell1982>[Harrell1982]</a>).
Here is the estimation for <span class="math inline">\(p^\textrm{th}\)</span> quantile:</p><p><span class="math display">\[q_p = \sum_{i=1}^{n} W_{i} \cdot x_{(i)}, \quad
W_{i} = I_{i/n}(a, b) - I_{(i-1)/n}(a, b), \quad
a = p(n+1),\; b = (1-p)(n+1)
\]</span></p><p>where
<span class="math inline">\(I_t(a, b)\)</span> denotes the <a href=https://en.wikipedia.org/wiki/Beta_function#Incomplete_beta_function>regularized incomplete beta function</a>,
<span class="math inline">\(x_{(i)}\)</span> is the <span class="math inline">\(i^\textrm{th}\)</span> <a href=https://en.wikipedia.org/wiki/Order_statistic>order statistic</a>.
This estimator has higher efficiency than the sample median.
It means that it has a smaller variance and smaller mean squared error.</p><p>However, the Harrell-Davis quantile estimator has a serious drawback: it&rsquo;s not robust.
Indeed, since its value is a linear combination of all order statistics,
it&rsquo;s enough to corrupt a single sample element to spoil the estimation.
Thus, its breakdown point is zero.</p><p>So, how should we estimate the median?
The sample median gives a robust but not-so-efficient estimation.
The Harrell-Davis quantile estimator gives efficient but not robust estimation.</p><p>I&rsquo;m going to suggest an approach that improves the robustness of the Harrell-Davis quantile estimator
keeping a decent level of efficiency.
But first, we should briefly discuss trimmed and winsorized means.</p><h3 id=trimmed-and-winsorized-mean>Trimmed and winsorized mean</h3><p>The <a href=https://en.wikipedia.org/wiki/Truncated_mean>trimmed mean</a> (or truncated mean) is an attempt
to improve the mean robustness.
The idea is simple:
we should sort all values in the sample,
drop the first k values and the last k values,
and calculate the mean of the middle elements.
Let&rsquo;s say we have a sample with 8 elements:</p><p><span class="math display">\[x = \{x_1, x_2, x_3, x_4, x_5, x_6, x_7, x_8\}.
\]</span></p><p>If we assume that <span class="math inline">\(x\)</span> is already sorted, and we want to calculated the 25% trimmed mean,
we should drop the first 25% and the last 25% of the values:</p><p><span class="math display">\[x_{\textrm{trimmed}} = \{x_3, x_4, x_5, x_6\}.
\]</span></p><p>Next, we should calculate the mean of the middle elements:</p><p><span class="math display">\[\overline{x_{\textrm{trimmed}}} = \dfrac{x_3 + x_4 + x_5 + x_6}{4}.
\]</span></p><p>We can also consider a similar technique called <a href=https://en.wikipedia.org/wiki/Winsorizing>winsorization</a>.
Instead of dropping extreme values, we could replace them with the minimum and maximum elements among the remaining values.
Thus, if we 25% winsorize the above sample, we get</p><p><span class="math display">\[x_{\textrm{winsorized}} = \{x_3, x_3, x_3, x_4, x_5, x_6, x_6, x_6\}.
\]</span></p><p>Using the winsorized sample, we could calculate the <a href=https://en.wikipedia.org/wiki/Winsorized_mean>winsorized mean</a>:</p><p><span class="math display">\[\overline{x_{\textrm{winsorized}}} = \dfrac{x_3 + x_3 + x_3 + x_4 + x_5 + x_6 + x_6 + x_6}{4}.
\]</span></p><p>The breakdown point of p% trimmed mean and p% winsorized mean is p% (the proportion of dropped/replaced element on each tail).
This makes these metrics more robust than the classic mean.</p><h3 id=winsorized-harrell-davis-quantile-estimator>Winsorized Harrell-Davis quantile estimator</h3><p>Let&rsquo;s go back to the Harrell-Davis quantile estimator.
It estimates the <span class="math inline">\(p^\textrm{th}\)</span> quantile as a weighted sum of order statistics:</p><p><span class="math display">\[q_p = \sum_{i=1}^{n} W_{i} \cdot x_{(i)}
\]</span></p><p>The weights <span class="math inline">\(W_i\)</span> can be calculated as segment areas of Beta distribution density plot with <span class="math inline">\(a = p(n+1)\)</span> and <span class="math inline">\(b = (1-p)(n+1)\)</span>.
For example, <span class="math inline">\(n = 10, p = 0.5\)</span> (estimating the median for 10-elements sample) gives the following plot:</p><div class="flex my-7 justify-center"><a class="img-light hidden" href=/posts/winsorized-hdqe/img/beta1-light.png target=_blank alt=beta1><img src=/posts/winsorized-hdqe/img/beta1-light.png width=800></a>
<a class="img-dark hidden" href=/posts/winsorized-hdqe/img/beta1-dark.png target=_blank alt=beta1><img src=/posts/winsorized-hdqe/img/beta1-dark.png width=800></a></div><p>Here are the values of corresponding weights <span class="math inline">\(W_i\)</span>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=n>W</span><span class=p>[</span><span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>W</span><span class=p>[</span><span class=m>10</span><span class=p>]</span> <span class=p>=</span> <span class=m>0.0005124147</span>
</span></span><span class=line><span class=cl><span class=n>W</span><span class=p>[</span><span class=m>2</span><span class=p>]</span> <span class=p>=</span> <span class=n>W</span><span class=p>[</span><span class=m>9</span><span class=p>]</span>  <span class=p>=</span> <span class=m>0.0145729829</span>
</span></span><span class=line><span class=cl><span class=n>W</span><span class=p>[</span><span class=m>3</span><span class=p>]</span> <span class=p>=</span> <span class=n>W</span><span class=p>[</span><span class=m>8</span><span class=p>]</span>  <span class=p>=</span> <span class=m>0.0727403902</span>
</span></span><span class=line><span class=cl><span class=n>W</span><span class=p>[</span><span class=m>4</span><span class=p>]</span> <span class=p>=</span> <span class=n>W</span><span class=p>[</span><span class=m>7</span><span class=p>]</span>  <span class=p>=</span> <span class=m>0.1683691116</span>
</span></span><span class=line><span class=cl><span class=n>W</span><span class=p>[</span><span class=m>5</span><span class=p>]</span> <span class=p>=</span> <span class=n>W</span><span class=p>[</span><span class=m>6</span><span class=p>]</span>  <span class=p>=</span> <span class=m>0.2438051006</span>
</span></span></code></pre></div><p>As we can see, weights of <span class="math inline">\(x_{(1)}\)</span> and <span class="math inline">\(x_{(10)}\)</span> are <span class="math inline">\(W_1 = W_{10} = 0.0005124147\)</span>.
In most cases, they don&rsquo;t produce a noticeable impact on the result (their total weight is about <span class="math inline">\(0.1\%\)</span>).
However, in the case of extremely large outliers, they can completely distort the final estimation.
Let&rsquo;s consider the following sample:</p><p><span class="math display">\[x = \{ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 \}
\]</span></p><p>The sample median is <span class="math inline">\(5.5\)</span>.
The Harrell-Davis quantile estimator dives the same estimation: <span class="math inline">\(q_{0.5} = 5.5\)</span>.
Now let&rsquo;s replace the last element of this sample by <span class="math inline">\(10^6\)</span>:</p><p><span class="math display">\[x = \{ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10^6 \}
\]</span></p><p>Now, the Harrell-Davis estimation is <span class="math inline">\(q_{0.5} = 517.9096\)</span> which is probably too far from the actual median value.
We have this problem because the Harrell-Davis quantile estimator is not robust; its breakdown point is zero.</p><p>Let&rsquo;s look again at the tail elements <span class="math inline">\(x_{(1)}\)</span> and <span class="math inline">\(x_{(10)}\)</span>.
They are almost useless in situations without outliers and
they are destructive in situations with outliers.
What the point of using these values at all?
What if we winsorize them?</p><p>However, we couldn&rsquo;t just update the p% of values in each tail.
Firstly, if we winsorize values with the big weight, we noticeably reduce the estimator efficiency.
Secondly, if we estimate arbitrary quantile (not the median), the tail values may have the highest weight
and definitely should not be dropped.</p><p>I suggest a simple heuristic.
We should find the 99% highest density interval of the considered beta distribution.
All segments outside this interval should be winsorized.
Thus, we keep values that form 99% of the final result (keeping almost the same level of efficiency)
and protect ourselves against outliers (improving robustness).
In the below table, you can find values of breakdown points and the numbers of winsorized elements
for different sample sizes.</p><table><thead><tr><th>n</th><th>winsorized</th><th>breakdown</th></tr></thead><tbody><tr><td>2</td><td>0</td><td>0.0000</td></tr><tr><td>3</td><td>0</td><td>0.0000</td></tr><tr><td>4</td><td>0</td><td>0.0000</td></tr><tr><td>5</td><td>0</td><td>0.0000</td></tr><tr><td>6</td><td>0</td><td>0.0000</td></tr><tr><td>7</td><td>0</td><td>0.0000</td></tr><tr><td>8</td><td>2</td><td>0.1250</td></tr><tr><td>9</td><td>2</td><td>0.1111</td></tr><tr><td>10</td><td>2</td><td>0.1000</td></tr><tr><td>11</td><td>2</td><td>0.0909</td></tr><tr><td>12</td><td>4</td><td>0.1667</td></tr><tr><td>13</td><td>4</td><td>0.1538</td></tr><tr><td>14</td><td>4</td><td>0.1429</td></tr><tr><td>15</td><td>6</td><td>0.2000</td></tr><tr><td>16</td><td>6</td><td>0.1875</td></tr><tr><td>17</td><td>6</td><td>0.1765</td></tr><tr><td>18</td><td>8</td><td>0.2222</td></tr><tr><td>19</td><td>8</td><td>0.2105</td></tr><tr><td>20</td><td>8</td><td>0.2000</td></tr><tr><td>21</td><td>10</td><td>0.2381</td></tr><tr><td>22</td><td>10</td><td>0.2273</td></tr><tr><td>23</td><td>10</td><td>0.2174</td></tr><tr><td>24</td><td>12</td><td>0.2500</td></tr><tr><td>25</td><td>12</td><td>0.2400</td></tr><tr><td>26</td><td>12</td><td>0.2308</td></tr><tr><td>27</td><td>14</td><td>0.2593</td></tr><tr><td>28</td><td>14</td><td>0.2500</td></tr><tr><td>29</td><td>14</td><td>0.2414</td></tr><tr><td>30</td><td>16</td><td>0.2667</td></tr><tr><td>31</td><td>16</td><td>0.2581</td></tr><tr><td>32</td><td>18</td><td>0.2812</td></tr><tr><td>33</td><td>18</td><td>0.2727</td></tr><tr><td>34</td><td>18</td><td>0.2647</td></tr><tr><td>35</td><td>20</td><td>0.2857</td></tr><tr><td>36</td><td>20</td><td>0.2778</td></tr><tr><td>37</td><td>22</td><td>0.2973</td></tr><tr><td>38</td><td>22</td><td>0.2895</td></tr><tr><td>39</td><td>22</td><td>0.2821</td></tr><tr><td>40</td><td>24</td><td>0.3000</td></tr><tr><td>41</td><td>24</td><td>0.2927</td></tr><tr><td>42</td><td>26</td><td>0.3095</td></tr><tr><td>43</td><td>26</td><td>0.3023</td></tr><tr><td>44</td><td>26</td><td>0.2955</td></tr><tr><td>45</td><td>28</td><td>0.3111</td></tr><tr><td>46</td><td>28</td><td>0.3043</td></tr><tr><td>47</td><td>30</td><td>0.3191</td></tr><tr><td>48</td><td>30</td><td>0.3125</td></tr><tr><td>49</td><td>30</td><td>0.3061</td></tr><tr><td>50</td><td>32</td><td>0.3200</td></tr><tr><td>100</td><td>74</td><td>0.3700</td></tr><tr><td>500</td><td>442</td><td>0.4420</td></tr><tr><td>1000</td><td>918</td><td>0.4590</td></tr><tr><td>10000</td><td>9742</td><td>0.4871</td></tr><tr><td>100000</td><td>99184</td><td>0.4959</td></tr></tbody></table><h3 id=winsorized-maritz-jarrett-method>Winsorized Maritz-Jarrett method</h3><p>The Maritz-Jarrett method (see <a href=#Maritz1979>[Maritz1979]</a>) allows estimating quantile confidence intervals.
It works great with the Harrell-Davis quantile estimator because it reuses weights <span class="math inline">\(W_i\)</span>.
Let&rsquo;s define <span class="math inline">\(k^\textrm{th}\)</span> moment of the <span class="math inline">\(p^\textrm{th}\)</span> quantile as follows:</p><p><span class="math display">\[C_k = \sum_{i=1}^n W_{i} \cdot x_{(i)}^k.
\]</span></p><p>Next, we could express the standard error of the <span class="math inline">\(p^\textrm{th}\)</span> quantile via the first and the seconds moments:</p><p><span class="math display">\[s_{q_p} = \sqrt{C_2 - C_1^2}
\]</span></p><p>It&rsquo;s easy to see that winsorization could be applied here as well.</p><h3 id=reference-implementation>Reference implementation</h3><p>The C# reference implementation can be found in
the latest nightly version (0.3.0-nightly.89+) of <a href=https://github.com/AndreyAkinshin/perfolizer>Perfolizer</a>
(you need <code>WinsorizedHarrellDavisQuantileEstimator</code>).</p><h3 id=conclusion>Conclusion</h3><p>The winsorized modifications of the Harrell-Davis quantile estimator has the same level of efficiency as the original estimator,
but it&rsquo;s more robust.
It protects the estimated value from extreme outliers.
The asymptotic breakdown point of the suggested estimator is <span class="math inline">\(0.5\)</span>.
Also, the winsorized version can be calculated much faster because it doesn&rsquo;t require so many values of the regularized incomplete beta function.</p><h3 id=references>References</h3><ul><li><b id=Harrell1982>[Harrell1982]</b><br>Harrell, F.E. and Davis, C.E., 1982. A new distribution-free quantile estimator.
<em>Biometrika</em>, 69(3), pp.635-640.<br><a href=https://doi.org/10.2307/2335999>https://doi.org/10.2307/2335999</a></li><li><b id=Maritz1979>[Maritz1979]</b><br>Maritz, J. S., and R. G. Jarrett. 1978.
“A Note on Estimating the Variance of the Sample Median.”
Journal of the American Statistical Association 73 (361): 194–196.<br><a href=https://doi.org/10.1080/01621459.1978.10480027>https://doi.org/10.1080/01621459.1978.10480027</a></li></ul></div><br><br><div class="flex flex-wrap justify-center items-center mb-5"><span>Share:</span><div class="text-4xl pl-3"><a href="https://www.reddit.com/submit?url=https%3a%2f%2faakinshin.net%2fposts%2fwinsorized-hdqe%2f&title=Winsorized%20modification%20of%20the%20Harrell-Davis%20quantile%20estimator" target=_blank title="Share on Reddit"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#reddit"/></svg></a></div><div class="text-4xl pl-3"><a href="https://twitter.com/intent/tweet?text=Winsorized%20modification%20of%20the%20Harrell-Davis%20quantile%20estimator&url=https%3a%2f%2faakinshin.net%2fposts%2fwinsorized-hdqe%2f&via=andrey_akinshin&related=andrey_akinshin" rel=nofollow target=_blank title="Share on Twitter"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></div><div class="text-4xl pl-3"><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2faakinshin.net%2fposts%2fwinsorized-hdqe%2f" target=_blank title="Share on HackerNews"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#hacker-news"/></svg></a></div><div class="text-4xl pl-3"><a href="https://getpocket.com/save?url=https%3a%2f%2faakinshin.net%2fposts%2fwinsorized-hdqe%2f&title=Winsorized%20modification%20of%20the%20Harrell-Davis%20quantile%20estimator" target=_blank title="Add to Pocket"><svg class="fai fai-link"><use xlink:href="/img/fa/all.svg#get-pocket"/></svg></a></div></div></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2022 Andrey Akinshin</span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js integrity="sha512-zPB79j2C+3sFS9zcA3vg/z6bVKzJVEyu9pY5w89akQRys76zpAT2t6S3wZKla3QQ14O5l/Yt0RUQ/DHXx82Y5g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>anchors.options={placement:"left",icon:"§"},anchors.add("h1"),anchors.add("h2"),anchors.add("h3")</script><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>