<!doctype html><html lang=en class=h-100><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.74.3"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content><title>Andrey Akinshin's blog (Page 11)</title><meta name=description content="Andrey Akinshin's blog"><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><link href=/css/lumen-bootstrap.min.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/slate-bootstrap.min.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><link href=/css/syntax-light.css theme=light rel=stylesheet type=text/css media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link href=/css/syntax-dark.css theme=dark rel=stylesheet type=text/css media="(prefers-color-scheme: dark)"><script src=https://aakinshin.net/js/theme-before.min.26d61b7027fe55e642f0001cef94cb75b567d721086492aab6b4e32d9ee7811d.js></script><script type=module src=https://aakinshin.net/js/dark-mode-toggle.min.882998740b9c4c24677576b997bde5a487246e2e3bd72128a0e922eaa59db029.mjs></script><link href=https://aakinshin.net/css/fontawesome-all.min.50da8736f05b35aac9691de67fe993cbe01b7d88fcf0cb682c3a8f39933fe4a3.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/about.min.2a76db7cc14055b3bafacc363f453917ab54a818a7db2a0a9b2409c0f6bf07c5.css rel=stylesheet type=text/css media=all><link href=https://aakinshin.net/css/blog.min.ae812fc71daf5160d927febda5a991cee6c361345e3f685d3736931ed7537986.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVB6MXSX32"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-ZVB6MXSX32');</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-41419012-5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-41419012-5');</script><script type=text/javascript>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym");ym(28700916,"init",{clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src=https://mc.yandex.ru/watch/28700916 style=position:absolute;left:-9999px alt></div></noscript><script src=/js/jquery-3.3.1.slim.min.js></script></head><body><div class=bg-primary><div class="container bg-primary"><nav class="navbar navbar-expand-sm navbar-dark bg-primary"><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link id=nav-link-blog href=https://aakinshin.net/><i class="fas fa-home" title=Home style=color:#fff></i></a></li><li class=nav-item><a class=nav-link id=nav-link-posts href=https://aakinshin.net/posts/>Posts</a></li><li class=nav-item><a class=nav-link id=nav-link-about href=https://aakinshin.net/about/>About</a></li><li class=nav-item><a class=nav-link id=nav-link-pdnb href=https://aakinshin.net/prodotnetbenchmarking/>Pro .NET Benchmarking</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle=dropdown href=# role=button aria-haspopup=true aria-expanded=false>EN</a><div class=dropdown-menu><a class=dropdown-item href=https://aakinshin.net/ru/>RU</a></div></li></ul><ul class="navbar-nav ml-auto"><li class=nav-item><dark-mode-toggle permanent=true></dark-mode-toggle></li></ul></nav></div></div><div class=container><main id=main><div class=blog-main><div class=blog-post><h2 class=blog-post-title><a href=/posts/ryujit-rc-and-constant-folding/>RyuJIT RC and constant folding</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2015-05-12>May 12, 2015</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/jit/ class="badge badge-info">JIT</a>
<a href=https://aakinshin.net/tags/ryujit/ class="badge badge-info">RyuJIT</a>
<a href=https://aakinshin.net/tags/constantfolding/ class="badge badge-info">ConstantFolding</a></span><br><br><p><strong>Update:</strong> The below results are valid for the release version of RyuJIT in .NET Framework 4.6 without updates.</p><p>The challenge of the day: which method is faster?</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=kt>double</span> <span class=n>Sqrt13</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>1</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>2</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>3</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>4</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>5</span><span class=p>)</span> <span class=p>+</span> 
           <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>6</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>7</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>8</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>9</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>10</span><span class=p>)</span> <span class=p>+</span> 
           <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>11</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>12</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>13</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>public</span> <span class=kt>double</span> <span class=n>Sqrt14</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>1</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>2</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>3</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>4</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>5</span><span class=p>)</span> <span class=p>+</span> 
           <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>6</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>7</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>8</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>9</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>10</span><span class=p>)</span> <span class=p>+</span> 
           <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>11</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>12</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>13</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>14</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>I have measured the methods performance with help of <a href=https://github.com/AndreyAkinshin/BenchmarkDotNet>BenchmarkDotNet</a> for RyuJIT RC (a part of .NET Framework 4.6 RC) and received the following results:</p><div class=highlight><pre class=chroma><code class=language-md data-lang=md>// BenchmarkDotNet=v0.7.4.0
// OS=Microsoft Windows NT 6.2.9200.0
// Processor=Intel(R) Core(TM) i7-4702MQ CPU ＠ 2.20GHz, ProcessorCount=8
// CLR=MS.NET 4.0.30319.0, Arch=64-bit  [RyuJIT]
Common:  Type=Math_DoubleSqrtAvx  Mode=Throughput  Platform=X64  Jit=RyuJit  .NET=Current  

 Method |  AvrTime |    StdDev |         op/s |
------- |--------- |---------- |------------- |
 Sqrt13 | 55.40 ns |  0.571 ns |  18050993.06 |
 Sqrt14 |  1.43 ns | 0.0224 ns | 697125029.18 |
</code></pre></div><p>How so? If I add one more <code>Math.Sqrt</code> to the expression, the method starts work 40 times faster! Let&rsquo;s examine the situation..</p><br><a href=/posts/ryujit-rc-and-constant-folding/>Read more</a><br><br><hr></div><div class=blog-post><h2 class=blog-post-title><a href=/posts/unrolling-of-small-loops-in-different-jit-versions/>Unrolling of small loops in different JIT versions</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2015-03-02>March 2, 2015</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/jit/ class="badge badge-info">JIT</a>
<a href=https://aakinshin.net/tags/bugs/ class="badge badge-info">Bugs</a>
<a href=https://aakinshin.net/tags/loopunrolling/ class="badge badge-info">LoopUnrolling</a></span><br><br><p>Challenge of the day: what will the following code display?</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>struct</span> <span class=nc>Point</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=kt>int</span> <span class=n>X</span><span class=p>;</span>
    <span class=k>public</span> <span class=kt>int</span> <span class=n>Y</span><span class=p>;</span>
<span class=p>}</span>
<span class=k>static</span> <span class=k>void</span> <span class=n>Print</span><span class=p>(</span><span class=n>Point</span> <span class=n>p</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=n>X</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>p</span><span class=p>.</span><span class=n>Y</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
<span class=p>{</span>
    <span class=kt>var</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Point</span><span class=p>();</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=n>X</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>p</span><span class=p>.</span><span class=n>X</span> <span class=p>&lt;</span> <span class=m>2</span><span class=p>;</span> <span class=n>p</span><span class=p>.</span><span class=n>X</span><span class=p>++)</span>
        <span class=n>Print</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>The right answer: it depends. There is a bug in CLR2 JIT-x86 which spoil this wonderful program. This story is about optimization that called unrolling of small loops. This is a very interesting theme, let&rsquo;s discuss it in detail.</p><br><a href=/posts/unrolling-of-small-loops-in-different-jit-versions/>Read more</a><br><br><hr></div><div class=blog-post><h2 class=blog-post-title><a href=/posts/ryujit-ctp5-and-loop-unrolling/>RyuJIT CTP5 and loop unrolling</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2015-03-01>March 1, 2015</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/jit/ class="badge badge-info">JIT</a>
<a href=https://aakinshin.net/tags/ryujit/ class="badge badge-info">RyuJIT</a>
<a href=https://aakinshin.net/tags/loopunrolling/ class="badge badge-info">LoopUnrolling</a></span><br><br><p>RyuJIT will be available soon. It is a next generation JIT-compiler for .NET-applications. Microsoft likes to tell us about the benefits of SIMD using and JIT-compilation time reducing. But what about basic code optimization which is usually applying by a compiler? Today we talk about the loop unrolling (unwinding) optimization. In general, in this type of code optimization, the code</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>1024</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</code></pre></div><p>transforms to</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>1024</span><span class=p>;</span> <span class=n>i</span> <span class=p>+=</span> <span class=m>4</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>);</span>
    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>2</span><span class=p>);</span>
    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>3</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>Such approach can significantly increase performance of your code. So, what&rsquo;s about loop unrolling in .NET?</p><br><a href=/posts/ryujit-ctp5-and-loop-unrolling/>Read more</a><br><br><hr></div><div class=blog-post><h2 class=blog-post-title><a href=/posts/jit-version-determining-in-runtime/>JIT version determining in runtime</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2015-02-28>February 28, 2015</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/jit/ class="badge badge-info">JIT</a></span><br><br><p>Sometimes I want to know used JIT compiler version in my little C# experiments. It is clear that it is possible to determine the version in advance based on the environment. However, sometimes I want to know it in runtime to perform specific code for the current JIT compiler. More formally, I want to get the value from the following enum:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>enum</span> <span class=n>JitVersion</span>
<span class=p>{</span>
    <span class=n>Mono</span><span class=p>,</span> <span class=n>MsX86</span><span class=p>,</span> <span class=n>MsX64</span><span class=p>,</span> <span class=n>RyuJit</span>
<span class=p>}</span>
</code></pre></div><p>It is easy to detect Mono by existing of the <code>Mono.Runtime</code> class. Otherwise, we can assume that we work with Microsoft JIT implementation. It is easy to detect JIT-x86 with help of <code>IntPtr.Size == 4</code>. The challenge is to distinguish JIT-x64 and RyuJIT. Next, I will show how you can do it with help of the bug from my <a href=http://aakinshin.net/en/blog/dotnet/subexpression-elimination-bug-in-jit-x64/>previous post</a>.</p><br><a href=/posts/jit-version-determining-in-runtime/>Read more</a><br><br><hr></div><div class=blog-post><h2 class=blog-post-title><a href=/posts/subexpression-elimination-bug-in-jit-x64/>A bug story about JIT-x64</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2015-02-27>February 27, 2015</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/jit/ class="badge badge-info">JIT</a>
<a href=https://aakinshin.net/tags/bugs/ class="badge badge-info">Bugs</a></span><br><br><p>Can you say, what will the following code display for <code>step=1</code>?</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>void</span> <span class=n>Foo</span><span class=p>(</span><span class=kt>int</span> <span class=n>step</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>step</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
    <span class=p>{</span>
        <span class=n>bar</span> <span class=p>=</span> <span class=n>i</span> <span class=p>+</span> <span class=m>10</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>j</span> <span class=p>&lt;</span> <span class=m>2</span> <span class=p>*</span> <span class=n>step</span><span class=p>;</span> <span class=n>j</span> <span class=p>+=</span> <span class=n>step</span><span class=p>)</span>
            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>j</span> <span class=p>+</span> <span class=m>10</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>If you think about specific numbers, you are wrong. The right answer: it depends. The post title suggests to us, the program can has a strange behavior for x64.</p><br><a href=/posts/subexpression-elimination-bug-in-jit-x64/>Read more</a><br><br><hr></div><div class=blog-post><h2 class=blog-post-title><a href=/posts/inlining-and-starg/>A story about JIT-x86 inlining and starg</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2015-02-26>February 26, 2015</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/inlining/ class="badge badge-info">Inlining</a></span><br><br><p>Sometimes you can learn a lot during reading source .NET. Let&rsquo;s open the source code of a <code>Decimal</code> constructor from .NET Reference Source (<a href=http://referencesource.microsoft.com/#mscorlib/system/decimal.cs,158>mscorlib/system/decimal.cs,158</a>):</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=c1>// Constructs a Decimal from an integer value.
</span><span class=c1>//
</span><span class=c1></span><span class=k>public</span> <span class=n>Decimal</span><span class=p>(</span><span class=kt>int</span> <span class=k>value</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>//  JIT today can&#39;t inline methods that contains &#34;starg&#34; opcode.
</span><span class=c1></span>    <span class=c1>//  For more details, see DevDiv Bugs 81184: x86 JIT CQ: Removing the inline striction of &#34;starg&#34;.
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>value_copy</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>value_copy</span> <span class=p>&gt;=</span> <span class=m>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>flags</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span>
        <span class=n>flags</span> <span class=p>=</span> <span class=n>SignMask</span><span class=p>;</span>
        <span class=n>value_copy</span> <span class=p>=</span> <span class=p>-</span><span class=n>value_copy</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>lo</span> <span class=p>=</span> <span class=n>value_copy</span><span class=p>;</span>
    <span class=n>mid</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
    <span class=n>hi</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>The comment states that JIT-x86 can&rsquo;t apply the inlining optimization for a method that contains the <a href=https://msdn.microsoft.com/library/system.reflection.emit.opcodes.starg.aspx>starg</a> IL-opcode. Curious, is not it?</p><br><a href=/posts/inlining-and-starg/>Read more</a><br><br><hr></div><div class=blog-post><h2 class=blog-post-title><a href=/posts/mono-utf8-conversions/>About UTF-8 conversions in Mono</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2014-11-10>November 10, 2014</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/encodings/ class="badge badge-info">Encodings</a>
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/mono/ class="badge badge-info">Mono</a></span><br><br><p>This post is a logical continuation of the Jon Skeet&rsquo;s blog post <a href=http://codeblog.jonskeet.uk/2014/11/07/when-is-a-string-not-a-string>“When is a string not a string?”</a>. Jon showed very interesting things about behavior of ill-formed Unicode strings in .NET. I wondered about how similar examples will work on Mono. And I have got very interesting results.</p><h3 id=experiment-1-compilation>Experiment 1: Compilation</h3><p>Let&rsquo;s take the Jon&rsquo;s code with a small modification. We will just add <code>text</code> null check in <code>DumpString</code>:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.ComponentModel</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=na>[Description(Value)]</span>
<span class=k>class</span> <span class=nc>Test</span>
<span class=p>{</span>
    <span class=k>const</span> <span class=kt>string</span> <span class=n>Value</span> <span class=p>=</span> <span class=s>&#34;X\ud800Y&#34;</span><span class=p>;</span>
    <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=kt>var</span> <span class=n>description</span> <span class=p>=</span> <span class=p>(</span><span class=n>DescriptionAttribute</span><span class=p>)</span><span class=k>typeof</span><span class=p>(</span><span class=n>Test</span><span class=p>).</span>
            <span class=n>GetCustomAttributes</span><span class=p>(</span><span class=k>typeof</span><span class=p>(</span><span class=n>DescriptionAttribute</span><span class=p>),</span> <span class=k>true</span><span class=p>)[</span><span class=m>0</span><span class=p>];</span>
        <span class=n>DumpString</span><span class=p>(</span><span class=s>&#34;Attribute&#34;</span><span class=p>,</span> <span class=n>description</span><span class=p>.</span><span class=n>Description</span><span class=p>);</span>
        <span class=n>DumpString</span><span class=p>(</span><span class=s>&#34;Constant&#34;</span><span class=p>,</span> <span class=n>Value</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>static</span> <span class=k>void</span> <span class=n>DumpString</span><span class=p>(</span><span class=kt>string</span> <span class=n>name</span><span class=p>,</span> <span class=kt>string</span> <span class=n>text</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=n>Console</span><span class=p>.</span><span class=n>Write</span><span class=p>(</span><span class=s>&#34;{0}: &#34;</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>text</span> <span class=p>!=</span> <span class=k>null</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=kt>var</span> <span class=n>utf16</span> <span class=p>=</span> <span class=n>text</span><span class=p>.</span><span class=n>Select</span><span class=p>(</span><span class=n>c</span> <span class=p>=&gt;</span> <span class=p>((</span><span class=kt>uint</span><span class=p>)</span> <span class=n>c</span><span class=p>).</span><span class=n>ToString</span><span class=p>(</span><span class=s>&#34;x4&#34;</span><span class=p>));</span>
            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>Join</span><span class=p>(</span><span class=s>&#34; &#34;</span><span class=p>,</span> <span class=n>utf16</span><span class=p>));</span>
        <span class=p>}</span>
        <span class=k>else</span>
            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;null&#34;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><br><a href=/posts/mono-utf8-conversions/>Read more</a><br><br><hr></div><div class=blog-post><h2 class=blog-post-title><a href=/posts/happy-monday/>Happy Monday!</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2014-08-11>August 11, 2014</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/bugs/ class="badge badge-info">Bugs</a>
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/hate/ class="badge badge-info">Hate</a>
<a href=https://aakinshin.net/tags/postsharp/ class="badge badge-info">PostSharp</a></span><br><br><p>Today I tell you a story about one tricky bug. The bug is a tricky one because it doesn&rsquo;t allow me to debug my application on Mondays. I&rsquo;m serious right now: the debug mode doesn&rsquo;t work every Monday. Furthermore, the bug literally tell me: &ldquo;Happy Monday!&rdquo;.</p><p>So, the story. It was a wonderful Sunday evening, no signs of trouble. We planned to release a new version of our software (a minor one, but it includes some useful features). Midnight on the clock. Suddenly, I came up with the idea that we have a minor bug that should be fixed. It requires a few lines of code and 10 minutes to do it. And I decided to write needed logic before I go to sleep. I open VisualStudio, lunch build, and wait. But something goes wrong, because I get the following error:</p><div class=highlight><pre class=chroma><code class=language-txt data-lang=txt>Error connecting to the pipe server.
</code></pre></div><p>Hmm. It is a strange error.</p><br><a href=/posts/happy-monday/>Read more</a><br><br><hr></div><div class=blog-post><h2 class=blog-post-title><a href=/posts/refactoring/>To Refactor Or Not To Refactor?</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2014-07-19>July 19, 2014</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/perfectcode/ class="badge badge-info">PerfectCode</a>
<a href=https://aakinshin.net/tags/refactoring/ class="badge badge-info">Refactoring</a></span><br><br><p>I like refactoring. No, I love refactoring. No, not even like this. I awfully love refactoring.</p><p>I hate bad code and bad architecture. I feel quite creepy when I design a new feature and the near-by class contains absolute mess. I just can’t look at the sadly-looking variables. Sometimes before falling asleep I close my eyes and imagine what could be improved in the project. Sometimes I wake up at 3:00AM and go to my computer to improve something. I want to have not just code, but a masterpiece that is pleasant to look at, that is pleasant to work with at any stage of the project.</p><p>If you just a little bit share my feelings we have something to talk about. The matter is that over some time something inside me began to hint that it’s a bad idea to refactor all code, everywhere and all the time. Understand me correctly – code should be good (even better when it’s ideal), but in real life it’s not reasonable to improve code instantly. I formed some rules about the refactoring timeliness. If I am itching to improve something, I look at these rules and think “Is that the moment when I need to refactor the code?” So, let’s talk about when refactoring is necessary and when it’s inappropriate.</p><br><a href=/posts/refactoring/>Read more</a><br><br><hr></div><div class=blog-post><h2 class=blog-post-title><a href=/posts/findelementsinhostcoordinates/>Strange behavior of FindElementsInHostCoordinates in WinRT</a></h2><span class=blog-post-meta><div class=faicon><i class="far fa-calendar-alt"></i></div><time datetime=2014-04-29>April 29, 2014</time>
&nbsp;&nbsp;
<i class="fas fa-tag"></i>&nbsp;
<a href=https://aakinshin.net/tags/dotnet/ class="badge badge-info">.NET</a>
<a href=https://aakinshin.net/tags/cs/ class="badge badge-info">C#</a>
<a href=https://aakinshin.net/tags/silverlight/ class="badge badge-info">Silverlight</a>
<a href=https://aakinshin.net/tags/winrt/ class="badge badge-info">WinRT</a></span><br><br><p>Silverlight features a splendid method: <a href="http://msdn.microsoft.com/en-us/library/system.windows.media.visualtreehelper.findelementsinhostcoordinates(v=vs.95).aspx">VisualTreeHelper.FindElementsInHostCoordinates</a>. It allows the <code>HitTest</code>, i.e. makes it possible for a point or rectangle to search for all visual sub-tree objects that intersect this rectangle or point. Formally the same method <a href=http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.media.visualtreehelper.findelementsinhostcoordinates.aspx>VisualTreeHelper.FindElementsInHostCoordinates</a> is available in WinRT. And it seems the method looks in the same way, but there is a little nuance. It works differently in different versions of the platform. So, let’s see what’s going on.</p><br><a href=/posts/findelementsinhostcoordinates/>Read more</a><br><br><hr></div></div><div class=paginator><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/10/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/10/>10</a></li><li class="page-item active"><a class=page-link href=/page/11/>11</a></li><li class=page-item><a class=page-link href=/page/12/>12</a></li><li class=page-item><a class=page-link href=/page/13/>13</a></li><li class=page-item><a href=/page/12/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/13/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></main></div><footer class=blog-footer><div class=container><p>&copy; 2013&mdash;2022 Andrey Akinshin
|
<a href=https://github.com/AndreyAkinshin><i class="fab fa-github" title=GitHub></i></a><a href=https://twitter.com/andrey_akinshin><i class="fab fa-twitter" title=Twitter></i></a><a href=https://aakinshin.net/posts/index.xml><i class="fas fa-rss" title=RSS></i></a>|
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></p></div></footer><script src=https://aakinshin.net/js/theme-after.min.082780cb948cc57eabbc0d80172a7a5347d5572b599938b4c9876dfd7978b424.js></script><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/anchor.min.js></script><script src=https://aakinshin.net/js/custom.min.11932490dde776463ed165b345838c701accc0cfdedf2e0868f13415f41f0872.js></script><script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:true,processEnvironments:true,},options:{skipHtmlTags:['script','noscript','style','textarea','pre'],ignoreHtmlClass:'tex2jax_ignore',processHtmlClass:'tex2jax_process'}};</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></body></html>