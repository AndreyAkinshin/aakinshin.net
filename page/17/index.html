<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content><title>Andrey Akinshin's blog (Page 17)</title><meta name=description content="Andrey Akinshin's blog"><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.4ac0c7ef2f01d3ca1205e3c606bdce4b51eef77185a18ae7e20af21b90e1f88d.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-content><div><h2><a href=/posts/bdn-v0_10_7/>BenchmarkDotNet v0.10.7</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2017-06-05>June 5, 2017</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarkdotnet/>BenchmarkDotNet</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarking/>Benchmarking</a></div></div><br><p>BenchmarkDotNet v0.10.7 has been released.
In this post, I will briefly cover the following features:</p><ul><li>LINQPad support</li><li>Filters and categories</li><li>Updated Setup/Cleanup attributes</li><li>Better Value Types support</li><li>Building Sources on Linux</li></ul><br><a href=/posts/bdn-v0_10_7/>Read more</a><br><br><hr></div><div><h2><a href=/posts/mono-and-65535interfaces/>65535 interfaces ought to be enough for anybody</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2017-02-14>February 14, 2017</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a>
<a class=label-link href=https://aakinshin.net/tags/bugs/>Bugs</a>
<a class=label-link href=https://aakinshin.net/tags/mono/>Mono</a></div></div><br><p>It was a bright, sunny morning.
There were no signs of trouble.
I came to work, opened Slack, and received many messages from my coworkers about failed tests.</p><div class=mx-auto><img class="mx-auto d-block" width=800 src=/img/posts/dotnet/mono-and-65535interfaces/front.png></div><p>After a few hours of investigation, the situation became clear:</p><ul><li>I&rsquo;m responsible for the unit tests subsystem in <a href=https://www.jetbrains.com/rider/>Rider</a>, and only tests from this subsystem were failing.</li><li>I didn&rsquo;t commit anything to the subsystem for a week because I worked with a local branch.
Other developers also didn&rsquo;t touch this code.</li><li>The unit tests subsystem is completely independent.
It&rsquo;s hard to imagine a situation when only the corresponded tests would fail, thousands of other tests pass, and there are no changes in the source code.</li><li><code>git blame</code> helped to find the &ldquo;bad commit&rdquo;: it didn&rsquo;t include anything suspicious, only a few additional classes in other subsystems.</li><li>Only tests on Linux and MacOS were red.
On Windows, everything was ok.</li><li>Stacktraces in failed tests were completely random.
We had a new stack trace in each test from different subsystems.
There was no connection between these stack traces, unit tests source code, and the changes in the &ldquo;bad commit.&rdquo;
There was no clue where we should look for a problem.</li></ul><p>So, what was special about this &ldquo;bad commit&rdquo;? Spoiler: after these changes, we sometimes have more than 65535 interface implementations at runtime.</p><br><a href=/posts/mono-and-65535interfaces/>Read more</a><br><br><hr></div><div><h2><a href=/posts/namedmutex-on-mono/>A bug story about named mutex on Mono</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2017-02-13>February 13, 2017</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a>
<a class=label-link href=https://aakinshin.net/tags/bugs/>Bugs</a>
<a class=label-link href=https://aakinshin.net/tags/xplat/>Xplat</a>
<a class=label-link href=https://aakinshin.net/tags/mono/>Mono</a>
<a class=label-link href=https://aakinshin.net/tags/coreclr/>CoreCLR</a></div></div><br><p>When you write some multithreading magic on .NET,
you can use a cool synchronization primitive called <a href="https://msdn.microsoft.com/en-us/library/system.threading.mutex(v=vs.110).aspx">Mutex</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>var</span> <span class=n>mutex</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Mutex</span><span class=p>(</span><span class=k>false</span><span class=p>,</span> <span class=s>&#34;Global\\MyNamedMutex&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>You also can make it <a href="https://msdn.microsoft.com/en-us/library/f55ddskf(v=vs.110).aspx">named</a> (and share the mutex between processes)
which works perfectly on Windows:</p><div class=mx-auto><img class="mx-auto d-block" width=600 src=/img/posts/dotnet/namedmutex-on-mono/front.png></div><p>However, today the .NET Framework is cross-platform, so this code should work on any operation system.
What will happen if you use named mutex on Linux or MacOS with the help of Mono or CoreCLR?
Is it possible to create some tricky bug based on this case?
Of course, it does.
Today I want to tell you a story about such bug in <a href=https://www.jetbrains.com/rider/>Rider</a> which was a headache for several weeks.</p><br><a href=/posts/namedmutex-on-mono/>Read more</a><br><br><hr></div><div><h2><a href=/posts/invaliddataexception-in-getprocesses/>InvalidDataException in Process.GetProcesses</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2017-02-10>February 10, 2017</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a>
<a class=label-link href=https://aakinshin.net/tags/bugs/>Bugs</a>
<a class=label-link href=https://aakinshin.net/tags/xplat/>Xplat</a>
<a class=label-link href=https://aakinshin.net/tags/coreclr/>CoreCLR</a></div></div><br><p>Consider the following program:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Process</span><span class=p>.</span><span class=n>GetProcesses</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It seems that all exceptions should be caught.
However, <em>sometimes</em>, I had the following exception on Linux with <code>dotnet cli-1.0.0-preview2</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=err>$</span> <span class=n>dotnet</span> <span class=n>run</span>
</span></span><span class=line><span class=cl><span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>InvalidDataException</span><span class=p>:</span> <span class=n>Found</span> <span class=n>invalid</span> <span class=n>data</span> <span class=k>while</span> <span class=n>decoding</span><span class=p>.</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>IO</span><span class=p>.</span><span class=n>StringParser</span><span class=p>.</span><span class=n>ParseNextChar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>Interop</span><span class=p>.</span><span class=n>procfs</span><span class=p>.</span><span class=n>TryParseStatFile</span><span class=p>(</span><span class=n>String</span> <span class=n>statFilePath</span><span class=p>,</span> <span class=n>ParsedStat</span><span class=p>&amp;</span> <span class=n>result</span><span class=p>,</span> <span class=n>ReusableTextReader</span> <span class=n>reusableReader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>Diagnostics</span><span class=p>.</span><span class=n>ProcessManager</span><span class=p>.</span><span class=n>CreateProcessInfo</span><span class=p>(</span><span class=n>ParsedStat</span> <span class=n>procFsStat</span><span class=p>,</span> <span class=n>ReusableTextReader</span> <span class=n>reusableReader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>Diagnostics</span><span class=p>.</span><span class=n>ProcessManager</span><span class=p>.</span><span class=n>CreateProcessInfo</span><span class=p>(</span><span class=n>Int32</span> <span class=n>pid</span><span class=p>,</span> <span class=n>ReusableTextReader</span> <span class=n>reusableReader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>Diagnostics</span><span class=p>.</span><span class=n>ProcessManager</span><span class=p>.</span><span class=n>GetProcessInfos</span><span class=p>(</span><span class=n>String</span> <span class=n>machineName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>Diagnostics</span><span class=p>.</span><span class=n>Process</span><span class=p>.</span><span class=n>GetProcesses</span><span class=p>(</span><span class=n>String</span> <span class=n>machineName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>System</span><span class=p>.</span><span class=n>Diagnostics</span><span class=p>.</span><span class=n>Process</span><span class=p>.</span><span class=n>GetProcesses</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=n>at</span> <span class=n>DotNetCoreConsoleApplication</span><span class=p>.</span><span class=n>Program</span><span class=p>.</span><span class=n>Main</span><span class=p>(</span><span class=n>String</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span> <span class=k>in</span> <span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>akinshin</span><span class=p>/</span><span class=n>Program</span><span class=p>.</span><span class=n>cs</span><span class=p>:</span><span class=n>line</span> <span class=m>12</span>
</span></span></code></pre></div><p>How is that possible?</p><br><a href=/posts/invaliddataexception-in-getprocesses/>Read more</a><br><br><hr></div><div><h2><a href=/posts/rider-nuget-search/>Why is NuGet search in Rider so fast?</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2017-02-08>February 8, 2017</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a>
<a class=label-link href=https://aakinshin.net/tags/nuget/>NuGet</a></div></div><br><p>I&rsquo;m the guy who develops the NuGet manager in <a href=https://www.jetbrains.com/rider/>Rider</a>.
It&rsquo;s not ready yet, there are some bugs here and there, but it already works pretty well.
The feature which I am most proud of is smart and fast search:</p><div class=mx-auto><img class="mx-auto d-block" width=400 src=/img/posts/dotnet/rider-nuget-search/front.gif></div><p>Today I want to share with you some technical details about how it was implemented.</p><br><a href=/posts/rider-nuget-search/>Read more</a><br><br><hr></div><div><h2><a href=/posts/nuget2-and-directoryseparatorchar/>NuGet2 and a DirectorySeparatorChar bug</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2017-02-06>February 6, 2017</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a>
<a class=label-link href=https://aakinshin.net/tags/bugs/>Bugs</a>
<a class=label-link href=https://aakinshin.net/tags/performance/>Performance</a>
<a class=label-link href=https://aakinshin.net/tags/nuget/>NuGet</a></div></div><br><p>In <a href=https://www.jetbrains.com/rider/>Rider</a>, we care a lot about performance.
I like to improve the application responsiveness and do interesting optimizations all the time.
Rider is already well-optimized, and it&rsquo;s often hard to make significant performance improvements, so usually I do micro-optimizations which do not have a very big impact on the whole application.
However, sometimes it&rsquo;s possible to improve the speed of a feature 100 times with just a few lines of code.</p><p>Rider is based on <a href=https://www.jetbrains.com/resharper/>ReSharper</a>, so we have a lot of cool features out of the box.
One of these features is <a href=https://www.jetbrains.com/help/resharper/2016.3/Code_Analysis__Solution-Wide_Analysis.html>Solution-Wide Analysis</a>
which lets you constantly keep track of issues in your solution.
Sometimes, solution-wide analysis takes a lot of time to run because there are many files which should be analyzed.
Of course, it works super fast on small and projects.</p><p>Let&rsquo;s talk about a performance bug (<a href=https://youtrack.jetbrains.com/issue/RIDER-3742>#RIDER-3742</a>) that we recently had.</p><ul><li><em>Repro:</em> Open Rider, create a new &ldquo;ASP .NET MVC Application&rdquo;, enable solution wide-analysis.</li><li><em>Expected:</em> The analysis should take 1 second.</li><li><em>Actual:</em> The analysis takes 1 second on Windows and <strong>2 minutes</strong> on Linux and MacOS.</li></ul><br><a href=/posts/nuget2-and-directoryseparatorchar/>Read more</a><br><br><hr></div><div><h2><a href=/posts/perfex-div/>Performance exercise: Division</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-12-26>December 26, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/case-study/>Case study</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/performanceexercise/>PerformanceExercise</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarking/>Benchmarking</a>
<a class=label-link href=https://aakinshin.net/tags/math/>Math</a></div></div><br><p>In the previous post, we <a href=/en/blog/dotnet/perfex-min/>discussed</a> the performance space of the minimum function
which was implemented via a simple ternary operator and with the help of bit magic.
Now we continue to talk about performance and bit hacks.
In particular, we will divide a positive number by three:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>uint</span> <span class=n>Div3Simple</span><span class=p>(</span><span class=kt>uint</span> <span class=n>n</span><span class=p>)</span>   <span class=p>=&gt;</span> <span class=n>n</span> <span class=p>/</span> <span class=m>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>uint</span> <span class=n>Div3BitHacks</span><span class=p>(</span><span class=kt>uint</span> <span class=n>n</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)((</span><span class=n>n</span> <span class=p>*</span> <span class=p>(</span><span class=kt>ulong</span><span class=p>)</span><span class=m>0xAAAAAAAB</span><span class=p>)</span> <span class=p>&gt;&gt;</span> <span class=m>33</span><span class=p>);</span>
</span></span></code></pre></div><p>As usual, it&rsquo;s hard to say which method is faster in advanced because the performance depends on the environment.
Here are some interesting results:</p><table class="table table-sm"><tr><th></th><th>Simple</th><th>BitHacks</th></tr><tr><th>LegacyJIT-x86</th><td class=norm>≈8.3ns</td><td class=fast>≈2.6ns</td></tr><tr><th>LegacyJIT-x64</th><td class=fast>≈2.6ns</td><td class=fast>≈1.7ns</td></tr><tr><th>RyuJIT-x64</th><td class=norm>≈6.9ns</td><td class=fast>≈1.5ns</td></tr><tr><th>Mono4.6.2-x86</th><td class=norm>≈8.5ns</td><td class=slow>≈14.4ns</td></tr><tr><th>Mono4.6.2-x64</th><td class=norm>≈8.3ns</td><td class=fast>≈2.8ns</td></tr></table><br><a href=/posts/perfex-div/>Read more</a><br><br><hr></div><div><h2><a href=/posts/perfex-min/>Performance exercise: Minimum</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-12-20>December 20, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/performanceexercise/>PerformanceExercise</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarking/>Benchmarking</a>
<a class=label-link href=https://aakinshin.net/tags/math/>Math</a></div></div><br><p>Performance is tricky. Especially, if you are working with very fast operations. In today benchmarking exercise, we will try to measure performance of two simple methods which calculate minimum of two numbers. Sounds easy? Ok, let&rsquo;s do it, here are our guinea pigs for today:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>int</span> <span class=n>MinTernary</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span>  <span class=p>=&gt;</span> <span class=n>x</span> <span class=p>&lt;</span> <span class=n>y</span> <span class=p>?</span> <span class=n>x</span> <span class=p>:</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>MinBitHacks</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=n>x</span> <span class=p>&amp;</span> <span class=p>((</span><span class=n>x</span> <span class=p>-</span> <span class=n>y</span><span class=p>)</span> <span class=p>&gt;&gt;</span> <span class=m>31</span><span class=p>)</span> <span class=p>|</span> <span class=n>y</span> <span class=p>&amp;</span> <span class=p>(~(</span><span class=n>x</span> <span class=p>-</span> <span class=n>y</span><span class=p>)</span> <span class=p>&gt;&gt;</span> <span class=m>31</span><span class=p>);</span>
</span></span></code></pre></div><p>And here are some results:</p><table class="table table-sm"><style type=text/css scoped>td.slow{color:#f44}td.fast{color:#00c851}</style><tr><th></th><th colspan=2>Random</th><th colspan=2>Const</th></tr><tr><th></th><th>Ternary</th><th>BitHacks</th><th>Ternary</th><th>BitHacks</th></tr><tr><th>LegacyJIT-x86</th><td class=slow>≈643µs</td><td class=fast>≈227µs</td><td class=fast>≈160µs</td><td class=slow>≈226µs</td></tr><tr><th>LegacyJIT-x64</th><td class=slow>≈450µs</td><td class=fast>≈123µs</td><td class=fast>≈68µs</td><td class=slow>≈123µs</td></tr><tr><th>RyuJIT-x64</th><td class=slow>≈594µs</td><td class=fast>≈241µs</td><td class=fast>≈180µs</td><td class=slow>≈241µs</td></tr><tr><th>Mono-x64</th><td class=fast>≈203µs</td><td class=slow>≈283µs</td><td class=fast>≈204µs</td><td class=slow>≈282µs</td></tr></table><p>What&rsquo;s going on here? Let&rsquo;s discuss it in detail.</p><br><a href=/posts/perfex-min/>Read more</a><br><br><hr></div><div><h2><a href=/posts/stopwatch/>Stopwatch under the hood</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-09-09>September 9, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/hardware/>Hardware</a>
<a class=label-link href=https://aakinshin.net/tags/timers/>Timers</a>
<a class=label-link href=https://aakinshin.net/tags/internals/>Internals</a></div></div><br><p><strong>Update:</strong>
You can find an updated and significantly improved version of this post in my book <a href=/prodotnetbenchmarking/>&ldquo;Pro .NET Benchmarking&rdquo;</a>.</p><p>In <a href=/en/blog/dotnet/datetime/>the previous post</a>, we discussed <code>DateTime</code>.
This structure can be used in situations when you don&rsquo;t need a good level of precision.
If you want to do high-precision time measurements, you need a better tool because <code>DateTime</code> has a small resolution and a big latency.
Also, time is tricky, you can create wonderful bugs if you don&rsquo;t understand how it works (see <a href=http://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time>Falsehoods programmers believe about time</a> and <a href=http://infiniteundo.com/post/25509354022/more-falsehoods-programmers-believe-about-time>More falsehoods programmers believe about time</a>).</p><p>In this post, we will briefly talk about the <a href=https://msdn.microsoft.com/library/system.diagnostics.stopwatch.aspx>Stopwatch</a> class:</p><ul><li>Which kind of hardware timers could be a base for <code>Stopwatch</code></li><li>High precision timestamp API on Windows and Linux</li><li>Latency and Resolution of <code>Stopwatch</code> in different environments</li><li>Common pitfalls: which kind of problems could we get trying to measure small time intervals</li></ul><p>If you are not a .NET developer, you can also find a lot of useful information in this post: mainly we will discuss low-level details of high-resolution timestamping (probably your favorite language also uses the same API).
As usual, you can also find useful links for further reading.</p><br><a href=/posts/stopwatch/>Read more</a><br><br><hr></div><div><h2><a href=/posts/datetime/>DateTime under the hood</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-08-19>August 19, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/timers/>Timers</a>
<a class=label-link href=https://aakinshin.net/tags/internals/>Internals</a></div></div><br><p><strong>Update:</strong>
You can find an updated and significantly improved version of this post in my book <a href=/prodotnetbenchmarking/>&ldquo;Pro .NET Benchmarking&rdquo;</a>.</p><p><a href=https://msdn.microsoft.com/library/system.datetime.aspx>DateTime</a> is a widely used .NET type. A lot of developers use it all the time, but not all of them really know how it works. In this post, I discuss <a href=https://msdn.microsoft.com/library/system.datetime.utcnow.aspx>DateTime.UtcNow</a>: how it&rsquo;s implemented, what the latency and the resolution of <code>DateTime</code> on Windows and Linux, how the resolution can be changed, and how it can affect your application. This post is an overview, so you probably will not see super detailed explanations of some topics, but you will find a lot of useful links for further reading.</p><br><a href=/posts/datetime/>Read more</a><br><br><hr></div></div><div class=paginator><ul class="pagination pagination-default"><li class=page-item><a href=/ aria-label=First class=page-link role=button><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/16/ aria-label=Previous class=page-link role=button><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a href=/page/15/ aria-label="Page 15" class=page-link role=button>15</a></li><li class=page-item><a href=/page/16/ aria-label="Page 16" class=page-link role=button>16</a></li><li class="page-item active"><a aria-current=page aria-label="Page 17" class=page-link role=button>17</a></li><li class=page-item><a href=/page/18/ aria-label="Page 18" class=page-link role=button>18</a></li><li class=page-item><a href=/page/19/ aria-label="Page 19" class=page-link role=button>19</a></li><li class=page-item><a href=/page/18/ aria-label=Next class=page-link role=button><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/20/ aria-label=Last class=page-link role=button><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>