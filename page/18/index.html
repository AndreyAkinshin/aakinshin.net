<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.103.0-DEV"><meta name=author content="Andrey Akinshin"><link href=/img/favicon.ico rel=icon type=image/x-icon><meta name=keywords content><title>Andrey Akinshin's blog (Page 18)</title><meta name=description content="Andrey Akinshin's blog"><meta name=twitter:site content="@andrey_akinshin"><meta name=twitter:creator content="@andrey_akinshin"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link href=https://aakinshin.net/css/main.min.3746982c0855975eba2f485ef34018c70576ba5fe5ea2f4333daa717341a2831.css rel=stylesheet type=text/css media=all><link rel=alternate type=application/rss+xml href=https://aakinshin.net/posts/index.xml title="RSS Feed"></head><body><nav><div class="container flex flex-wrap items-center justify-between mx-auto max-w-6xl h-12 px-6"><div class="flex items-center justify-start justify-self-start"><div class="flex nav-item h-12 w-12 items-center justify-center"><a class=text-white href=https://aakinshin.net/><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#house-chimney"/></svg></a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/posts/>Posts</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/research/>Research</a></div><div class="flex nav-item h-12 items-center"><a class="px-3 text-white" href=https://aakinshin.net/about/>About</a></div></div><div class="flex items-center justify-end justify-self-start"><div class="flex nav-item h-12 items-center" title='Support this blog'><a class="px-3 text-white" href=https://github.com/sponsors/AndreyAkinshin><svg class="fai w-5 h-5 pr-0 mb-0.5"><use xlink:href="/img/fa/all.svg#heart"/></svg></a></div><button id=theme-toggle type=button class="nav-item p-3 content-center justify-self-end"><svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></div></div></nav><div class="main container mx-auto max-w-6xl px-6"><div class=main-content><div><h2><a href=/posts/perfex-div/>Performance exercise: Division</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-12-26>December 26, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/case-study/>Case study</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/performanceexercise/>PerformanceExercise</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarking/>Benchmarking</a>
<a class=label-link href=https://aakinshin.net/tags/math/>Math</a></div></div><br><p>In the previous post, we <a href=/en/blog/dotnet/perfex-min/>discussed</a> the performance space of the minimum function
which was implemented via a simple ternary operator and with the help of bit magic.
Now we continue to talk about performance and bit hacks.
In particular, we will divide a positive number by three:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>uint</span> <span class=n>Div3Simple</span><span class=p>(</span><span class=kt>uint</span> <span class=n>n</span><span class=p>)</span>   <span class=p>=&gt;</span> <span class=n>n</span> <span class=p>/</span> <span class=m>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>uint</span> <span class=n>Div3BitHacks</span><span class=p>(</span><span class=kt>uint</span> <span class=n>n</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)((</span><span class=n>n</span> <span class=p>*</span> <span class=p>(</span><span class=kt>ulong</span><span class=p>)</span><span class=m>0xAAAAAAAB</span><span class=p>)</span> <span class=p>&gt;&gt;</span> <span class=m>33</span><span class=p>);</span>
</span></span></code></pre></div><p>As usual, it&rsquo;s hard to say which method is faster in advanced because the performance depends on the environment.
Here are some interesting results:</p><table class="table table-sm"><tr><th></th><th>Simple</th><th>BitHacks</th></tr><tr><th>LegacyJIT-x86</th><td class=norm>≈8.3ns</td><td class=fast>≈2.6ns</td></tr><tr><th>LegacyJIT-x64</th><td class=fast>≈2.6ns</td><td class=fast>≈1.7ns</td></tr><tr><th>RyuJIT-x64</th><td class=norm>≈6.9ns</td><td class=fast>≈1.5ns</td></tr><tr><th>Mono4.6.2-x86</th><td class=norm>≈8.5ns</td><td class=slow>≈14.4ns</td></tr><tr><th>Mono4.6.2-x64</th><td class=norm>≈8.3ns</td><td class=fast>≈2.8ns</td></tr></table><br><a href=/posts/perfex-div/>Read more</a><br><br><hr></div><div><h2><a href=/posts/perfex-min/>Performance exercise: Minimum</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-12-20>December 20, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/performanceexercise/>PerformanceExercise</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarking/>Benchmarking</a>
<a class=label-link href=https://aakinshin.net/tags/math/>Math</a></div></div><br><p>Performance is tricky. Especially, if you are working with very fast operations. In today benchmarking exercise, we will try to measure performance of two simple methods which calculate minimum of two numbers. Sounds easy? Ok, let&rsquo;s do it, here are our guinea pigs for today:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=kt>int</span> <span class=n>MinTernary</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span>  <span class=p>=&gt;</span> <span class=n>x</span> <span class=p>&lt;</span> <span class=n>y</span> <span class=p>?</span> <span class=n>x</span> <span class=p>:</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>MinBitHacks</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=n>x</span> <span class=p>&amp;</span> <span class=p>((</span><span class=n>x</span> <span class=p>-</span> <span class=n>y</span><span class=p>)</span> <span class=p>&gt;&gt;</span> <span class=m>31</span><span class=p>)</span> <span class=p>|</span> <span class=n>y</span> <span class=p>&amp;</span> <span class=p>(~(</span><span class=n>x</span> <span class=p>-</span> <span class=n>y</span><span class=p>)</span> <span class=p>&gt;&gt;</span> <span class=m>31</span><span class=p>);</span>
</span></span></code></pre></div><p>And here are some results:</p><table class="table table-sm"><style type=text/css scoped>td.slow{color:#f44}td.fast{color:#00c851}</style><tr><th></th><th colspan=2>Random</th><th colspan=2>Const</th></tr><tr><th></th><th>Ternary</th><th>BitHacks</th><th>Ternary</th><th>BitHacks</th></tr><tr><th>LegacyJIT-x86</th><td class=slow>≈643µs</td><td class=fast>≈227µs</td><td class=fast>≈160µs</td><td class=slow>≈226µs</td></tr><tr><th>LegacyJIT-x64</th><td class=slow>≈450µs</td><td class=fast>≈123µs</td><td class=fast>≈68µs</td><td class=slow>≈123µs</td></tr><tr><th>RyuJIT-x64</th><td class=slow>≈594µs</td><td class=fast>≈241µs</td><td class=fast>≈180µs</td><td class=slow>≈241µs</td></tr><tr><th>Mono-x64</th><td class=fast>≈203µs</td><td class=slow>≈283µs</td><td class=fast>≈204µs</td><td class=slow>≈282µs</td></tr></table><p>What&rsquo;s going on here? Let&rsquo;s discuss it in detail.</p><br><a href=/posts/perfex-min/>Read more</a><br><br><hr></div><div><h2><a href=/posts/stopwatch/>Stopwatch under the hood</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-09-09>September 9, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/hardware/>Hardware</a>
<a class=label-link href=https://aakinshin.net/tags/timers/>Timers</a>
<a class=label-link href=https://aakinshin.net/tags/internals/>Internals</a></div></div><br><p><strong>Update:</strong>
You can find an updated and significantly improved version of this post in my book <a href=/prodotnetbenchmarking/>&ldquo;Pro .NET Benchmarking&rdquo;</a>.</p><p>In <a href=/en/blog/dotnet/datetime/>the previous post</a>, we discussed <code>DateTime</code>.
This structure can be used in situations when you don&rsquo;t need a good level of precision.
If you want to do high-precision time measurements, you need a better tool because <code>DateTime</code> has a small resolution and a big latency.
Also, time is tricky, you can create wonderful bugs if you don&rsquo;t understand how it works (see <a href=http://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time>Falsehoods programmers believe about time</a> and <a href=http://infiniteundo.com/post/25509354022/more-falsehoods-programmers-believe-about-time>More falsehoods programmers believe about time</a>).</p><p>In this post, we will briefly talk about the <a href=https://msdn.microsoft.com/library/system.diagnostics.stopwatch.aspx>Stopwatch</a> class:</p><ul><li>Which kind of hardware timers could be a base for <code>Stopwatch</code></li><li>High precision timestamp API on Windows and Linux</li><li>Latency and Resolution of <code>Stopwatch</code> in different environments</li><li>Common pitfalls: which kind of problems could we get trying to measure small time intervals</li></ul><p>If you are not a .NET developer, you can also find a lot of useful information in this post: mainly we will discuss low-level details of high-resolution timestamping (probably your favorite language also uses the same API).
As usual, you can also find useful links for further reading.</p><br><a href=/posts/stopwatch/>Read more</a><br><br><hr></div><div><h2><a href=/posts/datetime/>DateTime under the hood</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-08-19>August 19, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/timers/>Timers</a>
<a class=label-link href=https://aakinshin.net/tags/internals/>Internals</a></div></div><br><p><strong>Update:</strong>
You can find an updated and significantly improved version of this post in my book <a href=/prodotnetbenchmarking/>&ldquo;Pro .NET Benchmarking&rdquo;</a>.</p><p><a href=https://msdn.microsoft.com/library/system.datetime.aspx>DateTime</a> is a widely used .NET type. A lot of developers use it all the time, but not all of them really know how it works. In this post, I discuss <a href=https://msdn.microsoft.com/library/system.datetime.utcnow.aspx>DateTime.UtcNow</a>: how it&rsquo;s implemented, what the latency and the resolution of <code>DateTime</code> on Windows and Linux, how the resolution can be changed, and how it can affect your application. This post is an overview, so you probably will not see super detailed explanations of some topics, but you will find a lot of useful links for further reading.</p><br><a href=/posts/datetime/>Read more</a><br><br><hr></div><div><h2><a href=/posts/legacyjitx86-and-first-method-call/>LegacyJIT-x86 and first method call</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-04-04>April 4, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/jit/>JIT</a>
<a class=label-link href=https://aakinshin.net/tags/benchmarks/>Benchmarks</a></div></div><br><p>Today I tell you about one of my favorite benchmarks (this method doesn&rsquo;t return a useful value, we need it only as an example):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[Benchmark]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>string</span> <span class=n>Sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>a</span> <span class=p>=</span> <span class=m>1</span><span class=p>,</span> <span class=n>b</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>sw</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Stopwatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>10001</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span> <span class=p>=</span> <span class=n>a</span> <span class=p>+</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kt>string</span><span class=p>.</span><span class=n>Format</span><span class=p>(</span><span class=s>&#34;{0}{1}&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>sw</span><span class=p>.</span><span class=n>ElapsedMilliseconds</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>An interesting fact: if you call <code>Stopwatch.GetTimestamp()</code> before the first call of the <code>Sum</code> method, you improve <code>Sum</code> performance several times (works only with LegacyJIT-x86).</p><br><a href=/posts/legacyjitx86-and-first-method-call/>Read more</a><br><br><hr></div><div><h2><a href=/posts/projecttypeguids/>Visual Studio and ProjectTypeGuids.cs</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2016-02-27>February 27, 2016</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/visualstudio/>VisualStudio</a>
<a class=label-link href=https://aakinshin.net/tags/hate/>Hate</a>
<a class=label-link href=https://aakinshin.net/tags/rider/>Rider</a></div></div><br><p>It&rsquo;s a story about how I tried to open a project in Visual Studio for a few hours. The other day, I was going to do some work. I pulled last commits from a repo, opened Visual Studio, and prepared to start coding. However, one of a project in my solution failed to open with a strange message:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>error  : The operation could not be completed.
</span></span></code></pre></div><p>In the Solution Explorer, I had <em>&ldquo;load failed&rdquo;</em> as a project status and the following message instead of the file tree: <em>&ldquo;The project requires user input. Reload the project for more information.&rdquo;</em> Hmm, ok, I reloaded the project and got a few more errors:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>error  : The operation could not be completed.
</span></span><span class=line><span class=cl>error  : The operation could not be completed.
</span></span></code></pre></div><br><a href=/posts/projecttypeguids/>Read more</a><br><br><hr></div><div><h2><a href=/posts/blittable/>Blittable types</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2015-11-26>November 26, 2015</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/internals/>Internals</a></div></div><br><p>Challenge of the day: what will the following code display?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[StructLayout(LayoutKind.Explicit)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>UInt128</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>    [FieldOffset(0)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>ulong</span> <span class=n>Value1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=na>    [FieldOffset(8)]</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>ulong</span> <span class=n>Value2</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>[StructLayout(LayoutKind.Sequential)]</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>struct</span> <span class=nc>MyStruct</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=n>UInt128</span> <span class=n>UInt128</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>char</span> <span class=n>Char</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>static</span> <span class=k>unsafe</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>myStruct</span> <span class=p>=</span> <span class=k>new</span> <span class=n>MyStruct</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>baseAddress</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)&amp;</span><span class=n>myStruct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>uInt128Adress</span> <span class=p>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)&amp;</span><span class=n>myStruct</span><span class=p>.</span><span class=n>UInt128</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>uInt128Adress</span> <span class=p>-</span> <span class=n>baseAddress</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>Marshal</span><span class=p>.</span><span class=n>OffsetOf</span><span class=p>(</span><span class=k>typeof</span><span class=p>(</span><span class=n>MyStruct</span><span class=p>),</span> <span class=s>&#34;UInt128&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>A hint: two zeros or two another same values are wrong answers in the general case. The following table shows the console output on different runtimes:</p><table><tr><th></th><th>MS.NET-x86</th><th>MS.NET-x64</th><th>Mono</th></tr><tr><td>uInt128Adress - baseAddress</td><td>4</td><td>8</td><td>0</td></tr><tr><td>Marshal.OffsetOf(typeof(MyStruct), "UInt128")</td><td>0</td><td>0</td><td>0</td></tr></table><p>If you want to know why it happens, you probably should learn some useful information about blittable types.</p><br><a href=/posts/blittable/>Read more</a><br><br><hr></div><div><h2><a href=/posts/ryujit-rc-and-constant-folding/>RyuJIT RC and constant folding</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2015-05-12>May 12, 2015</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/jit/>JIT</a>
<a class=label-link href=https://aakinshin.net/tags/ryujit/>RyuJIT</a>
<a class=label-link href=https://aakinshin.net/tags/constantfolding/>ConstantFolding</a></div></div><br><p><strong>Update:</strong> The below results are valid for the release version of RyuJIT in .NET Framework 4.6 without updates.</p><p>The challenge of the day: which method is faster?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>public</span> <span class=kt>double</span> <span class=n>Sqrt13</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>1</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>2</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>3</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>4</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>5</span><span class=p>)</span> <span class=p>+</span> 
</span></span><span class=line><span class=cl>           <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>6</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>7</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>8</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>9</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>10</span><span class=p>)</span> <span class=p>+</span> 
</span></span><span class=line><span class=cl>           <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>11</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>12</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>13</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=kt>double</span> <span class=n>Sqrt14</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>1</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>2</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>3</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>4</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>5</span><span class=p>)</span> <span class=p>+</span> 
</span></span><span class=line><span class=cl>           <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>6</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>7</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>8</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>9</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>10</span><span class=p>)</span> <span class=p>+</span> 
</span></span><span class=line><span class=cl>           <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>11</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>12</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>13</span><span class=p>)</span> <span class=p>+</span> <span class=n>Math</span><span class=p>.</span><span class=n>Sqrt</span><span class=p>(</span><span class=m>14</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>I have measured the methods performance with help of <a href=https://github.com/AndreyAkinshin/BenchmarkDotNet>BenchmarkDotNet</a> for RyuJIT RC (a part of .NET Framework 4.6 RC) and received the following results:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>// BenchmarkDotNet=v0.7.4.0
</span></span><span class=line><span class=cl>// OS=Microsoft Windows NT 6.2.9200.0
</span></span><span class=line><span class=cl>// Processor=Intel(R) Core(TM) i7-4702MQ CPU ＠ 2.20GHz, ProcessorCount=8
</span></span><span class=line><span class=cl>// CLR=MS.NET 4.0.30319.0, Arch=64-bit  [RyuJIT]
</span></span><span class=line><span class=cl>Common:  Type=Math_DoubleSqrtAvx  Mode=Throughput  Platform=X64  Jit=RyuJit  .NET=Current  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> Method |  AvrTime |    StdDev |         op/s |
</span></span><span class=line><span class=cl>------- |--------- |---------- |------------- |
</span></span><span class=line><span class=cl> Sqrt13 | 55.40 ns |  0.571 ns |  18050993.06 |
</span></span><span class=line><span class=cl> Sqrt14 |  1.43 ns | 0.0224 ns | 697125029.18 |
</span></span></code></pre></div><p>How so? If I add one more <code>Math.Sqrt</code> to the expression, the method starts work 40 times faster! Let&rsquo;s examine the situation..</p><br><a href=/posts/ryujit-rc-and-constant-folding/>Read more</a><br><br><hr></div><div><h2><a href=/posts/unrolling-of-small-loops-in-different-jit-versions/>Unrolling of small loops in different JIT versions</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2015-03-02>March 2, 2015</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/jit/>JIT</a>
<a class=label-link href=https://aakinshin.net/tags/bugs/>Bugs</a>
<a class=label-link href=https://aakinshin.net/tags/loopunrolling/>LoopUnrolling</a></div></div><br><p>Challenge of the day: what will the following code display?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Point</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>X</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=kt>int</span> <span class=n>Y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>void</span> <span class=n>Print</span><span class=p>(</span><span class=n>Point</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=n>X</span> <span class=p>+</span> <span class=s>&#34; &#34;</span> <span class=p>+</span> <span class=n>p</span><span class=p>.</span><span class=n>Y</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Point</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=n>X</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>p</span><span class=p>.</span><span class=n>X</span> <span class=p>&lt;</span> <span class=m>2</span><span class=p>;</span> <span class=n>p</span><span class=p>.</span><span class=n>X</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>        <span class=n>Print</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The right answer: it depends. There is a bug in CLR2 JIT-x86 which spoil this wonderful program. This story is about optimization that called unrolling of small loops. This is a very interesting theme, let&rsquo;s discuss it in detail.</p><br><a href=/posts/unrolling-of-small-loops-in-different-jit-versions/>Read more</a><br><br><hr></div><div><h2><a href=/posts/ryujit-ctp5-and-loop-unrolling/>RyuJIT CTP5 and loop unrolling</a></h2><div class="flex flex-wrap justify-start items-center"><svg class="fai text-accent-l dark:text-front-d"><title>Date</title><use xlink:href="/img/fa/all.svg#calendar-days"/></svg><time datetime=2015-03-01>March 1, 2015</time><svg class="fai ml-3 text-accent-l dark:text-front-d"><title>Tags</title><use xlink:href="/img/fa/all.svg#tag"/></svg><div class="flex flex-wrap gap-y-1"><a class=label-link href=https://aakinshin.net/tags/programming/>Programming</a>
<a class=label-link href=https://aakinshin.net/tags/dotnet/>.NET</a>
<a class=label-link href=https://aakinshin.net/tags/cs/>C#</a>
<a class=label-link href=https://aakinshin.net/tags/jit/>JIT</a>
<a class=label-link href=https://aakinshin.net/tags/ryujit/>RyuJIT</a>
<a class=label-link href=https://aakinshin.net/tags/loopunrolling/>LoopUnrolling</a></div></div><br><p>RyuJIT will be available soon. It is a next generation JIT-compiler for .NET-applications. Microsoft likes to tell us about the benefits of SIMD using and JIT-compilation time reducing. But what about basic code optimization which is usually applying by a compiler? Today we talk about the loop unrolling (unwinding) optimization. In general, in this type of code optimization, the code</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>1024</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
</span></span><span class=line><span class=cl>    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span></code></pre></div><p>transforms to</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=m>1024</span><span class=p>;</span> <span class=n>i</span> <span class=p>+=</span> <span class=m>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Foo</span><span class=p>(</span><span class=n>i</span> <span class=p>+</span> <span class=m>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Such approach can significantly increase performance of your code. So, what&rsquo;s about loop unrolling in .NET?</p><br><a href=/posts/ryujit-ctp5-and-loop-unrolling/>Read more</a><br><br><hr></div></div><div class=paginator><ul class="pagination pagination-default"><li class=page-item><a href=/ aria-label=First class=page-link role=button><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/17/ aria-label=Previous class=page-link role=button><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a href=/page/16/ aria-label="Page 16" class=page-link role=button>16</a></li><li class=page-item><a href=/page/17/ aria-label="Page 17" class=page-link role=button>17</a></li><li class="page-item active"><a aria-current=page aria-label="Page 18" class=page-link role=button>18</a></li><li class=page-item><a href=/page/19/ aria-label="Page 19" class=page-link role=button>19</a></li><li class=page-item><a href=/page/20/ aria-label="Page 20" class=page-link role=button>20</a></li><li class=page-item><a href=/page/19/ aria-label=Next class=page-link role=button><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/20/ aria-label=Last class=page-link role=button><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script>var themeToggleDarkIcon=document.getElementById("theme-toggle-dark-icon"),themeToggleBtn,themeToggleLightIcon=document.getElementById("theme-toggle-light-icon");const imagesDark=document.querySelectorAll(".img-dark"),imagesLight=document.querySelectorAll(".img-light");localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(themeToggleLightIcon.classList.remove("hidden"),imagesDark.forEach(e=>{e.classList.remove("hidden")})):(themeToggleDarkIcon.classList.remove("hidden"),imagesLight.forEach(e=>{e.classList.remove("hidden")})),themeToggleBtn=document.getElementById("theme-toggle"),themeToggleBtn.addEventListener("click",function(){themeToggleDarkIcon.classList.toggle("hidden"),themeToggleLightIcon.classList.toggle("hidden"),imagesLight.forEach(e=>{e.classList.toggle("hidden")}),imagesDark.forEach(e=>{e.classList.toggle("hidden")}),localStorage.getItem("color-theme")?localStorage.getItem("color-theme")==="light"?(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark")):(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"))})</script><footer class="z-20 p-4 md:p-6 mt-3 w-full border-t border-gray-200 shadow flex items-center justify-center dark:border-gray-600 bg-white dark:bg-zinc-800"><span class="dark:text-gray-400 text-center">© 2013—2023 <span class=whitespace-nowrap>Andrey Akinshin</span></span><ul class="flex flex-wrap items-center px-4 mb-1"><li><a href=https://github.com/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>GitHub</title><use xlink:href="/img/fa/all.svg#github"/></svg></a></li><li><a href=https://twitter.com/andrey_akinshin><svg class="fai fai-link w-5 h-5"><title>Twitter</title><use xlink:href="/img/fa/all.svg#twitter"/></svg></a></li><li><a href=https://aakinshin.net/posts/index.xml><svg class="fai fai-link w-5 h-5"><title>RSS</title><use xlink:href="/img/fa/all.svg#rss"/></svg></a></li><li><a href=https://github.com/sponsors/AndreyAkinshin><svg class="fai fai-link w-5 h-5"><title>Support this blog</title><use xlink:href="/img/fa/all.svg#heart"/></svg></a></li></ul><div class=main-content><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></div></footer><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0},options:{skipHtmlTags:["script","noscript","style","textarea","pre"],ignoreHtmlClass:"tex2jax_ignore",processHtmlClass:"tex2jax_process"}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></body></html>